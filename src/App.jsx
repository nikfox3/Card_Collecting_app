import { seriesFromSetName, cleanSetName } from "./utils/series";
import React, { useState, useEffect, useRef, useMemo } from "react";
import { createPortal } from "react-dom";
import { useUser } from "./context/UserContext";
import { useTheme } from "./context/ThemeContext";
import { API_URL } from "./utils/api";
import DeckBuilder from "./pages/DeckBuilder";
import BinderBuilder from "./pages/BinderBuilder";
import SetsPage from "./pages/SetsPage";
import CommunityPage from "./pages/CommunityPage";
import WishlistPage from "./pages/WishlistPage";
import SettingsPage from "./pages/SettingsPage";
import HelpCenterPage from "./pages/HelpCenterPage";
import CardScanner from "./components/CardScanner";

// Function to construct TCGdx image URL
function constructTCGdxImageUrl(card, quality = "high", extension = "webp") {
  // Map set names to series and set codes
  // Format: 'Set Name': { series: 'series_code', set: 'set_code' }
  const setMap = {
    151: { series: "Scarlet & Violet", set: "sv3pt5" },
    "Ancient Origins": { series: "XY", set: "xy7" },
    Aquapolis: { series: "E-Card", set: "ecard2" },
    Arceus: { series: "Platinum", set: "pl4" },
    "Astral Radiance": { series: "Sword & Shield", set: "swsh10" },
    "Astral Radiance Trainer Gallery": {
      series: "Sword & Shield",
      set: "swsh10tg",
    },
    BREAKpoint: { series: "XY", set: "xy9" },
    BREAKthrough: { series: "XY", set: "xy8" },
    "BW Black Star Promos": { series: "Black & White", set: "bwp" },
    Base: { series: "Base", set: "base1" },
    "Base Set 2": { series: "Base", set: "base4" },
    "Battle Styles": { series: "Sword & Shield", set: "swsh5" },
    "Best of Game": { series: "Other", set: "bp" },
    "Black & White": { series: "Black & White", set: "bw1" },
    "Black Bolt": { series: "Scarlet & Violet", set: "zsv10pt5" },
    "Boundaries Crossed": { series: "Black & White", set: "bw7" },
    "Brilliant Stars": { series: "Sword & Shield", set: "swsh9" },
    "Brilliant Stars Trainer Gallery": {
      series: "Sword & Shield",
      set: "swsh9tg",
    },
    "Burning Shadows": { series: "Sun & Moon", set: "sm3" },
    "Call of Legends": { series: "HeartGold & SoulSilver", set: "col1" },
    Celebrations: { series: "Sword & Shield", set: "cel25" },
    "Celebrations: Classic Collection": {
      series: "Sword & Shield",
      set: "cel25c",
    },
    "Celestial Storm": { series: "Sun & Moon", set: "sm7" },
    "Champion's Path": { series: "Sword & Shield", set: "swsh35" },
    "Chilling Reign": { series: "Sword & Shield", set: "swsh6" },
    "Cosmic Eclipse": { series: "Sun & Moon", set: "sm12" },
    "Crimson Invasion": { series: "Sun & Moon", set: "sm4" },
    "Crown Zenith": { series: "Sword & Shield", set: "swsh12pt5" },
    "Crown Zenith Galarian Gallery": {
      series: "Sword & Shield",
      set: "swsh12pt5gg",
    },
    "Crystal Guardians": { series: "EX", set: "ex14" },
    "DP Black Star Promos": { series: "Diamond & Pearl", set: "dpp" },
    "Dark Explorers": { series: "Black & White", set: "bw5" },
    "Darkness Ablaze": { series: "Sword & Shield", set: "swsh3" },
    "Delta Species": { series: "EX", set: "ex11" },
    Deoxys: { series: "EX", set: "ex8" },
    "Destined Rivals": { series: "Scarlet & Violet", set: "sv10" },
    "Detective Pikachu": { series: "Sun & Moon", set: "det1" },
    "Diamond & Pearl": { series: "Diamond & Pearl", set: "dp1" },
    "Double Crisis": { series: "XY", set: "dc1" },
    Dragon: { series: "EX", set: "ex3" },
    "Dragon Frontiers": { series: "EX", set: "ex15" },
    "Dragon Majesty": { series: "Sun & Moon", set: "sm75" },
    "Dragon Vault": { series: "Black & White", set: "dv1" },
    "Dragons Exalted": { series: "Black & White", set: "bw6" },
    "EX Trainer Kit 2 Minun": { series: "EX", set: "tk2b" },
    "EX Trainer Kit 2 Plusle": { series: "EX", set: "tk2a" },
    "EX Trainer Kit Latias": { series: "EX", set: "tk1a" },
    "EX Trainer Kit Latios": { series: "EX", set: "tk1b" },
    Emerald: { series: "EX", set: "ex9" },
    "Emerging Powers": { series: "Black & White", set: "bw2" },
    Evolutions: { series: "XY", set: "xy12" },
    "Evolving Skies": { series: "Sword & Shield", set: "swsh7" },
    "Expedition Base Set": { series: "E-Card", set: "ecard1" },
    "Fates Collide": { series: "XY", set: "xy10" },
    "FireRed & LeafGreen": { series: "EX", set: "ex6" },
    Flashfire: { series: "XY", set: "xy2" },
    "Forbidden Light": { series: "Sun & Moon", set: "sm6" },
    Fossil: { series: "Base", set: "base3" },
    "Furious Fists": { series: "XY", set: "xy3" },
    "Fusion Strike": { series: "Sword & Shield", set: "swsh8" },
    Generations: { series: "XY", set: "g1" },
    "Great Encounters": { series: "Diamond & Pearl", set: "dp4" },
    "Guardians Rising": { series: "Sun & Moon", set: "sm2" },
    "Gym Challenge": { series: "Gym", set: "gym2" },
    "Gym Heroes": { series: "Gym", set: "gym1" },
    "HGSS Black Star Promos": { series: "HeartGold & SoulSilver", set: "hsp" },
    "HS—Triumphant": { series: "HeartGold & SoulSilver", set: "hgss4" },
    "HS—Undaunted": { series: "HeartGold & SoulSilver", set: "hgss3" },
    "HS—Unleashed": { series: "HeartGold & SoulSilver", set: "hgss2" },
    "HeartGold & SoulSilver": {
      series: "HeartGold & SoulSilver",
      set: "hgss1",
    },
    "Hidden Fates": { series: "Sun & Moon", set: "sm115" },
    "Hidden Fates Shiny Vault": { series: "Sun & Moon", set: "sma" },
    "Hidden Legends": { series: "EX", set: "ex5" },
    "Holon Phantoms": { series: "EX", set: "ex13" },
    "Journey Together": { series: "Scarlet & Violet", set: "sv9" },
    Jungle: { series: "Base", set: "base2" },
    "Kalos Starter Set": { series: "XY", set: "xy0" },
    "Legend Maker": { series: "EX", set: "ex12" },
    "Legendary Collection": { series: "Other", set: "base6" },
    "Legendary Treasures": { series: "Black & White", set: "bw11" },
    "Legends Awakened": { series: "Diamond & Pearl", set: "dp6" },
    "Lost Origin": { series: "Sword & Shield", set: "swsh11" },
    "Lost Origin Trainer Gallery": {
      series: "Sword & Shield",
      set: "swsh11tg",
    },
    "Lost Thunder": { series: "Sun & Moon", set: "sm8" },
    "Majestic Dawn": { series: "Diamond & Pearl", set: "dp5" },
    "McDonald's Collection 2011": { series: "Other", set: "mcd11" },
    "McDonald's Collection 2012": { series: "Other", set: "mcd12" },
    "McDonald's Collection 2014": { series: "Other", set: "mcd14" },
    "McDonald's Collection 2015": { series: "Other", set: "mcd15" },
    "McDonald's Collection 2016": { series: "Other", set: "mcd16" },
    "McDonald's Collection 2017": { series: "Other", set: "mcd17" },
    "McDonald's Collection 2018": { series: "Other", set: "mcd18" },
    "McDonald's Collection 2019": { series: "Other", set: "mcd19" },
    "McDonald's Collection 2021": { series: "Other", set: "mcd21" },
    "McDonald's Collection 2022": { series: "Other", set: "mcd22" },
    "Mega Evolution": { series: "Mega Evolution", set: "me1" },
    "Mysterious Treasures": { series: "Diamond & Pearl", set: "dp2" },
    "Neo Destiny": { series: "Neo", set: "neo4" },
    "Neo Discovery": { series: "Neo", set: "neo2" },
    "Neo Genesis": { series: "Neo", set: "neo1" },
    "Neo Revelation": { series: "Neo", set: "neo3" },
    "Next Destinies": { series: "Black & White", set: "bw4" },
    "Nintendo Black Star Promos": { series: "NP", set: "np" },
    "Noble Victories": { series: "Black & White", set: "bw3" },
    "Obsidian Flames": { series: "Scarlet & Violet", set: "sv3" },
    "POP Series 1": { series: "POP", set: "pop1" },
    "POP Series 2": { series: "POP", set: "pop2" },
    "POP Series 3": { series: "POP", set: "pop3" },
    "POP Series 4": { series: "POP", set: "pop4" },
    "POP Series 5": { series: "POP", set: "pop5" },
    "POP Series 6": { series: "POP", set: "pop6" },
    "POP Series 7": { series: "POP", set: "pop7" },
    "POP Series 8": { series: "POP", set: "pop8" },
    "POP Series 9": { series: "POP", set: "pop9" },
    "Paldea Evolved": { series: "Scarlet & Violet", set: "sv2" },
    "Paldean Fates": { series: "Scarlet & Violet", set: "sv4pt5" },
    "Paradox Rift": { series: "Scarlet & Violet", set: "sv4" },
    "Phantom Forces": { series: "XY", set: "xy4" },
    "Plasma Blast": { series: "Black & White", set: "bw10" },
    "Plasma Freeze": { series: "Black & White", set: "bw9" },
    "Plasma Storm": { series: "Black & White", set: "bw8" },
    Platinum: { series: "Platinum", set: "pl1" },
    "Pokémon Futsal Collection": { series: "Other", set: "fut20" },
    "Pokémon GO": { series: "Sword & Shield", set: "pgo" },
    "Pokémon Rumble": { series: "Other", set: "ru1" },
    "Power Keepers": { series: "EX", set: "ex16" },
    "Primal Clash": { series: "XY", set: "xy5" },
    "Prismatic Evolutions": { series: "Scarlet & Violet", set: "sv8pt5" },
    "Rebel Clash": { series: "Sword & Shield", set: "swsh2" },
    "Rising Rivals": { series: "Platinum", set: "pl2" },
    "Roaring Skies": { series: "XY", set: "xy6" },
    "Ruby & Sapphire": { series: "EX", set: "ex1" },
    "SM Black Star Promos": { series: "Sun & Moon", set: "smp" },
    "SWSH Black Star Promos": { series: "Sword & Shield", set: "swshp" },
    Sandstorm: { series: "EX", set: "ex2" },
    "Scarlet & Violet": { series: "Scarlet & Violet", set: "sv1" },
    "Scarlet & Violet Black Star Promos": {
      series: "Scarlet & Violet",
      set: "svp",
    },
    "Scarlet & Violet Energies": { series: "Scarlet & Violet", set: "sve" },
    "Secret Wonders": { series: "Diamond & Pearl", set: "dp3" },
    "Shining Fates": { series: "Sword & Shield", set: "swsh45" },
    "Shining Fates Shiny Vault": { series: "Sword & Shield", set: "swsh45sv" },
    "Shining Legends": { series: "Sun & Moon", set: "sm35" },
    "Shrouded Fable": { series: "Scarlet & Violet", set: "sv6pt5" },
    "Silver Tempest": { series: "Sword & Shield", set: "swsh12" },
    "Silver Tempest Trainer Gallery": {
      series: "Sword & Shield",
      set: "swsh12tg",
    },
    Skyridge: { series: "E-Card", set: "ecard3" },
    "Southern Islands": { series: "Other", set: "si1" },
    "Steam Siege": { series: "XY", set: "xy11" },
    "Stellar Crown": { series: "Scarlet & Violet", set: "sv7" },
    Stormfront: { series: "Diamond & Pearl", set: "dp7" },
    "Sun & Moon": { series: "Sun & Moon", set: "sm1" },
    "Supreme Victors": { series: "Platinum", set: "pl3" },
    "Surging Sparks": { series: "Scarlet & Violet", set: "sv8" },
    "Sword & Shield": { series: "Sword & Shield", set: "swsh1" },
    "Team Magma vs Team Aqua": { series: "EX", set: "ex4" },
    "Team Rocket": { series: "Base", set: "base5" },
    "Team Rocket Returns": { series: "EX", set: "ex7" },
    "Team Up": { series: "Sun & Moon", set: "sm9" },
    "Temporal Forces": { series: "Scarlet & Violet", set: "sv5" },
    "Twilight Masquerade": { series: "Scarlet & Violet", set: "sv6" },
    "Ultra Prism": { series: "Sun & Moon", set: "sm5" },
    "Unbroken Bonds": { series: "Sun & Moon", set: "sm10" },
    "Unified Minds": { series: "Sun & Moon", set: "sm11" },
    "Unseen Forces": { series: "EX", set: "ex10" },
    "Vivid Voltage": { series: "Sword & Shield", set: "swsh4" },
    "White Flare": { series: "Scarlet & Violet", set: "rsv10pt5" },
    "Wizards Black Star Promos": { series: "Base", set: "basep" },
    XY: { series: "XY", set: "xy1" },
    "XY Black Star Promos": { series: "XY", set: "xyp" },
    // TCGCSV set name mappings
    "Neo Destiny": { series: "Neo", set: "neo4" },
    "SM - Team Up": { series: "Sun & Moon", set: "sm9" },
    "SWSH07: Evolving Skies": { series: "Sword & Shield", set: "swsh7" },
    "Holon Phantoms": { series: "EX", set: "ex12" },
    "Power Keepers": { series: "EX", set: "ex14" },
    "Base Set (Shadowless)": { series: "Base", set: "base1" },
    Skyridge: { series: "E-Card", set: "ecard3" },
    "Delta Species": { series: "EX", set: "ex13" },
  };

  // Try to find set info from set name
  // Helper function to get display name (prefer clean_name for Japanese cards, fallback to name)
  const getDisplayName = (card) => {
    if (!card) return "";
    let name = "";
    // For Japanese cards, prefer clean_name
    if (card.language === "ja" && card.clean_name) {
      name = card.clean_name;
    } else {
      // For other cards, use clean_name if available, otherwise name
      name = card.clean_name || card.cleanName || card.name || "";
    }

    // Remove card number suffixes (e.g., "086", "086/165", "- 086", "125 094")
    // Handle multiple patterns and multiple trailing numbers
    name = name
      .replace(/\s*-\s*\d+\/?\d*\s*$/, "") // Remove "- 086" or "- 086/165"
      .replace(/\s+\d+\s+\d+\s*$/, "") // Remove trailing " 125 094" (two numbers)
      .replace(/\s+\d+\/?\d*\s*$/, "") // Remove trailing " 086" or " 086/165" (single number)
      .replace(/\s*\/\s*\d+\s*$/, "") // Remove trailing "/ 094"
      .replace(/\s*\(\d+\)\s*$/, "") // Remove "(086)"
      .trim();

    return name;
  };

  // Helper function to get display set name (prefer clean_name if available)
  const getDisplaySetName = (card) => {
    if (!card) return "";
    let setName =
      card.clean_set_name || card.set_name || card.set?.name || card.set || "";

    // Remove set ID prefix (e.g., "SV2D: ", "SV1a: ", "SWSH07: ")
    // Pattern matches: letters/numbers followed by colon and space
    setName = setName.replace(/^[A-Z0-9]+[a-z]?\d*[a-z]?:\s*/i, "").trim();

    return setName;
  };

  let setInfo = setMap[card.set_name] || setMap[card.set];

  // Fallback: try to extract from set_id (e.g., "me01" → series: "me", set: "me01")
  if (!setInfo && card.set_id) {
    const setId = card.set_id;
    const seriesMatch = setId.match(/^([a-z]+)/i);
    if (seriesMatch) {
      setInfo = { series: seriesMatch[1], set: setId };
    }
  }

  // Final fallback
  if (!setInfo) {
    setInfo = { series: "base", set: "base1" };
  }

  // Construct the TCGdx URL: https://assets.tcgdex.net/{language}/{series}/{set}/{cardNumber}/{quality}.{extension}
  const baseUrl = "https://assets.tcgdex.net/en";
  const cardNumber = card.formattedNumber || card.number || "1";

  return `${baseUrl}/${setInfo.series}/${setInfo.set}/${cardNumber}/${quality}.${extension}`;
}

// seriesFromSetName now provided by utils/series

// Function to get set symbol path
function getSetSymbolPath(setName, series, language = "en") {
  // Japanese set symbol mapping
  const japaneseSetSymbolMap = {
    // Scarlet & Violet Series
    "SV7: Stellar Miracle": "Stellar Miracle.png",
    "Stellar Miracle": "Stellar Miracle.png",
    "SV6a: Night Wanderer": "Night Wanderer.png",
    "Night Wanderer": "Night Wanderer.png",
    "SV6: Transformation Mask": "Transformation Mask.png",
    "Transformation Mask": "Transformation Mask.png",
    "SV5M: Cyber Judge": "Cyber Judge.png",
    "Cyber Judge": "Cyber Judge.png",
    "SV5K: Wild Force": "Wild Force.png",
    "Wild Force": "Wild Force.png",
    "SV5a: Crimson Haze": "Crimson Haze.png",
    "Crimson Haze": "Crimson Haze.png",
    "SV4M: Future Flash": "Future Flash.png",
    "Future Flash": "Future Flash.png",
    "SV4K: Ancient Roar": "Ancient Roar.png",
    "Ancient Roar": "Ancient Roar.png",
    "SV4a: Shiny Treasure ex": "Shiny Treasure ex.png",
    "Shiny Treasure ex": "Shiny Treasure ex.png",
    "SV3a: Raging Surf": "Raging Surf.png",
    "Raging Surf": "Raging Surf.png",
    "SV3: Ruler of the Black Flame": "Ruler of the Black Flame.png",
    "Ruler of the Black Flame": "Ruler of the Black Flame.png",
    "SV2P: Snow Hazard": "Snow Hazard.png",
    "Snow Hazard": "Snow Hazard.png",
    "SV2D: Clay Burst": "Clay Burst.png",
    "Clay Burst": "Clay Burst.png",
    "SV2a: Pokemon Card 151": "Pokémon Card 151.png",
    "Pokemon Card 151": "Pokémon Card 151.png",
    "Pokémon Card 151": "Pokémon Card 151.png",
    "SV1V: Violet ex": "Violet ex.png",
    "Violet ex": "Violet ex.png",
    "SV1S: Scarlet ex": "Scarlet ex.png",
    "Scarlet ex": "Scarlet ex.png",
    "SV1a: Triplet Beat": "Triplet Beat.png",
    "Triplet Beat": "Triplet Beat.png",
    "S12: Paradigm Trigger": "Paradigm Trigger.png",
    "Paradigm Trigger": "Paradigm Trigger.png",
    "S12a: VSTAR Universe": "VSTAR Universe.png",
    "VSTAR Universe": "VSTAR Universe.png",
    "S9a: Battle Region": "Battle Region.png",
    "Battle Region": "Battle Region.png",
    // Sword & Shield Series
    "S11: Lost Abyss": "Lost Abyss.png",
    "Lost Abyss": "Lost Abyss.png",
    "S10: Incandescent Arcana": "Incandescent Arcana.png",
    "Incandescent Arcana": "Incandescent Arcana.png",
    "S9: Dark Phantasma": "Dark Phantasma.png",
    "Dark Phantasma": "Dark Phantasma.png",
    "S8: Time Gazer": "Time Gazer.png",
    "Time Gazer": "Time Gazer.png",
    "S8a: Space Juggler": "Space Juggler.png",
    "Space Juggler": "Space Juggler.png",
    "S7: Star Birth": "Star Birth.png",
    "Star Birth": "Star Birth.png",
    "S6: Fusion Arts": "Fusion Arts.png",
    "Fusion Arts": "Fusion Arts.png",
    "S5: Blue Sky Stream": "Blue Sky Stream.png",
    "Blue Sky Stream": "Blue Sky Stream.png",
    "S5a: Skyscraping Perfection": "Skyscraping Perfection.png",
    "Skyscraping Perfection": "Skyscraping Perfection.png",
    "S4: Jet-Black Spirit": "Jet-Black Spirit.png",
    "Jet-Black Spirit": "Jet-Black Spirit.png",
    "S4a: Silver Lance": "Silver Lance.png",
    "Silver Lance": "Silver Lance.png",
    "S3: Rapid Strike Master": "Rapid Strike Master.png",
    "Rapid Strike Master": "Rapid Strike Master.png",
    "S3a: Single Strike Master": "Single Strike Master.png",
    "Single Strike Master": "Single Strike Master.png",
    "S2: Amazing Volt Tackle": "Amazing Volt Tackle.png",
    "Amazing Volt Tackle": "Amazing Volt Tackle.png",
    "S1: Infinity Zone": "Infinity Zone.png",
    "Infinity Zone": "Infinity Zone.png",
    "S1a: Rebellion Crash": "Rebellion Crash.png",
    "Rebellion Crash": "Rebellion Crash.png",
    "S1V: Shield": "Shield.png",
    Shield: "Shield.png",
    "S1S: Sword": "Sword.png",
    Sword: "Sword.png",
    "S1a: Alter Genesis": "Alter Genesis.png",
    "Alter Genesis": "Alter Genesis.png",
    "S1: Miracle Twin": "Miracle Twin.png",
    "Miracle Twin": "Miracle Twin.png",
    "S1a: Double Blaze": "Double Blaze.png",
    "Double Blaze": "Double Blaze.png",
    "S1a: Tag Bolt": "Tag Bolt.png",
    "Tag Bolt": "Tag Bolt.png",
    "S1: Super-Burst Impact": "Super-Burst Impact.png",
    "Super-Burst Impact": "Super-Burst Impact.png",
    "S1a: Sky-Splitting Charisma": "Sky-Splitting Charisma.png",
    "Sky-Splitting Charisma": "Sky-Splitting Charisma.png",
    "S1: Forbidden Light": "Forbidden Light.png",
    "Forbidden Light": "Forbidden Light.png",
    "S1a: Ultra Moon": "Ultra Moon.png",
    "Ultra Moon": "Ultra Moon.png",
    "S1V: Ultra Sun": "Ultra Sun.png",
    "Ultra Sun": "Ultra Sun.png",
    "S1a: Ultradimensional Beasts": "Ultradimensional Beasts.png",
    "Ultradimensional Beasts": "Ultradimensional Beasts.png",
    "S1: Awakened Heroes": "Awakened Heroes.png",
    "Awakened Heroes": "Awakened Heroes.png",
    "S1a: Darkness that Consumes Light": "Darkness that Consumes Light.png",
    "Darkness that Consumes Light": "Darkness that Consumes Light.png",
    "S1: To Have Seen the Battle Rainbow":
      "To Have Seen the Battle Rainbow.png",
    "To Have Seen the Battle Rainbow": "To Have Seen the Battle Rainbow.png",
    "S1a: Alolan Moonlight": "Alolan Moonlight.png",
    "Alolan Moonlight": "Alolan Moonlight.png",
    "S1V: Islands Await You": "Islands Await You.png",
    "Islands Await You": "Islands Await You.png",
    "S1: Collection Moon": "Collection Moon.png",
    "Collection Moon": "Collection Moon.png",
    "S1V: Collection Sun": "Collection Sun.png",
    "Collection Sun": "Collection Sun.png",
    "S1a: Shining Legends": "Shining Legends.png",
    "Shining Legends": "Shining Legends.png",
    "S1: Facing a New Trial": "Facing a New Trial.png",
    "Facing a New Trial": "Facing a New Trial.png",
    "S1V: Sun & Moon": "Sun & Moon.png",
    "Sun & Moon": "Sun & Moon.png",
    // Promos and Special Sets
    "SV-P Promotional cards": "SV-P Promotional cards.png",
    "S-P Promotional cards": "S-P Promotional cards.png",
    "SM-P Promotional cards": "SM-P Promotional cards.png",
    "XY-P Promotional cards": "XY-P Promotional cards.png",
    "BW-P Promotional cards": "BW-P Promotional cards.png",
    "L-P Promotional cards": "L-P Promotional cards.png",
    "DPt-P Promotional cards": "DPt-P Promotional cards.png",
    "DP-P Promotional cards": "DP-P Promotional cards.png",
    "PCG-P Promotional cards": "PCG-P Promotional cards.png",
    "PLAY Promotional cards": "PLAY Promotional cards.png",
    "PPP Promotional cards": "PPP Promotional cards.png",
    "T Promotional cards": "T Promotional cards.png",
    "J Promotional cards": "J Promotional cards.png",
    "P Promotional cards": "P Promotional cards.png",
    "M-P Promotional cards": "M-P Promotional cards.png",
    "ADV-P Promotional cards": "ADV-P Promotional cards.png",
    "25th Anniversary Collection": "25th Anniversary Collection.png",
    "Pokémon GO": "Pokémon GO.png",
    "Pokemon GO": "Pokémon GO.png",
    "VMAX Climax": "VMAX Climax.png",
    "Shiny Star V": "Shiny Star V.png",
    "Eevee Heroes": "Eevee Heroes.png",
    "Peerless Fighters": "Peerless Fighters.png",
    "Legendary Heartbeat": "Legendary Heartbeat.png",
    "Explosive Walker": "Explosive Walker.png",
    "VMAX Rising": "VMAX Rising.png",
    "TAG TEAM GX- Tag All Stars": "TAG TEAM GX- Tag All Stars.png",
    "GX Ultra Shiny": "GX Ultra Shiny.png",
    "GX Battle Boost": "GX Battle Boost.png",
    "Dream League": "Dream League.png",
    "Remix Bout": "Remix Bout.png",
    "Sky Legend": "Sky Legend.png",
    "GG End": "GG End.png",
    "Full Metal Wall": "Full Metal Wall.png",
    "Night Unison": "Night Unison.png",
    "Dark Order": "Dark Order.png",
    "Fairy Rise": "Fairy Rise.png",
    "Thunderclap Spark": "Thunderclap Spark.png",
    "Champion Road": "Champion Road.png",
    "Dragon Storm": "Dragon Storm.png",
    "Ultra Force": "Ultra Force.png",
    "THE BEST OF XY": "THE BEST OF XY.png",
    "Expansion Pack 20th Anniversary": "Expansion Pack 20th Anniversary.png",
    "Mythical & Legendary Dream Shine Collection":
      "Mythical & Legendary Dream Shine Collection.png",
    "Premium Champion Pack": "Premium Champion Pack.png",
    "PokéKyun Collection": "PokéKyun Collection.png",
    "Legendary Shine Collection": "Legendary Shine Collection.png",
    "Magma Gang VS Aqua Gang- Double Crisis":
      "Magma Gang VS Aqua Gang- Double Crisis.png",
    "EX Battle Boost": "EX Battle Boost.png",
    "Shiny Collection": "Shiny Collection.png",
    "Dragon Selection": "Dragon Selection.png",
    "Lost Link": "Lost Link.png",
    "Magma VS Aqua- Two Ambitions": "Magma VS Aqua- Two Ambitions.png",
    "Inferno X": "Inferno X.png",
    "Mega Symphonia Mega Evolution": "Mega Symphonia.png",
    "Mega Brave": "Mega Brave.png",
    "White Flare": "White Flare.png",
    "Black Bolt": "Black Bolt .png",
    "Glory of the Rocket Gang": "Glory of the Rocket Gang.png",
    "Battle Partners": "Battle Partners.png",
    "Super Electric Breaker": "Super Electric Breaker.png",
    "Hot Wind Arena": "Hot Wind Arena.png",
    "Paradise Dragona": "Paradise Dragona.png",
    "Terastal Fest ex": "Terastal Fest ex.png",
    "Collection Sheet Journey Partners":
      "Collection Sheet Journey Partners.png",
    "World Collection": "World Collection.png",
    "Movie Commemoration Premium Sheet":
      "Movie Commemoration Premium Sheet.png",
    "McDonald's Original Minimum★Pack": "McDonald's Original Minimum★Pack.png",
    "Southern Islands": "Southern Islands.png",
    "Expansion Sheet- Vending Machine cards Series 1 (Blue)":
      "Expansion Sheet- Vending Machine cards Series 1 (Blue).png",
    "Expansion Sheet- Vending Machine cards Series 2 (Red)":
      "Expansion Sheet- Vending Machine cards Series 2 (Red).png",
    "Expansion Sheet- Vending Machine cards Series 3 (Green)":
      "Expansion Sheet- Vending Machine cards Series 3 (Green).png",
    "MEGA Dream ex": "MEGA Dream ex.png",
    "Promo Card Pack 25th Anniversary Edition":
      "Promo Card Pack 25th Anniversary Edition.png",
    " Great Detective Pikachu": " Great Detective Pikachu.png",
    "Great Detective Pikachu": " Great Detective Pikachu.png",
  };

  // If Japanese language, use Japanese set symbols
  if (language === "ja") {
    // Try exact match first
    let symbolFile =
      japaneseSetSymbolMap[setName] ||
      japaneseSetSymbolMap[cleanSetName(setName)];

    // If not found, try to match by cleaning the set name
    if (!symbolFile) {
      const cleaned = cleanSetName(setName);
      // Try matching with cleaned name
      for (const [key, value] of Object.entries(japaneseSetSymbolMap)) {
        if (
          cleanSetName(key) === cleaned ||
          key.includes(cleaned) ||
          cleaned.includes(cleanSetName(key))
        ) {
          symbolFile = value;
          break;
        }
      }
    }

    // If still not found, try to construct filename from cleaned name
    if (!symbolFile) {
      const cleaned = cleanSetName(setName);
      // Remove set codes like "SV4K:", "S12:", etc.
      const withoutCode = cleaned
        .replace(/^[A-Z0-9]+[a-z]?\d*[a-z]?:\s*/i, "")
        .trim();
      symbolFile = `${withoutCode}.png`;
    }

    return `/Assets/Set Symbols _Japanese/${symbolFile}`;
  }

  // English/International set symbols (existing logic)
  const cleanedName = cleanSetName(setName);
  const normalizedName = cleanedName
    .replace(/\s*\([^)]*\)/g, "")
    .replace(/\s*\[[^\]]*\]/g, "")
    .replace(/\s*(?:-|—|–|:)\s*.*$/, "")
    .replace(/\s+/g, " ")
    .replace(/'/g, "_")
    .replace(/&/g, "_")
    .trim();

  const seriesFolderMap = {
    Base: "01 Base",
    Gym: "02 Gym",
    Neo: "03 Neo",
    "Legendary Collection": "04 Legendary Collection",
    "Team Rocket": "01 Base",
    eCard: "05 eCard",
    EX: "06 EX",
    "Diamond & Pearl": "07 Diamond and Pearl",
    Nintendo: "08 Nintendo",
    Platinum: "09 Platinum",
    "HeartGold & SoulSilver": "10 HeartGold SoulSilver",
    "Black & White": "11 Black & White",
    XY: "12 XY",
    "Sun & Moon": "13 Sun & Moon",
    "Sword & Shield": "14 Sword & Shield",
    "Scarlet & Violet": "15 Scarlet & Violet",
    "Mega Evolutions": "16 Mega Evolutions",
  };

  const normalizedSeriesKey = (() => {
    const s = (series || "").toString().toLowerCase();
    if (s.includes("scarlet") && s.includes("violet"))
      return "Scarlet & Violet";
    if (s.includes("sword") && s.includes("shield")) return "Sword & Shield";
    if (s.includes("sun") && s.includes("moon")) return "Sun & Moon";
    if (s.includes("heartgold") || s.includes("soul"))
      return "HeartGold & SoulSilver";
    if (s.includes("diamond") || s.includes("pearl")) return "Diamond & Pearl";
    if (s.includes("black") && s.includes("white")) return "Black & White";
    if (s.includes("legendary") && s.includes("collection"))
      return "Legendary Collection";
    if (s.includes("platinum")) return "Platinum";
    if (s.includes("nintendo")) return "Nintendo";
    if (s.includes("xy")) return "XY";
    if (s.includes("neo")) return "Neo";
    if (s.includes("gym")) return "Gym";
    if (s.includes("team rocket")) return "Team Rocket";
    if (s.includes("base")) return "Base";
    if (s.includes("e-card") || s.includes("ecard") || s.includes("e card"))
      return "eCard";
    if (s.includes("ex")) return "EX";
    if (s.includes("mega")) return "Mega Evolutions";
    return "";
  })();

  let seriesFolder =
    seriesFolderMap[normalizedSeriesKey] ||
    seriesFolderMap[series] ||
    "15 Scarlet & Violet";
  if (cleanedName === "Mega Evolution" || setName === "Mega Evolution")
    seriesFolder = "16 Mega Evolutions";
  if (cleanedName === "Call of Legends")
    seriesFolder = "10 HeartGold SoulSilver";
  if (
    cleanedName === "HeartGold SoulSilver" ||
    setName === "HeartGold SoulSilver"
  )
    seriesFolder = "10 HeartGold SoulSilver";
  if (setName === "WoTC Promo" || setName === "WOTC Promo")
    seriesFolder = "01 Base";
  if (setName === "Southern Islands") seriesFolder = "03 Neo";
  if (
    cleanedName === "Ruby and Sapphire" ||
    cleanedName === "Ruby & Sapphire" ||
    setName === "Ruby and Sapphire" ||
    setName === "Ruby & Sapphire"
  )
    seriesFolder = "06 EX";
  if (setName === "Prize Pack Series Cards") seriesFolder = "14 Sword & Shield";
  if (setName === "McDonald's Promos 2022") seriesFolder = "14 Sword & Shield";
  if (
    setName === "Celebrations" ||
    setName === "Celebrations: Classic Collection"
  )
    seriesFolder = "14 Sword & Shield";
  if (setName === "McDonald's 25th Anniversary Promos")
    seriesFolder = "14 Sword & Shield";
  if (setName === "McDonald's Promos 2019") seriesFolder = "13 Sun & Moon";
  if (setName === "Hidden Fates" || setName === "Hidden Fates: Shiny Vault")
    seriesFolder = "13 Sun & Moon";
  if (setName === "Detective Pikachu") seriesFolder = "13 Sun & Moon";
  if (setName === "McDonald's Promos 2018") seriesFolder = "13 Sun & Moon";
  if (setName === "Dragon Majesty") seriesFolder = "13 Sun & Moon";
  if (setName === "McDonald's Promos 2017") seriesFolder = "13 Sun & Moon";
  if (setName === "McDonald's Promos 2016") seriesFolder = "12 XY";
  if (setName === "Generations: Radiant Collection") seriesFolder = "12 XY";
  if (setName === "Double Crisis") seriesFolder = "12 XY";
  if (setName === "McDonald's Promos 2015") seriesFolder = "12 XY";
  if (setName === "McDonald's Promos 2014") seriesFolder = "12 XY";
  if (
    setName === "Legendary Treasures" ||
    setName === "Legendary Treasures: Radiant Collection"
  )
    seriesFolder = "11 Black & White";
  if (setName === "Dragon Vault") seriesFolder = "11 Black & White";
  if (setName === "McDonald's Promos 2011") seriesFolder = "11 Black & White";
  if (setName === "McDonald's Promos 2012") seriesFolder = "11 Black & White";
  if (setName === "McDonald's Promos 2013") seriesFolder = "11 Black & White";
  if (setName === "Rumble") seriesFolder = "09 Platinum";

  const setFileMap = {
    "ME01: Mega Evolution": "mega-evolution.png",
    "ME02: Phantasmal Flames": "Phantasmal Flame.png",
    "Call of Legends": "Call of Legends.png",
    "Champion's Path": "Champion_s Path.png",
    "Base Set": "Base Set.png",
    "Base Set 2": "Base Set 2.png",
    Jungle: "Jungle.png",
    Fossil: "Fossil.png",
    "Gym Heroes": "Gym Heroes.png",
    "Gym Challenge": "Gym Challenge.png",
    "Neo Genesis": "Neo Genesis.png",
    "Neo Discovery": "Neo Discovery.png",
    "Neo Revelation": "Neo Revelation.png",
    "Neo Destiny": "Neo Destiny.png",
    "Southern Islands": "Southern Isles.png",
    "Pop Series 1": "Pop 1.png",
    "POP Series 1": "Pop 1.png",
    "Pop Series 2": "Pop 2.png",
    "POP Series 2": "Pop 2.png",
    "Pop Series 3": "Pop 3.png",
    "POP Series 3": "Pop 3.png",
    "Pop Series 4": "Pop 4.png",
    "POP Series 4": "Pop 4.png",
    "Pop Series 5": "Pop 5.png",
    "POP Series 5": "Pop 5.png",
    "Pop Series 6": "Pop 6.png",
    "POP Series 6": "Pop 6.png",
    "Pop Series 7": "Pop 7.png",
    "POP Series 7": "Pop 7.png",
    "Pop Series 8": "Pop 8.png",
    "POP Series 8": "Pop 8.png",
    "Pop Series 9": "Pop 9.png",
    "POP Series 9": "Pop 9.png",
    Aquapolis: "Aquapolis.png",
    Skyridge: "Skyridge.png",
    "Expedition Base Set": "Expedition Base Set.png",
    "Ruby & Sapphire": "Ruby & Sapphire.png",
    "Ruby and Sapphire": "Ruby & Sapphire.png",
    Sandstorm: "Sandstorm.png",
    Dragon: "Dragon.png",
    "Delta Species": "Delta Species.png",
    "Dragon Frontiers": "Dragon Frontiers.png",
    "Team Rocket Returns": "Team Rocket Returns.png",
    "Hidden Legends": "Hidden Legends.png",
    "Hidden Fates": "Hidden Fates.png",
    "Hidden Fates: Shiny Vault": "Hidden Fates.png",
    "Detective Pikachu": "Detective Pikachu.png",
    "Dragon Majesty": "Dragon Majesty.png",
    Flashfire: "XY Flashfire.png",
    XY: "XY.png",
    "XY Base Set": "XY.png",
    Deoxys: "Deoxys.png",
    "Holon Phantoms": "Holon Phantoms.png",
    "Legend Maker": "Legend Maker.png",
    "Power Keepers": "Power Keepers.png",
    "Unseen Forces": "Unseen Forces.png",
    Emerald: "Emerald.png",
    "Crystal Guardians": "Crystal Guardians.png",
    "FireRed & LeafGreen": "FireRed LeafGreen.png",
    "Team Magma vs Team Aqua": "Team Magma vs. Team Aqua.png",
    "Team Rocket": "Team Rocket.png",
    Rumble: "Pokemon Rumble.png",
    "Black and White": "Black & White.png",
    "Black & White": "Black & White.png",
    "Black Bolt": "black-bolt.png",
    "White Flare": "white-flare.png",
    "Destined Rivals": "destined-rivals.png",
    "Legendary Treasures": "Legendary Treasures.png",
    "Legendary Treasures: Radiant Collection": "Legendary Treasures.png",
    "McDonald's Promos 2011": "McDonald_s Collection 2011.png",
    "McDonald's Promos 2012": "McDonald_s Collection 2012.png",
    "McDonald's Promos 2013": "McDonald_s Collection 2013.png",
    "McDonald's Promos 2014": "McDonald_s Collection 2014.png",
    "McDonald's Promos 2015": "McDonald_s Collection 2015.png",
    "McDonald's Promos 2016": "McDonald_s Collection 2016.png",
    "McDonald's Promos 2017": "McDonald_s Collection 2017.png",
    "McDonald's Promos 2018": "S&M McDonald_s Collection 2018.png",
    "McDonald's Promos 2019": "S&M McDonald_s Collection 2019.png",
    "McDonald's Promos 2022": "McDonald_s Match Battle 2022.png",
    "McDonald's Promos 2023": "McDonald_s Match Battle 2023.png",
    "McDonald's Promos 2024": "McDonald_s Dragon Discovery.png",
    "McDonald's 25th Anniversary Promos":
      "S&S McDonald_s Collection 25th Anniversary.png",
    "Mega Evolution": "mega-evolution.png",
    "Prismatic Evolutions": "Prismatic Evolutions.png",
    Evolutions: "XY Evolutions.png",
    "Fates Collide": "XY Fates Collide.png",
    "Steam Siege": "XY Steam Siege.png",
    "Surging Sparks": "Surging Sparks.png",
    "Stellar Crown": "Stellar Crown.png",
    "Shrouded Fable": "Shrouded Fable.png",
    "Twilight Masquerade": "Twilight Masquerade.png",
    "Temporal Forces": "Temporal Forces.png",
    "Paldean Fates": "Paldean Fates.png",
    "Paradox Rift": "Paradox Rift.png",
    "Obsidian Flames": "Obsidian Flames.png",
    151: "151.png",
    "Paldea Evolved": "Paldea Evolved.png",
    "Scarlet & Violet": "Scarlet & Violet.png",
    "SV: Scarlet & Violet Promo Cards": "Scarlet & Violet Promos.png",
    "SVE: Scarlet & Violet Energies": "scarlet-and-violet-energies.png",
    "Crown Zenith": "Crown Zenith.png",
    "Crown Zenith: Galarian Gallery": "Crown Zenith.png",
    "Silver Tempest": "Silver Tempest.png",
    "SWSH12: Silver Tempest Trainer Gallery": "Silver Tempest.png",
    "Lost Origin": "Lost Origin.png",
    "SWSH11: Lost Origin Trainer Gallery": "Lost Origin.png",
    "Brilliant Stars": "Brilliant Stars.png",
    "SWSH09: Brilliant Stars Trainer Gallery": "Brilliant Stars.png",
    "Astral Radiance": "Astral Radiance.png",
    "SWSH10: Astral Radiance Trainer Gallery": "Astral Radiance.png",
    "Fusion Strike": "Fusion Strike.png",
    "Evolving Skies": "Evolving Skies.png",
    "Chilling Reign": "Chilling Reign.png",
    "Battle Styles": "Battle Styles.png",
    "Shining Fates": "Shining Fates.png",
    "Shining Fates: Shiny Vault": "Shining Fates.png",
    "Vivid Voltage": "Vivid Voltage.png",
    "Darkness Ablaze": "Darkness Ablaze.png",
    "Rebel Clash": "Rebel Clash.png",
    "Sword & Shield": "Sword & Shield.png",
    Generations: "XY Generations.png",
    "Generations: Radiant Collection": "XY Generations.png",
    "Double Crisis": "Double Crisis.png",
    "Pokemon Go": "Pokemon Go.png",
    "Pokemon GO": "Pokemon Go.png",
    Promos: "_Promo.png",
    "WoTC Promo": "_Promo.png",
    "WOTC Promo": "_Promo.png",
    "HGSS Promos": "_Promo.png",
    "Black and White Promos": "_Promo.png",
    "XY Promos": "_Promo.png",
    "Sun and Moon Promo": "_Promo.png",
    "Trick or Trade BOOster Bundle": "_Trick or Trade.png",
    "Trick or Trade BOOster Bundle 2023": "_Trick or Trade.png",
    "Trick or Trade BOOster Bundle 2024": "_Trick or Trade.png",
  };

  const fileName =
    setFileMap[setName] || setFileMap[cleanedName] || `${cleanedName}.png`;

  // Special case: Promo symbols are in root Set Symbols folder
  if (fileName === "_Promo.png" || fileName === "_Trick or Trade.png") {
    return `/Assets/Set Symbols/${fileName}`;
  }

  return `/Assets/Set Symbols/${seriesFolder}/${fileName}`;
}

// Function to get set logo path
function getSetLogoPath(setName, series, language = "en") {
  // If Japanese language, use Japanese logos
  if (language === "ja") {
    const cleaned = cleanSetName(setName);
    // Remove set codes like "SV4K:", "S12:", etc.
    const withoutCode = cleaned
      .replace(/^[A-Z0-9]+[a-z]?\d*[a-z]?:\s*/i, "")
      .trim();
    // Try to match with available logo files
    // Most Japanese logos match the set name directly
    const logoFile = `${withoutCode}.png`;
    return `/Assets/Logo_Japanese/${logoFile}`;
  }

  // English/International logos (existing logic)
  const cleanedName = cleanSetName(setName);
  const normalizedName = cleanedName
    .replace(/\s*\([^)]*\)/g, "")
    .replace(/\s*\[[^\]]*\]/g, "")
    .replace(/\s*(?:-|—|–|:)\s*.*$/, "")
    .replace(/\s+/g, " ")
    .replace(/'/g, "_")
    .replace(/&/g, "_")
    .trim();

  const seriesFolderMap = {
    Base: "01 Base",
    Gym: "02 Gym",
    Neo: "03 Neo",
    "Legendary Collection": "04 Legendary Collection",
    "Team Rocket": "01 Base",
    eCard: "05 eCard",
    EX: "06 EX",
    "Diamond & Pearl": "07 Diamond and Pearl",
    Nintendo: "08 Nintendo",
    Platinum: "09 Platinum",
    "HeartGold & SoulSilver": "10 HeartGold SoulSilver",
    "Black & White": "11 Black & White",
    XY: "12 XY",
    "Sun & Moon": "13 Sun & Moon",
    "Sword & Shield": "14 Sword & Shield",
    "Scarlet & Violet": "15 Scarlet & Violet",
    "Mega Evolutions": "Mega Evolutions",
  };

  const normalizedSeriesKey = (() => {
    const s = (series || "").toString().toLowerCase();
    if (s.includes("scarlet") && s.includes("violet"))
      return "Scarlet & Violet";
    if (s.includes("sword") && s.includes("shield")) return "Sword & Shield";
    if (s.includes("sun") && s.includes("moon")) return "Sun & Moon";
    if (s.includes("heartgold") || s.includes("soul"))
      return "HeartGold & SoulSilver";
    if (s.includes("diamond") || s.includes("pearl")) return "Diamond & Pearl";
    if (s.includes("black") && s.includes("white")) return "Black & White";
    if (s.includes("legendary") && s.includes("collection"))
      return "Legendary Collection";
    if (s.includes("platinum")) return "Platinum";
    if (s.includes("nintendo")) return "Nintendo";
    if (s.includes("xy")) return "XY";
    if (s.includes("neo")) return "Neo";
    if (s.includes("gym")) return "Gym";
    if (s.includes("team rocket")) return "Team Rocket";
    if (s.includes("base")) return "Base";
    if (s.includes("e-card") || s.includes("ecard") || s.includes("e card"))
      return "eCard";
    if (s.includes("ex")) return "EX";
    if (s.includes("mega")) return "Mega Evolutions";
    return "";
  })();

  let seriesFolder =
    seriesFolderMap[normalizedSeriesKey] ||
    seriesFolderMap[series] ||
    "15 Scarlet & Violet";
  if (cleanedName === "Mega Evolution" || setName === "Mega Evolution")
    seriesFolder = "Mega Evolutions";
  if (cleanedName === "Call of Legends")
    seriesFolder = "10 HeartGold SoulSilver";
  if (
    cleanedName === "HeartGold SoulSilver" ||
    setName === "HeartGold SoulSilver"
  )
    seriesFolder = "10 HeartGold SoulSilver";
  if (setName === "WoTC Promo" || setName === "WOTC Promo")
    seriesFolder = "01 Base";
  if (setName === "Southern Islands") seriesFolder = "03 Neo";
  if (
    cleanedName === "Ruby and Sapphire" ||
    cleanedName === "Ruby & Sapphire" ||
    setName === "Ruby and Sapphire" ||
    setName === "Ruby & Sapphire"
  )
    seriesFolder = "06 EX";
  if (setName === "Prize Pack Series Cards") seriesFolder = "14 Sword & Shield";
  if (setName === "McDonald's Promos 2022") seriesFolder = "14 Sword & Shield";
  if (
    setName === "Celebrations" ||
    setName === "Celebrations: Classic Collection"
  )
    seriesFolder = "14 Sword & Shield";
  if (setName === "McDonald's 25th Anniversary Promos")
    seriesFolder = "14 Sword & Shield";
  if (setName === "McDonald's Promos 2019") seriesFolder = "13 Sun & Moon";
  if (setName === "Hidden Fates" || setName === "Hidden Fates: Shiny Vault")
    seriesFolder = "13 Sun & Moon";
  if (setName === "Detective Pikachu") seriesFolder = "13 Sun & Moon";
  if (setName === "McDonald's Promos 2018") seriesFolder = "13 Sun & Moon";
  if (setName === "Dragon Majesty") seriesFolder = "13 Sun & Moon";
  if (setName === "McDonald's Promos 2017") seriesFolder = "13 Sun & Moon";
  if (setName === "McDonald's Promos 2016") seriesFolder = "12 XY";
  if (setName === "Generations: Radiant Collection") seriesFolder = "12 XY";
  if (setName === "Double Crisis") seriesFolder = "12 XY";
  if (setName === "McDonald's Promos 2015") seriesFolder = "12 XY";
  if (setName === "McDonald's Promos 2014") seriesFolder = "12 XY";
  if (
    setName === "Legendary Treasures" ||
    setName === "Legendary Treasures: Radiant Collection"
  )
    seriesFolder = "11 Black & White";
  if (setName === "Dragon Vault") seriesFolder = "11 Black & White";
  if (setName === "McDonald's Promos 2011") seriesFolder = "11 Black & White";
  if (setName === "McDonald's Promos 2012") seriesFolder = "11 Black & White";
  if (setName === "McDonald's Promos 2013") seriesFolder = "11 Black & White";
  if (setName === "Rumble") seriesFolder = "09 Platinum";

  const logoFileMap = {
    "Team Magma vs Team Aqua": "Team Magma vs. Team Aqua.png",
    "Ruby & Sapphire": "Ruby & Sapphire.png",
    "Ruby and Sapphire": "Ruby & Sapphire.png",
    "FireRed & LeafGreen": "FireRed LeafGreen.png",
    Rumble: "Pokemon Rumble.png",
    Generations: "XY Generations.png",
    "Generations: Radiant Collection": "XY Generations Radiant Collection.png",
    "Double Crisis": "Double Crisis.png",
    Flashfire: "Flashfire.png",
    "Sun & Moon": "Sun & Moon.png",
    "SM Base Set": "Sun & Moon.png",
    Promos: "Sun & Moon Promos.png",
    "WoTC Promo": "WOTC Promos.png",
    "WOTC Promo": "WOTC Promos.png",
    "HGSS Promos": "HeartGold SoulSilver Promos.png",
    "Black and White Promos": "Black & White Promos.png",
    "XY Promos": "XY Promos.png",
    "Sun and Moon Promo": "Sun & Moon Promos.png",
    "Hidden Fates": "Hidden Fates.png",
    "Hidden Fates: Shiny Vault": "Hidden Fates.png",
    "Detective Pikachu": "Detective Pikachu.png",
    "Dragon Majesty": "Dragon Majesty.png",
    "Sword & Shield": "Sword & Shield.png",
    "SWSH: Sword & Shield Promo Cards": "Sword & Shield Promos.png",
    "Scarlet & Violet": "Scarlet & Violet.png",
    "Scarlet & Violet Base Set": "Scarlet & Violet.png",
    "Legendary Treasures": "Legendary Treasures1.png",
    "Legendary Treasures: Radiant Collection":
      "Legendary Treasures Radiant collection .png",
    "Delta Species": "Delta Species Logo.png",
    "Base Set": "Base.png",
    "Base Set (Shadowless)": "Base.png",
    "Southern Islands": "Southern Islands.png",
    "Pop Series 1": "Pop.png",
    "POP Series 1": "Pop.png",
    "Pop Series 2": "Pop.png",
    "POP Series 2": "Pop.png",
    "Pop Series 3": "Pop.png",
    "POP Series 3": "Pop.png",
    "Pop Series 4": "Pop.png",
    "POP Series 4": "Pop.png",
    "Pop Series 5": "Pop.png",
    "POP Series 5": "Pop.png",
    "Pop Series 6": "Pop.png",
    "POP Series 6": "Pop.png",
    "Pop Series 7": "Pop.png",
    "POP Series 7": "Pop.png",
    "Pop Series 8": "Pop.png",
    "POP Series 8": "Pop.png",
    "Pop Series 9": "Pop.png",
    "POP Series 9": "Pop.png",
    "ME01: Mega Evolution": "mega-evolution.png",
    "Mega Evolution": "mega-evolution.png",
    "ME: Mega Evolution Promo": "mega-evolution.png",
    "MEE: Mega Evolution Energies": "mega-evolution.png",
    "ME02: Phantasmal Flames": "Phantasmal Flames.png",
    "SV: Black Bolt": "black bolt.png",
    "SV: White Flare": "white flare.png",
    "SV10: Destined Rivals": "destined-rivals.png",
    "SV09: Journey Together": "Journey Together.png",
    "Journey Together": "Journey Together.png",
    "Prismatic Evolutions": "Prismatic Evolutions.png",
    "McDonald's Promos 2011": "B&W McDonald_s Collection.png",
    "McDonald's Promos 2012": "B&W McDonald_s Collection.png",
    "McDonald's Promos 2013": "B&W McDonald_s Collection.png",
    "McDonald's Promos 2014": "XY McDonald_s Collection.png",
    "McDonald's Promos 2015": "XY McDonald_s Collection.png",
    "McDonald's Promos 2016": "XY McDonald_s Collection.png",
    "McDonald's Promos 2017": "S&M McDonald_s Collection.png",
    "McDonald's Promos 2018": "S&M McDonald_s Collection.png",
    "McDonald's Promos 2019": "S&M McDonald_s Collection.png",
    "McDonald's Promos 2022": "Match Battle 2022.png",
    "McDonald's Promos 2023": "McDonald_s Match Battle 2023.png",
    "McDonald's Promos 2024": "McDonald_s Dragon Discovery.png",
    "McDonald's 25th Anniversary Promos":
      "S&S McDonald_s Collection 25th Anniversary.png",
    "Pokemon Go": "Pokemon Go.png",
    "Pokemon GO": "Pokemon Go.png",
    "Prize Pack Series Cards": "Play!_Pokémon_Prize_Pack_Series_2022_logo.png",
  };

  // Try exact matches first - check setName, cleanedName, and normalizedName
  let fileName = logoFileMap[setName];
  if (!fileName) {
    fileName = logoFileMap[cleanedName];
  }
  if (!fileName) {
    fileName = logoFileMap[normalizedName];
  }

  // If still no match, use normalized name with proper capitalization
  // (title case with spaces matches actual file naming convention)
  if (!fileName) {
    fileName = `${normalizedName}.png`;
  }

  return `/Assets/Logos/${seriesFolder}/${fileName}`;
}

// Function to format release date
function formatReleaseDate(dateString) {
  if (!dateString) return "";
  try {
    const date = new Date(dateString);
    if (isNaN(date.getTime())) return "";
    return date.toLocaleDateString("en-US", {
      year: "numeric",
      month: "short",
      day: "numeric",
    });
  } catch (error) {
    return "";
  }
}

// Get set code abbreviation
function getSetCode(set) {
  if (set.abbreviation) {
    return set.abbreviation.toUpperCase();
  }
  const words = set.name.split(" ");
  if (words.length === 1) {
    return words[0].substring(0, 3).toUpperCase();
  }
  return words
    .map((w) => w[0] || "")
    .join("")
    .substring(0, 3)
    .toUpperCase();
}

// Function to get the best available image URL
function getCardImageUrl(card) {
  // First try TCGCSV image_url (TCGPlayer URLs)
  if (card.image_url && card.image_url !== "/placeholder-card.png") {
    return card.image_url;
  }

  // Then try existing imageUrl or images
  if (card.imageUrl && card.imageUrl !== "/placeholder-card.png") {
    return card.imageUrl;
  }

  // Check if images is a string that needs to be parsed
  let images = card.images;
  if (typeof images === "string") {
    try {
      images = JSON.parse(images);
    } catch (e) {
      console.warn("Failed to parse images JSON:", e);
      images = {};
    }
  }

  if (
    images?.high &&
    typeof images.high === "string" &&
    images.high !== "/placeholder-card.png"
  ) {
    return images.high;
  }

  if (
    images?.large &&
    typeof images.large === "string" &&
    images.large !== "/placeholder-card.png"
  ) {
    return images.large;
  }

  if (
    images?.small &&
    typeof images.small === "string" &&
    images.small !== "/placeholder-card.png"
  ) {
    return images.small;
  }

  // If no existing image, try to construct TCGdx URL
  try {
    const constructedUrl = constructTCGdxImageUrl(card, "high", "webp");
    return constructedUrl;
  } catch (error) {
    console.warn("Failed to construct TCGdx URL for card:", card.name, error);
    return "/placeholder-card.png";
  }
}

// Marketplace Card Component
const MarketplaceCard = ({
  platform,
  cardName,
  setName,
  rarity,
  cardNumber,
  price,
  onClick,
  isCollection = false,
  isSelected = false,
  onPressStart,
  onPressEnd,
  onTouchStart,
  onTouchEnd,
  onTouchMove,
  cardImage,
  quantity = 1,
  onAddToCollection,
}) => {
  // Clean set name to remove set ID prefix (e.g., "SV2D: ", "SV1a: ", "SWSH07: ")
  const cleanedSetName = setName
    ? setName.replace(/^[A-Z0-9]+[a-z]?\d*[a-z]?:\s*/i, "").trim()
    : setName;
  const handleClick = async (e) => {
    e.preventDefault();
    e.stopPropagation(); // Prevent event bubbling

    // Always prioritize onClick handler (card profile) over affiliate links
    if (onClick) {
      onClick(e);
    } else if (!isCollection) {
      // Get affiliate link from marketplace service
      try {
        const affiliateLink = await marketplaceService.getAffiliateLink(
          platform,
          {
            cardName,
            setName,
            productId: null, // Could be passed if available
          }
        );

        if (affiliateLink) {
          window.open(affiliateLink, "_blank");
        } else {
          // Fallback to default platform URL
          const defaultLinks = {
            TCGPlayer: "https://www.tcgplayer.com",
            eBay: "https://www.ebay.com",
            Whatnot: "https://www.whatnot.com",
            Drip: "https://www.drip.com",
            Fanatics: "https://www.fanaticsollect.com",
          };
          window.open(defaultLinks[platform] || "#", "_blank");
        }
      } catch (error) {
        console.error("Error getting affiliate link:", error);
        // Fallback on error
        const defaultLinks = {
          TCGPlayer: "https://www.tcgplayer.com",
          eBay: "https://www.ebay.com",
          Whatnot: "https://www.whatnot.com",
          Drip: "https://www.drip.com",
          Fanatics: "https://www.fanaticsollect.com",
        };
        window.open(defaultLinks[platform] || "#", "_blank");
      }
    }
  };

  const cardClasses = `${
    isCollection ? "w-full" : "w-full min-w-0"
  } cursor-pointer hover:transform hover:scale-105 transition-transform ${
    isCollection && isSelected ? "ring-2 ring-blue-400 bg-blue-400/10" : ""
  }`;

  return (
    <div
      className={cardClasses}
      onClick={handleClick}
      onMouseDown={isCollection ? onPressStart : undefined}
      onMouseUp={isCollection ? onPressEnd : undefined}
      onMouseLeave={isCollection ? onPressEnd : undefined}
      onTouchStart={isCollection ? onTouchStart : undefined}
      onTouchEnd={isCollection ? onTouchEnd : undefined}
      onTouchMove={isCollection ? onTouchMove : undefined}
    >
      <div
        className={`bg-white/5 backdrop-blur-md rounded-xl ${
          isCollection ? "p-4" : "p-2 sm:p-3"
        } border border-white/10 shadow-xl hover:border-white/20 transition-all duration-300 ${
          isCollection ? "flex flex-col h-full" : "w-full h-full flex flex-col"
        } overflow-hidden`}
      >
        {/* Card Image */}
        <div
          className={`aspect-[3/4] bg-white/5 backdrop-blur-sm rounded-lg mb-3 flex items-center justify-center overflow-hidden relative ${
            isCollection ? "border border-white/10" : ""
          }`}
        >
          {(() => {
            // cardImage is already the processed URL from getCardImageUrl
            const imageUrl = cardImage;

            return imageUrl && imageUrl !== "/placeholder-card.png" ? (
              <img
                src={imageUrl}
                alt={cardName}
                className={`w-full h-full ${
                  isCollection ? "object-cover" : "object-contain"
                } rounded-lg`}
                style={
                  isCollection
                    ? {}
                    : {
                        filter: "contrast(1.1) saturate(1.1) brightness(1.05)",
                        mixBlendMode: "multiply",
                        imageRendering: "high-quality",
                      }
                }
                onError={(e) => {
                  console.log(
                    `Image failed to load for ${cardName}:`,
                    imageUrl
                  );
                  e.target.style.display = "none";
                  e.target.nextSibling.style.display = "flex";
                }}
                onLoad={() => {
                  console.log(
                    `Image loaded successfully for ${cardName}:`,
                    imageUrl
                  );
                }}
              />
            ) : null;
          })()}
          <span
            className="text-gray-400 text-xs"
            style={{
              display:
                cardImage && cardImage !== "/placeholder-card.png"
                  ? "none"
                  : "flex",
            }}
          >
            {cardImage === "/placeholder-card.png" ? "No Image" : "Card Image"}
          </span>
          {isCollection && isSelected && (
            <div className="absolute top-1 right-1 w-5 h-5 bg-gradient-to-r from-blue-500 to-indigo-600 rounded-full flex items-center justify-center">
              <svg
                className="w-3 h-3 text-white"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  strokeLinecap="round"
                  strokeLinejoin="round"
                  strokeWidth="2"
                  d="M5 13l4 4L19 7"
                />
              </svg>
            </div>
          )}
        </div>

        {/* Card Info */}
        <div
          className={`${
            isCollection ? "flex-grow flex flex-col" : "space-y-3"
          } min-w-0`}
        >
          {/* Card Name */}
          <div
            className={`${
              isCollection
                ? "dark:text-white text-theme-primary font-medium text-sm mb-1"
                : "dark:text-white text-theme-primary text-[14px] sm:text-[15px] md:text-[16px] font-bold leading-[normal] min-h-[20px]"
            } min-w-0`}
          >
            <p className="truncate min-w-0">
              {(() => {
                const n = (cardName || "").toString();
                return n
                  .replace(/\s*-\s*\d+\/?\d*$/, "") // remove "- 161/132"
                  .replace(/\s*\(\d+\)\s*$/, "") // remove "(150)"
                  .replace(/\s+\d+$/, ""); // remove trailing standalone number
              })()}
            </p>
          </div>

          {/* Card Details */}
          {isCollection ? (
            <p className="text-gray-400 text-xs mb-2">{cardNumber || "N/A"}</p>
          ) : (
            <div className="dark:text-white text-theme-primary text-[12px] sm:text-[13px] md:text-[14px] space-y-1 min-h-[60px] min-w-0">
              <p className="truncate min-h-[18px] min-w-0">{cleanedSetName}</p>
              <p className="truncate min-h-[18px] min-w-0">{rarity}</p>
              {cardNumber && cardNumber.trim() ? (
                <p className="truncate min-h-[18px] min-w-0">{cardNumber}</p>
              ) : (
                <p className="min-h-[18px]">&nbsp;</p>
              )}
            </div>
          )}

          {/* Price and Quantity */}
          <div
            className={
              isCollection
                ? "flex items-end justify-between gap-2 mt-auto"
                : "flex items-center justify-between min-h-[40px]"
            }
          >
            <div
              className={
                isCollection
                  ? "flex flex-col gap-1 flex-1 min-w-0"
                  : "flex flex-col gap-0.5"
              }
            >
              <span
                className={
                  isCollection
                    ? "text-primary font-bold text-xs truncate"
                    : "text-blue-300 text-[14px] sm:text-[15px] md:text-[16px] font-black"
                }
                title={`Raw price data: ${price}`}
              >
                {price}
              </span>
              {isCollection && (
                <div className="min-h-[14px]">
                  <div className="flex items-center gap-1 text-gray-400 text-[10px]">
                    <span>Qty:</span>
                    <span>{quantity}</span>
                  </div>
                </div>
              )}
            </div>
            {!isCollection && onAddToCollection && (
              <svg
                onClick={(e) => {
                  e.stopPropagation();
                  onAddToCollection();
                }}
                className="h-6 w-6 cursor-pointer hover:opacity-80 transition-opacity"
                viewBox="0 0 31 31"
                fill="none"
                xmlns="http://www.w3.org/2000/svg"
              >
                <mask
                  id="mask0_253_3934"
                  style={{ maskType: "luminance" }}
                  maskUnits="userSpaceOnUse"
                  x="2"
                  y="1"
                  width="28"
                  height="28"
                >
                  <path
                    d="M25.9542 2.85913H5.27307C4.13088 2.85913 3.20496 3.78506 3.20496 4.92724V25.6084C3.20496 26.7506 4.13088 27.6765 5.27307 27.6765H25.9542C27.0964 27.6765 28.0223 26.7506 28.0223 25.6084V4.92724C28.0223 3.78506 27.0964 2.85913 25.9542 2.85913Z"
                    fill="white"
                    stroke="white"
                    strokeWidth="2.14869"
                    strokeLinejoin="round"
                  />
                  <path
                    d="M15.6138 9.75293V20.7829M10.0989 15.2679H21.1288"
                    stroke="black"
                    strokeWidth="2.14869"
                    strokeLinecap="round"
                    strokeLinejoin="round"
                  />
                </mask>
                <g mask="url(#mask0_253_3934)">
                  <path
                    d="M-0.931274 -1.2771H32.1586V31.8127H-0.931274V-1.2771Z"
                    fill="#3B82F6"
                  />
                </g>
              </svg>
            )}
          </div>
        </div>
      </div>
    </div>
  );
};
import cardService from "./services/cardService";
import priceService from "./services/priceService";
import tcgplayerService from "./services/tcgplayerService";
import userDatabase from "./services/userDatabase";
import cardDataMigration from "./services/cardDataMigration.js";
import eventTracker from "./services/eventTracker.js";
import marketplaceService from "./services/marketplaceService.js";
import "./styles/holographic.css";
import "./styles/card-rarities.css";
import "./styles/image-enhancements.css";
import HolographicCard from "./components/HolographicCard";
import SearchBar from "./components/SearchBar";
import EventHistory from "./components/EventHistory";
import AffiliateCard from "./components/AffiliateCard";
import { Particles } from "./components/Particles";
import {
  Chart as ChartJS,
  CategoryScale,
  LinearScale,
  PointElement,
  LineElement,
  Title,
  Tooltip,
  Legend,
  Filler,
} from "chart.js";
import { Line } from "react-chartjs-2";

// Register Chart.js components
ChartJS.register(
  CategoryScale,
  LinearScale,
  PointElement,
  LineElement,
  Title,
  Tooltip,
  Legend,
  Filler
);

export default function App() {
  // User authentication context
  const {
    user,
    loading: userLoading,
    isAuthenticated,
    updateProfile,
    getUserStats,
    getPricingAlerts,
    createPricingAlert,
    deletePricingAlert,
    getSetProgression,
    loginWithGoogle,
    logout,
  } = useUser();
  // Theme context
  const { theme, toggleTheme, isDark } = useTheme();
  const [userStats, setUserStats] = useState(null);

  // Helper function to get display name (prefer clean_name for Japanese cards, fallback to name)
  const getDisplayName = (card) => {
    if (!card) return "";
    let name = "";
    // For Japanese cards, prefer clean_name
    if (card.language === "ja" && card.clean_name) {
      name = card.clean_name;
    } else {
      // For other cards, use clean_name if available, otherwise name
      name = card.clean_name || card.cleanName || card.name || "";
    }

    // Remove card number suffixes (e.g., "086", "086/165", "- 086", "125 094")
    // Handle multiple patterns and multiple trailing numbers
    name = name
      .replace(/\s*-\s*\d+\/?\d*\s*$/, "") // Remove "- 086" or "- 086/165"
      .replace(/\s+\d+\s+\d+\s*$/, "") // Remove trailing " 125 094" (two numbers)
      .replace(/\s+\d+\/?\d*\s*$/, "") // Remove trailing " 086" or " 086/165" (single number)
      .replace(/\s*\/\s*\d+\s*$/, "") // Remove trailing "/ 094"
      .replace(/\s*\(\d+\)\s*$/, "") // Remove "(086)"
      .trim();

    return name;
  };

  // Helper function to get display set name (prefer clean_name if available)
  const getDisplaySetName = (card) => {
    if (!card) return "";
    let setName =
      card.clean_set_name || card.set_name || card.set?.name || card.set || "";

    // Remove set ID prefix (e.g., "SV2D: ", "SV1a: ", "SWSH07: ")
    // Pattern matches: letters/numbers followed by colon and space
    setName = setName.replace(/^[A-Z0-9]+[a-z]?\d*[a-z]?:\s*/i, "").trim();

    return setName;
  };

  const [currentScreen, setCurrentScreen] = useState("splash");
  const [showPassword, setShowPassword] = useState(false);
  const [email, setEmail] = useState("");
  const [resetToken, setResetToken] = useState("");
  const [newPassword, setNewPassword] = useState("");
  const [confirmPassword, setConfirmPassword] = useState("");

  // Signup form fields
  const [firstName, setFirstName] = useState("");
  const [lastName, setLastName] = useState("");
  const [signupEmail, setSignupEmail] = useState("");
  const [dateOfBirth, setDateOfBirth] = useState("");
  const [phoneNumber, setPhoneNumber] = useState("");
  const [username, setUsername] = useState("");
  const [signupPassword, setSignupPassword] = useState("");
  const [confirmSignupPassword, setConfirmSignupPassword] = useState("");
  const [showSignupPassword, setShowSignupPassword] = useState(false);
  const [showConfirmPassword, setShowConfirmPassword] = useState(false);
  const [selectedCountry, setSelectedCountry] = useState("US");
  const [showCountryDropdown, setShowCountryDropdown] = useState(false);
  const [currentOnboardingStep, setCurrentOnboardingStep] = useState(0);
  const [isFirstTimeUser, setIsFirstTimeUser] = useState(false);
  const [touchStart, setTouchStart] = useState(null);
  const [touchEnd, setTouchEnd] = useState(null);

  // Track if user manually navigated to main-app (for guest mode)
  const [guestMode, setGuestMode] = useState(() => {
    // Check if guest mode was previously enabled
    return localStorage.getItem("guestMode") === "true";
  });

  // Automatically navigate to main app if user is already authenticated (session restored)
  useEffect(() => {
    // Wait for user loading to complete
    if (!userLoading) {
      if (isAuthenticated && user) {
        // User is logged in - navigate to main app
        if (currentScreen === "splash" || currentScreen === "login") {
          setCurrentScreen("main-app");
          setGuestMode(false); // Clear guest mode when authenticated
        }
      } else {
        // User is not logged in - allow guest mode if they manually navigated
        // Only redirect to splash if they weren't in guest mode
        if (currentScreen === "main-app" && !guestMode) {
          // Redirect to splash only if not in guest mode
          setCurrentScreen("splash");
        }
      }
    }
  }, [userLoading, isAuthenticated, user, currentScreen, guestMode]);

  // Save guest mode to localStorage
  useEffect(() => {
    if (guestMode) {
      localStorage.setItem("guestMode", "true");
    } else {
      localStorage.removeItem("guestMode");
    }
  }, [guestMode]);

  // Load user stats when user is authenticated
  useEffect(() => {
    if (isAuthenticated && getUserStats) {
      getUserStats().then((stats) => {
        if (stats) setUserStats(stats);
      });
    }
  }, [isAuthenticated, getUserStats]);

  // Analytics tracking - User ID and Session ID
  const userId = useMemo(() => {
    let id = localStorage.getItem("user_uuid");
    if (!id) {
      id = "user_" + Math.random().toString(36).substr(2, 9) + Date.now();
      localStorage.setItem("user_uuid", id);
    }
    return id;
  }, []);

  const sessionId = useMemo(() => {
    let id = sessionStorage.getItem("session_uuid");
    if (!id) {
      id = "session_" + Math.random().toString(36).substr(2, 9) + Date.now();
      sessionStorage.setItem("session_uuid", id);
    }
    return id;
  }, []);

  // Analytics tracking helper
  const trackEvent = (eventType, data = {}) => {
    // Only track if analytics is enabled (you can toggle this)
    const analyticsEnabled =
      localStorage.getItem("enable_analytics") !== "false"; // Default to true
    if (!analyticsEnabled) return;

    fetch(`${API_URL}/api/analytics/track`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        event_type: eventType,
        user_id: userId,
        session_id: sessionId,
        data: data,
        timestamp: new Date().toISOString(),
        user_agent: navigator.userAgent,
        screen_size: `${window.innerWidth}x${window.innerHeight}`,
        referrer: document.referrer,
      }),
    }).catch((err) => {
      // Silent fail - analytics shouldn't break the app
      console.log("Analytics tracking (silently failed):", eventType);
    });
  };

  // Dashboard state
  const [searchQuery, setSearchQuery] = useState("");
  const [collectionSearchQuery, setCollectionSearchQuery] = useState("");

  // Marketplace state
  const [marketplaceSearchQuery, setMarketplaceSearchQuery] = useState("");
  const [marketplaceConfigs, setMarketplaceConfigs] = useState(null);
  const [trendingProducts, setTrendingProducts] = useState([]);
  const [recentSearches, setRecentSearches] = useState([]);
  const [wishlistItems, setWishlistItems] = useState([]);
  const [selectedCollection, setSelectedCollection] = useState(null);
  const [selectedTimeRange, setSelectedTimeRange] = useState("6M");
  const [selectedCurrency, setSelectedCurrency] = useState("USD");
  const [showCurrencyDropdown, setShowCurrencyDropdown] = useState(false);
  const [showCollectionDropdown, setShowCollectionDropdown] = useState(false);
  const [pricingAlerts, setPricingAlerts] = useState([]);
  const [setProgression, setSetProgression] = useState([]);
  const [showSortDropdown, setShowSortDropdown] = useState(false);
  const [collectionSortOption, setCollectionSortOption] = useState("name");
  const [showFilterModal, setShowFilterModal] = useState(false);
  const [showEventHistory, setShowEventHistory] = useState(false);
  const [defaultLanguage, setDefaultLanguage] = useState("english");
  const [filterSettings, setFilterSettings] = useState({
    cardStatus: "all", // all, duplicates, wishlisted
    languages: [], // array of selected languages - empty means show all
    products: [], // cards, sealed - empty means show all
    energies: [], // array of selected energies - empty means show all
    supertype: [], // pokemon, trainer, energy - empty means show all
    rarityType: "international", // international, japanese
    rarities: [], // array of selected rarities - empty means show all
    variants: [], // normal, holos, reverse_holos, first_editions - empty means show all
    formats: [], // unlimited, expanded, standard - empty means show all
    regulationMarkings: [], // A, B, C, D, E, F, G, H, I - empty means show all
    conditions: [], // near_mint, lightly_played, moderately_played, heavily_played, damaged - empty means show all
  });
  const [showCollectionCardActions, setShowCollectionCardActions] =
    useState(false);
  const [selectedCollectionCard, setSelectedCollectionCard] = useState(null);
  const [collectionCardActionsPosition, setCollectionCardActionsPosition] =
    useState({ x: 0, y: 0 });
  const [selectedCollectionCards, setSelectedCollectionCards] = useState(
    new Set()
  );
  const [isCollectionMultiSelectMode, setIsCollectionMultiSelectMode] =
    useState(false);

  const [longPressTimer, setLongPressTimer] = useState(null);
  const [isScrolling, setIsScrolling] = useState(false);
  const [touchStartPosition, setTouchStartPosition] = useState(null);
  const [scrollTimeout, setScrollTimeout] = useState(null);
  const [lastTapTime, setLastTapTime] = useState(0);
  const [showMoveToFolderModal, setShowMoveToFolderModal] = useState(false);
  const [availableFolders, setAvailableFolders] = useState([]);
  const [showAddToDeckModal, setShowAddToDeckModal] = useState(false);
  const [availableDecks, setAvailableDecks] = useState([]);
  const [showAddToBinderModal, setShowAddToBinderModal] = useState(false);
  const [availableBinders, setAvailableBinders] = useState([]);
  const [showCreateCollectionModal, setShowCreateCollectionModal] =
    useState(false);
  const [newCollectionName, setNewCollectionName] = useState("");
  const [showAllActivity, setShowAllActivity] = useState(false);
  const [showCollectionsModal, setShowCollectionsModal] = useState(false);
  const [showActivityModal, setShowActivityModal] = useState(false);
  const [showTopMoversModal, setShowTopMoversModal] = useState(false);
  const [showTrendingModal, setShowTrendingModal] = useState(false);
  const [showSlidingMenu, setShowSlidingMenu] = useState(false);

  // Real user data from database
  const [userData, setUserData] = useState(null);
  const [recentActivityData, setRecentActivityData] = useState([]);
  const [displayedActivity, setDisplayedActivity] = useState([]);

  // State for real data
  const [topMoversData, setTopMoversData] = useState([]);
  const [trendingCardsData, setTrendingCardsData] = useState([]);
  const [isLoadingData, setIsLoadingData] = useState(true);
  const [refreshKey, setRefreshKey] = useState(0);

  // Load user data from database
  useEffect(() => {
    const loadUserData = () => {
      // Only load from localStorage if user is NOT authenticated (guest mode)
      // Authenticated users should have their data loaded from the backend API
      if (!isAuthenticated) {
        const data = userDatabase.getUserData();
        if (data) {
          // Clean up duplicates in all collections automatically
          data.collections?.forEach((collection) => {
            userDatabase.cleanupDuplicates(collection.id);
          });

          // Get the cleaned data
          const cleanedData = userDatabase.getUserData();
          setUserData(cleanedData);
          setRecentActivityData(cleanedData.recentActivity || []);
          setDisplayedActivity((cleanedData.recentActivity || []).slice(0, 3));

          // Fetch missing data for the selected collection
          if (selectedCollection) {
            userDatabase
              .fetchMissingCardData(selectedCollection)
              .then((success) => {
                if (success) {
                  const updatedData = userDatabase.getUserData();
                  setUserData(updatedData);
                  console.log("Missing card data fetched automatically");
                }
              });
          }
        } else {
          // Initialize empty user data for guest mode
          userDatabase.initializeUserData();
          const initialData = userDatabase.getUserData();
          setUserData(initialData);
          setRecentActivityData([]);
          setDisplayedActivity([]);
        }
      } else {
        // User is authenticated - clear local state and load from backend
        // TODO: Load user-specific data from backend API endpoints
        // For now, initialize empty state for authenticated users
        setUserData({
          collections: [], // No default collection - user must create their first one
          recentActivity: [],
        });
        setRecentActivityData([]);
        setDisplayedActivity([]);
        console.log(
          "✅ User authenticated - guest data cleared, ready to load user data from backend"
        );
      }
    };
    loadUserData();
  }, [isAuthenticated, selectedCollection]);

  // Fetch missing data when selected collection changes
  useEffect(() => {
    if (selectedCollection && userData) {
      userDatabase.fetchMissingCardData(selectedCollection).then((success) => {
        if (success) {
          const updatedData = userDatabase.getUserData();
          setUserData(updatedData);
          console.log(
            "Missing card data fetched for collection:",
            selectedCollection
          );
        }
      });
    }
  }, [selectedCollection]);

  // Load real data from API
  useEffect(() => {
    const loadData = async () => {
      console.log("🔄 Starting data load...");

      try {
        setIsLoadingData(true);

        // Initialize card data migration service
        await cardDataMigration.initialize();

        // Load real data from database with cache busting
        const [topMovers, trending, marketplaceConfigs] = await Promise.all([
          cardService.getTopMovers(),
          cardService.getTrendingCards(),
          marketplaceService.getConfigs(),
        ]);

        // Set marketplace configs
        setMarketplaceConfigs(marketplaceConfigs);

        console.log("Loaded trending cards:", trending.length);
        console.log("Sample trending card:", trending[0]);

        // Use trending cards from API (now includes fallback for actual cards)
        const trendingCards = trending;

        // Transform the data and add mock properties for compatibility
        const transformedTopMovers = topMovers.map((card, index) => {
          const transformed = cardService.transformCard(card);
          return {
            ...transformed,
            id: transformed.id || index + 1,
            change: 0, // Real data - no fake changes
            dailyChange: 0, // Real data - no fake changes
            quantity: 1, // Real data - actual quantity
            rank: index + 1,
            type: "neutral", // Real data - no fake type
          };
        });

        const transformedTrending = trendingCards.map((card, index) => {
          const transformed = cardService.transformCard(card);
          return {
            ...transformed,
            id: transformed.id || index + 1,
            change: card.priceChange || 0, // Use real price change from API
            percentChange: card.percentChange || 0, // Use real percent change from API
            rank: index + 1,
            trendingScore: card.trendingScore || 0,
          };
        });

        setTopMoversData(transformedTopMovers);
        setTrendingCardsData(transformedTrending);
      } catch (error) {
        console.error("Error loading card data:", error);
        // Show error instead of fake data
        setTopMoversData([]);
        setTrendingCardsData([]);
      } finally {
        setIsLoadingData(false);
      }
    };

    loadData();
  }, [refreshKey]);

  // Listen for card clicks from DeckBuilder
  useEffect(() => {
    const handleOpenCardProfileFromDeck = (event) => {
      const card = event.detail;
      if (card) {
        handleCardClick(card);
      }
    };

    window.addEventListener(
      "openCardProfileFromDeck",
      handleOpenCardProfileFromDeck
    );
    return () => {
      window.removeEventListener(
        "openCardProfileFromDeck",
        handleOpenCardProfileFromDeck
      );
    };
  }, []); // Empty dependency array is fine here since we're just setting up a one-time listener

  // Listen for navigation to search from BinderBuilder
  useEffect(() => {
    const handleNavigateToSearch = (event) => {
      const { source, targetPocket, currentPage } = event.detail;
      if (source === "binder") {
        setActiveTab("search");
        setNavigationMode("search");
      }
    };

    window.addEventListener("navigateToSearch", handleNavigateToSearch);
    return () => {
      window.removeEventListener("navigateToSearch", handleNavigateToSearch);
    };
  }, []);

  // State variables that were accidentally removed
  const [activeTab, setActiveTab] = useState("home");
  const [previousTab, setPreviousTab] = useState(null); // Track previous tab for back navigation
  const [navigationMode, setNavigationMode] = useState("home"); // 'home', 'collection', 'marketplace', 'profile', 'none'
  const [previousNavigationMode, setPreviousNavigationMode] = useState(null); // Track previous navigation mode for back navigation
  const navigationModeRef = useRef("home");
  const [viewingUserId, setViewingUserId] = useState(null); // Track which user's profile to view
  const [followingUsers, setFollowingUsers] = useState(new Set()); // Track which users are being followed

  // Track navigation mode changes for back navigation
  useEffect(() => {
    const previousMode = navigationModeRef.current;
    if (
      navigationMode !== "home" &&
      navigationMode !== "search" &&
      navigationMode !== previousMode &&
      previousMode !== "home"
    ) {
      // Only update previousNavigationMode if navigating between special pages (deck-builder <-> binder <-> sets)
      setPreviousNavigationMode(previousMode);
    }
    navigationModeRef.current = navigationMode;
  }, [navigationMode]);

  // Track tab changes for back navigation
  useEffect(() => {
    if (
      activeTab !== "search" &&
      activeTab !== "binder" &&
      activeTab !== "deck-builder" &&
      activeTab !== "sets" &&
      previousTab !== activeTab
    ) {
      // Only update previousTab if we're not already on search, binder, deck-builder, or sets
      setPreviousTab(activeTab);
    }
  }, [activeTab, previousTab]);
  const [showScanner, setShowScanner] = useState(false);
  const [scannedCard, setScannedCard] = useState(null);
  const [cardImages, setCardImages] = useState({});
  const [showSearchResults, setShowSearchResults] = useState(false);

  // Profile tab state
  const [profileTab, setProfileTab] = useState("stats");
  const [showEditProfile, setShowEditProfile] = useState(false);
  const [editDisplayName, setEditDisplayName] = useState("");
  const [editUsername, setEditUsername] = useState("");
  const [editTagline, setEditTagline] = useState("");
  const [editAboutMe, setEditAboutMe] = useState("");
  const [editSocialLinks, setEditSocialLinks] = useState({
    twitter: "",
    instagram: "",
    youtube: "",
    tiktok: "",
    website: "",
  });
  const [editCollectingGoals, setEditCollectingGoals] = useState([]);
  const [chartTimeRange, setChartTimeRange] = useState("6M");

  // Image upload state
  const [coverPhotoPreview, setCoverPhotoPreview] = useState(null);
  const [profilePicturePreview, setProfilePicturePreview] = useState(null);
  const [coverPhotoFile, setCoverPhotoFile] = useState(null);
  const [profilePictureFile, setProfilePictureFile] = useState(null);

  // File input handlers
  const handleCoverPhotoChange = (event) => {
    const file = event.target.files[0];
    if (file) {
      setCoverPhotoFile(file);
      const reader = new FileReader();
      reader.onload = (e) => setCoverPhotoPreview(e.target.result);
      reader.readAsDataURL(file);
    }
  };

  const handleProfilePictureChange = (event) => {
    const file = event.target.files[0];
    if (file) {
      setProfilePictureFile(file);
      const reader = new FileReader();
      reader.onload = (e) => setProfilePicturePreview(e.target.result);
      reader.readAsDataURL(file);
    }
  };

  const handleRemoveCoverPhoto = () => {
    setCoverPhotoFile(null);
    setCoverPhotoPreview(null);
  };

  const handleRemoveProfilePicture = async () => {
    setProfilePictureFile(null);
    setProfilePicturePreview(null);

    // Only remove from database if user is authenticated
    if (isAuthenticated) {
      try {
        const result = await updateProfile({ profileImage: null });
        if (!result.success) {
          console.error("Failed to remove profile image:", result.error);
          alert(`Failed to remove profile image: ${result.error}`);
        } else {
          alert("Profile picture removed successfully!");
        }
      } catch (error) {
        console.error("Error removing profile image:", error);
        alert("Error removing profile picture. Please try again.");
      }
    } else {
      alert("Please log in to remove your profile picture.");
    }
  };

  const [filteredSearchResults, setFilteredSearchResults] = useState([]);
  const [originalSearchResults, setOriginalSearchResults] = useState([]);
  const [loading, setLoading] = useState(false);
  const [showSortModal, setShowSortModal] = useState(false);
  const [sortOption, setSortOption] = useState("trending");
  const [showSearchFilterModal, setShowSearchFilterModal] = useState(false);
  const [filterButtonPosition, setFilterButtonPosition] = useState({
    top: 0,
    right: 0,
  });
  const [activeFilters, setActiveFilters] = useState({
    language: [],
    products: [],
    energy: [],
    cardType: [],
    rarity: [],
    variant: [],
    regulation: [],
    format: [],
    condition: [],
  });

  // Debug showSortModal state changes
  useEffect(() => {
    console.log("showSortModal state changed to:", showSortModal);
  }, [showSortModal]);

  // Removed click-outside handlers since modals now handle clicks on backdrop

  // Auto-search as user types (debounced)
  useEffect(() => {
    // Only trigger auto-search if on search tab
    if (activeTab !== "search") {
      return;
    }

    // Don't search if query is empty or too short
    if (!searchQuery || searchQuery.trim().length < 2) {
      return;
    }

    // Debounce the search - wait 500ms after user stops typing
    const timeoutId = setTimeout(() => {
      handleSearch(true); // Pass true to indicate this is an auto-search
    }, 500);

    return () => clearTimeout(timeoutId);
  }, [searchQuery, activeTab]);

  // Apply filters to search results
  useEffect(() => {
    if (originalSearchResults.length > 0) {
      let filtered = [...originalSearchResults];

      // Apply language filter
      if (activeFilters.language.length > 0) {
        // Map language names to language codes
        const languageNameToCode = {
          English: "en",
          Japanese: "ja",
          Chinese: "zh",
        };

        const selectedLanguageCodes = activeFilters.language.map(
          (lang) => languageNameToCode[lang] || "en"
        );

        const selectedLanguageCodesLower = selectedLanguageCodes.map((code) =>
          code.toLowerCase().trim()
        );
        const beforeCount = filtered.length;
        filtered = filtered.filter((card) => {
          const cardLanguage = (card.language || "en").toLowerCase().trim();
          const matches = selectedLanguageCodesLower.includes(cardLanguage);
          return matches;
        });
        console.log(
          `[useEffect Filter] Language filter applied: ${beforeCount} -> ${
            filtered.length
          } cards. Selected languages: ${activeFilters.language.join(
            ", "
          )}, Codes: ${selectedLanguageCodesLower.join(", ")}`
        );
        if (filtered.length === 0 && beforeCount > 0) {
          const sampleLanguages = [
            ...new Set(
              originalSearchResults
                .slice(0, 20)
                .map((c) => c.language || "undefined")
            ),
          ];
          console.log(
            "Sample card languages in originalSearchResults:",
            sampleLanguages
          );
        }
      }

      // Apply products filter
      if (activeFilters.products.length > 0) {
        filtered = filtered.filter((card) => {
          const cardProduct = card.product_type || "Cards";
          return activeFilters.products.includes(cardProduct);
        });
      }

      // Apply energy filter
      if (activeFilters.energy.length > 0) {
        filtered = filtered.filter((card) => {
          const cardTypes = card.types || [];
          return activeFilters.energy.some((filterEnergy) =>
            cardTypes.some((cardType) =>
              cardType.toLowerCase().includes(filterEnergy.toLowerCase())
            )
          );
        });
      }

      // Apply card type filter
      if (activeFilters.cardType.length > 0) {
        filtered = filtered.filter((card) => {
          const cardType = card.card_type || "Pokémon";
          return activeFilters.cardType.includes(cardType);
        });
      }

      // Apply rarity filter
      if (activeFilters.rarity.length > 0) {
        filtered = filtered.filter((card) =>
          activeFilters.rarity.includes(card.rarity)
        );
      }

      // Apply variant filter
      if (activeFilters.variant.length > 0) {
        filtered = filtered.filter((card) => {
          const cardVariant = card.variant || "Normal";
          return activeFilters.variant.includes(cardVariant);
        });
      }

      // Apply regulation filter
      if (activeFilters.regulation.length > 0) {
        filtered = filtered.filter((card) =>
          activeFilters.regulation.includes(card.regulation)
        );
      }

      // Apply format filter
      if (activeFilters.format.length > 0) {
        filtered = filtered.filter((card) => {
          const cardFormat = card.format || "Unlimited";
          return activeFilters.format.includes(cardFormat);
        });
      }

      // Apply condition filter
      if (activeFilters.condition.length > 0) {
        filtered = filtered.filter((card) => {
          const cardCondition = card.condition || "Near Mint";
          return activeFilters.condition.includes(cardCondition);
        });
      }

      setFilteredSearchResults(filtered);
    }
  }, [activeFilters, originalSearchResults]);

  // Add to Collection Modal states
  const [showAddToCollectionModal, setShowAddToCollectionModal] =
    useState(false);
  const [cardToAdd, setCardToAdd] = useState(null);
  const [selectedCollectionForAdd, setSelectedCollectionForAdd] =
    useState(null);

  // Separate modal states for search results and card profile
  const [showSearchResultsModal, setShowSearchResultsModal] = useState(false);
  const [cardToAddFromSearch, setCardToAddFromSearch] = useState(null);
  const [showCardProfileModal, setShowCardProfileModal] = useState(false);
  const [cardToAddFromProfile, setCardToAddFromProfile] = useState(null);
  const [addQuantity, setAddQuantity] = useState(1);
  const [selectedVariant, setSelectedVariant] = useState("Normal");
  const [addCardCondition, setAddCardCondition] = useState("Near Mint");
  const [isGraded, setIsGraded] = useState(false);
  const [selectedGradingService, setSelectedGradingService] = useState("PSA");
  const [selectedGrade, setSelectedGrade] = useState("10");
  const [addNote, setAddNote] = useState("");
  const [showMatchesReview, setShowMatchesReview] = useState(false); // Toggle to review matches in add modal

  // Custom dropdown states for Add to Collection modal
  const [showVariantDropdown, setShowVariantDropdown] = useState(false);
  const [showConditionDropdown, setShowConditionDropdown] = useState(false);
  const [showGradingServiceDropdown, setShowGradingServiceDropdown] =
    useState(false);
  const [showGradeDropdown, setShowGradeDropdown] = useState(false);

  const [showQuickFiltersModal, setShowQuickFiltersModal] = useState(false);
  const [showSetPage, setShowSetPage] = useState(false);
  const [selectedSet, setSelectedSet] = useState(null);
  const [selectedSetData, setSelectedSetData] = useState(null);
  const [setCardsData, setSetCardsData] = useState([]);
  const [loadingSetCards, setLoadingSetCards] = useState(false);
  const [setCardsPage, setSetCardsPage] = useState(1);
  const [hasMoreCards, setHasMoreCards] = useState(false);
  const [showNoteModal, setShowNoteModal] = useState(false);
  const [cardNote, setCardNote] = useState("");

  const [quickFilters, setQuickFilters] = useState({
    owned: false,
    missing: false,
    duplicates: false,
    wishlist: false,
  });
  const [showLanguageModal, setShowLanguageModal] = useState(false);
  const [selectedLanguages, setSelectedLanguages] = useState({
    english: true,
    japanese: false,
    chinese: false,
  });
  const [showConditionModal, setShowConditionModal] = useState(false);
  const [selectedConditions, setSelectedConditions] = useState({
    mint: false,
    nearMint: true,
    lightlyPlayed: false,
    moderatelyPlayed: false,
    heavilyPlayed: false,
    damaged: false,
  });
  const [showProductsModal, setShowProductsModal] = useState(false);
  const [selectedProducts, setSelectedProducts] = useState({
    cardsOnly: true,
    sealedOnly: false,
  });
  const [showEnergyModal, setShowEnergyModal] = useState(false);
  const [selectedEnergies, setSelectedEnergies] = useState({
    colorless: false,
    darkness: false,
    dragon: false,
    electric: false,
    fairy: false,
    fighting: false,
    fire: false,
    grass: false,
    metal: false,
    psychic: false,
    water: false,
  });
  const [showTypeModal, setShowTypeModal] = useState(false);
  const [selectedTypes, setSelectedTypes] = useState({
    pokemon: true,
    trainer: true,
    energy: true,
  });
  const [showRarityModal, setShowRarityModal] = useState(false);
  const [rarityType, setRarityType] = useState("international"); // 'international' or 'japanese'

  const [selectedRarities, setSelectedRarities] = useState({
    common: true,
    uncommon: true,
    rare: true,
    doubleRare: true,
    aceSpecRare: true,
    illustrationRare: true,
    ultraRare: true,
    specialIllustrationRare: true,
    hyperRare: true,
    shinyRare: true,
    shinyUltraRare: true,
    blackStarPromo: true,
    artRare: true,
    specialArtRare: true,
    superRare: true,
    shinySuperRare: true,
  });

  // Variant modal state
  const [showVariantModal, setShowVariantModal] = useState(false);
  const [selectedVariants, setSelectedVariants] = useState({
    normal: true,
    holo: true,
    reverseHolo: true,
    firstEdition: true,
  });

  // Regulation filter state
  const [showRegulationModal, setShowRegulationModal] = useState(false);
  const [selectedRegulations, setSelectedRegulations] = useState({
    a: true,
    b: true,
    c: true,
    d: true,
    e: true,
    f: true,
    g: true,
    h: true,
    i: true,
  });

  // Format filter state
  const [showFormatModal, setShowFormatModal] = useState(false);
  const [selectedFormats, setSelectedFormats] = useState({
    unlimited: true,
    expanded: true,
    standard: true,
  });

  // Additional scanner states
  const [showEditModal, setShowEditModal] = useState(false);
  const [showScanConfirm, setShowScanConfirm] = useState(false);
  const [isScanConfirmFading, setIsScanConfirmFading] = useState(false);
  const [showCardProfile, setShowCardProfile] = useState(false);
  const [selectedCard, setSelectedCard] = useState(null);
  const [wishlist, setWishlist] = useState(new Set());
  const [showWishlistNotification, setShowWishlistNotification] =
    useState(false);

  // Edit modal dropdown states
  const [showEditConditionDropdown, setShowEditConditionDropdown] =
    useState(false);
  const [showEditVariantDropdown, setShowEditVariantDropdown] = useState(false);
  const [showEditGradeDropdown, setShowEditGradeDropdown] = useState(false);
  const [showEditGradingServiceDropdown, setShowEditGradingServiceDropdown] =
    useState(false);
  const [wishlistNotificationMessage, setWishlistNotificationMessage] =
    useState("");
  const [showCollectionNotification, setShowCollectionNotification] =
    useState(false);
  const [collectionNotificationMessage, setCollectionNotificationMessage] =
    useState("");
  const [showCardMenu, setShowCardMenu] = useState(false);
  const [showViewMyCardsModal, setShowViewMyCardsModal] = useState(false);
  const [myCardEntries, setMyCardEntries] = useState([]);
  const [swipedEntryId, setSwipedEntryId] = useState(null);
  const [pressedEntryId, setPressedEntryId] = useState(null);
  const [pressTimer, setPressTimer] = useState(null);
  const [touchStartPos, setTouchStartPos] = useState(null);
  const [mouseStartPos, setMouseStartPos] = useState(null);
  const [selectedEntries, setSelectedEntries] = useState(new Set());
  const [isMultiSelectMode, setIsMultiSelectMode] = useState(false);
  const [showPricingMenu, setShowPricingMenu] = useState(false);
  const [showPriceAlertModal, setShowPriceAlertModal] = useState(false);
  const [showEditPricePaidModal, setShowEditPricePaidModal] = useState(false);
  const [selectedPurchaseSource, setSelectedPurchaseSource] = useState("");
  const [showPurchaseSourceDropdown, setShowPurchaseSourceDropdown] =
    useState(false);
  const [cardChartTimeRange, setCardChartTimeRange] = useState("3M");
  const [selectedCardVariant, setSelectedCardVariant] = useState("Normal");
  const [showCardVariantDropdown, setShowCardVariantDropdown] = useState(false);

  // Condition pricing state
  const [selectedCondition, setSelectedCondition] = useState("Near Mint");
  const [showCardConditionDropdown, setShowCardConditionDropdown] =
    useState(false);
  const [conditionPrices, setConditionPrices] = useState(null);
  const [gradedPrices, setGradedPrices] = useState(null);
  const [showGradedPrices, setShowGradedPrices] = useState(false);

  // Raw/Graded selection
  const [selectedCardType, setSelectedCardType] = useState("Raw"); // 'Raw' or 'Graded'
  const [showCardTypeDropdown, setShowCardTypeDropdown] = useState(false);

  // Track selected conditions for comparison
  const [selectedComparisons, setSelectedComparisons] = useState([]);

  const [showSetCustomTagModal, setShowSetCustomTagModal] = useState(false);
  const [showSendFeedbackModal, setShowSendFeedbackModal] = useState(false);

  // Dropdown states for modals

  const [showDeckDropdown, setShowDeckDropdown] = useState(false);
  const [showBinderDropdown, setShowBinderDropdown] = useState(false);
  const [showIssueDropdown, setShowIssueDropdown] = useState(false);

  // Selected values for modal dropdowns
  const [selectedDeck, setSelectedDeck] = useState("Standard Deck");
  const [selectedBinder, setSelectedBinder] = useState("Main Binder");
  const [selectedIssue, setSelectedIssue] = useState("Incorrect Image");

  // New deck name state
  const [newDeckName, setNewDeckName] = useState("");

  // Deck quantity state
  const [deckQuantity, setDeckQuantity] = useState(1);

  // New binder name state
  const [newBinderName, setNewBinderName] = useState("");

  // Custom tag states
  const [tagName, setTagName] = useState("");
  const [selectedTagColor, setSelectedTagColor] = useState("red");
  const [cardCustomTags, setCardCustomTags] = useState([]); // Array of tags for the card
  const [editingTagIndex, setEditingTagIndex] = useState(null); // Index of tag being edited

  // Color mapping for consistent styling
  const colorMap = {
    red: {
      bg: "bg-red-500/20",
      border: "border-red-400/30",
      dot: "bg-red-500",
      text: "text-white",
    },
    blue: {
      bg: "bg-blue-500/20",
      border: "border-blue-400/30",
      dot: "bg-blue-500",
      text: "text-white",
    },
    green: {
      bg: "bg-green-500/20",
      border: "border-green-400/30",
      dot: "bg-green-500",
      text: "text-white",
    },
    yellow: {
      bg: "bg-yellow-500/20",
      border: "border-yellow-400/30",
      dot: "bg-yellow-500",
      text: "text-white",
    },
    purple: {
      bg: "bg-purple-500/20",
      border: "border-purple-400/30",
      dot: "bg-purple-500",
      text: "text-white",
    },
    pink: {
      bg: "bg-pink-500/20",
      border: "border-pink-400/30",
      dot: "bg-pink-500",
      text: "text-white",
    },
  };

  // Energy type mapping for dynamic energy icons
  const energyTypeMap = {
    Fire: "Fire",
    Water: "Water",
    Grass: "Grass",
    Lightning: "Electric",
    Electric: "Electric",
    Psychic: "Psychic",
    Fighting: "Fighting",
    Darkness: "Darkness",
    Metal: "Metal",
    Fairy: "Fairy",
    Dragon: "Dragon",
    Colorless: "Colorless",
    // Handle single-letter abbreviations
    F: "Fire",
    W: "Water",
    G: "Grass",
    L: "Electric",
    P: "Psychic",
    D: "Darkness",
    M: "Metal",
    Y: "Fairy",
    N: "Dragon",
    C: "Colorless",
  };

  // Helper function to get energy icon path
  const getEnergyIconPath = (energyType) => {
    const mappedType = energyTypeMap[energyType] || "Colorless";
    return `/Assets/Energies/${mappedType}.svg`;
  };

  // Rarity mapping for dynamic rarity icons
  const rarityMap = {
    // Common rarities
    Common: "Common",
    Uncommon: "Uncommon",
    Rare: "Rare",
    "Ultra Rare": "Ultra Rare",
    "Hyper Rare": "Hyper Rare",
    "Secret Rare": "Ultra Rare", // Map to Ultra Rare SVG
    "Double Rare": "Double Rare",

    // Special rarities
    "Illustration Rare": "IR",
    "Special Illustration Rare": "SIR",
    "Shiny Rare": "Shiny Rare",
    "Shiny Ultra Rare": "Shiny Ultra Rare",
    "ACE SPEC Rare": "ACE",
    "ACE SPEC": "ACE",

    // Promo rarities
    Promo: "Promo",
    "Black Star Promo": "Promo",
    Prerelease: "Promo",

    // V/VMAX/VSTAR rarities
    "Holo Rare V": "Ultra Rare",
    "Holo Rare VMAX": "Ultra Rare",
    "Holo Rare VSTAR": "Ultra Rare",
    "Rare Holo V": "Ultra Rare",
    "Rare Holo VMAX": "Ultra Rare",
    "Shiny rare V": "Shiny Rare",
    "Shiny rare VMAX": "Shiny Ultra Rare",

    // Other special rarities
    "Amazing Rare": "Rare",
    LEGEND: "Ultra Rare",
    "Rare PRIME": "Ultra Rare",
    "Rare Prism Star": "Rare",
    "Rare Shiny": "Shiny Rare",
    "Rare Ultra": "Ultra Rare",
    "Mega Hyper Rare": "Hyper Rare",
    "Full Art Trainer": "Ultra Rare",
    "Classic Collection": "Rare",
    Crown: "Rare",
    "Black White Rare": "Rare",
    "Rare Holo LV.X": "Ultra Rare",

    // Diamond/Star rarities
    "One Diamond": "Rare",
    "Two Diamond": "Rare",
    "Three Diamond": "Rare",
    "Four Diamond": "Rare",
    "One Shiny": "Shiny Rare",
    "Two Shiny": "Shiny Rare",
    "Three Star": "Rare",
    "Two Star": "Rare",

    // Fallback
    None: "Common",
  };

  // Set default variant when card changes
  useEffect(() => {
    if (selectedCard) {
      // Get available variants for this card based on rarity
      let cardVariants = [];
      const rarity = selectedCard.ext_rarity || "";

      // Determine variants based on rarity - check Secret Rare FIRST
      if (
        rarity.includes("Secret") ||
        rarity.includes("Ultra") ||
        rarity.includes("Hyper")
      ) {
        // Special handling for Secret Rare cards that might have specific variant names
        if (rarity.includes("Secret") || rarity.includes("Star")) {
          // For Secret Rare cards, prioritize the specific variant names
          cardVariants = ["Unlimited Holofoil", "1st Edition Holofoil"];
        } else {
          // Other Secret/Ultra/Hyper rare cards are typically holo only
          cardVariants.push("Holo");
        }
      } else if (rarity.includes("Holo") || rarity.includes("Rare")) {
        // Holo cards can have both Normal and Holo variants
        cardVariants.push("Normal");
        cardVariants.push("Holo");

        // Add Reverse Holo for most holo cards
        if (
          !rarity.includes("Secret") &&
          !rarity.includes("Ultra") &&
          !rarity.includes("Hyper")
        ) {
          cardVariants.push("Reverse Holo");
        }
      } else if (rarity.includes("Common") || rarity.includes("Uncommon")) {
        // Common/Uncommon cards are typically normal only
        cardVariants.push("Normal");
      } else {
        // Default to Normal for unknown rarities
        cardVariants.push("Normal");
      }

      // Add special variants based on rarity
      if (rarity.includes("1st Edition") || rarity.includes("First Edition")) {
        cardVariants.push("1st Edition");
      }
      if (rarity.includes("Shadowless")) {
        cardVariants.push("Shadowless");
      }
      if (rarity.includes("Radiant")) {
        cardVariants.push("Radiant");
      }

      // Remove duplicates
      const uniqueVariants = [...new Set(cardVariants)];

      console.log("Variant selection debug:", {
        cardName: selectedCard.name,
        rarity: rarity,
        availableVariants: uniqueVariants,
        currentSelected: selectedCardVariant,
        cardVariants: cardVariants,
      });

      console.log(
        "🔍 SECRET RARE DEBUG - cardVariants after Secret Rare logic:",
        cardVariants
      );
      console.log(
        "🔍 SECRET RARE DEBUG - uniqueVariants after deduplication:",
        uniqueVariants
      );

      // Always set to the first available variant when card changes
      if (uniqueVariants.length > 0) {
        const defaultVariant = uniqueVariants[0]
          .toLowerCase()
          .replace(/\s+/g, "");
        console.log(
          "Setting default variant to:",
          defaultVariant,
          "for card:",
          selectedCard.name
        );
        setSelectedCardVariant(defaultVariant);
      } else {
        // Only default to Normal if absolutely no variants are found
        console.log(
          "No variants found, defaulting to Normal for card:",
          selectedCard.name
        );
        setSelectedCardVariant("Normal");
      }
    } else {
      // Reset to default when no card is selected
      setSelectedCardVariant("Normal");
    }
  }, [selectedCard]);

  // Fetch condition and graded prices when card is selected
  useEffect(() => {
    if (selectedCard) {
      // Fetch condition-based pricing from price_history
      const fetchPricingData = async () => {
        try {
          console.log(
            "🔍 Fetching pricing data for card:",
            selectedCard.name,
            "ID:",
            selectedCard.id
          );

          // Determine API variant from UI-selected variant
          const variantParam = (() => {
            const v = (selectedCardVariant || "").toString().toLowerCase();
            if (v.includes("reverse")) return "Reverse Holofoil";
            if (v.includes("holo")) return "Holofoil";
            return "Normal";
          })();

          // Fetch condition and graded prices for the selected variant
          const response = await fetch(
            `${API_URL}/api/cards/${
              selectedCard.id
            }/condition-prices?variant=${encodeURIComponent(variantParam)}`
          );
          if (response.ok) {
            const result = await response.json();
            if (result.success) {
              console.log("✅ Card data received");
              const latest = result.data || {};

              // Map DB condition keys to UI keys
              const nearMint = latest["Near Mint"];
              const lightlyPlayed = latest["Lightly Played"];
              const moderatelyPlayed = latest["Moderately Played"];
              const heavilyPlayed = latest["Heavily Played"];
              const damaged = latest["Damaged"];

              // Base fallback from selectedCard fields
              const baseValue =
                selectedCard?.currentValue ||
                selectedCard?.current_value ||
                selectedCard?.price ||
                selectedCard?.tcgplayer?.prices?.holofoil?.market ||
                selectedCard?.tcgplayer?.prices?.normal?.market ||
                selectedCard?.tcgplayer?.prices?.reverseHolofoil?.market ||
                selectedCard?.tcgplayer?.prices?.firstEditionHolofoil?.market ||
                0;

              const multipliers = {
                NM: 1.0,
                LP: 0.85,
                MP: 0.7,
                HP: 0.5,
                DM: 0.3,
              };

              const computedConditionPrices = {
                near_mint:
                  (typeof nearMint === "number"
                    ? nearMint
                    : Math.round(baseValue * multipliers.NM * 100) / 100) || 0,
                lightly_played:
                  (typeof lightlyPlayed === "number"
                    ? lightlyPlayed
                    : Math.round(baseValue * multipliers.LP * 100) / 100) || 0,
                moderately_played:
                  (typeof moderatelyPlayed === "number"
                    ? moderatelyPlayed
                    : Math.round(baseValue * multipliers.MP * 100) / 100) || 0,
                heavily_played:
                  (typeof heavilyPlayed === "number"
                    ? heavilyPlayed
                    : Math.round(baseValue * multipliers.HP * 100) / 100) || 0,
                damaged:
                  (typeof damaged === "number"
                    ? damaged
                    : Math.round(baseValue * multipliers.DM * 100) / 100) || 0,
              };

              setConditionPrices(computedConditionPrices);

              // Parse graded values (PSA only for now)
              const psaGrades = Object.keys(latest)
                .filter((k) => /^PSA\s+\d+(?:\.5)?$/.test(k))
                .map((k) => ({
                  grade: k.replace("PSA", "").trim(),
                  price: latest[k],
                }))
                .sort((a, b) => parseFloat(b.grade) - parseFloat(a.grade));

              const graded = {};
              if (psaGrades.length > 0) {
                graded["PSA"] = psaGrades;
              }

              setGradedPrices(Object.keys(graded).length > 0 ? graded : null);
            }
          } else {
            console.log("⚠️ Failed to fetch card data:", response.status);
            setConditionPrices(null);
            setGradedPrices(null);
          }
        } catch (error) {
          console.error("❌ Error fetching pricing data:", error);
          setConditionPrices(null);
          setGradedPrices(null);
        }
      };

      fetchPricingData();
    } else {
      setConditionPrices(null);
      setGradedPrices(null);
    }
  }, [selectedCard]);

  // Helper function to get rarity icon path
  const getRarityIconPath = (rarity, language = "en") => {
    const mappedRarity = rarityMap[rarity] || "Common";

    // Use Japanese rarity symbols for Japanese cards
    if (language === "ja") {
      // Map to Japanese equivalents
      const japaneseRarityMap = {
        Common: "Common",
        Uncommon: "Uncommon",
        Rare: "Rare",
        "Ultra Rare": "Super Rare",
        "Hyper Rare": "Hyper Rare",
        "Double Rare": "Double Rare",
        "Shiny Rare": "Shiny Rare",
        "Shiny Ultra Rare": "Shiny Ultra Rare",
        Promo: "Promo",
        IR: "Art Rare",
        SIR: "Special Art Rare",
        ACE: "ACE",
      };
      const japaneseRarity = japaneseRarityMap[mappedRarity] || mappedRarity;
      return `/Assets/Rarity/Japanese/${japaneseRarity}.svg`;
    }

    return `/Assets/Rarity/International/${mappedRarity}.svg`;
  };

  // Helper function to determine regulation mark from release date
  const getRegulationFromDate = (releaseDate) => {
    if (!releaseDate) return "A";

    const date = new Date(releaseDate);
    const year = date.getFullYear();

    // Regulation mark timeline based on set release dates
    if (year < 2021) return "A";
    if (year === 2021) return "B";
    if (year === 2022) return "C";
    if (year === 2023) return "D";
    if (year === 2024) return "E";
    if (year === 2025) return "F";
    if (year === 2026) return "G";
    if (year === 2027) return "H";
    if (year >= 2028) return "I";

    return "A"; // Default fallback
  };

  // Helper function to get regulation mark icon path
  const getRegulationIconPath = (regulation) => {
    if (!regulation || regulation === "—" || regulation === "-") return null;
    return `/Assets/Regulation/${regulation}.svg`;
  };

  // Helper function to render energy cost
  const renderEnergyCost = (cost) => {
    if (!cost || !Array.isArray(cost)) return null;

    return (
      <div className="flex items-center gap-1">
        {cost.map((energy, index) => (
          <img
            key={index}
            src={getEnergyIconPath(energy)}
            alt={`${energy} Energy`}
            className="w-5 h-5"
          />
        ))}
      </div>
    );
  };

  // Helper function to render energy symbols in text
  const renderEnergyText = (text) => {
    if (!text) return text;

    // Energy symbol mapping
    const energySymbols = {
      "[C]": "/Assets/Energies/Colorless.svg",
      "[G]": "/Assets/Energies/Grass.svg",
      "[R]": "/Assets/Energies/Fire.svg",
      "[W]": "/Assets/Energies/Water.svg",
      "[L]": "/Assets/Energies/Electric.svg",
      "[P]": "/Assets/Energies/Psychic.svg",
      "[F]": "/Assets/Energies/Fighting.svg",
      "[D]": "/Assets/Energies/Darkness.svg",
      "[M]": "/Assets/Energies/Metal.svg",
      // Also support old curly brace format
      "{C}": "/Assets/Energies/Colorless.svg",
      "{G}": "/Assets/Energies/Grass.svg",
      "{R}": "/Assets/Energies/Fire.svg",
      "{W}": "/Assets/Energies/Water.svg",
      "{L}": "/Assets/Energies/Electric.svg",
      "{P}": "/Assets/Energies/Psychic.svg",
      "{F}": "/Assets/Energies/Fighting.svg",
      "{D}": "/Assets/Energies/Darkness.svg",
      "{M}": "/Assets/Energies/Metal.svg",
    };

    // Split text by energy symbols (including multiple letters in brackets/braces)
    const parts = text.split(/(\[[CGWRPLFDM]+\]|\{[CGWRPLFDM]+\})/g);

    return parts.map((part, index) => {
      // Check if this part is an energy symbol pattern
      if (part.match(/^\[[CGWRPLFDM]+\]$/)) {
        // Extract individual energy letters from brackets
        const energyLetters = part.slice(1, -1).split("");
        return (
          <span
            key={index}
            className="inline-flex items-center gap-0.5"
            style={{ marginRight: "10px" }}
          >
            {energyLetters.map((letter, letterIndex) => {
              const energyKey = `[${letter}]`;
              if (energySymbols[energyKey]) {
                return (
                  <img
                    key={letterIndex}
                    src={energySymbols[energyKey]}
                    alt={letter}
                    className="inline-block w-4 h-4 mx-0.3 align-middle"
                  />
                );
              }
              return letter;
            })}
          </span>
        );
      } else if (part.match(/^\{[CGWRPLFDM]+\}$/)) {
        // Extract individual energy letters from braces
        const energyLetters = part.slice(1, -1).split("");
        return (
          <span
            key={index}
            className="inline-flex items-center gap-0.5"
            style={{ marginRight: "10px" }}
          >
            {energyLetters.map((letter, letterIndex) => {
              const energyKey = `{${letter}}`;
              if (energySymbols[energyKey]) {
                return (
                  <img
                    key={letterIndex}
                    src={energySymbols[energyKey]}
                    alt={letter}
                    className="inline-block w-4 h-4 mx-0.3 align-middle"
                  />
                );
              }
              return letter;
            })}
          </span>
        );
      } else if (energySymbols[part]) {
        // Single energy symbol
        return (
          <img
            key={index}
            src={energySymbols[part]}
            alt={part}
            className="inline-block w-4 h-4 mx-1 align-middle"
          />
        );
      }
      return part;
    });
  };

  // Chart and pricing state
  const [selectedPriceType, setSelectedPriceType] = useState("Raw");
  const [selectedTimeframe, setSelectedTimeframe] = useState("6M");
  const [showPriceTypeDropdown, setShowPriceTypeDropdown] = useState(false);

  // Infinite scroll state
  const [visibleCardsCount, setVisibleCardsCount] = useState(12); // Start with 12 cards
  const [isLoadingMore, setIsLoadingMore] = useState(false);
  const [showLoadMoreHint, setShowLoadMoreHint] = useState(false);

  // Trending cards pagination (removed - dashboard now shows fixed 12 cards)

  // Helper function to get card variants and their colors

  // Calculate ungraded values based on card and condition
  const getUngradedValues = useMemo(() => {
    if (!selectedCard) return {};

    // Get base market value - handle different pricing structures
    const baseValue =
      selectedCard?.currentValue ||
      selectedCard?.current_value ||
      selectedCard?.price ||
      selectedCard?.tcgplayer?.prices?.holofoil?.market ||
      selectedCard?.tcgplayer?.prices?.normal?.market ||
      selectedCard?.tcgplayer?.prices?.reverseHolofoil?.market ||
      selectedCard?.tcgplayer?.prices?.firstEditionHolofoil?.market ||
      0;

    // Condition multipliers (relative to Near Mint)
    const conditionMultipliers = {
      NM: 1.0, // Near Mint - 100%
      LP: 0.85, // Lightly Played - 85%
      MP: 0.7, // Moderately Played - 70%
      HP: 0.5, // Heavily Played - 50%
      DM: 0.3, // Damaged - 30%
    };

    const values = {};
    Object.entries(conditionMultipliers).forEach(([condition, multiplier]) => {
      values[condition] = Math.round(baseValue * multiplier * 100) / 100;
    });

    return values;
  }, [selectedCard]);

  const [flashEnabled, setFlashEnabled] = useState(false);
  const [selectedFolder, setSelectedFolder] = useState("My Collection");
  const [selectedModalCondition, setSelectedModalCondition] =
    useState("Near Mint");

  // Real user data is loaded from userDatabase.getUserData()
  // No mock data needed - using real collection data

  // Real trending cards are loaded from the database - no mock generation needed

  // Use real trending cards data from database
  const allTrendingCards = useMemo(() => {
    return trendingCardsData.length > 0 ? trendingCardsData : [];
  }, [trendingCardsData]);

  // Load more cards function
  const loadMoreCards = () => {
    if (isLoadingMore) return;

    setIsLoadingMore(true);

    // Load more cards immediately with a small delay for smooth UX
    setTimeout(() => {
      setVisibleCardsCount((prev) =>
        Math.min(prev + 12, allTrendingCards.length)
      ); // Load 12 cards at a time
      setIsLoadingMore(false);
    }, 300); // Reasonable loading delay
  };

  // Infinite scroll handler
  const handleScroll = (e) => {
    const { scrollTop, scrollHeight, clientHeight } = e.target;
    const scrollPercentage = (scrollTop + clientHeight) / scrollHeight;

    // Show hint when approaching load threshold
    if (scrollPercentage > 0.7 && scrollPercentage < 0.8) {
      setShowLoadMoreHint(true);
    } else {
      setShowLoadMoreHint(false);
    }

    // Load more when user scrolls to 80% of the content
    // Only trigger on search page when trending cards are visible
    if (
      scrollPercentage > 0.8 &&
      visibleCardsCount < allTrendingCards.length &&
      !showSearchResults &&
      !isLoadingMore
    ) {
      loadMoreCards();
    }
  };

  // Create new collection function
  const createNewCollection = () => {
    if (newCollectionName.trim()) {
      const newCollection = {
        id: `collection-${Date.now()}`,
        name: newCollectionName.trim(),
        totalValue: 0,
        totalCards: 0,
        monthlyChange: 0,
        currency: "USD",
        lastUpdated: new Date().toISOString().split("T")[0],
        cardsAddedThisWeek: 0,
        valueChangeThisWeek: 0,
        isUserCreated: true,
      };

      // Add to collections using userDatabase
      const success = userDatabase.createCollection(
        newCollection.name,
        newCollection.description
      );
      if (!success) {
        console.error("Failed to create collection");
        return;
      }

      // Select the new collection
      setSelectedCollection(newCollection.id);
      setNewCollectionName("");
      setShowCreateCollectionModal(false);
      setShowCollectionDropdown(false);
    }
  };

  // Reset scroll position when navigating between tabs
  useEffect(() => {
    // Scroll to top when activeTab changes
    window.scrollTo({ top: 0, left: 0, behavior: "smooth" });
  }, [activeTab]);

  // Helper function to close card profile and restore previous page
  const handleCloseCardProfileAndRestore = () => {
    // Very visible debug - use console.error to ensure it shows up
    console.error(
      "🔙🔙🔙 [NAV DEBUG] BACK BUTTON CLICKED - handleCloseCardProfileAndRestore called"
    );
    console.log("🔙 [NAV DEBUG] handleCloseCardProfileAndRestore called");
    console.log("🔙 [NAV DEBUG] Current state:", {
      showCardProfile,
      showSetPage,
      selectedSet,
      setCardsDataLength: setCardsData?.length || 0,
      selectedSetData: selectedSetData ? "exists" : "null",
    });

    // Check history state to see if we came from a set page
    const historyState = window.history.state;
    console.log("🔙 [NAV DEBUG] History state:", historyState);

    const cameFromSetPage =
      historyState?.fromSetPage || (showSetPage && selectedSet);
    const previousSetId = historyState?.previousSetId || selectedSet;

    console.log("🔙 [NAV DEBUG] Navigation context:", {
      cameFromSetPage,
      previousSetId,
      currentShowSetPage: showSetPage,
      currentSelectedSet: selectedSet,
    });

    setShowCardProfile(false);
    setSelectedCard(null);

    // Restore set page visibility if it was hidden via DOM manipulation
    setTimeout(() => {
      const setPageElement = document.querySelector(".set-page-container");
      if (setPageElement) {
        setPageElement.style.opacity = "";
        setPageElement.style.pointerEvents = "";
      }
    }, 0);

    // If we came from a set page, ensure it remains visible with card list
    if (cameFromSetPage && previousSetId) {
      console.log("🔙 [NAV DEBUG] Restoring set page with card list");

      // Restore set page state to show the card list
      if (!showSetPage) {
        console.log("🔙 [NAV DEBUG] Setting showSetPage to true");
        setShowSetPage(true);
      }
      if (selectedSet !== previousSetId) {
        console.log("🔙 [NAV DEBUG] Setting selectedSet to:", previousSetId);
        setSelectedSet(previousSetId);
      }
      // Get restoration data from history state
      const previousSetData = historyState?.previousSetData;
      const previousSetCardsData = historyState?.previousSetCardsData;

      console.log("🔙 [NAV DEBUG] Restoration data check:", {
        previousSetDataExists: !!previousSetData,
        previousSetCardsDataLength: previousSetCardsData?.length || 0,
        currentSetDataExists: !!selectedSetData,
        currentSetCardsDataLength: setCardsData?.length || 0,
      });

      // Restore state in the correct order: set data first, then cards
      if (previousSetData) {
        console.log("🔙 [NAV DEBUG] Restoring set data");
        setSelectedSetData(previousSetData);
      }

      // Restore card list data IMMEDIATELY - this must happen to show cards
      if (previousSetCardsData && previousSetCardsData.length > 0) {
        console.error(
          "🔙🔙🔙 [NAV DEBUG] RESTORING CARD LIST IMMEDIATELY with",
          previousSetCardsData.length,
          "cards"
        );
        setSetCardsData(previousSetCardsData);
      } else {
        console.error(
          "🔙🔙🔙 [NAV DEBUG] NO CARD LIST DATA TO RESTORE - will load from API/cache"
        );
      }
    } else {
      console.log(
        "🔙 [NAV DEBUG] NOT restoring set page - conditions not met:",
        {
          cameFromSetPage,
          previousSetId,
          reason: !cameFromSetPage
            ? "did not come from set page"
            : !previousSetId
            ? "no previous set ID"
            : "unknown",
        }
      );
    }

    console.log("🔙 [NAV DEBUG] Restore complete. Final state will be:", {
      showCardProfile: false,
      showSetPage: cameFromSetPage && previousSetId ? true : showSetPage,
      selectedSet:
        cameFromSetPage && previousSetId ? previousSetId : selectedSet,
    });
  };

  // Handle browser back button for navigation
  useEffect(() => {
    const handlePopState = (event) => {
      // Handle back button navigation
      if (showCardProfile) {
        // If card profile is open, close it and restore previous page
        handleCloseCardProfileAndRestore();
        event.preventDefault();
        return;
      }

      if (showSearchResults) {
        // If search results are showing, go back to trending cards
        setShowSearchResults(false);
        setSearchQuery("");
        setActiveTab("search");
        setNavigationMode("search");
        event.preventDefault();
        return;
      }

      if (showSetPage) {
        // If set page is open, close it
        setShowSetPage(false);
        setSelectedSet(null);
        event.preventDefault();
        return;
      }

      // Default: go to home tab
      if (activeTab !== "home") {
        setActiveTab("home");
        setNavigationMode("home");
        event.preventDefault();
        return;
      }
    };

    // Add event listener
    window.addEventListener("popstate", handlePopState);

    // Cleanup
    return () => {
      window.removeEventListener("popstate", handlePopState);
    };
  }, [showCardProfile, showSearchResults, showSetPage, activeTab]);

  // Debug: Track state changes
  useEffect(() => {
    console.log(
      "🔄 [NAV DEBUG] State change - showCardProfile:",
      showCardProfile
    );
  }, [showCardProfile]);

  useEffect(() => {
    console.log(
      "🔄 [NAV DEBUG] State change - showSetPage:",
      showSetPage,
      "selectedSet:",
      selectedSet
    );
  }, [showSetPage, selectedSet]);

  useEffect(() => {
    console.log(
      "🔄 [NAV DEBUG] State change - setCardsData length:",
      setCardsData?.length || 0
    );
  }, [setCardsData?.length]);

  useEffect(() => {
    console.log(
      "🔄 [NAV DEBUG] State change - selectedSetData:",
      selectedSetData
        ? {
            name: selectedSetData.name,
            cards_total: selectedSetData.cards_total,
            group_id: selectedSetData.group_id,
          }
        : "null"
    );
  }, [selectedSetData]);

  // Set default variant when card is selected for adding to collection
  useEffect(() => {
    if (cardToAddFromSearch) {
      // Get available variants for this specific card based on rarity
      const availableVariants = [];
      const rarity = cardToAddFromSearch.ext_rarity || "";

      // Determine variants based on rarity
      if (rarity.includes("Holo") || rarity.includes("Rare")) {
        // Holo cards can have both Normal and Holo variants
        availableVariants.push("Normal");
        availableVariants.push("Holo");

        // Add Reverse Holo for most holo cards
        if (
          !rarity.includes("Secret") &&
          !rarity.includes("Ultra") &&
          !rarity.includes("Hyper")
        ) {
          availableVariants.push("Reverse Holo");
        }
      } else if (
        rarity.includes("Secret") ||
        rarity.includes("Ultra") ||
        rarity.includes("Hyper")
      ) {
        // Secret/Ultra/Hyper rare cards are typically holo only
        availableVariants.push("Holo");
      } else if (rarity.includes("Common") || rarity.includes("Uncommon")) {
        // Common/Uncommon cards are typically normal only
        availableVariants.push("Normal");
      } else {
        // Default to Normal for unknown rarities
        availableVariants.push("Normal");
      }

      // Add special variants based on rarity
      if (rarity.includes("1st Edition") || rarity.includes("First Edition")) {
        availableVariants.push("1st Edition");
      }
      if (rarity.includes("Shadowless")) {
        availableVariants.push("Shadowless");
      }
      if (rarity.includes("Radiant")) {
        availableVariants.push("Radiant");
      }

      // Remove duplicates
      const uniqueVariants = [...new Set(availableVariants)];

      // Set the first available variant as default, or 'Normal' as fallback
      if (uniqueVariants.length > 0) {
        setSelectedVariant(uniqueVariants[0]);
      } else {
        setSelectedVariant("Normal");
      }
    }
  }, [cardToAddFromSearch]);

  // Set default variant when cardToAddFromProfile changes
  useEffect(() => {
    if (cardToAddFromProfile) {
      // Get available variants for this specific card based on rarity
      const availableVariants = [];
      const rarity = cardToAddFromProfile.ext_rarity || "";

      // Determine variants based on rarity
      if (rarity.includes("Holo") || rarity.includes("Rare")) {
        // Holo cards can have both Normal and Holo variants
        availableVariants.push("Normal");
        availableVariants.push("Holo");

        // Add Reverse Holo for most holo cards
        if (
          !rarity.includes("Secret") &&
          !rarity.includes("Ultra") &&
          !rarity.includes("Hyper")
        ) {
          availableVariants.push("Reverse Holo");
        }
      } else if (
        rarity.includes("Secret") ||
        rarity.includes("Ultra") ||
        rarity.includes("Hyper")
      ) {
        // Secret/Ultra/Hyper rare cards are typically holo only
        availableVariants.push("Holo");
      } else if (rarity.includes("Common") || rarity.includes("Uncommon")) {
        // Common/Uncommon cards are typically normal only
        availableVariants.push("Normal");
      } else {
        // Default to Normal for unknown rarities
        availableVariants.push("Normal");
      }

      // Add special variants based on rarity
      if (rarity.includes("1st Edition") || rarity.includes("First Edition")) {
        availableVariants.push("1st Edition");
      }
      if (rarity.includes("Shadowless")) {
        availableVariants.push("Shadowless");
      }
      if (rarity.includes("Radiant")) {
        availableVariants.push("Radiant");
      }

      // Remove duplicates
      const uniqueVariants = [...new Set(availableVariants)];

      // Set the first available variant as default, or 'Normal' as fallback
      if (uniqueVariants.length > 0) {
        setSelectedVariant(uniqueVariants[0]);
      } else {
        setSelectedVariant("Normal");
      }
    }
  }, [cardToAddFromProfile]);

  // Set default variant when cardToAdd changes
  useEffect(() => {
    if (cardToAdd) {
      // Get available variants for this specific card based on rarity
      const availableVariants = [];
      const rarity = cardToAdd.ext_rarity || "";

      // Determine variants based on rarity
      if (rarity.includes("Holo") || rarity.includes("Rare")) {
        // Holo cards can have both Normal and Holo variants
        availableVariants.push("Normal");
        availableVariants.push("Holo");

        // Add Reverse Holo for most holo cards
        if (
          !rarity.includes("Secret") &&
          !rarity.includes("Ultra") &&
          !rarity.includes("Hyper")
        ) {
          availableVariants.push("Reverse Holo");
        }
      } else if (
        rarity.includes("Secret") ||
        rarity.includes("Ultra") ||
        rarity.includes("Hyper")
      ) {
        // Secret/Ultra/Hyper rare cards are typically holo only
        availableVariants.push("Holo");
      } else if (rarity.includes("Common") || rarity.includes("Uncommon")) {
        // Common/Uncommon cards are typically normal only
        availableVariants.push("Normal");
      } else {
        // Default to Normal for unknown rarities
        availableVariants.push("Normal");
      }

      // Add special variants based on rarity
      if (rarity.includes("1st Edition") || rarity.includes("First Edition")) {
        availableVariants.push("1st Edition");
      }
      if (rarity.includes("Shadowless")) {
        availableVariants.push("Shadowless");
      }
      if (rarity.includes("Radiant")) {
        availableVariants.push("Radiant");
      }

      // Remove duplicates
      const uniqueVariants = [...new Set(availableVariants)];

      // Set the first available variant as default, or 'Normal' as fallback
      if (uniqueVariants.length > 0) {
        setSelectedVariant(uniqueVariants[0]);
      } else {
        setSelectedVariant("Normal");
      }
    }
  }, [cardToAdd]);

  // Close dropdowns when clicking outside
  useEffect(() => {
    const handleClickOutside = (event) => {
      if (showCurrencyDropdown && !event.target.closest(".currency-dropdown")) {
        setShowCurrencyDropdown(false);
      }
      if (
        showCollectionDropdown &&
        !event.target.closest(".collection-dropdown")
      ) {
        setShowCollectionDropdown(false);
      }
    };

    document.addEventListener("mousedown", handleClickOutside);
    return () => {
      document.removeEventListener("mousedown", handleClickOutside);
    };
  }, [showCurrencyDropdown, showCollectionDropdown]);

  // Load pricing alerts and set progression when user is authenticated or has localStorage data
  useEffect(() => {
    if (isAuthenticated && user?.id) {
      // Clear pricing alerts first, then load user-specific alerts from backend
      setPricingAlerts([]);
      loadPricingAlerts();
      loadSetProgression();
    } else if (
      userData &&
      userData.collections &&
      userData.collections.length > 0
    ) {
      // Load set progression from localStorage even when not authenticated
      loadSetProgression();
      setPricingAlerts([]); // Keep pricing alerts empty when not authenticated
    } else {
      // Clear pricing alerts when not authenticated
      setPricingAlerts([]);
      setSetProgression([]);
    }
  }, [isAuthenticated, user?.id, userData]); // Add user?.id dependency to reload when user changes

  // Fetch current prices for pricing alerts when component mounts or user navigates to profile
  useEffect(() => {
    // Only fetch prices if user is authenticated and has alerts
    if (
      activeTab === "profile" &&
      isAuthenticated &&
      user?.id &&
      pricingAlerts.length > 0
    ) {
      fetchAlertCurrentPrices();
    }
  }, [activeTab, pricingAlerts.length, isAuthenticated, user?.id]);

  // Currency options and conversion rates
  const currencies = [
    { code: "USD", symbol: "$", flag: "🇺🇸", name: "US Dollar" },
    { code: "EUR", symbol: "€", flag: "🇪🇺", name: "Euro" },
    { code: "GBP", symbol: "£", flag: "🇬🇧", name: "British Pound" },
    { code: "JPY", symbol: "¥", flag: "🇯🇵", name: "Japanese Yen" },
    { code: "CAD", symbol: "C$", flag: "🇨🇦", name: "Canadian Dollar" },
    { code: "AUD", symbol: "A$", flag: "🇦🇺", name: "Australian Dollar" },
  ];

  // Mock conversion rates (in real app, these would come from an API)
  const conversionRates = {
    USD: 1.0,
    EUR: 0.85,
    GBP: 0.73,
    JPY: 110.0,
    CAD: 1.25,
    AUD: 1.35,
  };

  // Convert value to selected currency
  const convertCurrency = (usdValue) => {
    const rate = conversionRates[selectedCurrency] || 1.0;
    return usdValue * rate;
  };

  // Format currency value
  const formatCurrency = (value) => {
    const convertedValue = convertCurrency(value);
    const currency = currencies.find((c) => c.code === selectedCurrency);
    return `${currency?.symbol || "$"}${convertedValue.toFixed(2)}`;
  };

  // Helper function to scroll to top
  const scrollToTop = () => {
    // Scroll the main container to top
    const mainContainer = document.querySelector("[data-main-container]");
    if (mainContainer) {
      mainContainer.scrollTo({ top: 0, behavior: "smooth" });
    }

    // Also scroll window to top as fallback
    window.scrollTo({ top: 0, behavior: "smooth" });
  };

  // Search functions using database API
  const handleSearch = async (isAutoSearch = false) => {
    // Don't trigger search if we're on the collection tab (use collection search instead)
    if (activeTab === "collection") {
      return;
    }

    // Don't search if query is empty
    if (!searchQuery.trim()) {
      return;
    }

    // Store the currently focused element before search
    const previouslyFocusedElement = document.activeElement;
    const wasSearchInputFocused =
      previouslyFocusedElement?.type === "text" ||
      previouslyFocusedElement?.tagName === "INPUT";

    // Only blur on manual search (not auto-search), and only on mobile
    if (
      !isAutoSearch &&
      document.activeElement &&
      document.activeElement.blur
    ) {
      document.activeElement.blur();
    }

    try {
      setLoading(true);

      // Use API endpoint for search to get proper formatted numbers
      // Increase limit to ensure we get results from multiple languages
      const response = await fetch(
        `${API_URL}/api/cards/search?q=${encodeURIComponent(
          searchQuery
        )}&limit=500&t=${Date.now()}`
      );
      if (!response.ok) {
        throw new Error(`Search failed: ${response.status}`);
      }
      const searchData = await response.json();
      const searchResults = searchData.data || [];

      // Search results loaded successfully

      // Apply filters to the API results

      // Get active languages for filtering - use activeFilters.language instead of selectedLanguages
      // Map language names to language codes
      const languageNameToCode = {
        English: "en",
        Japanese: "ja",
        Chinese: "zh",
      };
      const activeLanguages = activeFilters.language.map(
        (lang) => languageNameToCode[lang] || "en"
      );

      // Get active energy types for filtering
      const activeEnergies = Object.entries(selectedEnergies)
        .filter(([energy, isSelected]) => isSelected)
        .map(([energy]) => {
          // Map UI energy types to Pokemon TCG API energy types
          const energyMap = {
            colorless: "Colorless",
            darkness: "Darkness",
            dragon: "Dragon",
            electric: "Lightning", // Pokemon TCG uses "Lightning" not "Electric"
            fairy: "Fairy",
            fighting: "Fighting",
            fire: "Fire",
            grass: "Grass",
            metal: "Metal",
            psychic: "Psychic",
            water: "Water",
          };
          return energyMap[energy];
        });

      // Get active variants for filtering
      const activeVariants = Object.entries(selectedVariants)
        .filter(([variant, isSelected]) => isSelected)
        .map(([variant]) => {
          // Map UI variant types to Pokemon TCG API variant types
          const variantMap = {
            normal: "Normal",
            holo: "Holo",
            reverseHolo: "Reverse Holo",
            firstEdition: "1st Edition",
          };
          return variantMap[variant];
        });

      // Get active regulations for filtering
      const activeRegulations = Object.entries(selectedRegulations)
        .filter(([regulation, isSelected]) => isSelected)
        .map(([regulation]) => regulation.toUpperCase());

      // Get active formats for filtering
      const activeFormats = Object.entries(selectedFormats)
        .filter(([format, isSelected]) => isSelected)
        .map(([format]) => {
          // Map UI format types to Pokemon TCG API format types
          const formatMap = {
            unlimited: "Unlimited",
            expanded: "Expanded",
            standard: "Standard",
          };
          return formatMap[format];
        });

      // Apply filters to the API results
      let filtered = searchResults;

      // Apply filters to search results

      // Apply language filter
      if (activeLanguages.length > 0) {
        const activeLanguageCodes = activeLanguages.map((lang) =>
          lang.toLowerCase()
        );
        filtered = filtered.filter((card) => {
          // Get card language, defaulting to 'en' if not set
          const cardLanguage = (card.language || "en").toLowerCase().trim();
          const matches = activeLanguageCodes.includes(cardLanguage);
          return matches;
        });
      }

      // Apply energy type filter
      if (activeEnergies.length > 0) {
        filtered = filtered.filter(
          (card) =>
            card.types &&
            card.types.some((type) => activeEnergies.includes(type))
        );
      }

      // Apply variant filter - skip for now as cards don't have variant property
      // if (activeVariants.length > 0) {
      //   filtered = filtered.filter(card =>
      //     activeVariants.includes(card.variant)
      //   );
      // }

      // Apply regulation filter - only filter if we have specific regulations selected
      // and the card has a regulation mark that doesn't match
      console.log("Active regulations:", activeRegulations);
      console.log("Cards before regulation filter:", filtered.length);
      if (activeRegulations.length > 0 && activeRegulations.length < 9) {
        // Only apply filter if not all regulations are selected
        filtered = filtered.filter(
          (card) =>
            !card.regulationMark ||
            activeRegulations.includes(card.regulationMark)
        );
        console.log("Cards after regulation filter:", filtered.length);
      }

      // Apply format filter - skip for now as cards don't have format property
      // if (activeFormats.length > 0) {
      //   filtered = filtered.filter(card =>
      //     activeFormats.includes(card.format)
      //   );
      // }

      setOriginalSearchResults(filtered);
      setFilteredSearchResults(filtered);
      setShowSearchResults(true);

      try {
        loadSearchResultImages(filtered);
      } catch (imageError) {
        console.warn("Image loading failed:", imageError);
      }

      // Push state to history for back button support
      window.history.pushState(
        { searchResults: true, query: searchQuery },
        "",
        window.location.href
      );

      // Track search event
      try {
        trackEvent("search", {
          query: searchQuery,
          results_count: filtered.length,
          tab: activeTab,
          filters: {
            languages: activeLanguages,
            energies: activeEnergies,
            variants: activeVariants,
            regulations: activeRegulations,
            formats: activeFormats,
          },
        });
      } catch (trackingError) {
        console.warn("Event tracking failed:", trackingError);
      }
    } catch (error) {
      // Show error message instead of fallback data
      console.error("Search error:", error);
      console.error("Error message:", error.message);
      console.error("Error stack:", error.stack);
      setOriginalSearchResults([]);
      setFilteredSearchResults([]);
      setShowSearchResults(true);
      alert(`Search failed: ${error.message}. Please try again.`);
    } finally {
      setLoading(false);
    }
  };

  // Load images for search results - now using database API structure
  const loadSearchResultImages = async (searchCards = []) => {
    const imageMap = {};
    searchCards.forEach((card) => {
      // Use the imageUrl or images object directly (already formatted with extensions)
      if (card.imageUrl) {
        imageMap[card.id] = card.imageUrl;
      } else if (card.images?.small) {
        imageMap[card.id] = card.images.small;
      } else if (card.images?.large) {
        imageMap[card.id] = card.images.large;
      }
    });

    setCardImages((prev) => ({ ...prev, ...imageMap }));
  };

  // Sort cards based on selected option
  const sortCards = (cards, sortType) => {
    const sortedCards = [...cards].sort((a, b) => {
      // Helper function to get card price from any data structure
      const getCardPrice = (card) => {
        if (!card) return 0;

        // Priority 1: Use current_value if available and > 0
        if (card.current_value && card.current_value > 0) {
          return card.current_value;
        }

        // Priority 2: Try to parse tcgplayer JSON data
        let tcgplayerData = null;
        if (typeof card.tcgplayer === "string") {
          try {
            tcgplayerData = JSON.parse(card.tcgplayer);
          } catch (e) {
            console.warn("Failed to parse tcgplayer data for", card.name);
          }
        } else if (typeof card.tcgplayer === "object") {
          tcgplayerData = card.tcgplayer;
        }

        if (tcgplayerData) {
          // Try normal market price first
          if (tcgplayerData.normal?.market && tcgplayerData.normal.market > 0) {
            return tcgplayerData.normal.market;
          }
          // Fall back to holofoil market price
          if (
            tcgplayerData.holofoil?.market &&
            tcgplayerData.holofoil.market > 0
          ) {
            return tcgplayerData.holofoil.market;
          }
          // Fall back to normal low price
          if (tcgplayerData.normal?.low && tcgplayerData.normal.low > 0) {
            return tcgplayerData.normal.low;
          }
        }

        // Priority 3: Try cardmarket data
        let cardmarketData = null;
        if (typeof card.cardmarket === "string") {
          try {
            cardmarketData = JSON.parse(card.cardmarket);
          } catch (e) {
            console.warn("Failed to parse cardmarket data for", card.name);
          }
        } else if (typeof card.cardmarket === "object") {
          cardmarketData = card.cardmarket;
        }

        if (cardmarketData?.average && cardmarketData.average > 0) {
          return cardmarketData.average;
        }

        // Priority 4: Legacy tcgplayer parsing (for backward compatibility)
        if (card.tcgplayer && typeof card.tcgplayer === "string") {
          try {
            const tcgData = JSON.parse(card.tcgplayer);
            if (
              tcgData.prices?.normal?.market &&
              tcgData.prices.normal.market > 0
            ) {
              return tcgData.prices.normal.market;
            }
            if (
              tcgData.prices?.holofoil?.market &&
              tcgData.prices.holofoil.market > 0
            ) {
              return tcgData.prices.holofoil.market;
            }
          } catch (e) {
            // Ignore parsing errors for legacy format
          }
        }

        // Legacy fallbacks
        if (card.currentValue) return card.currentValue;
        if (card.price) return card.price;

        return 0;
      };

      // Helper function to get price change percentage
      const getPriceChange = (card) => {
        if (card.priceChange) return card.priceChange;
        if (card.price_change) return card.price_change;
        if (card.priceChangePercentage) return card.priceChangePercentage;
        if (card.price_change_percentage) return card.price_change_percentage;
        // Mock price change for demo purposes (you can replace with real data)
        return Math.random() * 20 - 10; // Random change between -10% and +10%
      };

      // Helper function to get date added
      const getDateAdded = (card) => {
        if (card.dateAdded) return new Date(card.dateAdded);
        if (card.date_added) return new Date(card.date_added);
        if (card.createdAt) return new Date(card.createdAt);
        if (card.created_at) return new Date(card.created_at);
        // Mock date for demo purposes (you can replace with real data)
        return new Date(Date.now() - Math.random() * 365 * 24 * 60 * 60 * 1000); // Random date within last year
      };

      switch (sortType) {
        case "name-asc":
          return a.name.localeCompare(b.name);
        case "name-desc":
          return b.name.localeCompare(a.name);
        case "price-low":
          return getCardPrice(a) - getCardPrice(b);
        case "price-high":
          return getCardPrice(b) - getCardPrice(a);
        case "price-change-low":
          return getPriceChange(a) - getPriceChange(b);
        case "price-change-high":
          return getPriceChange(b) - getPriceChange(a);
        case "number-asc":
          return (
            parseInt(a.number?.replace("#", "") || "0") -
            parseInt(b.number?.replace("#", "") || "0")
          );
        case "number-desc":
          return (
            parseInt(b.number?.replace("#", "") || "0") -
            parseInt(a.number?.replace("#", "") || "0")
          );
        case "date-added-oldest":
          return getDateAdded(a) - getDateAdded(b);
        case "date-added-newest":
          return getDateAdded(b) - getDateAdded(a);
        case "number":
          return (
            parseInt(a.number?.replace("#", "") || "0") -
            parseInt(b.number?.replace("#", "") || "0")
          );
        case "pokemon-number":
          return (
            (a.nationalPokedexNumbers?.[0] || 0) -
            (b.nationalPokedexNumbers?.[0] || 0)
          );
        case "trending":
          return getCardPrice(b) - getCardPrice(a);
        default:
          return 0;
      }
    });
    return sortedCards;
  };

  // Handle sort option selection
  const handleSortOption = (option) => {
    setSortOption(option);
    const sortedCards = sortCards(filteredSearchResults, option);
    setFilteredSearchResults(sortedCards);
    setShowSortModal(false);

    // Track sort event
    eventTracker.trackSortApplied(option);
  };

  const handleQuickFilterToggle = (filterType) => {
    setQuickFilters((prev) => ({
      ...prev,
      [filterType]: !prev[filterType],
    }));
  };

  const selectAllQuickFilters = () => {
    setQuickFilters((prev) => {
      const updated = {};
      Object.keys(prev).forEach((key) => {
        updated[key] = true;
      });
      return updated;
    });
  };

  const deselectAllQuickFilters = () => {
    setQuickFilters((prev) => {
      const updated = {};
      Object.keys(prev).forEach((key) => {
        updated[key] = false;
      });
      return updated;
    });
  };

  const applyQuickFilters = () => {
    setShowQuickFiltersModal(false);
    // Filter the search results based on selected quick filters
    filterSearchResults();
  };

  const filterSearchResults = () => {
    if (!originalSearchResults.length) return;

    let filteredCards = [...originalSearchResults];

    // Apply quick filters based on collection status
    if (quickFilters.owned) {
      // Show only owned cards (quantity > 0)
      filteredCards = filteredCards.filter((card) => card.quantity > 0);
    }

    if (quickFilters.missing) {
      // Show only missing cards (quantity = 0)
      filteredCards = filteredCards.filter((card) => card.quantity === 0);
    }

    if (quickFilters.duplicates) {
      // Show only cards with duplicates (quantity > 1)
      filteredCards = filteredCards.filter((card) => card.quantity > 1);
    }

    if (quickFilters.wishlist) {
      // Show only wishlist cards (for now, we'll use a placeholder logic)
      // In a real app, this would check a wishlist status field
      filteredCards = filteredCards.filter((card) => card.wishlist === true);
    }

    // If no filters are selected, show all cards
    const hasActiveFilters = Object.values(quickFilters).some(
      (filter) => filter
    );
    if (!hasActiveFilters) {
      filteredCards = [...originalSearchResults];
    }

    setFilteredSearchResults(filteredCards);
  };

  const handleLanguageToggle = (language) => {
    setSelectedLanguages((prev) => ({
      ...prev,
      [language]: !prev[language],
    }));
  };

  const selectAllLanguages = () => {
    setSelectedLanguages((prev) => {
      const updated = {};
      Object.keys(prev).forEach((key) => {
        updated[key] = true;
      });
      return updated;
    });
  };

  const deselectAllLanguages = () => {
    setSelectedLanguages((prev) => {
      const updated = {};
      Object.keys(prev).forEach((key) => {
        updated[key] = false;
      });
      return updated;
    });
  };

  const applyLanguageFilters = () => {
    setShowLanguageModal(false);
    // Filter the search results based on selected languages
    filterByLanguage();
  };

  const filterByLanguage = () => {
    if (!originalSearchResults.length) return;

    let filteredCards = [...originalSearchResults];

    // Apply language filters
    const activeLanguages = Object.entries(selectedLanguages)
      .filter(([lang, isSelected]) => isSelected)
      .map(([lang]) => lang);

    if (activeLanguages.length > 0) {
      filteredCards = filteredCards.filter((card) => {
        // Map language names to language codes
        const languageMap = {
          english: ["en", "english"],
          japanese: ["jp", "ja", "japanese"],
          chinese: ["zh", "chinese"],
        };

        // Check if card's language matches any selected language
        const cardLanguage = card.language?.toLowerCase() || "en";
        return activeLanguages.some((lang) =>
          languageMap[lang]?.includes(cardLanguage)
        );
      });
    }

    setFilteredSearchResults(filteredCards);
  };

  const handleConditionToggle = (condition) => {
    setSelectedConditions((prev) => ({
      ...prev,
      [condition]: !prev[condition],
    }));
  };

  const selectAllConditions = () => {
    setSelectedConditions((prev) => {
      const updated = {};
      Object.keys(prev).forEach((key) => {
        updated[key] = true;
      });
      return updated;
    });
  };

  const deselectAllConditions = () => {
    setSelectedConditions((prev) => {
      const updated = {};
      Object.keys(prev).forEach((key) => {
        updated[key] = false;
      });
      return updated;
    });
  };

  const applyConditionFilters = () => {
    setShowConditionModal(false);
    // Filter the search results based on selected conditions
    filterByCondition();
  };

  const filterByCondition = () => {
    if (!originalSearchResults.length) return;

    let filteredCards = [...originalSearchResults];

    // Apply condition filters
    const activeConditions = Object.entries(selectedConditions)
      .filter(([condition, isSelected]) => isSelected)
      .map(([condition]) => condition);

    if (activeConditions.length > 0) {
      filteredCards = filteredCards.filter((card) => {
        // Map condition names to condition codes
        const conditionMap = {
          mint: ["mint", "m"],
          nearMint: ["near mint", "nearmint", "nm"],
          lightlyPlayed: ["lightly played", "lightlyplayed", "lp"],
          moderatelyPlayed: ["moderately played", "moderatelyplayed", "mp"],
          heavilyPlayed: ["heavily played", "heavilyplayed", "hp"],
          damaged: ["damaged", "d"],
        };

        // Check if card's condition matches any selected condition
        const cardCondition = card.condition?.toLowerCase() || "nearmint";
        return activeConditions.some((condition) =>
          conditionMap[condition]?.includes(cardCondition)
        );
      });
    }

    setFilteredSearchResults(filteredCards);
  };

  const handleProductsToggle = (productType) => {
    setSelectedProducts((prev) => ({
      ...prev,
      [productType]: !prev[productType],
    }));
  };

  const selectAllProducts = () => {
    setSelectedProducts((prev) => {
      const updated = {};
      Object.keys(prev).forEach((key) => {
        updated[key] = true;
      });
      return updated;
    });
  };

  const deselectAllProducts = () => {
    setSelectedProducts((prev) => {
      const updated = {};
      Object.keys(prev).forEach((key) => {
        updated[key] = false;
      });
      return updated;
    });
  };

  const applyProductsFilters = () => {
    setShowProductsModal(false);
    // Filter the search results based on selected product types
    filterByProducts();
  };

  const filterByProducts = () => {
    if (!originalSearchResults.length) return;

    let filteredCards = [...originalSearchResults];

    // Apply product type filters
    const activeProducts = Object.entries(selectedProducts)
      .filter(([product, isSelected]) => isSelected)
      .map(([product]) => product);

    if (activeProducts.length > 0) {
      filteredCards = filteredCards.filter((card) => {
        // Map product types to product codes
        const productMap = {
          cardsOnly: ["card", "cards", "individual"],
          sealedOnly: ["sealed", "pack", "booster", "box", "collection"],
        };

        // Check if card's product type matches any selected product type
        const cardProductType = card.product_type?.toLowerCase() || "card";
        return activeProducts.some((product) =>
          productMap[product]?.includes(cardProductType)
        );
      });
    }

    setFilteredSearchResults(filteredCards);
  };

  const handleEnergyToggle = (energyType) => {
    setSelectedEnergies((prev) => ({
      ...prev,
      [energyType]: !prev[energyType],
    }));
  };

  const selectAllEnergies = () => {
    setSelectedEnergies((prev) => {
      const updated = {};
      Object.keys(prev).forEach((key) => {
        updated[key] = true;
      });
      return updated;
    });
  };

  const deselectAllEnergies = () => {
    setSelectedEnergies((prev) => {
      const updated = {};
      Object.keys(prev).forEach((key) => {
        updated[key] = false;
      });
      return updated;
    });
  };

  const applyEnergyFilters = () => {
    setShowEnergyModal(false);
    // Trigger a new search with the selected energy types
    handleSearch();
  };

  // Variant filter functions
  const handleVariantToggle = (variant) => {
    setSelectedVariants((prev) => ({
      ...prev,
      [variant]: !prev[variant],
    }));
  };

  const applyVariantFilters = () => {
    setShowVariantModal(false);
    handleSearch(); // Trigger search with new variant filters
  };

  // Select/Deselect all functions for Variant modal
  const selectAllVariants = () => {
    setSelectedVariants((prev) => {
      const updated = {};
      Object.keys(prev).forEach((key) => {
        updated[key] = true;
      });
      return updated;
    });
  };

  const deselectAllVariants = () => {
    setSelectedVariants((prev) => {
      const updated = {};
      Object.keys(prev).forEach((key) => {
        updated[key] = false;
      });
      return updated;
    });
  };

  // Regulation filter functions
  const handleRegulationToggle = (regulation) => {
    setSelectedRegulations((prev) => ({
      ...prev,
      [regulation]: !prev[regulation],
    }));
  };

  const applyRegulationFilters = () => {
    setShowRegulationModal(false);
    handleSearch(); // Trigger search with new regulation filters
  };

  // Select/Deselect all functions for Regulation modal
  const selectAllRegulations = () => {
    setSelectedRegulations((prev) => {
      const updated = {};
      Object.keys(prev).forEach((key) => {
        updated[key] = true;
      });
      return updated;
    });
  };

  const deselectAllRegulations = () => {
    setSelectedRegulations((prev) => {
      const updated = {};
      Object.keys(prev).forEach((key) => {
        updated[key] = false;
      });
      return updated;
    });
  };

  // Format filter functions
  const handleFormatToggle = (format) => {
    setSelectedFormats((prev) => ({
      ...prev,
      [format]: !prev[format],
    }));
  };

  const applyFormatFilters = () => {
    setShowFormatModal(false);
    handleSearch(); // Trigger search with new format filters
  };

  // Select/Deselect all functions for Format modal
  const selectAllFormats = () => {
    setSelectedFormats((prev) => {
      const updated = {};
      Object.keys(prev).forEach((key) => {
        updated[key] = true;
      });
      return updated;
    });
  };

  const deselectAllFormats = () => {
    setSelectedFormats((prev) => {
      const updated = {};
      Object.keys(prev).forEach((key) => {
        updated[key] = false;
      });
      return updated;
    });
  };

  const handleTypeToggle = (type) => {
    setSelectedTypes((prev) => ({
      ...prev,
      [type]: !prev[type],
    }));
  };

  const selectAllTypes = () => {
    setSelectedTypes((prev) => {
      const updated = {};
      Object.keys(prev).forEach((key) => {
        updated[key] = true;
      });
      return updated;
    });
  };

  const deselectAllTypes = () => {
    setSelectedTypes((prev) => {
      const updated = {};
      Object.keys(prev).forEach((key) => {
        updated[key] = false;
      });
      return updated;
    });
  };

  const applyTypeFilters = () => {
    setShowTypeModal(false);
    // Trigger a new search with the selected types
    handleSearch();
  };

  const handleRarityToggle = (rarity) => {
    setSelectedRarities((prev) => ({
      ...prev,
      [rarity]: !prev[rarity],
    }));
  };

  const handleRarityTypeToggle = (type) => {
    setRarityType(type);
  };

  const selectAllRarities = () => {
    setSelectedRarities((prev) => {
      const updated = {};
      Object.keys(prev).forEach((key) => {
        updated[key] = true;
      });
      return updated;
    });
  };

  const deselectAllRarities = () => {
    setSelectedRarities((prev) => {
      const updated = {};
      Object.keys(prev).forEach((key) => {
        updated[key] = false;
      });
      return updated;
    });
  };

  const applyRarityFilters = () => {
    setShowRarityModal(false);
    // Trigger a new search with the selected rarities
    handleSearch();
  };

  // Touch handlers for swipe-down to close modals
  const handleTouchStart = (e) => {
    setTouchEnd(null);
    setTouchStart(e.targetTouches[0].clientY);
  };

  const handleTouchMove = (e) => {
    setTouchEnd(e.targetTouches[0].clientY);
  };

  const handleTouchEnd = () => {
    if (!touchStart || !touchEnd) return;

    const distance = touchStart - touchEnd;
    const isDownSwipe = distance < -50; // Swipe down (touchStart > touchEnd)

    if (isDownSwipe) {
      // Close any open modal
      if (showSortModal) setShowSortModal(false);
      if (showQuickFiltersModal) setShowQuickFiltersModal(false);
      if (showLanguageModal) setShowLanguageModal(false);
      if (showConditionModal) setShowConditionModal(false);
      if (showProductsModal) setShowProductsModal(false);
      if (showEnergyModal) setShowEnergyModal(false);
      if (showTypeModal) setShowTypeModal(false);
      if (showRarityModal) setShowRarityModal(false);
      if (showVariantModal) setShowVariantModal(false);
      if (showRegulationModal) setShowRegulationModal(false);
      if (showFormatModal) setShowFormatModal(false);
    }
  };

  const handleKeyPress = (e) => {
    if (e.key === "Enter") {
      // Auto-close keyboard on mobile after search
      if (document.activeElement && document.activeElement.blur) {
        document.activeElement.blur();
      }
      handleSearch();
    }
  };

  // Handle search input change
  const handleSearchInputChange = (e) => {
    setSearchQuery(e.target.value);
  };

  // Handle search tab click with scroll
  const handleSearchTabClick = () => {
    setActiveTab("search");
    setNavigationMode("none");
    scrollToTop(); // Scroll to top when navigating
    // Push state to history for back button support
    window.history.pushState({ tab: "search" }, "", window.location.href);
  };

  // Test function to debug image loading
  const testImageLoading = async () => {
    console.log("Testing image loading...");
    const testUrl = "https://images.pokemontcg.io/gym2/2.png";
    console.log("Test URL:", testUrl);

    // Test if we can load the image
    const img = new Image();
    img.onload = () => console.log("Test image loaded successfully!");
    img.onerror = (e) => console.log("Test image failed to load:", e);
    img.src = testUrl;

    // Also test the API call
    const imageUrl = await fetchCardImage("Charizard", "Gym Challenge");
    console.log("API returned:", imageUrl);
  };

  // Pokémon TCG API integration
  const fetchCardImage = async (cardName, setName) => {
    try {
      // Add timeout to prevent hanging
      const controller = new AbortController();
      const timeoutId = setTimeout(() => controller.abort(), 5000); // 5 second timeout

      // First try searching by name only
      let searchQuery = `name:"${cardName}"`;
      let response = await fetch(
        `https://api.pokemontcg.io/v2/cards?q=${encodeURIComponent(
          searchQuery
        )}&pageSize=1`,
        {
          signal: controller.signal,
        }
      );
      let data = await response.json();

      // If no results, try with set name
      if (!data.data || data.data.length === 0) {
        searchQuery = `name:"${cardName}" set.name:"${setName}"`;
        response = await fetch(
          `https://api.pokemontcg.io/v2/cards?q=${encodeURIComponent(
            searchQuery
          )}&pageSize=1`,
          {
            signal: controller.signal,
          }
        );
        data = await response.json();
      }

      clearTimeout(timeoutId);

      if (data.data && data.data.length > 0) {
        return data.data[0].images.small; // Use small image for better performance
      }
      return null;
    } catch (error) {
      return null;
    }
  };

  // Country codes for phone number
  const countryCodes = [
    { code: "US", flag: "🇺🇸", dialCode: "+1", name: "United States" },
    { code: "CA", flag: "🇨🇦", dialCode: "+1", name: "Canada" },
    { code: "GB", flag: "🇬🇧", dialCode: "+44", name: "United Kingdom" },
    { code: "AU", flag: "🇦🇺", dialCode: "+61", name: "Australia" },
    { code: "DE", flag: "🇩🇪", dialCode: "+49", name: "Germany" },
    { code: "FR", flag: "🇫🇷", dialCode: "+33", name: "France" },
    { code: "IT", flag: "🇮🇹", dialCode: "+39", name: "Italy" },
    { code: "ES", flag: "🇪🇸", dialCode: "+34", name: "Spain" },
    { code: "JP", flag: "🇯🇵", dialCode: "+81", name: "Japan" },
    { code: "CN", flag: "🇨🇳", dialCode: "+86", name: "China" },
    { code: "IN", flag: "🇮🇳", dialCode: "+91", name: "India" },
    { code: "BR", flag: "🇧🇷", dialCode: "+55", name: "Brazil" },
  ];

  const getSelectedCountry = () => {
    return (
      countryCodes.find((country) => country.code === selectedCountry) ||
      countryCodes[0]
    );
  };

  // Close dropdown when clicking outside
  const handleClickOutside = (e) => {
    if (showCountryDropdown && !e.target.closest(".country-dropdown")) {
      setShowCountryDropdown(false);
    }
    if (showCurrencyDropdown && !e.target.closest(".currency-dropdown")) {
      setShowCurrencyDropdown(false);
    }
    if (showSortDropdown && !e.target.closest(".sort-dropdown")) {
      setShowSortDropdown(false);
    }
    if (showFilterModal && !e.target.closest(".filter-modal")) {
      setShowFilterModal(false);
    }
    if (
      showCollectionCardActions &&
      !e.target.closest(".collection-card-actions")
    ) {
      setShowCollectionCardActions(false);
    }
    if (
      isCollectionMultiSelectMode &&
      !e.target.closest(".collection-card") &&
      !e.target.closest(".collection-multi-select-bar")
    ) {
      setIsCollectionMultiSelectMode(false);
      setSelectedCollectionCards(new Set());
    }
    if (showMoveToFolderModal && !e.target.closest(".move-to-folder-modal")) {
      setShowMoveToFolderModal(false);
    }
    if (showAddToDeckModal && !e.target.closest(".add-to-deck-modal")) {
      setShowAddToDeckModal(false);
    }
    if (showAddToBinderModal && !e.target.closest(".add-to-binder-modal")) {
      setShowAddToBinderModal(false);
    }
    if (showDeckDropdown && !e.target.closest(".dropdown-container")) {
      setShowDeckDropdown(false);
    }
    if (showBinderDropdown && !e.target.closest(".dropdown-container")) {
      setShowBinderDropdown(false);
    }
    // Close edit modal dropdowns when clicking outside
    if (!e.target.closest(".edit-card-modal")) {
      setShowEditConditionDropdown(false);
      setShowEditVariantDropdown(false);
      setShowEditGradeDropdown(false);
      setShowEditGradingServiceDropdown(false);
    }
  };

  // Handle collection card press and hold
  const handleCollectionCardPressStart = (e, card) => {
    // Don't prevent default on touch events to avoid passive listener issues
    if (e.type !== "touchstart") {
      e.preventDefault();
    }
    e.stopPropagation();

    console.log("Press start on card:", card.name, "isScrolling:", isScrolling);

    // Reset scrolling state when starting a new press
    setIsScrolling(false);

    // Clear any existing timer
    if (longPressTimer) {
      clearTimeout(longPressTimer);
    }

    // Store initial touch position for scroll detection
    if (e.type === "touchstart") {
      setTouchStartPosition({
        x: e.touches[0].clientX,
        y: e.touches[0].clientY,
      });
    }

    // Set a timer for long press (500ms)
    const timer = setTimeout(() => {
      // Only start multi-select if we're not scrolling
      if (!isScrolling) {
        console.log(
          "Long press detected - entering multi-select mode with card:",
          card.name
        );
        setIsCollectionMultiSelectMode(true);
        setSelectedCollectionCards(new Set([card.id]));
      } else {
        console.log("Long press cancelled - user was scrolling");
      }
      setLongPressTimer(null);
    }, 500);

    setLongPressTimer(timer);
  };

  const handleCollectionCardPressEnd = (e) => {
    // Don't prevent default on touch events to avoid passive listener issues
    if (e.type !== "touchend") {
      e.preventDefault();
    }
    e.stopPropagation();

    // Clear the long press timer if it hasn't fired yet
    if (longPressTimer) {
      clearTimeout(longPressTimer);
      setLongPressTimer(null);
    }

    // Clear scroll timeout
    if (scrollTimeout) {
      clearTimeout(scrollTimeout);
      setScrollTimeout(null);
    }

    // Reset scroll detection
    setIsScrolling(false);
    setTouchStartPosition(null);
  };

  // Handle touch move to detect scrolling
  const handleCollectionCardTouchMove = (e) => {
    if (!touchStartPosition) return;

    const touch = e.touches[0];
    const deltaX = Math.abs(touch.clientX - touchStartPosition.x);
    const deltaY = Math.abs(touch.clientY - touchStartPosition.y);

    console.log(
      "Touch move - deltaX:",
      deltaX,
      "deltaY:",
      deltaY,
      "isScrolling:",
      isScrolling
    );

    // If user moved more than 15px, consider it scrolling (increased threshold)
    if (deltaX > 15 || deltaY > 15) {
      console.log("Scrolling detected - cancelling long press");
      setIsScrolling(true);
      // Cancel the long press timer if scrolling
      if (longPressTimer) {
        clearTimeout(longPressTimer);
        setLongPressTimer(null);
      }

      // Clear any existing scroll timeout
      if (scrollTimeout) {
        clearTimeout(scrollTimeout);
      }

      // Set a timeout to reset scrolling state after 300ms of no movement (increased timeout)
      const timeout = setTimeout(() => {
        console.log("Resetting scroll state");
        setIsScrolling(false);
        setScrollTimeout(null);
      }, 300);

      setScrollTimeout(timeout);
    }
  };

  // Handle collection card click
  const handleCollectionCardClick = (e, card) => {
    // Don't prevent default on touch events to avoid passive listener issues
    if (e.type !== "touchend") {
      e.preventDefault();
    }
    e.stopPropagation();

    // Only handle click if we're not in the middle of a long press
    if (longPressTimer) {
      console.log("Click ignored - long press in progress");
      return;
    }

    // Don't handle click if we were scrolling
    if (isScrolling) {
      console.log("Click ignored - user was scrolling");
      return;
    }

    if (isCollectionMultiSelectMode) {
      // Toggle selection in multi-select mode
      const newSelected = new Set(selectedCollectionCards);
      if (newSelected.has(card.id)) {
        newSelected.delete(card.id);
        console.log("Deselected card:", card.name);
      } else {
        newSelected.add(card.id);
        console.log("Selected card:", card.name);
      }
      setSelectedCollectionCards(newSelected);

      // Exit multi-select mode if no cards selected
      if (newSelected.size === 0) {
        console.log("Exiting multi-select mode - no cards selected");
        setIsCollectionMultiSelectMode(false);
      }
    } else {
      // Check for double-tap to enter multi-select mode
      const currentTime = Date.now();
      const timeDiff = currentTime - lastTapTime;

      if (timeDiff < 500 && timeDiff > 0) {
        // Double tap detected - enter multi-select mode
        console.log(
          "Double tap detected - entering multi-select mode with card:",
          card.name
        );
        setIsCollectionMultiSelectMode(true);
        setSelectedCollectionCards(new Set([card.id]));
        setLastTapTime(0); // Reset to prevent triple-tap issues
      } else {
        // Single tap - open card profile
        console.log("Single tap - opening card profile:", card.name);
        handleCardClick(card);
        setLastTapTime(currentTime);
      }
    }
  };

  // Handle collection card long press
  const handleCollectionCardLongPress = (e, card) => {
    e.preventDefault();
    e.stopPropagation();

    // Start multi-select mode with this card
    setIsCollectionMultiSelectMode(true);
    setSelectedCollectionCards(new Set([card.id]));
  };

  // Handle collection card touch end (for mobile)
  const handleCollectionCardTouchEnd = (e, card) => {
    e.stopPropagation();

    // Only handle if we're not in the middle of a long press
    if (longPressTimer) {
      console.log("Touch end ignored - long press in progress");
      return;
    }

    // Don't handle touch end if we were scrolling
    if (isScrolling) {
      console.log("Touch end ignored - user was scrolling");
      return;
    }

    if (isCollectionMultiSelectMode) {
      // Toggle selection in multi-select mode
      const newSelected = new Set(selectedCollectionCards);
      if (newSelected.has(card.id)) {
        newSelected.delete(card.id);
        console.log("Touch deselected card:", card.name);
      } else {
        newSelected.add(card.id);
        console.log("Touch selected card:", card.name);
      }
      setSelectedCollectionCards(newSelected);

      // Exit multi-select mode if no cards selected
      if (newSelected.size === 0) {
        console.log("Exiting multi-select mode - no cards selected");
        setIsCollectionMultiSelectMode(false);
      }
    } else {
      // Normal touch - open card profile
      console.log("Normal touch - opening card profile:", card.name);
      handleCardClick(card);
    }
  };

  // Handle move to folder button click
  const handleMoveToFolder = () => {
    // Get all collections except the current one
    const currentCollection = userData?.collections?.find(
      (c) => c.id === selectedCollection
    );
    const otherCollections =
      userData?.collections?.filter((c) => c.id !== selectedCollection) || [];

    // Transform collections to folder format
    const folders = otherCollections.map((collection) => ({
      id: collection.id,
      name: collection.name,
      color: collection.color || "#605DEC", // Default to app theme color
    }));

    setAvailableFolders(folders);
    setShowMoveToFolderModal(true);
  };

  // Handle folder selection
  const handleFolderSelection = async (folderId) => {
    try {
      const cardIds = Array.from(selectedCollectionCards);
      const currentCollection = userData?.collections?.find(
        (c) => c.id === selectedCollection
      );
      const targetCollection = userData?.collections?.find(
        (c) => c.id === folderId
      );

      if (!currentCollection || !targetCollection) {
        console.error("Collection not found");
        return;
      }

      // Get the cards to move
      const cardsToMove = currentCollection.cards.filter((card) =>
        cardIds.includes(card.id)
      );

      if (cardsToMove.length === 0) {
        console.error("No cards found to move");
        return;
      }

      // Move cards from current collection to target collection
      for (const card of cardsToMove) {
        // Remove from current collection
        await userDatabase.removeCardFromCollection(
          selectedCollection,
          card.id
        );

        // Add to target collection
        await userDatabase.addCardToCollection(
          folderId,
          card.cardId, // Use the original cardId for the API
          card.condition,
          card.variant,
          card.grade,
          card.gradingService,
          card.pricePaid,
          card.notes
        );
      }

      // Refresh user data
      const updatedUserData = await userDatabase.getUserData();
      setUserData(updatedUserData);

      console.log(
        `Successfully moved ${cardsToMove.length} cards to ${targetCollection.name}`
      );

      // Close modals and reset state
      setShowMoveToFolderModal(false);
      setIsCollectionMultiSelectMode(false);
      setSelectedCollectionCards(new Set());
    } catch (error) {
      console.error("Error moving cards:", error);
      // Still close the modal even if there's an error
      setShowMoveToFolderModal(false);
      setIsCollectionMultiSelectMode(false);
      setSelectedCollectionCards(new Set());
    }
  };

  // Handle add to deck button click - fetch from API
  const handleAddToDeck = async () => {
    try {
      // Fetch decks from the API
      const response = await fetch(`${API_URL}/api/decks`, {
        headers: {
          "user-id": user?.id || "default-user",
        },
      });

      if (!response.ok) {
        throw new Error("Failed to fetch decks");
      }

      const data = await response.json();
      const decks = (data.data || []).map((deck) => ({
        id: deck.id,
        name: deck.name,
        format: deck.format,
        deck_mode: deck.deck_mode,
        cardCount: deck.total_cards || 0,
      }));

      setAvailableDecks(decks);
      setSelectedDeck(decks.length > 0 ? decks[0].name : "No Decks Available");
      setShowAddToDeckModal(true);
    } catch (error) {
      console.error("Error fetching decks:", error);
      setAvailableDecks([]);
      setSelectedDeck("No Decks Available");
      setShowAddToDeckModal(true);
    }
  };

  // Handle deck selection and add card
  const handleDeckSelection = async () => {
    if (!selectedCard) {
      console.error("No card selected");
      return;
    }

    try {
      // Find the selected deck
      const selectedDeckObj = availableDecks.find(
        (d) => d.name === selectedDeck
      );
      if (!selectedDeckObj) {
        throw new Error("Deck not found");
      }

      const deckId = selectedDeckObj.id;
      const cardId =
        selectedCard.product_id || selectedCard.cardId || selectedCard.id;

      console.log("Adding card to deck:", {
        selectedCard,
        cardId,
        deckId,
        deckQuantity,
      });

      if (!cardId) {
        console.error("Selected card:", selectedCard);
        throw new Error("Card ID not found");
      }

      // Add the card to the deck via API
      const response = await fetch(`${API_URL}/api/decks/${deckId}/cards`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "user-id": user?.id || "default-user",
        },
        body: JSON.stringify({
          card_id: cardId,
          quantity: deckQuantity,
        }),
      });

      if (!response.ok) {
        const errorData = await response.json();
        console.error("API error response:", errorData);
        throw new Error(errorData.error || "Failed to add card to deck");
      }

      console.log(
        `Successfully added ${deckQuantity} ${selectedCard.name} to ${selectedDeck}`
      );

      // Close modals and reset state
      setShowAddToDeckModal(false);
      setDeckQuantity(1);

      // Show success message or notification here if desired
    } catch (error) {
      console.error("Error adding card to deck:", error);
      alert(`Error adding card to deck: ${error.message}`);
    }
  };

  // Handle add to binder button click
  const handleAddToBinder = async () => {
    try {
      // Fetch binders from the API
      const response = await fetch(`${API_URL}/api/binders`, {
        headers: {
          "user-id": user?.id || "default-user",
        },
      });

      if (!response.ok) {
        throw new Error("Failed to fetch binders");
      }

      const data = await response.json();
      const binders = (data.data || []).map((binder) => ({
        id: binder.id,
        name: binder.name,
        pocket_config: binder.pocket_config,
      }));

      setAvailableBinders(binders);
      setSelectedBinder(
        binders.length > 0 ? binders[0].name : "No Binders Available"
      );
      setShowAddToBinderModal(true);
    } catch (error) {
      console.error("Error fetching binders:", error);
      setAvailableBinders([]);
      setSelectedBinder("No Binders Available");
      setShowAddToBinderModal(true);
    }
  };

  // Handle binder selection
  const handleBinderSelection = async (binderId) => {
    try {
      const cardIds = Array.from(selectedCollectionCards);
      const currentCollection = userData?.collections?.find(
        (c) => c.id === selectedCollection
      );
      const targetBinder = userData?.binders?.find((b) => b.id === binderId);

      if (!currentCollection || !targetBinder) {
        console.error("Collection or binder not found");
        return;
      }

      // Get the cards to add
      const cardsToAdd = currentCollection.cards.filter((card) =>
        cardIds.includes(card.id)
      );

      if (cardsToAdd.length === 0) {
        console.error("No cards found to add");
        return;
      }

      // Add cards to the selected binder
      for (const card of cardsToAdd) {
        await userDatabase.addCardToBinder(
          binderId,
          card.cardId, // Use the original cardId for the API
          card.condition,
          card.variant,
          card.grade,
          card.gradingService,
          card.pricePaid,
          card.notes
        );
      }

      // Refresh user data
      const updatedUserData = await userDatabase.getUserData();
      setUserData(updatedUserData);

      console.log(
        `Successfully added ${cardsToAdd.length} cards to ${targetBinder.name}`
      );

      // Close modals and reset state
      setShowAddToBinderModal(false);
      setIsCollectionMultiSelectMode(false);
      setSelectedCollectionCards(new Set());
    } catch (error) {
      console.error("Error adding cards to binder:", error);
      setShowAddToBinderModal(false);
      setIsCollectionMultiSelectMode(false);
      setSelectedCollectionCards(new Set());
    }
  };

  // Handle binder selection for adding a single card from card profile
  const handleBinderSelectionForCard = async () => {
    if (!selectedCard) {
      console.error("No card selected");
      return;
    }

    try {
      // Find the selected binder
      const selectedBinderObj = availableBinders.find(
        (b) => b.name === selectedBinder
      );
      if (!selectedBinderObj) {
        throw new Error("Binder not found");
      }

      const binderId = selectedBinderObj.id;
      const cardId =
        selectedCard.product_id || selectedCard.cardId || selectedCard.id;

      // First, fetch the binder to find first available slot
      const binderResponse = await fetch(`${API_URL}/api/binders/${binderId}`, {
        headers: {
          "user-id": user?.id || "default-user",
        },
      });

      if (!binderResponse.ok) {
        throw new Error("Failed to fetch binder details");
      }

      const binderData = await binderResponse.json();
      const binder = binderData.data;

      // Find first empty pocket
      let targetPageId = null;
      let targetPosition = null;

      for (const page of binder.pages) {
        const pocketCount = binder.pocket_config === "12-pocket" ? 12 : 9;
        for (let i = 0; i < pocketCount; i++) {
          if (!page.pockets[i]) {
            targetPageId = page.id;
            targetPosition = i;
            break;
          }
        }
        if (targetPageId) break;
      }

      if (!targetPageId || targetPosition === null) {
        alert("No available slots in this binder");
        return;
      }

      // Add card to the first available slot
      const response = await fetch(
        `${API_URL}/api/binders/${binderId}/pockets`,
        {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "user-id": user?.id || "default-user",
          },
          body: JSON.stringify({
            page_id: targetPageId,
            product_id: cardId,
            pocket_position: targetPosition,
            notes: "",
          }),
        }
      );

      if (!response.ok) {
        const errorData = await response.json();
        throw new Error(errorData.error || "Failed to add card to binder");
      }

      console.log(`Successfully added card to ${selectedBinder}`);

      // Close modal
      setShowAddToBinderModal(false);
    } catch (error) {
      console.error("Error adding card to binder:", error);
      alert(`Error adding card to binder: ${error.message}`);
    }
  };

  // Add event listener for clicking outside
  React.useEffect(() => {
    document.addEventListener("mousedown", handleClickOutside);
    return () => {
      document.removeEventListener("mousedown", handleClickOutside);
    };
  }, [
    showCountryDropdown,
    showCurrencyDropdown,
    showSortDropdown,
    showFilterModal,
    showCollectionCardActions,
    isCollectionMultiSelectMode,
    showMoveToFolderModal,
    showAddToDeckModal,
    showAddToBinderModal,
    showDeckDropdown,
    showBinderDropdown,
  ]);

  // Cleanup long press timer on unmount
  React.useEffect(() => {
    return () => {
      if (longPressTimer) {
        clearTimeout(longPressTimer);
      }
      if (scrollTimeout) {
        clearTimeout(scrollTimeout);
      }
    };
  }, [longPressTimer, scrollTimeout]);

  // Load card images on component mount - now using real data
  React.useEffect(() => {
    const loadCardImages = () => {
      // Load images for both topMovers and trendingCards from real data
      const allCards = [...topMoversData, ...trendingCardsData];

      const imageMap = {};
      allCards.forEach((card) => {
        if (card.images?.small) {
          imageMap[card.id] = card.images.small;
        }
      });

      setCardImages((prev) => ({ ...prev, ...imageMap }));
    };

    loadCardImages();
  }, [topMoversData, trendingCardsData]);

  // Onboarding navigation handlers
  const handleNextOnboarding = () => {
    if (currentOnboardingStep < 2) {
      setCurrentOnboardingStep(currentOnboardingStep + 1);
    } else {
      // Complete onboarding
      setIsFirstTimeUser(false);
      setCurrentScreen("main-app"); // You can change this to your main app screen
    }
  };

  const handlePreviousOnboarding = () => {
    if (currentOnboardingStep > 0) {
      setCurrentOnboardingStep(currentOnboardingStep - 1);
    }
  };

  const handleSkipOnboarding = () => {
    setIsFirstTimeUser(false);
    setCurrentScreen("main-app"); // You can change this to your main app screen
  };

  // Card scanning handlers
  const handleCardScan = async () => {
    try {
      console.log("Scanner button clicked, setting showScanner to true");
      setShowScanner(true);
      // In a real app, this would:
      // 1. Access device camera
      // 2. Capture card image
      // 3. Send to TCGPlayer API for recognition
      // 4. Get card data from Pokemon TCG API
      // 5. Add to collection
    } catch (error) {
      console.error("Card scanning error:", error);
      setShowScanner(false);
      alert("Card scanning failed. Please try again.");
    }
  };

  // Scanner interface handlers
  const handleManualScan = async () => {
    try {
      // Simulate card scanning and recognition
      console.log("Manual scan triggered - simulating card recognition...");

      // Simulate API call delay
      await new Promise((resolve) => setTimeout(resolve, 1500));

      // Real card recognition - use actual collection data
      const allCards =
        userData?.collections?.flatMap(
          (collection) => collection.cards || []
        ) || [];
      if (allCards.length === 0) {
        throw new Error("No cards in collection to scan");
      }

      // For now, randomly select from actual collection cards
      // In a real app, this would use computer vision to identify the card
      const recognizedCard =
        allCards[Math.floor(Math.random() * allCards.length)];

      // Add card to collection
      const newCard = {
        ...recognizedCard,
        condition: selectedModalCondition || "Near Mint",
        folder: selectedFolder || "Collection",
        dateAdded: new Date().toISOString(),
        quantity: 1,
      };

      // Add card to collection using userDatabase
      const success = userDatabase.addCardToCollection(
        selectedCollection || "pokemon-tcg-collection",
        newCard,
        1,
        "Near Mint",
        "Normal",
        null,
        null,
        newCard.price,
        "Scanned card"
      );

      if (success) {
        // Update user data
        const updatedData = userDatabase.getUserData();
        setUserData(updatedData);

        // Track scan event
        eventTracker.trackScanPerformed([recognizedCard], "manual");
      } else {
        console.error("Failed to add card to collection");
      }

      // Set the scanned card and show confirmation ONLY after card is identified
      setScannedCard(newCard);
      setShowScanConfirm(true);
      setIsScanConfirmFading(false);

      // Start fade animation after showing success for longer
      setTimeout(() => {
        setIsScanConfirmFading(true);
      }, 1500);

      // Auto-close after fade completes (1500ms display + 500ms fade = 2000ms total)
      setTimeout(() => {
        setShowScanConfirm(false);
        setIsScanConfirmFading(false);
        setScannedCard(null);
      }, 2000);
    } catch (error) {
      console.error("Error during card scanning:", error);
      // Show error confirmation ONLY after error occurs
      setScannedCard({
        name: "Scan Error",
        set: "Unknown",
        rarity: "Error",
        number: "000/000",
        price: 0,
        imageUrl: null,
      });
      setShowScanConfirm(true);
      setIsScanConfirmFading(false);

      // Still show and fade the confirmation
      setTimeout(() => {
        setIsScanConfirmFading(true);
      }, 1500);

      setTimeout(() => {
        setShowScanConfirm(false);
        setIsScanConfirmFading(false);
        setScannedCard(null);
      }, 2000);
    }
  };

  // Ref for the card profile modal
  const cardProfileModalRef = React.useRef(null);

  // Ref for the search results scrollable container
  const searchResultsContainerRef = React.useRef(null);

  // Layout effect to reset scroll position immediately when card profile is shown
  React.useLayoutEffect(() => {
    if (showCardProfile) {
      // Force immediate scroll reset before browser paints - only on modal open
      window.scrollTo({ top: 0, left: 0, behavior: "instant" });
      document.documentElement.scrollTop = 0;
      document.body.scrollTop = 0;

      // Reset modal scroll position using ref - only on modal open
      if (cardProfileModalRef.current) {
        cardProfileModalRef.current.scrollTop = 0;
        cardProfileModalRef.current.scrollIntoView({
          behavior: "instant",
          block: "start",
        });
      }
    }
  }, [showCardProfile]);

  // Effect to reset scroll position when card profile is shown - only on initial open
  React.useEffect(() => {
    if (showCardProfile) {
      // Reset search results container scroll position only on modal open
      if (searchResultsContainerRef.current) {
        searchResultsContainerRef.current.scrollTop = 0;
      }
    }
  }, [showCardProfile]);

  // Card profile handlers
  const handleCardClick = async (card) => {
    console.error("🃏🃏🃏 [NAV DEBUG] CARD CLICKED - handleCardClick called");
    console.log("🃏 [NAV DEBUG] handleCardClick called");
    console.log("🃏 [NAV DEBUG] Current state before card click:", {
      showSetPage,
      selectedSet,
      setCardsDataLength: setCardsData?.length || 0,
      selectedSetData: selectedSetData ? "exists" : "null",
      cardName: card.name || card.cleanName || "unknown",
    });

    // Simple scroll reset - only reset main window scroll
    window.scrollTo({ top: 0, left: 0, behavior: "instant" });

    // Reset search results container scroll position
    if (searchResultsContainerRef.current) {
      searchResultsContainerRef.current.scrollTop = 0;
    }

    // Show the modal immediately
    setShowCardProfile(true);

    // Initialize chart loading state for the new card
    setChartLoading(true);
    setChartError(null);

    // Prepare history state data
    const historyStateData = {
      cardProfile: true,
      cardId: card.id,
      fromSetPage: showSetPage, // Track if we came from a set page
      previousSetId: selectedSet, // Track the set ID if applicable
      previousSetData: selectedSetData, // Preserve the set data to restore card list
      previousSetCardsData: showSetPage ? setCardsData : null, // Preserve the card list data
    };

    console.log("🃏 [NAV DEBUG] Pushing history state:", {
      ...historyStateData,
      previousSetCardsDataLength:
        historyStateData.previousSetCardsData?.length || 0,
      previousSetDataSummary: historyStateData.previousSetData
        ? {
            name: historyStateData.previousSetData.name,
            cards_total: historyStateData.previousSetData.cards_total,
          }
        : null,
    });

    // Push state to history for back button support, including where we came from
    window.history.pushState(historyStateData, "", window.location.href);

    console.log("🃏 [NAV DEBUG] History state pushed. After push state:", {
      historyState: window.history.state,
      showCardProfile: true,
      showSetPage, // Should still be true if coming from set page
      selectedSet,
    });

    // If the card has a cardId or id, fetch the complete data from the API
    const cardIdentifier = card.cardId || card.id;
    if (cardIdentifier) {
      try {
        // Convert cardIdentifier to string and extract the base card ID from the cardId (remove timestamp parts)
        const cardIdStr = String(cardIdentifier);
        const baseCardId = cardIdStr.includes("-")
          ? cardIdStr.split("-").slice(0, 2).join("-")
          : cardIdStr;

        // Try to fetch the card data
        console.log("Main App - Fetching card data for ID:", baseCardId);
        const response = await fetch(
          `${API_URL}/api/cards/${baseCardId}?t=${Date.now()}`
        );
        if (response.ok) {
          const result = await response.json();
          console.log("Main App - API response:", result);
          let cardData = result.data;

          // Parse JSON fields that might be strings
          const parseJSONField = (field) => {
            if (!field) return field;
            if (typeof field === "object") return field;
            if (typeof field === "string") {
              try {
                let parsed = JSON.parse(field);
                // Handle double-encoded JSON
                if (typeof parsed === "string") {
                  parsed = JSON.parse(parsed);
                }
                return parsed;
              } catch {
                return field;
              }
            }
            return field;
          };

          cardData = {
            ...cardData,
            abilities: cardData.abilities || [],
            attacks: cardData.attacks || [],
            weaknesses: parseJSONField(cardData.weaknesses) || [],
            resistances: parseJSONField(cardData.resistances) || [],
            retreat_cost: parseJSONField(cardData.retreat_cost) || [],
            types: parseJSONField(cardData.types) || [],
            images: parseJSONField(cardData.images) || {},
          };

          // Debug logging for attacks
          console.log("Main App - Card data attacks:", cardData.attacks);
          console.log("Main App - Card data abilities:", cardData.abilities);

          // Set the card data first (without image) for immediate display
          setSelectedCard(cardData);

          // Fetch image URL from Pokémon TCG API asynchronously
          // Don't await this - let it update the card when ready
          fetchCardImage(cardData.name, cardData.set_name)
            .then((imageUrl) => {
              if (imageUrl) {
                setSelectedCard((prevCard) => ({
                  ...prevCard,
                  imageUrl: imageUrl,
                  images: {
                    small: imageUrl,
                    large: imageUrl,
                  },
                }));
              }
            })
            .catch((imageError) => {
              console.warn("Error fetching card image:", imageError);
            });
        } else {
          setSelectedCard(card);
        }
      } catch (error) {
        console.error("Error fetching card data:", error);
        setSelectedCard(card);
      }
    } else {
      // Use the provided card data if no cardId
      setSelectedCard(card);
    }
  };

  // Handle native share functionality
  const handleShare = async () => {
    if (!selectedCard) return;

    const shareData = {
      title: `${selectedCard.name} - Pokemon Card`,
      text: `Check out this ${selectedCard.name} card from ${
        selectedCard.set_name ||
        selectedCard.set?.name ||
        selectedCard.set ||
        "Pokemon TCG"
      }!`,
      url: window.location.href,
    };

    try {
      // Check if Web Share API is supported
      if (
        navigator.share &&
        navigator.canShare &&
        navigator.canShare(shareData)
      ) {
        await navigator.share(shareData);
      } else {
        // Fallback: copy to clipboard
        await navigator.clipboard.writeText(shareData.url);
        // You could add a toast notification here to inform the user
        console.log("Link copied to clipboard!");
      }
    } catch (error) {
      console.error("Error sharing:", error);
      // Fallback: copy to clipboard
      try {
        await navigator.clipboard.writeText(shareData.url);
        console.log("Link copied to clipboard!");
      } catch (clipboardError) {
        console.error("Failed to copy to clipboard:", clipboardError);
      }
    }
  };

  // Handle artist search functionality
  const handleArtistSearch = async (artistName) => {
    if (!artistName) return;

    try {
      setLoading(true);

      // Combine all available card data sources
      const allCards = [...topMoversData, ...trendingCardsData];

      // Filter cards by artist name
      const artistCards = allCards.filter(
        (card) =>
          card.artist &&
          card.artist.toLowerCase().includes(artistName.toLowerCase())
      );

      // Remove duplicates based on card name and set
      const uniqueArtistCards = artistCards.filter(
        (card, index, self) =>
          index ===
          self.findIndex((c) => c.name === card.name && c.set === card.set)
      );

      // Set search results
      setOriginalSearchResults(uniqueArtistCards);
      setFilteredSearchResults(uniqueArtistCards);
      setShowSearchResults(true);
      setSearchQuery(artistName); // Set the search query to show what we're searching for

      // Load images for the results
      loadSearchResultImages(uniqueArtistCards);

      // Close card profile and switch to search tab
      setShowCardProfile(false);
      setActiveTab("search");
      setNavigationMode("search");
      scrollToTop(); // Scroll to top when navigating
    } catch (error) {
      console.error("Error searching for artist:", error);
    } finally {
      setLoading(false);
    }
  };

  // Handle clear search functionality
  const handleClearSearch = () => {
    // Clear search query
    setSearchQuery("");

    // Reset search results to show trending cards
    setShowSearchResults(false);
    setFilteredSearchResults([]);
    setOriginalSearchResults([]);

    // Reset sort option to default
    setSortOption("trending");

    // Clear any active filters
    setQuickFilters({
      owned: false,
      missing: false,
      duplicates: false,
      wishlist: false,
    });

    // Reset language selection
    setSelectedLanguages({
      english: true,
      japanese: false,
      chinese: false,
      korean: false,
      german: false,
      spanish: false,
      french: false,
      italian: false,
    });

    // Reset other filter states
    setSelectedConditions({});
    setSelectedProducts({});
    setSelectedEnergies({});
    setSelectedTypes({});
    setSelectedRarities({});
    setSelectedVariants({});
    setSelectedRegulations({});
    setSelectedFormats({});
  };

  // Handle viewing my cards in collection
  const handleViewMyCards = () => {
    if (!selectedCard || !userData || !userData.collections) return;

    // Find all entries of this card in user's collections
    const entries = [];
    const searchCardId = String(
      selectedCard.cardId || selectedCard.id || selectedCard.product_id || ""
    );

    userData.collections.forEach((collection) => {
      if (collection.cards && collection.cards.length > 0) {
        collection.cards.forEach((card) => {
          const baseCardId = String(card.cardId || card.id || "");
          const searchBaseCardId = String(searchCardId);

          // Extract the base card ID from the full ID (remove timestamp part)
          const cardBaseId = baseCardId.includes("-")
            ? baseCardId.split("-").slice(0, 2).join("-")
            : baseCardId;
          const searchBaseId = searchBaseCardId.includes("-")
            ? searchBaseCardId.split("-").slice(0, 2).join("-")
            : searchBaseCardId;

          if (cardBaseId === searchBaseId || baseCardId === searchBaseCardId) {
            entries.push({
              ...card,
              collectionName: collection.name,
              collectionId: collection.id,
            });
          }
        });
      }
    });

    console.log("View My Cards - Found entries:", {
      searchCardId,
      entriesCount: entries.length,
      totalQuantity: entries.reduce(
        (sum, entry) => sum + (entry.quantity || 0),
        0
      ),
    });

    setMyCardEntries(entries);
    setSelectedEntries(new Set());
    setIsMultiSelectMode(false);
    setShowViewMyCardsModal(true);
    setShowCardMenu(false);
  };

  // Handle multi-select toggle
  const toggleMultiSelect = () => {
    setIsMultiSelectMode(!isMultiSelectMode);
    setSelectedEntries(new Set());
  };

  // Handle entry selection
  const toggleEntrySelection = (entryId) => {
    const newSelected = new Set(selectedEntries);
    if (newSelected.has(entryId)) {
      newSelected.delete(entryId);
    } else {
      newSelected.add(entryId);
    }
    setSelectedEntries(newSelected);
  };

  // Handle select all
  const selectAllEntries = () => {
    const allEntryIds = myCardEntries.map((entry) => entry.id);
    setSelectedEntries(new Set(allEntryIds));
  };

  // Handle deselect all
  const deselectAllEntries = () => {
    setSelectedEntries(new Set());
  };

  // Handle bulk remove
  const handleBulkRemove = () => {
    if (selectedEntries.size === 0) return;

    const entriesToRemove = myCardEntries.filter((entry) =>
      selectedEntries.has(entry.id)
    );
    const totalQuantity = entriesToRemove.reduce(
      (sum, entry) => sum + (entry.quantity || 0),
      0
    );

    if (
      confirm(
        `Remove ${selectedEntries.size} entries (${totalQuantity} cards) from your collection?`
      )
    ) {
      let successCount = 0;
      entriesToRemove.forEach((entry) => {
        const success = userDatabase.removeCardFromCollection(
          entry.collectionId,
          entry.id,
          entry.quantity || 1
        );
        if (success) successCount++;
      });

      if (successCount > 0) {
        // Refresh data
        const updatedUserData = userDatabase.getUserData();
        setUserData({ ...updatedUserData });
        setRecentActivityData([...(updatedUserData.recentActivity || [])]);
        setDisplayedActivity([
          ...(updatedUserData.recentActivity || []).slice(0, 3),
        ]);

        // Refresh the entries list
        const updatedEntries = myCardEntries.filter(
          (entry) => !selectedEntries.has(entry.id)
        );
        setMyCardEntries(updatedEntries);
        setSelectedEntries(new Set());

        // Show notification
        setCollectionNotificationMessage(
          `Removed ${successCount} entries from collection`
        );
        setShowCollectionNotification(true);
        setTimeout(() => {
          setShowCollectionNotification(false);
        }, 3000);
      }
    }
  };

  // Handle click outside to close swipe actions
  const handleSwipeClickOutside = (e) => {
    if (swipedEntryId && !e.target.closest(".swipe-actions")) {
      setSwipedEntryId(null);
    }
  };

  // Add click-outside listener for swipe actions
  useEffect(() => {
    if (swipedEntryId) {
      document.addEventListener("click", handleSwipeClickOutside);
      return () =>
        document.removeEventListener("click", handleSwipeClickOutside);
    }
  }, [swipedEntryId]);

  // Handle press and hold for entry
  const handleEntryPressStart = (entryId) => {
    const timer = setTimeout(() => {
      if (!isMultiSelectMode) {
        // Enter multi-select mode on press and hold
        setIsMultiSelectMode(true);
        setSelectedEntries(new Set([entryId]));
      } else {
        // Toggle selection in multi-select mode
        toggleEntrySelection(entryId);
      }
    }, 500); // 500ms press and hold
    setPressTimer(timer);
  };

  const handleEntryPressEnd = () => {
    if (pressTimer) {
      clearTimeout(pressTimer);
      setPressTimer(null);
    }
  };

  // Handle swipe gestures
  const handleEntrySwipe = (entryId, direction) => {
    if (direction === "right" && !isMultiSelectMode) {
      setSwipedEntryId(entryId);
    }
  };

  // Touch swipe detection
  const handleEntryTouchStart = (e, entryId) => {
    const touch = e.touches[0];
    setTouchStartPos({ x: touch.clientX, y: touch.clientY, entryId });
    handleEntryPressStart(entryId);
  };

  const handleEntryTouchEnd = (e, entryId) => {
    if (!touchStartPos) return;

    const touch = e.changedTouches[0];
    const deltaX = touch.clientX - touchStartPos.x;
    const deltaY = touch.clientY - touchStartPos.y;

    // Check if it's a horizontal swipe (more horizontal than vertical movement)
    if (Math.abs(deltaX) > Math.abs(deltaY) && Math.abs(deltaX) > 30) {
      handleEntrySwipe(entryId, deltaX > 0 ? "right" : "left");
    }

    setTouchStartPos(null);
    handleEntryPressEnd();
  };

  // Mouse swipe detection
  const handleEntryMouseDown = (e, entryId) => {
    setMouseStartPos({ x: e.clientX, y: e.clientY, entryId });
    handleEntryPressStart(entryId);
  };

  const handleEntryMouseUp = (e, entryId) => {
    if (!mouseStartPos) return;

    const deltaX = e.clientX - mouseStartPos.x;
    const deltaY = e.clientY - mouseStartPos.y;

    // Check if it's a horizontal swipe (more horizontal than vertical movement)
    if (Math.abs(deltaX) > Math.abs(deltaY) && Math.abs(deltaX) > 30) {
      handleEntrySwipe(entryId, deltaX > 0 ? "right" : "left");
    }

    setMouseStartPos(null);
    handleEntryPressEnd();
  };

  const handleRemoveEntry = (entry) => {
    setSwipedEntryId(null);
    setPressedEntryId(null);

    if (
      confirm(
        `Remove ${entry.quantity || 1} ${entry.name} from ${
          entry.collectionName
        }?`
      )
    ) {
      const success = userDatabase.removeCardFromCollection(
        entry.collectionId,
        entry.id,
        entry.quantity || 1
      );
      if (success) {
        // Refresh data
        const updatedUserData = userDatabase.getUserData();
        setUserData({ ...updatedUserData });
        setRecentActivityData([...(updatedUserData.recentActivity || [])]);
        setDisplayedActivity([
          ...(updatedUserData.recentActivity || []).slice(0, 3),
        ]);

        // Refresh the entries list
        const updatedEntries = myCardEntries.filter((e) => e.id !== entry.id);
        setMyCardEntries(updatedEntries);

        // Show notification
        setCollectionNotificationMessage(
          `Removed ${entry.name} from ${entry.collectionName}`
        );
        setShowCollectionNotification(true);
        setTimeout(() => {
          setShowCollectionNotification(false);
        }, 3000);
      }
    }
  };

  // Handle opening Add to Collection modal
  const handleAddToCollection = (card) => {
    // First close any open modals
    setShowCardProfileModal(false);
    setShowSearchResultsModal(false);
    setShowAddToCollectionModal(false);

    // Small delay to ensure modal closes and resets
    setTimeout(() => {
      // Reset form to defaults
      setSelectedCollectionForAdd("pokemon-collection");
      setAddQuantity(1);
      setSelectedVariant("Normal");
      setAddCardCondition("Near Mint");
      setIsGraded(false);
      setSelectedGradingService("PSA");
      setSelectedGrade("10");
      setAddNote("");

      // Reset dropdown states
      setShowCollectionDropdown(false);
      setShowVariantDropdown(false);
      setShowConditionDropdown(false);
      setShowGradingServiceDropdown(false);
      setShowGradeDropdown(false);

      // Determine which modal to open based on current page
      // Don't open modal if we're on the set page (use quick add instead)
      if (showSetPage) {
        // Quick add directly without opening modal
        const cardData = {
          id: card.id || card.product_id || card.cardId,
          cardId: card.id || card.product_id || card.cardId,
          name: card.cleanName || card.name,
          set_name:
            card.set_name ||
            selectedSetData?.name ||
            selectedSet ||
            "Unknown Set",
          rarity: card.rarity || card.ext_rarity || "Unknown",
          number: card.formattedNumber || card.ext_number || "000/000",
          imageUrl: card.image_url || card.imageUrl,
          images: card.images,
          price: card.current_value || card.market_price || 0,
          current_value: card.current_value || card.market_price || 0,
        };

        userDatabase.addCardToCollection(
          "pokemon-collection",
          cardData,
          1,
          "Near Mint",
          "Normal",
          null,
          null,
          null,
          ""
        );

        // Update user data state
        const updatedData = userDatabase.getUserData();
        setUserData(updatedData);
        return; // Don't open modal
      } else if (showCardProfile) {
        setCardToAddFromProfile(card);
        setShowCardProfileModal(true);
      } else if (
        showSearchResults ||
        activeTab === "cards" ||
        activeTab === "search"
      ) {
        setCardToAddFromSearch(card);
        setShowSearchResultsModal(true);
      } else {
        // Fallback to original behavior
        setCardToAdd(card);
        setShowAddToCollectionModal(true);
      }
    }, 50);
  };

  // Get total quantity of a card in user's collection
  const getCardQuantityInCollection = (cardId) => {
    // Always get fresh data from userDatabase to ensure we have the latest state
    const freshUserData = userDatabase.getUserData();

    if (!freshUserData || !freshUserData.collections) return 0;

    let totalQuantity = 0;
    freshUserData.collections.forEach((collection) => {
      if (collection.cards && collection.cards.length > 0) {
        collection.cards.forEach((card) => {
          // Check if this card matches the base cardId (before the timestamp)
          const baseCardId = card.cardId || card.id;
          const searchBaseCardId = cardId;

          // Convert to strings and extract the base card ID from the full ID (remove timestamp part)
          const cardBaseId = String(baseCardId).includes("-")
            ? String(baseCardId).split("-").slice(0, 2).join("-")
            : String(baseCardId);
          const searchBaseId = String(searchBaseCardId).includes("-")
            ? String(searchBaseCardId).split("-").slice(0, 2).join("-")
            : String(searchBaseCardId);

          if (cardBaseId === searchBaseId || baseCardId === searchBaseCardId) {
            totalQuantity += card.quantity || 0;
          }
        });
      }
    });

    return totalQuantity;
  };

  // Calculate dynamic price based on variant, condition, and grade
  const calculateDynamicPrice = (card) => {
    if (!card) return 0;

    // Base price from the card
    let basePrice =
      card.price ||
      card.currentValue ||
      card.tcgplayer?.prices?.holofoil?.market ||
      card.tcgplayer?.prices?.normal?.market ||
      card.tcgplayer?.prices?.reverseHolofoil?.market ||
      card.tcgplayer?.prices?.firstEditionHolofoil?.market ||
      0;

    // Variant multipliers
    const variantMultipliers = {
      Normal: 1.0,
      Holo: 1.5,
      "Reverse Holo": 1.2,
      "1st Edition": 3.0,
      Shadowless: 2.5,
      Unlimited: 1.0,
    };

    // Condition multipliers (for raw cards)
    const conditionMultipliers = {
      "Near Mint": 1.0,
      "Lightly Played": 0.8,
      "Moderately Played": 0.6,
      "Heavily Played": 0.4,
      Damaged: 0.2,
    };

    // Grade multipliers (for graded cards)
    const gradeMultipliers = {
      10: 2.0,
      9.5: 1.8,
      9: 1.5,
      8.5: 1.3,
      8: 1.1,
      7.5: 0.9,
      7: 0.8,
      6.5: 0.7,
      6: 0.6,
      5.5: 0.5,
      5: 0.4,
    };

    // Grading service multipliers
    const serviceMultipliers = {
      PSA: 1.0,
      BGS: 1.1,
      CGC: 0.9,
      TAG: 0.8,
      ACE: 0.7,
    };

    // Apply variant multiplier
    let adjustedPrice =
      basePrice * (variantMultipliers[selectedVariant] || 1.0);

    // Apply condition or grade multiplier
    if (isGraded) {
      // For graded cards, apply grade and service multipliers
      adjustedPrice *= gradeMultipliers[selectedGrade] || 1.0;
      adjustedPrice *= serviceMultipliers[selectedGradingService] || 1.0;
    } else {
      // For raw cards, apply condition multiplier
      adjustedPrice *= conditionMultipliers[addCardCondition] || 1.0;
    }

    return Math.max(0.01, Math.round(adjustedPrice * 100) / 100); // Round to 2 decimal places, ensure positive
  };

  // Handle clicking on set information to navigate to set page
  const handleSetClick = (setName) => {
    console.log("Navigating to set page for:", setName);
    setSelectedSet(setName);
    setShowSetPage(true);
  };

  // Handle clicking on set with full set data
  const handleSetClickWithData = (setData) => {
    console.log("📋 [NAV DEBUG] handleSetClickWithData called");
    console.log("📋 [NAV DEBUG] Set data:", {
      id: setData.id,
      group_id: setData.group_id,
      name: setData.name,
      cards_total: setData.cards_total,
    });
    const setId = setData.id || setData.group_id || setData.name;
    const cacheKey = `set_cards_cache_${setId}`;
    console.log("📋 [NAV DEBUG] Opening set:", setId);

    // Check cache IMMEDIATELY and synchronously before any state updates
    const cached = localStorage.getItem(cacheKey);
    if (cached) {
      try {
        const { data, timestamp } = JSON.parse(cached);
        const CACHE_TTL = 10 * 60 * 1000; // 10 minutes
        if (Date.now() - timestamp < CACHE_TTL) {
          // Load from cache immediately - no delay
          setSetCardsData(data.cards || []);
          setLoadingSetCards(false);
          if (data.setDetails) {
            setSelectedSetData({
              ...setData,
              ...data.setDetails,
              release_date:
                data.setDetails.release_date ||
                data.setDetails.published_on ||
                setData.release_date,
            });
          } else {
            setSelectedSetData(setData);
          }
          setSelectedSet(setId);
          setShowSetPage(true);
          console.log("📋 [NAV DEBUG] Set page opened from cache:", {
            setId,
            cardsLoaded: (data.cards || []).length,
            showSetPage: true,
          });
          // Refresh in background
          setTimeout(() => {
            // Trigger useEffect to refresh
            setSelectedSet(setId);
          }, 0);
          return;
        }
      } catch (e) {
        // Invalid cache, continue with normal flow
      }
    }

    // No cache or expired - show loading and fetch
    console.log("📋 [NAV DEBUG] No cache found, loading set from API");
    setSetCardsData([]);
    setLoadingSetCards(true);
    setSelectedSet(setId);
    setSelectedSetData(setData);
    setShowSetPage(true);
    console.log("📋 [NAV DEBUG] Set page state set:", {
      setId,
      showSetPage: true,
      loading: true,
    });
  };

  // Handle note functionality
  const handleNoteClick = () => {
    console.log("Note button clicked!");
    console.log("selectedCard:", selectedCard);
    console.log("showNoteModal before:", showNoteModal);
    if (selectedCard) {
      // Load existing note if available
      setCardNote(selectedCard.note || "");
      setShowNoteModal(true);
      console.log("Note modal should be opening...");
      console.log("showNoteModal after setShowNoteModal(true):", showNoteModal);
    } else {
      console.log("No selectedCard found");
    }
  };

  const handleSaveNote = () => {
    if (selectedCard) {
      // Update the card with the new note
      selectedCard.note = cardNote;
      console.log("Note saved for card:", selectedCard.name, "Note:", cardNote);
      setShowNoteModal(false);
    }
  };

  const handleDeleteNote = () => {
    if (selectedCard) {
      selectedCard.note = "";
      setCardNote("");
      console.log("Note deleted for card:", selectedCard.name);
      setShowNoteModal(false);
    }
  };

  // Handle wishlist toggle
  const handleWishlistToggle = async (cardId) => {
    if (!user?.id) {
      alert("Please log in to manage your wishlist");
      return;
    }

    // Validate cardId
    if (!cardId) {
      console.error("handleWishlistToggle: cardId is undefined or null");
      alert("Error: Card ID is missing. Please try again.");
      return;
    }

    const isCurrentlyWishlisted = wishlist.has(cardId);

    try {
      if (isCurrentlyWishlisted) {
        // Remove from wishlist
        const response = await fetch(`${API_URL}/api/wishlist/card/${cardId}`, {
          method: "DELETE",
          headers: {
            "x-user-id": user.id,
          },
        });

        if (!response.ok) throw new Error("Failed to remove from wishlist");

        setWishlist((prev) => {
          const newWishlist = new Set(prev);
          newWishlist.delete(cardId);
          return newWishlist;
        });
        // Also remove from wishlistItems
        setWishlistItems((prev) =>
          prev.filter((item) => item.cardId !== cardId)
        );
        setWishlistNotificationMessage("Removed from wishlist");
      } else {
        // Add to wishlist
        console.log("🛒 [WISHLIST] Adding card to wishlist:", {
          cardId,
          userId: user.id,
          cardIdType: typeof cardId,
          userIdType: typeof user.id,
          selectedCard: selectedCard,
        });

        const response = await fetch(`${API_URL}/api/wishlist`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "x-user-id": String(user.id),
          },
          body: JSON.stringify({
            cardId: String(cardId),
            priority: "Medium",
          }),
        });

        console.log(
          "🛒 [WISHLIST] Response status:",
          response.status,
          response.statusText
        );

        if (!response.ok) {
          let error;
          try {
            error = await response.json();
          } catch (e) {
            error = {
              error: `HTTP ${response.status}: ${response.statusText}`,
            };
          }

          console.error("❌ [WISHLIST] Error response:", error);

          if (error.error?.includes("already in your collection")) {
            alert("This card is already in your collection");
            return;
          }
          if (error.error?.includes("already in wishlist")) {
            alert("This card is already in your wishlist");
            return;
          }

          const errorMessage = error.details
            ? `${error.error}: ${error.details}`
            : error.error || "Failed to add to wishlist";
          throw new Error(errorMessage);
        }

        setWishlist((prev) => new Set(prev).add(cardId));

        // Reload wishlist items to get full card data for the new item
        // This ensures the showcase tab shows the complete card information
        const reloadResponse = await fetch(
          `${API_URL}/api/wishlist?limit=1000`,
          {
            headers: {
              "x-user-id": String(user.id),
            },
          }
        );
        if (reloadResponse.ok) {
          const reloadResult = await reloadResponse.json();
          if (reloadResult.success && reloadResult.data) {
            setWishlistItems(reloadResult.data);
          }
        }

        setWishlistNotificationMessage("Added to wishlist");
      }

      // Show notification
      setShowWishlistNotification(true);

      // Auto-hide notification after 3 seconds
      setTimeout(() => {
        setShowWishlistNotification(false);
      }, 3000);
    } catch (error) {
      console.error("Error toggling wishlist:", error);
      alert(error.message || "Failed to update wishlist. Please try again.");
    }
  };

  // Load wishlist on mount
  useEffect(() => {
    const loadWishlist = async () => {
      if (!user?.id) {
        // If not authenticated, use empty wishlist
        setWishlist(new Set());
        setWishlistItems([]);
        return;
      }

      try {
        const response = await fetch(`${API_URL}/api/wishlist?limit=1000`, {
          headers: {
            "x-user-id": String(user.id),
          },
        });

        if (response.ok) {
          const result = await response.json();
          if (result.success && result.data) {
            const wishlistSet = new Set(result.data.map((item) => item.cardId));
            setWishlist(wishlistSet);
            // Also store full wishlist items for display in showcase tab
            setWishlistItems(result.data);
          } else {
            // Empty wishlist if no data
            setWishlist(new Set());
            setWishlistItems([]);
          }
        } else {
          // If API fails, use empty wishlist (don't break the app)
          console.warn("Failed to load wishlist, using empty wishlist");
          setWishlist(new Set());
          setWishlistItems([]);
        }
      } catch (error) {
        console.error("Error loading wishlist:", error);
        // Use empty wishlist on error (don't break the app)
        setWishlist(new Set());
        setWishlistItems([]);
      }
    };

    loadWishlist();
  }, [user?.id]);

  // Load binders on mount
  useEffect(() => {
    const loadBinders = async () => {
      if (!user?.id) {
        setAvailableBinders([]);
        return;
      }

      try {
        const response = await fetch(`${API_URL}/api/binders`, {
          headers: {
            "user-id": String(user.id),
          },
        });

        if (response.ok) {
          const data = await response.json();
          const binders = (data.data || []).map((binder) => ({
            id: binder.id,
            name: binder.name,
            pocket_config: binder.pocket_config,
          }));
          setAvailableBinders(binders);
        } else {
          console.warn("Failed to load binders");
          setAvailableBinders([]);
        }
      } catch (error) {
        console.error("Error loading binders:", error);
        setAvailableBinders([]);
      }
    };

    loadBinders();
  }, [user?.id]);

  // Handle card menu toggle
  const handleCardMenuToggle = () => {
    setShowCardMenu(!showCardMenu);
  };

  const handlePricingMenuToggle = () => {
    setShowPricingMenu(!showPricingMenu);
  };

  // Handle pricing menu item clicks
  const handleSetPriceAlert = () => {
    setShowPricingMenu(false);
    setShowPriceAlertModal(true);
  };

  const handleEditPricePaid = () => {
    setShowPricingMenu(false);
    setShowEditPricePaidModal(true);
  };

  // Handle menu item clicks

  const handleSetCustomTag = () => {
    setShowCardMenu(false);
    setShowSetCustomTagModal(true);
  };

  const handleSendFeedback = () => {
    setShowCardMenu(false);
    setShowSendFeedbackModal(true);
  };

  // Close menu when clicking outside
  useEffect(() => {
    const handleClickOutside = (event) => {
      if (showCardMenu && !event.target.closest(".card-menu-container")) {
        setShowCardMenu(false);
      }
      if (showPricingMenu && !event.target.closest(".pricing-menu-container")) {
        setShowPricingMenu(false);
      }
      if (
        showCardVariantDropdown &&
        !event.target.closest(".variant-dropdown-container")
      ) {
        setShowCardVariantDropdown(false);
      }
      if (
        showCardConditionDropdown &&
        !event.target.closest(".condition-dropdown-container")
      ) {
        setShowCardConditionDropdown(false);
      }
      if (
        showCardTypeDropdown &&
        !event.target.closest(".card-type-dropdown-container")
      ) {
        setShowCardTypeDropdown(false);
      }
      // Close dropdowns when clicking outside
      if (!event.target.closest(".dropdown-container")) {
        setShowDeckDropdown(false);
        setShowBinderDropdown(false);
        setShowIssueDropdown(false);
        setShowPurchaseSourceDropdown(false);
      }
    };

    document.addEventListener("mousedown", handleClickOutside);
    return () => {
      document.removeEventListener("mousedown", handleClickOutside);
    };
  }, [
    showCardMenu,
    showPricingMenu,
    showCardVariantDropdown,
    showCardConditionDropdown,
    showCardTypeDropdown,
  ]);

  // Handle actually adding the card to collection with all options
  const handleConfirmAddToCollection = async () => {
    // Determine which card to add based on which modal is open
    const card = cardToAdd || cardToAddFromProfile || cardToAddFromSearch;
    if (!card) return;

    console.log("Adding card to collection with options:", {
      card: card.name,
      collection: selectedCollectionForAdd,
      quantity: addQuantity,
      variant: selectedVariant,
      condition: addCardCondition,
      isGraded,
      gradingService: selectedGradingService,
      grade: selectedGrade,
      note: addNote,
    });

    // Create a consistent card ID based on card properties
    // This ensures the same card always gets the same ID regardless of when it's added
    const cardId =
      card.id ||
      card.cardId ||
      `${card.name}-${card.set_name || "Unknown"}-${
        card.formattedNumber || card.number || "001"
      }`.replace(/[^a-zA-Z0-9-]/g, "-");

    // Get current value - if it's 0 or null, try to fetch from API
    let currentValue =
      card.price ||
      card.currentValue ||
      card.tcgplayer?.prices?.holofoil?.market ||
      card.tcgplayer?.prices?.normal?.market ||
      0;

    // If we don't have a price, try to fetch from the database
    if (currentValue === 0 && cardId) {
      try {
        const response = await fetch(
          `${API_URL}/api/cards/${cardId}?t=${Date.now()}`
        );
        if (response.ok) {
          const cardData = await response.json();
          if (cardData.current_value && cardData.current_value > 0) {
            currentValue = cardData.current_value;
          }
        }
      } catch (err) {
        console.error("Error fetching card price:", err);
      }
    }

    // Prepare card data for database
    const cardData = {
      id: cardId,
      name: card.name,
      set: card.set_name || "Unknown Set",
      set_name: card.set_name || "Unknown Set",
      rarity: card.rarity || "Unknown",
      number: card.formattedNumber || card.number || "001",
      imageUrl: getCardImageUrl(card),
      images: card.images || { small: card.imageUrl, large: card.imageUrl },
      artist: card.artist || null, // TCGCSV data doesn't include artist information
      currentValue: currentValue,
      tcgplayer: card.tcgplayer,
    };

    // Add card to collection using userDatabase
    const success = userDatabase.addCardToCollection(
      selectedCollectionForAdd,
      cardData,
      addQuantity,
      isGraded ? null : addCardCondition,
      selectedVariant,
      isGraded ? selectedGrade : null,
      isGraded ? selectedGradingService : null,
      null, // pricePaid
      addNote || ""
    );

    if (success) {
      // Clean up any duplicates that might have been created
      userDatabase.cleanupDuplicates(selectedCollectionForAdd);

      // Reload user data to reflect changes
      const updatedUserData = userDatabase.getUserData();

      // Update states
      if (updatedUserData) {
        setUserData({ ...updatedUserData });
        setRecentActivityData([...(updatedUserData.recentActivity || [])]);
        setDisplayedActivity([
          ...(updatedUserData.recentActivity || []).slice(0, 3),
        ]);
      }

      // Show notification
      const collectionName =
        updatedUserData?.collections.find(
          (c) => c.id === selectedCollectionForAdd
        )?.name || "Collection";
      const quantityText = addQuantity > 1 ? ` (${addQuantity})` : "";
      setCollectionNotificationMessage(
        `Added ${card.name}${quantityText} to ${collectionName}`
      );
      setShowCollectionNotification(true);

      // Auto-hide notification after 3 seconds
      setTimeout(() => {
        setShowCollectionNotification(false);
      }, 3000);

      // Close all modals and reset states
      setShowAddToCollectionModal(false);
      setShowCardProfileModal(false);
      setShowSearchResultsModal(false);
      setCardToAdd(null);
      setCardToAddFromProfile(null);
      setCardToAddFromSearch(null);

      // Reset form fields for next use
      setAddQuantity(1);
      setSelectedVariant("Normal");
      setAddCardCondition("Near Mint");
      setIsGraded(false);
      setSelectedGradingService("PSA");
      setSelectedGrade("10");
      setAddNote("");
      setSelectedCollectionForAdd("pokemon-collection");
    } else {
      console.error("Failed to add card to collection");
      alert("Failed to add card to collection. Please try again.");
    }
  };

  const handleCloseCardProfile = () => {
    setShowCardProfile(false);
    setSelectedCard(null);
  };

  const handleGallerySelect = () => {
    // Gallery selection functionality
    console.log("Gallery selection triggered");
  };

  const handleEditSettings = () => {
    setShowEditModal(true);
  };

  const handleEditModalClose = () => {
    setShowEditModal(false);
  };

  // Calculate total collection value at a specific time
  const calculateCollectionValueAtTime = (collection, timePoint) => {
    if (!collection || !collection.cards || collection.cards.length === 0) {
      return 0;
    }

    let totalValue = 0;
    collection.cards.forEach((card) => {
      // Check if this card existed at the given time point
      const cardAddedTime = card.dateAdded || card.lastUpdated;
      if (cardAddedTime && new Date(cardAddedTime) <= timePoint) {
        // Card existed at this time, include its value
        const cardValue =
          card.currentValue || card.current_value || card.price || 0;
        const quantity = card.quantity || 1;
        totalValue += cardValue * quantity;
      }
      // If card was added after this time point, don't include it (value = 0)
    });

    return totalValue;
  };

  // Calculate price change for the selected timeline
  const calculatePriceChange = (timeRange) => {
    if (!userData) return { change: 0, changePercent: 0, timeLabel: "" };

    const currentCollection =
      userData.collections.find((c) => c.id === selectedCollection) ||
      userData.collections[0];
    if (!currentCollection)
      return { change: 0, changePercent: 0, timeLabel: "" };

    const now = new Date();
    const currentValue = calculateCollectionValueAtTime(currentCollection, now);

    let pastValue = 0;
    let timeLabel = "";

    if (timeRange === "MAX") {
      // For Max, find the earliest card addition time
      const cardAdditionTimes =
        currentCollection.cards
          ?.map((card) => {
            const dateAdded = card.dateAdded || card.lastUpdated;
            return dateAdded ? new Date(dateAdded) : null;
          })
          .filter(Boolean) || [];

      if (cardAdditionTimes.length > 0) {
        const earliestCardTime = new Date(
          Math.min(...cardAdditionTimes.map((d) => d.getTime()))
        );
        // For Max, pastValue should be the value the day BEFORE the first card was added (which should be $0.00)
        const dayBeforeFirstCard = new Date(
          earliestCardTime.getTime() - 24 * 60 * 60 * 1000
        );
        pastValue = calculateCollectionValueAtTime(
          currentCollection,
          dayBeforeFirstCard
        );
        timeLabel = "total";
      } else {
        // No cards in collection, total change is 0
        pastValue = 0;
        timeLabel = "total";
      }
    } else {
      // Calculate the time interval for the selected range
      let timeInterval;
      switch (timeRange) {
        case "1D":
          timeInterval = 24 * 60 * 60 * 1000; // 24 hours
          break;
        case "7D":
          timeInterval = 7 * 24 * 60 * 60 * 1000; // 7 days
          break;
        case "1M":
          timeInterval = 30 * 24 * 60 * 60 * 1000; // 30 days
          break;
        case "3M":
          timeInterval = 90 * 24 * 60 * 60 * 1000; // 90 days
          break;
        case "6M":
          timeInterval = 180 * 24 * 60 * 60 * 1000; // 180 days
          break;
        case "1Y":
          timeInterval = 365 * 24 * 60 * 60 * 1000; // 365 days
          break;
        default:
          timeInterval = 24 * 60 * 60 * 1000; // Default to 1 day
      }

      const pastTime = new Date(now.getTime() - timeInterval);
      pastValue = calculateCollectionValueAtTime(currentCollection, pastTime);

      // Get the time label
      switch (timeRange) {
        case "1D":
          timeLabel = "today";
          break;
        case "7D":
          timeLabel = "this week";
          break;
        case "1M":
          timeLabel = "this month";
          break;
        case "3M":
          timeLabel = "past 3 months";
          break;
        case "6M":
          timeLabel = "past 6 months";
          break;
        case "1Y":
          timeLabel = "past year";
          break;
        default:
          timeLabel = "today";
      }
    }

    const change = currentValue - pastValue;
    const changePercent = pastValue > 0 ? (change / pastValue) * 100 : 0;

    return { change, changePercent, timeLabel };
  };

  // Generate historical collection data for a time range
  const generateCollectionHistoryData = (timeRange) => {
    if (!userData) return [];

    const currentCollection =
      userData.collections.find((c) => c.id === selectedCollection) ||
      userData.collections[0];
    if (!currentCollection) return [];

    const now = new Date();

    // Find the earliest card addition time
    const cardAdditionTimes =
      currentCollection.cards
        ?.map((card) => {
          const dateAdded = card.dateAdded || card.lastUpdated;
          return dateAdded ? new Date(dateAdded) : null;
        })
        .filter(Boolean) || [];

    const earliestCardTime =
      cardAdditionTimes.length > 0
        ? new Date(Math.min(...cardAdditionTimes.map((d) => d.getTime())))
        : null;

    let dataPoints, timeInterval, startTime;

    if (timeRange === "MAX") {
      if (!earliestCardTime) {
        // No cards in collection, return empty history
        return [];
      }

      // For Max, show just 2 points: day before first card and day of first card
      dataPoints = 2;
      const dayBeforeFirstCard = new Date(
        earliestCardTime.getTime() - 24 * 60 * 60 * 1000
      ); // 24 hours before
      timeInterval = 24 * 60 * 60 * 1000; // 24 hours
      startTime = dayBeforeFirstCard;
    } else {
      dataPoints = priceService.getDataPointsForRange(timeRange);
      timeInterval = priceService.getTimeInterval(timeRange, dataPoints);
      startTime = new Date(now.getTime() - (dataPoints - 1) * timeInterval);
    }

    const history = [];
    const currentValue = calculateCollectionValueAtTime(currentCollection, now);

    console.log(`Generating ${timeRange} chart data:`, {
      dataPoints,
      timeInterval: timeInterval / (60 * 60 * 1000), // Convert to hours
      currentValue,
      collectionCards: currentCollection.cards?.length || 0,
      earliestCardTime: earliestCardTime?.toISOString(),
      startTime: startTime?.toISOString(),
    });

    for (let i = 0; i < dataPoints; i++) {
      const date = new Date(startTime.getTime() + i * timeInterval);

      // Calculate the actual collection value at this specific time point
      const value = calculateCollectionValueAtTime(currentCollection, date);

      history.push({
        date: date.toISOString(),
        value: Math.max(0, value),
      });
    }

    // For Max timeline, add current value as the final point if it's different from the first card day
    if (timeRange === "MAX" && earliestCardTime) {
      const currentValue = calculateCollectionValueAtTime(
        currentCollection,
        now
      );
      const firstCardValue = calculateCollectionValueAtTime(
        currentCollection,
        earliestCardTime
      );

      // Only add current point if the value has changed since the first card was added
      if (currentValue !== firstCardValue) {
        history.push({
          date: now.toISOString(),
          value: Math.max(0, currentValue),
        });
      }
    }

    console.log(`${timeRange} chart data generated:`, {
      historyLength: history.length,
      firstValue: history[0]?.value,
      lastValue: history[history.length - 1]?.value,
      firstTime: history[0]?.date,
      lastTime: history[history.length - 1]?.date,
      earliestCardTime: earliestCardTime?.toISOString(),
    });

    return history;
  };

  // Chart data generator
  // Get theme-aware chart dataset colors
  const getChartDatasetColors = () => {
    const isDark = document.documentElement.classList.contains("dark");
    return {
      borderColor: "#6865E7",
      backgroundColor: isDark
        ? "rgba(104, 101, 231, 0.1)"
        : "rgba(104, 101, 231, 0.08)",
      pointBackgroundColor: "#6865E7",
      pointBorderColor: isDark ? "#F9F9F9" : "#FFFFFF",
    };
  };

  const getChartData = useMemo(() => {
    const colors = getChartDatasetColors();
    if (!userData) {
      return {
        labels: [],
        datasets: [
          {
            label: "Portfolio Value",
            data: [],
            borderColor: colors.borderColor,
            backgroundColor: colors.backgroundColor,
            borderWidth: 2,
            fill: true,
            tension: 0.4,
            pointBackgroundColor: colors.pointBackgroundColor,
            pointBorderColor: colors.pointBorderColor,
            pointBorderWidth: 2,
            pointRadius: 0,
            pointHoverRadius: 6,
          },
        ],
      };
    }

    const currentCollection =
      userData.collections.find((c) => c.id === selectedCollection) ||
      userData.collections[0];

    // Generate real collection history data based on current collection
    const history = generateCollectionHistoryData(selectedTimeRange);

    // If no collection or no cards, show $0.00 for all time points
    if (
      !currentCollection ||
      !currentCollection.cards ||
      currentCollection.cards.length === 0
    ) {
      const dataPoints = priceService.getDataPointsForRange(selectedTimeRange);
      const now = new Date();
      const timeInterval = priceService.getTimeInterval(
        selectedTimeRange,
        dataPoints
      );

      const labels = [];
      const data = [];

      for (let i = dataPoints - 1; i >= 0; i--) {
        const date = new Date(now.getTime() - i * timeInterval);
        labels.push(
          selectedTimeRange === "1D"
            ? date.toLocaleTimeString("en-US", {
                hour: "2-digit",
                minute: "2-digit",
              })
            : date.toLocaleDateString("en-US", {
                month: "short",
                day: "numeric",
              })
        );
        data.push(0); // $0.00 for all time points when no collection
      }

      const colors = getChartDatasetColors();
      return {
        labels,
        datasets: [
          {
            label: "Portfolio Value",
            data,
            borderColor: colors.borderColor,
            backgroundColor: colors.backgroundColor,
            borderWidth: 2,
            fill: true,
            tension: 0.4,
            pointBackgroundColor: colors.pointBackgroundColor,
            pointBorderColor: colors.pointBorderColor,
            pointBorderWidth: 2,
            pointRadius: 0,
            pointHoverRadius: 6,
          },
        ],
      };
    }

    // Ensure we have valid data
    if (!history || history.length === 0) {
      const colors = getChartDatasetColors();
      return {
        labels: [],
        datasets: [
          {
            label: "Portfolio Value",
            data: [],
            borderColor: colors.borderColor,
            backgroundColor: colors.backgroundColor,
            borderWidth: 2,
            fill: true,
            tension: 0.4,
            pointBackgroundColor: colors.pointBackgroundColor,
            pointBorderColor: colors.pointBorderColor,
            pointBorderWidth: 2,
            pointRadius: 4,
            pointHoverRadius: 6,
          },
        ],
      };
    }

    return {
      labels: history.map((point) => {
        const date = new Date(point.date);
        if (selectedTimeRange === "1D") {
          return date.toLocaleTimeString("en-US", {
            hour: "2-digit",
            minute: "2-digit",
          });
        } else if (selectedTimeRange === "7D") {
          return date.toLocaleDateString("en-US", {
            month: "short",
            day: "numeric",
          });
        } else if (selectedTimeRange === "1M") {
          return date.toLocaleDateString("en-US", {
            month: "short",
            day: "numeric",
          });
        } else if (selectedTimeRange === "3M") {
          return date.toLocaleDateString("en-US", {
            month: "short",
            day: "numeric",
          });
        } else if (selectedTimeRange === "6M") {
          return date.toLocaleDateString("en-US", {
            month: "short",
            day: "numeric",
          });
        } else if (selectedTimeRange === "1Y") {
          return date.toLocaleDateString("en-US", {
            month: "short",
            day: "numeric",
          });
        } else if (selectedTimeRange === "MAX") {
          return date.toLocaleDateString("en-US", {
            month: "short",
            day: "numeric",
          });
        } else {
          return date.toLocaleDateString("en-US", {
            month: "short",
            day: "numeric",
          });
        }
      }),
      datasets: [
        {
          label: "Portfolio Value",
          data: history.map((point) => convertCurrency(point.value)),
          borderColor: getChartDatasetColors().borderColor,
          backgroundColor: getChartDatasetColors().backgroundColor,
          borderWidth: 2,
          fill: true,
          tension: 0.4,
          pointBackgroundColor: getChartDatasetColors().pointBackgroundColor,
          pointBorderColor: getChartDatasetColors().pointBorderColor,
          pointBorderWidth: 2,
          pointRadius: 0,
          pointHoverRadius: 6,
        },
      ],
    };
  }, [
    selectedTimeRange,
    selectedCurrency,
    selectedCollection,
    userData,
    theme,
    isDark,
  ]); // Re-compute when theme changes

  // Get top valued cards from user's collection
  const myTopMovers = useMemo(() => {
    if (!userData || !userData.collections) return [];

    // Get all cards from all collections
    const allCards = [];
    userData.collections.forEach((collection) => {
      if (collection.cards && collection.cards.length > 0) {
        collection.cards.forEach((card) => {
          // Use the currentValue from localStorage, but we'll update this with fresh data
          allCards.push({
            ...card,
            totalValue: (card.currentValue || 0) * (card.quantity || 1),
          });
        });
      }
    });

    // Sort by total value (descending) and take top 3
    return allCards.sort((a, b) => b.totalValue - a.totalValue).slice(0, 3);
  }, [userData]);

  // State to store updated prices for collection cards
  const [updatedCollectionPrices, setUpdatedCollectionPrices] = useState({});

  // Fetch current prices for collection cards
  useEffect(() => {
    const fetchCurrentPrices = async () => {
      if (!userData || !userData.collections) return;

      const priceUpdates = {};

      // Get all unique card IDs from collections
      const cardIds = new Set();
      userData.collections.forEach((collection) => {
        if (collection.cards && collection.cards.length > 0) {
          collection.cards.forEach((card) => {
            if (card.cardId) {
              cardIds.add(card.cardId);
            }
          });
        }
      });

      // Fetch current prices for each card
      const pricePromises = Array.from(cardIds).map(async (cardId) => {
        try {
          const response = await fetch(`${API_URL}/api/cards/${cardId}`);
          if (response.ok) {
            const result = await response.json();
            if (result.data && result.data.current_value > 0) {
              priceUpdates[cardId] = result.data.current_value;
            }
          } else if (response.status === 404) {
            // Card not found - this is expected for old card IDs
            console.log(
              `Card ${cardId} not found in new database (likely old card ID)`
            );
          }
        } catch (error) {
          console.error(`Error fetching price for card ${cardId}:`, error);
        }
      });

      await Promise.all(pricePromises);
      setUpdatedCollectionPrices(priceUpdates);
    };

    fetchCurrentPrices();
  }, [userData]);

  // Get top movers with updated prices
  const myTopMoversWithUpdatedPrices = useMemo(() => {
    if (!userData || !userData.collections) return [];

    // Get all cards from all collections
    const allCards = [];
    userData.collections.forEach((collection) => {
      if (collection.cards && collection.cards.length > 0) {
        collection.cards.forEach((card) => {
          // Use updated price if available, otherwise fall back to stored price
          const currentPrice =
            updatedCollectionPrices[card.cardId] || card.currentValue || 0;
          allCards.push({
            ...card,
            currentValue: currentPrice, // Update with fresh price
            totalValue: currentPrice * (card.quantity || 1),
          });
        });
      }
    });

    // Sort by total value (descending) and take top 3
    return allCards.sort((a, b) => b.totalValue - a.totalValue).slice(0, 3);
  }, [userData, updatedCollectionPrices]);

  // Get card-specific variants and their prices from database
  const getCardVariants = useMemo(() => {
    if (!selectedCard) return [];

    // If the card has variants data from the API, use real database prices
    if (selectedCard.variants) {
      let variantsArray = selectedCard.variants;

      // Parse variants if it's a string
      if (typeof variantsArray === "string") {
        try {
          variantsArray = JSON.parse(variantsArray);
        } catch (e) {
          console.warn("Failed to parse variants string:", variantsArray);
          variantsArray = [];
        }
      }

      // Ensure it's an array
      if (!Array.isArray(variantsArray)) {
        variantsArray = [];
      }

      if (variantsArray.length > 0) {
        console.log(
          "Using real variant data from database for",
          selectedCard.name,
          ":",
          variantsArray
        );

        return variantsArray.map((variant) => ({
          id: (variant.sub_type_name || "normal")
            .toLowerCase()
            .replace(/\s+/g, ""),
          name: variant.sub_type_name || "Normal",
          price: variant.market_price || 0,
          product_id: variant.product_id,
          is_primary: variant.is_primary,
        }));
      }
    }

    // Fallback: Use calculated variants if no database variants available
    const basePrice = selectedCard.current_value || selectedCard.price || 0;

    // Get the actual variants available for this card based on rarity
    let cardVariants = [];
    const rarity = selectedCard.ext_rarity || "";

    // Determine variants based on rarity - check Secret Rare FIRST
    if (
      rarity.includes("Secret") ||
      rarity.includes("Ultra") ||
      rarity.includes("Hyper")
    ) {
      // Special handling for Secret Rare cards that might have specific variant names
      if (rarity.includes("Secret") || rarity.includes("Star")) {
        // For Secret Rare cards, prioritize the specific variant names
        cardVariants = ["Unlimited Holofoil", "1st Edition Holofoil"];
      } else {
        // Other Secret/Ultra/Hyper rare cards are typically holo only
        cardVariants.push("Holo");
      }
    } else if (rarity.includes("Holo") || rarity.includes("Rare")) {
      // Holo cards can have both Normal and Holo variants
      cardVariants.push("Normal");
      cardVariants.push("Holo");

      // Add Reverse Holo for most holo cards
      if (
        !rarity.includes("Secret") &&
        !rarity.includes("Ultra") &&
        !rarity.includes("Hyper")
      ) {
        cardVariants.push("Reverse Holo");
      }
    } else if (rarity.includes("Common") || rarity.includes("Uncommon")) {
      // Common/Uncommon cards are typically normal only
      cardVariants.push("Normal");
    } else {
      // Default to Normal for unknown rarities
      cardVariants.push("Normal");
    }

    // Add special variants based on rarity
    if (rarity.includes("1st Edition") || rarity.includes("First Edition")) {
      cardVariants.push("1st Edition");
    }
    if (rarity.includes("Shadowless")) {
      cardVariants.push("Shadowless");
    }
    if (rarity.includes("Radiant")) {
      cardVariants.push("Radiant");
    }

    // Remove duplicates
    const uniqueVariants = [...new Set(cardVariants)];

    // If still no variants found, default to Normal
    if (uniqueVariants.length === 0) {
      uniqueVariants.push("Normal");
    }

    console.log("Using calculated variants for", selectedCard.name, ":", {
      rarity: rarity,
      finalVariants: uniqueVariants,
      cardVariants: cardVariants,
    });

    // Create variants with base price (no multipliers)
    const variants = uniqueVariants.map((variantName) => {
      const variantId = variantName.toLowerCase().replace(/\s+/g, "");

      return {
        id: variantId,
        name: variantName,
        price: basePrice, // Use base price for all variants
        multiplier: 1.0,
      };
    });

    // If no variants are specified, default to Normal
    if (variants.length === 0) {
      variants.push({
        id: "Normal",
        name: "Normal",
        price: basePrice,
        multiplier: 1.0,
      });
    }

    return variants;
  }, [selectedCard]);

  // Get current price based on selected variant and condition
  const getCurrentPrice = useMemo(() => {
    if (!selectedCard) return 0;

    // Check for condition-specific pricing first (highest priority)
    if (conditionPrices) {
      const conditionKey = selectedCondition.toLowerCase().replace(/\s+/g, "_");
      const conditionPrice = conditionPrices[conditionKey];
      if (conditionPrice && conditionPrice > 0) {
        console.log(
          "Using condition price:",
          selectedCondition,
          conditionPrice
        );
        return conditionPrice;
      }
    }

    // Check for variant-specific pricing (second priority)
    const variant = getCardVariants.find((v) => v.id === selectedCardVariant);
    if (variant && variant.price > 0) {
      console.log(
        "Using variant price:",
        variant.name,
        variant.price,
        "for variant ID:",
        selectedCardVariant
      );
      return variant.price;
    }

    // Fallback to database current_value if no variant pricing
    if (selectedCard.current_value && selectedCard.current_value > 0) {
      return selectedCard.current_value;
    }

    // Fallback to legacy price field
    if (selectedCard.price && selectedCard.price > 0) {
      return selectedCard.price;
    }

    // If no price data available, return 0 to indicate no pricing information
    return 0;
  }, [
    selectedCard,
    selectedCardVariant,
    getCardVariants,
    conditionPrices,
    selectedCondition,
  ]);

  // Card-specific price chart data generator
  // Helper function to get chart data with parameters
  const getCardChartData = async (
    card,
    timeRange,
    variant,
    condition,
    gradingService,
    grade
  ) => {
    if (!card) {
      return {
        labels: [],
        datasets: [],
        absoluteChange: 0,
        percentageChange: 0,
      };
    }

    try {
      // Use TCGPlayer service for real data only, pass the variant
      // Use clean name without card numbers for better matching
      const cleanCardName = getDisplayName(card) || card.name;
      console.log("📊 [CHART] Fetching chart data:", {
        cardName: cleanCardName,
        setName: card.set_name || card.set,
        timeRange,
        variant,
        cardId: card.id || card.product_id || card.cardId,
      });
      const chartData = await tcgplayerService.getChartData(
        cleanCardName,
        card.set_name || card.set,
        timeRange,
        card,
        variant
      );
      console.log("📊 [CHART] Chart data received:", {
        hasChartData: !!chartData,
        hasDatasets: !!chartData?.datasets,
        datasetsLength: chartData?.datasets?.length || 0,
        dataPoints: chartData?.datasets?.[0]?.data?.length || 0,
        labelsCount: chartData?.labels?.length || 0,
      });
      return chartData;
    } catch (error) {
      console.error("❌ [CHART] Error fetching chart data:", error);
      console.error("❌ [CHART] Error stack:", error.stack);

      // Return empty chart if no real data is available
      return {
        labels: [],
        datasets: [],
        absoluteChange: 0,
        percentageChange: 0,
      };
    }
  };

  // Chart data state for async loading
  const [cardChartData, setCardChartData] = useState({
    labels: [],
    datasets: [],
  });

  // Market value data state for async loading
  const [marketValueData, setMarketValueData] = useState({
    currentPrice: 0,
    absoluteChange: 0,
    percentageChange: 0,
    isPositive: false,
  });

  // Chart error state
  const [chartError, setChartError] = useState(null);
  const [chartLoading, setChartLoading] = useState(false);

  // Load chart data when selectedCard or timeRange changes
  useEffect(() => {
    // Track the current card to prevent race conditions
    const currentCardId =
      selectedCard?.id || selectedCard?.product_id || selectedCard?.cardId;
    let cancelled = false;
    let retryCount = 0;
    const MAX_RETRIES = 2;
    let retryTimeoutId = null;

    const loadChartData = async (isRetry = false) => {
      if (!selectedCard) {
        setCardChartData({
          labels: [],
          datasets: [],
        });
        setChartLoading(false);
        setChartError(null);
        return;
      }

      // Check if this is still the current card (prevent race conditions)
      const cardId =
        selectedCard?.id || selectedCard?.product_id || selectedCard?.cardId;
      if (cardId !== currentCardId || cancelled) {
        console.log(
          "Chart load cancelled - card changed or component unmounted"
        );
        return;
      }

      if (!isRetry) {
        setChartLoading(true);
        setChartError(null);
      }

      console.log(
        `Loading chart data for ${selectedCard.name} with time range: ${cardChartTimeRange}, variant: ${selectedCardVariant}`
      );
      console.log(
        "Chart data loading - selectedCardVariant:",
        selectedCardVariant,
        "type:",
        typeof selectedCardVariant
      );
      console.log("SelectedCard ID fields:", {
        id: selectedCard.id,
        product_id: selectedCard.product_id,
        cardId: selectedCard.cardId,
        name: selectedCard.name,
        set_name: selectedCard.set_name,
      });

      try {
        const chartData = await getCardChartData(
          selectedCard,
          cardChartTimeRange,
          selectedCardVariant,
          "raw",
          "PSA",
          "10"
        );

        // Double-check this is still the current card before updating state
        let stillCurrentCard =
          (selectedCard?.id ||
            selectedCard?.product_id ||
            selectedCard?.cardId) === currentCardId;
        if (cancelled || !stillCurrentCard) {
          console.log("Chart load cancelled - card changed during fetch");
          return;
        }

        console.log(`Chart data loaded for ${cardChartTimeRange}:`, chartData);
        console.log(
          `Data points: ${chartData?.datasets?.[0]?.data?.length || 0}`
        );
        console.log(
          `Labels: ${chartData?.labels
            ?.slice(0, 5)
            .join(", ")}... (showing first 5)`
        );
        console.log(
          "Setting chart data with datasets:",
          chartData?.datasets?.length || 0
        );
        console.log(
          "Setting chart data with data points:",
          chartData?.datasets?.[0]?.data?.length || 0
        );

        // Validate chart data structure - ensure it has valid data
        const hasValidData =
          chartData &&
          chartData.datasets &&
          chartData.datasets.length > 0 &&
          chartData.datasets[0] &&
          chartData.datasets[0].data &&
          Array.isArray(chartData.datasets[0].data) &&
          chartData.datasets[0].data.length > 0 &&
          chartData.labels &&
          Array.isArray(chartData.labels) &&
          chartData.labels.length > 0;

        // Re-check if still current card (may have changed during validation)
        stillCurrentCard =
          (selectedCard?.id ||
            selectedCard?.product_id ||
            selectedCard?.cardId) === currentCardId;

        if (hasValidData) {
          if (cancelled || !stillCurrentCard) {
            console.log(
              "Chart load cancelled - card changed during validation"
            );
            return;
          }

          console.log("✅ [CHART] Setting valid chart data:", {
            labelsCount: chartData.labels?.length || 0,
            datasetsCount: chartData.datasets?.length || 0,
            dataPoints: chartData.datasets?.[0]?.data?.length || 0,
            chartData: chartData,
          });
          setCardChartData(chartData);
          setChartError(null);
          setChartLoading(false);
        } else {
          // No data available - tcgplayerService already tried fallback variants
          console.log("⚠️ [CHART] No valid chart data returned:", {
            chartData,
            hasChartData: !!chartData,
            hasDatasets: !!chartData?.datasets,
            datasetsLength: chartData?.datasets?.length || 0,
          });
          if (!cancelled && stillCurrentCard) {
            setCardChartData({
              labels: [],
              datasets: [],
            });
            setChartError(null); // Don't show error if just no data
            setChartLoading(false);
          }
        }
      } catch (error) {
        console.error("Error loading chart data:", error);

        // Check if still current card (in catch block, so separate scope - need new variable)
        const isStillCurrentCard =
          (selectedCard?.id ||
            selectedCard?.product_id ||
            selectedCard?.cardId) === currentCardId;

        // Retry on network errors (only if not cancelled and still current card)
        if (
          !cancelled &&
          isStillCurrentCard &&
          retryCount < MAX_RETRIES &&
          (error.message?.includes("fetch") ||
            error.message?.includes("network") ||
            error.message?.includes("Failed to fetch") ||
            error.message?.includes("timeout"))
        ) {
          console.log(
            `Network error, retrying (attempt ${retryCount + 1}/${MAX_RETRIES})`
          );
          retryCount++;
          retryTimeoutId = setTimeout(() => {
            if (
              !cancelled &&
              (selectedCard?.id ||
                selectedCard?.product_id ||
                selectedCard?.cardId) === currentCardId
            ) {
              loadChartData(true);
            }
          }, 1000 * retryCount); // Exponential backoff
          return;
        }

        // Check if still current card before setting error
        if (!cancelled && isStillCurrentCard) {
          setChartError(error.message || "Failed to load chart data");
          setCardChartData({
            labels: [],
            datasets: [],
          });
          setChartLoading(false);
        }
      }
    };

    loadChartData();

    // Cleanup function to cancel in-flight requests
    return () => {
      cancelled = true;
      if (retryTimeoutId) {
        clearTimeout(retryTimeoutId);
      }
      setChartLoading(false);
    };
  }, [selectedCard, cardChartTimeRange, selectedCardVariant]);

  // Load set cards when selectedSet changes
  useEffect(() => {
    const CACHE_KEY_PREFIX = "set_cards_cache_";
    const CACHE_TTL = 10 * 60 * 1000; // 10 minutes

    // Track the current set being loaded to prevent race conditions
    let currentSetId = null;
    let cancelled = false;

    const loadSetCards = async (
      useCache = true,
      skipIfAlreadyLoaded = false
    ) => {
      console.log("📋 [NAV DEBUG] loadSetCards called:", {
        selectedSet,
        showSetPage,
        showCardProfile,
        currentCardsLength: setCardsData?.length || 0,
        useCache,
        skipIfAlreadyLoaded,
      });

      if (!selectedSet || !showSetPage) {
        console.log(
          "📋 [NAV DEBUG] loadSetCards: Skipping - no selectedSet or showSetPage is false"
        );
        // Only clear cards if we're actually closing the set page (not just temporarily hidden)
        // Don't clear if card profile is open (set page is just hidden behind modal)
        if (!showCardProfile) {
          console.log(
            "📋 [NAV DEBUG] Clearing cards because set page is closing"
          );
          setSetCardsData([]);
        } else {
          console.log(
            "📋 [NAV DEBUG] NOT clearing cards - card profile is open (set page is just hidden)"
          );
        }
        setLoadingSetCards(false);
        return;
      }

      // If we already have cards loaded and we're just restoring from history, don't reload
      if (setCardsData && setCardsData.length > 0 && skipIfAlreadyLoaded) {
        console.log("📋 [NAV DEBUG] Cards already loaded, skipping reload");
        return;
      }

      // Use selectedSetData to get the set ID, fallback to selectedSet
      // For Japanese sets, prefer group_id; for English sets, use id or name
      const setId =
        selectedSetData?.group_id || selectedSetData?.id || selectedSet;

      // Set current loading set ID to prevent race conditions
      currentSetId = setId;

      // If cards are already loaded (from handleSetClickWithData cache), skip cache check
      // and just refresh in background
      if (skipIfAlreadyLoaded && setCardsData.length > 0) {
        // Just refresh in background silently
        useCache = false;
      }

      try {
        const cacheKey = `${CACHE_KEY_PREFIX}${setId}`;

        // Check cache first (only if cards aren't already loaded)
        if (useCache && setCardsData.length === 0) {
          const cached = localStorage.getItem(cacheKey);
          if (cached) {
            try {
              const { data, timestamp } = JSON.parse(cached);
              if (Date.now() - timestamp < CACHE_TTL) {
                // Only update if this is still the current set and not cancelled
                if (currentSetId === setId && !cancelled) {
                  setSetCardsData(data.cards || []);
                  setLoadingSetCards(false);
                  if (data.setDetails) {
                    setSelectedSetData((prev) => ({
                      ...prev,
                      ...data.setDetails,
                      release_date:
                        data.setDetails.release_date ||
                        data.setDetails.published_on ||
                        prev?.release_date,
                    }));
                  }
                  // Fetch fresh data in background (silently)
                  loadSetCards(false, true);
                }
                return;
              }
            } catch (e) {
              // Invalid cache, continue to fetch
            }
          }
        }

        // Only show loading if we don't have cached data already loaded
        if (useCache && setCardsData.length === 0) {
          setLoadingSetCards(true);
        }

        // URL encode the set ID/name to handle special characters and spaces
        const encodedSetId = encodeURIComponent(String(setId));

        // Fetch cards from API endpoint with pagination (first page only for initial load)
        const page = skipIfAlreadyLoaded ? setCardsPage : 1;
        const response = await fetch(
          `${API_URL}/api/sets/${encodedSetId}?page=${page}&limit=100`
        );
        if (!response.ok) {
          throw new Error("Failed to fetch set cards");
        }

        const result = await response.json();
        const setDetails = result.data;

        // Only update if this is still the current set (prevent race conditions)
        if (currentSetId !== setId || cancelled) {
          return; // Another set was selected, ignore this response
        }

        // Update selectedSetData with the set details from API (includes release_date)
        if (setDetails) {
          setSelectedSetData((prev) => ({
            ...prev,
            ...setDetails,
            // Ensure release_date is available
            release_date:
              setDetails.release_date ||
              setDetails.published_on ||
              prev?.release_date,
          }));
        }

        if (setDetails && setDetails.cards) {
          // Format cards to match the expected structure
          const formattedCards = setDetails.cards.map((card) => {
            const cardId = card.id || card.productId;
            const imageUrl = card.imageUrl || card.image_url;

            return {
              id: cardId,
              product_id: cardId,
              cardId: String(cardId),
              name: card.cleanName || card.name,
              cleanName: card.cleanName || card.name,
              image_url: imageUrl,
              imageUrl: imageUrl, // Include both formats for compatibility
              formattedNumber: card.ext_number || "N/A",
              current_value: card.current_value || card.market_price || 0,
              price: card.current_value || card.market_price || 0,
              market_price: card.market_price || 0,
              low_price: card.low_price || 0,
              high_price: card.high_price || 0,
              rarity: card.ext_rarity,
              ext_rarity: card.ext_rarity,
              sub_type_name: card.sub_type_name,
              images: imageUrl ? { small: imageUrl, large: imageUrl } : null,
              tcgplayer: {
                prices: {
                  holofoil: card.market_price
                    ? { market: card.market_price }
                    : null,
                  normal: card.market_price
                    ? { market: card.market_price }
                    : null,
                },
              },
            };
          });

          // Update cache (only for first page)
          if (page === 1) {
            try {
              localStorage.setItem(
                cacheKey,
                JSON.stringify({
                  cards: formattedCards,
                  setDetails: setDetails,
                  has_more: setDetails.has_more || false,
                  timestamp: Date.now(),
                })
              );
            } catch (e) {
              // Cache full, continue anyway
            }
          }

          // Append or replace cards based on page
          if (page === 1 || !skipIfAlreadyLoaded) {
            setSetCardsData(formattedCards);
          } else {
            // Append for pagination
            setSetCardsData((prev) => [...prev, ...formattedCards]);
          }

          setHasMoreCards(setDetails.has_more || false);
        } else {
          if (page === 1) {
            setSetCardsData([]);
          }
        }

        setLoadingSetCards(false);
      } catch (error) {
        console.error("Error loading set cards:", error);
        // Only update if this is still the current set
        if (currentSetId === setId) {
          // If fetch fails and we have cached data, use it
          if (useCache) {
            const cacheKey = `${CACHE_KEY_PREFIX}${setId}`;
            const cached = localStorage.getItem(cacheKey);
            if (cached) {
              try {
                const { data } = JSON.parse(cached);
                setSetCardsData(data.cards || []);
                setLoadingSetCards(false);
                if (data.setDetails) {
                  setSelectedSetData((prev) => ({
                    ...prev,
                    ...data.setDetails,
                    release_date:
                      data.setDetails.release_date ||
                      data.setDetails.published_on ||
                      prev?.release_date,
                  }));
                }
                return;
              } catch (e) {
                // Invalid cache
              }
            }
          }
          setSetCardsData([]);
          setLoadingSetCards(false);
        }
      }
    };

    // Only load if cards aren't already loaded (they might be from handleSetClickWithData or restored from history)
    // This prevents clearing already-loaded cached data or restored cards
    if (setCardsData.length === 0) {
      console.log(
        "📋 [NAV DEBUG] useEffect: No cards loaded, loading from API/cache"
      );
      loadSetCards(true, false);
    } else {
      // Cards already loaded (from cache or restored from history), just refresh in background silently
      console.log(
        "📋 [NAV DEBUG] useEffect: Cards already loaded (" +
          setCardsData.length +
          " cards), skipping reload"
      );
      // Don't reload if cards are already loaded - they might be restored from history
      // Only refresh in background if we're not restoring from history
      // loadSetCards(false, true);
    }

    // Cleanup function to cancel if component unmounts or set changes
    return () => {
      cancelled = true;
      currentSetId = null;
    };
  }, [selectedSet, showSetPage, selectedSetData]);

  // Load market value data when selectedCard changes
  useEffect(() => {
    const loadMarketValueData = async () => {
      if (!selectedCard) {
        setMarketValueData({
          currentPrice: 0,
          absoluteChange: 0,
          percentageChange: 0,
          isPositive: false,
        });
        return;
      }

      try {
        // Use real card data as primary source
        const currentPrice =
          selectedCard.current_value || selectedCard.price || 0;

        console.log("Market value debug:", {
          cardName: selectedCard.name,
          current_value: selectedCard.current_value,
          price: selectedCard.price,
          finalPrice: currentPrice,
          cardId: selectedCard.cardId,
          product_id: selectedCard.product_id,
        });

        // Try to get chart data for price changes, but don't rely on it for current price
        const chartData = await getCardChartData(
          selectedCard,
          cardChartTimeRange,
          "Normal",
          "raw",
          "PSA",
          "10"
        );

        console.log("Chart data loaded:", {
          hasDatasets: !!chartData.datasets,
          datasetLength: chartData.datasets?.length || 0,
          dataLength: chartData.datasets?.[0]?.data?.length || 0,
          absoluteChange: chartData.absoluteChange,
          percentageChange: chartData.percentageChange,
        });

        // Use chart data for changes, but prioritize real card data for current price
        const absoluteChange = chartData.absoluteChange || 0;
        const percentageChange = chartData.percentageChange || 0;

        setMarketValueData({
          currentPrice: currentPrice,
          absoluteChange: absoluteChange,
          percentageChange: percentageChange,
          isPositive: absoluteChange >= 0,
        });
      } catch (error) {
        console.error("Error loading market value data:", error);
        // Use real card data as fallback
        const currentPrice =
          selectedCard.current_value || selectedCard.price || 0;
        setMarketValueData({
          currentPrice: currentPrice,
          absoluteChange: 0,
          percentageChange: 0,
          isPositive: false,
        });
      }
    };

    loadMarketValueData();
  }, [selectedCard, cardChartTimeRange, getCurrentPrice, selectedCardVariant]);

  // Card chart options
  const cardChartOptions = {
    responsive: true,
    maintainAspectRatio: false,
    plugins: {
      legend: {
        display: false,
      },
      tooltip: {
        backgroundColor: "rgba(0, 0, 0, 0.8)",
        titleColor: "#F9F9F9",
        bodyColor: "#F9F9F9",
        borderColor: "#605DEC",
        borderWidth: 1,
        callbacks: {
          label: function (context) {
            return `Price: $${context.parsed.y.toFixed(2)}`;
          },
        },
      },
    },
    scales: {
      x: {
        grid: {
          display: false,
        },
        ticks: {
          color: "#9CA3AF",
          font: {
            size: 10,
          },
        },
      },
      y: {
        beginAtZero: true,
        grid: {
          color: "rgba(156, 163, 175, 0.1)",
        },
        ticks: {
          color: "#9CA3AF",
          font: {
            size: 10,
          },
          callback: function (value) {
            return `$${value.toFixed(2)}`;
          },
        },
      },
    },
    interaction: {
      intersect: false,
      mode: "index",
    },
  };

  // Get theme-aware chart colors
  const getChartColors = () => {
    const isDark = document.documentElement.classList.contains("dark");
    return {
      gridColor: isDark
        ? "rgba(156, 163, 175, 0.1)"
        : "rgba(210, 211, 219, 0.4)",
      tickColor: isDark ? "#9CA3AF" : "#9394a5",
      tooltipBg: isDark ? "rgba(0, 0, 0, 0.9)" : "rgba(250, 250, 250, 0.98)",
      tooltipText: isDark ? "#F9F9F9" : "#484b6a",
      tooltipBorder: "#6865E7",
    };
  };

  // Make chart options reactive to theme changes
  const chartOptions = useMemo(() => {
    const colors = getChartColors();
    return {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          display: false,
        },
        tooltip: {
          backgroundColor: colors.tooltipBg,
          titleColor: colors.tooltipText,
          bodyColor: colors.tooltipText,
          borderColor: colors.tooltipBorder,
          borderWidth: 1,
          padding: 12,
          titleFont: {
            size: 14,
            weight: "bold",
          },
          bodyFont: {
            size: 13,
          },
          callbacks: {
            label: function (context) {
              return `Value: ${formatCurrency(context.parsed.y)}`;
            },
          },
        },
      },
      scales: {
        x: {
          grid: {
            display: false,
          },
          ticks: {
            color: colors.tickColor,
            font: {
              size: 12,
              weight: "500",
            },
          },
        },
        y: {
          beginAtZero: true,
          grid: {
            color: colors.gridColor,
          },
          ticks: {
            color: colors.tickColor,
            font: {
              size: 12,
              weight: "500",
            },
            callback: function (value) {
              return formatCurrency(value);
            },
          },
        },
      },
      interaction: {
        intersect: false,
        mode: "index",
      },
    };
  }, [theme, isDark]); // Re-compute when theme changes

  // Swipe handlers
  const minSwipeDistance = 50;

  const onTouchStart = (e) => {
    setTouchEnd(null);
    setTouchStart(e.targetTouches[0].clientX);
  };

  const onTouchMove = (e) => {
    setTouchEnd(e.targetTouches[0].clientX);
  };

  const onTouchEnd = () => {
    if (!touchStart || !touchEnd) return;
    const distance = touchStart - touchEnd;
    const isLeftSwipe = distance > minSwipeDistance;
    const isRightSwipe = distance < -minSwipeDistance;

    if (isLeftSwipe && currentOnboardingStep < 2) {
      handleNextOnboarding();
    }
    if (isRightSwipe && currentOnboardingStep > 0) {
      handlePreviousOnboarding();
    }
  };

  // Google OAuth handler
  const handleGoogleAuth = async () => {
    try {
      // Get Google OAuth URL from backend
      const response = await fetch(
        `${API_URL}/api/auth/google?state=${currentScreen}`
      );
      const data = await response.json();

      if (data.success && data.authUrl) {
        // Redirect to Google OAuth
        window.location.href = data.authUrl;
      } else {
        // Show more helpful error message
        const errorMsg = data.error || "Failed to get Google OAuth URL";
        if (
          errorMsg.includes("not configured") ||
          errorMsg.includes("GOOGLE_CLIENT_ID")
        ) {
          alert(
            "Google OAuth is not configured yet. Please add your Google OAuth credentials to server/.env file. See GOOGLE_OAUTH_SETUP.md for instructions."
          );
        } else {
          alert(`Google authentication failed: ${errorMsg}`);
        }
        throw new Error(errorMsg);
      }
    } catch (error) {
      console.error("Google authentication error:", error);
      // Only show generic error if it's a network error
      if (error.message && !error.message.includes("not configured")) {
        alert(
          "Google authentication failed. Please check that the API server is running and try again."
        );
      }
    }
  };

  // Handle Google OAuth callback
  useEffect(() => {
    const handleGoogleCallback = async () => {
      const urlParams = new URLSearchParams(window.location.search);
      const token = urlParams.get("token");
      const error = urlParams.get("error");

      if (error) {
        alert(`Authentication failed: ${error}`);
        setCurrentScreen("login");
        return;
      }

      if (token && loginWithGoogle) {
        const result = await loginWithGoogle(token);

        if (result.success) {
          // Clear URL params
          window.history.replaceState(
            {},
            document.title,
            window.location.pathname
          );

          // Clear pricing alerts state to prevent showing guest data
          setPricingAlerts([]);

          // Redirect to main app
          setCurrentScreen("main-app");
        } else {
          alert(
            result.error ||
              "Failed to complete authentication. Please try again."
          );
          setCurrentScreen("login");
        }
      }
    };

    // Check if we're on the callback page
    if (
      window.location.pathname === "/auth/google/success" ||
      window.location.search.includes("token=")
    ) {
      handleGoogleCallback();
    }
  }, [loginWithGoogle]);

  // Apple OAuth handler
  const handleAppleAuth = async () => {
    try {
      console.log(`Apple ${currentScreen} initiated`);
      alert(
        `Apple ${currentScreen} successful! (This is a demo - in production this would redirect to Apple Sign In)`
      );
    } catch (error) {
      console.error("Apple authentication error:", error);
      alert("Apple authentication failed. Please try again.");
    }
  };

  // Email signup handler
  const handleEmailSignup = async () => {
    try {
      console.log("Email signup initiated");
      setCurrentScreen("manual-signup");
    } catch (error) {
      console.error("Email signup error:", error);
      alert("Email signup failed. Please try again.");
    }
  };

  // Manual signup form handler
  const handleManualSignup = async () => {
    try {
      // Validate required fields
      if (
        !firstName ||
        !lastName ||
        !signupEmail ||
        !dateOfBirth ||
        !phoneNumber ||
        !username ||
        !signupPassword ||
        !confirmSignupPassword
      ) {
        alert("Please fill in all required fields");
        return;
      }

      if (signupPassword !== confirmSignupPassword) {
        alert("Passwords do not match");
        return;
      }

      if (signupPassword.length < 6) {
        alert("Password must be at least 6 characters long");
        return;
      }

      // Simulate account creation
      console.log("Account created:", {
        firstName,
        lastName,
        email: signupEmail,
        dateOfBirth,
        phoneNumber,
        username,
      });

      alert("Account created successfully! You can now log in.");
      setCurrentScreen("login");

      // In a real app, you would:
      // 1. Validate all form data
      // 2. Check if email/username already exists
      // 3. Hash password
      // 4. Create user account in database
      // 5. Send verification email
      // 6. Redirect to login or dashboard
    } catch (error) {
      console.error("Manual signup error:", error);
      alert("Account creation failed. Please try again.");
    }
  };

  // Forgot password handler
  const handleForgotPassword = async () => {
    try {
      if (!email) {
        alert("Please enter your email address");
        return;
      }

      // Simulate sending reset email
      console.log("Password reset email sent to:", email);
      alert(
        `Password reset email sent to ${email}! (This is a demo - in production this would send a real email)`
      );

      // In a real app, you would:
      // 1. Validate email format
      // 2. Check if email exists in database
      // 3. Generate reset token
      // 4. Send email with reset link
      // 5. Store token in database with expiration
    } catch (error) {
      console.error("Forgot password error:", error);
      alert("Failed to send reset email. Please try again.");
    }
  };

  // Load pricing alerts from database
  const loadPricingAlerts = async () => {
    if (isAuthenticated && user?.id) {
      try {
        // Clear existing alerts first to prevent showing stale data
        setPricingAlerts([]);
        // Load user-specific alerts from backend API
        const alerts = await getPricingAlerts();
        if (alerts && Array.isArray(alerts)) {
          setPricingAlerts(alerts);
        } else {
          setPricingAlerts([]);
        }
      } catch (error) {
        console.error("Error loading pricing alerts:", error);
        // On error, ensure alerts are cleared
        setPricingAlerts([]);
      }
    } else {
      // Not authenticated - clear alerts
      setPricingAlerts([]);
    }
  };

  // Helper function to normalize set names for matching
  const normalizeSetName = (name) => {
    if (!name) return "";
    // Remove prefixes like "ME01: ", "SV01: ", etc.
    return name
      .replace(/^[A-Z]{2,3}\d{1,2}:\s*/i, "") // Remove "ME01: ", "SV01: " etc.
      .replace(/^[A-Z]{2,3}\d{1,2}\s*/i, "") // Remove "ME01 ", "SV01 " etc.
      .trim()
      .toLowerCase();
  };

  // Load set progression from localStorage collection data
  const loadSetProgression = async () => {
    if (userData?.collections) {
      try {
        // Get all cards from all collections
        const allCollectedCards = [];
        userData.collections.forEach((collection) => {
          if (collection.cards && collection.cards.length > 0) {
            collection.cards.forEach((card) => {
              allCollectedCards.push(card);
            });
          }
        });

        if (allCollectedCards.length === 0) {
          setSetProgression([]);
          return;
        }

        // Group cards by set
        const setGroups = {};
        allCollectedCards.forEach((card) => {
          const setName =
            card.clean_set_name || card.set_name || card.set || "Unknown Set";
          if (!setGroups[setName]) {
            setGroups[setName] = {
              name: setName,
              cards: [],
              collectedCount: 0,
            };
          }
          setGroups[setName].cards.push(card);
          setGroups[setName].collectedCount += card.quantity || 1;
        });

        // Fetch set information from database to get total counts
        const progressionData = [];
        for (const [setName, setData] of Object.entries(setGroups)) {
          try {
            // Try to find the set in the database
            const response = await fetch(`${API_URL}/api/sets?t=${Date.now()}`);
            if (response.ok) {
              const result = await response.json();
              // Try to match set by name (normalized, case-insensitive)
              const normalizedSetName = normalizeSetName(setName);
              const dbSet = result.data.find((s) => {
                const dbName = normalizeSetName(s.name || "");
                // Try exact match first
                if (dbName === normalizedSetName) return true;
                // Try partial matches
                if (dbName && normalizedSetName) {
                  return (
                    dbName.includes(normalizedSetName) ||
                    normalizedSetName.includes(dbName) ||
                    // Also try matching the original name without normalization
                    (s.name || "").trim().toLowerCase() ===
                      setName.trim().toLowerCase()
                  );
                }
                return false;
              });

              if (dbSet) {
                // Get total count from various possible field names
                const totalCount =
                  dbSet.cards_total ||
                  dbSet.total_cards ||
                  dbSet.printed_total ||
                  dbSet.card_count ||
                  dbSet.cards_with_pricing ||
                  0;

                const percentage =
                  totalCount > 0
                    ? Math.round((setData.collectedCount / totalCount) * 100)
                    : 0;

                progressionData.push({
                  id:
                    dbSet.id ||
                    dbSet.group_id ||
                    setName.toLowerCase().replace(/\s+/g, "-"),
                  name: setName,
                  series: dbSet.series || "Unknown",
                  releaseDate: dbSet.release_date || dbSet.published_on,
                  collectedCount: setData.collectedCount,
                  totalCount: totalCount,
                  percentage: percentage,
                });
              } else {
                // Fallback if set not found in database
                progressionData.push({
                  id: setName.toLowerCase().replace(/\s+/g, "-"),
                  name: setName,
                  series: "Unknown",
                  releaseDate: null,
                  collectedCount: setData.collectedCount,
                  totalCount: 0, // Show 0 if we don't know the total
                  percentage: 0,
                });
              }
            } else {
              // API response not ok
              progressionData.push({
                id: setName.toLowerCase().replace(/\s+/g, "-"),
                name: setName,
                series: "Unknown",
                releaseDate: null,
                collectedCount: setData.collectedCount,
                totalCount: 0,
                percentage: 0,
              });
            }
          } catch (error) {
            console.error(`Error fetching set info for ${setName}:`, error);
            // Fallback
            progressionData.push({
              id: setName.toLowerCase().replace(/\s+/g, "-"),
              name: setName,
              series: "Unknown",
              releaseDate: null,
              collectedCount: setData.collectedCount,
              totalCount: 0,
              percentage: 0,
            });
          }
        }

        // Sort by release date (newest first) and take top 10
        const sortedProgression = progressionData
          .sort((a, b) => {
            if (!a.releaseDate && !b.releaseDate) return 0;
            if (!a.releaseDate) return 1;
            if (!b.releaseDate) return -1;
            return new Date(b.releaseDate) - new Date(a.releaseDate);
          })
          .slice(0, 10);

        setSetProgression(sortedProgression);
      } catch (error) {
        console.error("Error loading set progression:", error);
        setSetProgression([]);
      }
    } else {
      console.log("Not authenticated or no user data");
      setSetProgression([]);
    }
  };

  // Fetch current prices for pricing alerts
  const fetchAlertCurrentPrices = async () => {
    // Only fetch if user is authenticated and has alerts
    if (!isAuthenticated || !user?.id || pricingAlerts.length === 0) {
      return;
    }

    try {
      // Filter alerts to only process valid ones
      const validAlerts = pricingAlerts.filter(
        (alert) => alert && alert.card_id
      );

      if (validAlerts.length === 0) {
        setPricingAlerts([]);
        return;
      }

      const updatedAlerts = await Promise.all(
        validAlerts.map(async (alert) => {
          try {
            // Fetch current price from the database
            const response = await fetch(
              `${API_URL}/api/cards/${alert.card_id}?t=${Date.now()}`
            );
            if (response.ok) {
              const data = await response.json();
              const currentPrice =
                data.data?.current_value || data.data?.price || 0;
              return {
                ...alert,
                currentPrice: currentPrice,
              };
            } else {
              console.warn(`Failed to fetch price for card ${alert.card_id}`);
              return {
                ...alert,
                currentPrice: null,
              };
            }
          } catch (error) {
            console.error(
              `Error fetching price for ${alert.card_name}:`,
              error
            );
            return {
              ...alert,
              currentPrice: null,
            };
          }
        })
      );

      // Only update if still authenticated and user hasn't changed
      if (isAuthenticated && user?.id) {
        setPricingAlerts(updatedAlerts);
      }
    } catch (error) {
      console.error("Error fetching alert prices:", error);
    }
  };

  // Delete pricing alert handler
  const handleDeletePricingAlert = async (alertId) => {
    const result = await deletePricingAlert(alertId);
    if (result.success) {
      setPricingAlerts((prev) => prev.filter((alert) => alert.id !== alertId));
    } else {
      alert(`Failed to delete alert: ${result.error}`);
    }
  };

  // Reset password handler
  const handleResetPassword = async () => {
    try {
      if (!newPassword || !confirmPassword) {
        alert("Please fill in all password fields");
        return;
      }

      if (newPassword !== confirmPassword) {
        alert("Passwords do not match");
        return;
      }

      if (newPassword.length < 6) {
        alert("Password must be at least 6 characters long");
        return;
      }

      // Simulate password reset
      console.log("Password reset successful for token:", resetToken);
      alert(
        "Password reset successful! You can now log in with your new password."
      );
      setCurrentScreen("login");

      // In a real app, you would:
      // 1. Validate reset token
      // 2. Check token expiration
      // 3. Hash new password
      // 4. Update password in database
      // 5. Invalidate reset token
    } catch (error) {
      console.error("Reset password error:", error);
      alert("Failed to reset password. Please try again.");
    }
  };

  // Collection Value Chart Component
  const CollectionValueChart = ({ collectionId, timeRange, className }) => {
    const [chartData, setChartData] = useState({
      labels: [],
      datasets: [],
    });
    const [loading, setLoading] = useState(true);

    useEffect(() => {
      const loadCollectionChartData = async () => {
        setLoading(true);
        try {
          // Generate collection history data based on the selected collection and time range
          const currentCollection = userData?.collections?.find(
            (c) => c.id === collectionId
          );
          if (!currentCollection) {
            setChartData({
              labels: [],
              datasets: [],
            });
            setLoading(false);
            return;
          }

          // Generate realistic collection value history
          const history = generateCollectionHistoryData(
            timeRange,
            currentCollection.totalValue
          );

          const labels = history.map((point) => {
            const date = new Date(point.date);
            if (timeRange === "1D" || timeRange === "7D") {
              return date.toLocaleDateString("en-US", {
                month: "short",
                day: "numeric",
              });
            } else if (timeRange === "1M" || timeRange === "3M") {
              return date.toLocaleDateString("en-US", {
                month: "short",
                day: "numeric",
              });
            } else if (
              timeRange === "6M" ||
              timeRange === "1Y" ||
              timeRange === "Max"
            ) {
              return date.toLocaleDateString("en-US", {
                month: "short",
                day: "numeric",
              });
            }
            return date.toLocaleDateString("en-US", {
              month: "short",
              day: "numeric",
            });
          });

          const values = history.map((point) => point.value);

          const colors = getChartDatasetColors();
          setChartData({
            labels,
            datasets: [
              {
                label: "Collection Value",
                data: values,
                borderColor: colors.borderColor,
                backgroundColor: colors.backgroundColor,
                borderWidth: 2,
                fill: true,
                tension: 0.4,
                pointBackgroundColor: colors.pointBackgroundColor,
                pointBorderColor: colors.pointBorderColor,
                pointBorderWidth: 2,
                pointRadius: 0,
                pointHoverRadius: 6,
              },
            ],
          });
        } catch (error) {
          console.error("Error loading collection chart data:", error);
          setChartData({
            labels: [],
            datasets: [],
          });
        } finally {
          setLoading(false);
        }
      };

      loadCollectionChartData();
    }, [collectionId, timeRange, userData, theme, isDark]); // Re-compute when theme changes

    if (loading) {
      return (
        <div className={`${className} flex items-center justify-center`}>
          <div className="text-gray-400 text-sm">Loading chart...</div>
        </div>
      );
    }

    if (chartData.labels.length === 0) {
      return (
        <div className={`${className} flex items-center justify-center`}>
          <div className="text-gray-400 text-sm">No data available</div>
        </div>
      );
    }

    return (
      <Line data={chartData} options={chartOptions} className={className} />
    );
  };

  // Handle scan completion - add card to collection
  const handleScanComplete = async (card) => {
    try {
      if (card.manualEntry) {
        // For manual entries, show search modal
        setShowScanner(false);

        // If there's a search query, use it; otherwise just open search
        if (card.searchQuery) {
          setSearchQuery(card.searchQuery);
          // Small delay to ensure scanner is closed before opening search
          setTimeout(() => {
            handleSearch();
          }, 100);
        } else {
          // Navigate to search screen (home tab) instead of marketplace
          setActiveTab("home");
          setNavigationMode("home");
          // Focus on search input
          setTimeout(() => {
            const searchInput = document.getElementById("search-input");
            if (searchInput) {
              searchInput.focus();
            }
          }, 200);
        }
        return;
      }

      // Add scanned card to collection
      if (card.product_id || card.id) {
        // Pass all card data to ensure correct display in add modal
        setCardToAdd({
          id: card.product_id || card.id,
          product_id: card.product_id || card.id,
          name: card.clean_name || card.name,
          clean_name: card.clean_name || card.name,
          imageUrl: card.image_url,
          image_url: card.image_url, // Use image_url for getCardImageUrl compatibility
          set_name: card.set_name || card.clean_set_name,
          clean_set_name: card.clean_set_name || card.set_name,
          number: card.ext_number || card.number,
          ext_number: card.ext_number || card.number,
          ext_rarity: card.ext_rarity || card.rarity,
          current_value:
            card.current_value ||
            card.price ||
            card.market_price ||
            card.mid_price ||
            card.low_price ||
            0,
          price:
            card.price ||
            card.current_value ||
            card.market_price ||
            card.mid_price ||
            card.low_price ||
            0,
          market_price: card.market_price,
          mid_price: card.mid_price,
          low_price: card.low_price,
          images:
            card.images ||
            (card.image_url
              ? { small: card.image_url, large: card.image_url }
              : null),
          // Include all matches for review toggle if available
          allMatches: card.allMatches || [],
          showMatchesToggle: card.showMatchesToggle || false,
          // Include all other card properties for completeness
          ...card,
        });
        setShowAddToCollectionModal(true);
        setShowScanner(false);
      }
    } catch (error) {
      console.error("Error handling scan completion:", error);
      alert("Failed to add scanned card. Please try again.");
    }
  };

  // Card Scanner Interface
  if (showScanner) {
    return (
      <CardScanner
        onScanComplete={handleScanComplete}
        onClose={() => setShowScanner(false)}
      />
    );
  }

  // Legacy scanner placeholder (kept for reference)
  if (false && showScanner) {
    return (
      <div
        className="fixed inset-0 z-[60] flex flex-col"
        style={{ backgroundColor: "#01010C" }}
      >
        {/* Header */}
        <div className="px-4 py-4" style={{ backgroundColor: "#02030D" }}>
          <div className="flex justify-between items-center">
            {/* Close Button */}
            <button
              onClick={() => setShowScanner(false)}
              className="w-10 h-10 rounded-full flex items-center justify-center"
              style={{ backgroundColor: "rgba(32, 32, 32, 0.65)" }}
            >
              <svg
                width="28"
                height="28"
                viewBox="0 0 28 28"
                fill="none"
                xmlns="http://www.w3.org/2000/svg"
              >
                <rect
                  x="0.5"
                  y="0.5"
                  width="27"
                  height="27"
                  rx="13.5"
                  fill="#202020"
                  fillOpacity="0.65"
                />
                <rect
                  x="0.5"
                  y="0.5"
                  width="27"
                  height="27"
                  rx="13.5"
                  stroke="white"
                />
                <path
                  d="M9 9L19 19M9 19L19 9"
                  stroke="white"
                  strokeWidth="2"
                  strokeLinecap="round"
                  strokeLinejoin="round"
                />
              </svg>
            </button>

            {/* Header Text */}
            <div className="flex-1 text-center">
              <h1 className="dark:text-white text-theme-primary text-lg font-bold">
                Scan Card
              </h1>
            </div>

            {/* Flash Toggle */}
            <button
              onClick={() => setFlashEnabled(!flashEnabled)}
              className="w-10 h-10 rounded-full flex items-center justify-center"
              style={{ backgroundColor: "rgba(32, 32, 32, 0.65)" }}
            >
              {flashEnabled ? (
                <svg
                  width="28"
                  height="28"
                  viewBox="0 0 28 28"
                  fill="none"
                  xmlns="http://www.w3.org/2000/svg"
                >
                  <rect
                    x="0.5"
                    y="0.5"
                    width="27"
                    height="27"
                    rx="13.5"
                    fill="#202020"
                    fillOpacity="0.65"
                  />
                  <rect
                    x="0.5"
                    y="0.5"
                    width="27"
                    height="27"
                    rx="13.5"
                    stroke="#605DEC"
                  />
                  <path
                    d="M11.3307 6C10.854 6 10.4356 6.31395 10.3039 6.76988L8.04116 14.6427C7.99568 14.8008 7.98777 14.9672 8.01803 15.1289C8.0483 15.2906 8.11592 15.4431 8.21557 15.5743C8.31522 15.7056 8.44417 15.812 8.59226 15.8853C8.74036 15.9585 8.90354 15.9966 9.06894 15.9964H10.3431L9.16649 20.6757C8.901 21.7306 10.2134 22.4524 10.9727 21.6706L19.6977 12.8139L19.7018 12.8099C20.3454 12.143 19.8828 10.9992 18.9304 10.9992H16.3519L17.621 7.40578L17.6231 7.39778C17.6766 7.23812 17.6912 7.06808 17.6657 6.90169C17.6402 6.73531 17.5752 6.57734 17.4762 6.44082C17.3772 6.30429 17.247 6.19312 17.0963 6.11648C16.9455 6.03984 16.7786 5.99991 16.6094 6H11.3307Z"
                    fill="#605DEC"
                  />
                </svg>
              ) : (
                <svg
                  width="28"
                  height="28"
                  viewBox="0 0 28 28"
                  fill="none"
                  xmlns="http://www.w3.org/2000/svg"
                >
                  <rect
                    x="0.5"
                    y="0.5"
                    width="27"
                    height="27"
                    rx="13.5"
                    fill="#202020"
                    fillOpacity="0.65"
                  />
                  <rect
                    x="0.5"
                    y="0.5"
                    width="27"
                    height="27"
                    rx="13.5"
                    stroke="white"
                  />
                  <path
                    d="M10.2977 6.81624C10.3716 6.58025 10.5235 6.37331 10.7308 6.22623C10.9381 6.07916 11.1898 5.99981 11.4482 6H16.7342C16.928 6.00007 17.1189 6.04488 17.2906 6.13058C17.4622 6.21629 17.6095 6.34035 17.7199 6.49215C17.8303 6.64395 17.9004 6.81896 17.9243 7.00222C17.9482 7.18548 17.9252 7.37153 17.8571 7.54445L16.6658 10.5728H19.1012C19.2704 10.573 19.4362 10.6186 19.5794 10.7045C19.7226 10.7903 19.8375 10.9129 19.9109 11.0582C19.9843 11.2035 20.0133 11.3655 19.9944 11.5257C19.9755 11.686 19.9096 11.8379 19.8043 11.964L11.8777 21.4525C10.8532 22.6792 8.80403 21.6674 9.26472 20.163L10.8004 15.1455H8.90121C8.76098 15.1457 8.62264 15.1147 8.49722 15.0549C8.37181 14.9952 8.2628 14.9083 8.17888 14.8012C8.09497 14.6941 8.03848 14.5699 8.01391 14.4383C7.98935 14.3068 7.99739 14.1716 8.03741 14.0435L10.2977 6.81624Z"
                    fill="white"
                  />
                </svg>
              )}
            </button>
          </div>
        </div>

        {/* Camera Viewfinder */}
        <div className="flex-1 relative overflow-hidden">
          {/* Camera Feed Placeholder */}
          <div
            className="w-full h-full flex items-center justify-center"
            style={{ backgroundColor: "#1a1a1a" }}
          >
            <div className="text-center">
              <p className="dark:text-white/70 text-theme-secondary text-sm">
                Camera feed will appear here
              </p>
              <p className="dark:text-white/50 text-theme-tertiary text-xs mt-1">
                Position card within the guide
              </p>
            </div>
          </div>

          {/* Card Alignment Guide */}
          <div className="absolute inset-0 flex items-center justify-center pointer-events-none">
            {/* Darkened Overlay */}
            <div
              className="absolute inset-0"
              style={{ backgroundColor: "rgba(0, 0, 0, 0.3)" }}
            ></div>

            {/* Card Frame Cutout */}
            <div className="relative">
              {/* Card Border - matches the design */}
              <div
                className="border-4 rounded-lg bg-transparent"
                style={{
                  width: "307px",
                  height: "413px",
                  borderColor: "#605DEC",
                }}
              >
                {/* Corner Guides */}
                <div className="absolute -top-3 -left-3">
                  <div className="w-6 h-6 border-l-4 border-t-4 border-white rounded-tl-lg"></div>
                </div>
                <div className="absolute -top-3 -right-3">
                  <div className="w-6 h-6 border-r-4 border-t-4 border-white rounded-tr-lg"></div>
                </div>
                <div className="absolute -bottom-3 -left-3">
                  <div className="w-6 h-6 border-l-4 border-b-4 border-white rounded-bl-lg"></div>
                </div>
                <div className="absolute -bottom-3 -right-3">
                  <div className="w-6 h-6 border-r-4 border-b-4 border-white rounded-br-lg"></div>
                </div>
              </div>
            </div>
          </div>
        </div>

        {/* Bottom Controls */}
        <div className="flex items-center justify-center gap-8 p-6 pb-12">
          {/* Edit Button */}
          <button
            onClick={handleEditSettings}
            className="w-16 h-16 flex items-center justify-center"
          >
            <img src="/Assets/edit.svg" alt="Edit" className="w-8 h-8" />
          </button>

          {/* Manual Scan Button */}
          <button
            onClick={handleManualScan}
            className="w-20 h-20 flex items-center justify-center"
          >
            <img src="/Assets/Scan.svg" alt="Scan" className="w-20 h-20" />
          </button>

          {/* Gallery Button */}
          <button
            onClick={handleGallerySelect}
            className="w-16 h-16 flex items-center justify-center"
          >
            <img
              src="/Assets/gallery-circle-bold.svg"
              alt="Gallery"
              className="w-8 h-8"
            />
          </button>
        </div>

        {/* Edit Modal - Compact Design */}
        {showEditModal && (
          <div className="fixed inset-0 bg-black/50 z-[70] flex items-center justify-center p-4">
            <div className="bg-[#2b2b2b] rounded-2xl w-full max-w-sm border border-gray-700/50 shadow-2xl">
              {/* Modal Header */}
              <div className="flex items-center justify-between p-4 border-b border-gray-700/50">
                <h2 className="dark:text-white text-theme-primary text-lg font-bold">
                  Scan Settings
                </h2>
                <button
                  onClick={handleEditModalClose}
                  className="w-8 h-8 dark:bg-gray-700 bg-gray-300 rounded-full flex items-center justify-center dark:hover:bg-gray-600 hover:bg-gray-400 transition-colors"
                >
                  <svg
                    className="w-4 h-4 dark:text-white text-theme-primary"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      strokeLinecap="round"
                      strokeLinejoin="round"
                      strokeWidth="2"
                      d="M6 18L18 6M6 6l12 12"
                    />
                  </svg>
                </button>
              </div>

              {/* Settings Options */}
              <div className="p-4">
                {/* Folder Selection */}
                <div className="mb-4">
                  <h3 className="dark:text-white text-theme-primary text-sm font-medium mb-2">
                    Collection
                  </h3>
                  <div className="grid grid-cols-2 gap-2">
                    {["Collection", "Wishlist", "Trading", "Selling"].map(
                      (folder) => (
                        <button
                          key={folder}
                          onClick={() => setSelectedFolder(folder)}
                          className={`px-3 py-2 rounded-lg text-sm font-medium transition-colors ${
                            selectedFolder === folder
                              ? "bg-[#6865E7] text-white"
                              : "dark:bg-gray-700 bg-gray-300 dark:text-white/70 text-theme-primary dark:hover:bg-gray-600 hover:bg-gray-400"
                          }`}
                        >
                          {folder}
                        </button>
                      )
                    )}
                  </div>
                </div>

                {/* Condition Selection */}
                <div className="mb-6">
                  <h3 className="dark:text-white text-theme-primary text-sm font-medium mb-2">
                    Condition
                  </h3>
                  <div className="grid grid-cols-2 gap-2">
                    {[
                      "Mint",
                      "Near Mint",
                      "Lightly Played",
                      "Moderately Played",
                      "Heavily Played",
                      "Damaged",
                    ].map((condition) => (
                      <button
                        key={condition}
                        onClick={() => setSelectedCondition(condition)}
                        className={`px-3 py-2 rounded-lg text-xs font-medium transition-colors ${
                          selectedCondition === condition
                            ? "bg-[#6865E7] text-white"
                            : "dark:bg-gray-700 bg-gray-300 dark:text-white/70 text-theme-primary dark:hover:bg-gray-600 hover:bg-gray-400"
                        }`}
                      >
                        {condition}
                      </button>
                    ))}
                  </div>
                </div>

                {/* Default Language Selection */}
                <div className="mb-6">
                  <h3 className="dark:text-white text-theme-primary text-sm font-medium mb-2">
                    Default Language
                  </h3>
                  <div className="grid grid-cols-2 gap-2">
                    {[
                      { value: "english", label: "English" },
                      { value: "japanese", label: "Japanese" },
                      { value: "chinese", label: "Chinese" },
                    ].map((lang) => (
                      <button
                        key={lang.value}
                        onClick={() => setDefaultLanguage(lang.value)}
                        className={`px-3 py-2 rounded-lg text-xs font-medium transition-colors ${
                          defaultLanguage === lang.value
                            ? "bg-[#6865E7] text-white"
                            : "dark:bg-gray-700 bg-gray-300 dark:text-white/70 text-theme-primary dark:hover:bg-gray-600 hover:bg-gray-400"
                        }`}
                      >
                        {lang.label}
                      </button>
                    ))}
                  </div>
                </div>

                {/* Save Button */}
                <button
                  onClick={handleEditModalClose}
                  className="w-full bg-gradient-to-r from-[#6865E7] to-[#5A57D1] hover:from-[#5A57D1] hover:to-[#4C49BB] text-white py-3 rounded-lg font-semibold text-sm transition-all duration-300 shadow-lg shadow-[#6865E7]/25"
                >
                  Save Settings
                </button>
              </div>
            </div>
          </div>
        )}

        {/* Scan Confirmation Modal */}
        {showScanConfirm && (
          <div className="fixed inset-0 z-[70] flex items-end pointer-events-none">
            {/* No backdrop - allows camera to remain visible */}

            {/* Confirmation Card - Horizontal Layout */}
            <div
              className={`relative bg-[rgba(32,32,32,0.95)] border border-white/20 rounded-lg p-3 w-full max-w-sm mx-auto transition-opacity duration-500 shadow-2xl ${
                isScanConfirmFading ? "opacity-0" : "opacity-100"
              }`}
              style={{
                marginBottom: "165px",
              }}
            >
              <div className="flex items-center justify-between gap-1">
                {/* Left side - Card Image */}
                <div className="w-[45.63px] h-[63.275px] bg-gray-700 rounded-lg shrink-0 overflow-hidden">
                  {scannedCard && scannedCard.imageUrl ? (
                    <img
                      src={scannedCard.imageUrl}
                      alt={scannedCard.name}
                      className="w-full h-full object-cover"
                      onError={(e) => {
                        e.target.style.display = "none";
                        e.target.nextSibling.style.display = "flex";
                      }}
                    />
                  ) : null}
                  <div
                    className="w-full h-full flex items-center justify-center"
                    style={{
                      display:
                        scannedCard && scannedCard.imageUrl ? "none" : "flex",
                    }}
                  >
                    <svg
                      className="w-6 h-6 dark:text-white/50 text-theme-tertiary"
                      fill="none"
                      stroke="currentColor"
                      viewBox="0 0 24 24"
                    >
                      <path
                        strokeLinecap="round"
                        strokeLinejoin="round"
                        strokeWidth={2}
                        d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"
                      />
                    </svg>
                  </div>
                </div>

                {/* Middle section - Card Details */}
                <div className="flex-1 flex flex-col items-start gap-1">
                  {/* Card Name */}
                  <div className="dark:text-white text-theme-primary text-xs font-bold leading-tight">
                    {scannedCard ? scannedCard.name : ""}
                  </div>

                  {/* Card Details */}
                  <div className="flex flex-col items-start dark:text-white/70 text-theme-secondary text-[10px] leading-tight">
                    <div>{scannedCard ? scannedCard.set : ""}</div>
                    <div>{scannedCard ? scannedCard.rarity : ""}</div>
                    <div>{scannedCard ? scannedCard.formattedNumber : ""}</div>
                  </div>
                </div>

                {/* Right side - Price and Status */}
                <div className="flex flex-col items-end justify-between h-[63.275px]">
                  {/* Price */}
                  <div className="text-[#8871FF] text-base font-black text-center">
                    {scannedCard
                      ? `$${scannedCard.price.toLocaleString()}`
                      : ""}
                  </div>

                  {/* Success message */}
                  <div className="text-green-400 text-xs font-medium text-center">
                    {scannedCard ? `✓ Added to ${scannedCard.folder}` : ""}
                  </div>
                </div>
              </div>
            </div>
          </div>
        )}
      </div>
    );
  }

  // Set Page Component (renders when card profile is not open)
  if (showSetPage && selectedSet && !showCardProfile) {
    console.log("📋 [NAV DEBUG] Rendering Set Page:", {
      showSetPage,
      selectedSet,
      setCardsDataLength: setCardsData?.length || 0,
      selectedSetData: selectedSetData ? "exists" : "null",
      showCardProfile,
      timestamp: new Date().toISOString(),
    });
    // Get all cards from the selected set - will be loaded via useEffect
    const setCards = setCardsData || [];
    const setInfo = selectedSetData || {};
    const series = seriesFromSetName(setInfo.name || selectedSet);
    const symbolPath = getSetSymbolPath(
      setInfo.name || selectedSet,
      series,
      setInfo.language || "en"
    );
    const logoPath = getSetLogoPath(
      setInfo.name || selectedSet,
      series,
      setInfo.language || "en"
    );
    // Get release date from multiple possible fields
    const releaseDate = formatReleaseDate(
      setInfo.release_date || setInfo.published_on || setInfo.releaseDate
    );

    // Calculate actual progress based on user's collection
    const userData = userDatabase.getUserData();
    const collection = userData?.collections?.find(
      (c) => c.id === selectedCollection
    );
    const totalCards = setCards.length || setInfo.cards_total || 0;

    // Pre-build a Map for fast card lookups with quantities (O(1) instead of O(n))
    const collectedCardsMap = new Map();
    if (collection?.cards) {
      collection.cards.forEach((c) => {
        const id = String(c.cardId || c.id || c.product_id || "");
        if (id) {
          collectedCardsMap.set(id, c);
        }
      });
    }

    // Count collected cards efficiently
    let cardsCollected = 0;
    if (setCards.length > 0) {
      setCards.forEach((card) => {
        const cardId = String(card.id || card.product_id || card.cardId || "");
        if (cardId && collectedCardsMap.has(cardId)) {
          cardsCollected++;
        }
      });
    }

    const progress =
      totalCards > 0 ? Math.round((cardsCollected / totalCards) * 100) : 0;

    return (
      <div className="fixed inset-0 z-[60] bg-background overflow-y-auto set-page-container">
        {/* Set Info Header */}
        <div
          className="pb-4"
          style={{
            background:
              "linear-gradient(rgba(0, 0, 0, 0.2) 0%, rgba(71, 135, 243, 0.2) 100%), linear-gradient(0deg, rgb(1, 1, 12) 0%, rgb(1, 1, 12) 100%), rgb(1, 1, 12)",
          }}
        >
          <div className="flex items-center justify-between px-4 pt-4">
            <button
              onClick={() => {
                console.log("📋 [NAV DEBUG] Set page back button clicked");
                console.log("📋 [NAV DEBUG] Current state:", {
                  showSetPage,
                  selectedSet,
                  setCardsDataLength: setCardsData?.length || 0,
                });
                setShowSetPage(false);
              }}
              className="w-10 h-10 bg-gray-800 rounded-full flex items-center justify-center hover:bg-gray-700 transition-colors"
            >
              <svg
                className="w-5 h-5 dark:text-white text-theme-primary"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  strokeLinecap="round"
                  strokeLinejoin="round"
                  strokeWidth="2"
                  d="M15 19l-7-7 7-7"
                />
              </svg>
            </button>
            <button
              onClick={() => {
                console.log("📋 [NAV DEBUG] Set page close button clicked");
                console.log("📋 [NAV DEBUG] Current state:", {
                  showSetPage,
                  selectedSet,
                  setCardsDataLength: setCardsData?.length || 0,
                });
                setShowSetPage(false);
              }}
              className="w-10 h-10 bg-gray-800 rounded-full flex items-center justify-center hover:bg-gray-700 transition-colors"
            >
              <svg
                className="w-5 h-5 dark:text-white text-theme-primary"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  strokeLinecap="round"
                  strokeLinejoin="round"
                  strokeWidth="2"
                  d="M6 18L18 6M6 6l12 12"
                />
              </svg>
            </button>
          </div>

          {/* Set Logo */}
          <div className="flex justify-center px-4 mt-4 mb-4">
            <div className="h-32 flex items-center justify-center">
              <img
                src={logoPath}
                alt={setInfo.name || selectedSet}
                className="h-full w-full object-contain"
                onError={(e) => {
                  console.log(
                    "Set logo failed to load:",
                    logoPath,
                    "for set:",
                    setInfo.name || selectedSet
                  );
                  e.target.style.display = "none";
                }}
                onLoad={() => {
                  console.log("Set logo loaded successfully:", logoPath);
                }}
              />
            </div>
          </div>

          {/* Set Details */}
          <div className="px-4 mb-4">
            <div className="flex gap-2 items-center mb-2">
              <div className="set-symbol-container h-8 w-16 flex items-center justify-center flex-shrink-0">
                <img
                  src={symbolPath}
                  alt=""
                  className="h-full w-full object-contain"
                  onError={(e) => {
                    const container = e.target.closest(".set-symbol-container");
                    if (container) container.style.display = "none";
                  }}
                />
              </div>
              <h1 className="dark:text-white text-theme-primary text-2xl font-bold">
                {setInfo.name || selectedSet}
              </h1>
            </div>
            <p className="dark:text-gray-300 text-theme-secondary text-sm mb-3">
              {releaseDate || "TBD"}
            </p>

            {/* Progress Bar */}
            <div>
              <div className="flex items-center justify-between mb-2">
                <p className="dark:text-white text-theme-primary text-sm font-medium">
                  {cardsCollected} of {totalCards}
                </p>
                <p className="text-gray-300 text-sm">{progress}%</p>
              </div>
              <div className="h-2 bg-gray-700 rounded-full overflow-hidden">
                <div
                  className="h-full bg-gradient-to-r from-blue-500 to-indigo-600 transition-all"
                  style={{ width: `${Math.min(progress, 100)}%` }}
                />
              </div>
            </div>
          </div>
        </div>

        {/* Set Cards Grid */}
        <div className="p-4">
          {(() => {
            console.log("📋 [NAV DEBUG] Rendering card grid:", {
              setCardsLength: setCards.length,
              setCardsDataLength: setCardsData?.length || 0,
              loadingSetCards,
              showSetPage,
              selectedSet,
              selectedSetData: selectedSetData
                ? {
                    name: selectedSetData.name,
                    cards_total: selectedSetData.cards_total,
                  }
                : null,
            });
            return null;
          })()}
          <div className="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-5 lg:grid-cols-6 xl:grid-cols-7 gap-0.5">
            {setCards.length > 0 ? (
              setCards.map((card, index) => {
                // Use pre-built map for O(1) lookup instead of O(n) find
                const cardId = String(
                  card.id || card.product_id || card.cardId || ""
                );
                const collectedCard = collectedCardsMap.get(cardId);
                const cardPrice =
                  card.currentValue ||
                  card.tcgplayer?.prices?.holofoil?.market ||
                  card.tcgplayer?.prices?.normal?.market ||
                  0;

                return (
                  <div
                    key={`set-${card.id}-${index}`}
                    className="bg-white/5 backdrop-blur-md rounded-xl p-4 border border-white/10 hover:border-white/20 transition-all duration-300 cursor-pointer flex flex-col"
                    onClick={() => {
                      console.log(
                        "📋 [NAV DEBUG] Card clicked from set page:",
                        {
                          cardName: card.name || card.cleanName,
                          selectedSet,
                          showSetPage,
                          setCardsDataLength: setCardsData?.length || 0,
                          selectedSetData: selectedSetData ? "exists" : "null",
                        }
                      );
                      // Don't close set page - let handleCardClick manage the state
                      // The set page will be hidden behind the card profile modal
                      handleCardClick(card);
                    }}
                  >
                    <div className="aspect-[3/4] bg-white/5 backdrop-blur-sm rounded-lg mb-3 flex items-center justify-center relative overflow-hidden border border-white/10">
                      <img
                        src={getCardImageUrl(card)}
                        alt={getDisplayName(card)}
                        className="w-full h-full object-cover rounded-lg"
                        loading="lazy"
                        decoding="async"
                        onError={(e) => {
                          e.target.style.display = "none";
                          e.target.nextSibling.style.display = "flex";
                        }}
                      />
                      <div
                        className="absolute inset-0 flex items-center justify-center"
                        style={{ display: "none" }}
                      >
                        <span className="text-gray-400 text-sm">
                          Card Image
                        </span>
                      </div>
                    </div>
                    <div className="flex-grow flex flex-col">
                      <h3 className="dark:text-white text-theme-primary font-medium text-sm mb-1">
                        {getDisplayName(card)}
                      </h3>
                      <p className="text-gray-400 text-xs mb-2">
                        {card.formattedNumber}
                      </p>
                    </div>
                    <div className="flex items-end justify-between gap-2 mt-auto">
                      <div className="flex flex-col gap-1 flex-1 min-w-0">
                        <p className="text-primary font-bold text-xs truncate">
                          ${cardPrice.toFixed(2)}
                        </p>
                        <div className="min-h-[14px]">
                          {collectedCard && collectedCard.quantity > 0 && (
                            <div className="flex items-center gap-1 text-gray-400 text-[10px]">
                              <span>Qty:</span>
                              <span>{collectedCard.quantity}</span>
                            </div>
                          )}
                        </div>
                      </div>
                      <button
                        onClick={(e) => {
                          e.preventDefault();
                          e.stopPropagation();
                          // Quick add directly to collection without opening modal
                          const cardData = {
                            id: card.id || card.product_id || card.cardId,
                            cardId: card.id || card.product_id || card.cardId,
                            name: card.cleanName || card.name,
                            set_name:
                              card.set_name ||
                              selectedSetData?.name ||
                              selectedSet ||
                              "Unknown Set",
                            rarity: card.rarity || card.ext_rarity || "Unknown",
                            number:
                              card.formattedNumber ||
                              card.ext_number ||
                              "000/000",
                            imageUrl: card.image_url || card.imageUrl,
                            images: card.images,
                            price: card.current_value || card.market_price || 0,
                            current_value:
                              card.current_value || card.market_price || 0,
                          };

                          const success = userDatabase.addCardToCollection(
                            "pokemon-collection",
                            cardData,
                            1,
                            "Near Mint",
                            "Normal",
                            null,
                            null,
                            null,
                            ""
                          );

                          if (success) {
                            // Update user data state to refresh collection quantity display
                            const updatedData = userDatabase.getUserData();
                            setUserData(updatedData);
                            // Force re-render to update quantity badge
                            setSetCardsData([...setCardsData]);
                          }
                        }}
                        className="bg-primary text-accent w-8 h-8 rounded-lg flex items-center justify-center hover:bg-primary/80 transition-colors flex-shrink-0 relative z-10"
                        title="Add to collection"
                      >
                        <svg
                          className="w-5 h-5"
                          fill="none"
                          stroke="currentColor"
                          viewBox="0 0 24 24"
                        >
                          <path
                            strokeLinecap="round"
                            strokeLinejoin="round"
                            strokeWidth={2}
                            d="M12 4v16m8-8H4"
                          />
                        </svg>
                      </button>
                    </div>
                  </div>
                );
              })
            ) : (
              <div className="col-span-full text-center py-8">
                {loadingSetCards ? (
                  <>
                    <div className="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-primary mb-2"></div>
                    <p className="text-gray-400 text-sm">Loading cards...</p>
                  </>
                ) : (
                  <p className="text-gray-400 text-sm">
                    No cards found in this set.
                  </p>
                )}
              </div>
            )}
          </div>
        </div>
      </div>
    );
  }

  // Card Profile Screen
  if (showCardProfile && selectedCard) {
    console.log("🃏 [NAV DEBUG] Rendering Card Profile:", {
      showCardProfile,
      selectedCard: selectedCard.name || selectedCard.cleanName || "unknown",
      showSetPage,
      selectedSet,
      setCardsDataLength: setCardsData?.length || 0,
      timestamp: new Date().toISOString(),
    });
    return (
      <div
        ref={cardProfileModalRef}
        className="fixed inset-0 z-[99999] card-profile-modal"
        style={{
          background: isDark
            ? "linear-gradient(180deg, rgba(0, 0, 0, 0.20) 0%, rgba(71, 135, 243, 0.20) 100%), linear-gradient(0deg, #01010C 0%, #01010C 100%), #01010C"
            : "linear-gradient(135deg, #fafafa 0%, #e4e5f1 50%, rgba(104, 101, 231, 0.1) 100%)",
          overflow: "hidden",
        }}
      >
        {/* Floating Particles Background */}
        <Particles
          className="absolute inset-0 z-0"
          quantity={60}
          ease={80}
          color={isDark ? "#ffffff" : "#8B87E8"}
          size={0.5}
          vx={0.02}
          vy={-0.01}
        />
        {/* Scrollable Content Container */}
        <div className="h-full overflow-y-auto" ref={cardProfileModalRef}>
          {/* Header */}
          <div className="sticky top-0 dark:bg-[#01010C]/95 bg-[#fafafa]/95 backdrop-blur-sm border-b dark:border-gray-800 border-[#d2d3db] z-[10002] relative">
            <div className="flex items-center justify-between px-4 pt-6 pb-2">
              {/* Logo */}
              <div className="flex items-center gap-3">
                <img
                  src="/Assets/CardStax_logo_light.svg"
                  alt="CardStax"
                  className="h-10 w-auto"
                />
              </div>

              {/* Menu Button */}
              <button
                onClick={() => setShowSlidingMenu(true)}
                className="w-12 h-12 dark:bg-white/10 bg-gray-100 backdrop-blur-md rounded-xl flex items-center justify-center dark:hover:bg-white/20 hover:bg-gray-200 transition-all duration-200 dark:border-white/20 border-gray-300 border shadow-lg"
              >
                <svg
                  className="w-6 h-6 dark:text-white text-[#6865E7]"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    strokeLinecap="round"
                    strokeLinejoin="round"
                    strokeWidth="2"
                    d="M4 6h16M4 12h16M4 18h16"
                  />
                </svg>
              </button>
            </div>
          </div>

          {/* Sliding Menu - Rendered inside card profile screen */}
          {showSlidingMenu &&
            createPortal(
              <>
                {/* Backdrop */}
                <div
                  className="fixed inset-0 bg-black bg-opacity-50 z-[99999]"
                  onClick={() => setShowSlidingMenu(false)}
                />

                {/* Sliding Menu */}
                <div
                  className={`fixed top-0 right-0 h-full w-80 dark:bg-gray-900 bg-white shadow-2xl z-[99999] transform transition-transform duration-300 ease-in-out ${
                    showSlidingMenu ? "translate-x-0" : "translate-x-full"
                  }`}
                >
                  {/* Menu Header */}
                  <div className="flex items-center justify-between p-6 border-b dark:border-gray-700 border-[#d2d3db]">
                    <h2 className="dark:text-white text-theme-primary text-xl font-bold">
                      Menu
                    </h2>
                    <button
                      onClick={() => setShowSlidingMenu(false)}
                      className="w-8 h-8 dark:bg-gray-700 bg-gray-200 rounded-full flex items-center justify-center dark:hover:bg-gray-600 hover:bg-gray-300 transition-colors"
                      aria-label="Close menu"
                    >
                      <svg
                        className="w-4 h-4 dark:text-white text-theme-primary"
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                      >
                        <path
                          strokeLinecap="round"
                          strokeLinejoin="round"
                          strokeWidth="2"
                          d="M6 18L18 6M6 6l12 12"
                        />
                      </svg>
                    </button>
                  </div>

                  {/* Menu Content */}
                  <div className="p-6 overflow-y-auto h-full">
                    <nav className="space-y-6">
                      {/* Main Navigation */}
                      <div className="space-y-2">
                        <button
                          onClick={() => {
                            setShowCardProfile(false);
                            setSelectedCard(null);
                            setActiveTab("profile");
                            setNavigationMode("profile");
                            setViewingUserId(null); // Show own profile
                            setShowSlidingMenu(false);
                          }}
                          className="w-full flex items-center gap-3 p-3 rounded-lg dark:hover:bg-gray-800 hover:bg-gray-100 transition-colors text-left"
                        >
                          <svg
                            className="w-5 h-5 dark:text-gray-400 text-gray-600"
                            fill="none"
                            stroke="currentColor"
                            viewBox="0 0 24 24"
                          >
                            <path
                              strokeLinecap="round"
                              strokeLinejoin="round"
                              strokeWidth="2"
                              d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"
                            />
                          </svg>
                          <span className="dark:text-white text-theme-primary">
                            Profile
                          </span>
                        </button>

                        <button
                          onClick={() => {
                            setShowCardProfile(false);
                            setSelectedCard(null);
                            setActiveTab("deck-builder");
                            setNavigationMode("deck-builder");
                            setShowSlidingMenu(false);
                          }}
                          className="w-full flex items-center gap-3 p-3 rounded-lg dark:hover:bg-gray-800 hover:bg-gray-100 transition-colors text-left"
                        >
                          <svg
                            className="w-5 h-5 dark:text-gray-400 text-gray-600"
                            fill="none"
                            stroke="currentColor"
                            viewBox="0 0 24 24"
                          >
                            <path
                              strokeLinecap="round"
                              strokeLinejoin="round"
                              strokeWidth="2"
                              d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"
                            />
                          </svg>
                          <span className="dark:text-white text-theme-primary">
                            Deck Builder
                          </span>
                        </button>

                        <button
                          onClick={() => {
                            setShowCardProfile(false);
                            setSelectedCard(null);
                            setActiveTab("binder");
                            setNavigationMode("binder");
                            setShowSlidingMenu(false);
                          }}
                          className="w-full flex items-center gap-3 p-3 rounded-lg dark:hover:bg-gray-800 hover:bg-gray-100 transition-colors text-left"
                        >
                          <svg
                            className="w-5 h-5 dark:text-gray-400 text-gray-600"
                            fill="none"
                            stroke="currentColor"
                            viewBox="0 0 24 24"
                          >
                            <path
                              strokeLinecap="round"
                              strokeLinejoin="round"
                              strokeWidth="2"
                              d="M4 5a1 1 0 011-1h14a1 1 0 011 1v2a1 1 0 01-1 1H5a1 1 0 01-1-1V5zM4 13a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H5a1 1 0 01-1-1v-6zM16 13a1 1 0 011-1h2a1 1 0 011 1v6a1 1 0 01-1 1h-2a1 1 0 01-1-1v-6z"
                            />
                          </svg>
                          <span className="dark:text-white text-theme-primary">
                            Binder
                          </span>
                        </button>

                        <button
                          onClick={() => {
                            setShowCardProfile(false);
                            setSelectedCard(null);
                            setActiveTab("sets");
                            setNavigationMode("sets");
                            setShowSlidingMenu(false);
                          }}
                          className="w-full flex items-center gap-3 p-3 rounded-lg dark:hover:bg-gray-800 hover:bg-gray-100 transition-colors text-left"
                        >
                          <svg
                            className="w-5 h-5 dark:text-gray-400 text-gray-600"
                            fill="none"
                            stroke="currentColor"
                            viewBox="0 0 24 24"
                          >
                            <path
                              strokeLinecap="round"
                              strokeLinejoin="round"
                              strokeWidth="2"
                              d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"
                            />
                          </svg>
                          <span className="dark:text-white text-theme-primary">
                            Sets
                          </span>
                        </button>

                        <button
                          onClick={() => {
                            setShowCardProfile(false);
                            setSelectedCard(null);
                            setPreviousTab(activeTab);
                            setPreviousNavigationMode(navigationMode);
                            setActiveTab("community");
                            setNavigationMode("community");
                            setShowSlidingMenu(false);
                          }}
                          className="w-full flex items-center gap-3 p-3 rounded-lg dark:hover:bg-gray-800 hover:bg-gray-100 transition-colors text-left"
                        >
                          <svg
                            className="w-5 h-5 dark:text-gray-400 text-gray-600"
                            fill="none"
                            stroke="currentColor"
                            viewBox="0 0 24 24"
                          >
                            <path
                              strokeLinecap="round"
                              strokeLinejoin="round"
                              strokeWidth="2"
                              d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"
                            />
                          </svg>
                          <span className="dark:text-white text-theme-primary">
                            Community
                          </span>
                        </button>
                      </div>

                      {/* Collections Section */}
                      <div className="pt-4 border-t dark:border-gray-700 border-[#d2d3db]">
                        <h4 className="dark:text-gray-400 text-gray-600 text-sm font-medium mb-3">
                          Collections
                        </h4>
                        <div className="space-y-2">
                          {/* Dynamic Collections from userData */}
                          {userData?.collections?.map((collection, index) => (
                            <button
                              key={collection.id || index}
                              onClick={() => {
                                setShowCardProfile(false);
                                setSelectedCard(null);
                                setSelectedCollection(collection.id);
                                setActiveTab("collection");
                                setNavigationMode("collection");
                                setShowSlidingMenu(false);
                              }}
                              className="w-full flex items-center gap-3 p-3 rounded-lg dark:hover:bg-gray-800 hover:bg-gray-100 transition-colors text-left"
                            >
                              <svg
                                className="w-5 h-5 dark:text-gray-400 text-gray-600"
                                fill="none"
                                stroke="currentColor"
                                viewBox="0 0 24 24"
                              >
                                <path
                                  strokeLinecap="round"
                                  strokeLinejoin="round"
                                  strokeWidth="2"
                                  d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"
                                />
                              </svg>
                              <span className="dark:text-white text-theme-primary">
                                {collection.name}
                              </span>
                            </button>
                          ))}

                          {/* Wishlist - Always present */}
                          <button
                            onClick={() => {
                              setShowCardProfile(false);
                              setSelectedCard(null);
                              setPreviousTab(activeTab);
                              setPreviousNavigationMode(navigationMode);
                              setActiveTab("wishlist");
                              setNavigationMode("wishlist");
                              setShowSlidingMenu(false);
                            }}
                            className="w-full flex items-center gap-3 p-3 rounded-lg dark:hover:bg-gray-800 hover:bg-gray-100 transition-colors text-left"
                          >
                            <svg
                              className="w-5 h-5 dark:text-gray-400 text-gray-600"
                              fill="none"
                              stroke="currentColor"
                              viewBox="0 0 24 24"
                            >
                              <path
                                strokeLinecap="round"
                                strokeLinejoin="round"
                                strokeWidth="2"
                                d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"
                              />
                            </svg>
                            <span className="dark:text-white text-theme-primary">
                              Wishlist
                            </span>
                          </button>
                        </div>
                      </div>

                      {/* Settings Section */}
                      <div className="pt-4 border-t dark:border-gray-700 border-[#d2d3db]">
                        <h4 className="dark:text-gray-400 text-gray-600 text-sm font-medium mb-3">
                          Settings
                        </h4>
                        <div className="space-y-2">
                          <button
                            onClick={() => {
                              setShowCardProfile(false);
                              setSelectedCard(null);
                              setPreviousTab(activeTab);
                              setPreviousNavigationMode(navigationMode);
                              setActiveTab("settings");
                              setNavigationMode("settings");
                              setShowSlidingMenu(false);
                            }}
                            className="w-full flex items-center gap-3 p-3 rounded-lg dark:hover:bg-gray-800 hover:bg-gray-100 transition-colors text-left"
                          >
                            <svg
                              className="w-5 h-5 dark:text-gray-400 text-gray-600"
                              fill="none"
                              stroke="currentColor"
                              viewBox="0 0 24 24"
                            >
                              <path
                                strokeLinecap="round"
                                strokeLinejoin="round"
                                strokeWidth="2"
                                d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"
                              />
                              <path
                                strokeLinecap="round"
                                strokeLinejoin="round"
                                strokeWidth="2"
                                d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"
                              />
                            </svg>
                            <span className="dark:text-white text-theme-primary">
                              Settings
                            </span>
                          </button>

                          <button
                            onClick={() => {
                              setShowCardProfile(false);
                              setSelectedCard(null);
                              setPreviousTab(activeTab);
                              setPreviousNavigationMode(navigationMode);
                              setActiveTab("help");
                              setNavigationMode("help");
                              setShowSlidingMenu(false);
                            }}
                            className="w-full flex items-center gap-3 p-3 rounded-lg dark:hover:bg-gray-800 hover:bg-gray-100 transition-colors text-left"
                          >
                            <svg
                              className="w-5 h-5 dark:text-gray-400 text-gray-600"
                              fill="none"
                              stroke="currentColor"
                              viewBox="0 0 24 24"
                            >
                              <path
                                strokeLinecap="round"
                                strokeLinejoin="round"
                                strokeWidth="2"
                                d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
                              />
                            </svg>
                            <span className="dark:text-white text-theme-primary">
                              Help Center
                            </span>
                          </button>

                          {/* Light/Dark Mode Toggle */}
                          <button
                            onClick={() => {
                              toggleTheme();
                              setShowSlidingMenu(false);
                            }}
                            className="w-full flex items-center gap-3 p-3 rounded-lg dark:hover:bg-gray-800 hover:bg-gray-100 transition-colors text-left"
                          >
                            {isDark ? (
                              <>
                                <svg
                                  className="w-5 h-5 dark:text-gray-400 text-gray-600"
                                  fill="none"
                                  stroke="currentColor"
                                  viewBox="0 0 24 24"
                                >
                                  <path
                                    strokeLinecap="round"
                                    strokeLinejoin="round"
                                    strokeWidth="2"
                                    d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"
                                  />
                                </svg>
                                <span className="dark:text-white text-theme-primary">
                                  Light Mode
                                </span>
                              </>
                            ) : (
                              <>
                                <svg
                                  className="w-5 h-5 dark:text-gray-400 text-gray-600"
                                  fill="none"
                                  stroke="currentColor"
                                  viewBox="0 0 24 24"
                                >
                                  <path
                                    strokeLinecap="round"
                                    strokeLinejoin="round"
                                    strokeWidth="2"
                                    d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"
                                  />
                                </svg>
                                <span className="dark:text-white text-theme-primary">
                                  Dark Mode
                                </span>
                              </>
                            )}
                          </button>

                          <button
                            onClick={async () => {
                              setShowSlidingMenu(false);
                              setGuestMode(false); // Clear guest mode on logout
                              await logout();
                              setCurrentScreen("login");
                            }}
                            className="w-full flex items-center gap-3 p-3 rounded-lg dark:hover:bg-gray-800 hover:bg-gray-100 transition-colors text-left"
                          >
                            <svg
                              className="w-5 h-5 dark:text-gray-400 text-gray-600"
                              fill="none"
                              stroke="currentColor"
                              viewBox="0 0 24 24"
                            >
                              <path
                                strokeLinecap="round"
                                strokeLinejoin="round"
                                strokeWidth="2"
                                d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"
                              />
                            </svg>
                            <span className="dark:text-white text-theme-primary">
                              Logout
                            </span>
                          </button>
                        </div>
                      </div>
                    </nav>
                  </div>
                </div>
              </>,
              document.body
            )}

          {/* Back and Share Buttons */}
          <div className="px-4 py-2">
            <div className="flex items-center justify-between">
              <button
                onClick={handleCloseCardProfileAndRestore}
                className="w-10 h-10 dark:bg-white/10 bg-white/20 backdrop-blur-md rounded-lg flex items-center justify-center dark:hover:bg-white/20 hover:bg-white/30 transition-all duration-200 dark:border-white/20 border-[#d2d3db] border"
              >
                <svg
                  className="w-5 h-5 dark:text-white text-theme-primary"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    strokeLinecap="round"
                    strokeLinejoin="round"
                    strokeWidth="2"
                    d="M15 19l-7-7 7-7"
                  />
                </svg>
              </button>
              <button
                onClick={handleShare}
                className="w-10 h-10 dark:bg-white/10 bg-white/20 backdrop-blur-md rounded-lg flex items-center justify-center dark:hover:bg-white/20 hover:bg-white/30 transition-all duration-200 dark:border-white/20 border-[#d2d3db] border"
              >
                <img
                  src="/Assets/share_card.svg"
                  alt="Share"
                  className="w-5 h-5"
                  style={{
                    filter: isDark
                      ? "none"
                      : "brightness(0) saturate(100%) invert(30%) sepia(15%) saturate(1000%) hue-rotate(200deg) brightness(90%) contrast(90%)",
                  }}
                />
              </button>
            </div>
          </div>

          {/* Card Image Section */}
          <div className="px-4 pt-0 pb-6">
            <div className="flex flex-col items-center gap-4">
              {/* Card Image with Dynamic Glow */}
              <div
                className="relative flex items-center justify-center"
                style={{
                  width: "194px",
                  height: (() => {
                    const n =
                      (selectedCard?.clean_name || selectedCard?.name || "") +
                      "";
                    const t =
                      (selectedCard?.ext_card_type ||
                        selectedCard?.sub_type_name ||
                        "") + "";
                    const isPack =
                      /(blister|single\s*pack|booster\s*pack)/i.test(n) ||
                      /(blister|single\s*pack|booster\s*pack)/i.test(t);
                    return isPack ? "230px" : "260px";
                  })(),
                  overflow: (() => {
                    const n =
                      (selectedCard?.clean_name || selectedCard?.name || "") +
                      "";
                    const t =
                      (selectedCard?.ext_card_type ||
                        selectedCard?.sub_type_name ||
                        "") + "";
                    const isPack =
                      /(blister|single\s*pack)/i.test(n) ||
                      /(blister|single\s*pack)/i.test(t);
                    return isPack ? "hidden" : "visible";
                  })(),
                }}
              >
                {/* Dynamic Glow Background - uses card image as source */}
                <div
                  className="absolute blur-2xl"
                  style={{
                    backgroundImage: `url(${getCardImageUrl(selectedCard)})`,
                    backgroundSize: "cover",
                    backgroundPosition: "center center",
                    filter: "blur(25px) saturate(1.3) brightness(1.1)",
                    width: "110%",
                    height: "110%",
                    left: "100px",
                    transform: "translateX(-50%) scale(1.05)",
                    top: "-2px",
                    zIndex: 1,
                    borderRadius: "8px",
                    opacity: (() => {
                      const n =
                        (selectedCard?.clean_name || selectedCard?.name || "") +
                        "";
                      const t =
                        (selectedCard?.ext_card_type ||
                          selectedCard?.sub_type_name ||
                          "") + "";
                      const isPack =
                        /(blister|single\s*pack)/i.test(n) ||
                        /(blister|single\s*pack)/i.test(t);
                      return isPack ? 0 : 0.15;
                    })(),
                  }}
                />
                {/* Card */}
                <div
                  className="relative z-10 w-full h-full"
                  style={{ boxShadow: "none" }}
                >
                  <HolographicCard
                    src={getCardImageUrl(selectedCard)}
                    alt={getDisplayName(selectedCard)}
                    className={(() => {
                      const n =
                        (selectedCard?.clean_name || selectedCard?.name || "") +
                        "";
                      const t =
                        (selectedCard?.ext_card_type ||
                          selectedCard?.sub_type_name ||
                          "") + "";
                      const isPack =
                        /(blister|single\s*pack|booster\s*pack)/i.test(n) ||
                        /(blister|single\s*pack|booster\s*pack)/i.test(t);
                      return isPack
                        ? "block rounded bg-transparent overflow-visible h-[220px] w-auto"
                        : "w-full h-full bg-transparent overflow-visible";
                    })()}
                    style={(() => {
                      const n =
                        (selectedCard?.clean_name || selectedCard?.name || "") +
                        "";
                      const t =
                        (selectedCard?.ext_card_type ||
                          selectedCard?.sub_type_name ||
                          "") + "";
                      const isPack =
                        /(blister|single\s*pack|booster\s*pack)/i.test(n) ||
                        /(blister|single\s*pack|booster\s*pack)/i.test(t);
                      if (isPack) {
                        return {
                          boxShadow: "none",
                          border: "none",
                          width: "auto",
                          height: "220px",
                          maxHeight: "240px",
                          objectFit: "contain",
                        };
                      }
                      return {
                        boxShadow: "none",
                        border: "none",
                        maxHeight: "240px",
                      };
                    })()}
                    enableGyroscope={true}
                    enableHolographic={true}
                    cardRarity={selectedCard.rarity || "common"}
                    showExpandedOverlay={true}
                    onExpandedClick={() => {}}
                    imageSize={(() => {
                      const n = getDisplayName(selectedCard);
                      const t =
                        (selectedCard?.ext_card_type ||
                          selectedCard?.sub_type_name ||
                          "") + "";
                      const isPack =
                        /(blister|single\s*pack|booster\s*pack)/i.test(n) ||
                        /(blister|single\s*pack|booster\s*pack)/i.test(t);
                      return isPack ? "medium" : "large";
                    })()}
                    removeBackground={true}
                    roundedCorners={true}
                  />
                </div>
              </div>

              {/* Card Info */}
              <div className="flex flex-col items-center gap-1 w-full">
                {/* Card Name with Status */}
                <div className="flex items-center gap-2 justify-center">
                  <h2
                    className="text-lg font-semibold dark:text-white text-theme-primary leading-tight whitespace-normal break-words text-center"
                    style={(() => {
                      const n = getDisplayName(selectedCard);
                      const t =
                        (selectedCard?.ext_card_type ||
                          selectedCard?.sub_type_name ||
                          "") + "";
                      const isPack =
                        /(blister|single\s*pack|booster\s*pack)/i.test(n) ||
                        /(blister|single\s*pack|booster\s*pack)/i.test(t);
                      return isPack ? { width: "250px" } : {};
                    })()}
                  >
                    {getDisplayName(selectedCard)}
                  </h2>
                  {selectedCard.collected !== false &&
                  (selectedCard.quantity > 0 ||
                    selectedCard.collected === true) ? (
                    <img
                      src="/Assets/Collected=Yes.svg"
                      alt="Collected"
                      className="w-[18px] h-[18px] flex-shrink-0"
                    />
                  ) : (
                    <img
                      src="/Assets/Collected=No.svg"
                      alt="Not Collected"
                      className="w-[18px] h-[18px] flex-shrink-0"
                    />
                  )}
                </div>

                {/* Rarity */}
                <p className="text-sm dark:text-white text-theme-primary text-center">
                  {selectedCard.rarity}
                </p>

                {/* Illustrator */}
                {selectedCard.artist ? (
                  <button
                    onClick={() => handleArtistSearch(selectedCard.artist)}
                    className="text-sm text-blue-400 text-center hover:text-blue-300 hover:underline transition-colors cursor-pointer"
                    style={{ width: "360px" }}
                  >
                    {selectedCard.artist}
                  </button>
                ) : null}
              </div>
            </div>
          </div>

          {/* Set Information Section */}
          <div className="px-4">
            <div
              className="dark:bg-white/5 bg-white/20 backdrop-blur-md rounded-2xl p-4 mb-0 relative z-0 dark:border-white/10 border-[#d2d3db] border"
              style={{
                paddingBottom: "64px",
                marginBottom: "0",
                top: "0px",
                marginTop: "0px",
              }}
            >
              <div className="flex items-center justify-between">
                <div className="flex items-center gap-3">
                  {/* Card Number Indicator */}
                  <div className="flex items-center justify-center dark:bg-gray-700/80 bg-gray-100 backdrop-blur-sm rounded-lg px-3 py-1.5 min-w-[80px] h-[28px] dark:border-white/10 border-[#d2d3db] border">
                    <span className="dark:text-white text-theme-primary text-xs font-bold">
                      {selectedCard.formattedNumber
                        ? selectedCard.formattedNumber.replace("#", "")
                        : "001"}
                    </span>
                  </div>
                  {(() => {
                    const setNameRaw =
                      getDisplaySetName(selectedCard).toString();
                    const series = seriesFromSetName(
                      getDisplaySetName(selectedCard)
                    );
                    const language = selectedCard?.language || "en";
                    const primaryLocal = getSetSymbolPath(
                      cleanSetName(setNameRaw),
                      series,
                      language
                    );

                    // Prepare candidate sources: local asset, images.symbol, set_symbol_url, and a secondary attempt with uncleaned name
                    let images = selectedCard.images;
                    if (typeof images === "string") {
                      try {
                        images = JSON.parse(images);
                      } catch {
                        images = undefined;
                      }
                    }
                    const candidates = [
                      primaryLocal,
                      images?.symbol,
                      selectedCard.set_symbol_url,
                      getSetSymbolPath(
                        (
                          selectedCard.set_name ||
                          selectedCard.set?.name ||
                          selectedCard.set ||
                          ""
                        ).toString(),
                        series,
                        language
                      ),
                    ].filter(Boolean);

                    if (candidates.length === 0) return null;

                    const dataSources = candidates.join("|");
                    return (
                      <img
                        src={candidates[0]}
                        alt="Set Symbol"
                        className="h-8 w-auto object-contain"
                        data-sources={dataSources}
                        data-idx="0"
                        onError={(e) => {
                          const el = e.currentTarget;
                          const sources = (
                            el.getAttribute("data-sources") || ""
                          )
                            .split("|")
                            .filter(Boolean);
                          const currentIdx = parseInt(
                            el.getAttribute("data-idx") || "0",
                            10
                          );
                          const nextIdx = currentIdx + 1;
                          if (nextIdx < sources.length) {
                            el.setAttribute("data-idx", String(nextIdx));
                            el.src = sources[nextIdx];
                          } else {
                            el.style.display = "none";
                          }
                        }}
                      />
                    );
                  })()}

                  {/* Set and Expansion Info */}
                  <div
                    className="flex flex-col cursor-pointer hover:opacity-80 transition-opacity"
                    onClick={() => {
                      // For Japanese cards, use the full set name or group_id if available
                      const setName =
                        selectedCard.set_name ||
                        selectedCard.set?.name ||
                        selectedCard.set ||
                        selectedCard.clean_set_name ||
                        "Set Name";
                      // If we have group_id, use handleSetClickWithData instead
                      if (selectedCard.group_id) {
                        handleSetClickWithData({
                          id: selectedCard.group_id,
                          group_id: selectedCard.group_id,
                          name: setName,
                          language: selectedCard.language || "en",
                        });
                      } else {
                        handleSetClick(setName);
                      }
                    }}
                  >
                    <span className="dark:text-white text-theme-primary text-sm font-medium">
                      {getDisplaySetName(selectedCard)}
                    </span>
                    <span className="dark:text-gray-300 text-theme-secondary text-xs">
                      {(() => {
                        // Try multiple sources for set name to get accurate series
                        const setNameRaw =
                          selectedCard.clean_set_name ||
                          selectedCard.set_name ||
                          selectedCard.set?.name ||
                          selectedCard.set ||
                          "";
                        let series = seriesFromSetName(setNameRaw);

                        // If we got the fallback but have a set name, try to extract series from set name patterns
                        if (series === "Pokemon TCG" && setNameRaw) {
                          const cleaned = cleanSetName(setNameRaw);
                          const seriesFromCleaned = seriesFromSetName(cleaned);
                          if (
                            seriesFromCleaned &&
                            seriesFromCleaned !== "Pokemon TCG"
                          ) {
                            series = seriesFromCleaned;
                          }
                          // Also try the original raw name if cleaned didn't work
                          if (
                            series === "Pokemon TCG" &&
                            cleaned !== setNameRaw
                          ) {
                            const seriesFromRaw = seriesFromSetName(setNameRaw);
                            if (
                              seriesFromRaw &&
                              seriesFromRaw !== "Pokemon TCG"
                            ) {
                              series = seriesFromRaw;
                            }
                          }
                        }

                        // Return the series (will be "Pokemon TCG" only if no series could be determined)
                        return series || "Pokemon TCG";
                      })()}
                    </span>
                  </div>
                </div>

                {/* Navigation Chevron */}
                <svg
                  className="w-5 h-5 dark:text-gray-400 text-theme-secondary"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    strokeLinecap="round"
                    strokeLinejoin="round"
                    strokeWidth={2}
                    d="M9 5l7 7-7 7"
                  />
                </svg>
              </div>
            </div>
          </div>

          {/* Card Details Section */}
          <div className="px-4 pb-6 relative z-10">
            {/* Card Number and Set Info */}
            <div className="dark:bg-white/5 bg-white/20 backdrop-blur-md rounded-2xl p-6 mb-6 -mt-12 relative z-[1] dark:border-white/10 border-[#d2d3db] border">
              {/* Action Icons */}
              <div className="flex items-center justify-between mb-4">
                <div className="flex items-center gap-4">
                  <button
                    className="w-6 h-6 dark:text-white text-theme-primary hover:opacity-80 transition-opacity"
                    onClick={handleNoteClick}
                  >
                    {selectedCard?.note ? (
                      <svg
                        className="w-6 h-6"
                        viewBox="0 0 24 24"
                        fill="none"
                        xmlns="http://www.w3.org/2000/svg"
                      >
                        <path
                          d="M2.75499 14.7161L3.27199 16.6481C3.87599 18.9031 4.17899 20.0311 4.86399 20.7621C5.40464 21.3389 6.10408 21.7425 6.87399 21.9221C7.84999 22.1501 8.97799 21.8481 11.234 21.2441C13.488 20.6401 14.616 20.3381 15.347 19.6531C15.4077 19.5958 15.4663 19.5371 15.523 19.4771C15.1824 19.4464 14.8439 19.3963 14.509 19.3271C13.813 19.1891 12.986 18.9671 12.008 18.7051L11.901 18.6761L11.876 18.6701C10.812 18.3841 9.92299 18.1461 9.21299 17.8901C8.46599 17.6201 7.78799 17.2871 7.21099 16.7471C6.41731 16.0035 5.86191 15.0413 5.61499 13.9821C5.43499 13.2131 5.48699 12.4591 5.62699 11.6781C5.76099 10.9291 6.00099 10.0311 6.28899 8.95609L6.82399 6.96209L6.84199 6.89209C4.92199 7.40909 3.91099 7.71509 3.23699 8.34609C2.65949 8.88714 2.25545 9.58734 2.07599 10.3581C1.84799 11.3331 2.14999 12.4611 2.75499 14.7161Z"
                          fill="#605DEC"
                        />
                        <path
                          fillRule="evenodd"
                          clipRule="evenodd"
                          d="M20.83 10.715L20.312 12.647C19.707 14.902 19.405 16.03 18.72 16.761C18.1795 17.3382 17.48 17.7422 16.71 17.922C16.6133 17.9447 16.515 17.962 16.415 17.974C15.5 18.087 14.383 17.788 12.351 17.244C10.096 16.639 8.96799 16.337 8.23699 15.652C7.65966 15.1112 7.25563 14.4114 7.07599 13.641C6.84799 12.665 7.14999 11.538 7.75499 9.28299L8.27199 7.35099L8.51599 6.44599C8.97099 4.77999 9.27699 3.86299 9.86399 3.23599C10.4046 2.65919 11.1041 2.25553 11.874 2.07599C12.85 1.84799 13.978 2.14999 16.234 2.75499C18.488 3.35899 19.616 3.66099 20.347 4.34499C20.9245 4.88605 21.3285 5.58625 21.508 6.35699C21.736 7.33299 21.434 8.45999 20.83 10.715ZM11.051 9.80499C11.0765 9.70984 11.1205 9.62065 11.1805 9.54251C11.2405 9.46437 11.3154 9.39883 11.4007 9.34961C11.486 9.30039 11.5802 9.26847 11.6779 9.25566C11.7756 9.24286 11.8749 9.24943 11.97 9.27499L16.8 10.57C16.8976 10.5931 16.9897 10.6357 17.0706 10.695C17.1515 10.7544 17.2197 10.8294 17.2711 10.9156C17.3225 11.0018 17.3561 11.0974 17.3699 11.1968C17.3836 11.2963 17.3773 11.3974 17.3513 11.4943C17.3252 11.5913 17.28 11.682 17.2183 11.7611C17.1565 11.8402 17.0795 11.9062 16.9919 11.955C16.9042 12.0038 16.8076 12.0346 16.7078 12.0454C16.608 12.0562 16.5071 12.0469 16.411 12.018L11.581 10.724C11.389 10.6724 11.2254 10.5468 11.126 10.3747C11.0267 10.2025 10.9997 9.99701 11.051 9.80499ZM10.275 12.704C10.3266 12.512 10.4522 12.3484 10.6243 12.249C10.7964 12.1497 11.001 12.1227 11.193 12.174L14.091 12.951C14.1891 12.9736 14.2817 13.0158 14.3631 13.075C14.4446 13.1342 14.5133 13.2092 14.5652 13.2955C14.6171 13.3818 14.651 13.4777 14.665 13.5774C14.679 13.6771 14.6728 13.7786 14.6468 13.8759C14.6207 13.9732 14.5753 14.0642 14.5133 14.1435C14.4513 14.2229 14.374 14.2889 14.2859 14.3378C14.1978 14.3866 14.1008 14.4172 14.0007 14.4277C13.9005 14.4382 13.7993 14.4284 13.703 14.399L10.805 13.623C10.7098 13.5975 10.6206 13.5534 10.5425 13.4934C10.4644 13.4334 10.3988 13.3586 10.3496 13.2733C10.3004 13.1879 10.2685 13.0937 10.2557 12.9961C10.2429 12.8984 10.2494 12.7991 10.275 12.704Z"
                          fill="#605DEC"
                        />
                      </svg>
                    ) : (
                      <img
                        src="/Assets/Notes Icon_None.svg"
                        alt="No Note"
                        className="w-6 h-6"
                        style={{
                          filter: "brightness(0) saturate(100%) invert(100%)",
                        }}
                      />
                    )}
                  </button>
                  <button
                    className="w-6 h-6 dark:text-white text-theme-primary hover:opacity-80 transition-opacity"
                    onClick={() => {
                      const cardId =
                        selectedCard.product_id ||
                        selectedCard.cardId ||
                        selectedCard.id;
                      if (!cardId) {
                        console.error(
                          "Cannot add to wishlist: card ID is undefined",
                          selectedCard
                        );
                        alert("Error: Card ID is missing. Please try again.");
                        return;
                      }
                      handleWishlistToggle(cardId);
                    }}
                  >
                    {wishlist.has(
                      selectedCard.product_id ||
                        selectedCard.cardId ||
                        selectedCard.id
                    ) ? (
                      <img
                        src="/Assets/Wishlisted_card.svg"
                        alt="Remove from Wishlist"
                        className="w-6 h-6"
                      />
                    ) : (
                      <img
                        src="/Assets/Wishlist_white.svg"
                        alt="Add to Wishlist"
                        className="w-6 h-6"
                      />
                    )}
                  </button>
                </div>

                {/* Centered Quantity Text */}
                <div className="absolute left-1/2 transform -translate-x-1/2">
                  <span className="dark:text-white text-theme-primary text-sm">
                    Qty:{" "}
                    {getCardQuantityInCollection(
                      selectedCard.cardId || selectedCard.id
                    )}
                  </span>
                </div>

                <button
                  className="w-6 h-6 dark:text-white text-theme-primary hover:opacity-80 transition-opacity relative card-menu-container"
                  onClick={handleCardMenuToggle}
                >
                  <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path
                      strokeLinecap="round"
                      strokeLinejoin="round"
                      strokeWidth={2}
                      d="M12 5v.01M12 12v.01M12 19v.01M12 6a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2z"
                    />
                  </svg>
                </button>
              </div>

              {/* Card Menu */}
              {showCardMenu && (
                <div className="absolute top-16 right-0 z-[80] dark:bg-gray-800/95 bg-[#fafafa]/95 backdrop-blur-md dark:border-white/10 border-[#d2d3db] rounded-lg shadow-xl min-w-[160px] card-menu-container">
                  <div className="py-2">
                    <button
                      onClick={handleViewMyCards}
                      className="w-full flex items-center gap-3 px-4 py-2 text-left dark:hover:bg-gray-700/50 hover:bg-[#e4e5f1] transition-colors"
                    >
                      <svg
                        className="w-5 h-5 dark:text-gray-300 text-theme-primary"
                        fill="none"
                        viewBox="0 0 20 20"
                      >
                        <g clipPath="url(#clip0_363_5703)">
                          <path
                            d="M15.105 19.0527L10.4474 16.8878C10.1388 16.7443 10.0046 16.3774 10.1481 16.0684L13.444 8.97766C13.5872 8.66891 13.9545 8.53493 14.2629 8.67817L18.9207 10.8436C19.2293 10.987 19.3632 11.3539 19.2197 11.6625L15.924 18.7532C15.7804 19.062 15.4133 19.196 15.105 19.0527ZM3.86524 18.2791L0.773053 11.0973C0.638366 10.7845 0.783014 10.4214 1.09532 10.287L2.62641 9.6279L4.5395 16.8171C4.72286 17.5041 5.42837 17.9139 6.11606 17.7308L7.64075 17.3251L4.67563 18.6019C4.36286 18.7364 3.99993 18.5919 3.86524 18.2791ZM5.18907 16.644L3.17821 9.08743C3.09071 8.75852 3.2868 8.42032 3.61532 8.33305L4.94473 7.97946L4.78465 9.1695C4.69005 9.87403 5.18403 10.5231 5.88954 10.6182L9.00782 11.0384L7.73841 15.3145C7.60774 15.7551 7.72395 16.2109 8.00661 16.5325L5.94333 17.0813C5.61442 17.1688 5.27657 16.9731 5.18907 16.644ZM9.42454 16.458L8.79876 16.2721C8.47219 16.1748 8.28626 15.832 8.38298 15.5054L10.6084 8.0093C10.7054 7.68274 11.049 7.4968 11.3749 7.59329L13.2918 8.16294C13.0929 8.29413 12.9344 8.47837 12.8343 8.69458L9.53825 15.7856C9.44059 15.9955 9.40141 16.2277 9.42454 16.458ZM9.20161 10.3865L5.9795 9.95227C5.64227 9.90673 5.40512 9.59602 5.45067 9.2586L6.49481 1.50899C6.54012 1.17177 6.85126 0.934851 7.18778 0.980164L12.2787 1.66622C12.6157 1.71177 12.8526 2.02266 12.8073 2.35966L12.1649 7.12735L11.566 6.94954C10.8837 6.74653 10.1666 7.13641 9.9643 7.81798L9.20161 10.3865Z"
                            fill={isDark ? "#8F8F94" : "#484b6a"}
                          />
                        </g>
                        <defs>
                          <clipPath id="clip0_363_5703">
                            <rect width="20" height="20" fill="white" />
                          </clipPath>
                        </defs>
                      </svg>
                      <span className="dark:text-gray-300 text-theme-primary text-sm font-medium">
                        View My Cards
                      </span>
                    </button>

                    <button
                      onClick={handleAddToDeck}
                      className="w-full flex items-center gap-3 px-4 py-2 text-left dark:hover:bg-gray-700/50 hover:bg-[#e4e5f1] transition-colors"
                    >
                      <img
                        src="/Assets/Addtodeck.svg"
                        alt="Add to Deck"
                        className="w-5 h-5"
                        style={{
                          filter: isDark
                            ? "none"
                            : "brightness(0) saturate(100%) invert(30%) sepia(15%) saturate(1000%) hue-rotate(200deg) brightness(90%) contrast(90%)",
                        }}
                      />
                      <span className="dark:text-gray-300 text-theme-primary text-sm font-medium">
                        Add to Deck
                      </span>
                    </button>
                    <button
                      onClick={handleAddToBinder}
                      className="w-full flex items-center gap-3 px-4 py-2 text-left dark:hover:bg-gray-700/50 hover:bg-[#e4e5f1] transition-colors"
                    >
                      <img
                        src="/Assets/Addtobinder.svg"
                        alt="Add to Binder"
                        className="w-5 h-5"
                        style={{
                          filter: isDark
                            ? "none"
                            : "brightness(0) saturate(100%) invert(30%) sepia(15%) saturate(1000%) hue-rotate(200deg) brightness(90%) contrast(90%)",
                        }}
                      />
                      <span className="dark:text-gray-300 text-theme-primary text-sm font-medium">
                        Add to Binder
                      </span>
                    </button>
                    <button
                      onClick={handleSetCustomTag}
                      className="w-full flex items-center gap-3 px-4 py-2 text-left dark:hover:bg-gray-700/50 hover:bg-[#e4e5f1] transition-colors"
                    >
                      <img
                        src="/Assets/SetTag.svg"
                        alt="Set Custom Tag"
                        className="w-5 h-5"
                        style={{
                          filter: isDark
                            ? "none"
                            : "brightness(0) saturate(100%) invert(30%) sepia(15%) saturate(1000%) hue-rotate(200deg) brightness(90%) contrast(90%)",
                        }}
                      />
                      <span className="dark:text-gray-300 text-theme-primary text-sm font-medium">
                        Set Custom Tag
                      </span>
                    </button>
                    <button
                      onClick={handleSendFeedback}
                      className="w-full flex items-center gap-3 px-4 py-2 text-left dark:hover:bg-gray-700/50 hover:bg-[#e4e5f1] transition-colors"
                    >
                      <img
                        src="/Assets/Sendfeedback.svg"
                        alt="Send Feedback"
                        className="w-5 h-5"
                        style={{
                          filter: isDark
                            ? "none"
                            : "brightness(0) saturate(100%) invert(30%) sepia(15%) saturate(1000%) hue-rotate(200deg) brightness(90%) contrast(90%)",
                        }}
                      />
                      <span className="dark:text-gray-300 text-theme-primary text-sm font-medium">
                        Send Feedback
                      </span>
                    </button>
                  </div>
                </div>
              )}

              <div className="border-t dark:border-gray-700 border-[#d2d3db] pt-4">
                <div className="flex justify-between items-center">
                  <span className="dark:text-white text-theme-primary">
                    Avg. market value
                  </span>
                  <div className="flex flex-col items-end">
                    <span className="dark:text-white text-theme-primary text-lg font-bold">
                      {getCurrentPrice > 0
                        ? `$${getCurrentPrice.toFixed(2)}`
                        : "—"}
                    </span>
                    <div className="dark:text-gray-400 text-theme-secondary text-xs">
                      {getCurrentPrice > 0 ? "market data" : "no data"}
                    </div>
                  </div>
                </div>
              </div>
            </div>

            {/* Add to Collection Button */}
            <div className="mb-6">
              <button
                onClick={() => handleAddToCollection(selectedCard)}
                className="w-full bg-[#605DEC] text-white py-4 px-6 rounded-lg font-semibold text-lg hover:bg-[#605DEC]/80 transition-colors flex items-center justify-center gap-2"
              >
                <svg
                  className="w-5 h-5"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    strokeLinecap="round"
                    strokeLinejoin="round"
                    strokeWidth={2}
                    d="M12 6v6m0 0v6m0-6h6m-6 0H6"
                  />
                </svg>
                Add To Collection
              </button>
            </div>

            {/* Market Value Chart Section */}
            <div className="dark:bg-white/5 bg-white/20 backdrop-blur-md rounded-2xl p-6 mb-6 relative dark:border-white/10 border-[#d2d3db] border">
              <div className="flex items-center justify-between mb-4">
                <div className="flex items-center gap-2">
                  <svg
                    className="w-4 h-4 dark:text-white text-theme-primary"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 17 18"
                  >
                    <path
                      d="M1.70093 2.17285V15.7705H15.2986"
                      stroke="currentColor"
                      strokeWidth="1.28571"
                      strokeLinecap="round"
                      strokeLinejoin="round"
                    />
                    <path
                      d="M4.83911 8.44851L6.59152 10.2009C7.03773 10.6471 7.78063 10.5736 8.13067 10.0485L11.0651 5.64692C11.3784 5.17688 12.0187 5.05953 12.4784 5.38789L15.2989 7.40253"
                      stroke="currentColor"
                      strokeWidth="1.28571"
                      strokeLinecap="round"
                      strokeLinejoin="round"
                    />
                  </svg>
                  <h3 className="dark:text-white text-theme-primary font-medium">
                    Market Value
                  </h3>
                </div>
                <button
                  className="w-6 h-6 dark:text-white text-theme-primary hover:opacity-80 transition-opacity relative pricing-menu-container"
                  onClick={handlePricingMenuToggle}
                >
                  <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path
                      strokeLinecap="round"
                      strokeLinejoin="round"
                      strokeWidth={2}
                      d="M12 5v.01M12 12v.01M12 19v.01M12 6a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2z"
                    />
                  </svg>
                </button>
              </div>

              {/* Pricing Menu */}
              {showPricingMenu && (
                <div className="absolute right-0 top-12 z-50 dark:bg-gray-800/95 bg-[#fafafa]/95 backdrop-blur-md dark:border-white/10 border-[#d2d3db] rounded-lg shadow-lg py-2 w-56 pricing-menu-container">
                  <button
                    onClick={handleSetPriceAlert}
                    className="w-full px-4 py-3 text-left dark:text-white text-theme-primary dark:hover:bg-gray-700 hover:bg-[#e4e5f1] transition-colors flex items-center gap-3"
                  >
                    <img
                      src="/Assets/PriceAlert.svg"
                      alt="Price Alert"
                      className="w-4 h-4"
                    />
                    <span>Set Pricing Alerts</span>
                  </button>
                  <button
                    onClick={handleEditPricePaid}
                    className="w-full px-4 py-3 text-left dark:text-white text-theme-primary dark:hover:bg-gray-700 hover:bg-[#e4e5f1] transition-colors flex items-center gap-3"
                  >
                    <img
                      src="/Assets/Edit Price Paid.svg"
                      alt="Edit Price Paid"
                      className="w-4 h-4"
                    />
                    <span>Edit Price Paid</span>
                  </button>
                </div>
              )}

              {/* Price and Filters */}
              <div className="space-y-4 mb-4">
                {/* Price Display */}
                <div className="flex items-center justify-between">
                  <span className="dark:text-white text-theme-primary text-xl font-bold">
                    $
                    {(() => {
                      // Use getCurrentPrice as primary source (respects Raw/Graded selection)
                      if (getCurrentPrice > 0) {
                        return getCurrentPrice.toFixed(2);
                      }
                      // Fallback to chart data if no current price
                      if (
                        cardChartData.datasets &&
                        cardChartData.datasets.length > 0 &&
                        cardChartData.datasets[0].data.length > 0
                      ) {
                        return cardChartData.datasets[0].data[
                          cardChartData.datasets[0].data.length - 1
                        ].toFixed(2);
                      }
                      return "0.00";
                    })()}
                  </span>
                  <div
                    className={`flex items-center gap-1 text-sm ${(() => {
                      // Use the actual chart data from state
                      if (
                        !cardChartData.datasets ||
                        cardChartData.datasets.length === 0
                      ) {
                        return "dark:text-gray-400 text-theme-secondary";
                      }

                      const history = cardChartData.datasets[0].data;
                      if (history.length < 2) {
                        return "dark:text-gray-400 text-theme-secondary";
                      }

                      // Calculate absolute price change from start to end of time range
                      const currentPrice = history[history.length - 1];
                      const startPrice = history[0];
                      const absoluteChange = currentPrice - startPrice;

                      return absoluteChange >= 0
                        ? "text-green-400"
                        : "text-red-400";
                    })()}`}
                  >
                    <svg
                      className="w-3 h-3"
                      fill="none"
                      stroke="currentColor"
                      viewBox="0 0 24 24"
                    >
                      <path
                        strokeLinecap="round"
                        strokeLinejoin="round"
                        strokeWidth={2}
                        d={(() => {
                          // Use the actual chart data from state
                          if (
                            !cardChartData.datasets ||
                            cardChartData.datasets.length === 0
                          ) {
                            return "M7 11l5-5m0 0l5 5m-5-5v12"; // Default up arrow
                          }

                          const history = cardChartData.datasets[0].data;
                          if (history.length < 2) {
                            return "M7 11l5-5m0 0l5 5m-5-5v12"; // Default up arrow
                          }

                          // Calculate absolute price change from start to end of time range
                          const currentPrice = history[history.length - 1];
                          const startPrice = history[0];
                          const absoluteChange = currentPrice - startPrice;

                          // Return correct arrow based on price change direction
                          if (absoluteChange >= 0) {
                            return "M7 11l5-5m0 0l5 5m-5-5v12"; // Up arrow for increase
                          } else {
                            return "M17 13l-5 5m0 0l-5-5m5 5V6"; // Down arrow for decrease
                          }
                        })()}
                      />
                    </svg>
                    <span>
                      {(() => {
                        // Use the actual chart data from state
                        if (
                          !cardChartData.datasets ||
                          cardChartData.datasets.length === 0
                        ) {
                          return "$0.00";
                        }

                        const history = cardChartData.datasets[0].data;
                        if (history.length < 2) {
                          return "$0.00";
                        }

                        // Calculate absolute price change from start to end of time range
                        const currentPrice = history[history.length - 1];
                        const startPrice = history[0];
                        const absoluteChange = currentPrice - startPrice;

                        return `$${absoluteChange >= 0 ? "+" : "-"}${Math.abs(
                          absoluteChange
                        ).toFixed(2)}`;
                      })()}
                    </span>
                    <span>
                      {(() => {
                        // Update text based on timeline selection
                        const tcgplayerPrices =
                          selectedCard?.tcgplayer?.prices || {};
                        const hasRealData =
                          tcgplayerPrices.holofoil?.market ||
                          tcgplayerPrices.normal?.market;

                        if (!hasRealData) return "estimated";

                        switch (cardChartTimeRange) {
                          case "1D":
                            return "today";
                          case "7D":
                            return "this week";
                          case "1M":
                            return "this month";
                          case "3M":
                            return "past 3 months";
                          case "6M":
                            return "past 6 months";
                          case "1Y":
                            return "past year";
                          case "Max":
                            return "total";
                          default:
                            return "this week";
                        }
                      })()}
                    </span>
                  </div>
                </div>

                {/* Variant and Condition Dropdowns */}
                <div className="flex gap-2">
                  <div
                    className="relative variant-dropdown-container"
                    style={{ width: "65%" }}
                  >
                    <button
                      onClick={() =>
                        setShowCardVariantDropdown(!showCardVariantDropdown)
                      }
                      className="px-4 py-2 dark:bg-gray-700 bg-gray-100 dark:text-white text-theme-primary text-sm rounded flex items-center gap-2 dark:hover:bg-gray-600 hover:bg-gray-200 transition-colors w-full justify-between whitespace-nowrap dark:border-gray-600 border-[#d2d3db] border"
                    >
                      {getCardVariants.find((v) => v.id === selectedCardVariant)
                        ?.name || "Normal"}
                      <svg
                        className="w-3 h-3"
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                      >
                        <path
                          strokeLinecap="round"
                          strokeLinejoin="round"
                          strokeWidth={2}
                          d="M19 9l-7 7-7-7"
                        />
                      </svg>
                    </button>
                    {showCardVariantDropdown && (
                      <div className="absolute top-full left-0 mt-1 dark:bg-gray-800 bg-white dark:border-gray-600 border-[#d2d3db] rounded-lg shadow-lg z-50 min-w-full border">
                        {getCardVariants.map((variant) => (
                          <button
                            key={variant.id}
                            onClick={() => {
                              setSelectedCardVariant(variant.id);
                              setShowCardVariantDropdown(false);
                            }}
                            className={`w-full px-4 py-3 text-left text-sm dark:hover:bg-gray-700 hover:bg-[#e4e5f1] transition-colors first:rounded-t-lg last:rounded-b-lg ${
                              selectedCardVariant === variant.id
                                ? "dark:bg-gray-700 bg-[#e4e5f1] dark:text-white text-theme-primary"
                                : "dark:text-gray-300 text-theme-primary"
                            }`}
                          >
                            <div className="flex justify-between items-center gap-4">
                              <span className="flex-1 text-left">
                                {variant.name}
                              </span>
                              <span className="text-xs dark:text-gray-400 text-theme-secondary font-medium whitespace-nowrap">
                                ${variant.price.toFixed(2)}
                              </span>
                            </div>
                          </button>
                        ))}
                      </div>
                    )}
                  </div>

                  {/* Raw/Graded Dropdown */}
                  <div
                    className="relative card-type-dropdown-container"
                    style={{ width: "35%" }}
                  >
                    <button
                      onClick={() =>
                        setShowCardTypeDropdown(!showCardTypeDropdown)
                      }
                      className="px-4 py-2 dark:bg-gray-700 bg-gray-100 dark:text-white text-theme-primary text-sm rounded flex items-center gap-2 dark:hover:bg-gray-600 hover:bg-gray-200 transition-colors w-full justify-between dark:border-gray-600 border-[#d2d3db] border"
                    >
                      {selectedCardType}
                      <svg
                        className="w-3 h-3"
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                      >
                        <path
                          strokeLinecap="round"
                          strokeLinejoin="round"
                          strokeWidth={2}
                          d="M19 9l-7 7-7-7"
                        />
                      </svg>
                    </button>
                    {showCardTypeDropdown && (
                      <div className="absolute top-full left-0 mt-1 dark:bg-gray-800 bg-white dark:border-gray-600 border-[#d2d3db] rounded-lg shadow-lg z-50 min-w-full border">
                        {[
                          { id: "Raw", name: "Raw" },
                          { id: "Graded", name: "Graded" },
                        ].map((type) => (
                          <button
                            key={type.id}
                            onClick={() => {
                              setSelectedCardType(type.name);
                              setShowCardTypeDropdown(false);
                              setSelectedComparisons([]); // Clear comparisons when switching types
                            }}
                            className={`w-full px-4 py-3 text-left text-sm dark:hover:bg-gray-700 hover:bg-[#e4e5f1] transition-colors first:rounded-t-lg last:rounded-b-lg ${
                              selectedCardType === type.name
                                ? "dark:bg-gray-700 bg-[#e4e5f1] dark:text-white text-theme-primary"
                                : "dark:text-gray-300 text-theme-primary"
                            }`}
                          >
                            {type.name}
                          </button>
                        ))}
                      </div>
                    )}
                  </div>
                </div>
              </div>

              {/* Card Price Chart */}
              <div className="h-48 dark:bg-gray-700 bg-gray-100 rounded-lg mb-4 p-4">
                {(() => {
                  // Debug: Log current state for troubleshooting
                  console.log("📊 [CHART DEBUG] Chart rendering state:", {
                    chartLoading,
                    chartError: chartError || "none",
                    hasCardChartData: !!cardChartData,
                    datasets: cardChartData?.datasets?.length || 0,
                    dataLength: cardChartData?.datasets?.[0]?.data?.length || 0,
                    labelsLength: cardChartData?.labels?.length || 0,
                    selectedCard: selectedCard?.name || "none",
                    timeRange: cardChartTimeRange,
                    variant: selectedCardVariant,
                  });

                  if (chartLoading) {
                    return (
                      <div className="h-full flex flex-col items-center justify-center text-center">
                        <div className="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-[#605DEC] mb-3"></div>
                        <p className="dark:text-gray-300 text-theme-primary text-sm">
                          Loading price history...
                        </p>
                      </div>
                    );
                  }

                  if (chartError) {
                    return (
                      <div className="h-full flex flex-col items-center justify-center text-center">
                        <svg
                          className="w-12 h-12 text-red-400 mb-3"
                          fill="none"
                          stroke="currentColor"
                          viewBox="0 0 24 24"
                        >
                          <path
                            strokeLinecap="round"
                            strokeLinejoin="round"
                            strokeWidth="2"
                            d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"
                          />
                        </svg>
                        <h3 className="text-lg font-semibold text-red-400 mb-2">
                          Chart Data Unavailable
                        </h3>
                        <p className="dark:text-gray-300 text-theme-primary text-sm mb-3">
                          {chartError}
                        </p>
                        <button
                          onClick={() => {
                            setChartError(null);
                            setChartLoading(true);
                            // Trigger reload by updating time range
                            setCardChartTimeRange(cardChartTimeRange);
                          }}
                          className="px-4 py-2 bg-[#605DEC] hover:bg-[#4F46E5] text-white rounded-lg text-sm font-medium transition-colors"
                        >
                          Try Again
                        </button>
                      </div>
                    );
                  }

                  // Check for valid chart data
                  const hasValidData =
                    cardChartData &&
                    cardChartData.datasets &&
                    Array.isArray(cardChartData.datasets) &&
                    cardChartData.datasets.length > 0 &&
                    cardChartData.datasets[0] &&
                    cardChartData.datasets[0].data &&
                    Array.isArray(cardChartData.datasets[0].data) &&
                    cardChartData.datasets[0].data.length > 0 &&
                    cardChartData.labels &&
                    Array.isArray(cardChartData.labels) &&
                    cardChartData.labels.length > 0;

                  console.log("📊 [CHART DEBUG] Validation result:", {
                    hasValidData,
                    fullCardChartData: cardChartData,
                  });

                  if (hasValidData) {
                    return (
                      <Line
                        key={`${selectedCard?.id}-${cardChartTimeRange}-${selectedCardVariant}`}
                        data={cardChartData}
                        options={cardChartOptions}
                      />
                    );
                  }

                  return (
                    <div className="h-full flex flex-col items-center justify-center text-center">
                      <svg
                        className="w-12 h-12 dark:text-gray-400 text-theme-secondary mb-3"
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                      >
                        <path
                          strokeLinecap="round"
                          strokeLinejoin="round"
                          strokeWidth={2}
                          d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"
                        />
                      </svg>
                      <h3 className="text-lg font-semibold dark:text-gray-400 text-theme-secondary mb-2">
                        No Price History Available
                      </h3>
                      <p className="dark:text-gray-500 text-theme-tertiary text-sm">
                        This card doesn't have historical price data for the
                        selected time period.
                      </p>
                      <button
                        onClick={() => {
                          setChartLoading(true);
                          setCardChartTimeRange(cardChartTimeRange);
                        }}
                        className="mt-2 px-4 py-2 bg-[#605DEC] hover:bg-[#4F46E5] text-white rounded-lg text-sm font-medium transition-colors"
                      >
                        Refresh
                      </button>
                    </div>
                  );
                })()}
              </div>

              {/* Time Range Buttons */}
              <div className="flex gap-1 mb-4 w-full overflow-x-auto">
                {["7D", "1M", "3M", "6M", "1Y", "All"].map((period) => (
                  <button
                    key={period}
                    onClick={() => setCardChartTimeRange(period)}
                    className={`flex-1 px-2 py-2 text-xs rounded-lg font-medium whitespace-nowrap min-w-0 ${
                      cardChartTimeRange === period
                        ? "bg-gradient-to-r from-blue-500 to-indigo-600 text-white"
                        : "dark:bg-white/10 bg-white/20 dark:text-blue-200 text-[#6865E7] dark:hover:bg-white/20 hover:bg-white/30 dark:border-white/20 border-[#d2d3db] border"
                    }`}
                  >
                    {period}
                  </button>
                ))}
              </div>

              {/* Condition/Graded Price Selection */}
              {selectedCardType === "Raw" ? (
                <div className="mb-4">
                  <h4 className="dark:text-gray-400 text-theme-secondary text-sm mb-2">
                    Ungraded Values
                  </h4>
                  <div className="flex gap-2 overflow-x-auto pb-2">
                    {[
                      { id: "NM", name: "Near Mint", condition: "near_mint" },
                      {
                        id: "LP",
                        name: "Lightly Played",
                        condition: "lightly_played",
                      },
                      {
                        id: "MP",
                        name: "Moderately Played",
                        condition: "moderately_played",
                      },
                      {
                        id: "HP",
                        name: "Heavily Played",
                        condition: "heavily_played",
                      },
                      { id: "DM", name: "Damaged", condition: "damaged" },
                    ].map((item) => {
                      const isSelected = selectedComparisons.some(
                        (comp) => comp.id === item.id
                      );
                      const price = conditionPrices?.[item.condition] || 0;
                      return (
                        <button
                          key={item.id}
                          onClick={() => {
                            if (isSelected) {
                              setSelectedComparisons((prev) =>
                                prev.filter((c) => c.id !== item.id)
                              );
                            } else {
                              setSelectedComparisons((prev) => [
                                ...prev,
                                {
                                  id: item.id,
                                  name: item.name,
                                  type: "raw",
                                  condition: item.condition,
                                },
                              ]);
                            }
                          }}
                          className={`px-4 py-3 rounded-lg text-center min-w-[80px] transition-all ${
                            isSelected
                              ? "bg-blue-600 text-white"
                              : "dark:bg-gray-700 bg-gray-200 dark:hover:bg-gray-600 hover:bg-gray-300 dark:text-white text-theme-primary"
                          }`}
                        >
                          <div
                            className="text-xs font-medium text-center inline-block"
                            style={{ width: "52px" }}
                          >
                            {item.id}
                          </div>
                          <div className="text-sm font-bold">
                            {price && price > 0 ? `$${price.toFixed(2)}` : "—"}
                          </div>
                        </button>
                      );
                    })}
                  </div>
                </div>
              ) : (
                <div className="mb-4">
                  <h4 className="dark:text-gray-400 text-theme-secondary text-sm mb-2">
                    PSA Values
                  </h4>
                  <div className="flex gap-2 overflow-x-auto pb-2">
                    {[
                      { id: "GEM-MT", grade: "10", name: "Gem Mint" },
                      { id: "MINT", grade: "9", name: "Mint" },
                      { id: "NM-MT", grade: "8", name: "Near Mint-Mint" },
                      { id: "NM", grade: "7", name: "Near Mint" },
                      { id: "EX-MT", grade: "6", name: "Excellent-Mint" },
                    ].map((item) => {
                      const isSelected = selectedComparisons.some(
                        (comp) => comp.id === item.id
                      );
                      const gradedData = gradedPrices?.PSA?.find(
                        (g) => g.grade === parseInt(item.grade)
                      );
                      const price = gradedData?.price || 0;
                      return (
                        <button
                          key={item.id}
                          onClick={() => {
                            if (isSelected) {
                              setSelectedComparisons((prev) =>
                                prev.filter((c) => c.id !== item.id)
                              );
                            } else {
                              setSelectedComparisons((prev) => [
                                ...prev,
                                {
                                  id: item.id,
                                  name: item.name,
                                  type: "graded",
                                  grade: item.grade,
                                },
                              ]);
                            }
                          }}
                          className={`px-4 py-3 rounded-lg text-center min-w-[80px] transition-all ${
                            isSelected
                              ? "bg-blue-600 text-white"
                              : "dark:bg-gray-700 bg-gray-200 dark:hover:bg-gray-600 hover:bg-gray-300 dark:text-white text-theme-primary"
                          }`}
                        >
                          <div
                            className="text-xs font-medium text-center inline-block whitespace-nowrap"
                            style={{ width: "52px" }}
                          >
                            {item.id}
                          </div>
                          <div className="text-sm">{item.grade}</div>
                          <div className="text-sm font-bold">
                            {price && price > 0 ? `$${price.toFixed(2)}` : "—"}
                          </div>
                        </button>
                      );
                    })}
                  </div>
                </div>
              )}

              {/* Graded Prices Section */}
              {gradedPrices && Object.keys(gradedPrices).length > 0 && (
                <div className="dark:bg-gray-800 bg-gray-100 rounded-2xl p-6 mb-6">
                  <div className="flex items-center justify-between mb-4">
                    <div className="flex items-center gap-2">
                      <img
                        src="/Assets/Price.svg"
                        alt="Graded Prices"
                        className="w-4 h-4"
                        style={{
                          filter: isDark
                            ? "none"
                            : "brightness(0) saturate(100%) invert(30%) sepia(15%) saturate(1000%) hue-rotate(200deg) brightness(90%) contrast(90%)",
                        }}
                      />
                      <h3 className="dark:text-white text-theme-primary font-medium">
                        Graded Card Values
                      </h3>
                    </div>
                    <button
                      onClick={() => setShowGradedPrices(!showGradedPrices)}
                      className="text-blue-400 hover:text-blue-300 text-sm font-medium"
                    >
                      {showGradedPrices ? "Hide" : "Show"} Details
                    </button>
                  </div>

                  {showGradedPrices ? (
                    <div className="space-y-4">
                      {Object.entries(gradedPrices).map(([service, grades]) => (
                        <div
                          key={service}
                          className="dark:bg-gray-700 bg-gray-200 rounded-lg p-4"
                        >
                          <h4 className="dark:text-white text-theme-primary font-medium mb-3">
                            {service} Graded
                          </h4>
                          <div className="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-3">
                            {grades.map((grade) => (
                              <div
                                key={`${service}-${grade.grade}`}
                                className="dark:bg-gray-600 bg-gray-300 rounded p-3 text-center"
                              >
                                <div className="dark:text-white text-theme-primary text-sm font-medium mb-1">
                                  {service} {grade.grade}
                                </div>
                                <div className="dark:text-white text-theme-primary text-lg font-bold">
                                  {grade.price
                                    ? `$${grade.price.toFixed(2)}`
                                    : "—"}
                                </div>
                                {grade.market_trend && (
                                  <div
                                    className={`text-xs mt-1 ${
                                      grade.market_trend === "rising"
                                        ? "text-green-400"
                                        : grade.market_trend === "falling"
                                        ? "text-red-400"
                                        : "text-gray-400"
                                    }`}
                                  >
                                    {grade.market_trend}
                                  </div>
                                )}
                                {grade.sales_velocity && (
                                  <div className="text-xs text-gray-400 mt-1">
                                    {grade.sales_velocity.toFixed(1)}/day
                                  </div>
                                )}
                              </div>
                            ))}
                          </div>
                        </div>
                      ))}
                    </div>
                  ) : (
                    <div className="text-center py-4">
                      <div className="text-gray-400 text-sm">
                        {Object.values(gradedPrices).reduce(
                          (total, grades) => total + grades.length,
                          0
                        )}{" "}
                        graded prices available
                      </div>
                      <div className="text-gray-500 text-xs mt-1">
                        Click "Show Details" to view all grades
                      </div>
                    </div>
                  )}
                </div>
              )}
            </div>

            {/* Card Info Section */}
            <div className="dark:bg-gray-800 bg-gray-100 rounded-2xl p-6 mb-6">
              <div className="flex items-center gap-2 mb-4">
                <img
                  src="/Assets/CardInfo.svg"
                  alt="Card Info"
                  className="w-4 h-4"
                  style={{
                    filter: isDark
                      ? "none"
                      : "brightness(0) saturate(100%) invert(30%) sepia(15%) saturate(1000%) hue-rotate(200deg) brightness(90%) contrast(90%)",
                  }}
                />
                <h3 className="dark:text-white text-theme-primary font-medium">
                  Card info
                </h3>
              </div>

              {/* Attack Section */}
              <div className="mb-4">
                <div className="dark:bg-gray-700 bg-gray-200 rounded-lg p-4">
                  {/* Pokémon Power Section */}
                  {selectedCard?.abilities &&
                    (() => {
                      try {
                        console.log(
                          "Main App - selectedCard.abilities:",
                          selectedCard.abilities
                        );
                        const abilities =
                          typeof selectedCard.abilities === "string"
                            ? JSON.parse(selectedCard.abilities)
                            : selectedCard.abilities;
                        console.log("Main App - parsed abilities:", abilities);
                        console.log(
                          "Main App - is array:",
                          Array.isArray(abilities)
                        );
                        console.log("Main App - length:", abilities?.length);
                        return (
                          abilities &&
                          Array.isArray(abilities) &&
                          abilities.length > 0
                        );
                      } catch (e) {
                        console.log(
                          "Main App - error parsing abilities:",
                          e.message
                        );
                        return false;
                      }
                    })() && (
                      <div className="mb-4">
                        {(() => {
                          try {
                            const abilities =
                              typeof selectedCard.abilities === "string"
                                ? JSON.parse(selectedCard.abilities)
                                : selectedCard.abilities;
                            return abilities.map((ability, index) => (
                              <div
                                key={index}
                                className={index > 0 ? "mt-4" : ""}
                              >
                                <div className="flex items-center gap-2 mb-2">
                                  <span className="text-red-400 text-sm font-medium">
                                    {ability.type}
                                  </span>
                                  <span className="dark:text-white text-theme-primary text-base font-bold flex items-center">
                                    {ability.name}
                                  </span>
                                </div>
                                <p className="dark:text-white text-theme-primary text-sm font-light">
                                  {renderEnergyText(
                                    ability.text ||
                                      ability.effect ||
                                      ability.description
                                  )}
                                </p>
                              </div>
                            ));
                          } catch {
                            return null;
                          }
                        })()}
                      </div>
                    )}

                  {/* Attacks Section */}
                  {selectedCard?.attacks &&
                    (() => {
                      try {
                        const attacks =
                          typeof selectedCard.attacks === "string"
                            ? JSON.parse(selectedCard.attacks)
                            : selectedCard.attacks;
                        return attacks && attacks.length > 0;
                      } catch {
                        return false;
                      }
                    })() && (
                      <div
                        className={(() => {
                          // Check if there are abilities to determine if we need a top border
                          try {
                            const abilities =
                              typeof selectedCard.abilities === "string"
                                ? JSON.parse(selectedCard.abilities)
                                : selectedCard.abilities;
                            const hasAbilities =
                              abilities &&
                              Array.isArray(abilities) &&
                              abilities.length > 0;
                            return hasAbilities
                              ? "border-t dark:border-gray-600 border-[#d2d3db] pt-4 mb-4"
                              : "mb-4";
                          } catch {
                            return "mb-4";
                          }
                        })()}
                      >
                        {(() => {
                          try {
                            const attacks =
                              typeof selectedCard.attacks === "string"
                                ? JSON.parse(selectedCard.attacks)
                                : selectedCard.attacks;

                            // Helper function to parse attack if API didn't parse it
                            const parseAttackIfNeeded = (attack) => {
                              // If cost is already parsed, return as-is
                              if (
                                attack.cost &&
                                Array.isArray(attack.cost) &&
                                attack.cost.length > 0 &&
                                attack.damage
                              ) {
                                return attack;
                              }

                              // Otherwise, parse from name
                              const attackText = attack.name || "";
                              const energyCosts = [];
                              const energyPattern = /\[([^\]]+)\]/g;
                              let match;

                              while (
                                (match = energyPattern.exec(attackText)) !==
                                null
                              ) {
                                const energyType = match[1].trim();
                                const energyMap = {
                                  Grass: "Grass",
                                  G: "Grass",
                                  Fire: "Fire",
                                  R: "Fire",
                                  Water: "Water",
                                  W: "Water",
                                  Lightning: "Lightning",
                                  L: "Lightning",
                                  Psychic: "Psychic",
                                  P: "Psychic",
                                  Fighting: "Fighting",
                                  F: "Fighting",
                                  Darkness: "Darkness",
                                  D: "Darkness",
                                  Metal: "Metal",
                                  M: "Metal",
                                  Colorless: "Colorless",
                                  C: "Colorless",
                                  Fairy: "Fairy",
                                  Y: "Fairy",
                                  Dragon: "Dragon",
                                };
                                const mappedEnergy =
                                  energyMap[energyType] || energyType;
                                energyCosts.push(mappedEnergy);
                              }

                              // Extract damage
                              const damageMatch =
                                attackText.match(/\((\d+)\)\s*$/);
                              const damage = damageMatch
                                ? damageMatch[1]
                                : attack.damage || "";

                              // Extract name (remove energy costs and damage)
                              let name = attackText
                                .replace(/\[([^\]]+)\]/g, "")
                                .trim();
                              if (damageMatch) {
                                name = name.replace(/\(\d+\)\s*$/, "").trim();
                              }

                              return {
                                ...attack,
                                name: name || attack.name || "Unknown Attack",
                                cost:
                                  energyCosts.length > 0
                                    ? energyCosts
                                    : attack.cost || [],
                                damage: damage || attack.damage || "",
                              };
                            };

                            return attacks.map((attack, index) => {
                              const parsedAttack = parseAttackIfNeeded(attack);
                              return (
                                <div
                                  key={index}
                                  className={`dark:bg-gray-700/30 bg-gray-200/50 rounded-lg p-4 ${
                                    index > 0 ? "mt-3" : ""
                                  }`}
                                >
                                  {/* Attack Cost, Name, and Damage */}
                                  <div className="flex items-center gap-2 mb-2">
                                    {/* Display energy costs */}
                                    {parsedAttack.cost &&
                                    Array.isArray(parsedAttack.cost) &&
                                    parsedAttack.cost.length > 0
                                      ? renderEnergyCost(parsedAttack.cost)
                                      : null}
                                    {/* Display attack name and damage */}
                                    <span className="dark:text-white text-theme-primary text-base font-bold">
                                      {parsedAttack.name || "Unknown Attack"}
                                      {parsedAttack.damage &&
                                        ` (${parsedAttack.damage})`}
                                    </span>
                                  </div>
                                  {/* Attack description - only show if it exists */}
                                  {parsedAttack.text && (
                                    <p className="dark:text-gray-300 text-theme-primary text-sm leading-relaxed mt-2">
                                      {parsedAttack.text}
                                    </p>
                                  )}
                                </div>
                              );
                            });
                          } catch {
                            return null;
                          }
                        })()}
                      </div>
                    )}

                  {/* Fallback when no abilities or attacks */}
                  {!(() => {
                    try {
                      const abilities =
                        typeof selectedCard?.abilities === "string"
                          ? JSON.parse(selectedCard.abilities)
                          : selectedCard?.abilities;
                      const hasAbilities =
                        abilities &&
                        Array.isArray(abilities) &&
                        abilities.length > 0;

                      const attacks =
                        typeof selectedCard?.attacks === "string"
                          ? JSON.parse(selectedCard.attacks)
                          : selectedCard?.attacks;
                      const hasAttacks =
                        attacks && Array.isArray(attacks) && attacks.length > 0;

                      return hasAbilities || hasAttacks;
                    } catch {
                      return false;
                    }
                  })() && (
                    <div className="text-center py-8">
                      <div className="dark:text-gray-400 text-theme-secondary text-sm">
                        {selectedCard?.supertype === "Pokémon"
                          ? "No abilities or attacks for this Pokémon"
                          : selectedCard?.supertype === "Trainer"
                          ? "No special abilities for this Trainer card"
                          : "No special abilities or attacks for this card"}
                      </div>
                    </div>
                  )}
                </div>
              </div>

              {/* Card Attributes Grid */}
              <div className="grid grid-cols-3 gap-4">
                <div
                  className="dark:bg-gray-700 bg-gray-200 rounded p-3 text-center cursor-pointer dark:hover:bg-gray-600 hover:bg-gray-300 transition-colors"
                  onClick={async () => {
                    if (selectedCard?.artist) {
                      const query = selectedCard.artist;
                      setShowCardProfile(false);
                      setSearchQuery(query);
                      setShowSearchResults(true);
                      setActiveTab("search");
                      setNavigationMode("search");
                      // Small delay to ensure modal closes, then search
                      setTimeout(async () => {
                        await handleSearch();
                      }, 200);
                    }
                  }}
                >
                  <div className="dark:text-white text-theme-primary text-xs mb-2">
                    Illustrator
                  </div>
                  <div className="text-blue-400 text-sm hover:text-blue-300">
                    {selectedCard.artist || "Artist Not Available"}
                  </div>
                </div>
                <div
                  className="dark:bg-gray-700 bg-gray-200 rounded p-3 text-center cursor-pointer dark:hover:bg-gray-600 hover:bg-gray-300 transition-colors"
                  onClick={async () => {
                    const setName =
                      selectedCard.clean_set_name ||
                      selectedCard.set?.name ||
                      selectedCard.set_name;
                    if (setName) {
                      setShowCardProfile(false);
                      setSearchQuery(setName);
                      setShowSearchResults(true);
                      setActiveTab("search");
                      setNavigationMode("search");
                      setSortOption("number-asc"); // Auto-sort by number when searching by set
                      setTimeout(async () => {
                        await handleSearch();
                      }, 200);
                    }
                  }}
                >
                  <div className="dark:text-white text-theme-primary text-xs mb-2">
                    Expansion
                  </div>
                  <div className="flex items-center justify-center gap-2">
                    {(() => {
                      const setNameRaw = (
                        selectedCard.clean_set_name ||
                        selectedCard.set?.name ||
                        selectedCard.set_name ||
                        ""
                      ).toString();
                      const series = seriesFromSetName(
                        selectedCard.set?.name || selectedCard.set_name || ""
                      );
                      const language = selectedCard?.language || "en";
                      const primaryLocal = getSetSymbolPath(
                        cleanSetName(setNameRaw),
                        series,
                        language
                      );
                      let images = selectedCard.images;
                      if (typeof images === "string") {
                        try {
                          images = JSON.parse(images);
                        } catch {
                          images = undefined;
                        }
                      }
                      const candidates = [
                        primaryLocal,
                        images?.symbol,
                        selectedCard.set_symbol_url,
                        getSetSymbolPath(
                          (
                            selectedCard.set?.name ||
                            selectedCard.set_name ||
                            ""
                          ).toString(),
                          series,
                          language
                        ),
                      ].filter(Boolean);
                      if (candidates.length === 0) return null;
                      const dataSources = candidates.join("|");
                      return (
                        <img
                          src={candidates[0]}
                          alt="Set Symbol"
                          className="h-6 w-auto object-contain"
                          data-sources={dataSources}
                          data-idx="0"
                          onError={(e) => {
                            const el = e.currentTarget;
                            const sources = (
                              el.getAttribute("data-sources") || ""
                            )
                              .split("|")
                              .filter(Boolean);
                            const currentIdx = parseInt(
                              el.getAttribute("data-idx") || "0",
                              10
                            );
                            const nextIdx = currentIdx + 1;
                            if (nextIdx < sources.length) {
                              el.setAttribute("data-idx", String(nextIdx));
                              el.src = sources[nextIdx];
                            } else {
                              el.style.display = "none";
                            }
                          }}
                        />
                      );
                    })()}
                    <div className="text-blue-400 text-sm hover:text-blue-300">
                      {selectedCard.set?.name ||
                        selectedCard.set_name ||
                        "Expansion Name"}
                    </div>
                  </div>
                </div>
                <div className="dark:bg-gray-700 bg-gray-200 rounded p-3 text-center">
                  <div className="dark:text-white text-theme-primary text-xs mb-2">
                    Card Number
                  </div>
                  <div className="dark:text-white text-theme-primary text-sm">
                    {selectedCard.formattedNumber}
                  </div>
                </div>
                <div className="dark:bg-gray-700 bg-gray-200 rounded p-3 text-center">
                  <div className="dark:text-white text-theme-primary text-xs mb-2">
                    HP
                  </div>
                  <div className="dark:text-white text-theme-primary text-sm">
                    {selectedCard?.hp || "N/A"}
                  </div>
                </div>
                <div
                  className="dark:bg-gray-700 bg-gray-200 rounded p-3 text-center cursor-pointer dark:hover:bg-gray-600 hover:bg-gray-300 transition-colors"
                  onClick={async () => {
                    let pokemonType = selectedCard?.type;

                    // If no type field, try to get from types array
                    if (!pokemonType && selectedCard?.types) {
                      if (Array.isArray(selectedCard.types)) {
                        pokemonType = selectedCard.types[0];
                      } else if (typeof selectedCard.types === "string") {
                        try {
                          const parsed = JSON.parse(selectedCard.types);
                          pokemonType = Array.isArray(parsed)
                            ? parsed[0]
                            : parsed;
                        } catch (e) {
                          // If it's not JSON, use the string directly
                          pokemonType = selectedCard.types;
                        }
                      }
                    }
                    if (pokemonType) {
                      setShowCardProfile(false);
                      setSearchQuery(pokemonType);
                      setShowSearchResults(true);
                      setActiveTab("search");
                      setNavigationMode("search");
                      setTimeout(async () => {
                        await handleSearch();
                      }, 200);
                    }
                  }}
                >
                  <div className="dark:text-white text-theme-primary text-xs mb-2">
                    Type
                  </div>
                  <div className="flex items-center justify-center gap-2">
                    {(() => {
                      let energyType = selectedCard?.type;

                      // If no type field, try to get from types array
                      if (!energyType && selectedCard?.types) {
                        if (Array.isArray(selectedCard.types)) {
                          energyType = selectedCard.types[0];
                        } else if (typeof selectedCard.types === "string") {
                          try {
                            const parsed = JSON.parse(selectedCard.types);
                            energyType = Array.isArray(parsed)
                              ? parsed[0]
                              : parsed;
                          } catch (e) {
                            // If it's not JSON, use the string directly
                            energyType = selectedCard.types;
                          }
                        }
                      }

                      console.log("Energy type debug:", {
                        selectedCard: selectedCard,
                        type: selectedCard?.type,
                        types: selectedCard?.types,
                        energyType: energyType,
                      });

                      return energyType ? (
                        <>
                          <img
                            src={getEnergyIconPath(energyType)}
                            alt={`${energyType} Energy`}
                            className="w-5 h-5"
                          />
                          <div className="text-blue-400 text-sm hover:text-blue-300">
                            {energyType}
                          </div>
                        </>
                      ) : (
                        <>
                          <div className="w-5 h-5 dark:bg-gray-600 bg-gray-300 rounded"></div>
                          <div className="dark:text-gray-500 text-theme-tertiary text-sm">
                            —
                          </div>
                        </>
                      );
                    })()}
                  </div>
                </div>
                <div
                  className="dark:bg-gray-700 bg-gray-200 rounded p-3 text-center cursor-pointer dark:hover:bg-gray-600 hover:bg-gray-300 transition-colors"
                  onClick={async () => {
                    const stage =
                      selectedCard?.stage || selectedCard?.supertype;
                    if (stage) {
                      setShowCardProfile(false);
                      setSearchQuery(stage);
                      setShowSearchResults(true);
                      setActiveTab("search");
                      setNavigationMode("search");
                      setTimeout(async () => {
                        await handleSearch();
                      }, 200);
                    }
                  }}
                >
                  <div className="dark:text-white text-theme-primary text-xs mb-2">
                    Stage
                  </div>
                  <div className="text-blue-400 text-sm hover:text-blue-300">
                    {(() => {
                      // Prioritize stage from API (derived from TCGCSV extendedData)
                      if (selectedCard?.stage) {
                        return selectedCard.stage;
                      }
                      // Fallback to subtypes if stage not available
                      if (selectedCard?.subtypes) {
                        if (Array.isArray(selectedCard.subtypes)) {
                          const stageSubtype = selectedCard.subtypes.find(
                            (st) =>
                              typeof st === "string" &&
                              (st.toLowerCase().includes("stage") ||
                                st.toLowerCase().includes("basic"))
                          );
                          if (stageSubtype) {
                            // Handle "Stage1" or "Stage 1" format
                            return stageSubtype.replace(
                              /Stage(\d)/i,
                              "Stage $1"
                            );
                          }
                          return selectedCard.subtypes[0] || "Basic";
                        } else if (typeof selectedCard.subtypes === "string") {
                          // Handle "Stage1" or "Stage 1" format
                          return selectedCard.subtypes.replace(
                            /Stage(\d)/i,
                            "Stage $1"
                          );
                        }
                      }
                      return "Basic";
                    })()}
                  </div>
                </div>
                <div className="dark:bg-gray-700 bg-gray-200 rounded p-3 text-center">
                  <div className="dark:text-white text-theme-primary text-xs mb-2">
                    Weakness
                  </div>
                  <div className="flex items-center justify-center gap-1">
                    {(() => {
                      console.log(
                        "🎯 Weakness Debug - selectedCard.weaknesses:",
                        selectedCard?.weaknesses
                      );
                      if (
                        selectedCard?.weaknesses &&
                        Array.isArray(selectedCard.weaknesses) &&
                        selectedCard.weaknesses.length > 0
                      ) {
                        const weakness = selectedCard.weaknesses[0];
                        console.log(
                          "🎯 Weakness Debug - first weakness object:",
                          weakness
                        );

                        // Handle different weakness data formats
                        let weaknessType = null;
                        let weaknessValue = "×2";

                        if (typeof weakness === "object" && weakness !== null) {
                          // Proper format: {type: "Water", value: "×2"}
                          let rawType =
                            weakness.type || weakness.weaknessType || null;
                          weaknessValue =
                            weakness.value || weakness.weaknessValue || "×2";

                          // If type is in format like "Wx2" or "Fx2", extract just the letter
                          if (rawType && typeof rawType === "string") {
                            // Check if it matches patterns like "Wx2", "Fx2", etc.
                            const singleLetterMatch =
                              rawType.match(/^([A-Z])x\d+$/i);
                            if (singleLetterMatch) {
                              weaknessType = singleLetterMatch[1].toUpperCase();
                            } else {
                              // Check if it contains x2 or ×2 - extract the part before it
                              const combinedMatch =
                                rawType.match(/^(.+?)[\s×xX]\d+/);
                              if (combinedMatch) {
                                weaknessType = combinedMatch[1].trim();
                              } else {
                                weaknessType = rawType;
                              }
                            }

                            // Normalize the extracted type
                            const typeUpper = weaknessType.toUpperCase().trim();
                            if (
                              typeUpper === "W" ||
                              typeUpper === "WX2" ||
                              typeUpper.startsWith("WATER")
                            )
                              weaknessType = "Water";
                            else if (
                              typeUpper === "F" ||
                              typeUpper === "FX2" ||
                              typeUpper.startsWith("FIRE")
                            )
                              weaknessType = "Fire";
                            else if (typeUpper.startsWith("FIGHTING"))
                              weaknessType = "Fighting";
                            else if (
                              typeUpper === "G" ||
                              typeUpper === "GX2" ||
                              typeUpper.startsWith("GRASS")
                            )
                              weaknessType = "Grass";
                            else if (
                              typeUpper === "P" ||
                              typeUpper === "PX2" ||
                              typeUpper.startsWith("PSYCHIC")
                            )
                              weaknessType = "Psychic";
                            else if (
                              typeUpper === "L" ||
                              typeUpper === "LX2" ||
                              typeUpper.startsWith("LIGHTNING") ||
                              typeUpper.startsWith("ELECTRIC")
                            )
                              weaknessType = "Electric";
                            else if (
                              typeUpper === "D" ||
                              typeUpper === "DX2" ||
                              typeUpper.startsWith("DARKNESS")
                            )
                              weaknessType = "Darkness";
                            else if (
                              typeUpper === "M" ||
                              typeUpper === "MX2" ||
                              typeUpper.startsWith("METAL")
                            )
                              weaknessType = "Metal";
                            else if (
                              typeUpper === "C" ||
                              typeUpper === "CX2" ||
                              typeUpper.startsWith("COLORLESS")
                            )
                              weaknessType = "Colorless";
                          } else {
                            weaknessType = rawType;
                          }
                        } else if (typeof weakness === "string") {
                          // String format - try to parse it
                          const weaknessStr = weakness.trim();

                          // Handle formats like "Wx2", "Water×2", "Water x2", etc.
                          // First, try to extract a value if present
                          const valueMatch = weaknessStr.match(/[\s×xX]+(\d+)/);
                          if (valueMatch) {
                            weaknessValue = `×${valueMatch[1]}`;
                            // Extract the type part (everything before the value)
                            const typePart = weaknessStr
                              .substring(0, weaknessStr.indexOf(valueMatch[0]))
                              .trim();
                            weaknessType =
                              typePart ||
                              weaknessStr.replace(/[\s×xX\d]+/g, "").trim();
                          } else {
                            // No value found, entire string is the type
                            weaknessType = weaknessStr;
                          }

                          // Normalize common type names (check longer names first to avoid conflicts)
                          if (weaknessType) {
                            const typeUpper = weaknessType.toUpperCase().trim();
                            // Handle single letters first
                            if (
                              typeUpper === "W" ||
                              typeUpper === "WX2" ||
                              typeUpper.startsWith("WATER")
                            )
                              weaknessType = "Water";
                            else if (
                              typeUpper === "F" ||
                              typeUpper === "FX2" ||
                              typeUpper.startsWith("FIRE")
                            )
                              weaknessType = "Fire";
                            else if (typeUpper.startsWith("FIGHTING"))
                              weaknessType = "Fighting";
                            else if (
                              typeUpper === "G" ||
                              typeUpper === "GX2" ||
                              typeUpper.startsWith("GRASS")
                            )
                              weaknessType = "Grass";
                            else if (
                              typeUpper === "P" ||
                              typeUpper === "PX2" ||
                              typeUpper.startsWith("PSYCHIC")
                            )
                              weaknessType = "Psychic";
                            else if (
                              typeUpper === "L" ||
                              typeUpper === "LX2" ||
                              typeUpper.startsWith("LIGHTNING") ||
                              typeUpper.startsWith("ELECTRIC")
                            )
                              weaknessType = "Electric";
                            else if (
                              typeUpper === "D" ||
                              typeUpper === "DX2" ||
                              typeUpper.startsWith("DARKNESS")
                            )
                              weaknessType = "Darkness";
                            else if (
                              typeUpper === "M" ||
                              typeUpper === "MX2" ||
                              typeUpper.startsWith("METAL")
                            )
                              weaknessType = "Metal";
                            else if (
                              typeUpper === "C" ||
                              typeUpper === "CX2" ||
                              typeUpper.startsWith("COLORLESS")
                            )
                              weaknessType = "Colorless";
                          }
                        }

                        console.log(
                          "🎯 Weakness Debug - extracted type:",
                          weaknessType,
                          "value:",
                          weaknessValue
                        );

                        if (weaknessType) {
                          return (
                            <>
                              {renderEnergyCost([weaknessType])}
                              <span className="dark:text-white text-theme-primary text-sm">
                                {weaknessValue}
                              </span>
                            </>
                          );
                        }
                      }
                      return (
                        <span className="dark:text-white text-theme-primary text-sm">
                          —
                        </span>
                      );
                    })()}
                  </div>
                </div>
                <div className="dark:bg-gray-700 bg-gray-200 rounded p-3 text-center">
                  <div className="dark:text-white text-theme-primary text-xs mb-2">
                    Resistance
                  </div>
                  <div className="flex items-center justify-center gap-1">
                    {(() => {
                      console.log(
                        "🎯 Resistance Debug - selectedCard.resistances:",
                        selectedCard?.resistances
                      );
                      if (
                        selectedCard?.resistances &&
                        Array.isArray(selectedCard.resistances) &&
                        selectedCard.resistances.length > 0
                      ) {
                        const resistance = selectedCard.resistances[0];
                        console.log(
                          "🎯 Resistance Debug - first resistance object:",
                          resistance
                        );

                        // Handle different resistance data formats (same as weaknesses)
                        let resistanceType = null;
                        let resistanceValue = "-20";

                        if (
                          typeof resistance === "object" &&
                          resistance !== null
                        ) {
                          // Proper format: {type: "Water", value: "-20"}
                          let rawType =
                            resistance.type ||
                            resistance.resistanceType ||
                            null;
                          resistanceValue =
                            resistance.value ||
                            resistance.resistanceValue ||
                            "-20";

                          // If type is in format like "Wx2" or "Fx2", extract just the letter
                          if (rawType && typeof rawType === "string") {
                            // Check if it matches patterns like "Wx2", "Fx2", etc.
                            const singleLetterMatch =
                              rawType.match(/^([A-Z])x\d+$/i);
                            if (singleLetterMatch) {
                              resistanceType =
                                singleLetterMatch[1].toUpperCase();
                            } else {
                              // Check if it contains x2 or ×2 - extract the part before it
                              const combinedMatch =
                                rawType.match(/^(.+?)[\s×xX]\d+/);
                              if (combinedMatch) {
                                resistanceType = combinedMatch[1].trim();
                              } else {
                                resistanceType = rawType;
                              }
                            }

                            // Normalize the extracted type
                            const typeUpper = resistanceType
                              .toUpperCase()
                              .trim();
                            if (
                              typeUpper === "W" ||
                              typeUpper === "WX2" ||
                              typeUpper.startsWith("WATER")
                            )
                              resistanceType = "Water";
                            else if (
                              typeUpper === "F" ||
                              typeUpper === "FX2" ||
                              typeUpper.startsWith("FIRE")
                            )
                              resistanceType = "Fire";
                            else if (typeUpper.startsWith("FIGHTING"))
                              resistanceType = "Fighting";
                            else if (
                              typeUpper === "G" ||
                              typeUpper === "GX2" ||
                              typeUpper.startsWith("GRASS")
                            )
                              resistanceType = "Grass";
                            else if (
                              typeUpper === "P" ||
                              typeUpper === "PX2" ||
                              typeUpper.startsWith("PSYCHIC")
                            )
                              resistanceType = "Psychic";
                            else if (
                              typeUpper === "L" ||
                              typeUpper === "LX2" ||
                              typeUpper.startsWith("LIGHTNING") ||
                              typeUpper.startsWith("ELECTRIC")
                            )
                              resistanceType = "Electric";
                            else if (
                              typeUpper === "D" ||
                              typeUpper === "DX2" ||
                              typeUpper.startsWith("DARKNESS")
                            )
                              resistanceType = "Darkness";
                            else if (
                              typeUpper === "M" ||
                              typeUpper === "MX2" ||
                              typeUpper.startsWith("METAL")
                            )
                              resistanceType = "Metal";
                            else if (
                              typeUpper === "C" ||
                              typeUpper === "CX2" ||
                              typeUpper.startsWith("COLORLESS")
                            )
                              resistanceType = "Colorless";
                          } else {
                            resistanceType = rawType;
                          }
                        } else if (typeof resistance === "string") {
                          // String format - try to parse it
                          const resistanceStr = resistance.trim();

                          // Handle formats like "Wx2", "Water×2", "Water x2", etc.
                          // First, try to extract a value if present
                          const valueMatch =
                            resistanceStr.match(/[\s×xX]+(\d+)/);
                          if (valueMatch) {
                            resistanceValue = `-${valueMatch[1]}`;
                            // Extract the type part (everything before the value)
                            const typePart = resistanceStr
                              .substring(
                                0,
                                resistanceStr.indexOf(valueMatch[0])
                              )
                              .trim();
                            resistanceType =
                              typePart ||
                              resistanceStr.replace(/[\s×xX\d]+/g, "").trim();
                          } else {
                            // No value found, entire string is the type
                            resistanceType = resistanceStr;
                          }

                          // Normalize common type names (check longer names first to avoid conflicts)
                          if (resistanceType) {
                            const typeUpper = resistanceType
                              .toUpperCase()
                              .trim();
                            // Handle single letters first
                            if (
                              typeUpper === "W" ||
                              typeUpper === "WX2" ||
                              typeUpper.startsWith("WATER")
                            )
                              resistanceType = "Water";
                            else if (
                              typeUpper === "F" ||
                              typeUpper === "FX2" ||
                              typeUpper.startsWith("FIRE")
                            )
                              resistanceType = "Fire";
                            else if (typeUpper.startsWith("FIGHTING"))
                              resistanceType = "Fighting";
                            else if (
                              typeUpper === "G" ||
                              typeUpper === "GX2" ||
                              typeUpper.startsWith("GRASS")
                            )
                              resistanceType = "Grass";
                            else if (
                              typeUpper === "P" ||
                              typeUpper === "PX2" ||
                              typeUpper.startsWith("PSYCHIC")
                            )
                              resistanceType = "Psychic";
                            else if (
                              typeUpper === "L" ||
                              typeUpper === "LX2" ||
                              typeUpper.startsWith("LIGHTNING") ||
                              typeUpper.startsWith("ELECTRIC")
                            )
                              resistanceType = "Electric";
                            else if (
                              typeUpper === "D" ||
                              typeUpper === "DX2" ||
                              typeUpper.startsWith("DARKNESS")
                            )
                              resistanceType = "Darkness";
                            else if (
                              typeUpper === "M" ||
                              typeUpper === "MX2" ||
                              typeUpper.startsWith("METAL")
                            )
                              resistanceType = "Metal";
                            else if (
                              typeUpper === "C" ||
                              typeUpper === "CX2" ||
                              typeUpper.startsWith("COLORLESS")
                            )
                              resistanceType = "Colorless";
                          }
                        }

                        console.log(
                          "🎯 Resistance Debug - extracted type:",
                          resistanceType,
                          "value:",
                          resistanceValue
                        );

                        // Check if resistance is "None" or empty - don't show anything
                        if (
                          resistanceType &&
                          resistanceType.toLowerCase() !== "none" &&
                          resistanceType.trim() !== ""
                        ) {
                          return (
                            <>
                              {renderEnergyCost([resistanceType])}
                              <span className="dark:text-white text-theme-primary text-sm">
                                {resistanceValue}
                              </span>
                            </>
                          );
                        }
                      }
                      return (
                        <span className="dark:text-white text-theme-primary text-sm">
                          —
                        </span>
                      );
                    })()}
                  </div>
                </div>
                <div className="dark:bg-gray-700 bg-gray-200 rounded p-3 text-center">
                  <div className="dark:text-white text-theme-primary text-xs mb-2">
                    Retreat
                  </div>
                  <div className="flex items-center justify-center gap-1">
                    {(() => {
                      console.log(
                        "🎯 Retreat Debug - selectedCard.retreat_cost:",
                        selectedCard?.retreat_cost
                      );
                      let retreatCost = selectedCard?.retreat_cost;

                      // Parse retreat_cost if it's a string
                      if (retreatCost && typeof retreatCost === "string") {
                        try {
                          const parsed = JSON.parse(retreatCost);
                          if (Array.isArray(parsed)) {
                            retreatCost = parsed;
                          } else if (typeof parsed === "number") {
                            retreatCost = Array(parsed).fill("Colorless");
                          }
                        } catch (e) {
                          // If not JSON, try to parse as a number
                          const num = parseInt(retreatCost);
                          if (!isNaN(num) && num > 0) {
                            // If it's a number, convert to array of Colorless
                            retreatCost = Array(num).fill("Colorless");
                          } else {
                            // If it's a single energy type string, make it an array
                            retreatCost = [retreatCost.trim()];
                          }
                        }
                      }

                      // Handle case where retreat_cost is a single number
                      if (typeof retreatCost === "number" && retreatCost > 0) {
                        retreatCost = Array(retreatCost).fill("Colorless");
                      }

                      // Ensure it's an array
                      if (!Array.isArray(retreatCost)) {
                        retreatCost = null;
                      }

                      console.log(
                        "🎯 Retreat Debug - parsed retreat_cost:",
                        retreatCost
                      );

                      if (
                        retreatCost &&
                        Array.isArray(retreatCost) &&
                        retreatCost.length > 0
                      ) {
                        // Filter out any null, undefined, or empty values and normalize energy type names
                        const validCosts = retreatCost
                          .filter((cost) => cost != null && cost !== "")
                          .map((cost) => {
                            const costStr = String(cost).trim();
                            // Normalize energy type names
                            if (
                              costStr === "W" ||
                              costStr.toUpperCase() === "WATER"
                            )
                              return "Water";
                            if (
                              costStr === "F" ||
                              costStr.toUpperCase() === "FIRE"
                            )
                              return "Fire";
                            if (
                              costStr === "G" ||
                              costStr.toUpperCase() === "GRASS"
                            )
                              return "Grass";
                            if (
                              costStr === "P" ||
                              costStr.toUpperCase() === "PSYCHIC"
                            )
                              return "Psychic";
                            if (
                              costStr === "L" ||
                              costStr.toUpperCase() === "LIGHTNING" ||
                              costStr.toUpperCase() === "ELECTRIC"
                            )
                              return "Electric";
                            if (
                              costStr === "D" ||
                              costStr.toUpperCase() === "DARKNESS"
                            )
                              return "Darkness";
                            if (
                              costStr === "M" ||
                              costStr.toUpperCase() === "METAL"
                            )
                              return "Metal";
                            if (
                              costStr === "C" ||
                              costStr.toUpperCase() === "COLORLESS"
                            )
                              return "Colorless";
                            return costStr;
                          })
                          .filter((cost) => cost && cost !== "");

                        if (validCosts.length > 0) {
                          return renderEnergyCost(validCosts);
                        }
                      }
                      return (
                        <span className="dark:text-white text-theme-primary text-sm">
                          —
                        </span>
                      );
                    })()}
                  </div>
                </div>
                <div
                  className="dark:bg-gray-700 bg-gray-200 rounded p-3 text-center cursor-pointer dark:hover:bg-gray-600 hover:bg-gray-300 transition-colors"
                  onClick={async () => {
                    if (selectedCard?.rarity) {
                      setShowCardProfile(false);
                      setSearchQuery(selectedCard.rarity);
                      setShowSearchResults(true);
                      setActiveTab("search");
                      setNavigationMode("search");
                      setTimeout(async () => {
                        await handleSearch();
                      }, 200);
                    }
                  }}
                >
                  <div className="dark:text-white text-theme-primary text-xs mb-2">
                    Rarity
                  </div>
                  <div className="flex items-center justify-center gap-1">
                    {(() => {
                      const rarity =
                        selectedCard?.rarity || selectedCard?.ext_rarity;
                      const language = selectedCard?.language || "en";
                      const rarityPath = rarity
                        ? getRarityIconPath(rarity, language)
                        : null;
                      console.log("Rarity debug:", {
                        rarity: rarity,
                        rarityPath: rarityPath,
                        mappedRarity: rarity ? rarityMap[rarity] : null,
                      });

                      return rarity ? (
                        <img
                          src={rarityPath}
                          alt={`${rarity} Rarity`}
                          className="w-4 h-4"
                          onError={(e) => {
                            console.log(
                              "Rarity SVG failed to load:",
                              rarityPath
                            );
                            // Fallback to white circle if SVG fails to load
                            e.target.style.display = "none";
                            e.target.nextSibling.style.display = "block";
                          }}
                        />
                      ) : null;
                    })()}
                    <div
                      className="w-3 h-3 dark:bg-white bg-gray-400 rounded-full"
                      style={{
                        display: selectedCard?.rarity ? "none" : "block",
                      }}
                    ></div>
                    <span className="text-blue-400 text-sm hover:text-blue-300">
                      {selectedCard.rarity}
                    </span>
                  </div>
                </div>
                <div
                  className="dark:bg-gray-700 bg-gray-200 rounded p-3 text-center cursor-pointer dark:hover:bg-gray-600 hover:bg-gray-300 transition-colors"
                  onClick={async () => {
                    let regulation =
                      selectedCard?.regulation_mark || selectedCard?.regulation;
                    if (!regulation || regulation === "A") {
                      regulation = getRegulationFromDate(
                        selectedCard?.release_date
                      );
                    }
                    if (regulation) {
                      setShowCardProfile(false);
                      setSearchQuery(regulation);
                      setShowSearchResults(true);
                      setActiveTab("search");
                      setNavigationMode("search");
                      setTimeout(async () => {
                        await handleSearch();
                      }, 200);
                    }
                  }}
                >
                  <div className="dark:text-white text-theme-primary text-xs mb-2">
                    Regulation
                  </div>
                  <div className="flex items-center justify-center gap-1">
                    {(() => {
                      // Get regulation from API (should already be derived from TCGCSV or release_date)
                      let regulation =
                        selectedCard?.regulation_mark ||
                        selectedCard?.regulation;

                      // If still missing, try to derive from release date
                      if (!regulation || regulation === "A") {
                        const derivedRegulation = getRegulationFromDate(
                          selectedCard?.release_date
                        );
                        if (derivedRegulation && derivedRegulation !== "A") {
                          regulation = derivedRegulation;
                        }
                      }

                      // Ensure we have a regulation value
                      if (!regulation) {
                        regulation =
                          getRegulationFromDate(selectedCard?.release_date) ||
                          "A";
                      }

                      const regulationPath = regulation
                        ? getRegulationIconPath(regulation)
                        : null;
                      console.log("Regulation debug:", {
                        selectedCard: selectedCard,
                        original_regulation:
                          selectedCard?.regulation_mark ||
                          selectedCard?.regulation,
                        final_regulation: regulation,
                        release_date: selectedCard?.release_date,
                        regulationPath: regulationPath,
                      });

                      return (
                        <>
                          {regulationPath ? (
                            <img
                              src={regulationPath}
                              alt={`Regulation ${regulation}`}
                              className="w-4 h-4"
                              onError={(e) => {
                                console.log(
                                  "Regulation SVG failed to load:",
                                  regulationPath
                                );
                                // Fallback to text if SVG fails to load
                                e.target.style.display = "none";
                              }}
                            />
                          ) : null}
                          <span className="text-blue-400 text-sm hover:text-blue-300">
                            {regulation || "—"}
                          </span>
                        </>
                      );
                    })()}
                  </div>
                </div>
                <div
                  className="dark:bg-gray-700 bg-gray-200 rounded p-3 text-center cursor-pointer dark:hover:bg-gray-600 hover:bg-gray-300 transition-colors"
                  onClick={async () => {
                    // Determine format based on legalities
                    let format = "Unlimited";
                    if (selectedCard?.legalities) {
                      const legalities =
                        typeof selectedCard.legalities === "string"
                          ? JSON.parse(selectedCard.legalities)
                          : selectedCard.legalities;

                      if (
                        legalities?.standard === "Legal" ||
                        legalities?.find?.(
                          (l) =>
                            l.format === "Standard" && l.legality === "Legal"
                        )
                      ) {
                        format = "Standard";
                      } else if (
                        legalities?.expanded === "Legal" ||
                        legalities?.find?.(
                          (l) =>
                            l.format === "Expanded" && l.legality === "Legal"
                        )
                      ) {
                        format = "Expanded";
                      }
                    }

                    setShowCardProfile(false);
                    setSearchQuery(format);
                    setShowSearchResults(true);
                    setActiveTab("search");
                    setNavigationMode("search");
                    setTimeout(async () => {
                      await handleSearch();
                    }, 200);
                  }}
                >
                  <div className="dark:text-white text-theme-primary text-xs mb-2">
                    Card Format
                  </div>
                  <div className="text-blue-400 text-sm hover:text-blue-300">
                    {(() => {
                      // Determine format based on legalities
                      if (selectedCard?.legalities) {
                        try {
                          const legalities =
                            typeof selectedCard.legalities === "string"
                              ? JSON.parse(selectedCard.legalities)
                              : selectedCard.legalities;

                          if (
                            legalities?.standard === "Legal" ||
                            legalities?.find?.(
                              (l) =>
                                l.format === "Standard" &&
                                l.legality === "Legal"
                            )
                          ) {
                            return "Standard";
                          } else if (
                            legalities?.expanded === "Legal" ||
                            legalities?.find?.(
                              (l) =>
                                l.format === "Expanded" &&
                                l.legality === "Legal"
                            )
                          ) {
                            return "Expanded";
                          }
                        } catch (e) {
                          console.warn("Error parsing legalities:", e);
                        }
                      }
                      return "Unlimited";
                    })()}
                  </div>
                </div>
              </div>
            </div>

            {/* Browse Listings Section */}
            <div className="dark:bg-gray-800 bg-gray-100 rounded-2xl p-6">
              <div className="flex items-center gap-2 mb-4">
                <svg
                  className="w-4 h-4 dark:text-white text-theme-primary"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    strokeLinecap="round"
                    strokeLinejoin="round"
                    strokeWidth={2}
                    d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z"
                  />
                </svg>
                <h3 className="dark:text-white text-theme-primary font-medium">
                  Browse Listings
                </h3>
              </div>

              <div className="space-y-3">
                {/* TCGplayer */}
                <button
                  onClick={async (e) => {
                    e.preventDefault();
                    try {
                      const link = await marketplaceService.getAffiliateLink(
                        "TCGPlayer",
                        {
                          cardName: selectedCard?.name || "",
                          setName: selectedCard?.set_name,
                          productId:
                            selectedCard?.product_id ||
                            selectedCard?.tcgplayer?.url?.match(/\/(\d+)/)?.[1],
                        }
                      );
                      window.open(
                        link ||
                          `https://www.tcgplayer.com/search/pokemon/product?q=${encodeURIComponent(
                            selectedCard?.name || ""
                          )}`,
                        "_blank"
                      );
                    } catch {
                      window.open(
                        `https://www.tcgplayer.com/search/pokemon/product?q=${encodeURIComponent(
                          selectedCard?.name || ""
                        )}`,
                        "_blank"
                      );
                    }
                  }}
                  className="w-full flex items-center justify-between p-3 dark:bg-gray-700 bg-gray-200 rounded-lg dark:hover:bg-gray-600 hover:bg-gray-300 transition-colors cursor-pointer text-left"
                >
                  <div className="flex items-center gap-3">
                    <img
                      src="/Assets/TCGplayer_Logo 1.svg"
                      alt="TCGplayer Logo"
                      className="h-6 w-auto"
                    />
                    <div>
                      <div className="dark:text-white text-theme-primary text-sm">
                        Recent Listings
                      </div>
                      <div className="dark:text-gray-400 text-theme-secondary text-xs">
                        View recent listings on TCGplayer.com
                      </div>
                    </div>
                  </div>
                  <svg
                    className="w-4 h-4 dark:text-white text-theme-primary"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      strokeLinecap="round"
                      strokeLinejoin="round"
                      strokeWidth={2}
                      d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"
                    />
                  </svg>
                </button>

                {/* eBay */}
                <button
                  onClick={async (e) => {
                    e.preventDefault();
                    try {
                      const link = await marketplaceService.getAffiliateLink(
                        "eBay",
                        {
                          cardName: selectedCard?.name || "",
                          setName: selectedCard?.set_name,
                        }
                      );
                      window.open(
                        link ||
                          `https://www.ebay.com/sch/i.html?_nkw=${encodeURIComponent(
                            selectedCard?.name || ""
                          )}`,
                        "_blank"
                      );
                    } catch {
                      window.open(
                        `https://www.ebay.com/sch/i.html?_nkw=${encodeURIComponent(
                          selectedCard?.name || ""
                        )}`,
                        "_blank"
                      );
                    }
                  }}
                  className="w-full flex items-center justify-between p-3 dark:bg-gray-700 bg-gray-200 rounded-lg dark:hover:bg-gray-600 hover:bg-gray-300 transition-colors cursor-pointer text-left"
                >
                  <div className="flex items-center gap-3">
                    <img
                      src="/Assets/EBay_logo 1.svg"
                      alt="eBay Logo"
                      className="h-6 w-auto"
                    />
                    <div>
                      <div className="dark:text-white text-theme-primary text-sm">
                        Recent Listings
                      </div>
                      <div className="dark:text-gray-400 text-theme-secondary text-xs">
                        View recent listings on ebay.com
                      </div>
                    </div>
                  </div>
                  <svg
                    className="w-4 h-4 dark:text-white text-theme-primary"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      strokeLinecap="round"
                      strokeLinejoin="round"
                      strokeWidth={2}
                      d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"
                    />
                  </svg>
                </button>
              </div>
            </div>
          </div>

          {/* View My Cards Modal */}
          {showViewMyCardsModal && (
            <div className="fixed inset-0 z-[10000] bg-black/50 backdrop-blur-sm flex items-center justify-center p-4">
              <div
                className={`bg-gray-800 rounded-2xl p-6 w-full max-w-2xl mx-auto relative max-h-[90vh] overflow-y-auto ${
                  isMultiSelectMode ? "pb-24" : ""
                }`}
              >
                <div className="flex items-center justify-between mb-6">
                  <div className="flex items-center gap-3">
                    <svg className="w-6 h-6" fill="none" viewBox="0 0 20 20">
                      <g clipPath="url(#clip0_363_5703_modal)">
                        <path
                          d="M15.105 19.0527L10.4474 16.8878C10.1388 16.7443 10.0046 16.3774 10.1481 16.0684L13.444 8.97766C13.5872 8.66891 13.9545 8.53493 14.2629 8.67817L18.9207 10.8436C19.2293 10.987 19.3632 11.3539 19.2197 11.6625L15.924 18.7532C15.7804 19.062 15.4133 19.196 15.105 19.0527ZM3.86524 18.2791L0.773053 11.0973C0.638366 10.7845 0.783014 10.4214 1.09532 10.287L2.62641 9.6279L4.5395 16.8171C4.72286 17.5041 5.42837 17.9139 6.11606 17.7308L7.64075 17.3251L4.67563 18.6019C4.36286 18.7364 3.99993 18.5919 3.86524 18.2791ZM5.18907 16.644L3.17821 9.08743C3.09071 8.75852 3.2868 8.42032 3.61532 8.33305L4.94473 7.97946L4.78465 9.1695C4.69005 9.87403 5.18403 10.5231 5.88954 10.6182L9.00782 11.0384L7.73841 15.3145C7.60774 15.7551 7.72395 16.2109 8.00661 16.5325L5.94333 17.0813C5.61442 17.1688 5.27657 16.9731 5.18907 16.644ZM9.42454 16.458L8.79876 16.2721C8.47219 16.1748 8.28626 15.832 8.38298 15.5054L10.6084 8.0093C10.7054 7.68274 11.049 7.4968 11.3749 7.59329L13.2918 8.16294C13.0929 8.29413 12.9344 8.47837 12.8343 8.69458L9.53825 15.7856C9.44059 15.9955 9.40141 16.2277 9.42454 16.458ZM9.20161 10.3865L5.9795 9.95227C5.64227 9.90673 5.40512 9.59602 5.45067 9.2586L6.49481 1.50899C6.54012 1.17177 6.85126 0.934851 7.18778 0.980164L12.2787 1.66622C12.6157 1.71177 12.8526 2.02266 12.8073 2.35966L12.1649 7.12735L11.566 6.94954C10.8837 6.74653 10.1666 7.13641 9.9643 7.81798L9.20161 10.3865Z"
                          fill="#8F8F94"
                        />
                      </g>
                      <defs>
                        <clipPath id="clip0_363_5703_modal">
                          <rect width="20" height="20" fill="white" />
                        </clipPath>
                      </defs>
                    </svg>
                    <h2 className="dark:text-white text-theme-primary text-xl font-semibold">
                      My Cards: {selectedCard?.name}
                    </h2>
                  </div>
                  <button
                    onClick={() => setShowViewMyCardsModal(false)}
                    className="w-8 h-8 bg-gray-600 rounded-full flex items-center justify-center text-white hover:bg-gray-500 transition-colors"
                  >
                    <svg
                      className="w-5 h-5"
                      fill="none"
                      stroke="currentColor"
                      viewBox="0 0 24 24"
                    >
                      <path
                        strokeLinecap="round"
                        strokeLinejoin="round"
                        strokeWidth="2"
                        d="M6 18L18 6M6 6l12 12"
                      />
                    </svg>
                  </button>
                </div>

                <div className="space-y-3">
                  {myCardEntries.length > 0 && !isMultiSelectMode && (
                    <div className="text-center text-gray-400 text-xs mb-2">
                      💡 Swipe right to reveal actions • Press and hold to
                      multi-select
                    </div>
                  )}
                  {myCardEntries.length > 0 && isMultiSelectMode && (
                    <div className="text-center text-blue-400 text-xs mb-2">
                      ✨ Multi-select mode: Tap entries to select them
                    </div>
                  )}
                  {myCardEntries.length === 0 ? (
                    <div className="text-center py-12">
                      <div className="w-20 h-20 bg-gray-700 rounded-full flex items-center justify-center mx-auto mb-4">
                        <svg
                          className="w-10 h-10 text-gray-500"
                          fill="none"
                          stroke="currentColor"
                          viewBox="0 0 24 24"
                        >
                          <path
                            strokeLinecap="round"
                            strokeLinejoin="round"
                            strokeWidth="2"
                            d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4"
                          />
                        </svg>
                      </div>
                      <h3 className="dark:text-white text-theme-primary font-semibold text-lg mb-2">
                        No Cards Found
                      </h3>
                      <p className="text-gray-400 text-sm">
                        You don't have this card in your collection yet.
                      </p>
                    </div>
                  ) : (
                    <>
                      <div className="text-gray-400 text-sm mb-4">
                        Found {myCardEntries.length}{" "}
                        {myCardEntries.length === 1 ? "entry" : "entries"} •
                        Total Quantity:{" "}
                        {myCardEntries.reduce(
                          (sum, entry) => sum + (entry.quantity || 0),
                          0
                        )}
                      </div>
                      {myCardEntries.map((entry, index) => (
                        <div
                          key={entry.id || index}
                          className={`relative bg-gray-700/50 rounded-xl border transition-all duration-300 cursor-pointer overflow-hidden ${
                            isMultiSelectMode && selectedEntries.has(entry.id)
                              ? "border-[#8871FF] shadow-lg shadow-[#8871FF]/20 bg-[#8871FF]/10"
                              : pressedEntryId === entry.id
                              ? "border-[#8871FF] shadow-lg shadow-[#8871FF]/20"
                              : swipedEntryId === entry.id
                              ? "border-[#8871FF] shadow-lg shadow-[#8871FF]/20"
                              : "border-gray-600/50 hover:border-gray-500/50"
                          }`}
                          onClick={() => {
                            if (isMultiSelectMode) {
                              toggleEntrySelection(entry.id);
                            } else if (swipedEntryId === entry.id) {
                              // Close swipe actions when clicking on the card
                              setSwipedEntryId(null);
                            }
                          }}
                          onMouseDown={(e) => handleEntryMouseDown(e, entry.id)}
                          onMouseUp={(e) => handleEntryMouseUp(e, entry.id)}
                          onMouseLeave={handleEntryPressEnd}
                          onTouchStart={(e) =>
                            handleEntryTouchStart(e, entry.id)
                          }
                          onTouchEnd={(e) => handleEntryTouchEnd(e, entry.id)}
                          style={{
                            transform:
                              swipedEntryId === entry.id
                                ? "translateX(60px)"
                                : "translateX(0)",
                            transition: "transform 0.3s ease-in-out",
                          }}
                        >
                          <div className="p-4">
                            <div className="flex items-center justify-between mb-2">
                              <div className="flex items-center gap-3">
                                {isMultiSelectMode && (
                                  <div
                                    className={`w-5 h-5 rounded border-2 flex items-center justify-center ${
                                      selectedEntries.has(entry.id)
                                        ? "bg-[#8871FF] border-[#8871FF]"
                                        : "border-gray-400"
                                    }`}
                                  >
                                    {selectedEntries.has(entry.id) && (
                                      <svg
                                        className="w-3 h-3 text-white"
                                        fill="currentColor"
                                        viewBox="0 0 20 20"
                                      >
                                        <path
                                          fillRule="evenodd"
                                          d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z"
                                          clipRule="evenodd"
                                        />
                                      </svg>
                                    )}
                                  </div>
                                )}
                                <h4 className="dark:text-white text-theme-primary font-semibold">
                                  {entry.collectionName}
                                </h4>
                              </div>
                              <div className="flex items-center gap-2">
                                <span className="text-primary font-bold">
                                  Qty: {entry.quantity || 1}
                                </span>
                              </div>
                            </div>
                            <div className="grid grid-cols-2 gap-x-4 gap-y-2 text-sm">
                              <div>
                                <span className="text-gray-400">Variant:</span>
                                <span className="text-white ml-2 capitalize">
                                  {entry.variant || "Normal"}
                                </span>
                              </div>
                              {entry.gradingService &&
                              entry.gradingService !== "raw" ? (
                                <>
                                  <div>
                                    <span className="text-gray-400">
                                      Grade:
                                    </span>
                                    <span className="text-white ml-2">
                                      {entry.gradingService} {entry.grade}
                                    </span>
                                  </div>
                                </>
                              ) : (
                                <div>
                                  <span className="text-gray-400">
                                    Condition:
                                  </span>
                                  <span className="text-white ml-2">
                                    {entry.condition || "Near Mint"}
                                  </span>
                                </div>
                              )}
                              <div>
                                <span className="text-gray-400">Value:</span>
                                <span className="text-white ml-2">
                                  ${(entry.currentValue || 0).toFixed(2)}
                                </span>
                              </div>
                              <div>
                                <span className="text-gray-400">Total:</span>
                                <span className="text-white ml-2">
                                  $
                                  {(
                                    (entry.currentValue || 0) *
                                    (entry.quantity || 1)
                                  ).toFixed(2)}
                                </span>
                              </div>
                            </div>
                            {entry.notes && (
                              <div className="mt-2 pt-2 border-t border-gray-600/50">
                                <span className="text-gray-400 text-xs">
                                  Notes:
                                </span>
                                <p className="text-white text-xs mt-1">
                                  {entry.notes}
                                </p>
                              </div>
                            )}
                            <div className="text-gray-500 text-xs mt-2">
                              Added{" "}
                              {new Date(entry.dateAdded).toLocaleDateString()}
                            </div>
                          </div>

                          {/* Swipe-to-reveal action buttons */}
                          {swipedEntryId === entry.id && !isMultiSelectMode && (
                            <div className="swipe-actions absolute left-0 right-0 bottom-0 bg-gray-600/90 backdrop-blur-sm flex items-center justify-start gap-4 py-3 px-4 rounded-b-xl">
                              <button
                                onClick={(e) => {
                                  e.stopPropagation();
                                  handleRemoveEntry(entry);
                                }}
                                className="px-4 py-2 bg-red-600 hover:bg-red-500 text-white rounded-lg flex items-center gap-2 transition-colors"
                                title="Remove"
                              >
                                <svg
                                  className="w-4 h-4"
                                  fill="none"
                                  stroke="currentColor"
                                  viewBox="0 0 24 24"
                                >
                                  <path
                                    strokeLinecap="round"
                                    strokeLinejoin="round"
                                    strokeWidth="2"
                                    d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"
                                  />
                                </svg>
                                <span className="text-sm font-medium">
                                  Remove
                                </span>
                              </button>
                            </div>
                          )}

                          {/* Press and hold indicator */}
                          {pressedEntryId === entry.id && (
                            <div className="absolute inset-0 bg-[#8871FF]/10 rounded-xl pointer-events-none animate-pulse"></div>
                          )}
                        </div>
                      ))}
                    </>
                  )}
                </div>

                {/* Multi-select floating action bar */}
                {isMultiSelectMode && (
                  <div
                    className={`fixed bottom-0 left-0 right-0 bg-gray-800/95 backdrop-blur-sm border-t border-gray-600/50 p-4 z-[10003] ${
                      showAddToCollectionModal ? "pointer-events-none" : ""
                    }`}
                  >
                    <div className="max-w-2xl mx-auto flex items-center justify-between">
                      <div className="flex items-center gap-3">
                        <span className="dark:text-white text-theme-primary font-medium">
                          {selectedEntries.size} selected
                        </span>
                        <div className="flex gap-2">
                          <button
                            onClick={selectAllEntries}
                            className="px-3 py-1.5 bg-gray-600 hover:bg-gray-500 text-white text-sm rounded-lg transition-colors"
                          >
                            All
                          </button>
                          <button
                            onClick={deselectAllEntries}
                            className="px-3 py-1.5 bg-gray-600 hover:bg-gray-500 text-white text-sm rounded-lg transition-colors"
                          >
                            None
                          </button>
                        </div>
                      </div>
                      <div className="flex gap-2">
                        {selectedEntries.size > 0 && (
                          <button
                            onClick={handleBulkRemove}
                            className="px-3 py-1.5 bg-red-600 hover:bg-red-500 text-white text-sm rounded-lg transition-colors"
                          >
                            Remove
                          </button>
                        )}
                        <button
                          onClick={toggleMultiSelect}
                          className="px-3 py-1.5 bg-gray-600 hover:bg-gray-500 text-white text-sm rounded-lg transition-colors"
                        >
                          Cancel
                        </button>
                      </div>
                    </div>
                  </div>
                )}

                <div className="mt-6 flex justify-end">
                  <button
                    onClick={() => setShowViewMyCardsModal(false)}
                    className="bg-gray-600 hover:bg-gray-500 text-white py-3 px-6 rounded-lg font-medium transition-colors"
                  >
                    Close
                  </button>
                </div>
              </div>
            </div>
          )}

          {/* Add to Deck Modal */}
          {showAddToDeckModal && (
            <div className="fixed inset-0 z-[10000] bg-black/50 backdrop-blur-sm flex items-center justify-center p-4">
              <div className="bg-gray-800 rounded-2xl p-6 w-full max-w-md mx-auto relative modal-container add-to-deck-modal">
                <div className="flex items-center gap-3 mb-6">
                  <img
                    src="/Assets/Addtodeck.svg"
                    alt="Add to Deck"
                    className="w-6 h-6"
                  />
                  <h2 className="dark:text-white text-theme-primary text-xl font-semibold">
                    Add to Deck
                  </h2>
                </div>
                <div className="space-y-4">
                  <div>
                    <label className="block text-gray-300 text-sm font-medium mb-2">
                      Select Deck
                    </label>
                    <div className="relative dropdown-container">
                      <button
                        type="button"
                        onClick={() => setShowDeckDropdown(!showDeckDropdown)}
                        className="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-3 text-white text-left flex items-center justify-between focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent"
                      >
                        <span>{selectedDeck}</span>
                        <svg
                          className={`w-4 h-4 transition-transform ${
                            showDeckDropdown ? "rotate-180" : ""
                          }`}
                          fill="none"
                          stroke="currentColor"
                          viewBox="0 0 24 24"
                        >
                          <path
                            strokeLinecap="round"
                            strokeLinejoin="round"
                            strokeWidth={2}
                            d="M19 9l-7 7-7-7"
                          />
                        </svg>
                      </button>
                      {showDeckDropdown && (
                        <div className="absolute z-50 w-full mt-1 bg-gray-700 border border-gray-600 rounded-lg shadow-lg max-h-60 overflow-y-auto">
                          <div className="py-1">
                            {availableDecks.length > 0 ? (
                              availableDecks.map((deck) => (
                                <button
                                  key={deck.id}
                                  type="button"
                                  onClick={() => {
                                    setSelectedDeck(deck.name);
                                    setShowDeckDropdown(false);
                                  }}
                                  className="w-full px-4 py-2 text-left text-white hover:bg-gray-600 transition-colors"
                                >
                                  <div className="flex items-center justify-between">
                                    <span>{deck.name}</span>
                                    <span className="text-gray-400 text-xs">
                                      {deck.cardCount} cards
                                    </span>
                                  </div>
                                </button>
                              ))
                            ) : (
                              <div className="px-4 py-2 text-gray-400 text-sm">
                                No decks available
                              </div>
                            )}
                          </div>
                        </div>
                      )}
                    </div>
                  </div>
                  <div>
                    <label className="block text-gray-300 text-sm font-medium mb-2">
                      Quantity
                    </label>
                    <div className="flex items-center gap-3">
                      <button
                        type="button"
                        onClick={() =>
                          setDeckQuantity(Math.max(1, deckQuantity - 1))
                        }
                        className="w-10 h-10 bg-gray-700 border border-gray-600 rounded-lg flex items-center justify-center text-white hover:bg-gray-600 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                        disabled={deckQuantity <= 1}
                      >
                        <svg
                          className="w-4 h-4"
                          fill="none"
                          stroke="currentColor"
                          viewBox="0 0 24 24"
                        >
                          <path
                            strokeLinecap="round"
                            strokeLinejoin="round"
                            strokeWidth={2}
                            d="M20 12H4"
                          />
                        </svg>
                      </button>
                      <div className="flex-1 bg-gray-700 border border-gray-600 rounded-lg px-4 py-3 text-center">
                        <span className="dark:text-white text-theme-primary text-lg font-medium">
                          {deckQuantity}
                        </span>
                      </div>
                      <button
                        type="button"
                        onClick={() => setDeckQuantity(deckQuantity + 1)}
                        className="w-10 h-10 bg-gray-700 border border-gray-600 rounded-lg flex items-center justify-center text-white hover:bg-gray-600 transition-colors"
                      >
                        <svg
                          className="w-4 h-4"
                          fill="none"
                          stroke="currentColor"
                          viewBox="0 0 24 24"
                        >
                          <path
                            strokeLinecap="round"
                            strokeLinejoin="round"
                            strokeWidth={2}
                            d="M12 6v6m0 0v6m0-6h6m-6 0H6"
                          />
                        </svg>
                      </button>
                    </div>
                  </div>
                </div>
                <div className="flex gap-3 mt-6">
                  <button
                    onClick={() => {
                      setShowAddToDeckModal(false);
                      setDeckQuantity(1);
                    }}
                    className="flex-1 bg-gray-600 text-white py-2 px-4 rounded-lg hover:bg-gray-500 transition-colors"
                  >
                    Cancel
                  </button>
                  <button
                    onClick={handleDeckSelection}
                    disabled={availableDecks.length === 0 || !selectedCard}
                    className="flex-1 bg-primary text-white py-2 px-4 rounded-lg hover:bg-primary/80 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                  >
                    Add to Deck
                  </button>
                </div>
              </div>
            </div>
          )}

          {/* Add to Binder Modal */}
          {showAddToBinderModal && (
            <div className="fixed inset-0 z-[10000] bg-black/50 backdrop-blur-sm flex items-center justify-center p-4">
              <div className="bg-gray-800 rounded-2xl p-6 w-full max-w-md mx-auto relative modal-container add-to-binder-modal">
                <div className="flex items-center gap-3 mb-6">
                  <img
                    src="/Assets/Addtobinder.svg"
                    alt="Add to Binder"
                    className="w-6 h-6"
                  />
                  <h2 className="dark:text-white text-theme-primary text-xl font-semibold">
                    Add to Binder
                  </h2>
                </div>
                <div className="space-y-4">
                  <div>
                    <label className="block text-gray-300 text-sm font-medium mb-2">
                      Select Binder
                    </label>
                    <div className="relative dropdown-container">
                      <button
                        type="button"
                        onClick={() =>
                          setShowBinderDropdown(!showBinderDropdown)
                        }
                        className="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-3 text-white text-left flex items-center justify-between focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent"
                      >
                        <span>{selectedBinder}</span>
                        <svg
                          className={`w-4 h-4 transition-transform ${
                            showBinderDropdown ? "rotate-180" : ""
                          }`}
                          fill="none"
                          stroke="currentColor"
                          viewBox="0 0 24 24"
                        >
                          <path
                            strokeLinecap="round"
                            strokeLinejoin="round"
                            strokeWidth={2}
                            d="M19 9l-7 7-7-7"
                          />
                        </svg>
                      </button>
                      {showBinderDropdown && (
                        <div className="absolute z-50 w-full mt-1 bg-gray-700 border border-gray-600 rounded-lg shadow-lg">
                          <div className="py-1">
                            {availableBinders.map((binder) => (
                              <button
                                key={binder.id}
                                type="button"
                                onClick={() => {
                                  setSelectedBinder(binder.name);
                                  setShowBinderDropdown(false);
                                }}
                                className="w-full px-4 py-2 text-left text-white hover:bg-gray-600 transition-colors"
                              >
                                {binder.name}
                              </button>
                            ))}
                          </div>
                        </div>
                      )}
                    </div>
                  </div>
                  <div className="bg-gray-700/50 border border-gray-600 rounded-lg p-3">
                    <div className="flex items-center gap-2">
                      <svg
                        className="w-4 h-4 text-blue-400"
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                      >
                        <path
                          strokeLinecap="round"
                          strokeLinejoin="round"
                          strokeWidth={2}
                          d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
                        />
                      </svg>
                      <p className="text-gray-300 text-sm">
                        Card will be added to the next available slot in the
                        selected binder
                      </p>
                    </div>
                  </div>
                </div>
                <div className="flex gap-3 mt-6">
                  <button
                    onClick={() => setShowAddToBinderModal(false)}
                    className="flex-1 bg-gray-600 text-white py-2 px-4 rounded-lg hover:bg-gray-500 transition-colors"
                  >
                    Cancel
                  </button>
                  <button
                    onClick={handleBinderSelectionForCard}
                    className="flex-1 bg-primary text-white py-2 px-4 rounded-lg hover:bg-primary/80 transition-colors"
                  >
                    Add to Binder
                  </button>
                </div>
              </div>
            </div>
          )}

          {/* Set Custom Tag Modal */}
          {showSetCustomTagModal && (
            <div className="fixed inset-0 z-[10000] bg-black/50 backdrop-blur-sm flex items-center justify-center p-4">
              <div className="bg-gray-800 rounded-2xl p-6 w-full max-w-md mx-auto relative modal-container">
                <div className="flex items-center gap-3 mb-6">
                  <img
                    src="/Assets/SetTag.svg"
                    alt="Set Custom Tag"
                    className="w-6 h-6"
                  />
                  <h2 className="dark:text-white text-theme-primary text-xl font-semibold">
                    Set Custom Tag
                  </h2>
                </div>
                <div className="space-y-4">
                  {/* Create/Edit Tag Form */}
                  <div>
                    <label className="block text-gray-300 text-sm font-medium mb-2">
                      {editingTagIndex !== null ? "Edit Tag Name" : "Tag Name"}
                    </label>
                    <input
                      type="text"
                      placeholder="Enter tag name..."
                      value={tagName}
                      onChange={(e) => setTagName(e.target.value)}
                      className="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-3 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent"
                    />
                  </div>
                  <div>
                    <label className="block text-gray-300 text-sm font-medium mb-2">
                      Tag Color
                    </label>
                    <div className="flex gap-2">
                      {["red", "blue", "green", "yellow", "purple", "pink"].map(
                        (color) => (
                          <button
                            key={color}
                            onClick={() => setSelectedTagColor(color)}
                            className={`w-8 h-8 bg-${color}-500 rounded-full border-2 ${
                              selectedTagColor === color
                                ? "border-white"
                                : "border-transparent"
                            } hover:scale-110 transition-transform`}
                          />
                        )
                      )}
                    </div>
                  </div>

                  {/* Current Tags Display */}
                  {cardCustomTags.length > 0 && (
                    <div>
                      <label className="block text-gray-300 text-sm font-medium mb-2">
                        Current Tags
                      </label>
                      <div className="flex flex-wrap gap-2">
                        {cardCustomTags.map((tag, index) => (
                          <div
                            key={index}
                            className={`group relative cursor-pointer ${
                              editingTagIndex === index
                                ? "ring-2 ring-blue-400 ring-opacity-50 rounded-full"
                                : ""
                            }`}
                            onClick={() => {
                              setTagName(tag.name);
                              setSelectedTagColor(tag.color);
                              setEditingTagIndex(index);
                            }}
                          >
                            <div
                              className={`px-3 py-1 rounded-full text-sm font-medium ${
                                colorMap[tag.color].text
                              } ${colorMap[tag.color].bg} border ${
                                colorMap[tag.color].border
                              } flex items-center gap-2`}
                            >
                              <div
                                className={`w-2 h-2 rounded-full ${
                                  colorMap[tag.color].dot
                                }`}
                              ></div>
                              <span>{tag.name}</span>
                            </div>
                            {editingTagIndex === index && (
                              <div className="absolute -top-1 -right-1 w-3 h-3 bg-blue-500 rounded-full"></div>
                            )}
                          </div>
                        ))}
                      </div>
                    </div>
                  )}
                </div>
                <div className="flex gap-3 mt-6">
                  <button
                    onClick={() => {
                      setShowSetCustomTagModal(false);
                      setTagName("");
                      setSelectedTagColor("red");
                      setEditingTagIndex(null);
                    }}
                    className="flex-1 bg-gray-600 text-white py-2 px-4 rounded-lg hover:bg-gray-500 transition-colors"
                  >
                    Cancel
                  </button>
                  {editingTagIndex !== null && (
                    <button
                      onClick={() => {
                        const newTags = cardCustomTags.filter(
                          (_, index) => index !== editingTagIndex
                        );
                        setCardCustomTags(newTags);
                        setTagName("");
                        setSelectedTagColor("red");
                        setEditingTagIndex(null);
                      }}
                      className="bg-red-600 text-white py-2 px-4 rounded-lg hover:bg-red-500 transition-colors"
                    >
                      Delete
                    </button>
                  )}
                  <button
                    onClick={() => {
                      if (tagName.trim()) {
                        const newTag = {
                          name: tagName.trim(),
                          color: selectedTagColor,
                        };

                        if (editingTagIndex !== null) {
                          // Update existing tag
                          const newTags = [...cardCustomTags];
                          newTags[editingTagIndex] = newTag;
                          setCardCustomTags(newTags);
                        } else {
                          // Add new tag
                          setCardCustomTags([...cardCustomTags, newTag]);
                        }

                        setTagName("");
                        setSelectedTagColor("red");
                        setEditingTagIndex(null);
                      }
                    }}
                    disabled={!tagName.trim()}
                    className="flex-1 bg-primary text-white py-2 px-4 rounded-lg hover:bg-primary/80 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                  >
                    {editingTagIndex !== null ? "Update Tag" : "Create Tag"}
                  </button>
                </div>
              </div>
            </div>
          )}

          {/* Send Feedback Modal */}
          {showSendFeedbackModal && (
            <div className="fixed inset-0 z-[10000] bg-black/50 backdrop-blur-sm flex items-center justify-center p-4">
              <div className="bg-gray-800 rounded-2xl p-6 w-full max-w-md mx-auto relative modal-container">
                <div className="flex items-center gap-3 mb-6">
                  <img
                    src="/Assets/Sendfeedback.svg"
                    alt="Send Feedback"
                    className="w-6 h-6"
                  />
                  <h2 className="dark:text-white text-theme-primary text-xl font-semibold">
                    Send Feedback
                  </h2>
                </div>
                <div className="space-y-4">
                  <div>
                    <label className="block text-gray-300 text-sm font-medium mb-2">
                      Issue Type
                    </label>
                    <div className="relative dropdown-container">
                      <button
                        type="button"
                        onClick={() => setShowIssueDropdown(!showIssueDropdown)}
                        className="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-3 text-white text-left flex items-center justify-between focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent"
                      >
                        <span>{selectedIssue}</span>
                        <svg
                          className={`w-4 h-4 transition-transform ${
                            showIssueDropdown ? "rotate-180" : ""
                          }`}
                          fill="none"
                          stroke="currentColor"
                          viewBox="0 0 24 24"
                        >
                          <path
                            strokeLinecap="round"
                            strokeLinejoin="round"
                            strokeWidth={2}
                            d="M19 9l-7 7-7-7"
                          />
                        </svg>
                      </button>
                      {showIssueDropdown && (
                        <div className="absolute z-50 w-full mt-1 bg-gray-700 border border-gray-600 rounded-lg shadow-lg">
                          <div className="py-1">
                            {[
                              "Incorrect Image",
                              "Incorrect Price",
                              "Missing Information",
                              "Card Not Found",
                              "App Bug",
                              "Feature Request",
                              "Other",
                            ].map((option) => (
                              <button
                                key={option}
                                type="button"
                                onClick={() => {
                                  setSelectedIssue(option);
                                  setShowIssueDropdown(false);
                                }}
                                className="w-full px-4 py-2 text-left text-white hover:bg-gray-600 transition-colors"
                              >
                                {option}
                              </button>
                            ))}
                          </div>
                        </div>
                      )}
                    </div>
                  </div>
                  <div>
                    <label className="block text-gray-300 text-sm font-medium mb-2">
                      Description
                    </label>
                    <textarea
                      placeholder="Please describe the issue or feedback..."
                      rows="4"
                      className="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-3 text-white placeholder-gray-400 resize-none focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent"
                    ></textarea>
                  </div>
                  <div>
                    <label className="block text-gray-300 text-sm font-medium mb-2">
                      Your Email (Optional)
                    </label>
                    <input
                      type="email"
                      placeholder="your@email.com"
                      className="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-3 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent"
                    />
                  </div>
                </div>
                <div className="flex gap-3 mt-6">
                  <button
                    onClick={() => setShowSendFeedbackModal(false)}
                    className="flex-1 bg-gray-600 text-white py-2 px-4 rounded-lg hover:bg-gray-500 transition-colors"
                  >
                    Cancel
                  </button>
                  <button
                    onClick={() => setShowSendFeedbackModal(false)}
                    className="flex-1 bg-primary text-white py-2 px-4 rounded-lg hover:bg-primary/80 transition-colors"
                  >
                    Send Feedback
                  </button>
                </div>
              </div>
            </div>
          )}

          {/* Set Pricing Alerts Modal - Card Profile Only */}
          {showPriceAlertModal && (
            <div className="fixed inset-0 z-[10003] bg-black/50 backdrop-blur-sm flex items-center justify-center p-4">
              <div className="bg-gray-800 rounded-2xl p-6 w-full max-w-md mx-auto relative modal-container">
                <div className="flex items-center gap-3 mb-6">
                  <div className="w-10 h-10 bg-blue-500/20 rounded-lg flex items-center justify-center">
                    <img
                      src="/Assets/PriceAlert.svg"
                      alt="Price Alert"
                      className="w-5 h-5"
                    />
                  </div>
                  <div>
                    <h2 className="dark:text-white text-theme-primary text-xl font-semibold">
                      Set Pricing Alert
                    </h2>
                    <p className="text-gray-400 text-sm">
                      Get notified when price changes
                    </p>
                  </div>
                </div>

                <div className="space-y-5">
                  {/* Current Price Display */}
                  <div className="bg-gray-700/50 rounded-lg p-4 border border-gray-600/50">
                    <div className="flex items-center justify-between mb-3">
                      <div>
                        <p className="text-gray-400 text-sm">
                          Current Market Price
                        </p>
                        <p className="dark:text-white text-theme-primary text-2xl font-bold">
                          $
                          {selectedCard?.current_value?.toFixed(2) ||
                            selectedCard?.price?.toFixed(2) ||
                            "0.00"}
                        </p>
                      </div>
                      <div className="text-right">
                        <p className="text-gray-400 text-sm">Card</p>
                        <p className="dark:text-white text-theme-primary text-sm font-medium">
                          {selectedCard?.name || "Unknown"}
                        </p>
                      </div>
                    </div>
                  </div>

                  {/* Alert Type */}
                  <div>
                    <label className="block text-gray-300 text-sm font-medium mb-3">
                      Alert Type
                    </label>
                    <div className="flex gap-3">
                      <label className="flex items-center gap-2 cursor-pointer">
                        <input
                          type="radio"
                          name="alertType"
                          value="above"
                          className="w-4 h-4 text-primary bg-gray-700 border-gray-600 focus:ring-primary focus:ring-2"
                        />
                        <span className="dark:text-white text-theme-primary text-sm">
                          Price goes above
                        </span>
                      </label>
                      <label className="flex items-center gap-2 cursor-pointer">
                        <input
                          type="radio"
                          name="alertType"
                          value="below"
                          className="w-4 h-4 text-primary bg-gray-700 border-gray-600 focus:ring-primary focus:ring-2"
                        />
                        <span className="dark:text-white text-theme-primary text-sm">
                          Price goes below
                        </span>
                      </label>
                    </div>
                  </div>

                  {/* Price Threshold */}
                  <div>
                    <label className="block text-gray-300 text-sm font-medium mb-2">
                      Price Threshold
                    </label>
                    <div className="relative">
                      <span className="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400">
                        $
                      </span>
                      <input
                        type="number"
                        step="0.01"
                        placeholder="0.00"
                        className="w-full bg-gray-700 border border-gray-600 rounded-lg pl-8 pr-4 py-3 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent"
                      />
                    </div>
                  </div>

                  {/* Notification Method */}
                  <div>
                    <label className="block text-gray-300 text-sm font-medium mb-3">
                      Notification Method
                    </label>
                    <div className="space-y-2">
                      <label className="flex items-center gap-3 cursor-pointer">
                        <input
                          type="checkbox"
                          className="w-4 h-4 text-primary bg-gray-700 border-gray-600 rounded focus:ring-primary focus:ring-2"
                        />
                        <span className="dark:text-white text-theme-primary text-sm">
                          Push Notification
                        </span>
                      </label>
                      <label className="flex items-center gap-3 cursor-pointer">
                        <input
                          type="checkbox"
                          className="w-4 h-4 text-primary bg-gray-700 border-gray-600 rounded focus:ring-primary focus:ring-2"
                        />
                        <span className="dark:text-white text-theme-primary text-sm">
                          Email
                        </span>
                      </label>
                    </div>
                  </div>

                  {/* Notes */}
                  <div>
                    <label className="block text-gray-300 text-sm font-medium mb-2">
                      Notes (Optional)
                    </label>
                    <textarea
                      placeholder="Add any additional notes about this alert..."
                      className="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-3 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent resize-none h-20"
                    />
                  </div>
                </div>

                <div className="flex gap-3 mt-6">
                  <button
                    onClick={() => setShowPriceAlertModal(false)}
                    className="flex-1 bg-gray-600 hover:bg-gray-500 text-white py-3 px-4 rounded-lg font-medium transition-colors"
                  >
                    Cancel
                  </button>
                  <button
                    onClick={async () => {
                      // Get form values
                      const alertType =
                        document.querySelector(
                          'input[name="alertType"]:checked'
                        )?.value || "above";
                      const priceThreshold = document.querySelector(
                        'input[type="number"]'
                      )?.value;

                      if (!priceThreshold || parseFloat(priceThreshold) <= 0) {
                        alert("Please enter a valid price threshold");
                        return;
                      }

                      // Create new pricing alert data
                      const alertData = {
                        cardId: selectedCard?.id,
                        cardName: selectedCard?.name || "Unknown Card",
                        setName: selectedCard?.set_name || "Unknown Set",
                        rarity: selectedCard?.rarity || "Unknown",
                        cardNumber: selectedCard?.formattedNumber || "N/A",
                        imageUrl:
                          selectedCard?.image_url ||
                          selectedCard?.imageUrl ||
                          "https://images.pokemontcg.io/base1/4.png",
                        alertPrice: parseFloat(priceThreshold),
                        alertType: alertType,
                        notes: document.querySelector("textarea")?.value || "",
                      };

                      // Create alert in database
                      const result = await createPricingAlert(alertData);

                      if (result.success) {
                        // Reload alerts from database
                        await loadPricingAlerts();

                        // Close modal and show success message
                        setShowPriceAlertModal(false);
                        alert(
                          `Price alert set for ${selectedCard?.name} at $${priceThreshold}`
                        );
                      } else {
                        alert(`Failed to create alert: ${result.error}`);
                      }
                    }}
                    className="flex-1 bg-primary hover:bg-primary/80 text-white py-3 px-4 rounded-lg font-medium transition-colors"
                  >
                    Create Alert
                  </button>
                </div>
              </div>
            </div>
          )}

          {/* Edit Price Paid Modal - Card Profile Only */}
          {showEditPricePaidModal && (
            <div className="fixed inset-0 z-[10003] bg-black/50 backdrop-blur-sm flex items-center justify-center p-4">
              <div className="bg-gray-800 rounded-2xl p-6 w-full max-w-md mx-auto relative modal-container">
                <div className="flex items-center gap-3 mb-6">
                  <div className="w-10 h-10 bg-green-500/20 rounded-lg flex items-center justify-center">
                    <img
                      src="/Assets/Edit Price Paid.svg"
                      alt="Edit Price Paid"
                      className="w-5 h-5"
                    />
                  </div>
                  <div>
                    <h2 className="dark:text-white text-theme-primary text-xl font-semibold">
                      Edit Price Paid
                    </h2>
                    <p className="text-gray-400 text-sm">
                      Update your purchase price
                    </p>
                  </div>
                </div>

                <div className="space-y-5">
                  {/* Current Price Display */}
                  <div className="bg-gray-700 rounded-lg p-4">
                    <div className="flex items-center justify-between">
                      <span className="text-gray-300 text-sm">
                        Current Market Value
                      </span>
                      <span className="dark:text-white text-theme-primary text-lg font-bold">
                        {(() => {
                          const currentPrice =
                            updatedCollectionPrices[selectedCard?.cardId] ||
                            selectedCard?.current_value;
                          return currentPrice && currentPrice > 0
                            ? formatCurrency(currentPrice)
                            : "—";
                        })()}
                      </span>
                    </div>
                    <div className="flex items-center justify-between mt-2">
                      <span className="text-gray-300 text-sm">
                        Your Purchase Price
                      </span>
                      <span className="text-gray-400 text-sm">$0.00</span>
                    </div>
                  </div>

                  {/* Price Paid Input */}
                  <div>
                    <label className="block text-gray-300 text-sm font-medium mb-2">
                      Price You Paid
                    </label>
                    <div className="relative">
                      <span className="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400">
                        $
                      </span>
                      <input
                        type="number"
                        step="0.01"
                        placeholder="0.00"
                        className="w-full bg-gray-700 border border-gray-600 rounded-lg pl-8 pr-4 py-3 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent"
                      />
                    </div>
                  </div>

                  {/* Purchase Date */}
                  <div>
                    <label className="block text-gray-300 text-sm font-medium mb-2">
                      Purchase Date
                    </label>
                    <input
                      type="date"
                      className="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-3 text-white focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent"
                    />
                  </div>

                  {/* Purchase Source */}
                  <div>
                    <label className="block text-gray-300 text-sm font-medium mb-2">
                      Purchase Source
                    </label>
                    <div className="relative dropdown-container">
                      <button
                        onClick={() =>
                          setShowPurchaseSourceDropdown(
                            !showPurchaseSourceDropdown
                          )
                        }
                        className="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-3 text-white text-left flex items-center justify-between focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent"
                      >
                        <span>{selectedPurchaseSource || "Select source"}</span>
                        <svg
                          className={`w-4 h-4 transition-transform ${
                            showPurchaseSourceDropdown ? "rotate-180" : ""
                          }`}
                          fill="none"
                          stroke="currentColor"
                          viewBox="0 0 24 24"
                        >
                          <path
                            strokeLinecap="round"
                            strokeLinejoin="round"
                            strokeWidth={2}
                            d="M19 9l-7 7-7-7"
                          />
                        </svg>
                      </button>
                      {showPurchaseSourceDropdown && (
                        <div className="absolute z-50 w-full mt-1 bg-gray-700 border border-gray-600 rounded-lg shadow-lg">
                          <div className="py-1">
                            {[
                              "eBay",
                              "TCGPlayer",
                              "Local Store",
                              "Trade",
                              "Gift",
                              "Other",
                            ].map((source) => (
                              <button
                                key={source}
                                onClick={() => {
                                  setSelectedPurchaseSource(source);
                                  setShowPurchaseSourceDropdown(false);
                                }}
                                className="w-full px-4 py-2 text-left text-white hover:bg-gray-600 transition-colors"
                              >
                                {source}
                              </button>
                            ))}
                          </div>
                        </div>
                      )}
                    </div>
                  </div>

                  {/* Notes */}
                  <div>
                    <label className="block text-gray-300 text-sm font-medium mb-2">
                      Notes (Optional)
                    </label>
                    <textarea
                      placeholder="Add any notes about this purchase..."
                      className="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-3 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent resize-none h-20"
                    />
                  </div>
                </div>

                <div className="flex gap-3 mt-6">
                  <button
                    onClick={() => setShowEditPricePaidModal(false)}
                    className="flex-1 bg-gray-600 hover:bg-gray-500 text-white py-3 px-4 rounded-lg font-medium transition-colors"
                  >
                    Cancel
                  </button>
                  <button
                    onClick={() => {
                      // Handle price paid update
                      console.log("Price paid updated");
                      setShowEditPricePaidModal(false);
                    }}
                    className="flex-1 bg-primary hover:bg-primary/80 text-white py-3 px-4 rounded-lg font-medium transition-colors"
                  >
                    Save Changes
                  </button>
                </div>
              </div>
            </div>
          )}

          {/* Wishlist Notification */}
          {showWishlistNotification && (
            <div className="fixed bottom-24 left-0 right-0 z-[70] animate-slide-up-notification">
              <div className="bg-gray-800/95 backdrop-blur-sm border border-gray-600/50 rounded-xl px-4 py-3 shadow-2xl mx-auto w-fit">
                <div className="flex items-center gap-3">
                  <div className="w-2 h-2 bg-primary rounded-full"></div>
                  <span className="text-white text-sm font-medium">
                    {wishlistNotificationMessage}
                  </span>
                </div>
              </div>
            </div>
          )}

          {/* Bottom Spacing */}
          <div className="h-20"></div>

          {/* Card Profile Navigation Bar - Using main navigation with none state */}
          <div
            className={`fixed bottom-0 left-0 right-0 px-2 py-2 sm:px-[19px] sm:py-0 sm:bottom-4 sm:rounded-[16px] z-[10002] ${
              showAddToCollectionModal ? "pointer-events-none" : ""
            }`}
            style={{
              filter:
                "drop-shadow(0px 24px 7px rgba(0,0,0,0.01)) drop-shadow(16px 16px 16px rgba(0,0,0,0.04)) drop-shadow(0px 9px 5px rgba(0,0,0,0.15)) drop-shadow(0px 4px 4px rgba(0,0,0,0.25)) drop-shadow(0px 1px 2px rgba(0,0,0,0.29))",
            }}
          >
            <div
              className={`flex items-center justify-between px-4 py-2 sm:px-[30px] sm:py-0 rounded-[16px] relative dark:border-white/50 border-[#d2d3db]/50 h-[75px] overflow-hidden ${
                isDark ? "bg-gray-900/90" : "bg-[#fafafa]/95"
              }`}
              style={{
                backdropFilter: "blur(60px) saturate(200%)",
                WebkitBackdropFilter: "blur(60px) saturate(200%)",
                boxShadow: isDark
                  ? "inset 0 1px 0 rgba(255,255,255,0.15), inset 0 -1px 0 rgba(0,0,0,0.2)"
                  : "inset 0 1px 0 rgba(250,250,250,0.9), inset 0 -1px 0 rgba(72,75,106,0.03), 0 4px 6px rgba(72,75,106,0.08)",
              }}
            >
              {/* Home Button */}
              <button
                onClick={() => {
                  setSelectedCard(null); // Close card profile modal
                  setShowCardProfile(false);
                  setShowSearchResults(false);
                  setTimeout(() => {
                    setActiveTab("home");
                    setNavigationMode("home");
                    scrollToTop(); // Scroll to top when navigating
                  }, 100);
                }}
                className="flex flex-col gap-[10px] h-[75px] items-center justify-center pt-[26px] px-2 sm:px-[10px] w-16 sm:w-[84px]"
              >
                <div className="flex flex-col gap-[6px] h-[58px] items-center w-12 sm:w-[64px]">
                  <div className="w-6 h-6 relative">
                    <svg
                      width="24"
                      height="24"
                      viewBox="0 0 24 24"
                      fill="none"
                      xmlns="http://www.w3.org/2000/svg"
                    >
                      <path
                        d="M20.04 6.82006L14.28 2.79006C12.71 1.69006 10.3 1.75006 8.78999 2.92006L3.77999 6.83006C2.77999 7.61006 1.98999 9.21006 1.98999 10.4701V17.3701C1.98999 19.9201 4.05999 22.0001 6.60999 22.0001H17.39C19.94 22.0001 22.01 19.9301 22.01 17.3801V10.6001C22.01 9.25006 21.14 7.59006 20.04 6.82006ZM12.75 18.0001C12.75 18.4101 12.41 18.7501 12 18.7501C11.59 18.7501 11.25 18.4101 11.25 18.0001V15.0001C11.25 14.5901 11.59 14.2501 12 14.2501C12.41 14.2501 12.75 14.5901 12.75 15.0001V18.0001Z"
                        stroke="#8F8F94"
                        strokeWidth="2"
                        strokeLinecap="round"
                        strokeLinejoin="round"
                      />
                    </svg>
                  </div>
                </div>
              </button>
              {/* Collection Button */}
              <button
                onClick={() => {
                  setSelectedCard(null); // Close card profile modal first
                  setTimeout(() => {
                    setActiveTab("collection");
                    setNavigationMode("collection");
                    scrollToTop(); // Scroll to top when navigating
                  }, 100); // Small delay to ensure modal closes first
                }}
                className="flex flex-col gap-[10px] h-[75px] items-center justify-center pt-[26px] px-2 sm:px-[10px] w-16 sm:w-[84px]"
              >
                <div className="flex flex-col gap-[6px] h-[58px] items-center w-12 sm:w-[64px]">
                  <div className="w-6 h-6 relative">
                    <svg
                      width="25"
                      height="24"
                      viewBox="0 0 25 24"
                      fill="none"
                      xmlns="http://www.w3.org/2000/svg"
                    >
                      <g clipPath="url(#clip0_248_3247)">
                        <path
                          d="M11.555 1.469C11.6113 1.26096 11.7477 1.0837 11.9344 0.976052C12.1211 0.868406 12.3428 0.839157 12.551 0.894714L22.871 3.65814C23.0797 3.71364 23.2578 3.84974 23.3661 4.03652C23.4745 4.2233 23.5042 4.44546 23.4488 4.65414L19.4888 19.4279C19.4325 19.6363 19.2959 19.8138 19.1088 19.9215C18.9217 20.0292 18.6995 20.0582 18.491 20.0021L8.17104 17.2387C7.96268 17.1828 7.78501 17.0466 7.67702 16.8599C7.56903 16.6731 7.53954 16.4512 7.59504 16.2427L11.555 1.469Z"
                          stroke="#8F8F94"
                          strokeWidth="2"
                          strokeLinecap="round"
                          strokeLinejoin="round"
                        ></path>
                        <path
                          d="M10.8042 4.3457L1.7939 6.76113C1.58555 6.81699 1.40787 6.95325 1.29988 7.13999C1.19189 7.32672 1.16241 7.54868 1.2179 7.75713L5.17447 22.5308C5.23069 22.7393 5.36736 22.9168 5.55445 23.0245C5.74154 23.1322 5.96373 23.1612 6.17219 23.1051L11.3322 21.7234"
                          stroke="#8F8F94"
                          strokeWidth="2"
                          strokeLinecap="round"
                          strokeLinejoin="round"
                        ></path>
                      </g>
                      <defs>
                        <clipPath id="clip0_248_3247">
                          <rect
                            width="24"
                            height="24"
                            fill="white"
                            transform="translate(0.333313)"
                          ></rect>
                        </clipPath>
                      </defs>
                    </svg>
                  </div>
                </div>
              </button>
              {/* Marketplace Button */}
              <button
                onClick={() => {
                  setSelectedCard(null); // Close card profile modal
                  setShowCardProfile(false);
                  setShowSearchResults(false);
                  setTimeout(() => {
                    setActiveTab("marketplace");
                    setNavigationMode("marketplace");
                    scrollToTop(); // Scroll to top when navigating
                  }, 100);
                }}
                className="flex flex-col gap-[10px] h-[75px] items-center justify-center pt-[26px] px-2 sm:px-[10px] w-16 sm:w-[84px]"
              >
                <div className="flex flex-col gap-[6px] h-[58px] items-center w-12 sm:w-[64px]">
                  <div className="w-6 h-6 relative">
                    <svg
                      width="25"
                      height="24"
                      viewBox="0 0 25 24"
                      fill="none"
                      xmlns="http://www.w3.org/2000/svg"
                    >
                      <g clipPath="url(#clip0_248_3253)">
                        <path
                          fillRule="evenodd"
                          clipRule="evenodd"
                          d="M11.3334 21.3351C11.3334 22.8081 10.1393 24.0022 8.6663 24.0022C7.1933 24.0022 5.99921 22.8081 5.99921 21.3351C5.99921 19.8621 7.1933 18.668 8.6663 18.668C10.1393 18.668 11.3334 19.8621 11.3334 21.3351ZM22.0018 21.3351C22.0018 22.8081 20.8077 24.0022 19.3347 24.0022C17.8617 24.0022 16.6676 22.8081 16.6676 21.3351C16.6676 19.8621 17.8617 18.668 19.3347 18.668C20.8077 18.668 22.0018 19.8621 22.0018 21.3351Z"
                          fill="#8F8F94"
                        />
                        <path
                          fillRule="evenodd"
                          clipRule="evenodd"
                          d="M0.665039 1.33159C0.665039 0.595096 1.26209 -0.00195312 1.99859 -0.00195312H2.47918C4.38621 -0.00195312 6.02813 1.3441 6.40213 3.2141L6.55905 3.99868H21.3308C23.5421 3.99868 25.1407 6.11215 24.5388 8.23995L23.1673 13.0888C22.68 14.8114 21.1078 16.0006 19.3177 16.0006H9.51926C7.61223 16.0006 5.97031 14.6545 5.59631 12.7846L3.78683 3.73716C3.66217 3.11382 3.11486 2.66514 2.47918 2.66514H1.99859C1.26209 2.66514 0.665039 2.06809 0.665039 1.33159ZM7.09247 6.66578L8.21161 12.2615C8.33628 12.8848 8.88359 13.3335 9.51926 13.3335H19.3177C19.9144 13.3335 20.4385 12.9371 20.6009 12.3629L21.9724 7.51403C22.0928 7.08847 21.7731 6.66578 21.3308 6.66578H7.09247Z"
                          fill="#8F8F94"
                        />
                      </g>
                      <defs>
                        <clipPath id="clip0_248_3253">
                          <rect
                            width="24"
                            height="24"
                            fill="white"
                            transform="translate(0.666687)"
                          />
                        </clipPath>
                      </defs>
                    </svg>
                  </div>
                </div>
              </button>
              {/* Profile Button */}
              <button
                onClick={() => {
                  setActiveTab("profile");
                  setNavigationMode("profile");
                  setViewingUserId(null); // Show own profile
                  setSelectedCard(null); // Close card profile modal
                  scrollToTop(); // Scroll to top when navigating
                }}
                className="flex flex-col gap-[10px] h-[75px] items-center justify-center pt-[26px] px-2 sm:px-[10px] w-16 sm:w-[84px]"
              >
                <div className="flex flex-col gap-[6px] h-[58px] items-center w-12 sm:w-[64px]">
                  <div className="w-6 h-6 relative">
                    <svg
                      width="24"
                      height="24"
                      viewBox="0 0 24 24"
                      fill="none"
                      xmlns="http://www.w3.org/2000/svg"
                    >
                      <path
                        d="M12 12C14.7614 12 17 9.76142 17 7C17 4.23858 14.7614 2 12 2C9.23858 2 7 4.23858 7 7C7 9.76142 9.23858 12 12 12Z"
                        stroke="#8F8F94"
                        strokeWidth="2"
                        strokeLinecap="round"
                        strokeLinejoin="round"
                      ></path>
                      <path
                        d="M20.59 22C20.59 18.13 16.74 15 12 15C7.26003 15 3.41003 18.13 3.41003 22"
                        stroke="#8F8F94"
                        strokeWidth="2"
                        strokeLinecap="round"
                        strokeLinejoin="round"
                      ></path>
                    </svg>
                  </div>
                </div>
              </button>
            </div>
          </div>
        </div>{" "}
        {/* Close scrollable content container */}
        {/* Note Modal */}
        {console.log(
          "Card Profile - Rendering note modal check:",
          showNoteModal,
          selectedCard
        )}
        {showNoteModal && selectedCard && (
          <div
            style={{
              position: "fixed",
              top: 0,
              left: 0,
              right: 0,
              bottom: 0,
              backgroundColor: "rgba(0,0,0,0.8)",
              zIndex: 9999999,
              display: "flex",
              alignItems: "center",
              justifyContent: "center",
              padding: "20px",
            }}
            onClick={() => setShowNoteModal(false)}
          >
            <div
              style={{
                backgroundColor: "#2b2b2b",
                borderRadius: "16px",
                padding: "24px",
                width: "100%",
                maxWidth: "400px",
                maxHeight: "80vh",
                overflowY: "auto",
                border: "1px solid #444",
              }}
              onClick={(e) => e.stopPropagation()}
            >
              {/* Header */}
              <div
                style={{
                  display: "flex",
                  alignItems: "center",
                  justifyContent: "space-between",
                  marginBottom: "20px",
                }}
              >
                <h2
                  style={{
                    color: "white",
                    fontSize: "18px",
                    fontWeight: "600",
                    margin: 0,
                  }}
                >
                  {selectedCard?.note ? "Edit Note" : "Add Note"}
                </h2>
                <button
                  onClick={() => setShowNoteModal(false)}
                  style={{
                    width: "32px",
                    height: "32px",
                    backgroundColor: "#444",
                    border: "none",
                    borderRadius: "50%",
                    color: "white",
                    cursor: "pointer",
                    display: "flex",
                    alignItems: "center",
                    justifyContent: "center",
                  }}
                >
                  ✕
                </button>
              </div>

              {/* Card Info */}
              <div
                style={{
                  marginBottom: "20px",
                  padding: "16px",
                  backgroundColor: "#333",
                  borderRadius: "8px",
                }}
              >
                <div
                  style={{ display: "flex", alignItems: "center", gap: "12px" }}
                >
                  <div
                    style={{
                      width: "60px",
                      height: "80px",
                      backgroundColor: "#555",
                      borderRadius: "8px",
                      flexShrink: 0,
                    }}
                  >
                    <img
                      src={
                        selectedCard?.images?.small || selectedCard?.imageUrl
                      }
                      alt={selectedCard?.name || "Card"}
                      style={{
                        width: "100%",
                        height: "100%",
                        objectFit: "cover",
                        borderRadius: "8px",
                      }}
                      onError={(e) => {
                        e.target.style.display = "none";
                      }}
                    />
                  </div>
                  <div>
                    <h3
                      style={{
                        color: "white",
                        fontSize: "16px",
                        fontWeight: "500",
                        margin: "0 0 4px 0",
                      }}
                    >
                      {selectedCard?.name || "Unknown Card"}
                    </h3>
                    <p style={{ color: "#999", fontSize: "14px", margin: 0 }}>
                      {selectedCard?.formattedNumber || "N/A"}
                    </p>
                  </div>
                </div>
              </div>

              {/* Note Input */}
              <div style={{ marginBottom: "20px" }}>
                <label
                  style={{
                    color: "white",
                    fontSize: "14px",
                    fontWeight: "500",
                    marginBottom: "8px",
                    display: "block",
                  }}
                >
                  Note
                </label>
                <textarea
                  value={cardNote}
                  onChange={(e) => setCardNote(e.target.value)}
                  placeholder="Add a note about this card..."
                  style={{
                    width: "100%",
                    height: "120px",
                    padding: "12px",
                    backgroundColor: "#333",
                    border: "1px solid #555",
                    borderRadius: "8px",
                    color: "white",
                    fontSize: "14px",
                    resize: "vertical",
                    fontFamily: "inherit",
                    boxSizing: "border-box",
                  }}
                />
              </div>

              {/* Action Buttons */}
              <div style={{ display: "flex", gap: "12px" }}>
                {selectedCard?.note && (
                  <button
                    onClick={handleDeleteNote}
                    style={{
                      flex: 1,
                      padding: "12px",
                      backgroundColor: "#dc2626",
                      border: "none",
                      borderRadius: "8px",
                      color: "white",
                      cursor: "pointer",
                      fontSize: "14px",
                      fontWeight: "500",
                    }}
                  >
                    Delete Note
                  </button>
                )}
                <button
                  onClick={() => setShowNoteModal(false)}
                  style={{
                    flex: 1,
                    padding: "12px",
                    backgroundColor: "#444",
                    border: "none",
                    borderRadius: "8px",
                    color: "white",
                    cursor: "pointer",
                    fontSize: "14px",
                    fontWeight: "500",
                  }}
                >
                  Cancel
                </button>
                <button
                  onClick={handleSaveNote}
                  style={{
                    flex: 1,
                    padding: "12px",
                    backgroundColor: "#6865E7",
                    border: "none",
                    borderRadius: "8px",
                    color: "white",
                    cursor: "pointer",
                    fontSize: "14px",
                    fontWeight: "500",
                  }}
                >
                  {selectedCard?.note ? "Update Note" : "Save Note"}
                </button>
              </div>
            </div>
          </div>
        )}
        {/* Edit Card Modal - REMOVED */}
        {false && (
          <div
            style={{
              position: "fixed",
              top: 0,
              left: 0,
              right: 0,
              bottom: 0,
              backgroundColor: "rgba(0,0,0,0.8)",
              zIndex: 9999999,
              display: "flex",
              alignItems: "center",
              justifyContent: "center",
              padding: "20px",
            }}
            onClick={() => setShowEditCardModal(false)}
          >
            <div
              className="edit-card-modal"
              style={{
                backgroundColor: "#2b2b2b",
                borderRadius: "16px",
                padding: "24px",
                width: "100%",
                maxWidth: "500px",
                maxHeight: "90vh",
                overflowY: "auto",
                border: "1px solid #444",
              }}
              onClick={(e) => e.stopPropagation()}
            >
              {/* Header */}
              <div
                style={{
                  display: "flex",
                  alignItems: "center",
                  justifyContent: "space-between",
                  marginBottom: "20px",
                }}
              >
                <h2
                  style={{
                    color: "white",
                    fontSize: "18px",
                    fontWeight: "600",
                    margin: 0,
                  }}
                >
                  Edit Card
                </h2>
                <button
                  onClick={() => setShowEditCardModal(false)}
                  style={{
                    width: "32px",
                    height: "32px",
                    backgroundColor: "#444",
                    border: "none",
                    borderRadius: "50%",
                    color: "white",
                    cursor: "pointer",
                    display: "flex",
                    alignItems: "center",
                    justifyContent: "center",
                  }}
                >
                  ✕
                </button>
              </div>

              {/* Card Info */}
              <div
                style={{
                  marginBottom: "20px",
                  padding: "16px",
                  backgroundColor: "#333",
                  borderRadius: "8px",
                }}
              >
                <div
                  style={{ display: "flex", alignItems: "center", gap: "12px" }}
                >
                  <img
                    src={editingCard.imageUrl}
                    alt={editingCard.name}
                    style={{
                      width: "40px",
                      height: "56px",
                      objectFit: "cover",
                      borderRadius: "4px",
                    }}
                  />
                  <div>
                    <h3
                      style={{
                        color: "white",
                        fontSize: "16px",
                        fontWeight: "600",
                        margin: 0,
                      }}
                    >
                      {editingCard.name}
                    </h3>
                    <p
                      style={{
                        color: "#888",
                        fontSize: "14px",
                        margin: "4px 0 0 0",
                      }}
                    >
                      {editingCard.set} • {editingCard.rarity}
                    </p>
                  </div>
                </div>
              </div>

              {/* Form Fields */}
              <div
                style={{
                  display: "flex",
                  flexDirection: "column",
                  gap: "16px",
                }}
              >
                {/* Quantity */}
                <div>
                  <label
                    style={{
                      color: "white",
                      fontSize: "14px",
                      fontWeight: "500",
                      marginBottom: "8px",
                      display: "block",
                    }}
                  >
                    Quantity
                  </label>
                  <input
                    type="number"
                    min="1"
                    value={editQuantity}
                    onChange={(e) =>
                      setEditQuantity(parseInt(e.target.value) || 1)
                    }
                    style={{
                      width: "100%",
                      padding: "12px",
                      backgroundColor: "#444",
                      border: "1px solid #666",
                      borderRadius: "8px",
                      color: "white",
                      fontSize: "14px",
                    }}
                  />
                </div>

                {/* Condition */}
                <div>
                  <label
                    style={{
                      color: "white",
                      fontSize: "14px",
                      fontWeight: "500",
                      marginBottom: "8px",
                      display: "block",
                    }}
                  >
                    Condition
                  </label>
                  <select
                    value={editCondition}
                    onChange={(e) => setEditCondition(e.target.value)}
                    style={{
                      width: "100%",
                      padding: "12px",
                      backgroundColor: "#444",
                      border: "1px solid #666",
                      borderRadius: "8px",
                      color: "white",
                      fontSize: "14px",
                    }}
                  >
                    <option value="Near Mint">Near Mint</option>
                    <option value="Lightly Played">Lightly Played</option>
                    <option value="Moderately Played">Moderately Played</option>
                    <option value="Heavily Played">Heavily Played</option>
                    <option value="Damaged">Damaged</option>
                  </select>
                </div>

                {/* Variant */}
                <div>
                  <label
                    style={{
                      color: "white",
                      fontSize: "14px",
                      fontWeight: "500",
                      marginBottom: "8px",
                      display: "block",
                    }}
                  >
                    Variant
                  </label>
                  <select
                    value={editVariant}
                    onChange={(e) => setEditVariant(e.target.value)}
                    style={{
                      width: "100%",
                      padding: "12px",
                      backgroundColor: "#444",
                      border: "1px solid #666",
                      borderRadius: "8px",
                      color: "white",
                      fontSize: "14px",
                    }}
                  >
                    <option value="Normal">Normal</option>
                    <option value="Holo">Holo</option>
                    <option value="Reverse Holo">Reverse Holo</option>
                    <option value="Foil">Foil</option>
                  </select>
                </div>

                {/* Grading Toggle */}
                <div
                  style={{ display: "flex", alignItems: "center", gap: "12px" }}
                >
                  <input
                    type="checkbox"
                    id="isGraded"
                    checked={editIsGraded}
                    onChange={(e) => {
                      setEditIsGraded(e.target.checked);
                      if (!e.target.checked) {
                        setEditGrade("");
                        setEditGradingService("raw");
                      }
                    }}
                    style={{ width: "18px", height: "18px" }}
                  />
                  <label
                    htmlFor="isGraded"
                    style={{
                      color: "white",
                      fontSize: "14px",
                      fontWeight: "500",
                    }}
                  >
                    This card is graded
                  </label>
                </div>

                {/* Grade and Grading Service (only show if graded) */}
                {editIsGraded && (
                  <div
                    style={{
                      display: "grid",
                      gridTemplateColumns: "1fr 1fr",
                      gap: "12px",
                    }}
                  >
                    <div>
                      <label
                        style={{
                          color: "white",
                          fontSize: "14px",
                          fontWeight: "500",
                          marginBottom: "8px",
                          display: "block",
                        }}
                      >
                        Grade
                      </label>
                      <input
                        type="text"
                        value={editGrade}
                        onChange={(e) => setEditGrade(e.target.value)}
                        placeholder="e.g., 10, 9.5"
                        style={{
                          width: "100%",
                          padding: "12px",
                          backgroundColor: "#444",
                          border: "1px solid #666",
                          borderRadius: "8px",
                          color: "white",
                          fontSize: "14px",
                        }}
                      />
                    </div>
                    <div>
                      <label
                        style={{
                          color: "white",
                          fontSize: "14px",
                          fontWeight: "500",
                          marginBottom: "8px",
                          display: "block",
                        }}
                      >
                        Grading Service
                      </label>
                      <select
                        value={editGradingService}
                        onChange={(e) => setEditGradingService(e.target.value)}
                        style={{
                          width: "100%",
                          padding: "12px",
                          backgroundColor: "#444",
                          border: "1px solid #666",
                          borderRadius: "8px",
                          color: "white",
                          fontSize: "14px",
                        }}
                      >
                        <option value="PSA">PSA</option>
                        <option value="BGS">BGS</option>
                        <option value="CGC">CGC</option>
                        <option value="SGC">SGC</option>
                      </select>
                    </div>
                  </div>
                )}

                {/* Price Paid */}
                <div>
                  <label
                    style={{
                      color: "white",
                      fontSize: "14px",
                      fontWeight: "500",
                      marginBottom: "8px",
                      display: "block",
                    }}
                  >
                    Price Paid (optional)
                  </label>
                  <input
                    type="number"
                    step="0.01"
                    min="0"
                    value={editPricePaid}
                    onChange={(e) => setEditPricePaid(e.target.value)}
                    placeholder="0.00"
                    style={{
                      width: "100%",
                      padding: "12px",
                      backgroundColor: "#444",
                      border: "1px solid #666",
                      borderRadius: "8px",
                      color: "white",
                      fontSize: "14px",
                    }}
                  />
                </div>

                {/* Notes */}
                <div>
                  <label
                    style={{
                      color: "white",
                      fontSize: "14px",
                      fontWeight: "500",
                      marginBottom: "8px",
                      display: "block",
                    }}
                  >
                    Notes (optional)
                  </label>
                  <textarea
                    value={editNotes}
                    onChange={(e) => setEditNotes(e.target.value)}
                    placeholder="Add any notes about this card..."
                    rows="3"
                    style={{
                      width: "100%",
                      padding: "12px",
                      backgroundColor: "#444",
                      border: "1px solid #666",
                      borderRadius: "8px",
                      color: "white",
                      fontSize: "14px",
                      resize: "vertical",
                      fontFamily: "inherit",
                    }}
                  />
                </div>
              </div>

              {/* Action Buttons */}
              <div style={{ display: "flex", gap: "12px", marginTop: "24px" }}>
                <button
                  onClick={() => setShowEditCardModal(false)}
                  style={{
                    flex: 1,
                    padding: "12px",
                    backgroundColor: "#444",
                    border: "none",
                    borderRadius: "8px",
                    color: "white",
                    cursor: "pointer",
                    fontSize: "14px",
                    fontWeight: "500",
                  }}
                >
                  Cancel
                </button>
                <button
                  onClick={handleSaveEdit}
                  style={{
                    flex: 1,
                    padding: "12px",
                    backgroundColor: "#6865E7",
                    border: "none",
                    borderRadius: "8px",
                    color: "white",
                    cursor: "pointer",
                    fontSize: "14px",
                    fontWeight: "500",
                  }}
                >
                  Save Changes
                </button>
              </div>
            </div>
          </div>
        )}
        {/* Edit Card Modal - REMOVED */}
        {false && (
          <div
            className="fixed inset-0 bg-black/50 backdrop-blur-sm z-[110] flex items-center justify-center p-4"
            onClick={() => setShowEditCardModal(false)}
          >
            <div
              className="bg-gray-800 rounded-xl p-6 mx-4 max-w-md w-full edit-card-modal"
              onClick={(e) => e.stopPropagation()}
            >
              <div className="text-center mb-6">
                <h3 className="text-white text-lg font-semibold mb-2">
                  Edit Card
                </h3>
                <p className="text-gray-400 text-sm">
                  {editingCard.name} - {editingCard.set}
                </p>
              </div>

              <div className="space-y-4 mb-6">
                {/* Quantity */}
                <div>
                  <label className="block text-white text-sm font-medium mb-2">
                    Quantity
                  </label>
                  <input
                    type="number"
                    min="1"
                    value={editQuantity}
                    onChange={(e) =>
                      setEditQuantity(parseInt(e.target.value) || 1)
                    }
                    className="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-[#8871FF]"
                  />
                </div>

                {/* Condition */}
                <div className="relative">
                  <label className="block text-white text-sm font-medium mb-2">
                    Condition
                  </label>
                  <button
                    onClick={() =>
                      setShowEditConditionDropdown(!showEditConditionDropdown)
                    }
                    className="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white text-left focus:outline-none focus:ring-2 focus:ring-[#8871FF] flex items-center justify-between"
                  >
                    <span>{editCondition}</span>
                    <svg
                      className="w-4 h-4"
                      fill="none"
                      stroke="currentColor"
                      viewBox="0 0 24 24"
                    >
                      <path
                        strokeLinecap="round"
                        strokeLinejoin="round"
                        strokeWidth="2"
                        d="M19 9l-7 7-7-7"
                      />
                    </svg>
                  </button>
                  {showEditConditionDropdown && (
                    <div className="absolute top-full left-0 right-0 mt-1 bg-gray-700 border border-gray-600 rounded-lg shadow-lg z-50">
                      {[
                        "Near Mint",
                        "Lightly Played",
                        "Moderately Played",
                        "Heavily Played",
                        "Damaged",
                      ].map((condition) => (
                        <button
                          key={condition}
                          onClick={() => {
                            setEditCondition(condition);
                            setShowEditConditionDropdown(false);
                          }}
                          className="w-full px-3 py-2 text-white hover:bg-gray-600 text-left first:rounded-t-lg last:rounded-b-lg"
                        >
                          {condition}
                        </button>
                      ))}
                    </div>
                  )}
                </div>

                {/* Variant */}
                <div className="relative">
                  <label className="block text-white text-sm font-medium mb-2">
                    Variant
                  </label>
                  <button
                    onClick={() =>
                      setShowEditVariantDropdown(!showEditVariantDropdown)
                    }
                    className="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white text-left focus:outline-none focus:ring-2 focus:ring-[#8871FF] flex items-center justify-between"
                  >
                    <span>{editVariant}</span>
                    <svg
                      className="w-4 h-4"
                      fill="none"
                      stroke="currentColor"
                      viewBox="0 0 24 24"
                    >
                      <path
                        strokeLinecap="round"
                        strokeLinejoin="round"
                        strokeWidth="2"
                        d="M19 9l-7 7-7-7"
                      />
                    </svg>
                  </button>
                  {showEditVariantDropdown && (
                    <div className="absolute top-full left-0 right-0 mt-1 bg-gray-700 border border-gray-600 rounded-lg shadow-lg z-50 min-w-[180px]">
                      {["Normal", "Holo", "Reverse Holo", "Foil"].map(
                        (variant) => (
                          <button
                            key={variant}
                            onClick={() => {
                              setEditVariant(variant);
                              setShowEditVariantDropdown(false);
                            }}
                            className="w-full px-4 py-3 text-white hover:bg-gray-600 text-left first:rounded-t-lg last:rounded-b-lg"
                          >
                            {variant}
                          </button>
                        )
                      )}
                    </div>
                  )}
                </div>

                {/* Grading Toggle */}
                <div>
                  <label className="flex items-center gap-2">
                    <input
                      type="checkbox"
                      checked={editIsGraded}
                      onChange={(e) => setEditIsGraded(e.target.checked)}
                      className="w-4 h-4 text-[#8871FF] bg-gray-700 border-gray-600 rounded focus:ring-[#8871FF]"
                    />
                    <span className="dark:text-white text-theme-primary text-sm font-medium">
                      This card is graded
                    </span>
                  </label>
                </div>

                {/* Grade and Grading Service - only show if graded */}
                {editIsGraded && (
                  <>
                    <div className="relative">
                      <label className="block text-white text-sm font-medium mb-2">
                        Grade
                      </label>
                      <button
                        onClick={() =>
                          setShowEditGradeDropdown(!showEditGradeDropdown)
                        }
                        className="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white text-left focus:outline-none focus:ring-2 focus:ring-[#8871FF] flex items-center justify-between"
                      >
                        <span>{editGrade || "Select Grade"}</span>
                        <svg
                          className="w-4 h-4"
                          fill="none"
                          stroke="currentColor"
                          viewBox="0 0 24 24"
                        >
                          <path
                            strokeLinecap="round"
                            strokeLinejoin="round"
                            strokeWidth="2"
                            d="M19 9l-7 7-7-7"
                          />
                        </svg>
                      </button>
                      {showEditGradeDropdown && (
                        <div className="absolute top-full left-0 right-0 mt-1 bg-gray-700 border border-gray-600 rounded-lg shadow-lg z-50">
                          {[
                            "10",
                            "9.5",
                            "9",
                            "8.5",
                            "8",
                            "7.5",
                            "7",
                            "6.5",
                            "6",
                            "5.5",
                            "5",
                            "4.5",
                            "4",
                            "3.5",
                            "3",
                            "2.5",
                            "2",
                            "1.5",
                            "1",
                            "0.5",
                          ].map((grade) => (
                            <button
                              key={grade}
                              onClick={() => {
                                setEditGrade(grade);
                                setShowEditGradeDropdown(false);
                              }}
                              className="w-full px-3 py-2 text-white hover:bg-gray-600 text-left first:rounded-t-lg last:rounded-b-lg"
                            >
                              {grade}
                            </button>
                          ))}
                        </div>
                      )}
                    </div>

                    <div className="relative">
                      <label className="block text-white text-sm font-medium mb-2">
                        Grading Service
                      </label>
                      <button
                        onClick={() =>
                          setShowEditGradingServiceDropdown(
                            !showEditGradingServiceDropdown
                          )
                        }
                        className="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white text-left focus:outline-none focus:ring-2 focus:ring-[#8871FF] flex items-center justify-between"
                      >
                        <span>
                          {editGradingService === "raw"
                            ? "Raw"
                            : editGradingService}
                        </span>
                        <svg
                          className="w-4 h-4"
                          fill="none"
                          stroke="currentColor"
                          viewBox="0 0 24 24"
                        >
                          <path
                            strokeLinecap="round"
                            strokeLinejoin="round"
                            strokeWidth="2"
                            d="M19 9l-7 7-7-7"
                          />
                        </svg>
                      </button>
                      {showEditGradingServiceDropdown && (
                        <div className="absolute top-full left-0 right-0 mt-1 bg-gray-700 border border-gray-600 rounded-lg shadow-lg z-50">
                          {["raw", "PSA", "BGS", "CGC", "SGC"].map(
                            (service) => (
                              <button
                                key={service}
                                onClick={() => {
                                  setEditGradingService(service);
                                  setShowEditGradingServiceDropdown(false);
                                }}
                                className="w-full px-3 py-2 text-white hover:bg-gray-600 text-left first:rounded-t-lg last:rounded-b-lg"
                              >
                                {service === "raw" ? "Raw" : service}
                              </button>
                            )
                          )}
                        </div>
                      )}
                    </div>
                  </>
                )}

                {/* Price Paid */}
                <div>
                  <label className="block text-white text-sm font-medium mb-2">
                    Price Paid ($)
                  </label>
                  <input
                    type="number"
                    step="0.01"
                    min="0"
                    value={editPricePaid}
                    onChange={(e) => setEditPricePaid(e.target.value)}
                    placeholder="0.00"
                    className="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-[#8871FF]"
                  />
                </div>

                {/* Notes */}
                <div>
                  <label className="block text-white text-sm font-medium mb-2">
                    Notes
                  </label>
                  <textarea
                    value={editNotes}
                    onChange={(e) => setEditNotes(e.target.value)}
                    placeholder="Add any notes about this card..."
                    rows="3"
                    className="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-[#8871FF] resize-none"
                  />
                </div>
              </div>

              <div className="flex gap-3">
                <button
                  className="flex-1 px-4 py-2 bg-gray-600 hover:bg-gray-500 text-white rounded-lg transition-colors"
                  onClick={() => {
                    setShowEditCardModal(false);
                    setEditingCard(null);
                    setEditQuantity(1);
                    setEditCondition("Near Mint");
                    setEditVariant("Normal");
                    setEditGrade("");
                    setEditGradingService("raw");
                    setEditPricePaid("");
                    setEditNotes("");
                    setEditIsGraded(false);
                    setShowEditConditionDropdown(false);
                    setShowEditVariantDropdown(false);
                    setShowEditGradeDropdown(false);
                    setShowEditGradingServiceDropdown(false);
                  }}
                >
                  Cancel
                </button>
                <button
                  className="flex-1 px-4 py-2 bg-[#8871FF] hover:bg-[#7A5FFF] text-white rounded-lg transition-colors"
                  onClick={handleSaveEdit}
                >
                  Save Changes
                </button>
              </div>
            </div>
          </div>
        )}
        {/* Add to Collection Modal - Card Profile */}
        {showCardProfileModal &&
          cardToAddFromProfile &&
          showCardProfile &&
          createPortal(
            <div
              className="fixed left-0 right-0 top-0 bottom-0 z-[100500] backdrop-blur-sm flex items-end justify-center p-0.5 sm:p-4 overflow-y-auto"
              style={{ top: "0px", bottom: "0px" }}
            >
              <div className="bg-gray-800 rounded-2xl w-full max-w-md mx-auto relative z-[100501] modal-container max-h-[82vh] sm:max-h-[80vh] flex flex-col shadow-2xl border border-gray-600 pointer-events-auto">
                <div className="p-4 sm:p-6 overflow-y-auto flex-1">
                  {/* Header */}
                  <div className="flex items-center justify-between mb-4 sm:mb-6">
                    <h2 className="dark:text-white text-theme-primary text-xl font-semibold">
                      Add to Collection
                    </h2>
                    <button
                      onClick={() => {
                        setShowCardProfileModal(false);
                        setCardToAddFromProfile(null);
                      }}
                      className="w-8 h-8 bg-gray-600 rounded-full flex items-center justify-center text-white hover:bg-gray-500 transition-colors"
                    >
                      <svg
                        className="w-4 h-4"
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                      >
                        <path
                          strokeLinecap="round"
                          strokeLinejoin="round"
                          strokeWidth={2}
                          d="M6 18L18 6M6 6l12 12"
                        />
                      </svg>
                    </button>
                  </div>

                  {/* Card Preview */}
                  {cardToAddFromProfile && (
                    <div className="mb-6 p-4 bg-gray-700 rounded-xl">
                      <div className="flex gap-4 items-center">
                        <img
                          src={getCardImageUrl(cardToAddFromProfile)}
                          alt={cardToAddFromProfile.name}
                          className="w-20 h-28 object-cover rounded-lg"
                        />
                        <div className="flex-1">
                          <h3 className="text-white text-base font-bold mb-2">
                            {cardToAddFromProfile.name}
                          </h3>
                          <p className="text-gray-300 text-sm mb-1">
                            {cardToAddFromProfile.set_name ||
                              cardToAddFromProfile.set?.name ||
                              cardToAddFromProfile.set ||
                              "Set Name"}
                          </p>
                          <p className="text-gray-400 text-xs mb-2">
                            #
                            {cardToAddFromProfile.number
                              ? cardToAddFromProfile.number.replace("#", "")
                              : "001"}
                          </p>
                          <div className="flex justify-between items-center">
                            <span className="text-gray-300 text-xs">
                              Est. Value:
                            </span>
                            <span className="text-primary text-base font-bold">
                              $
                              {calculateDynamicPrice(
                                cardToAddFromProfile,
                                selectedVariant,
                                addCardCondition,
                                isGraded,
                                selectedGradingService,
                                selectedGrade
                              ).toFixed(2)}
                            </span>
                          </div>
                        </div>
                      </div>
                    </div>
                  )}

                  {/* Collection Selection */}
                  <div className="mb-5">
                    <label className="block text-gray-300 text-sm font-medium mb-2">
                      Collection
                    </label>
                    <div className="relative dropdown-container">
                      <button
                        onClick={() =>
                          setShowCollectionDropdown(!showCollectionDropdown)
                        }
                        className="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-3 text-white text-left flex items-center justify-between focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent"
                      >
                        <span>
                          {selectedCollectionForAdd
                            ? userData?.collections.find(
                                (c) => c.id === selectedCollectionForAdd
                              )?.name
                            : "Select Collection"}
                        </span>
                        <svg
                          className={`w-4 h-4 transition-transform ${
                            showCollectionDropdown ? "rotate-180" : ""
                          }`}
                          fill="none"
                          stroke="currentColor"
                          viewBox="0 0 24 24"
                        >
                          <path
                            strokeLinecap="round"
                            strokeLinejoin="round"
                            strokeWidth={2}
                            d="M19 9l-7 7-7-7"
                          />
                        </svg>
                      </button>
                      {showCollectionDropdown && (
                        <div className="absolute z-50 w-full mt-1 bg-gray-700 border border-gray-600 rounded-lg shadow-lg">
                          <div className="py-1">
                            {userData?.collections.map((collection) => (
                              <button
                                key={collection.id}
                                onClick={() => {
                                  setSelectedCollectionForAdd(collection.id);
                                  setShowCollectionDropdown(false);
                                }}
                                className="w-full px-4 py-2 text-left text-white hover:bg-gray-600 transition-colors"
                              >
                                {collection.name}
                              </button>
                            ))}
                          </div>
                        </div>
                      )}
                    </div>
                  </div>

                  {/* Quantity Selection */}
                  <div className="mb-5">
                    <label className="block text-gray-300 text-sm font-medium mb-2">
                      Quantity
                    </label>
                    <div className="flex items-center gap-3">
                      <button
                        onClick={() =>
                          setAddQuantity(Math.max(1, addQuantity - 1))
                        }
                        className="w-10 h-10 bg-gray-700 border border-gray-600 rounded-lg flex items-center justify-center text-white hover:bg-gray-600 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                        disabled={addQuantity <= 1}
                      >
                        <svg
                          className="w-4 h-4"
                          fill="none"
                          stroke="currentColor"
                          viewBox="0 0 24 24"
                        >
                          <path
                            strokeLinecap="round"
                            strokeLinejoin="round"
                            strokeWidth={2}
                            d="M20 12H4"
                          />
                        </svg>
                      </button>
                      <div className="flex-1 bg-gray-700 border border-gray-600 rounded-lg px-4 py-3 text-center">
                        <span className="text-white text-lg font-medium">
                          {addQuantity}
                        </span>
                      </div>
                      <button
                        onClick={() => setAddQuantity(addQuantity + 1)}
                        className="w-10 h-10 bg-gray-700 border border-gray-600 rounded-lg flex items-center justify-center text-white hover:bg-gray-600 transition-colors"
                      >
                        <svg
                          className="w-4 h-4"
                          fill="none"
                          stroke="currentColor"
                          viewBox="0 0 24 24"
                        >
                          <path
                            strokeLinecap="round"
                            strokeLinejoin="round"
                            strokeWidth={2}
                            d="M12 6v6m0 0v6m0-6h6m-6 0H6"
                          />
                        </svg>
                      </button>
                    </div>
                  </div>

                  {/* Variant Selection */}
                  <div className="mb-5">
                    <label className="block text-gray-300 text-sm font-medium mb-2">
                      Variant
                    </label>
                    <div className="relative dropdown-container">
                      <button
                        onClick={() =>
                          setShowVariantDropdown(!showVariantDropdown)
                        }
                        className="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-3 text-white text-left flex items-center justify-between focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent"
                      >
                        <span>{selectedVariant}</span>
                        <svg
                          className={`w-4 h-4 transition-transform ${
                            showVariantDropdown ? "rotate-180" : ""
                          }`}
                          fill="none"
                          stroke="currentColor"
                          viewBox="0 0 24 24"
                        >
                          <path
                            strokeLinecap="round"
                            strokeLinejoin="round"
                            strokeWidth={2}
                            d="M19 9l-7 7-7-7"
                          />
                        </svg>
                      </button>
                      {showVariantDropdown && (
                        <div className="absolute z-50 w-full mt-1 bg-gray-700 border border-gray-600 rounded-lg shadow-lg min-w-[180px]">
                          <div className="py-1">
                            {(() => {
                              const availableVariants = [];

                              if (cardToAddFromProfile?.variant_normal) {
                                availableVariants.push("Normal");
                              }
                              if (cardToAddFromProfile?.variant_holo) {
                                availableVariants.push("Holo");
                              }
                              if (cardToAddFromProfile?.variant_reverse) {
                                availableVariants.push("Reverse Holo");
                              }
                              if (cardToAddFromProfile?.variant_first_edition) {
                                availableVariants.push("1st Edition");
                              }

                              // Fallback: if no boolean variants are set, check the variants array
                              if (
                                availableVariants.length === 0 &&
                                cardToAddFromProfile?.variants
                              ) {
                                let variantsArray =
                                  cardToAddFromProfile.variants;

                                // Parse variants if it's a string
                                if (typeof variantsArray === "string") {
                                  try {
                                    variantsArray = JSON.parse(variantsArray);
                                  } catch (e) {
                                    console.warn(
                                      "Failed to parse variants string:",
                                      variantsArray
                                    );
                                    variantsArray = [];
                                  }
                                }

                                // Ensure it's an array
                                if (!Array.isArray(variantsArray)) {
                                  variantsArray = [];
                                }

                                const variantMap = {
                                  Normal: "Normal",
                                  Holo: "Holo",
                                  "Reverse Holo": "Reverse Holo",
                                  "1st Edition": "1st Edition",
                                };

                                variantsArray.forEach((variant) => {
                                  const mappedVariant = variantMap[variant];
                                  if (
                                    mappedVariant &&
                                    !availableVariants.includes(mappedVariant)
                                  ) {
                                    availableVariants.push(mappedVariant);
                                  }
                                });
                              }

                              // Final fallback: if still no variants, default to Normal
                              if (availableVariants.length === 0) {
                                availableVariants.push("Normal");
                              }

                              return availableVariants.map((variant) => (
                                <button
                                  key={variant}
                                  onClick={() => {
                                    setSelectedVariant(variant);
                                    setShowVariantDropdown(false);
                                  }}
                                  className="w-full px-4 py-3 text-left text-white hover:bg-gray-600 transition-colors"
                                >
                                  {variant}
                                </button>
                              ));
                            })()}
                          </div>
                        </div>
                      )}
                    </div>
                  </div>

                  {/* Condition Selection */}
                  <div className="mb-5">
                    <label className="block text-gray-300 text-sm font-medium mb-2">
                      Condition
                    </label>
                    <div className="relative dropdown-container">
                      <button
                        onClick={() =>
                          setShowConditionDropdown(!showConditionDropdown)
                        }
                        className="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-3 text-white text-left flex items-center justify-between focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent"
                      >
                        <span>{addCardCondition}</span>
                        <svg
                          className={`w-4 h-4 transition-transform ${
                            showConditionDropdown ? "rotate-180" : ""
                          }`}
                          fill="none"
                          stroke="currentColor"
                          viewBox="0 0 24 24"
                        >
                          <path
                            strokeLinecap="round"
                            strokeLinejoin="round"
                            strokeWidth={2}
                            d="M19 9l-7 7-7-7"
                          />
                        </svg>
                      </button>
                      {showConditionDropdown && (
                        <div className="absolute z-50 w-full mt-1 bg-gray-700 border border-gray-600 rounded-lg shadow-lg">
                          <div className="py-1">
                            {[
                              "Near Mint",
                              "Lightly Played",
                              "Moderately Played",
                              "Heavily Played",
                              "Damaged",
                            ].map((condition) => (
                              <button
                                key={condition}
                                onClick={() => {
                                  setAddCardCondition(condition);
                                  setShowConditionDropdown(false);
                                }}
                                className="w-full px-4 py-2 text-left text-white hover:bg-gray-600 transition-colors"
                              >
                                {condition}
                              </button>
                            ))}
                          </div>
                        </div>
                      )}
                    </div>
                  </div>

                  {/* Graded Card Toggle */}
                  <div className="mb-5">
                    <label className="flex items-center gap-3 text-gray-300 text-sm cursor-pointer">
                      <input
                        type="checkbox"
                        checked={isGraded}
                        onChange={(e) => setIsGraded(e.target.checked)}
                        className="w-4 h-4 text-primary bg-gray-700 border-gray-600 rounded focus:ring-primary focus:ring-2"
                      />
                      <span>This is a graded card</span>
                    </label>
                  </div>

                  {/* Grading Service Selection - Only show if graded */}
                  {isGraded && (
                    <div className="mb-5">
                      <label className="block text-gray-300 text-sm font-medium mb-2">
                        Grading Service
                      </label>
                      <div className="relative dropdown-container">
                        <button
                          onClick={() =>
                            setShowGradingServiceDropdown(
                              !showGradingServiceDropdown
                            )
                          }
                          className="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-3 text-white text-left flex items-center justify-between focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent"
                        >
                          <span>{selectedGradingService}</span>
                          <svg
                            className={`w-4 h-4 transition-transform ${
                              showGradingServiceDropdown ? "rotate-180" : ""
                            }`}
                            fill="none"
                            stroke="currentColor"
                            viewBox="0 0 24 24"
                          >
                            <path
                              strokeLinecap="round"
                              strokeLinejoin="round"
                              strokeWidth={2}
                              d="M19 9l-7 7-7-7"
                            />
                          </svg>
                        </button>
                        {showGradingServiceDropdown && (
                          <div className="absolute z-50 w-full mt-1 bg-gray-700 border border-gray-600 rounded-lg shadow-lg">
                            <div className="py-1">
                              {["PSA", "CGC", "TAG", "BGS", "ACE"].map(
                                (service) => (
                                  <button
                                    key={service}
                                    onClick={() => {
                                      setSelectedGradingService(service);
                                      setShowGradingServiceDropdown(false);
                                    }}
                                    className="w-full px-4 py-2 text-left text-white hover:bg-gray-600 transition-colors"
                                  >
                                    {service}
                                  </button>
                                )
                              )}
                            </div>
                          </div>
                        )}
                      </div>
                    </div>
                  )}

                  {/* Grade Selection - Only show if graded */}
                  {isGraded && (
                    <div className="mb-5">
                      <label className="block text-gray-300 text-sm font-medium mb-2">
                        Grade
                      </label>
                      <div className="relative dropdown-container">
                        <button
                          onClick={() =>
                            setShowGradeDropdown(!showGradeDropdown)
                          }
                          className="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-3 text-white text-left flex items-center justify-between focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent"
                        >
                          <span>{selectedGrade}</span>
                          <svg
                            className={`w-4 h-4 transition-transform ${
                              showGradeDropdown ? "rotate-180" : ""
                            }`}
                            fill="none"
                            stroke="currentColor"
                            viewBox="0 0 24 24"
                          >
                            <path
                              strokeLinecap="round"
                              strokeLinejoin="round"
                              strokeWidth={2}
                              d="M19 9l-7 7-7-7"
                            />
                          </svg>
                        </button>
                        {showGradeDropdown && (
                          <div className="absolute z-50 w-full mt-1 bg-gray-700 border border-gray-600 rounded-lg shadow-lg max-h-48 overflow-y-auto">
                            <div className="py-1">
                              {selectedGradingService === "PSA" &&
                                [
                                  "1",
                                  "2",
                                  "3",
                                  "4",
                                  "5",
                                  "6",
                                  "7",
                                  "8",
                                  "9",
                                  "10",
                                ].map((grade) => (
                                  <button
                                    key={grade}
                                    onClick={() => {
                                      setSelectedGrade(grade);
                                      setShowGradeDropdown(false);
                                    }}
                                    className="w-full px-4 py-2 text-left text-white hover:bg-gray-600 transition-colors"
                                  >
                                    {grade}
                                  </button>
                                ))}
                              {selectedGradingService === "CGC" &&
                                [
                                  "1",
                                  "2",
                                  "3",
                                  "4",
                                  "5",
                                  "6",
                                  "7",
                                  "8",
                                  "9",
                                  "10",
                                ].map((grade) => (
                                  <button
                                    key={grade}
                                    onClick={() => {
                                      setSelectedGrade(grade);
                                      setShowGradeDropdown(false);
                                    }}
                                    className="w-full px-4 py-2 text-left text-white hover:bg-gray-600 transition-colors"
                                  >
                                    {grade}
                                  </button>
                                ))}
                              {selectedGradingService === "TAG" &&
                                [
                                  "1",
                                  "2",
                                  "3",
                                  "4",
                                  "5",
                                  "6",
                                  "7",
                                  "8",
                                  "9",
                                  "10",
                                ].map((grade) => (
                                  <button
                                    key={grade}
                                    onClick={() => {
                                      setSelectedGrade(grade);
                                      setShowGradeDropdown(false);
                                    }}
                                    className="w-full px-4 py-2 text-left text-white hover:bg-gray-600 transition-colors"
                                  >
                                    {grade}
                                  </button>
                                ))}
                              {selectedGradingService === "BGS" &&
                                [
                                  "1",
                                  "1.5",
                                  "2",
                                  "2.5",
                                  "3",
                                  "3.5",
                                  "4",
                                  "4.5",
                                  "5",
                                  "5.5",
                                  "6",
                                  "6.5",
                                  "7",
                                  "7.5",
                                  "8",
                                  "8.5",
                                  "9",
                                  "9.5",
                                  "10",
                                ].map((grade) => (
                                  <button
                                    key={grade}
                                    onClick={() => {
                                      setSelectedGrade(grade);
                                      setShowGradeDropdown(false);
                                    }}
                                    className="w-full px-4 py-2 text-left text-white hover:bg-gray-600 transition-colors"
                                  >
                                    {grade}
                                  </button>
                                ))}
                              {selectedGradingService === "ACE" &&
                                [
                                  "1",
                                  "2",
                                  "3",
                                  "4",
                                  "5",
                                  "6",
                                  "7",
                                  "8",
                                  "9",
                                  "10",
                                ].map((grade) => (
                                  <button
                                    key={grade}
                                    onClick={() => {
                                      setSelectedGrade(grade);
                                      setShowGradeDropdown(false);
                                    }}
                                    className="w-full px-4 py-2 text-left text-white hover:bg-gray-600 transition-colors"
                                  >
                                    {grade}
                                  </button>
                                ))}
                            </div>
                          </div>
                        )}
                      </div>
                    </div>
                  )}

                  {/* Notes */}
                  <div className="mb-6">
                    <label className="block text-gray-300 text-sm font-medium mb-2">
                      Notes (Optional)
                    </label>
                    <textarea
                      value={addNote}
                      onChange={(e) => setAddNote(e.target.value)}
                      placeholder="Add any notes about this card..."
                      className="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-3 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent resize-none h-20"
                    />
                  </div>
                </div>

                {/* Action Buttons - Fixed at bottom */}
                <div className="p-6 pt-4 border-t border-gray-700">
                  <div className="flex gap-3">
                    <button
                      onClick={() => {
                        setShowCardProfileModal(false);
                        setCardToAddFromProfile(null);
                      }}
                      className="flex-1 bg-gray-600 hover:bg-gray-500 text-white py-3 px-4 rounded-lg font-medium transition-colors"
                    >
                      Cancel
                    </button>
                    <button
                      onClick={handleConfirmAddToCollection}
                      className="flex-1 bg-primary hover:bg-primary/80 text-white py-3 px-4 rounded-lg font-medium transition-colors"
                    >
                      Add to Collection
                    </button>
                  </div>
                </div>
              </div>
            </div>,
            document.body
          )}
      </div>
    );
  }

  // Login Screen
  if (currentScreen === "login") {
    return (
      <div className="min-h-screen bg-theme-primary relative overflow-hidden">
        {/* Background with card pattern overlay */}
        <div className="absolute inset-0 dark:bg-gradient-to-br dark:from-primary/20 dark:via-secondary/10 dark:to-primary/30 bg-gradient-to-br from-primary/5 via-secondary/3 to-primary/8">
          {/* Card pattern background */}
          <div className="absolute inset-0 dark:opacity-30 opacity-10">
            <div className="absolute top-10 left-10 w-32 h-44 bg-gradient-to-br from-primary/40 to-secondary/40 rounded-lg transform rotate-12"></div>
            <div className="absolute top-20 right-16 w-28 h-40 bg-gradient-to-br from-secondary/40 to-primary/40 rounded-lg transform -rotate-6"></div>
            <div className="absolute bottom-20 left-20 w-36 h-48 bg-gradient-to-br from-accent/20 to-primary/40 rounded-lg transform rotate-6"></div>
            <div className="absolute bottom-32 right-20 w-30 h-42 bg-gradient-to-br from-primary/40 to-accent/20 rounded-lg transform -rotate-12"></div>
          </div>

          {/* Theme-aware overlay */}
          <div className="absolute inset-0 bg-theme-primary/80 dark:bg-background/80"></div>
        </div>

        {/* Main content */}
        <div className="relative z-10 flex flex-col items-center justify-center min-h-screen px-4">
          {/* Logo */}
          <div className="mb-8">
            <div className="flex items-center justify-center">
              <img
                src="/Assets/CardStax_logo_light.svg"
                alt="CardStax"
                className="h-16 w-auto"
              />
            </div>
          </div>

          {/* Login Form */}
          <div className="w-full max-w-sm dark:bg-gray-800/50 bg-[#fafafa]/90 backdrop-blur-sm rounded-2xl p-6 dark:border-gray-700 border-[#d2d3db] border">
            <h2
              className="text-2xl font-bold text-center mb-6"
              style={{ color: "#6865E7" }}
            >
              Welcome Back
            </h2>

            <form className="space-y-4">
              {/* Email Input */}
              <div>
                <label
                  htmlFor="login-email"
                  className="block text-sm font-medium mb-2 dark:text-gray-400 text-gray-700"
                >
                  Email
                </label>
                <input
                  id="login-email"
                  type="email"
                  value={email}
                  onChange={(e) => setEmail(e.target.value)}
                  className="w-full px-4 py-3 dark:bg-gray-700 bg-gray-50 border dark:border-gray-600 border-gray-300 rounded-xl dark:text-white text-theme-primary placeholder-gray-500 dark:placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-[#6865E7] focus:border-transparent transition-all"
                  placeholder="Enter your email"
                  aria-label="Email address"
                  aria-required="true"
                />
              </div>

              {/* Password Input */}
              <div>
                <label
                  htmlFor="login-password"
                  className="block text-sm font-medium mb-2 dark:text-gray-400 text-gray-700"
                >
                  Password
                </label>
                <div className="relative">
                  <input
                    id="login-password"
                    type={showPassword ? "text" : "password"}
                    value={newPassword}
                    onChange={(e) => setNewPassword(e.target.value)}
                    className="w-full px-4 py-3 dark:bg-gray-700 bg-gray-50 border dark:border-gray-600 border-gray-300 rounded-xl dark:text-white text-theme-primary placeholder-gray-500 dark:placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-[#6865E7] focus:border-transparent pr-12 transition-all"
                    placeholder="Enter your password"
                    aria-label="Password"
                    aria-required="true"
                  />
                  <button
                    type="button"
                    onClick={() => setShowPassword(!showPassword)}
                    className="absolute right-3 top-1/2 transform -translate-y-1/2 dark:text-gray-400 text-gray-600 hover:dark:text-white hover:text-gray-900 focus:outline-none focus:ring-2 focus:ring-[#6865E7] rounded p-1 transition-colors"
                    aria-label={
                      showPassword ? "Hide password" : "Show password"
                    }
                  >
                    {showPassword ? (
                      <svg
                        className="w-5 h-5"
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                      >
                        <path
                          strokeLinecap="round"
                          strokeLinejoin="round"
                          strokeWidth="2"
                          d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.878 9.878L3 3m6.878 6.878L21 21"
                        />
                      </svg>
                    ) : (
                      <svg
                        className="w-5 h-5"
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                      >
                        <path
                          strokeLinecap="round"
                          strokeLinejoin="round"
                          strokeWidth="2"
                          d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"
                        />
                        <path
                          strokeLinecap="round"
                          strokeLinejoin="round"
                          strokeWidth="2"
                          d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"
                        />
                      </svg>
                    )}
                  </button>
                </div>
              </div>

              {/* Forgot Password Link */}
              <div className="text-right">
                <button
                  type="button"
                  onClick={() => setCurrentScreen("forgot-password")}
                  className="text-sm text-[#6865E7] hover:text-[#6865E7]/80 transition-colors focus:outline-none focus:ring-2 focus:ring-[#6865E7] rounded px-1"
                  aria-label="Forgot password link"
                >
                  Forgot Password?
                </button>
              </div>

              {/* Divider */}
              <div className="relative py-4">
                <div className="absolute inset-0 flex items-center">
                  <div className="w-full border-t dark:border-gray-600 border-gray-300"></div>
                </div>
                <div className="relative flex justify-center text-sm">
                  <span className="px-2 dark:bg-gray-800/50 bg-[#fafafa]/90 dark:text-gray-400 text-gray-700">
                    Or continue with
                  </span>
                </div>
              </div>

              {/* Google OAuth Button */}
              <button
                type="button"
                onClick={handleGoogleAuth}
                className="w-full flex items-center justify-center gap-3 bg-white dark:bg-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600 text-gray-900 dark:text-white font-medium py-3 px-6 rounded-xl transition-all duration-200 border dark:border-gray-600 border-gray-300 shadow-sm focus:outline-none focus:ring-2 focus:ring-[#6865E7] focus:ring-offset-2"
                aria-label="Log in with Google"
              >
                <svg className="w-5 h-5" viewBox="0 0 24 24">
                  <path
                    fill="#4285F4"
                    d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"
                  />
                  <path
                    fill="#34A853"
                    d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"
                  />
                  <path
                    fill="#FBBC05"
                    d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"
                  />
                  <path
                    fill="#EA4335"
                    d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"
                  />
                </svg>
                <span>Log in with Google</span>
              </button>

              {/* Login Button */}
              <button
                type="button"
                onClick={async () => {
                  // For now, skip authentication and go straight to app (guest mode)
                  // This allows the app to work without forcing login
                  setGuestMode(true); // Enable guest mode
                  setCurrentScreen("main-app");

                  // TODO: Uncomment when you want to require login
                  // const result = await login(email, newPassword)
                  // if (result.success) {
                  //   setCurrentScreen('main-app')
                  // } else {
                  //   alert(result.error || 'Login failed')
                  // }
                }}
                className="w-full bg-[#6865E7] hover:bg-[#6865E7]/90 text-white font-semibold py-3 px-6 rounded-xl transition-all duration-200 transform hover:scale-105 shadow-lg focus:outline-none focus:ring-2 focus:ring-[#6865E7] focus:ring-offset-2"
                aria-label="Log in button"
              >
                Log In
              </button>
            </form>

            {/* Sign Up Link */}
            <div className="mt-6 text-center">
              <span className="dark:text-gray-400 text-gray-700">
                Don't have an account?{" "}
              </span>
              <button
                onClick={() => setCurrentScreen("signup")}
                className="text-[#6865E7] hover:text-[#6865E7]/80 font-medium transition-colors focus:outline-none focus:ring-2 focus:ring-[#6865E7] rounded px-1"
                aria-label="Sign up link"
              >
                Sign Up
              </button>
            </div>
          </div>
        </div>
      </div>
    );
  }

  // Signup Screen
  if (currentScreen === "signup") {
    return (
      <div className="min-h-screen bg-theme-primary relative overflow-hidden">
        {/* Background with card pattern overlay */}
        <div className="absolute inset-0 dark:bg-gradient-to-br dark:from-primary/20 dark:via-secondary/10 dark:to-primary/30 bg-gradient-to-br from-primary/5 via-secondary/3 to-primary/8">
          {/* Card pattern background */}
          <div className="absolute inset-0 dark:opacity-30 opacity-10">
            <div className="absolute top-10 left-10 w-32 h-44 bg-gradient-to-br from-primary/40 to-secondary/40 rounded-lg transform rotate-12"></div>
            <div className="absolute top-20 right-16 w-28 h-40 bg-gradient-to-br from-secondary/40 to-primary/40 rounded-lg transform -rotate-6"></div>
            <div className="absolute bottom-20 left-20 w-36 h-48 bg-gradient-to-br from-accent/20 to-primary/40 rounded-lg transform rotate-6"></div>
            <div className="absolute bottom-32 right-20 w-30 h-42 bg-gradient-to-br from-primary/40 to-accent/20 rounded-lg transform -rotate-12"></div>
          </div>

          {/* Theme-aware overlay */}
          <div className="absolute inset-0 bg-theme-primary/80 dark:bg-background/80"></div>
        </div>

        {/* Main content */}
        <div className="relative z-10 flex flex-col items-center justify-center min-h-screen px-4">
          {/* Logo */}
          <div className="mb-8">
            <div className="flex items-center justify-center">
              <img
                src="/Assets/CardStax_logo_light.svg"
                alt="CardStax"
                className="h-16 w-auto"
              />
            </div>
          </div>

          {/* Signup Form */}
          <div className="w-full max-w-sm dark:bg-gray-800/50 bg-[#fafafa]/90 backdrop-blur-sm rounded-2xl p-6 dark:border-gray-700 border-[#d2d3db] border">
            <h2
              className="text-2xl font-bold text-center mb-6"
              style={{ color: "#6865E7" }}
            >
              Create Account
            </h2>

            <form className="space-y-4">
              {/* Email Input */}
              <div>
                <label
                  htmlFor="signup-email"
                  className="block text-sm font-medium mb-2 dark:text-gray-400 text-gray-700"
                >
                  Email
                </label>
                <input
                  id="signup-email"
                  type="email"
                  value={signupEmail}
                  onChange={(e) => setSignupEmail(e.target.value)}
                  className="w-full px-4 py-3 dark:bg-gray-700 bg-gray-50 border dark:border-gray-600 border-gray-300 rounded-xl dark:text-white text-theme-primary placeholder-gray-500 dark:placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-[#6865E7] focus:border-transparent transition-all"
                  placeholder="Enter your email"
                  aria-label="Email address"
                  aria-required="true"
                />
              </div>

              {/* Password Input */}
              <div>
                <label
                  htmlFor="signup-password"
                  className="block text-sm font-medium mb-2 dark:text-gray-400 text-gray-700"
                >
                  Password
                </label>
                <div className="relative">
                  <input
                    id="signup-password"
                    type={showSignupPassword ? "text" : "password"}
                    value={signupPassword}
                    onChange={(e) => setSignupPassword(e.target.value)}
                    className="w-full px-4 py-3 dark:bg-gray-700 bg-gray-50 border dark:border-gray-600 border-gray-300 rounded-xl dark:text-white text-theme-primary placeholder-gray-500 dark:placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-[#6865E7] focus:border-transparent pr-12 transition-all"
                    placeholder="Create a password"
                    aria-label="Password"
                    aria-required="true"
                  />
                  <button
                    type="button"
                    onClick={() => setShowSignupPassword(!showSignupPassword)}
                    className="absolute right-3 top-1/2 transform -translate-y-1/2 dark:text-gray-400 text-gray-600 hover:dark:text-white hover:text-gray-900 focus:outline-none focus:ring-2 focus:ring-[#6865E7] rounded p-1 transition-colors"
                    aria-label={
                      showSignupPassword ? "Hide password" : "Show password"
                    }
                  >
                    {showSignupPassword ? (
                      <svg
                        className="w-5 h-5"
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                      >
                        <path
                          strokeLinecap="round"
                          strokeLinejoin="round"
                          strokeWidth="2"
                          d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.878 9.878L3 3m6.878 6.878L21 21"
                        />
                      </svg>
                    ) : (
                      <svg
                        className="w-5 h-5"
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                      >
                        <path
                          strokeLinecap="round"
                          strokeLinejoin="round"
                          strokeWidth="2"
                          d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"
                        />
                        <path
                          strokeLinecap="round"
                          strokeLinejoin="round"
                          strokeWidth="2"
                          d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"
                        />
                      </svg>
                    )}
                  </button>
                </div>
              </div>

              {/* Divider */}
              <div className="relative my-6">
                <div className="absolute inset-0 flex items-center">
                  <div className="w-full border-t dark:border-gray-600 border-gray-300"></div>
                </div>
                <div className="relative flex justify-center text-sm">
                  <span className="px-2 dark:bg-gray-800/50 bg-[#fafafa]/90 dark:text-gray-400 text-gray-700">
                    Or continue with
                  </span>
                </div>
              </div>

              {/* Google OAuth Button */}
              <button
                type="button"
                onClick={handleGoogleAuth}
                className="w-full flex items-center justify-center gap-3 bg-white dark:bg-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600 text-gray-900 dark:text-white font-medium py-3 px-6 rounded-xl transition-all duration-200 border dark:border-gray-600 border-gray-300 shadow-sm focus:outline-none focus:ring-2 focus:ring-[#6865E7] focus:ring-offset-2"
                aria-label="Sign up with Google"
              >
                <svg className="w-5 h-5" viewBox="0 0 24 24">
                  <path
                    fill="#4285F4"
                    d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"
                  />
                  <path
                    fill="#34A853"
                    d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"
                  />
                  <path
                    fill="#FBBC05"
                    d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"
                  />
                  <path
                    fill="#EA4335"
                    d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"
                  />
                </svg>
                <span>Continue with Google</span>
              </button>

              {/* Sign Up Button */}
              <button
                type="button"
                onClick={() => setCurrentScreen("main-app")}
                className="w-full bg-[#6865E7] hover:bg-[#6865E7]/90 text-white font-semibold py-3 px-6 rounded-xl transition-all duration-200 transform hover:scale-105 shadow-lg focus:outline-none focus:ring-2 focus:ring-[#6865E7] focus:ring-offset-2"
                aria-label="Sign up button"
              >
                Sign Up
              </button>
            </form>

            {/* Login Link */}
            <div className="mt-6 text-center">
              <span className="dark:text-gray-400 text-gray-700">
                Already have an account?{" "}
              </span>
              <button
                onClick={() => setCurrentScreen("login")}
                className="text-[#6865E7] hover:text-[#6865E7]/80 font-medium transition-colors focus:outline-none focus:ring-2 focus:ring-[#6865E7] rounded px-1"
                aria-label="Log in link"
              >
                Log In
              </button>
            </div>
          </div>
        </div>
      </div>
    );
  }

  // Show loading screen while checking authentication
  if (userLoading) {
    return (
      <div className="min-h-screen bg-theme-primary flex items-center justify-center">
        <div className="text-center">
          <div className="w-16 h-16 border-4 border-blue-500 border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
          <p className="dark:text-white text-theme-primary">Loading...</p>
        </div>
      </div>
    );
  }

  // Loading state for data
  if (isLoadingData && currentScreen === "dashboard") {
    return (
      <div className="min-h-screen bg-theme-primary flex items-center justify-center">
        <div className="text-center">
          <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-[#6865E7] mx-auto mb-4"></div>
          <p className="text-theme-primary text-lg">Loading cards...</p>
        </div>
      </div>
    );
  }

  // Splash Screen
  if (currentScreen === "splash") {
    return (
      <div className="min-h-screen bg-theme-primary relative overflow-hidden">
        {/* Background with card pattern overlay */}
        <div className="absolute inset-0 dark:bg-gradient-to-br dark:from-primary/20 dark:via-secondary/10 dark:to-primary/30 bg-gradient-to-br from-primary/5 via-secondary/3 to-primary/8">
          {/* Card pattern background - using CSS to create a subtle card-like pattern */}
          <div className="absolute inset-0 dark:opacity-30 opacity-10">
            <div className="absolute top-10 left-10 w-32 h-44 bg-gradient-to-br from-primary/40 to-secondary/40 rounded-lg transform rotate-12"></div>
            <div className="absolute top-20 right-16 w-28 h-40 bg-gradient-to-br from-secondary/40 to-primary/40 rounded-lg transform -rotate-6"></div>
            <div className="absolute bottom-20 left-20 w-36 h-48 bg-gradient-to-br from-accent/20 to-primary/40 rounded-lg transform rotate-6"></div>
            <div className="absolute bottom-32 right-20 w-30 h-42 bg-gradient-to-br from-primary/40 to-accent/20 rounded-lg transform -rotate-12"></div>
            <div className="absolute top-1/2 left-1/4 w-24 h-36 bg-gradient-to-br from-secondary/40 to-primary/40 rounded-lg transform rotate-45"></div>
            <div className="absolute top-1/3 right-1/3 w-26 h-38 bg-gradient-to-br from-primary/40 to-secondary/40 rounded-lg transform -rotate-45"></div>
          </div>

          {/* Theme-aware overlay */}
          <div className="absolute inset-0 bg-theme-primary/80 dark:bg-background/80"></div>
        </div>

        {/* Main content */}
        <div className="relative z-10 flex flex-col items-center justify-center min-h-screen px-4">
          {/* Logo */}
          <div className="mb-20">
            <div className="flex items-center justify-center">
              <img
                src="/Assets/CardStax_logo_light.svg"
                alt="CardStax"
                className="h-24 w-auto"
              />
            </div>
          </div>

          {/* Buttons */}
          <div className="flex flex-col gap-4 w-full max-w-xs">
            {/* Log in button */}
            <button
              onClick={() => setCurrentScreen("login")}
              className="w-full bg-[#6865E7] hover:bg-[#6865E7]/90 text-white font-semibold py-4 px-8 rounded-xl transition-all duration-200 transform hover:scale-105 shadow-lg"
            >
              Log in
            </button>

            {/* Sign up button */}
            <button
              onClick={() => setCurrentScreen("signup")}
              className="w-full border-2 dark:border-primary border-[#6865E7] hover:dark:border-primary/80 hover:border-[#6865E7]/80 dark:text-primary text-[#6865E7] font-semibold py-4 px-8 rounded-xl transition-all duration-200 transform hover:scale-105 bg-transparent dark:hover:bg-primary/10 hover:bg-[#6865E7]/10"
            >
              Sign up
            </button>
          </div>
        </div>
      </div>
    );
  }

  // Forgot Password Screen
  if (currentScreen === "forgot-password") {
    return (
      <div className="min-h-screen bg-theme-primary relative overflow-hidden">
        {/* Blurred card background */}
        <div className="absolute inset-0 bg-gradient-to-br from-primary/20 via-secondary/10 to-primary/30">
          <div className="absolute inset-0 opacity-30">
            <div className="absolute top-10 left-10 w-32 h-44 bg-gradient-to-br from-primary/40 to-secondary/40 rounded-lg transform rotate-12"></div>
            <div className="absolute top-20 right-16 w-28 h-40 bg-gradient-to-br from-secondary/40 to-primary/40 rounded-lg transform -rotate-6"></div>
            <div className="absolute bottom-20 left-20 w-36 h-48 bg-gradient-to-br from-accent/20 to-primary/40 rounded-lg transform rotate-6"></div>
            <div className="absolute bottom-32 right-20 w-30 h-42 bg-gradient-to-br from-primary/40 to-accent/20 rounded-lg transform -rotate-12"></div>
            <div className="absolute top-1/2 left-1/4 w-24 h-36 bg-gradient-to-br from-secondary/40 to-primary/40 rounded-lg transform rotate-45"></div>
            <div className="absolute top-1/3 right-1/3 w-26 h-38 bg-gradient-to-br from-primary/40 to-secondary/40 rounded-lg transform -rotate-45"></div>
          </div>
          <div className="absolute inset-0 bg-background/60 backdrop-blur-sm"></div>
        </div>

        {/* Modal */}
        <div className="min-h-screen flex items-end justify-center relative z-10 ">
          <div className="w-full max-w-2xl h-[80vh] sm:h-[80vh] lg:h-[75vh] min-h-[500px] dark:bg-gray-800/95 bg-white rounded-t-3xl shadow-2xl relative animate-slide-up flex flex-col">
            {/* Close button */}
            <button
              onClick={() => setCurrentScreen("login")}
              className="absolute top-4 right-4 dark:text-gray-400 text-gray-600 hover:dark:text-gray-200 hover:text-gray-800 transition-colors z-10 focus:outline-none focus:ring-2 focus:ring-[#6865E7] rounded"
              aria-label="Close forgot password"
            >
              <svg
                className="w-6 h-6"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  strokeLinecap="round"
                  strokeLinejoin="round"
                  strokeWidth={2}
                  d="M6 18L18 6M6 6l12 12"
                />
              </svg>
            </button>

            {/* Modal Content */}
            <div className="px-6 pb-6 pt-12 flex-1 flex flex-col ">
              <h2
                className="text-2xl font-bold mb-2"
                style={{ color: "#6865E7" }}
              >
                Forgot your password?
              </h2>
              <p className="dark:text-gray-400 text-gray-700 mb-6">
                We'll send you an email with instructions to reset your
                password.
              </p>

              <div className="space-y-4 flex-1 flex flex-col">
                <div>
                  <label
                    htmlFor="forgot-email"
                    className="block text-sm font-medium mb-2 dark:text-gray-400 text-gray-700"
                  >
                    Email address
                  </label>
                  <input
                    id="forgot-email"
                    type="email"
                    value={email}
                    onChange={(e) => setEmail(e.target.value)}
                    placeholder="Enter your email address"
                    className="w-full px-3 py-3 dark:bg-gray-700 bg-gray-50 border dark:border-gray-600 border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-[#6865E7] focus:border-transparent dark:text-white text-theme-primary placeholder-gray-500 dark:placeholder-gray-400 transition-all"
                    aria-label="Email address for password reset"
                    aria-required="true"
                  />
                </div>

                <button
                  onClick={handleForgotPassword}
                  className="w-full bg-[#6865E7] hover:bg-[#6865E7]/90 text-white font-semibold py-3 px-4 rounded-lg transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-[#6865E7] focus:ring-offset-2"
                  aria-label="Continue password reset"
                >
                  Continue
                </button>

                {/* Demo button to simulate email link click */}
                <div className="text-center">
                  <button
                    onClick={() => {
                      setResetToken("demo-reset-token-123");
                      setCurrentScreen("reset-password");
                    }}
                    className="text-sm dark:text-gray-400 text-gray-600 hover:dark:text-gray-300 hover:text-gray-800 underline focus:outline-none focus:ring-2 focus:ring-[#6865E7] rounded"
                  >
                    Demo: Click here to simulate email link
                  </button>
                </div>

                <div className="text-center">
                  <button
                    onClick={() => setCurrentScreen("login")}
                    className="text-sm text-[#6865E7] hover:text-[#6865E7]/80 focus:outline-none focus:ring-2 focus:ring-[#6865E7] rounded px-1"
                    aria-label="Back to login"
                  >
                    Back to login
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    );
  }

  // Reset Password Screen
  if (currentScreen === "reset-password") {
    return (
      <div className="min-h-screen bg-theme-primary relative overflow-hidden">
        {/* Blurred card background */}
        <div className="absolute inset-0 bg-gradient-to-br from-primary/20 via-secondary/10 to-primary/30">
          <div className="absolute inset-0 opacity-30">
            <div className="absolute top-10 left-10 w-32 h-44 bg-gradient-to-br from-primary/40 to-secondary/40 rounded-lg transform rotate-12"></div>
            <div className="absolute top-20 right-16 w-28 h-40 bg-gradient-to-br from-secondary/40 to-primary/40 rounded-lg transform -rotate-6"></div>
            <div className="absolute bottom-20 left-20 w-36 h-48 bg-gradient-to-br from-accent/20 to-primary/40 rounded-lg transform rotate-6"></div>
            <div className="absolute bottom-32 right-20 w-30 h-42 bg-gradient-to-br from-primary/40 to-accent/20 rounded-lg transform -rotate-12"></div>
            <div className="absolute top-1/2 left-1/4 w-24 h-36 bg-gradient-to-br from-secondary/40 to-primary/40 rounded-lg transform rotate-45"></div>
            <div className="absolute top-1/3 right-1/3 w-26 h-38 bg-gradient-to-br from-primary/40 to-secondary/40 rounded-lg transform -rotate-45"></div>
          </div>
          <div className="absolute inset-0 bg-background/60 backdrop-blur-sm"></div>
        </div>

        {/* Modal */}
        <div className="min-h-screen flex items-end justify-center relative z-10 ">
          <div className="w-full max-w-2xl h-[80vh] sm:h-[80vh] lg:h-[75vh] min-h-[500px] dark:bg-gray-800/95 bg-white rounded-t-3xl shadow-2xl relative animate-slide-up flex flex-col">
            {/* Close button */}
            <button
              onClick={() => setCurrentScreen("login")}
              className="absolute top-4 right-4 dark:text-gray-400 text-gray-600 hover:dark:text-gray-200 hover:text-gray-800 transition-colors z-10 focus:outline-none focus:ring-2 focus:ring-[#6865E7] rounded"
              aria-label="Close reset password"
            >
              <svg
                className="w-6 h-6"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  strokeLinecap="round"
                  strokeLinejoin="round"
                  strokeWidth={2}
                  d="M6 18L18 6M6 6l12 12"
                />
              </svg>
            </button>

            {/* Modal Content */}
            <div className="px-6 pb-6 pt-12 flex-1 flex flex-col ">
              <h2
                className="text-2xl font-bold mb-2"
                style={{ color: "#6865E7" }}
              >
                Reset your password
              </h2>
              <p className="dark:text-gray-400 text-gray-700 mb-6">
                Enter your new password below.
              </p>

              <div className="space-y-4 flex-1 flex flex-col">
                <div>
                  <label
                    htmlFor="reset-password"
                    className="block text-sm font-medium mb-2 dark:text-gray-400 text-gray-700"
                  >
                    New password
                  </label>
                  <div className="relative">
                    <input
                      id="reset-password"
                      type={showPassword ? "text" : "password"}
                      value={newPassword}
                      onChange={(e) => setNewPassword(e.target.value)}
                      placeholder="Enter your new password"
                      className="w-full px-3 py-3 pr-10 dark:bg-gray-700 bg-gray-50 border dark:border-gray-600 border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-[#6865E7] focus:border-transparent dark:text-white text-theme-primary placeholder-gray-500 dark:placeholder-gray-400 transition-all"
                      aria-label="New password"
                      aria-required="true"
                    />
                    <button
                      onClick={() => setShowPassword(!showPassword)}
                      className="absolute right-3 top-1/2 transform -translate-y-1/2 dark:text-gray-400 text-gray-600 hover:dark:text-white hover:text-gray-900 focus:outline-none focus:ring-2 focus:ring-[#6865E7] rounded p-1 transition-colors"
                      aria-label={
                        showPassword ? "Hide password" : "Show password"
                      }
                    >
                      {showPassword ? (
                        <svg
                          className="w-5 h-5"
                          fill="none"
                          stroke="currentColor"
                          viewBox="0 0 24 24"
                        >
                          <path
                            strokeLinecap="round"
                            strokeLinejoin="round"
                            strokeWidth={2}
                            d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.878 9.878L3 3m6.878 6.878L21 21"
                          />
                        </svg>
                      ) : (
                        <svg
                          className="w-5 h-5"
                          fill="none"
                          stroke="currentColor"
                          viewBox="0 0 24 24"
                        >
                          <path
                            strokeLinecap="round"
                            strokeLinejoin="round"
                            strokeWidth={2}
                            d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"
                          />
                          <path
                            strokeLinecap="round"
                            strokeLinejoin="round"
                            strokeWidth={2}
                            d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"
                          />
                        </svg>
                      )}
                    </button>
                  </div>
                </div>

                <div>
                  <label
                    htmlFor="confirm-password"
                    className="block text-sm font-medium mb-2 dark:text-gray-400 text-gray-700"
                  >
                    Confirm new password
                  </label>
                  <input
                    id="confirm-password"
                    type="password"
                    value={confirmPassword}
                    onChange={(e) => setConfirmPassword(e.target.value)}
                    placeholder="Confirm your new password"
                    className="w-full px-3 py-3 dark:bg-gray-700 bg-gray-50 border dark:border-gray-600 border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-[#6865E7] focus:border-transparent dark:text-white text-theme-primary placeholder-gray-500 dark:placeholder-gray-400 transition-all"
                    aria-label="Confirm new password"
                    aria-required="true"
                  />
                </div>

                <button
                  onClick={handleResetPassword}
                  className="w-full bg-[#6865E7] hover:bg-[#6865E7]/90 text-white font-semibold py-3 px-4 rounded-lg transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-[#6865E7] focus:ring-offset-2"
                  aria-label="Reset password button"
                >
                  Reset password
                </button>

                <div className="text-center">
                  <button
                    onClick={() => setCurrentScreen("login")}
                    className="text-sm text-[#6865E7] hover:text-[#6865E7]/80 focus:outline-none focus:ring-2 focus:ring-[#6865E7] rounded px-1"
                    aria-label="Back to login"
                  >
                    Back to login
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    );
  }

  // Manual Signup Screen
  if (currentScreen === "manual-signup") {
    return (
      <div className="min-h-screen bg-theme-primary relative overflow-hidden">
        {/* Blurred card background */}
        <div className="absolute inset-0 bg-gradient-to-br from-primary/20 via-secondary/10 to-primary/30">
          <div className="absolute inset-0 opacity-30">
            <div className="absolute top-10 left-10 w-32 h-44 bg-gradient-to-br from-primary/40 to-secondary/40 rounded-lg transform rotate-12"></div>
            <div className="absolute top-20 right-16 w-28 h-40 bg-gradient-to-br from-secondary/40 to-primary/40 rounded-lg transform -rotate-6"></div>
            <div className="absolute bottom-20 left-20 w-36 h-48 bg-gradient-to-br from-accent/20 to-primary/40 rounded-lg transform rotate-6"></div>
            <div className="absolute bottom-32 right-20 w-30 h-42 bg-gradient-to-br from-primary/40 to-accent/20 rounded-lg transform -rotate-12"></div>
            <div className="absolute top-1/2 left-1/4 w-24 h-36 bg-gradient-to-br from-secondary/40 to-primary/40 rounded-lg transform rotate-45"></div>
            <div className="absolute top-1/3 right-1/3 w-26 h-38 bg-gradient-to-br from-primary/40 to-secondary/40 rounded-lg transform -rotate-45"></div>
          </div>
          <div className="absolute inset-0 bg-background/60 backdrop-blur-sm"></div>
        </div>

        {/* Modal */}
        <div className="min-h-screen flex items-end justify-center relative z-10">
          <div className="w-full max-w-2xl h-[90vh] sm:h-[90vh] lg:h-[85vh] min-h-[600px] bg-accent rounded-t-3xl shadow-2xl relative animate-slide-up flex flex-col">
            {/* Close button */}
            <button
              onClick={() => setCurrentScreen("signup")}
              className="absolute top-4 right-4 text-gray-600 hover:text-gray-800 transition-colors z-10"
            >
              <svg
                className="w-6 h-6"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  strokeLinecap="round"
                  strokeLinejoin="round"
                  strokeWidth={2}
                  d="M6 18L18 6M6 6l12 12"
                />
              </svg>
            </button>

            {/* Tab Toggle */}
            <div className="flex p-1 bg-gray-100 rounded-lg mx-6 mb-0 mt-12">
              <button
                onClick={() => setCurrentScreen("login")}
                className="flex-1 py-2 px-4 rounded-md text-sm font-medium transition-all text-gray-600 hover:text-gray-800"
              >
                Log In
              </button>
              <button
                onClick={() => setCurrentScreen("signup")}
                className="flex-1 py-2 px-4 rounded-md text-sm font-medium transition-all bg-accent text-primary shadow-sm"
              >
                Sign Up
              </button>
            </div>

            {/* Modal Content */}
            <div className="px-6 pb-8 pt-4 flex-1 flex flex-col">
              <h2 className="text-2xl font-bold text-gray-800 mb-4">
                Create an account
              </h2>

              <div className="space-y-3 flex-1 flex flex-col">
                {/* Name Fields */}
                <div className="grid grid-cols-2 gap-4">
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">
                      First name
                    </label>
                    <input
                      type="text"
                      value={firstName}
                      onChange={(e) => setFirstName(e.target.value)}
                      placeholder="First name"
                      className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-transparent text-gray-800"
                    />
                  </div>
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">
                      Last name
                    </label>
                    <input
                      type="text"
                      value={lastName}
                      onChange={(e) => setLastName(e.target.value)}
                      placeholder="Last name"
                      className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-transparent text-gray-800"
                    />
                  </div>
                </div>

                {/* Email */}
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">
                    Email address
                  </label>
                  <input
                    type="email"
                    value={signupEmail}
                    onChange={(e) => setSignupEmail(e.target.value)}
                    placeholder="Email address"
                    className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-transparent text-gray-800"
                  />
                </div>

                {/* Date of Birth */}
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">
                    Date of birth
                  </label>
                  <input
                    type="date"
                    value={dateOfBirth}
                    onChange={(e) => setDateOfBirth(e.target.value)}
                    className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-transparent text-gray-800"
                  />
                </div>

                {/* Phone Number */}
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">
                    Phone number
                  </label>
                  <div className="flex">
                    <div className="relative country-dropdown">
                      <button
                        type="button"
                        onClick={() =>
                          setShowCountryDropdown(!showCountryDropdown)
                        }
                        className="flex items-center px-3 py-2 border border-gray-300 rounded-l-lg bg-gray-50 hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-primary/50 h-[42px]"
                      >
                        <span className="text-sm text-gray-700">
                          {getSelectedCountry().flag}{" "}
                          {getSelectedCountry().dialCode}
                        </span>
                        <svg
                          className="w-4 h-4 ml-1 text-gray-500"
                          fill="none"
                          stroke="currentColor"
                          viewBox="0 0 24 24"
                        >
                          <path
                            strokeLinecap="round"
                            strokeLinejoin="round"
                            strokeWidth={2}
                            d="M19 9l-7 7-7-7"
                          />
                        </svg>
                      </button>

                      {showCountryDropdown && (
                        <div className="absolute top-full left-0 mt-1 w-48 bg-white border border-gray-300 rounded-lg shadow-lg z-50 max-h-48 overflow-y-auto">
                          {countryCodes.map((country) => (
                            <button
                              key={country.code}
                              type="button"
                              onClick={() => {
                                setSelectedCountry(country.code);
                                setShowCountryDropdown(false);
                              }}
                              className="w-full px-3 py-2 text-left hover:bg-gray-100 flex items-center"
                            >
                              <span className="mr-2">{country.flag}</span>
                              <span className="text-sm text-gray-700">
                                {country.dialCode} {country.name}
                              </span>
                            </button>
                          ))}
                        </div>
                      )}
                    </div>
                    <input
                      type="tel"
                      value={phoneNumber}
                      onChange={(e) => setPhoneNumber(e.target.value)}
                      placeholder="(555) 555-5555"
                      className="flex-1 px-3 py-2 border border-l-0 border-gray-300 rounded-r-lg focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-transparent text-gray-800 h-[42px]"
                    />
                  </div>
                </div>

                {/* Username */}
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">
                    Username
                  </label>
                  <input
                    type="text"
                    value={username}
                    onChange={(e) => setUsername(e.target.value)}
                    placeholder="Username"
                    className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-transparent text-gray-800"
                  />
                </div>

                {/* Password Fields */}
                <div className="grid grid-cols-2 gap-4">
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">
                      Password
                    </label>
                    <div className="relative">
                      <input
                        type={showSignupPassword ? "text" : "password"}
                        value={signupPassword}
                        onChange={(e) => setSignupPassword(e.target.value)}
                        placeholder="Password"
                        className="w-full px-3 py-2 pr-10 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-transparent text-gray-800"
                      />
                      <button
                        onClick={() =>
                          setShowSignupPassword(!showSignupPassword)
                        }
                        className="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-500 hover:text-gray-700"
                      >
                        {showSignupPassword ? (
                          <svg
                            className="w-5 h-5"
                            fill="none"
                            stroke="currentColor"
                            viewBox="0 0 24 24"
                          >
                            <path
                              strokeLinecap="round"
                              strokeLinejoin="round"
                              strokeWidth={2}
                              d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.878 9.878L3 3m6.878 6.878L21 21"
                            />
                          </svg>
                        ) : (
                          <svg
                            className="w-5 h-5"
                            fill="none"
                            stroke="currentColor"
                            viewBox="0 0 24 24"
                          >
                            <path
                              strokeLinecap="round"
                              strokeLinejoin="round"
                              strokeWidth={2}
                              d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"
                            />
                            <path
                              strokeLinecap="round"
                              strokeLinejoin="round"
                              strokeWidth={2}
                              d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"
                            />
                          </svg>
                        )}
                      </button>
                    </div>
                  </div>
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">
                      Confirm password
                    </label>
                    <div className="relative">
                      <input
                        type={showConfirmPassword ? "text" : "password"}
                        value={confirmSignupPassword}
                        onChange={(e) =>
                          setConfirmSignupPassword(e.target.value)
                        }
                        placeholder="Confirm password"
                        className="w-full px-3 py-2 pr-10 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-transparent text-gray-800"
                      />
                      <button
                        onClick={() =>
                          setShowConfirmPassword(!showConfirmPassword)
                        }
                        className="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-500 hover:text-gray-700"
                      >
                        {showConfirmPassword ? (
                          <svg
                            className="w-5 h-5"
                            fill="none"
                            stroke="currentColor"
                            viewBox="0 0 24 24"
                          >
                            <path
                              strokeLinecap="round"
                              strokeLinejoin="round"
                              strokeWidth={2}
                              d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.878 9.878L3 3m6.878 6.878L21 21"
                            />
                          </svg>
                        ) : (
                          <svg
                            className="w-5 h-5"
                            fill="none"
                            stroke="currentColor"
                            viewBox="0 0 24 24"
                          >
                            <path
                              strokeLinecap="round"
                              strokeLinejoin="round"
                              strokeWidth={2}
                              d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"
                            />
                            <path
                              strokeLinecap="round"
                              strokeLinejoin="round"
                              strokeWidth={2}
                              d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"
                            />
                          </svg>
                        )}
                      </button>
                    </div>
                  </div>
                </div>

                {/* Register Button */}
                <div className="mt-6 pt-4">
                  <button
                    onClick={handleManualSignup}
                    className="w-full bg-primary hover:bg-primary/90 text-accent font-semibold py-3 px-4 rounded-lg transition-all duration-200"
                  >
                    Register
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    );
  }

  // Onboarding Screens
  if (currentScreen === "onboarding") {
    return (
      <div
        className={`min-h-screen relative overflow-hidden ${
          currentOnboardingStep === 0 ? "bg-gray-900" : "bg-theme-primary"
        }`}
      >
        {/* Onboarding Content */}
        <div
          className="min-h-screen flex flex-col px-4 py-4"
          onTouchStart={onTouchStart}
          onTouchMove={onTouchMove}
          onTouchEnd={onTouchEnd}
        >
          {/* Image Placeholder */}
          <div
            className={`w-full h-32 rounded-lg mb-4 flex items-center justify-center ${
              currentOnboardingStep === 0 ? "bg-gray-800" : "bg-gray-300"
            }`}
          >
            <span
              className={`text-sm ${
                currentOnboardingStep === 0 ? "text-gray-400" : "text-gray-500"
              }`}
            >
              Image Placeholder
            </span>
          </div>

          {/* Title */}
          <h1
            className={`text-3xl font-bold text-center mb-4 ${
              currentOnboardingStep === 0 ? "text-white" : "text-accent"
            }`}
          >
            {currentOnboardingStep === 0
              ? "Track"
              : currentOnboardingStep === 1
              ? "Organize"
              : "and more..."}
          </h1>

          {/* Features */}
          <div className="flex-1 space-y-3 mb-4 overflow-y-auto">
            {currentOnboardingStep === 0 && (
              <>
                <div className="flex items-start space-x-3">
                  <div className="w-10 h-10 bg-primary rounded-lg flex items-center justify-center flex-shrink-0">
                    <svg
                      className="w-5 h-5 text-white"
                      fill="currentColor"
                      viewBox="0 0 24 24"
                    >
                      <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z" />
                    </svg>
                  </div>
                  <div>
                    <h3 className="text-base font-bold text-white mb-1">
                      Track Expansion Packs & Sets
                    </h3>
                    <p className="text-gray-300 text-xs">
                      Visualize your completion progress for every set. Easily
                      track the cards you own, the ones you need, and those on
                      your wishlist. Watch your collection grow set by set and
                      become the ultimate master collector.
                    </p>
                  </div>
                </div>
                <div className="flex items-start space-x-3">
                  <div className="w-10 h-10 bg-primary rounded-lg flex items-center justify-center flex-shrink-0">
                    <svg
                      className="w-5 h-5 text-white"
                      fill="currentColor"
                      viewBox="0 0 24 24"
                    >
                      <path d="M16 6l2.29 2.29-4.88 4.88-4-4L2 16.59 3.41 18l6-6 4 4 6.3-6.29L22 12V6z" />
                    </svg>
                  </div>
                  <div>
                    <h3 className="text-base font-bold text-white mb-1">
                      Price Charting
                    </h3>
                    <p className="text-gray-300 text-xs">
                      See the real-time market value of your entire portfolio.
                      We pull prices from TCGplayer and eBay to give you the
                      most accurate valuation.
                    </p>
                  </div>
                </div>
                <div className="flex items-start space-x-3">
                  <div className="w-10 h-10 bg-primary rounded-lg flex items-center justify-center flex-shrink-0">
                    <svg
                      className="w-5 h-5 text-white"
                      fill="currentColor"
                      viewBox="0 0 24 24"
                    >
                      <path d="M12.87 15.07l-2.54-2.51.03-.03c1.74-1.94 2.98-4.17 3.71-6.53H17V4h-7V2H8v2H1v1.99h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11.76-2.04zM18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2l-4.5-12zm-2.62 7l1.62-4.33L19.12 17h-3.24z" />
                    </svg>
                  </div>
                  <div>
                    <h3 className="text-base font-bold text-white mb-1">
                      Track Multiple Languages
                    </h3>
                    <p className="text-gray-300 text-xs">
                      Whether you chase Japanese promos or European first
                      editions, log every card in any language. Easily filter
                      your collection to show only the languages you collect,
                      making it simple to manage and showcase your international
                      treasures.
                    </p>
                  </div>
                </div>
                <div className="flex items-start space-x-3">
                  <div className="w-10 h-10 bg-primary rounded-lg flex items-center justify-center flex-shrink-0">
                    <svg
                      className="w-5 h-5 text-white"
                      fill="currentColor"
                      viewBox="0 0 24 24"
                    >
                      <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-5 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z" />
                    </svg>
                  </div>
                  <div>
                    <h3 className="text-base font-bold text-white mb-1">
                      Track Variants & Rarities
                    </h3>
                    <p className="text-gray-300 text-xs">
                      Log every version of your favorite Pokémon. Easily
                      distinguish between standard holos, reverse holos, amazing
                      rares, illustration rares, and secret rares. Never lose
                      track of that special alternate art pull or your complete
                      master set ever again.
                    </p>
                  </div>
                </div>
              </>
            )}

            {currentOnboardingStep === 1 && (
              <>
                <div className="flex items-start space-x-3">
                  <div className="w-10 h-10 bg-primary rounded-lg flex items-center justify-center flex-shrink-0">
                    <svg
                      className="w-5 h-5 text-accent"
                      fill="currentColor"
                      viewBox="0 0 24 24"
                    >
                      <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z" />
                    </svg>
                  </div>
                  <div>
                    <h3 className="text-base font-bold text-accent mb-1">
                      Deck Builder
                    </h3>
                    <p className="text-accent text-xs">
                      Build decks, check legality, and get recommendations.
                      Create the perfect deck for any format with our
                      intelligent deck builder that knows the rules and helps
                      you optimize your strategy.
                    </p>
                  </div>
                </div>
                <div className="flex items-start space-x-3">
                  <div className="w-10 h-10 bg-primary rounded-lg flex items-center justify-center flex-shrink-0">
                    <svg
                      className="w-5 h-5 text-accent"
                      fill="currentColor"
                      viewBox="0 0 24 24"
                    >
                      <path d="M10 4H4c-1.11 0-2 .89-2 2v12c0 1.11.89 2 2 2h16c1.11 0 2-.89 2-2V8c0-1.11-.89-2-2-2h-8l-2-2z" />
                    </svg>
                  </div>
                  <div>
                    <h3 className="text-base font-bold text-accent mb-1">
                      Custom Folders
                    </h3>
                    <p className="text-accent text-xs">
                      Create custom folders like 'Investment Cards' or 'Shiny
                      Vault'. Organize your collection exactly how you want with
                      unlimited custom categories and smart filtering options.
                    </p>
                  </div>
                </div>
                <div className="flex items-start space-x-3">
                  <div className="w-10 h-10 bg-primary rounded-lg flex items-center justify-center flex-shrink-0">
                    <svg
                      className="w-5 h-5 text-accent"
                      fill="currentColor"
                      viewBox="0 0 24 24"
                    >
                      <path d="M4 6H2v14c0 1.1.9 2 2 2h14v-2H4V6zm16-4H8c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-1 9H9V9h10v2zm-4 4H9v-2h6v2zm4-8H9V5h10v2z" />
                    </svg>
                  </div>
                  <div>
                    <h3 className="text-base font-bold text-accent mb-1">
                      Binder Builder
                    </h3>
                    <p className="text-accent text-xs">
                      Digitally recreate your binders, arrange cards exactly how
                      you want, and showcase your pulls. Create virtual binders
                      that match your physical collection perfectly.
                    </p>
                  </div>
                </div>
                <div className="flex items-start space-x-3">
                  <div className="w-10 h-10 bg-primary rounded-lg flex items-center justify-center flex-shrink-0">
                    <svg
                      className="w-5 h-5 text-accent"
                      fill="currentColor"
                      viewBox="0 0 24 24"
                    >
                      <path d="M17 3H7c-1.1 0-1.99.9-1.99 2L5 21l7-3 7 3V5c0-1.1-.9-2-2-2z" />
                    </svg>
                  </div>
                  <div>
                    <h3 className="text-base font-bold text-accent mb-1">
                      Bookmark Favorites
                    </h3>
                    <p className="text-accent text-xs">
                      Bookmark your most valuable or sentimental cards into a
                      dedicated tab. Never lose track of your prized possessions
                      and easily access your favorites.
                    </p>
                  </div>
                </div>
              </>
            )}

            {currentOnboardingStep === 2 && (
              <>
                <div className="flex items-start space-x-3">
                  <div className="w-10 h-10 bg-primary rounded-lg flex items-center justify-center flex-shrink-0">
                    <svg
                      className="w-5 h-5 text-accent"
                      fill="currentColor"
                      viewBox="0 0 24 24"
                    >
                      <path d="M9.5 6.5v3h-3v-3h3M11 5H5v6h6V5zm-1.5 9.5v3h-3v-3h3M11 13H5v6h6v-6zm6.5-6.5v3h-3v-3h3M19 5h-6v6h6V5zm-6.5 9.5v3h-3v-3h3M19 13h-6v6h6v-6z" />
                    </svg>
                  </div>
                  <div>
                    <h3 className="text-base font-bold text-accent mb-1">
                      Scan Cards
                    </h3>
                    <p className="text-accent text-xs">
                      Point your camera, and you're done. Our advanced scanner
                      instantly recognizes any card and adds it to your
                      collection with all its details—no typing required. Build
                      your digital library faster than ever.
                    </p>
                  </div>
                </div>
                <div className="flex items-start space-x-3">
                  <div className="w-10 h-10 bg-primary rounded-lg flex items-center justify-center flex-shrink-0">
                    <svg
                      className="w-5 h-5 text-accent"
                      fill="currentColor"
                      viewBox="0 0 24 24"
                    >
                      <path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z" />
                    </svg>
                  </div>
                  <div>
                    <h3 className="text-base font-bold text-accent mb-1">
                      Deep Search
                    </h3>
                    <p className="text-accent text-xs">
                      Go beyond the name. Hunt for cards by their artist, find
                      all 'Fire' type cards from the 'Sword & Shield' era, or
                      track down every card illustrated by Mitsuhiro Arita. The
                      power to explore your collection is finally here.
                    </p>
                  </div>
                </div>
                <div className="flex items-start space-x-3">
                  <div className="w-10 h-10 bg-primary rounded-lg flex items-center justify-center flex-shrink-0">
                    <svg
                      className="w-5 h-5 text-accent"
                      fill="currentColor"
                      viewBox="0 0 24 24"
                    >
                      <path d="M16 4c0-1.11.89-2 2-2s2 .89 2 2-.89 2-2 2-2-.89-2-2zm4 18v-6h2.5l-2.54-7.63A1.5 1.5 0 0 0 18.54 8H16c-.8 0-1.54.37-2.01.99L12 11l-1.99-2.01A2.5 2.5 0 0 0 8 8H5.46c-.8 0-1.54.37-2.01.99L1 14.5V22h2v-6h2.5l2.54-7.63A1.5 1.5 0 0 1 9.46 8H12c.8 0 1.54.37 2.01.99L16 11l1.99-2.01A2.5 2.5 0 0 1 20.54 8H22v14h-2z" />
                    </svg>
                  </div>
                  <div>
                    <h3 className="text-base font-bold text-accent mb-1">
                      Add Friends & Community
                    </h3>
                    <p className="text-accent text-xs">
                      Join a thriving community! Add friends, show off your
                      latest pulls, discuss strategies, and get inspired. Share
                      your journey with fellow trainers who get it.
                    </p>
                  </div>
                </div>
                <div className="flex items-start space-x-3">
                  <div className="w-10 h-10 bg-primary rounded-lg flex items-center justify-center flex-shrink-0">
                    <svg
                      className="w-5 h-5 text-accent"
                      fill="currentColor"
                      viewBox="0 0 24 24"
                    >
                      <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z" />
                    </svg>
                  </div>
                  <div>
                    <h3 className="text-base font-bold text-accent mb-1">
                      Buy/Sell/Trade Marketplace
                    </h3>
                    <p className="text-accent text-xs">
                      Manage your entire collecting lifecycle in one app. Safely
                      buy, sell, and trade cards with other collectors. Securely
                      connect your payment methods to easily grow your
                      collection and your portfolio.
                    </p>
                  </div>
                </div>
              </>
            )}
          </div>

          {/* Pagination Dots */}
          <div className="flex justify-center space-x-2 mb-4">
            {[0, 1, 2].map((step) => (
              <div
                key={step}
                className={`w-2 h-2 rounded-full ${
                  step === currentOnboardingStep
                    ? "bg-primary"
                    : currentOnboardingStep === 0
                    ? "bg-gray-600"
                    : "bg-gray-400"
                }`}
              />
            ))}
          </div>

          {/* Navigation Button */}
          <button
            onClick={handleNextOnboarding}
            className={`w-full py-3 px-6 rounded-lg font-semibold text-base transition-all duration-200 ${
              currentOnboardingStep === 2
                ? "bg-primary text-accent hover:bg-primary/90"
                : currentOnboardingStep === 0
                ? "bg-gray-700 text-white hover:bg-gray-600"
                : "bg-gray-200 text-gray-700 hover:bg-gray-300"
            }`}
          >
            {currentOnboardingStep === 2 ? "Start Collecting!" : "Next"}
          </button>
        </div>
      </div>
    );
  }

  // Main Dashboard
  if (currentScreen === "main-app") {
    return (
      <div
        data-main-container
        className="min-h-screen dark:text-white text-theme-primary transition-all duration-300 ease-in-out relative"
        style={{
          height: "100vh",
          overflowY: showSlidingMenu ? "hidden" : "auto",
          WebkitOverflowScrolling: "touch",
          touchAction: "pan-y",
          position: "relative",
        }}
      >
        {/* Background gradient for light mode - muted palette */}
        <div
          className="fixed inset-0 dark:hidden bg-gradient-to-br from-[#fafafa] via-[#e4e5f1] to-[#d2d3db] -z-10"
          style={{
            background:
              "linear-gradient(135deg, #fafafa 0%, #e4e5f1 50%, rgba(104, 101, 231, 0.1) 100%)",
          }}
        ></div>
        {/* Background for dark mode */}
        <div
          className="fixed inset-0 hidden dark:block -z-10"
          style={{
            background:
              "linear-gradient(180deg, rgba(0, 0, 0, 0.20) 0%, rgba(71, 135, 243, 0.20) 100%), linear-gradient(0deg, #01010C 0%, #01010C 100%), #01010C",
          }}
        ></div>
        {/* Floating Particles Background */}
        <Particles
          className="absolute inset-0 z-0"
          quantity={60}
          ease={80}
          color={isDark ? "#ffffff" : "#8B87E8"}
          size={0.5}
          vx={0.02}
          vy={-0.01}
        />

        {/* Header - Transparent on Profile */}
        <div
          className={`px-4 py-6 relative z-10 ${
            activeTab === "profile"
              ? "absolute top-0 left-0 right-0 z-20 bg-gradient-to-b from-black/50 via-black/20 to-transparent"
              : ""
          }`}
          style={{ height: "95px" }}
        >
          <div className="flex items-center justify-between mb-6">
            {/* Logo Placeholder */}
            <div className="flex items-center gap-3">
              <img
                src="/Assets/CardStax_logo_light.svg"
                alt="CardStax"
                className="h-10 w-auto"
              />
            </div>

            {/* Menu Button */}
            <button
              onClick={() => setShowSlidingMenu(true)}
              className="w-12 h-12 dark:bg-white/10 bg-[#e4e5f1]/50 backdrop-blur-md rounded-xl flex items-center justify-center dark:hover:bg-white/20 hover:bg-[#d2d3db]/60 transition-all duration-200 dark:border-white/20 border-[#d2d3db]/50 shadow-lg"
            >
              <svg
                className="w-6 h-6 dark:text-white text-[#6865E7]"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  strokeLinecap="round"
                  strokeLinejoin="round"
                  strokeWidth="2"
                  d="M4 6h16M4 12h16M4 18h16"
                />
              </svg>
            </button>
          </div>
        </div>

        {/* Search Bar Component - Hidden on Collection, Marketplace, Profile, Deck Builder, Binder, Sets, and Community Tabs */}
        {activeTab !== "collection" &&
          activeTab !== "marketplace" &&
          activeTab !== "profile" &&
          navigationMode !== "deck-builder" &&
          navigationMode !== "binder" &&
          navigationMode !== "sets" &&
          navigationMode !== "community" && (
            <SearchBar
              searchQuery={searchQuery}
              setSearchQuery={setSearchQuery}
              onSearch={handleSearch}
              onSearchInputClick={handleSearchTabClick}
              onClearSearch={handleClearSearch}
              onScanClick={handleCardScan}
              placeholder="Search cards, sets, attacks, abilities..."
              isMenuOpen={showSlidingMenu}
              isModalOpen={showSearchResultsModal || showCardProfileModal}
              showScanButton={true}
            />
          )}

        {/* Tab Content */}
        {activeTab === "home" && (
          <>
            {/* Collection Overview */}
            <div className="px-1 sm:px-2 mb-6">
              <div className="dark:bg-gray-900/95 bg-[#fafafa]/95 backdrop-blur-xl rounded-2xl p-4 dark:border-gray-600/50 border-[#d2d3db]/50 shadow-2xl max-w-7xl mx-auto">
                {/* Collection Header */}
                <div className="flex items-center justify-between mb-4">
                  <div className="relative collection-dropdown">
                    <button
                      onClick={() =>
                        setShowCollectionDropdown(!showCollectionDropdown)
                      }
                      className="flex items-center gap-2 dark:hover:bg-white/10 hover:bg-[#e4e5f1] rounded-xl px-3 py-2 transition-all duration-200 dark:border-white/20 border-[#d2d3db]"
                    >
                      <h3 className="dark:text-white text-theme-primary font-semibold text-base">
                        {userData?.collections.find(
                          (c) => c.id === selectedCollection
                        )?.name || "Select Collection"}
                      </h3>
                      <svg
                        className="w-4 h-4 dark:text-blue-300 text-[#6865E7]"
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                      >
                        <path
                          strokeLinecap="round"
                          strokeLinejoin="round"
                          strokeWidth="2"
                          d="M19 9l-7 7-7-7"
                        ></path>
                      </svg>
                    </button>

                    {/* Collection Dropdown */}
                    {showCollectionDropdown && (
                      <div className="absolute top-full left-0 mt-2 dark:bg-gray-800/95 bg-[#fafafa]/95 backdrop-blur-md dark:border-white/20 border-[#d2d3db] rounded-xl shadow-2xl z-50 min-w-48">
                        {userData?.collections.map((collection) => (
                          <button
                            key={collection.id}
                            onClick={() => {
                              setSelectedCollection(collection.id);
                              setShowCollectionDropdown(false);
                            }}
                            className={`w-full px-4 py-3 text-left text-sm dark:hover:bg-white/10 hover:bg-[#e4e5f1] flex items-center justify-between rounded-lg transition-all duration-200 ${
                              selectedCollection === collection.id
                                ? "dark:bg-white/20 bg-[#e4e5f1]"
                                : ""
                            }`}
                          >
                            <span className="dark:text-white text-theme-primary font-medium">
                              {collection.name}
                            </span>
                            <span className="dark:text-blue-300 text-[#6865E7] text-xs font-semibold">
                              {formatCurrency(collection.totalValue)}
                            </span>
                          </button>
                        ))}
                        <div className="border-t dark:border-white/20 border-[#d2d3db] my-1"></div>
                        <button
                          onClick={() => {
                            setShowCreateCollectionModal(true);
                            setShowCollectionDropdown(false);
                          }}
                          className="w-full px-4 py-3 text-left text-sm dark:hover:bg-white/10 hover:bg-[#e4e5f1] flex items-center gap-2 dark:text-blue-300 text-[#6865E7] rounded-lg transition-all duration-200"
                        >
                          <svg
                            className="w-4 h-4"
                            fill="none"
                            stroke="currentColor"
                            viewBox="0 0 24 24"
                          >
                            <path
                              strokeLinecap="round"
                              strokeLinejoin="round"
                              strokeWidth="2"
                              d="M12 4v16m8-8H4"
                            />
                          </svg>
                          Create New Collection
                        </button>
                      </div>
                    )}
                  </div>
                  <div className="relative currency-dropdown">
                    <button
                      onClick={() =>
                        setShowCurrencyDropdown(!showCurrencyDropdown)
                      }
                      className="flex items-center gap-2 dark:hover:bg-white/10 hover:bg-[#e4e5f1] rounded-xl px-3 py-2 transition-all duration-200 dark:border-white/20 border-[#d2d3db]"
                    >
                      <div className="w-3 h-3 bg-gradient-to-r from-blue-400 to-indigo-500 rounded-full shadow-sm"></div>
                      <span className="dark:text-white text-theme-primary text-sm font-medium">
                        {
                          currencies.find((c) => c.code === selectedCurrency)
                            ?.code
                        }{" "}
                        (
                        {
                          currencies.find((c) => c.code === selectedCurrency)
                            ?.symbol
                        }
                        )
                      </span>
                      <svg
                        className="w-4 h-4 dark:text-blue-300 text-[#6865E7]"
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                      >
                        <path
                          strokeLinecap="round"
                          strokeLinejoin="round"
                          strokeWidth="2"
                          d="M19 9l-7 7-7-7"
                        ></path>
                      </svg>
                    </button>

                    {/* Currency Dropdown */}
                    {showCurrencyDropdown && (
                      <div className="absolute top-full right-0 mt-2 dark:bg-gray-800/95 bg-[#fafafa]/95 backdrop-blur-md dark:border-white/20 border-[#d2d3db] rounded-xl shadow-2xl z-50 min-w-32">
                        {currencies.map((currency) => (
                          <button
                            key={currency.code}
                            onClick={() => {
                              setSelectedCurrency(currency.code);
                              setShowCurrencyDropdown(false);
                            }}
                            className={`w-full px-4 py-3 text-left text-sm dark:hover:bg-white/10 hover:bg-[#e4e5f1] flex items-center gap-3 rounded-lg transition-all duration-200 ${
                              selectedCurrency === currency.code
                                ? "dark:bg-white/20 bg-[#e4e5f1]"
                                : ""
                            }`}
                          >
                            <span className="text-lg">{currency.flag}</span>
                            <span className="dark:text-white text-theme-primary font-medium">
                              {currency.code}
                            </span>
                            <span className="dark:text-blue-300 text-[#6865E7] text-xs font-semibold">
                              ({currency.symbol})
                            </span>
                          </button>
                        ))}
                      </div>
                    )}
                  </div>
                </div>

                {/* Portfolio Value */}
                <div className="dark:text-white text-theme-primary text-4xl font-bold mb-3 dark:bg-gradient-to-r dark:from-white dark:to-blue-200 bg-gradient-to-r from-[#6865E7] to-[#5A57D1] bg-clip-text text-transparent">
                  {formatCurrency(
                    userData?.collections.find(
                      (c) => c.id === selectedCollection
                    )?.totalValue || 0
                  )}
                </div>

                {/* Price Change */}
                {(() => {
                  const priceChange = calculatePriceChange(selectedTimeRange);
                  return (
                    <div
                      className={`flex items-center gap-2 text-base mb-2 ${
                        priceChange.change >= 0
                          ? "dark:text-emerald-400 text-emerald-600"
                          : "dark:text-red-400 text-red-600"
                      }`}
                    >
                      <div
                        className={`p-1 rounded-full ${
                          priceChange.change >= 0
                            ? "dark:bg-emerald-500/20 bg-emerald-500/30"
                            : "dark:bg-red-500/20 bg-red-500/30"
                        }`}
                      >
                        <svg
                          className="w-4 h-4"
                          fill="none"
                          stroke="currentColor"
                          viewBox="0 0 24 24"
                        >
                          <path
                            strokeLinecap="round"
                            strokeLinejoin="round"
                            strokeWidth="2"
                            d={
                              priceChange.change >= 0
                                ? "M7 11l5-5m0 0l5 5m-5-5v12"
                                : "M17 13l-5 5m0 0l-5-5m5 5V6"
                            }
                          ></path>
                        </svg>
                      </div>
                      <span className="font-semibold">
                        {formatCurrency(Math.abs(priceChange.change))}
                      </span>
                      <span className="dark:text-blue-300 text-[#6865E7] font-medium">
                        {priceChange.timeLabel}
                      </span>
                    </div>
                  );
                })()}

                {/* Last Updated */}
                <div className="dark:text-blue-300 text-[#6865E7] text-sm mb-6 font-medium">
                  {(() => {
                    const collection = userData?.collections?.find(
                      (c) => c.id === selectedCollection
                    );
                    const lastUpdated = collection?.lastUpdated;
                    if (lastUpdated) {
                      const date = new Date(lastUpdated);
                      return `Last updated: ${date.toLocaleDateString("en-US", {
                        month: "long",
                        day: "numeric",
                        year: "numeric",
                      })}`;
                    }
                    return "Last updated: Recently";
                  })()}
                </div>

                {/* Chart */}
                <div className="h-48 mb-4">
                  <Line data={getChartData} options={chartOptions} />
                </div>

                {/* Time Range Selector */}
                <div className="flex gap-1 w-full overflow-x-auto">
                  {["1D", "7D", "1M", "3M", "6M", "1Y", "Max"].map((range) => (
                    <button
                      key={range}
                      onClick={() =>
                        setSelectedTimeRange(range === "Max" ? "MAX" : range)
                      }
                      className={`flex-1 py-2 px-2 text-xs font-semibold rounded-lg transition-all duration-200 whitespace-nowrap min-w-0 ${
                        selectedTimeRange === (range === "Max" ? "MAX" : range)
                          ? "bg-gradient-to-r from-blue-500 to-indigo-600 text-white shadow-lg"
                          : "dark:bg-white/10 bg-[#e4e5f1]/60 dark:text-blue-200 text-[#6865E7] dark:hover:bg-white/20 hover:bg-[#d2d3db] dark:border-white/20 border-[#d2d3db]"
                      }`}
                    >
                      {range}
                    </button>
                  ))}
                </div>
              </div>
            </div>

            {/* Collection Stats */}
            <div className="px-1 sm:px-2 mb-6">
              <div className="flex gap-4 max-w-7xl mx-auto">
                {/* Total Cards Card */}
                <div className="flex-1 bg-white/5 backdrop-blur-md rounded-2xl p-4 border border-white/10 shadow-xl">
                  <div className="dark:text-white text-theme-primary font-bold text-base mb-3">
                    Total Cards
                  </div>
                  <div className="bg-gradient-to-r from-blue-500/20 to-indigo-500/20 rounded-xl p-3 mb-3 border border-blue-400/30">
                    <div className="dark:text-white text-theme-primary text-2xl font-bold">
                      {userDatabase.getTotalCards().toLocaleString()}
                    </div>
                  </div>

                  {/* Portfolio Items */}
                  <div className="space-y-2">
                    {userData?.collections
                      ?.slice(0, 2)
                      .map((collection, index) => (
                        <div
                          key={collection.id}
                          className="flex items-center justify-between px-3 py-2 bg-white/5 rounded-lg"
                        >
                          <span className="dark:text-white text-theme-primary text-sm font-medium">
                            {collection.name}
                          </span>
                          <div className="text-blue-300 text-sm font-semibold">
                            <span>{collection.cards?.length || 0}</span>
                          </div>
                        </div>
                      ))}

                    <button
                      onClick={() => setShowCollectionsModal(true)}
                      className="text-center text-blue-300 text-sm py-3 hover:text-white transition-all duration-200 cursor-pointer w-full bg-white/5 hover:bg-white/10 rounded-xl font-medium"
                      style={{ marginTop: "20px" }}
                    >
                      View Collections
                    </button>
                  </div>
                </div>

                {/* Recent Activity Card */}
                <div className="flex-1 bg-white/5 backdrop-blur-md rounded-2xl p-4 border border-white/10 shadow-xl">
                  <div className="dark:text-white text-theme-primary font-bold text-base mb-3">
                    Recent Activity
                  </div>
                  <div className="space-y-2">
                    {displayedActivity.length > 0 ? (
                      displayedActivity.map((activity) => (
                        <div
                          key={activity.id}
                          className="bg-white/5 rounded-xl p-3 flex items-center justify-between border border-white/10"
                        >
                          <div className="flex flex-col">
                            <span className="dark:text-white text-theme-primary text-sm font-medium">
                              {activity.cardName}
                            </span>
                            <span className="text-blue-300 text-xs">
                              {activity.time}
                            </span>
                          </div>
                          <div
                            className={`flex items-center gap-2 text-sm ${
                              activity.type === "add"
                                ? "text-emerald-400"
                                : "text-red-400"
                            }`}
                          >
                            <div
                              className={`p-1 rounded-full ${
                                activity.type === "add"
                                  ? "bg-emerald-500/20"
                                  : "bg-red-500/20"
                              }`}
                            >
                              <svg
                                className="w-4 h-4"
                                fill="none"
                                stroke="currentColor"
                                viewBox="0 0 24 24"
                              >
                                {activity.type === "add" ? (
                                  <path
                                    strokeLinecap="round"
                                    strokeLinejoin="round"
                                    strokeWidth="2"
                                    d="M12 6v6m0 0v6m0-6h6m-6 0H6"
                                  />
                                ) : (
                                  <path
                                    strokeLinecap="round"
                                    strokeLinejoin="round"
                                    strokeWidth="2"
                                    d="M6 12L18 12"
                                  />
                                )}
                              </svg>
                            </div>
                            <span className="font-medium">
                              {activity.action}
                            </span>
                          </div>
                        </div>
                      ))
                    ) : (
                      <div className="bg-white/5 rounded-xl p-4 text-center border border-white/10">
                        <div className="text-blue-300 text-sm mb-1 font-medium">
                          No activity yet
                        </div>
                        <div className="text-blue-400 text-xs">
                          Add cards to see activity
                        </div>
                      </div>
                    )}
                  </div>

                  <button
                    onClick={() => setShowActivityModal(true)}
                    className="text-center text-blue-300 text-sm py-3 mt-3 hover:text-white transition-all duration-200 cursor-pointer w-full bg-white/5 hover:bg-white/10 rounded-xl font-medium"
                  >
                    View All
                  </button>
                </div>
              </div>
            </div>

            {/* Top Movers */}
            <div className="px-1 sm:px-2 mb-6 mt-8">
              <div className="bg-white/5 backdrop-blur-md rounded-2xl p-4 border border-white/10 shadow-xl max-w-7xl mx-auto">
                <div className="flex items-center justify-between mb-6">
                  <div className="flex items-center gap-3">
                    <div className="w-10 h-10 bg-gradient-to-br from-emerald-500 to-green-600 rounded-xl flex items-center justify-center shadow-lg">
                      <svg
                        className="w-5 h-5 dark:text-white text-theme-primary"
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                      >
                        <path
                          strokeLinecap="round"
                          strokeLinejoin="round"
                          strokeWidth="2"
                          d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"
                        />
                      </svg>
                    </div>
                    <h3 className="dark:text-white text-theme-primary font-bold text-xl">
                      My Top Movers
                    </h3>
                  </div>
                  <div className="text-sm dark:text-blue-300 text-[#6865E7] font-medium">
                    Highest Value
                  </div>
                </div>

                {myTopMoversWithUpdatedPrices.length === 0 ? (
                  // Empty State
                  <div className="flex flex-col items-center justify-center py-12">
                    <div className="w-20 h-20 bg-gradient-to-br from-blue-500/20 to-indigo-500/20 rounded-full flex items-center justify-center mb-4 border border-blue-400/30">
                      <svg
                        className="w-10 h-10 text-blue-400"
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                      >
                        <path
                          strokeLinecap="round"
                          strokeLinejoin="round"
                          strokeWidth="2"
                          d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4"
                        />
                      </svg>
                    </div>
                    <h4 className="text-white font-bold text-xl mb-2">
                      No Cards Yet
                    </h4>
                    <p className="text-blue-300 text-sm text-center max-w-xs mb-6">
                      Start building your collection to see your highest valued
                      cards here
                    </p>
                    <button
                      onClick={() => {
                        setActiveTab("search");
                        setNavigationMode("search"); // Update navigation bar to show search as active
                        scrollToTop(); // Scroll to top when navigating
                      }}
                      className="px-8 py-4 bg-gradient-to-r from-blue-500 to-indigo-600 hover:from-blue-600 hover:to-indigo-700 rounded-xl text-white text-sm font-semibold transition-all duration-300 shadow-lg shadow-blue-500/25 hover:shadow-blue-500/40"
                    >
                      Browse Cards
                    </button>
                  </div>
                ) : (
                  <>
                    <div className="grid grid-cols-1 gap-4">
                      {myTopMoversWithUpdatedPrices.map((card, index) => (
                        <div
                          key={card.id}
                          onClick={() => handleCardClick(card)}
                          className="relative bg-white/5 backdrop-blur-sm rounded-2xl p-4 border border-white/10 hover:border-blue-400/40 transition-all duration-300 group cursor-pointer shadow-lg hover:shadow-xl"
                        >
                          <div className="flex items-center gap-4">
                            <div className="relative">
                              <div className="w-16 h-20 rounded-xl shadow-lg overflow-hidden bg-gradient-to-br from-blue-500/20 to-indigo-500/20 border border-blue-400/30">
                                <img
                                  src={card.imageUrl}
                                  alt={getDisplayName(card)}
                                  className="w-full h-full object-cover"
                                  onError={(e) => {
                                    e.target.style.display = "none";
                                    e.target.nextSibling.style.display = "flex";
                                  }}
                                />
                                <div
                                  className="w-full h-full bg-gradient-to-br from-blue-400 to-purple-500 flex items-center justify-center"
                                  style={{ display: "none" }}
                                >
                                  <span className="text-white font-bold text-xs">
                                    #{index + 1}
                                  </span>
                                </div>
                              </div>
                              <div className="absolute -top-1 -right-1 w-6 h-6 bg-blue-500 rounded-full flex items-center justify-center">
                                <span className="text-white text-xs font-bold">
                                  #{index + 1}
                                </span>
                              </div>
                            </div>
                            <div className="flex-1">
                              <h4 className="dark:text-white text-theme-primary font-bold text-sm dark:group-hover:text-blue-400 group-hover:text-[#6865E7] transition-colors">
                                {getDisplayName(card)}
                              </h4>
                              <p className="dark:text-gray-400 text-theme-secondary text-xs">
                                {card.set} • {card.rarity}
                              </p>
                              <div className="flex items-center gap-2 mt-1">
                                {card.formattedNumber && (
                                  <>
                                    <span className="dark:text-white text-theme-primary text-xs font-medium">
                                      {card.formattedNumber}
                                    </span>
                                    <span className="dark:text-gray-500 text-theme-tertiary text-xs">
                                      •
                                    </span>
                                  </>
                                )}
                                <span className="dark:text-gray-400 text-theme-secondary text-xs">
                                  Qty:{" "}
                                  {getCardQuantityInCollection(
                                    card.cardId || card.id
                                  )}
                                </span>
                              </div>
                            </div>
                            <div className="text-right">
                              <div className="text-blue-400 font-bold text-lg">
                                {formatCurrency(card.totalValue)}
                              </div>
                              <div className="dark:text-gray-400 text-theme-secondary text-xs mt-1">
                                {formatCurrency(
                                  updatedCollectionPrices[card.cardId] ||
                                    card.currentValue
                                )}{" "}
                                each
                              </div>
                            </div>
                          </div>
                        </div>
                      ))}
                    </div>
                  </>
                )}
              </div>
            </div>

            {/* Trending Cards */}
            <div className="px-1 sm:px-2 mb-6 pb-20">
              <div className="bg-white/5 backdrop-blur-md rounded-2xl p-4 border border-white/10 shadow-xl max-w-7xl mx-auto">
                <div className="flex items-center justify-between mb-6">
                  <div className="flex items-center justify-between">
                    <div className="flex items-center gap-3">
                      <div className="w-8 h-8 bg-gradient-to-br from-blue-500 to-indigo-600 rounded-lg flex items-center justify-center">
                        <svg
                          className="w-4 h-4 text-white"
                          fill="none"
                          stroke="currentColor"
                          viewBox="0 0 24 24"
                        >
                          <path
                            strokeLinecap="round"
                            strokeLinejoin="round"
                            strokeWidth="2"
                            d="M17.657 18.657A8 8 0 016.343 7.343S7 9 9 10c0-2 .5-5 2.986-7C14 5 16.09 5.777 17.656 7.343A7.975 7.975 0 0120 13a7.975 7.975 0 01-2.343 5.657z"
                          />
                          <path
                            strokeLinecap="round"
                            strokeLinejoin="round"
                            strokeWidth="2"
                            d="M9.879 16.121A3 3 0 1012.015 11L11 14H9c0 .768.293 1.536.879 2.121z"
                          />
                        </svg>
                      </div>
                      <h3 className="dark:text-white text-theme-primary font-bold text-lg">
                        Trending Cards
                      </h3>
                    </div>
                  </div>
                  <div className="flex flex-col items-end">
                    <div className="text-xs dark:text-blue-300 text-[#6865E7]">
                      Hot Today
                    </div>
                    <button
                      onClick={() => setRefreshKey((prev) => prev + 1)}
                      className="text-xs text-blue-300 hover:text-white transition-colors flex items-center gap-1"
                    >
                      <svg
                        className="w-3 h-3"
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                      >
                        <path
                          strokeLinecap="round"
                          strokeLinejoin="round"
                          strokeWidth="2"
                          d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"
                        />
                      </svg>
                      Refresh
                    </button>
                  </div>
                </div>

                <div className="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 2xl:grid-cols-7 gap-3 sm:gap-2 md:gap-3">
                  {/* Trending Cards - Using MarketplaceCard for consistency */}
                  {trendingCardsData.slice(0, 12).map((card, index) => (
                    <MarketplaceCard
                      key={card.id || index}
                      platform="Trending"
                      cardName={card.name}
                      setName={card.set || card.set_name || "Unknown Set"}
                      rarity={card.rarity || card.ext_rarity || ""}
                      cardNumber={card.formattedNumber || card.ext_number || ""}
                      price={formatCurrency(
                        updatedCollectionPrices[card.cardId] ||
                          card.current_value ||
                          card.price ||
                          0
                      )}
                      isCollection={false}
                      cardImage={getCardImageUrl(card)}
                      onClick={() => handleCardClick(card)}
                      onAddToCollection={() => handleAddToCollection(card)}
                    />
                  ))}
                </div>

                <button
                  onClick={() => {
                    setActiveTab("search");
                    setNavigationMode("search"); // Update navigation bar to show search as active
                    setShowSearchResults(false); // Show trending cards instead of search results
                    scrollToTop(); // Scroll to top when navigating
                  }}
                  className="w-full mt-6 py-3 bg-gradient-to-r from-blue-500 to-indigo-600 hover:from-blue-600 hover:to-indigo-700 rounded-xl text-white text-sm font-medium transition-all duration-300 flex items-center justify-center gap-2 shadow-lg shadow-blue-500/25"
                >
                  <span>Explore All Trending</span>
                  <svg
                    className="w-4 h-4"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      strokeLinecap="round"
                      strokeLinejoin="round"
                      strokeWidth="2"
                      d="M9 5l7 7-7 7"
                    />
                  </svg>
                </button>
              </div>
            </div>
          </>
        )}

        {activeTab === "search" && (
          <div
            data-search-section
            className="flex flex-col px-5 pb-20 transition-all duration-300 ease-in-out animate-in fade-in-0 slide-in-from-bottom-4 max-w-7xl mx-auto relative z-10"
          >
            {/* Search Header - Fixed */}
            <div className="mb-6 flex-shrink-0">
              <div className="flex items-center gap-3 mb-4">
                {/* Back Button */}
                <button
                  onClick={() => {
                    if (previousTab) {
                      setActiveTab(previousTab);
                      setNavigationMode(previousTab);
                    } else {
                      setActiveTab("home");
                      setNavigationMode("home");
                    }
                  }}
                  className="w-10 h-10 bg-white/10 hover:bg-white/20 rounded-lg flex items-center justify-center transition-colors"
                  title="Back"
                >
                  <svg
                    className="w-5 h-5 text-white"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      strokeLinecap="round"
                      strokeLinejoin="round"
                      strokeWidth="2"
                      d="M15 19l-7-7 7-7"
                    />
                  </svg>
                </button>
                <h2 className="text-white text-lg font-semibold">
                  {showSearchResults
                    ? `Search Results (${filteredSearchResults.length})`
                    : "Search"}
                </h2>
              </div>
              {showSearchResults && (
                <div className="flex items-center gap-3">
                  {/* Filter Button */}
                  <div className="relative filter-dropdown-container">
                    <button
                      onClick={() =>
                        setShowSearchFilterModal(!showSearchFilterModal)
                      }
                      className="flex items-center gap-2 px-3 py-2 dark:bg-gray-800/90 bg-[#e4e5f1]/90 backdrop-blur-md dark:border-gray-600/50 border-[#d2d3db] rounded-lg dark:text-white text-theme-primary text-sm dark:hover:bg-gray-700/90 hover:bg-[#d2d3db] transition-all duration-200"
                    >
                      <svg
                        className="w-4 h-4"
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                      >
                        <path
                          strokeLinecap="round"
                          strokeLinejoin="round"
                          strokeWidth="2"
                          d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"
                        />
                      </svg>
                      Filter
                      {Object.values(activeFilters).some(
                        (filters) => filters.length > 0
                      ) && (
                        <span className="bg-blue-500 text-white text-xs rounded-full px-2 py-0.5 min-w-[20px] text-center">
                          {Object.values(activeFilters).reduce(
                            (total, filters) => total + filters.length,
                            0
                          )}
                        </span>
                      )}
                      <svg
                        className={`w-4 h-4 transition-transform duration-200 ${
                          showSearchFilterModal ? "rotate-180" : ""
                        }`}
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                      >
                        <path
                          strokeLinecap="round"
                          strokeLinejoin="round"
                          strokeWidth="2"
                          d="M19 9l-7 7-7-7"
                        />
                      </svg>
                    </button>
                  </div>

                  {/* Sort Button */}
                  <div className="relative sort-dropdown-container">
                    <button
                      onClick={() => setShowSortModal(!showSortModal)}
                      className="flex items-center gap-2 px-3 py-2 dark:bg-gray-800/90 bg-[#e4e5f1]/90 backdrop-blur-md dark:border-gray-600/50 border-[#d2d3db] rounded-lg dark:text-white text-theme-primary text-sm dark:hover:bg-gray-700/90 hover:bg-[#d2d3db] transition-all duration-200"
                    >
                      <svg
                        className="w-4 h-4"
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                      >
                        <path
                          strokeLinecap="round"
                          strokeLinejoin="round"
                          strokeWidth="2"
                          d="M3 4h13M3 8h9m-9 4h6m4 0l4-4m0 0l4 4m-4-4v12"
                        />
                      </svg>
                      Sort
                      <svg
                        className={`w-4 h-4 transition-transform duration-200 ${
                          showSortModal ? "rotate-180" : ""
                        }`}
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                      >
                        <path
                          strokeLinecap="round"
                          strokeLinejoin="round"
                          strokeWidth="2"
                          d="M19 9l-7 7-7-7"
                        />
                      </svg>
                    </button>

                    {/* Sort Modal */}
                    {showSortModal &&
                      createPortal(
                        <div
                          className="fixed inset-0 bg-black/60 backdrop-blur-sm z-[10003] flex items-end"
                          onClick={() => setShowSortModal(false)}
                        >
                          <div
                            className="w-full bg-gray-900/95 backdrop-blur-xl border-t border-gray-700/50 rounded-t-3xl shadow-2xl animate-in slide-in-from-bottom-8 duration-300"
                            onClick={(e) => e.stopPropagation()}
                          >
                            {/* Handle Bar */}
                            <div className="flex justify-center pt-3 pb-2">
                              <div className="w-12 h-1.5 bg-gray-600 rounded-full"></div>
                            </div>

                            {/* Header */}
                            <div className="px-6 py-4 border-b border-gray-700/50">
                              <h3 className="text-xl font-bold text-white mb-1">
                                Sort By
                              </h3>
                              <p className="text-sm text-gray-400">
                                Choose how to organize your results
                              </p>
                            </div>

                            {/* Sort Options */}
                            <div className="p-4 max-h-[60vh] overflow-y-auto">
                              <div className="grid grid-cols-1 gap-2">
                                {[
                                  {
                                    value: "trending",
                                    label: "Trending",
                                    icon: (
                                      <img
                                        src="/Assets/NewSort/Trending.svg"
                                        alt="Trending"
                                        className="w-5 h-5"
                                      />
                                    ),
                                  },
                                  {
                                    value: "name-asc",
                                    label: "A-Z",
                                    icon: (
                                      <img
                                        src="/Assets/NewSort/A-Z.svg"
                                        alt="A-Z"
                                        className="w-5 h-5"
                                      />
                                    ),
                                  },
                                  {
                                    value: "name-desc",
                                    label: "Z-A",
                                    icon: (
                                      <img
                                        src="/Assets/NewSort/Z-A.svg"
                                        alt="Z-A"
                                        className="w-5 h-5"
                                      />
                                    ),
                                  },
                                  {
                                    value: "price-low",
                                    label: (
                                      <span>
                                        Price{" "}
                                        <span className="text-xs opacity-75">
                                          (Low to High)
                                        </span>
                                      </span>
                                    ),
                                    icon: (
                                      <img
                                        src="/Assets/NewSort/Price down.svg"
                                        alt="Price Low to High"
                                        className="w-5 h-5"
                                      />
                                    ),
                                  },
                                  {
                                    value: "price-high",
                                    label: (
                                      <span>
                                        Price{" "}
                                        <span className="text-xs opacity-75">
                                          (High to Low)
                                        </span>
                                      </span>
                                    ),
                                    icon: (
                                      <img
                                        src="/Assets/NewSort/Price up.svg"
                                        alt="Price High to Low"
                                        className="w-5 h-5"
                                      />
                                    ),
                                  },
                                  {
                                    value: "number-asc",
                                    label: (
                                      <span>
                                        Number{" "}
                                        <span className="text-xs opacity-75">
                                          (Low to High)
                                        </span>
                                      </span>
                                    ),
                                    icon: (
                                      <img
                                        src="/Assets/NewSort/Number down.svg"
                                        alt="Number Low to High"
                                        className="w-5 h-5"
                                      />
                                    ),
                                  },
                                  {
                                    value: "number-desc",
                                    label: (
                                      <span>
                                        Number{" "}
                                        <span className="text-xs opacity-75">
                                          (High to Low)
                                        </span>
                                      </span>
                                    ),
                                    icon: (
                                      <img
                                        src="/Assets/NewSort/Number up.svg"
                                        alt="Number High to Low"
                                        className="w-5 h-5"
                                      />
                                    ),
                                  },
                                  {
                                    value: "date-added-oldest",
                                    label: (
                                      <span>
                                        Date Added{" "}
                                        <span className="text-xs opacity-75">
                                          (Oldest First)
                                        </span>
                                      </span>
                                    ),
                                    icon: (
                                      <img
                                        src="/Assets/NewSort/Date down.svg"
                                        alt="Date Oldest First"
                                        className="w-5 h-5"
                                      />
                                    ),
                                  },
                                  {
                                    value: "date-added-newest",
                                    label: (
                                      <span>
                                        Date Added{" "}
                                        <span className="text-xs opacity-75">
                                          (Newest First)
                                        </span>
                                      </span>
                                    ),
                                    icon: (
                                      <img
                                        src="/Assets/NewSort/Date up.svg"
                                        alt="Date Newest First"
                                        className="w-5 h-5"
                                      />
                                    ),
                                  },
                                ].map((option) => (
                                  <button
                                    key={option.value}
                                    onClick={() => {
                                      handleSortOption(option.value);
                                      setShowSortModal(false);
                                    }}
                                    className={`w-full flex items-center gap-4 px-4 py-4 rounded-xl text-sm transition-all duration-200 text-left border ${
                                      sortOption === option.value
                                        ? "bg-blue-500/20 border-blue-500/50 text-blue-300 shadow-lg shadow-blue-500/20"
                                        : "bg-white/5 border-gray-700/50 text-white/80 hover:bg-white/10 hover:border-gray-600 hover:text-white"
                                    }`}
                                  >
                                    <span className="flex-shrink-0">
                                      {option.icon}
                                    </span>
                                    <span className="truncate">
                                      {option.label}
                                    </span>
                                  </button>
                                ))}
                              </div>
                            </div>
                          </div>
                        </div>,
                        document.body
                      )}
                  </div>

                  {/* Filter Modal */}
                  {showSearchFilterModal &&
                    createPortal(
                      <div
                        className="fixed inset-0 bg-black/60 backdrop-blur-sm z-[10003] flex items-end"
                        onClick={() => setShowSearchFilterModal(false)}
                      >
                        <div
                          className="w-full bg-gray-900/95 backdrop-blur-xl border-t border-gray-700/50 rounded-t-3xl shadow-2xl animate-in slide-in-from-bottom-8 duration-300"
                          onClick={(e) => e.stopPropagation()}
                        >
                          {/* Handle Bar */}
                          <div className="flex justify-center pt-3 pb-2">
                            <div className="w-12 h-1.5 bg-gray-600 rounded-full"></div>
                          </div>

                          {/* Header */}
                          <div className="px-6 py-4 border-b border-gray-700/50">
                            <div className="flex items-center justify-between mb-2">
                              <div className="flex items-center gap-2">
                                <h3 className="text-xl font-bold text-white">
                                  Filters
                                </h3>
                                {Object.values(activeFilters).some(
                                  (filters) => filters.length > 0
                                ) && (
                                  <span className="bg-blue-500/20 border border-blue-500/50 text-blue-300 text-xs font-semibold rounded-full px-2.5 py-0.5">
                                    {Object.values(activeFilters).reduce(
                                      (total, filters) =>
                                        total + filters.length,
                                      0
                                    )}{" "}
                                    Active
                                  </span>
                                )}
                              </div>
                              {Object.values(activeFilters).some(
                                (filters) => filters.length > 0
                              ) && (
                                <button
                                  onClick={() =>
                                    setActiveFilters({
                                      language: [],
                                      products: [],
                                      energy: [],
                                      cardType: [],
                                      rarity: [],
                                      variant: [],
                                      regulation: [],
                                      format: [],
                                      condition: [],
                                    })
                                  }
                                  className="text-sm font-medium text-red-400 hover:text-red-300 transition-colors duration-200 flex items-center gap-1.5"
                                >
                                  <svg
                                    className="w-4 h-4"
                                    fill="none"
                                    stroke="currentColor"
                                    viewBox="0 0 24 24"
                                  >
                                    <path
                                      strokeLinecap="round"
                                      strokeLinejoin="round"
                                      strokeWidth="2"
                                      d="M6 18L18 6M6 6l12 12"
                                    />
                                  </svg>
                                  Clear All
                                </button>
                              )}
                            </div>
                            <p className="text-sm text-gray-400">
                              Refine your search results
                            </p>
                          </div>

                          {/* Filter Content */}
                          <div className="p-6 max-h-[70vh] overflow-y-auto">
                            {/* Language Filter */}
                            <div className="mb-6">
                              <div className="flex items-center gap-2 mb-3">
                                <div className="w-1 h-4 bg-blue-400 rounded-full"></div>
                                <h4 className="text-white text-sm font-semibold tracking-wide uppercase">
                                  Language
                                </h4>
                              </div>
                              <div className="flex flex-wrap gap-2">
                                {["English", "Japanese", "Chinese"].map(
                                  (language) => (
                                    <button
                                      key={language}
                                      onClick={() => {
                                        if (
                                          activeFilters.language.includes(
                                            language
                                          )
                                        ) {
                                          setActiveFilters((prev) => ({
                                            ...prev,
                                            language: prev.language.filter(
                                              (l) => l !== language
                                            ),
                                          }));
                                        } else {
                                          setActiveFilters((prev) => ({
                                            ...prev,
                                            language: [
                                              ...prev.language,
                                              language,
                                            ],
                                          }));
                                        }
                                      }}
                                      className={`px-4 py-2.5 rounded-full text-sm font-medium transition-all duration-200 border ${
                                        activeFilters.language.includes(
                                          language
                                        )
                                          ? "bg-blue-500/20 border-blue-500/50 text-blue-300 shadow-lg shadow-blue-500/20 backdrop-blur-xl"
                                          : "bg-white/5 border-gray-600/30 text-gray-300 hover:bg-white/10 hover:border-gray-500/50 hover:text-white backdrop-blur-md"
                                      }`}
                                    >
                                      {language}
                                    </button>
                                  )
                                )}
                              </div>
                            </div>

                            {/* Products Filter */}
                            <div className="mb-6">
                              <div className="flex items-center gap-2 mb-3">
                                <div className="w-1 h-4 bg-green-400 rounded-full"></div>
                                <h4 className="text-white text-sm font-semibold tracking-wide uppercase">
                                  Products
                                </h4>
                              </div>
                              <div className="flex flex-wrap gap-2">
                                {["Cards", "Sealed"].map((product) => (
                                  <button
                                    key={product}
                                    onClick={() => {
                                      if (
                                        activeFilters.products.includes(product)
                                      ) {
                                        setActiveFilters((prev) => ({
                                          ...prev,
                                          products: prev.products.filter(
                                            (p) => p !== product
                                          ),
                                        }));
                                      } else {
                                        setActiveFilters((prev) => ({
                                          ...prev,
                                          products: [...prev.products, product],
                                        }));
                                      }
                                    }}
                                    className={`px-4 py-2.5 rounded-full text-sm font-medium transition-all duration-200 border ${
                                      activeFilters.products.includes(product)
                                        ? "bg-green-500/20 border-green-500/50 text-green-300 shadow-lg shadow-green-500/20 backdrop-blur-xl"
                                        : "bg-white/5 border-gray-600/30 text-gray-300 hover:bg-white/10 hover:border-gray-500/50 hover:text-white backdrop-blur-md"
                                    }`}
                                  >
                                    {product}
                                  </button>
                                ))}
                              </div>
                            </div>

                            {/* Energy Filter */}
                            <div className="mb-6">
                              <div className="flex items-center gap-2 mb-3">
                                <div className="w-1 h-4 bg-yellow-400 rounded-full"></div>
                                <h4 className="text-white text-sm font-semibold tracking-wide uppercase">
                                  Energy
                                </h4>
                              </div>
                              <div className="flex flex-wrap gap-2">
                                {[
                                  "Colorless",
                                  "Darkness",
                                  "Dragon",
                                  "Lightning",
                                  "Fairy",
                                  "Fighting",
                                  "Fire",
                                  "Grass",
                                  "Metal",
                                  "Psychic",
                                  "Water",
                                ].map((energy) => (
                                  <button
                                    key={energy}
                                    onClick={() => {
                                      if (
                                        activeFilters.energy.includes(energy)
                                      ) {
                                        setActiveFilters((prev) => ({
                                          ...prev,
                                          energy: prev.energy.filter(
                                            (e) => e !== energy
                                          ),
                                        }));
                                      } else {
                                        setActiveFilters((prev) => ({
                                          ...prev,
                                          energy: [...prev.energy, energy],
                                        }));
                                      }
                                    }}
                                    className={`px-4 py-2.5 rounded-full text-sm font-medium transition-all duration-200 border ${
                                      activeFilters.energy.includes(energy)
                                        ? "bg-yellow-500/20 border-yellow-500/50 text-yellow-300 shadow-lg shadow-yellow-500/20 backdrop-blur-xl"
                                        : "bg-white/5 border-gray-600/30 text-gray-300 hover:bg-white/10 hover:border-gray-500/50 hover:text-white backdrop-blur-md"
                                    }`}
                                  >
                                    {energy}
                                  </button>
                                ))}
                              </div>
                            </div>

                            {/* Card Type Filter */}
                            <div className="mb-6">
                              <div className="flex items-center gap-2 mb-3">
                                <div className="w-1 h-4 bg-purple-400 rounded-full"></div>
                                <h4 className="text-white text-sm font-semibold tracking-wide uppercase">
                                  Card Type
                                </h4>
                              </div>
                              <div className="flex flex-wrap gap-2">
                                {["Pokémon", "Trainer", "Energy"].map(
                                  (cardType) => (
                                    <button
                                      key={cardType}
                                      onClick={() => {
                                        if (
                                          activeFilters.cardType.includes(
                                            cardType
                                          )
                                        ) {
                                          setActiveFilters((prev) => ({
                                            ...prev,
                                            cardType: prev.cardType.filter(
                                              (ct) => ct !== cardType
                                            ),
                                          }));
                                        } else {
                                          setActiveFilters((prev) => ({
                                            ...prev,
                                            cardType: [
                                              ...prev.cardType,
                                              cardType,
                                            ],
                                          }));
                                        }
                                      }}
                                      className={`px-4 py-2.5 rounded-full text-sm font-medium transition-all duration-200 border ${
                                        activeFilters.cardType.includes(
                                          cardType
                                        )
                                          ? "bg-purple-500/20 border-purple-500/50 text-purple-300 shadow-lg shadow-purple-500/20 backdrop-blur-xl"
                                          : "bg-white/5 border-gray-600/30 text-gray-300 hover:bg-white/10 hover:border-gray-500/50 hover:text-white backdrop-blur-md"
                                      }`}
                                    >
                                      {cardType}
                                    </button>
                                  )
                                )}
                              </div>
                            </div>

                            {/* Rarity Filter */}
                            <div className="mb-6">
                              <div className="flex items-center gap-2 mb-3">
                                <div className="w-1 h-4 bg-pink-400 rounded-full"></div>
                                <h4 className="text-white text-sm font-semibold tracking-wide uppercase">
                                  Rarity
                                </h4>
                              </div>
                              <div className="space-y-4">
                                <div>
                                  <h5 className="text-gray-400 text-xs font-medium mb-2 uppercase tracking-wider">
                                    International
                                  </h5>
                                  <div className="flex flex-wrap gap-2">
                                    {[
                                      "Common",
                                      "Uncommon",
                                      "Rare",
                                      "Double Rare",
                                      "Ace Spec Rare",
                                      "Illustration Rare",
                                      "Ultra Rare",
                                      "Special Illustration Rare",
                                      "Hyper Rare",
                                      "Shiny Rare",
                                      "Shiny Ultra Rare",
                                      "Black Star Promo",
                                    ].map((rarity) => (
                                      <button
                                        key={rarity}
                                        onClick={() => {
                                          if (
                                            activeFilters.rarity.includes(
                                              rarity
                                            )
                                          ) {
                                            setActiveFilters((prev) => ({
                                              ...prev,
                                              rarity: prev.rarity.filter(
                                                (r) => r !== rarity
                                              ),
                                            }));
                                          } else {
                                            setActiveFilters((prev) => ({
                                              ...prev,
                                              rarity: [...prev.rarity, rarity],
                                            }));
                                          }
                                        }}
                                        className={`px-3 py-2 rounded-full text-xs font-medium transition-all duration-200 border ${
                                          activeFilters.rarity.includes(rarity)
                                            ? "bg-pink-500/20 border-pink-500/50 text-pink-300 shadow-lg shadow-pink-500/20 backdrop-blur-xl"
                                            : "bg-white/5 border-gray-600/30 text-gray-300 hover:bg-white/10 hover:border-gray-500/50 hover:text-white backdrop-blur-md"
                                        }`}
                                      >
                                        {rarity}
                                      </button>
                                    ))}
                                  </div>
                                </div>
                                <div>
                                  <h5 className="text-gray-400 text-xs font-medium mb-2 uppercase tracking-wider">
                                    Japanese
                                  </h5>
                                  <div className="flex flex-wrap gap-2">
                                    {[
                                      "Common",
                                      "Uncommon",
                                      "Rare",
                                      "Double Rare",
                                      "Ace Spec Rare",
                                      "Art Rare",
                                      "Super Rare",
                                      "Special Art Rare",
                                      "Ultra Rare",
                                      "Shiny Rare",
                                      "Shiny Super Rare",
                                      "Black Star Promo",
                                    ].map((rarity) => (
                                      <button
                                        key={`japanese-${rarity}`}
                                        onClick={() => {
                                          const rarityValue = `Japanese ${rarity}`;
                                          if (
                                            activeFilters.rarity.includes(
                                              rarityValue
                                            )
                                          ) {
                                            setActiveFilters((prev) => ({
                                              ...prev,
                                              rarity: prev.rarity.filter(
                                                (r) => r !== rarityValue
                                              ),
                                            }));
                                          } else {
                                            setActiveFilters((prev) => ({
                                              ...prev,
                                              rarity: [
                                                ...prev.rarity,
                                                rarityValue,
                                              ],
                                            }));
                                          }
                                        }}
                                        className={`px-3 py-2 rounded-full text-xs font-medium transition-all duration-200 border ${
                                          activeFilters.rarity.includes(
                                            `Japanese ${rarity}`
                                          )
                                            ? "bg-pink-500/20 border-pink-500/50 text-pink-300 shadow-lg shadow-pink-500/20 backdrop-blur-xl"
                                            : "bg-white/5 border-gray-600/30 text-gray-300 hover:bg-white/10 hover:border-gray-500/50 hover:text-white backdrop-blur-md"
                                        }`}
                                      >
                                        {rarity}
                                      </button>
                                    ))}
                                  </div>
                                </div>
                              </div>
                            </div>

                            {/* Variant Filter */}
                            <div className="mb-6">
                              <div className="flex items-center gap-2 mb-3">
                                <div className="w-1 h-4 bg-cyan-400 rounded-full"></div>
                                <h4 className="text-white text-sm font-semibold tracking-wide uppercase">
                                  Variant
                                </h4>
                              </div>
                              <div className="flex flex-wrap gap-2">
                                {[
                                  "Normal",
                                  "Holo",
                                  "Reverse Holo",
                                  "1st Edition",
                                ].map((variant) => (
                                  <button
                                    key={variant}
                                    onClick={() => {
                                      if (
                                        activeFilters.variant.includes(variant)
                                      ) {
                                        setActiveFilters((prev) => ({
                                          ...prev,
                                          variant: prev.variant.filter(
                                            (v) => v !== variant
                                          ),
                                        }));
                                      } else {
                                        setActiveFilters((prev) => ({
                                          ...prev,
                                          variant: [...prev.variant, variant],
                                        }));
                                      }
                                    }}
                                    className={`px-4 py-2.5 rounded-full text-sm font-medium transition-all duration-200 border ${
                                      activeFilters.variant.includes(variant)
                                        ? "bg-cyan-500/20 border-cyan-500/50 text-cyan-300 shadow-lg shadow-cyan-500/20 backdrop-blur-xl"
                                        : "bg-white/5 border-gray-600/30 text-gray-300 hover:bg-white/10 hover:border-gray-500/50 hover:text-white backdrop-blur-md"
                                    }`}
                                  >
                                    {variant}
                                  </button>
                                ))}
                              </div>
                            </div>

                            {/* Regulation Filter */}
                            <div className="mb-6">
                              <div className="flex items-center gap-2 mb-3">
                                <div className="w-1 h-4 bg-orange-400 rounded-full"></div>
                                <h4 className="text-white text-sm font-semibold tracking-wide uppercase">
                                  Regulation
                                </h4>
                              </div>
                              <div className="flex flex-wrap gap-2">
                                {[
                                  "A",
                                  "B",
                                  "C",
                                  "D",
                                  "E",
                                  "F",
                                  "G",
                                  "H",
                                  "I",
                                ].map((regulation) => (
                                  <button
                                    key={regulation}
                                    onClick={() => {
                                      if (
                                        activeFilters.regulation.includes(
                                          regulation
                                        )
                                      ) {
                                        setActiveFilters((prev) => ({
                                          ...prev,
                                          regulation: prev.regulation.filter(
                                            (r) => r !== regulation
                                          ),
                                        }));
                                      } else {
                                        setActiveFilters((prev) => ({
                                          ...prev,
                                          regulation: [
                                            ...prev.regulation,
                                            regulation,
                                          ],
                                        }));
                                      }
                                    }}
                                    className={`px-4 py-2.5 rounded-full text-sm font-medium transition-all duration-200 border ${
                                      activeFilters.regulation.includes(
                                        regulation
                                      )
                                        ? "bg-orange-500/20 border-orange-500/50 text-orange-300 shadow-lg shadow-orange-500/20 backdrop-blur-xl"
                                        : "bg-white/5 border-gray-600/30 text-gray-300 hover:bg-white/10 hover:border-gray-500/50 hover:text-white backdrop-blur-md"
                                    }`}
                                  >
                                    {regulation}
                                  </button>
                                ))}
                              </div>
                            </div>

                            {/* Format Filter */}
                            <div className="mb-6">
                              <div className="flex items-center gap-2 mb-3">
                                <div className="w-1 h-4 bg-indigo-400 rounded-full"></div>
                                <h4 className="text-white text-sm font-semibold tracking-wide uppercase">
                                  Format
                                </h4>
                              </div>
                              <div className="flex flex-wrap gap-2">
                                {["Unlimited", "Expanded", "Standard"].map(
                                  (format) => (
                                    <button
                                      key={format}
                                      onClick={() => {
                                        if (
                                          activeFilters.format.includes(format)
                                        ) {
                                          setActiveFilters((prev) => ({
                                            ...prev,
                                            format: prev.format.filter(
                                              (f) => f !== format
                                            ),
                                          }));
                                        } else {
                                          setActiveFilters((prev) => ({
                                            ...prev,
                                            format: [...prev.format, format],
                                          }));
                                        }
                                      }}
                                      className={`px-4 py-2.5 rounded-full text-sm font-medium transition-all duration-200 border ${
                                        activeFilters.format.includes(format)
                                          ? "bg-indigo-500/20 border-indigo-500/50 text-indigo-300 shadow-lg shadow-indigo-500/20 backdrop-blur-xl"
                                          : "bg-white/5 border-gray-600/30 text-gray-300 hover:bg-white/10 hover:border-gray-500/50 hover:text-white backdrop-blur-md"
                                      }`}
                                    >
                                      {format}
                                    </button>
                                  )
                                )}
                              </div>
                            </div>

                            {/* Condition Filter */}
                            <div className="mb-6">
                              <div className="flex items-center gap-2 mb-3">
                                <div className="w-1 h-4 bg-emerald-400 rounded-full"></div>
                                <h4 className="text-white text-sm font-semibold tracking-wide uppercase">
                                  Condition
                                </h4>
                              </div>
                              <div className="flex flex-wrap gap-2">
                                {[
                                  "Graded",
                                  "Near Mint",
                                  "Lightly Played",
                                  "Moderately Played",
                                  "Heavily Played",
                                  "Damaged",
                                ].map((condition) => (
                                  <button
                                    key={condition}
                                    onClick={() => {
                                      if (
                                        activeFilters.condition.includes(
                                          condition
                                        )
                                      ) {
                                        setActiveFilters((prev) => ({
                                          ...prev,
                                          condition: prev.condition.filter(
                                            (c) => c !== condition
                                          ),
                                        }));
                                      } else {
                                        setActiveFilters((prev) => ({
                                          ...prev,
                                          condition: [
                                            ...prev.condition,
                                            condition,
                                          ],
                                        }));
                                      }
                                    }}
                                    className={`px-4 py-2.5 rounded-full text-sm font-medium transition-all duration-200 border ${
                                      activeFilters.condition.includes(
                                        condition
                                      )
                                        ? "bg-emerald-500/20 border-emerald-500/50 text-emerald-300 shadow-lg shadow-emerald-500/20 backdrop-blur-xl"
                                        : "bg-white/5 border-gray-600/30 text-gray-300 hover:bg-white/10 hover:border-gray-500/50 hover:text-white backdrop-blur-md"
                                    }`}
                                  >
                                    {condition}
                                  </button>
                                ))}
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>,
                      document.body
                    )}
                </div>
              )}
            </div>

            {/* Content Area - Scrollable */}
            <div
              ref={searchResultsContainerRef}
              className="flex-1 overflow-y-auto"
              onScroll={handleScroll}
              style={{ WebkitOverflowScrolling: "touch" }}
            >
              {/* Search Results */}
              {showSearchResults && (
                <div className="mb-12">
                  <div className="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 2xl:grid-cols-7 gap-2 justify-items-center">
                    {filteredSearchResults.map((card, index) => {
                      // Extract set name with better fallbacks
                      const setName = (() => {
                        const raw =
                          (card.clean_set_name ||
                            card.set_name ||
                            card.set?.name ||
                            card.set?.ptcgoCode ||
                            card.set?.id ||
                            card.setId ||
                            card.setId ||
                            "Unknown Set") + "";
                        return raw
                          .replace(/^(SWSH\d+:\s*)/i, "")
                          .replace(/^(SV\d+:\s*)/i, "")
                          .replace(/^(SM\s*-\s*)/i, "")
                          .replace(/^(XY\s*-\s*)/i, "")
                          .replace(/^(ME\d+:\s*)/i, "")
                          .replace(/^(SVE:\s*)/i, "")
                          .replace(/^(SV:\s*)/i, "")
                          .trim();
                      })();

                      // Extract price - use current_value from API
                      const getCardPrice = (card) => {
                        if (!card) return 0;

                        // Use current_value from the API (this should be populated for all cards)
                        return card.current_value || card.price || 0;
                      };

                      const cardPrice = getCardPrice(card);

                      // Debug: Log price extraction for first few cards
                      if (index < 3) {
                        console.log(`Card ${index} price extraction:`, {
                          cardName: card.name,
                          originalPrice:
                            card.current_value || card.price || "none",
                          extractedPrice: cardPrice,
                          formattedPrice: formatCurrency(cardPrice),
                          setName: setName,
                        });
                      }

                      return (
                        <MarketplaceCard
                          key={`search-${card.id}-${index}`}
                          platform="Search"
                          cardName={
                            card.clean_name ||
                            card.cleanName ||
                            card.name ||
                            "Unknown Card"
                          }
                          setName={setName}
                          rarity={card.rarity || "Unknown"}
                          cardNumber={card.formattedNumber || ""}
                          price={formatCurrency(cardPrice)}
                          isCollection={false}
                          cardImage={getCardImageUrl(card)}
                          onClick={() => handleCardClick(card)}
                          onAddToCollection={() => handleAddToCollection(card)}
                        />
                      );
                    })}
                  </div>

                  {filteredSearchResults.length === 0 && (
                    <div className="text-center py-8">
                      <p className="text-gray-400 text-sm">
                        No cards found matching your search.
                      </p>
                    </div>
                  )}
                </div>
              )}

              {/* Trending Cards Section - Only show when no search results */}
              {!showSearchResults && (
                <div className="mb-12 pb-20">
                  <div className="flex items-center justify-between mb-6">
                    <div className="flex items-center gap-2">
                      <svg
                        className="w-5 h-5 text-orange-400"
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                      >
                        <path
                          strokeLinecap="round"
                          strokeLinejoin="round"
                          strokeWidth="2"
                          d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"
                        />
                      </svg>
                      <h3 className="dark:text-white text-theme-primary font-medium">
                        Trending Now
                      </h3>
                    </div>
                    <button
                      onClick={() => setRefreshKey((prev) => prev + 1)}
                      className="text-sm dark:text-gray-400 text-theme-secondary dark:hover:text-white hover:text-theme-primary transition-colors flex items-center gap-1"
                    >
                      <svg
                        className="w-4 h-4"
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                      >
                        <path
                          strokeLinecap="round"
                          strokeLinejoin="round"
                          strokeWidth="2"
                          d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"
                        />
                      </svg>
                      Refresh
                    </button>
                  </div>
                  <div className="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 2xl:grid-cols-7 gap-3 sm:gap-4 md:gap-4 justify-items-center">
                    {allTrendingCards
                      .slice(0, visibleCardsCount)
                      .map((card, index) => (
                        <MarketplaceCard
                          key={`trending-${card.id}`}
                          platform="Trending"
                          cardName={
                            card.clean_name || card.cleanName || card.name
                          }
                          setName={card.set || card.set_name || "Unknown Set"}
                          rarity={card.rarity || "Unknown"}
                          cardNumber={card.formattedNumber || card.number || ""}
                          price={formatCurrency(
                            updatedCollectionPrices[card.cardId] ||
                              card.current_value ||
                              0
                          )}
                          isCollection={false}
                          cardImage={getCardImageUrl(card)}
                          onClick={() => handleCardClick(card)}
                          onAddToCollection={() => handleAddToCollection(card)}
                        />
                      ))}
                  </div>

                  {/* Load More Hint */}
                  {showLoadMoreHint &&
                    !isLoadingMore &&
                    visibleCardsCount < allTrendingCards.length && (
                      <div className="flex justify-center items-center py-4">
                        <div className="flex items-center gap-2 text-gray-500 text-sm">
                          <div className="w-2 h-2 bg-primary rounded-full animate-pulse"></div>
                          <span>Scroll down for more cards...</span>
                        </div>
                      </div>
                    )}

                  {/* Loading More Indicator */}
                  {isLoadingMore && (
                    <div className="flex justify-center items-center py-8">
                      <div className="flex items-center gap-3 text-gray-400">
                        <div className="animate-spin rounded-full h-6 w-6 border-2 border-gray-600 border-t-primary"></div>
                        <span className="text-sm font-medium">
                          Loading more trending cards...
                        </span>
                      </div>
                    </div>
                  )}

                  {/* Load More Button for Search Page Trending Cards */}
                  {allTrendingCards.length > visibleCardsCount && (
                    <div className="mt-8">
                      <div className="text-center text-gray-400 text-sm mb-2">
                        Showing {visibleCardsCount} of {allTrendingCards.length}{" "}
                        trending cards
                      </div>
                      <button
                        onClick={() =>
                          setVisibleCardsCount((prev) =>
                            Math.min(prev + 12, allTrendingCards.length)
                          )
                        }
                        className="w-full py-3 bg-gradient-to-r from-gray-700 to-gray-600 hover:from-gray-600 hover:to-gray-500 rounded-xl text-white text-sm font-medium transition-all duration-300 flex items-center justify-center gap-2"
                      >
                        <span>Load More Trending Cards</span>
                        <svg
                          className="w-4 h-4"
                          fill="none"
                          stroke="currentColor"
                          viewBox="0 0 24 24"
                        >
                          <path
                            strokeLinecap="round"
                            strokeLinejoin="round"
                            strokeWidth="2"
                            d="M19 9l-7 7-7-7"
                          />
                        </svg>
                      </button>
                    </div>
                  )}

                  {/* End of Results */}
                  {visibleCardsCount >= allTrendingCards.length && (
                    <div className="text-center py-8">
                      <p className="text-gray-400 text-sm">
                        You've reached the end of trending cards!
                      </p>
                    </div>
                  )}
                </div>
              )}
            </div>
          </div>
        )}

        {activeTab === "scan" && (
          <div className="px-1 sm:px-2 mb-6 max-w-7xl mx-auto">
            <div className="text-center">
              <div className="w-32 h-32 bg-gray-800 rounded-full mx-auto mb-4 flex items-center justify-center">
                <svg
                  className="w-16 h-16 text-gray-400"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    strokeLinecap="round"
                    strokeLinejoin="round"
                    strokeWidth="2"
                    d="M12 4v1m6 11h2m-6 0h-2v4m0-11v3m0 0h.01M12 12h4.01M16 20h4M4 12h4m12 0h.01M5 8h2a1 1 0 001-1V5a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1zm12 0h2a1 1 0 001-1V5a1 1 0 00-1-1h-2a1 1 0 00-1 1v2a1 1 0 001 1zM5 20h2a1 1 0 001-1v-2a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1z"
                  />
                </svg>
              </div>
              <h2 className="text-white text-xl font-semibold mb-2">
                Scan Card
              </h2>
              <p className="text-gray-400 mb-6">
                Point your camera at a card to identify it
              </p>
              <button className="bg-primary text-accent font-semibold py-3 px-8 rounded-xl">
                Start Scanning
              </button>
            </div>
          </div>
        )}

        {activeTab === "collection" && (
          <div className="px-2 sm:px-4 mb-6 pb-20 transition-all duration-300 ease-in-out animate-in fade-in-0 slide-in-from-bottom-4 max-w-7xl mx-auto relative z-10">
            {/* Collection Header with Dropdown */}
            <div className="mb-6">
              {/* Collection Dropdown and Price - Single Row */}
              <div className="flex items-center justify-between mb-4">
                <div className="relative">
                  <button
                    className="flex items-center gap-[7px] px-3 py-2 hover:bg-gray-600/20 rounded-lg transition-colors"
                    onClick={() =>
                      setShowCollectionDropdown(!showCollectionDropdown)
                    }
                  >
                    <div className="flex items-center gap-1">
                      <div className="flex items-center gap-0.5 shrink-0 dark:text-white text-theme-primary">
                        <span className="text-[14px] font-bold">
                          Collection
                        </span>
                        <span className="text-[12px] font-bold">:</span>
                      </div>
                      <div className="shrink-0 text-[#605DEC] text-[14px] font-bold">
                        <span className="truncate">
                          {userData?.collections?.find(
                            (c) => c.id === selectedCollection
                          )?.name || "My Personal Collection"}
                        </span>
                      </div>
                      <div className="relative shrink-0">
                        <svg
                          className={`w-4 h-4 dark:text-white text-theme-primary transition-transform flex-shrink-0 ${
                            showCollectionDropdown ? "rotate-180" : ""
                          }`}
                          fill="none"
                          stroke="currentColor"
                          viewBox="0 0 24 24"
                        >
                          <path
                            strokeLinecap="round"
                            strokeLinejoin="round"
                            strokeWidth="2"
                            d="M19 9l-7 7-7-7"
                          />
                        </svg>
                      </div>
                    </div>
                  </button>

                  {/* Collection Dropdown */}
                  {showCollectionDropdown && (
                    <div className="absolute top-full left-0 mt-2 w-64 bg-gray-900/95 backdrop-blur-md border border-gray-600/50 rounded-xl shadow-xl z-50">
                      <div className="p-2">
                        {userData?.collections?.map((collection) => (
                          <button
                            key={collection.id}
                            className={`w-full px-4 py-3 text-left text-sm rounded-lg transition-all duration-200 ${
                              selectedCollection === collection.id
                                ? "bg-blue-500/20 text-blue-300 font-medium"
                                : "text-white hover:bg-white/10"
                            }`}
                            onClick={() => {
                              setSelectedCollection(collection.id);
                              setShowCollectionDropdown(false);
                            }}
                          >
                            {collection.name}
                          </button>
                        ))}
                        <div className="border-t border-gray-600/50 my-2"></div>
                        <button
                          className="w-full px-4 py-3 text-left text-sm text-gray-300 hover:bg-white/10 hover:text-white transition-all duration-200 rounded-lg flex items-center gap-2"
                          onClick={() => {
                            setShowCreateCollectionModal(true);
                            setShowCollectionDropdown(false);
                          }}
                        >
                          <svg
                            className="w-4 h-4"
                            fill="none"
                            stroke="currentColor"
                            viewBox="0 0 24 24"
                          >
                            <path
                              strokeLinecap="round"
                              strokeLinejoin="round"
                              strokeWidth="2"
                              d="M12 4v16m8-8H4"
                            />
                          </svg>
                          Create New Collection
                        </button>
                      </div>
                    </div>
                  )}
                </div>

                {/* Collection Total Value */}
                <div className="dark:text-white text-theme-primary text-lg font-bold pr-4">
                  {formatCurrency(
                    userData?.collections?.find(
                      (c) => c.id === selectedCollection
                    )?.totalValue || 0
                  )}
                </div>
              </div>
            </div>

            {/* Collection Search Bar */}
            <div className="mb-4">
              <div className="relative">
                <input
                  type="text"
                  placeholder="Search your collection..."
                  value={collectionSearchQuery}
                  onChange={(e) => setCollectionSearchQuery(e.target.value)}
                  className="w-full pl-12 pr-10 py-3 dark:bg-white/5 bg-white/20 backdrop-blur-md border dark:border-white/10 border-theme rounded-xl dark:text-white text-theme-primary dark:placeholder-white/50 placeholder-theme-secondary focus:outline-none focus:ring-2 focus:ring-blue-500/50 focus:border-blue-500/50 shadow-xl transition-all duration-200"
                />
                <div className="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none z-10">
                  <svg
                    className="w-5 h-5 dark:text-white/70 text-theme-secondary"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      strokeLinecap="round"
                      strokeLinejoin="round"
                      strokeWidth="2"
                      d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"
                    />
                  </svg>
                </div>
                {collectionSearchQuery && (
                  <button
                    onClick={() => setCollectionSearchQuery("")}
                    className="absolute inset-y-0 right-0 pr-4 flex items-center dark:text-white/70 dark:hover:text-white text-theme-secondary hover:text-theme-primary transition-colors duration-200 z-10"
                  >
                    <svg
                      className="w-5 h-5"
                      fill="none"
                      stroke="currentColor"
                      viewBox="0 0 24 24"
                    >
                      <path
                        strokeLinecap="round"
                        strokeLinejoin="round"
                        strokeWidth="2"
                        d="M6 18L18 6M6 6l12 12"
                      />
                    </svg>
                  </button>
                )}
              </div>
            </div>

            {/* Card Count and Sort/Filter Buttons */}
            <div className="flex items-center justify-between mb-6 mt-8">
              {/* Card Count */}
              <h2 className="dark:text-white text-theme-primary text-lg font-semibold">
                {(() => {
                  const collection = userData?.collections?.find(
                    (c) => c.id === selectedCollection
                  );
                  const cardCount = collection?.cards?.length || 0;
                  return `${cardCount} ${cardCount === 1 ? "Card" : "Cards"}`;
                })()}
              </h2>

              {/* Sort and Filter Buttons */}
              <div className="flex items-center gap-3">
                {/* Filter Button */}
                <button
                  className="flex items-center gap-2 px-3 py-2 bg-gray-800/90 backdrop-blur-md border border-gray-600/50 rounded-lg text-white text-sm hover:bg-gray-700/90 transition-all duration-200"
                  onClick={() => setShowFilterModal(true)}
                >
                  <svg
                    className="w-4 h-4"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      strokeLinecap="round"
                      strokeLinejoin="round"
                      strokeWidth="2"
                      d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"
                    />
                  </svg>
                  Filter
                  {(filterSettings.cardStatus !== "all" ||
                    filterSettings.languages.length > 0 ||
                    filterSettings.products.length > 0 ||
                    filterSettings.energies.length > 0 ||
                    filterSettings.supertype.length > 0 ||
                    filterSettings.rarities.length > 0 ||
                    filterSettings.variants.length > 0 ||
                    filterSettings.formats.length > 0 ||
                    filterSettings.regulationMarkings.length > 0 ||
                    filterSettings.conditions.length > 0) && (
                    <span className="bg-blue-500 text-white text-xs rounded-full px-2 py-0.5 min-w-[20px] text-center">
                      {[
                        filterSettings.cardStatus !== "all" ? 1 : 0,
                        filterSettings.languages.length,
                        filterSettings.products.length,
                        filterSettings.energies.length,
                        filterSettings.supertype.length,
                        filterSettings.rarities.length,
                        filterSettings.variants.length,
                        filterSettings.formats.length,
                        filterSettings.regulationMarkings.length,
                        filterSettings.conditions.length,
                      ].reduce((a, b) => a + b, 0)}
                    </span>
                  )}
                  <svg
                    className={`w-4 h-4 transition-transform duration-200 ${
                      showFilterModal ? "rotate-180" : ""
                    }`}
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      strokeLinecap="round"
                      strokeLinejoin="round"
                      strokeWidth="2"
                      d="M19 9l-7 7-7-7"
                    />
                  </svg>
                </button>

                {/* Sort Button */}
                <div className="relative sort-dropdown">
                  <button
                    className="flex items-center gap-2 px-3 py-2 bg-gray-800/90 backdrop-blur-md border border-gray-600/50 rounded-lg text-white text-sm hover:bg-gray-700/90 transition-all duration-200"
                    onClick={() => setShowSortDropdown(!showSortDropdown)}
                  >
                    <svg
                      className="w-4 h-4"
                      fill="none"
                      stroke="currentColor"
                      viewBox="0 0 24 24"
                    >
                      <path
                        strokeLinecap="round"
                        strokeLinejoin="round"
                        strokeWidth="2"
                        d="M3 4h13M3 8h9m-9 4h6m4 0l4-4m0 0l4 4m-4-4v12"
                      />
                    </svg>
                    Sort
                    <svg
                      className={`w-4 h-4 transition-transform duration-200 ${
                        showSortDropdown ? "rotate-180" : ""
                      }`}
                      fill="none"
                      stroke="currentColor"
                      viewBox="0 0 24 24"
                    >
                      <path
                        strokeLinecap="round"
                        strokeLinejoin="round"
                        strokeWidth="2"
                        d="M19 9l-7 7-7-7"
                      />
                    </svg>
                  </button>

                  {showSortDropdown &&
                    createPortal(
                      <div
                        className="fixed inset-0 bg-black/60 backdrop-blur-sm z-[10003] flex items-end"
                        onClick={() => setShowSortDropdown(false)}
                      >
                        <div
                          className="w-full bg-gray-900/95 backdrop-blur-xl border-t border-gray-700/50 rounded-t-3xl shadow-2xl animate-in slide-in-from-bottom-8 duration-300"
                          onClick={(e) => e.stopPropagation()}
                        >
                          {/* Handle Bar */}
                          <div className="flex justify-center pt-3 pb-2">
                            <div className="w-12 h-1.5 bg-gray-600 rounded-full"></div>
                          </div>

                          {/* Header */}
                          <div className="px-6 py-4 border-b border-gray-700/50">
                            <h3 className="text-xl font-bold text-white mb-1">
                              Sort Collection
                            </h3>
                            <p className="text-sm text-gray-400">
                              Choose how to organize your cards
                            </p>
                          </div>

                          {/* Sort Options */}
                          <div className="p-4 max-h-[60vh] overflow-y-auto">
                            <div className="grid grid-cols-1 gap-2">
                              {[
                                {
                                  value: "trending",
                                  label: "Trending",
                                  icon: (
                                    <img
                                      src="/Assets/NewSort/Trending.svg"
                                      alt="Trending"
                                      className="w-5 h-5"
                                    />
                                  ),
                                },
                                {
                                  value: "name",
                                  label: "A-Z",
                                  icon: (
                                    <img
                                      src="/Assets/NewSort/A-Z.svg"
                                      alt="A-Z"
                                      className="w-5 h-5"
                                    />
                                  ),
                                },
                                {
                                  value: "name-desc",
                                  label: "Z-A",
                                  icon: (
                                    <img
                                      src="/Assets/NewSort/Z-A.svg"
                                      alt="Z-A"
                                      className="w-5 h-5"
                                    />
                                  ),
                                },
                                {
                                  value: "price",
                                  label: (
                                    <span>
                                      Price{" "}
                                      <span className="text-xs opacity-75">
                                        (Low to High)
                                      </span>
                                    </span>
                                  ),
                                  icon: (
                                    <img
                                      src="/Assets/NewSort/Price down.svg"
                                      alt="Price Low to High"
                                      className="w-5 h-5"
                                    />
                                  ),
                                },
                                {
                                  value: "price-desc",
                                  label: (
                                    <span>
                                      Price{" "}
                                      <span className="text-xs opacity-75">
                                        (High to Low)
                                      </span>
                                    </span>
                                  ),
                                  icon: (
                                    <img
                                      src="/Assets/NewSort/Price up.svg"
                                      alt="Price High to Low"
                                      className="w-5 h-5"
                                    />
                                  ),
                                },
                                {
                                  value: "number-asc",
                                  label: (
                                    <span>
                                      Number{" "}
                                      <span className="text-xs opacity-75">
                                        (Low to High)
                                      </span>
                                    </span>
                                  ),
                                  icon: (
                                    <img
                                      src="/Assets/NewSort/Number down.svg"
                                      alt="Number Low to High"
                                      className="w-5 h-5"
                                    />
                                  ),
                                },
                                {
                                  value: "number-desc",
                                  label: (
                                    <span>
                                      Number{" "}
                                      <span className="text-xs opacity-75">
                                        (High to Low)
                                      </span>
                                    </span>
                                  ),
                                  icon: (
                                    <img
                                      src="/Assets/NewSort/Number up.svg"
                                      alt="Number High to Low"
                                      className="w-5 h-5"
                                    />
                                  ),
                                },
                                {
                                  value: "date-added-oldest",
                                  label: (
                                    <span>
                                      Date Added{" "}
                                      <span className="text-xs opacity-75">
                                        (Oldest First)
                                      </span>
                                    </span>
                                  ),
                                  icon: (
                                    <img
                                      src="/Assets/NewSort/Date down.svg"
                                      alt="Date Oldest First"
                                      className="w-5 h-5"
                                    />
                                  ),
                                },
                                {
                                  value: "date-added-newest",
                                  label: (
                                    <span>
                                      Date Added{" "}
                                      <span className="text-xs opacity-75">
                                        (Newest First)
                                      </span>
                                    </span>
                                  ),
                                  icon: (
                                    <img
                                      src="/Assets/NewSort/Date up.svg"
                                      alt="Date Newest First"
                                      className="w-5 h-5"
                                    />
                                  ),
                                },
                              ].map((option) => (
                                <button
                                  key={option.value}
                                  className={`w-full flex items-center gap-4 px-4 py-4 rounded-xl text-sm transition-all duration-200 text-left border ${
                                    collectionSortOption === option.value
                                      ? "bg-blue-500/20 border-blue-500/50 text-blue-300 shadow-lg shadow-blue-500/20"
                                      : "bg-white/5 border-gray-700/50 text-white/80 hover:bg-white/10 hover:border-gray-600 hover:text-white"
                                  }`}
                                  onClick={() => {
                                    setCollectionSortOption(option.value);
                                    setShowSortDropdown(false);
                                  }}
                                >
                                  <span className="flex-shrink-0">
                                    {option.icon}
                                  </span>
                                  <span className="flex-1">{option.label}</span>
                                </button>
                              ))}
                            </div>
                          </div>
                        </div>
                      </div>,
                      document.body
                    )}
                </div>
              </div>
            </div>

            {/* Collection Cards Grid - Responsive */}
            <div className="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-5 lg:grid-cols-6 xl:grid-cols-7 gap-0.5">
              {(() => {
                try {
                  const collection = userData?.collections?.find(
                    (c) => c.id === selectedCollection
                  );
                  if (
                    !collection ||
                    !collection.cards ||
                    collection.cards.length === 0
                  ) {
                    return (
                      <div className="col-span-3 flex flex-col items-center justify-center py-12 min-h-[400px]">
                        <div className="w-16 h-16 bg-gray-600 rounded-full mx-auto mb-4 flex items-center justify-center">
                          <svg
                            className="w-8 h-8 text-gray-400"
                            fill="none"
                            stroke="currentColor"
                            viewBox="0 0 24 24"
                          >
                            <path
                              strokeLinecap="round"
                              strokeLinejoin="round"
                              strokeWidth="2"
                              d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"
                            />
                          </svg>
                        </div>
                        <h3 className="text-white text-lg font-semibold mb-2">
                          No Cards in Collection
                        </h3>
                        <p className="text-gray-400 mb-4 text-center max-w-md">
                          Start building your collection by scanning cards or
                          adding them from the marketplace.
                        </p>
                        <button
                          onClick={() => setShowScanner(true)}
                          className="px-6 py-2 bg-[#605DEC] hover:bg-[#4F46E5] text-white rounded-lg font-medium transition-colors"
                        >
                          Scan Cards
                        </button>
                      </div>
                    );
                  }

                  // Filter cards based on search query and filter settings
                  const filteredCards = collection.cards.filter((card) => {
                    // Search query filter
                    if (collectionSearchQuery.trim()) {
                      const searchTerm = collectionSearchQuery.toLowerCase();
                      const matchesSearch =
                        (card.name || "").toLowerCase().includes(searchTerm) ||
                        (card.set || "").toLowerCase().includes(searchTerm) ||
                        (card.rarity || "")
                          .toLowerCase()
                          .includes(searchTerm) ||
                        (card.formattedNumber || card.number || "")
                          .toLowerCase()
                          .includes(searchTerm);
                      if (!matchesSearch) return false;
                    }

                    // Card Status filter
                    if (filterSettings.cardStatus === "duplicates") {
                      // Show only cards with quantity > 1
                      const quantity = card.quantity || 1;
                      if (quantity <= 1) return false;
                    } else if (filterSettings.cardStatus === "wishlisted") {
                      // Show only wishlisted cards (this would need to be implemented in the card data structure)
                      // For now, we'll skip this filter as it's not in the current data structure
                    }
                    // If cardStatus is 'all', show all cards (no filtering)

                    // Languages filter
                    if (filterSettings.languages.length > 0) {
                      const cardLanguage = (
                        card.language || "english"
                      ).toLowerCase();
                      if (!filterSettings.languages.includes(cardLanguage))
                        return false;
                    }

                    // Products filter
                    if (filterSettings.products.length > 0) {
                      // For now, all cards are considered 'cards' type
                      // This would need to be implemented based on your data structure
                      if (!filterSettings.products.includes("cards"))
                        return false;
                    }

                    // Energies filter
                    if (filterSettings.energies.length > 0) {
                      const cardTypes = card.types || [];
                      const hasMatchingEnergy = filterSettings.energies.some(
                        (energy) =>
                          cardTypes.some(
                            (type) =>
                              type.toLowerCase() === energy.toLowerCase()
                          )
                      );
                      if (!hasMatchingEnergy) return false;
                    }

                    // Supertype filter
                    if (filterSettings.supertype.length > 0) {
                      const cardSupertype = (
                        card.supertype || "pokemon"
                      ).toLowerCase();
                      if (!filterSettings.supertype.includes(cardSupertype))
                        return false;
                    }

                    // Rarities filter
                    if (filterSettings.rarities.length > 0) {
                      const cardRarity = (card.rarity || "")
                        .toLowerCase()
                        .replace(/\s+/g, "_");
                      if (!filterSettings.rarities.includes(cardRarity))
                        return false;
                    }

                    // Variants filter
                    if (filterSettings.variants.length > 0) {
                      // This would need to be implemented based on your card data structure
                      // For now, we'll assume all cards are 'normal' variant
                      if (!filterSettings.variants.includes("Normal"))
                        return false;
                    }

                    // Formats filter
                    if (filterSettings.formats.length > 0) {
                      // This would need to be implemented based on your card data structure
                      // For now, we'll assume all cards are 'unlimited' format
                      if (!filterSettings.formats.includes("unlimited"))
                        return false;
                    }

                    // Regulation Markings filter
                    if (filterSettings.regulationMarkings.length > 0) {
                      // This would need to be implemented based on your card data structure
                      // For now, we'll skip this filter
                    }

                    // Conditions filter
                    if (filterSettings.conditions.length > 0) {
                      // This would need to be implemented based on your card data structure
                      // For now, we'll skip this filter
                    }

                    return true;
                  });

                  // Sort cards based on selected option
                  const sortedCards = [...filteredCards].sort((a, b) => {
                    switch (collectionSortOption) {
                      case "name":
                        return (a.name || "").localeCompare(b.name || "");
                      case "name-desc":
                        return (b.name || "").localeCompare(a.name || "");
                      case "price":
                        return (
                          (a.currentValue || a.current_value || a.price || 0) -
                          (b.currentValue || b.current_value || b.price || 0)
                        );
                      case "price-desc":
                        return (
                          (b.currentValue || b.current_value || b.price || 0) -
                          (a.currentValue || a.current_value || a.price || 0)
                        );
                      case "rarity":
                        return (a.rarity || "").localeCompare(b.rarity || "");
                      case "set":
                        return (a.set || "").localeCompare(b.set || "");
                      default:
                        return 0;
                    }
                  });

                  // Show no results message if search or filters return no cards
                  if (
                    sortedCards.length === 0 &&
                    (collectionSearchQuery.trim() ||
                      Object.values(filterSettings).some((arr) =>
                        Array.isArray(arr)
                          ? arr.length > 0
                          : arr !== "all" && arr !== "international"
                      ))
                  ) {
                    return (
                      <div className="col-span-2 text-center py-12">
                        <div className="w-16 h-16 bg-gray-600 rounded-full mx-auto mb-4 flex items-center justify-center">
                          <svg
                            className="w-8 h-8 text-gray-400"
                            fill="none"
                            stroke="currentColor"
                            viewBox="0 0 24 24"
                          >
                            <path
                              strokeLinecap="round"
                              strokeLinejoin="round"
                              strokeWidth="2"
                              d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"
                            />
                          </svg>
                        </div>
                        <h3 className="dark:text-white text-theme-primary text-lg font-semibold mb-2">
                          No Cards Found
                        </h3>
                        <p className="dark:text-gray-400 text-theme-secondary mb-4">
                          {collectionSearchQuery.trim()
                            ? `No cards match your search for "${collectionSearchQuery}"`
                            : "No cards match your current filter settings"}
                        </p>
                        <div className="flex gap-2 justify-center">
                          {collectionSearchQuery.trim() && (
                            <button
                              onClick={() => setCollectionSearchQuery("")}
                              className="px-4 py-2 bg-gray-700 hover:bg-gray-600 text-white rounded-lg font-medium transition-colors"
                            >
                              Clear Search
                            </button>
                          )}
                          <button
                            onClick={() => {
                              setCollectionSearchQuery("");
                              setFilterSettings({
                                cardStatus: "all",
                                languages: [],
                                products: [],
                                energies: [],
                                supertype: [],
                                rarityType: "international",
                                rarities: [],
                                variants: [],
                                formats: [],
                                regulationMarkings: [],
                                conditions: [],
                              });
                            }}
                            className="px-4 py-2 bg-[#605DEC] hover:bg-[#4F46E5] text-white rounded-lg font-medium transition-colors"
                          >
                            Clear All Filters
                          </button>
                        </div>
                      </div>
                    );
                  }

                  return sortedCards.map((card, index) => {
                    const isSelected = selectedCollectionCards.has(card.id);

                    return (
                      <MarketplaceCard
                        key={card.id || index}
                        platform="Collection"
                        cardName={card.name}
                        setName={card.set || "Unknown Set"}
                        rarity={card.rarity}
                        cardNumber={card.formattedNumber || card.number}
                        price={formatCurrency(
                          updatedCollectionPrices[card.cardId] ||
                            card.currentValue ||
                            card.current_value ||
                            card.price ||
                            0
                        )}
                        isCollection={true}
                        isSelected={isSelected}
                        quantity={card.quantity || 1}
                        cardImage={getCardImageUrl(card)}
                        onClick={(e) => handleCollectionCardClick(e, card)}
                        onPressStart={(e) =>
                          handleCollectionCardPressStart(e, card)
                        }
                        onPressEnd={handleCollectionCardPressEnd}
                        onTouchStart={(e) =>
                          handleCollectionCardPressStart(e, card)
                        }
                        onTouchEnd={(e) =>
                          handleCollectionCardTouchEnd(e, card)
                        }
                        onTouchMove={handleCollectionCardTouchMove}
                      />
                    );
                  });
                } catch (error) {
                  console.error("Error rendering collection:", error);
                  return (
                    <div className="col-span-2 text-center py-12">
                      <div className="w-16 h-16 bg-red-700 rounded-full mx-auto mb-4 flex items-center justify-center">
                        <svg
                          className="w-8 h-8 text-red-400"
                          fill="none"
                          stroke="currentColor"
                          viewBox="0 0 24 24"
                        >
                          <path
                            strokeLinecap="round"
                            strokeLinejoin="round"
                            strokeWidth="2"
                            d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"
                          />
                        </svg>
                      </div>
                      <h3 className="text-red-400 text-lg font-semibold mb-2">
                        Error Loading Collection
                      </h3>
                      <p className="text-gray-400 mb-4">
                        There was an error loading your collection. Please try
                        again.
                      </p>
                      <button
                        onClick={() => window.location.reload()}
                        className="px-6 py-2 bg-red-600 hover:bg-red-500 text-white rounded-lg font-medium transition-colors"
                      >
                        Reload Page
                      </button>
                    </div>
                  );
                }
              })()}
            </div>

            {/* Collection Multi-Select Action Bar */}
            {isCollectionMultiSelectMode &&
              selectedCollectionCards.size > 0 &&
              createPortal(
                <div className="fixed bottom-0 left-0 right-0 bg-gray-800/95 backdrop-blur-sm border-t border-gray-600 z-[99999] collection-multi-select-bar">
                  <div className="px-4 py-4">
                    {/* Top Row - Selected count and Cancel */}
                    <div className="flex items-center justify-between mb-4">
                      <div className="flex items-center gap-3">
                        <span className="text-white text-base font-semibold">
                          {selectedCollectionCards.size} selected
                        </span>
                      </div>
                      <button
                        onClick={() => {
                          setIsCollectionMultiSelectMode(false);
                          setSelectedCollectionCards(new Set());
                        }}
                        className="text-gray-400 hover:text-white text-sm font-medium px-3 py-1 rounded-lg hover:bg-gray-700 transition-colors"
                      >
                        Cancel
                      </button>
                    </div>

                    {/* Bottom Row - Action Buttons */}
                    <div className="flex items-center justify-center gap-3">
                      <button
                        className="flex items-center gap-2 px-4 py-3 bg-gray-700 hover:bg-gray-600 rounded-lg transition-colors min-w-[80px] justify-center"
                        onClick={handleMoveToFolder}
                      >
                        <svg
                          className="w-5 h-5 dark:text-white text-theme-primary"
                          fill="none"
                          stroke="currentColor"
                          viewBox="0 0 24 24"
                        >
                          <path
                            strokeLinecap="round"
                            strokeLinejoin="round"
                            strokeWidth="2"
                            d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"
                          />
                        </svg>
                        <span className="text-white text-sm font-medium">
                          Move
                        </span>
                      </button>

                      <button
                        className="flex items-center gap-2 px-4 py-3 bg-gray-700 hover:bg-gray-600 rounded-lg transition-colors min-w-[80px] justify-center"
                        onClick={handleAddToDeck}
                      >
                        <svg
                          className="w-5 h-5 dark:text-white text-theme-primary"
                          fill="none"
                          stroke="currentColor"
                          viewBox="0 0 24 24"
                        >
                          <path
                            strokeLinecap="round"
                            strokeLinejoin="round"
                            strokeWidth="2"
                            d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"
                          />
                        </svg>
                        <span className="text-white text-sm font-medium">
                          Deck
                        </span>
                      </button>

                      <button
                        className="flex items-center gap-2 px-4 py-3 bg-gray-700 hover:bg-gray-600 rounded-lg transition-colors min-w-[80px] justify-center"
                        onClick={handleAddToBinder}
                      >
                        <svg
                          className="w-5 h-5 dark:text-white text-theme-primary"
                          fill="none"
                          stroke="currentColor"
                          viewBox="0 0 24 24"
                        >
                          <path
                            strokeLinecap="round"
                            strokeLinejoin="round"
                            strokeWidth="2"
                            d="M4 5a1 1 0 011-1h14a1 1 0 011 1v2a1 1 0 01-1 1H5a1 1 0 01-1-1V5zM4 13a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H5a1 1 0 01-1-1v-6zM16 13a1 1 0 011-1h2a1 1 0 011 1v6a1 1 0 01-1 1h-2a1 1 0 01-1-1v-6z"
                          />
                        </svg>
                        <span className="text-white text-sm font-medium">
                          Binder
                        </span>
                      </button>

                      <button
                        className="flex items-center gap-2 px-4 py-3 bg-red-600 hover:bg-red-500 rounded-lg transition-colors min-w-[80px] justify-center"
                        onClick={async () => {
                          const cardIds = Array.from(selectedCollectionCards);
                          if (cardIds.length === 0) return;

                          const totalQuantity = cardIds.reduce(
                            (sum, cardId) => {
                              const card = myCardEntries.find(
                                (entry) => entry.id === cardId
                              );
                              return sum + (card?.quantity || 1);
                            },
                            0
                          );

                          if (
                            confirm(
                              `Remove ${cardIds.length} card${
                                cardIds.length !== 1 ? "s" : ""
                              } (${totalQuantity} total) from your collection?`
                            )
                          ) {
                            let successCount = 0;

                            for (const cardId of cardIds) {
                              const success =
                                userDatabase.removeCardFromCollection(
                                  selectedCollection,
                                  cardId
                                );
                              if (success) successCount++;
                            }

                            if (successCount > 0) {
                              // Clear selection and exit multi-select mode
                              setSelectedCollectionCards(new Set());
                              setIsCollectionMultiSelectMode(false);

                              // Refresh the collection data
                              const updatedUserData =
                                userDatabase.getUserData();
                              setUserData(updatedUserData);

                              // Update myCardEntries
                              const updatedCollection =
                                updatedUserData?.collections?.find(
                                  (c) => c.id === selectedCollection
                                );
                              if (updatedCollection) {
                                setMyCardEntries(updatedCollection.cards || []);
                              }

                              console.log(
                                `Successfully removed ${successCount} card${
                                  successCount !== 1 ? "s" : ""
                                } from collection`
                              );
                            } else {
                              alert(
                                "Failed to remove cards. Please try again."
                              );
                            }
                          }
                        }}
                      >
                        <svg
                          className="w-5 h-5 dark:text-white text-theme-primary"
                          fill="none"
                          stroke="currentColor"
                          viewBox="0 0 24 24"
                        >
                          <path
                            strokeLinecap="round"
                            strokeLinejoin="round"
                            strokeWidth="2"
                            d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"
                          />
                        </svg>
                        <span className="text-white text-sm font-medium">
                          Remove
                        </span>
                      </button>
                    </div>
                  </div>
                </div>,
                document.body
              )}

            {/* Move to Folder Modal */}
            {showMoveToFolderModal && (
              <div
                className="fixed inset-0 bg-black/50 backdrop-blur-sm z-[110] flex items-center justify-center p-4"
                onClick={() => setShowMoveToFolderModal(false)}
              >
                <div
                  className="bg-gray-800 rounded-xl p-6 mx-4 max-w-md w-full move-to-folder-modal"
                  onClick={(e) => e.stopPropagation()}
                >
                  <div className="text-center mb-6">
                    <h3 className="text-white text-lg font-semibold mb-2">
                      Move to Folder
                    </h3>
                    <p className="text-gray-400 text-sm">
                      Select a folder to move {selectedCollectionCards.size}{" "}
                      card{selectedCollectionCards.size !== 1 ? "s" : ""} to
                    </p>
                  </div>

                  <div className="space-y-2 mb-6 max-h-64 overflow-y-auto">
                    {availableFolders.length > 0 ? (
                      availableFolders.map((folder) => (
                        <button
                          key={folder.id}
                          className="w-full flex items-center gap-3 px-4 py-3 bg-gray-700 hover:bg-gray-600 rounded-lg transition-colors text-left"
                          onClick={() => handleFolderSelection(folder.id)}
                        >
                          <div
                            className="w-4 h-4 rounded-full flex-shrink-0"
                            style={{ backgroundColor: folder.color }}
                          ></div>
                          <span className="text-white font-medium">
                            {folder.name}
                          </span>
                        </button>
                      ))
                    ) : (
                      <div className="text-center py-8">
                        <div className="w-16 h-16 bg-gray-600 rounded-full mx-auto mb-4 flex items-center justify-center">
                          <svg
                            className="w-8 h-8 text-gray-400"
                            fill="none"
                            stroke="currentColor"
                            viewBox="0 0 24 24"
                          >
                            <path
                              strokeLinecap="round"
                              strokeLinejoin="round"
                              strokeWidth="2"
                              d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"
                            />
                          </svg>
                        </div>
                        <h4 className="text-white text-lg font-semibold mb-2">
                          No Other Collections
                        </h4>
                        <p className="text-gray-400 text-sm">
                          Create another collection to move cards to.
                        </p>
                      </div>
                    )}
                  </div>

                  <div className="flex gap-3">
                    <button
                      className="flex-1 px-4 py-2 bg-gray-600 hover:bg-gray-500 text-white rounded-lg transition-colors"
                      onClick={() => setShowMoveToFolderModal(false)}
                    >
                      Cancel
                    </button>
                    <button
                      className="flex-1 px-4 py-2 bg-[#605DEC] hover:bg-[#4F46E5] text-white rounded-lg transition-colors"
                      onClick={() => {
                        // TODO: Implement create new folder functionality
                        console.log("Create new folder");
                      }}
                    >
                      + New Folder
                    </button>
                  </div>
                </div>
              </div>
            )}

            {/* Add to Binder Modal */}
            {showAddToBinderModal && (
              <div
                className="fixed inset-0 bg-black/50 backdrop-blur-sm z-[110] flex items-center justify-center p-4"
                onClick={() => setShowAddToBinderModal(false)}
              >
                <div
                  className="bg-gray-800 rounded-xl p-6 mx-4 max-w-md w-full add-to-binder-modal"
                  onClick={(e) => e.stopPropagation()}
                >
                  <div className="text-center mb-6">
                    <h3 className="text-white text-lg font-semibold mb-2">
                      Add to Binder
                    </h3>
                    <p className="text-gray-400 text-sm">
                      Select a binder to add {selectedCollectionCards.size} card
                      {selectedCollectionCards.size !== 1 ? "s" : ""} to
                    </p>
                  </div>

                  <div className="space-y-2 mb-6 max-h-64 overflow-y-auto">
                    {availableBinders.length > 0 ? (
                      availableBinders.map((binder) => (
                        <button
                          key={binder.id}
                          className="w-full flex items-center justify-between px-4 py-3 bg-gray-700 hover:bg-gray-600 rounded-lg transition-colors text-left"
                          onClick={() => handleBinderSelection(binder.id)}
                        >
                          <div className="flex items-center gap-3">
                            <div
                              className="w-4 h-4 rounded-full flex-shrink-0"
                              style={{ backgroundColor: binder.color }}
                            ></div>
                            <span className="dark:text-white text-theme-primary font-medium">
                              {binder.name}
                            </span>
                          </div>
                          <span className="text-gray-400 text-sm">
                            {binder.cardCount} cards
                          </span>
                        </button>
                      ))
                    ) : (
                      <div className="text-center py-8">
                        <div className="w-16 h-16 bg-gray-600 rounded-full mx-auto mb-4 flex items-center justify-center">
                          <svg
                            className="w-8 h-8 text-gray-400"
                            fill="none"
                            stroke="currentColor"
                            viewBox="0 0 24 24"
                          >
                            <path
                              strokeLinecap="round"
                              strokeLinejoin="round"
                              strokeWidth="2"
                              d="M4 5a1 1 0 011-1h14a1 1 0 011 1v2a1 1 0 01-1 1H5a1 1 0 01-1-1V5zM4 13a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H5a1 1 0 01-1-1v-6zM16 13a1 1 0 011-1h2a1 1 0 011 1v6a1 1 0 01-1 1h-2a1 1 0 01-1-1v-6z"
                            />
                          </svg>
                        </div>
                        <h4 className="text-white text-lg font-semibold mb-2">
                          No Binders Available
                        </h4>
                        <p className="text-gray-400 text-sm">
                          Create a binder to add cards to.
                        </p>
                      </div>
                    )}
                  </div>

                  <div className="flex gap-3">
                    <button
                      className="flex-1 px-4 py-2 bg-gray-600 hover:bg-gray-500 text-white rounded-lg transition-colors"
                      onClick={() => setShowAddToBinderModal(false)}
                    >
                      Cancel
                    </button>
                    <button
                      className="flex-1 px-4 py-2 bg-[#605DEC] hover:bg-[#4F46E5] text-white rounded-lg transition-colors"
                      onClick={() => {
                        // TODO: Implement create new binder functionality
                        console.log("Create new binder");
                      }}
                    >
                      + New Binder
                    </button>
                  </div>
                </div>
              </div>
            )}
          </div>
        )}

        {activeTab === "marketplace" && (
          <div className="px-2 sm:px-4 mb-6 pb-20 transition-all duration-300 ease-in-out animate-in fade-in-0 slide-in-from-bottom-4 max-w-7xl mx-auto relative z-10">
            {/* Coming Soon Message */}
            <div className="flex flex-col items-center justify-center min-h-[60vh] text-center px-4">
              <div className="mb-6">
                <svg
                  className="w-24 h-24 mx-auto dark:text-blue-400 text-[#605DEC] mb-4"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    strokeLinecap="round"
                    strokeLinejoin="round"
                    strokeWidth="1.5"
                    d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z"
                  />
                </svg>
              </div>
              <h2 className="dark:text-white text-theme-primary text-3xl font-bold mb-4">
                Marketplace
                <br />
                Coming Soon
              </h2>
              <p className="dark:text-gray-400 text-theme-secondary text-lg max-w-md mb-6 leading-relaxed">
                We're working hard to bring you an amazing marketplace
                experience. Soon you'll be able to buy cards from trusted
                sellers all in one place!
              </p>
              <div className="flex items-center gap-2 dark:text-gray-500 text-theme-secondary text-sm">
                <svg
                  className="w-5 h-5"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    strokeLinecap="round"
                    strokeLinejoin="round"
                    strokeWidth="2"
                    d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"
                  />
                </svg>
                <span>Stay tuned for updates!</span>
              </div>
            </div>
          </div>
        )}

        {navigationMode === "deck-builder" && (
          <DeckBuilder
            onBack={() => {
              if (
                previousNavigationMode &&
                (previousNavigationMode === "binder" ||
                  previousNavigationMode === "deck-builder")
              ) {
                // Navigating between deck-builder and binder
                setActiveTab(previousNavigationMode);
                setNavigationMode(previousNavigationMode);
              } else if (previousTab) {
                setActiveTab(previousTab);
                setNavigationMode(previousTab);
              } else {
                setActiveTab("home");
                setNavigationMode("home");
              }
            }}
          />
        )}

        {navigationMode === "deck-builder" && (
          <DeckBuilder
            onBack={() => {
              if (
                previousNavigationMode &&
                (previousNavigationMode === "binder" ||
                  previousNavigationMode === "deck-builder")
              ) {
                // Navigating between deck-builder and binder
                setActiveTab(previousNavigationMode);
                setNavigationMode(previousNavigationMode);
              } else if (previousTab) {
                setActiveTab(previousTab);
                setNavigationMode(previousTab);
              } else {
                setActiveTab("home");
                setNavigationMode("home");
              }
            }}
          />
        )}

        {/* Old marketplace content removed - showing Coming Soon instead */}

        {navigationMode === "deck-builder" && (
          <DeckBuilder
            onBack={() => {
              if (
                previousNavigationMode &&
                (previousNavigationMode === "binder" ||
                  previousNavigationMode === "deck-builder")
              ) {
                // Navigating between deck-builder and binder
                setActiveTab(previousNavigationMode);
                setNavigationMode(previousNavigationMode);
              } else if (previousTab) {
                setActiveTab(previousTab);
                setNavigationMode(previousTab);
              } else {
                setActiveTab("home");
                setNavigationMode("home");
              }
            }}
          />
        )}

        {navigationMode === "community" && (
          <CommunityPage
            onBack={() => {
              if (
                previousNavigationMode &&
                (previousNavigationMode === "binder" ||
                  previousNavigationMode === "deck-builder")
              ) {
                // Navigating between deck-builder and binder
                setActiveTab(previousNavigationMode);
                setNavigationMode(previousNavigationMode);
              } else if (previousTab) {
                setActiveTab(previousTab);
                setNavigationMode(previousTab);
              } else {
                setActiveTab("home");
                setNavigationMode("home");
              }
            }}
          />
        )}

        {navigationMode === "sets" && (
          <SetsPage
            onBack={() => {
              if (previousTab) {
                setActiveTab(previousTab);
                setNavigationMode(previousTab);
              } else {
                setActiveTab("home");
                setNavigationMode("home");
              }
            }}
            onSetClick={handleSetClickWithData}
          />
        )}

        {navigationMode === "binder" && (
          <BinderBuilder
            onBack={() => {
              if (
                previousNavigationMode &&
                (previousNavigationMode === "binder" ||
                  previousNavigationMode === "deck-builder")
              ) {
                // Navigating between deck-builder and binder
                setActiveTab(previousNavigationMode);
                setNavigationMode(previousNavigationMode);
              } else if (previousTab) {
                setActiveTab(previousTab);
                setNavigationMode(previousTab);
              } else {
                setActiveTab("home");
                setNavigationMode("home");
              }
            }}
          />
        )}

        {navigationMode === "deck-builder" && (
          <DeckBuilder
            onBack={() => {
              if (
                previousNavigationMode &&
                (previousNavigationMode === "binder" ||
                  previousNavigationMode === "deck-builder")
              ) {
                // Navigating between deck-builder and binder
                setActiveTab(previousNavigationMode);
                setNavigationMode(previousNavigationMode);
              } else if (previousTab) {
                setActiveTab(previousTab);
                setNavigationMode(previousTab);
              } else {
                setActiveTab("home");
                setNavigationMode("home");
              }
            }}
          />
        )}

        {navigationMode === "binder" && (
          <BinderBuilder
            onBack={() => {
              if (
                previousNavigationMode &&
                (previousNavigationMode === "binder" ||
                  previousNavigationMode === "deck-builder")
              ) {
                // Navigating between deck-builder and binder
                setActiveTab(previousNavigationMode);
                setNavigationMode(previousNavigationMode);
              } else if (previousTab) {
                setActiveTab(previousTab);
                setNavigationMode(previousTab);
              } else {
                setActiveTab("home");
                setNavigationMode("home");
              }
            }}
          />
        )}

        {navigationMode === "community" && (
          <CommunityPage
            onBack={() => {
              if (
                previousNavigationMode &&
                (previousNavigationMode === "binder" ||
                  previousNavigationMode === "deck-builder" ||
                  previousNavigationMode === "sets" ||
                  previousNavigationMode === "community" ||
                  previousNavigationMode === "wishlist" ||
                  previousNavigationMode === "settings" ||
                  previousNavigationMode === "help")
              ) {
                setActiveTab(previousNavigationMode);
                setNavigationMode(previousNavigationMode);
              } else if (previousTab) {
                setActiveTab(previousTab);
                setNavigationMode(previousTab);
              } else {
                setActiveTab("home");
                setNavigationMode("home");
              }
            }}
            onNavigateToProfile={(userId) => {
              setViewingUserId(userId);
              setPreviousNavigationMode("community");
              setActiveTab("profile");
              setNavigationMode("profile");
            }}
          />
        )}

        {navigationMode === "wishlist" && (
          <WishlistPage
            onBack={() => {
              console.log("🔙 [WISHLIST] Back button clicked");
              console.log("🔙 [WISHLIST] Current state:", {
                previousNavigationMode,
                previousTab,
                activeTab,
                navigationMode,
              });

              // First, try to restore previous navigation mode (for special pages)
              if (
                previousNavigationMode &&
                previousNavigationMode !== "wishlist"
              ) {
                console.log(
                  "🔙 [WISHLIST] Restoring navigationMode:",
                  previousNavigationMode
                );
                // If it's a special page mode, also set it as active tab
                if (
                  [
                    "binder",
                    "deck-builder",
                    "sets",
                    "community",
                    "settings",
                    "help",
                  ].includes(previousNavigationMode)
                ) {
                  setActiveTab(previousNavigationMode);
                }
                setNavigationMode(previousNavigationMode);
                // Clear wishlist navigation
                if (navigationMode === "wishlist") {
                  // Navigation will be updated by setNavigationMode above
                }
                return;
              }

              // Otherwise, restore previous tab
              if (previousTab && previousTab !== "wishlist") {
                console.log("🔙 [WISHLIST] Restoring tab:", previousTab);
                setActiveTab(previousTab);
                setNavigationMode(previousTab);
                return;
              }

              // Default fallback to home
              console.log("🔙 [WISHLIST] Defaulting to home");
              setActiveTab("home");
              setNavigationMode("home");
            }}
            onCardClick={(card) => {
              if (card) {
                setSelectedCard(card);
                setShowCardProfile(true);
              }
            }}
          />
        )}

        {navigationMode === "settings" && (
          <SettingsPage
            onBack={() => {
              if (
                previousNavigationMode &&
                (previousNavigationMode === "binder" ||
                  previousNavigationMode === "deck-builder" ||
                  previousNavigationMode === "sets" ||
                  previousNavigationMode === "community" ||
                  previousNavigationMode === "wishlist" ||
                  previousNavigationMode === "settings" ||
                  previousNavigationMode === "help")
              ) {
                setActiveTab(previousNavigationMode);
                setNavigationMode(previousNavigationMode);
              } else if (previousTab) {
                setActiveTab(previousTab);
                setNavigationMode(previousTab);
              } else {
                setActiveTab("home");
                setNavigationMode("home");
              }
            }}
          />
        )}

        {navigationMode === "help" && (
          <HelpCenterPage
            onBack={() => {
              if (
                previousNavigationMode &&
                (previousNavigationMode === "binder" ||
                  previousNavigationMode === "deck-builder" ||
                  previousNavigationMode === "sets" ||
                  previousNavigationMode === "community" ||
                  previousNavigationMode === "wishlist" ||
                  previousNavigationMode === "settings" ||
                  previousNavigationMode === "help")
              ) {
                setActiveTab(previousNavigationMode);
                setNavigationMode(previousNavigationMode);
              } else if (previousTab) {
                setActiveTab(previousTab);
                setNavigationMode(previousTab);
              } else {
                setActiveTab("home");
                setNavigationMode("home");
              }
            }}
          />
        )}

        {navigationMode === "sets" && (
          <SetsPage
            onBack={() => {
              if (
                previousNavigationMode &&
                (previousNavigationMode === "binder" ||
                  previousNavigationMode === "deck-builder" ||
                  previousNavigationMode === "sets" ||
                  previousNavigationMode === "community" ||
                  previousNavigationMode === "wishlist" ||
                  previousNavigationMode === "settings" ||
                  previousNavigationMode === "help")
              ) {
                setActiveTab(previousNavigationMode);
                setNavigationMode(previousNavigationMode);
              } else if (previousTab) {
                setActiveTab(previousTab);
                setNavigationMode(previousTab);
              } else {
                setActiveTab("home");
                setNavigationMode("home");
              }
            }}
            onSetClick={handleSetClickWithData}
          />
        )}

        {activeTab === "profile" &&
          (() => {
            // Determine if viewing another user's profile
            const isViewingOtherUser =
              viewingUserId !== null &&
              viewingUserId !== undefined &&
              viewingUserId !== user?.id;

            // Mock data for other users (in a real app, this would come from an API)
            const getViewingUserData = () => {
              if (!isViewingOtherUser) return null;

              // Mock user data based on userId
              if (viewingUserId === 999) {
                // Calculate stats from userData if available (for Guest User who has collections)
                let calculatedCards = 0;
                let calculatedValue = 0;

                if (userData?.collections) {
                  userData.collections.forEach((collection) => {
                    calculatedCards += collection.cards?.length || 0;
                    calculatedValue += collection.totalValue || 0;
                  });
                }

                return {
                  id: 999,
                  name: "Guest User",
                  username: "guestuser",
                  fullName: "Guest User",
                  profileImage: null,
                  isPro: false,
                  joinedAt: new Date(Date.now() - 30 * 24 * 60 * 60 * 1000), // 30 days ago
                  followers: 0,
                  following: 0,
                  totalCards: calculatedCards || 0,
                  totalValue: calculatedValue || 0,
                };
              }

              // Default mock user
              return {
                id: viewingUserId,
                name: `User ${viewingUserId}`,
                username: `user${viewingUserId}`,
                fullName: `User ${viewingUserId}`,
                profileImage: null,
                isPro: false,
                joinedAt: new Date(Date.now() - 60 * 24 * 60 * 60 * 1000),
                followers: Math.floor(Math.random() * 1000),
                following: Math.floor(Math.random() * 500),
                totalCards: Math.floor(Math.random() * 500),
                totalValue: Math.random() * 1000,
              };
            };

            const viewingUser = isViewingOtherUser
              ? getViewingUserData()
              : null;
            const displayUser = isViewingOtherUser ? viewingUser : user;
            const isFollowing = viewingUserId
              ? followingUsers.has(viewingUserId)
              : false;

            // Calculate stats from userData if userStats is not available
            const calculateStatsFromUserData = () => {
              if (!userData?.collections) return null;

              let totalCards = 0;
              let totalValue = 0;

              userData.collections.forEach((collection) => {
                totalCards += collection.cards?.length || 0;
                totalValue += collection.totalValue || 0;
              });

              return {
                totalCards,
                totalValue,
                followers: 0, // Would come from API in real app
                following: 0, // Would come from API in real app
              };
            };

            // Get stats for viewing user or current user
            const viewingUserStats = viewingUser
              ? {
                  totalCards: viewingUser.totalCards || 0,
                  totalValue: viewingUser.totalValue || 0,
                  followers: viewingUser.followers || 0,
                  following: viewingUser.following || 0,
                }
              : null;

            // Use userStats if available, otherwise calculate from userData
            const currentUserStats = userStats || calculateStatsFromUserData();
            const displayStats = isViewingOtherUser
              ? viewingUserStats
              : currentUserStats;

            const handleToggleFollow = () => {
              if (!viewingUserId) return;
              setFollowingUsers((prev) => {
                const next = new Set(prev);
                if (next.has(viewingUserId)) {
                  next.delete(viewingUserId);
                } else {
                  next.add(viewingUserId);
                }
                return next;
              });
            };

            return (
              <div className="pb-32">
                {/* Back Button - Only show when viewing another user */}
                {isViewingOtherUser && (
                  <div className="px-6 pt-4 pb-2">
                    <button
                      onClick={() => {
                        setViewingUserId(null);
                        if (previousNavigationMode) {
                          setNavigationMode(previousNavigationMode);
                          setActiveTab(
                            previousNavigationMode === "community"
                              ? "community"
                              : "home"
                          );
                        } else {
                          setNavigationMode("home");
                          setActiveTab("home");
                        }
                      }}
                      className="flex items-center gap-2 dark:text-gray-400 dark:hover:text-white text-theme-secondary hover:text-theme-primary transition-colors"
                    >
                      <svg
                        className="w-5 h-5"
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                      >
                        <path
                          strokeLinecap="round"
                          strokeLinejoin="round"
                          strokeWidth="2"
                          d="M15 19l-7-7 7-7"
                        />
                      </svg>
                      <span>Back</span>
                    </button>
                  </div>
                )}

                {/* Cover Photo */}
                <div
                  className="relative backdrop-blur-sm overflow-hidden"
                  style={{ height: "188px" }}
                >
                  {/* Cover background - solid color with optional image overlay */}
                  {coverPhotoPreview ? (
                    <img
                      src={coverPhotoPreview}
                      alt="Cover"
                      className="absolute inset-0 w-full h-full object-cover opacity-60"
                    />
                  ) : (
                    <div className="absolute inset-0 bg-gradient-to-br from-[#6865E7] via-[#5B59D9] to-[#4F4DCB] dark:from-[#6865E7] dark:via-[#5B59D9] dark:to-[#4F4DCB]"></div>
                  )}
                  {/* Top gradient fade to soften the harsh edge */}
                  <div
                    className="absolute inset-0 bg-gradient-to-b from-black/80 via-black/20 to-transparent"
                    style={{ height: "80px" }}
                  ></div>
                  <div className="absolute inset-0 bg-gradient-to-b from-transparent to-gray-900/80"></div>
                </div>

                {/* Profile Header */}
                <div className="relative px-6 -mt-4">
                  <div className="flex items-start justify-between mb-4">
                    <div className="flex items-end gap-4">
                      {/* Profile Picture */}
                      <div className="relative">
                        <div className="w-24 h-24 rounded-full bg-gradient-to-br from-blue-500 to-purple-600 p-1 shadow-2xl">
                          {!isViewingOtherUser && profilePicturePreview ? (
                            <img
                              src={profilePicturePreview}
                              alt="Profile"
                              className="w-full h-full rounded-full object-cover"
                            />
                          ) : displayUser?.profileImage ? (
                            <img
                              src={displayUser.profileImage}
                              alt="Profile"
                              className="w-full h-full rounded-full object-cover"
                            />
                          ) : (
                            <div className="w-full h-full rounded-full dark:bg-gray-900 bg-gray-300 flex items-center justify-center dark:text-white text-theme-primary text-3xl font-bold">
                              {displayUser?.fullName?.charAt(0) ||
                                displayUser?.username?.charAt(0) ||
                                displayUser?.name?.charAt(0) ||
                                "G"}
                            </div>
                          )}
                        </div>
                        {/* PRO Badge - Only show if user is pro */}
                        {displayUser?.isPro && (
                          <div className="absolute -bottom-1 -right-1 bg-gradient-to-r from-yellow-400 to-orange-500 text-gray-900 text-xs font-bold px-2 py-0.5 rounded-full shadow-lg">
                            PRO
                          </div>
                        )}
                      </div>

                      {/* Profile Info */}
                      <div className="mb-2">
                        <h1 className="dark:text-white text-theme-primary text-2xl font-bold">
                          {displayUser?.fullName ||
                            displayUser?.name ||
                            "Guest User"}
                        </h1>
                        <p className="dark:text-gray-400 text-theme-secondary text-sm">
                          @{displayUser?.username || "guest"}
                        </p>
                        <p className="dark:text-gray-500 text-theme-tertiary text-xs">
                          Joined{" "}
                          {displayUser?.joinedAt
                            ? new Date(displayUser.joinedAt).toLocaleDateString(
                                "en-US",
                                { month: "short", year: "numeric" }
                              )
                            : "Recently"}
                        </p>
                      </div>
                    </div>

                    {/* Action Buttons */}
                    <div className="flex gap-2 mt-6">
                      {isViewingOtherUser ? (
                        <>
                          <button
                            className={`px-4 py-2 rounded-lg text-sm font-medium transition-colors ${
                              isFollowing
                                ? "dark:bg-white/10 dark:text-gray-300 dark:hover:bg-white/20 bg-white/20 text-theme-primary hover:bg-white/30"
                                : "bg-gradient-to-r from-blue-500 to-indigo-600 text-white hover:from-blue-600 hover:to-indigo-700"
                            }`}
                            onClick={handleToggleFollow}
                          >
                            {isFollowing ? "Following" : "Follow"}
                          </button>
                          <button className="w-9 h-9 dark:bg-white/10 bg-white/20 backdrop-blur-md dark:hover:bg-white/20 hover:bg-white/30 rounded-lg flex items-center justify-center transition-colors dark:border-white/10 border-theme">
                            <svg
                              className="w-5 h-5 dark:text-white text-theme-primary"
                              fill="none"
                              stroke="currentColor"
                              viewBox="0 0 24 24"
                            >
                              <path
                                strokeLinecap="round"
                                strokeLinejoin="round"
                                strokeWidth="2"
                                d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z"
                              />
                            </svg>
                          </button>
                        </>
                      ) : (
                        <>
                          <button
                            className="w-9 h-9 dark:bg-white/10 bg-white/20 backdrop-blur-md dark:hover:bg-white/20 hover:bg-white/30 rounded-lg flex items-center justify-center transition-colors dark:border-white/10 border-theme"
                            onClick={() => {
                              // Initialize form values when opening modal
                              setEditDisplayName(user?.fullName || "");
                              setEditUsername(user?.username || "");
                              setEditTagline(user?.tagline || "");
                              setEditAboutMe(user?.aboutMe || "");
                              setEditSocialLinks(
                                user?.socialLinks || {
                                  twitter: "",
                                  instagram: "",
                                  youtube: "",
                                  tiktok: "",
                                  website: "",
                                }
                              );
                              setEditCollectingGoals(
                                user?.collectingGoals || []
                              );
                              setShowEditProfile(true);
                            }}
                          >
                            <svg
                              className="w-5 h-5 dark:text-white text-theme-primary"
                              fill="currentColor"
                              viewBox="0 0 20 20"
                            >
                              <path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z" />
                            </svg>
                          </button>
                          <button className="w-9 h-9 dark:bg-white/10 bg-white/20 backdrop-blur-md dark:hover:bg-white/20 hover:bg-white/30 rounded-lg flex items-center justify-center transition-colors dark:border-white/10 border-theme">
                            <svg
                              className="w-5 h-5 dark:text-white text-theme-primary"
                              fill="none"
                              stroke="currentColor"
                              viewBox="0 0 24 24"
                            >
                              <path
                                strokeLinecap="round"
                                strokeLinejoin="round"
                                strokeWidth="2"
                                d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z"
                              />
                            </svg>
                          </button>
                        </>
                      )}
                    </div>
                  </div>

                  {/* Stats Bar */}
                  <div className="flex justify-between mb-6 dark:bg-white/5 bg-white/20 backdrop-blur-md rounded-xl p-4 dark:border-white/10 border-theme">
                    <div className="text-center flex-1">
                      <p className="dark:text-white text-theme-primary text-lg font-bold">
                        {(displayStats?.totalCards || 0).toLocaleString()}
                      </p>
                      <p className="dark:text-gray-400 text-theme-secondary text-xs mt-1">
                        Cards collected
                      </p>
                    </div>
                    <div className="w-px dark:bg-white/10 bg-[#d2d3db] mx-2"></div>
                    <div className="text-center flex-1">
                      <p className="dark:text-white text-theme-primary text-lg font-bold">
                        ${(displayStats?.totalValue || 0).toFixed(2)}
                      </p>
                      <p className="dark:text-gray-400 text-theme-secondary text-xs mt-1">
                        Value
                      </p>
                    </div>
                    <div className="w-px dark:bg-white/10 bg-[#d2d3db] mx-2"></div>
                    <div className="text-center flex-1">
                      <p className="dark:text-white text-theme-primary text-lg font-bold">
                        {(displayStats?.followers || 0).toLocaleString()}
                      </p>
                      <p className="dark:text-gray-400 text-theme-secondary text-xs mt-1">
                        Followers
                      </p>
                    </div>
                    <div className="w-px dark:bg-white/10 bg-[#d2d3db] mx-2"></div>
                    <div className="text-center flex-1">
                      <p className="dark:text-white text-theme-primary text-lg font-bold">
                        {(displayStats?.following || 0).toLocaleString()}
                      </p>
                      <p className="dark:text-gray-400 text-theme-secondary text-xs mt-1">
                        Following
                      </p>
                    </div>
                  </div>

                  {/* Tab Navigation */}
                  <div className="relative mb-6">
                    <div className="flex gap-8 border-b dark:border-white/10 border-theme">
                      <button
                        className={`pb-3 text-sm font-medium transition-colors relative ${
                          profileTab === "stats"
                            ? "dark:text-white text-theme-primary"
                            : "dark:text-gray-400 dark:hover:text-white text-theme-secondary hover:text-theme-primary"
                        }`}
                        onClick={() => setProfileTab("stats")}
                      >
                        Stats
                        {profileTab === "stats" && (
                          <div className="absolute bottom-0 left-0 right-0 h-0.5 bg-gradient-to-r from-blue-500 to-purple-600"></div>
                        )}
                      </button>
                      <button
                        className={`pb-3 text-sm font-medium transition-colors relative ${
                          profileTab === "showcase"
                            ? "dark:text-white text-theme-primary"
                            : "dark:text-gray-400 dark:hover:text-white text-theme-secondary hover:text-theme-primary"
                        }`}
                        onClick={() => setProfileTab("showcase")}
                      >
                        Showcase
                        {profileTab === "showcase" && (
                          <div className="absolute bottom-0 left-0 right-0 h-0.5 bg-gradient-to-r from-blue-500 to-purple-600"></div>
                        )}
                      </button>
                      <button
                        className={`pb-3 text-sm font-medium transition-colors relative ${
                          profileTab === "about"
                            ? "dark:text-white text-theme-primary"
                            : "dark:text-gray-400 dark:hover:text-white text-theme-secondary hover:text-theme-primary"
                        }`}
                        onClick={() => setProfileTab("about")}
                      >
                        About
                        {profileTab === "about" && (
                          <div className="absolute bottom-0 left-0 right-0 h-0.5 bg-gradient-to-r from-blue-500 to-purple-600"></div>
                        )}
                      </button>
                    </div>
                  </div>

                  {/* Tab Content */}
                  {profileTab === "stats" && (
                    <div className="space-y-6">
                      {/* Price Chart */}
                      <div className="dark:bg-white/5 bg-white/20 backdrop-blur-md rounded-xl p-4 dark:border-white/10 border-theme">
                        <div className="flex items-center justify-between mb-4">
                          <div>
                            <div className="relative">
                              <button
                                onClick={() =>
                                  setShowCollectionDropdown(
                                    !showCollectionDropdown
                                  )
                                }
                                className="flex items-center gap-2 mb-1 hover:bg-white/5 rounded-lg px-2 py-1 transition-colors"
                              >
                                <h3 className="dark:text-white text-theme-primary text-sm font-semibold">
                                  {userData?.collections?.find(
                                    (c) => c.id === selectedCollection
                                  )?.name || "No Collection Selected"}
                                </h3>
                                <svg
                                  className="w-4 h-4 dark:text-gray-400 text-theme-secondary"
                                  fill="none"
                                  stroke="currentColor"
                                  viewBox="0 0 24 24"
                                >
                                  <path
                                    strokeLinecap="round"
                                    strokeLinejoin="round"
                                    strokeWidth="2"
                                    d="M19 9l-7 7-7-7"
                                  />
                                </svg>
                              </button>

                              {/* Collection Dropdown */}
                              {showCollectionDropdown && (
                                <div className="collection-dropdown absolute top-8 left-0 dark:bg-gray-800/95 bg-[#fafafa]/95 backdrop-blur-md rounded-lg dark:border-gray-700/50 border-theme shadow-xl z-10 min-w-[200px]">
                                  {userData?.collections?.map((collection) => (
                                    <button
                                      key={collection.id}
                                      onClick={() => {
                                        setSelectedCollection(collection.id);
                                        setShowCollectionDropdown(false);
                                      }}
                                      className={`w-full text-left px-4 py-3 text-sm transition-colors dark:hover:bg-white/10 hover:bg-[#e4e5f1] first:rounded-t-lg last:rounded-b-lg ${
                                        selectedCollection === collection.id
                                          ? "dark:bg-white/10 dark:text-white bg-[#e4e5f1] text-theme-primary"
                                          : "dark:text-gray-300 text-theme-primary"
                                      }`}
                                    >
                                      <div className="font-medium">
                                        {collection.name}
                                      </div>
                                      <div className="text-xs dark:text-gray-400 text-theme-secondary">
                                        {collection.cards?.length || 0} cards •{" "}
                                        {formatCurrency(
                                          collection.totalValue || 0
                                        )}
                                      </div>
                                    </button>
                                  ))}
                                </div>
                              )}
                            </div>
                            <p className="dark:text-white text-theme-primary text-2xl font-bold">
                              {formatCurrency(
                                userData?.collections?.find(
                                  (c) => c.id === selectedCollection
                                )?.totalValue || 0
                              )}
                            </p>
                            <div
                              className={`flex items-center gap-1 text-sm mt-1 ${
                                (userData?.collections?.find(
                                  (c) => c.id === selectedCollection
                                )?.monthlyChange || 0) >= 0
                                  ? "text-green-400"
                                  : "text-red-400"
                              }`}
                            >
                              <svg
                                className="w-3 h-3"
                                fill="none"
                                stroke="currentColor"
                                viewBox="0 0 24 24"
                              >
                                <path
                                  strokeLinecap="round"
                                  strokeLinejoin="round"
                                  strokeWidth="2"
                                  d={
                                    (userData?.collections?.find(
                                      (c) => c.id === selectedCollection
                                    )?.monthlyChange || 0) >= 0
                                      ? "M7 11l5-5m0 0l5 5m-5-5v12"
                                      : "M17 13l-5 5m0 0l-5-5m5 5V6"
                                  }
                                />
                              </svg>
                              <span className="text-xs">
                                {Math.abs(
                                  userData?.collections?.find(
                                    (c) => c.id === selectedCollection
                                  )?.monthlyChange || 0
                                ).toFixed(1)}
                                %
                              </span>
                              <span className="dark:text-gray-400 text-theme-secondary text-xs">
                                past 6 months
                              </span>
                            </div>
                            <p className="dark:text-gray-500 text-theme-tertiary text-xs mt-1">
                              {userData?.collections?.find(
                                (c) => c.id === selectedCollection
                              )?.lastUpdated
                                ? new Date(
                                    userData.collections.find(
                                      (c) => c.id === selectedCollection
                                    ).lastUpdated
                                  ).toLocaleDateString("en-US", {
                                    month: "short",
                                    day: "numeric",
                                    year: "numeric",
                                  })
                                : "Recently updated"}
                            </p>
                          </div>

                          {/* Currency Selector */}
                          <div className="flex items-center gap-2 dark:bg-white/5 bg-white/20 rounded-lg px-3 py-2 dark:border-white/10 border-theme">
                            <div className="w-3 h-3 rounded-full overflow-hidden">
                              <img
                                src="https://flagcdn.com/w20/us.png"
                                alt="USD"
                                className="w-full h-full object-cover"
                              />
                            </div>
                            <span className="dark:text-white text-theme-primary text-xs font-medium">
                              USD ($)
                            </span>
                            <svg
                              className="w-3 h-3 dark:text-gray-400 text-theme-secondary"
                              fill="none"
                              stroke="currentColor"
                              viewBox="0 0 24 24"
                            >
                              <path
                                strokeLinecap="round"
                                strokeLinejoin="round"
                                strokeWidth="2"
                                d="M19 9l-7 7-7-7"
                              />
                            </svg>
                          </div>
                        </div>

                        {/* Collection Value Chart */}
                        <div className="h-48 bg-gradient-to-b from-blue-500/10 to-purple-500/5 rounded-lg flex items-end justify-center p-4 mb-4 relative overflow-hidden">
                          <CollectionValueChart
                            collectionId={selectedCollection}
                            timeRange={chartTimeRange}
                            className="w-full h-full"
                          />
                        </div>

                        {/* Time Range Buttons */}
                        <div className="flex gap-2 justify-center">
                          {["1D", "7D", "1M", "3M", "6M", "1Y", "Max"].map(
                            (range) => (
                              <button
                                key={range}
                                onClick={() => setChartTimeRange(range)}
                                className={`px-3 py-1 rounded-lg text-xs font-medium transition-colors ${
                                  chartTimeRange === range
                                    ? "bg-blue-500 text-white"
                                    : "dark:text-gray-400 dark:hover:text-white text-theme-secondary hover:text-theme-primary"
                                }`}
                              >
                                {range}
                              </button>
                            )
                          )}
                        </div>
                      </div>

                      {/* Pricing Alerts */}
                      <div className="dark:bg-white/5 bg-white/20 backdrop-blur-md rounded-xl p-4 dark:border-white/10 border-theme">
                        <h3 className="dark:text-white text-theme-primary text-sm font-semibold mb-4">
                          Pricing Alerts
                        </h3>

                        <div className="space-y-3">
                          {!isAuthenticated || !user?.id ? (
                            <div className="text-center py-8">
                              <div className="w-16 h-16 dark:bg-gray-700/50 bg-gray-200 rounded-full flex items-center justify-center mx-auto mb-4">
                                <svg
                                  className="w-8 h-8 dark:text-gray-400 text-theme-primary"
                                  viewBox="0 0 18 18"
                                  fill="currentColor"
                                  xmlns="http://www.w3.org/2000/svg"
                                >
                                  <path d="M0.657 2.50083C0.739514 2.37658 0.867999 2.29019 1.0142 2.26065C1.1604 2.23112 1.31235 2.26086 1.43662 2.34333L3.12412 3.46946C3.24349 3.5541 3.32518 3.68192 3.35185 3.82579C3.37852 3.96967 3.34807 4.11828 3.26697 4.24008C3.18587 4.36187 3.0605 4.44727 2.91747 4.47815C2.77443 4.50903 2.625 4.48295 2.50088 4.40546L0.813375 3.28046C0.689306 3.19777 0.603142 3.0692 0.57382 2.92301C0.544498 2.77682 0.574416 2.62497 0.657 2.50083ZM9 2.24996C7.65734 2.24996 6.36967 2.78333 5.42027 3.73273C4.47087 4.68213 3.9375 5.9698 3.9375 7.31246V10.0136L2.853 12.7282C2.8188 12.8136 2.80604 12.906 2.81583 12.9974C2.82563 13.0888 2.85769 13.1764 2.9092 13.2526C2.96072 13.3288 3.03011 13.3911 3.11132 13.4343C3.19252 13.4774 3.28306 13.4999 3.375 13.5H6.75C6.75 14.7465 7.7535 15.75 9 15.75C10.2465 15.75 11.25 14.7465 11.25 13.5H14.625C14.7168 13.4999 14.8072 13.4773 14.8883 13.4342C14.9693 13.3912 15.0386 13.3289 15.0901 13.2529C15.1416 13.1769 15.1737 13.0895 15.1836 12.9982C15.1935 12.9069 15.181 12.8146 15.147 12.7293L14.0625 10.0125V7.31246C14.0625 5.9698 13.5291 4.68213 12.5797 3.73273C11.6303 2.78333 10.3427 2.24996 9 2.24996ZM10.125 13.5C10.125 14.1255 9.6255 14.625 9 14.625C8.3745 14.625 7.875 14.1255 7.875 13.5H10.125ZM5.0625 7.31246C5.0625 6.26817 5.47734 5.26665 6.21577 4.52823C6.95419 3.7898 7.95571 3.37496 9 3.37496C10.0443 3.37496 11.0458 3.7898 11.7842 4.52823C12.5227 5.26665 12.9375 6.26817 12.9375 7.31246V10.1227C12.9377 10.194 12.9514 10.2647 12.978 10.3308L13.7948 12.375H4.20525L5.022 10.3308C5.04857 10.2647 5.06232 10.194 5.0625 10.1227V7.31246ZM16.5634 2.34446C16.6875 2.26696 16.8369 2.24089 16.98 2.27177C17.123 2.30265 17.2484 2.38804 17.3295 2.50984C17.4106 2.63164 17.441 2.78025 17.4143 2.92412C17.3877 3.068 17.306 3.19582 17.1866 3.28046L15.4991 4.40546C15.375 4.48295 15.2256 4.50903 15.0825 4.47815C14.9395 4.44727 14.8141 4.36187 14.733 4.24008C14.6519 4.11828 14.6215 3.96967 14.6482 3.82579C14.6748 3.68192 14.7565 3.5541 14.8759 3.46946L16.5634 2.34446ZM0 7.31246C0 7.16327 0.0592632 7.0202 0.164752 6.91471C0.270242 6.80922 0.413316 6.74996 0.5625 6.74996H2.25C2.39918 6.74996 2.54226 6.80922 2.64775 6.91471C2.75324 7.0202 2.8125 7.16327 2.8125 7.31246C2.8125 7.46164 2.75324 7.60472 2.64775 7.71021C2.54226 7.8157 2.39918 7.87496 2.25 7.87496H0.5625C0.413316 7.87496 0.270242 7.8157 0.164752 7.71021C0.0592632 7.60472 0 7.46164 0 7.31246ZM17.4375 6.74996C17.5867 6.74996 17.7298 6.80922 17.8352 6.91471C17.9407 7.0202 18 7.16327 18 7.31246C18 7.46164 17.9407 7.60472 17.8352 7.71021C17.7298 7.8157 17.5867 7.87496 17.4375 7.87496H15.75C15.6008 7.87496 15.4577 7.8157 15.3523 7.71021C15.2468 7.60472 15.1875 7.46164 15.1875 7.31246C15.1875 7.16327 15.2468 7.0202 15.3523 6.91471C15.4577 6.80922 15.6008 6.74996 15.75 6.74996H17.4375Z" />
                                </svg>
                              </div>
                              <p className="dark:text-gray-400 text-theme-secondary text-sm">
                                Please log in to view pricing alerts
                              </p>
                              <p className="dark:text-gray-500 text-theme-tertiary text-xs mt-1">
                                Set alerts on cards to track price changes
                              </p>
                            </div>
                          ) : pricingAlerts.length === 0 ? (
                            <div className="text-center py-8">
                              <div className="w-16 h-16 dark:bg-gray-700/50 bg-gray-200 rounded-full flex items-center justify-center mx-auto mb-4">
                                <svg
                                  className="w-8 h-8 dark:text-gray-400 text-theme-primary"
                                  viewBox="0 0 18 18"
                                  fill="currentColor"
                                  xmlns="http://www.w3.org/2000/svg"
                                >
                                  <path d="M0.657 2.50083C0.739514 2.37658 0.867999 2.29019 1.0142 2.26065C1.1604 2.23112 1.31235 2.26086 1.43662 2.34333L3.12412 3.46946C3.24349 3.5541 3.32518 3.68192 3.35185 3.82579C3.37852 3.96967 3.34807 4.11828 3.26697 4.24008C3.18587 4.36187 3.0605 4.44727 2.91747 4.47815C2.77443 4.50903 2.625 4.48295 2.50088 4.40546L0.813375 3.28046C0.689306 3.19777 0.603142 3.0692 0.57382 2.92301C0.544498 2.77682 0.574416 2.62497 0.657 2.50083ZM9 2.24996C7.65734 2.24996 6.36967 2.78333 5.42027 3.73273C4.47087 4.68213 3.9375 5.9698 3.9375 7.31246V10.0136L2.853 12.7282C2.8188 12.8136 2.80604 12.906 2.81583 12.9974C2.82563 13.0888 2.85769 13.1764 2.9092 13.2526C2.96072 13.3288 3.03011 13.3911 3.11132 13.4343C3.19252 13.4774 3.28306 13.4999 3.375 13.5H6.75C6.75 14.7465 7.7535 15.75 9 15.75C10.2465 15.75 11.25 14.7465 11.25 13.5H14.625C14.7168 13.4999 14.8072 13.4773 14.8883 13.4342C14.9693 13.3912 15.0386 13.3289 15.0901 13.2529C15.1416 13.1769 15.1737 13.0895 15.1836 12.9982C15.1935 12.9069 15.181 12.8146 15.147 12.7293L14.0625 10.0125V7.31246C14.0625 5.9698 13.5291 4.68213 12.5797 3.73273C11.6303 2.78333 10.3427 2.24996 9 2.24996ZM10.125 13.5C10.125 14.1255 9.6255 14.625 9 14.625C8.3745 14.625 7.875 14.1255 7.875 13.5H10.125ZM5.0625 7.31246C5.0625 6.26817 5.47734 5.26665 6.21577 4.52823C6.95419 3.7898 7.95571 3.37496 9 3.37496C10.0443 3.37496 11.0458 3.7898 11.7842 4.52823C12.5227 5.26665 12.9375 6.26817 12.9375 7.31246V10.1227C12.9377 10.194 12.9514 10.2647 12.978 10.3308L13.7948 12.375H4.20525L5.022 10.3308C5.04857 10.2647 5.06232 10.194 5.0625 10.1227V7.31246ZM16.5634 2.34446C16.6875 2.26696 16.8369 2.24089 16.98 2.27177C17.123 2.30265 17.2484 2.38804 17.3295 2.50984C17.4106 2.63164 17.441 2.78025 17.4143 2.92412C17.3877 3.068 17.306 3.19582 17.1866 3.28046L15.4991 4.40546C15.375 4.48295 15.2256 4.50903 15.0825 4.47815C14.9395 4.44727 14.8141 4.36187 14.733 4.24008C14.6519 4.11828 14.6215 3.96967 14.6482 3.82579C14.6748 3.68192 14.7565 3.5541 14.8759 3.46946L16.5634 2.34446ZM0 7.31246C0 7.16327 0.0592632 7.0202 0.164752 6.91471C0.270242 6.80922 0.413316 6.74996 0.5625 6.74996H2.25C2.39918 6.74996 2.54226 6.80922 2.64775 6.91471C2.75324 7.0202 2.8125 7.16327 2.8125 7.31246C2.8125 7.46164 2.75324 7.60472 2.64775 7.71021C2.54226 7.8157 2.39918 7.87496 2.25 7.87496H0.5625C0.413316 7.87496 0.270242 7.8157 0.164752 7.71021C0.0592632 7.60472 0 7.46164 0 7.31246ZM17.4375 6.74996C17.5867 6.74996 17.7298 6.80922 17.8352 6.91471C17.9407 7.0202 18 7.16327 18 7.31246C18 7.46164 17.9407 7.60472 17.8352 7.71021C17.7298 7.8157 17.5867 7.87496 17.4375 7.87496H15.75C15.6008 7.87496 15.4577 7.8157 15.3523 7.71021C15.2468 7.60472 15.1875 7.46164 15.1875 7.31246C15.1875 7.16327 15.2468 7.0202 15.3523 6.91471C15.4577 6.80922 15.6008 6.74996 15.75 6.74996H17.4375Z" />
                                </svg>
                              </div>
                              <p className="dark:text-gray-400 text-theme-secondary text-sm">
                                No pricing alerts set
                              </p>
                              <p className="dark:text-gray-500 text-theme-tertiary text-xs mt-1">
                                Set alerts on cards to track price changes
                              </p>
                            </div>
                          ) : (
                            pricingAlerts
                              .filter((alert) => alert && alert.id)
                              .map((alert) => (
                                <div
                                  key={alert.id}
                                  className="dark:bg-white/5 bg-white/20 rounded-lg p-3 flex gap-3 dark:border-white/10 border-theme"
                                >
                                  <img
                                    src={alert.imageUrl}
                                    alt={alert.cardName}
                                    className="w-12 h-16 rounded object-cover"
                                  />
                                  <div className="flex-1">
                                    <p className="dark:text-white text-theme-primary text-sm font-medium mb-1">
                                      {alert.card_name}
                                    </p>
                                    <p className="dark:text-gray-400 text-theme-secondary text-xs mb-1">
                                      {alert.set_name} • {alert.rarity}
                                    </p>
                                    <p className="dark:text-gray-400 text-theme-secondary text-xs">
                                      {alert.card_number}
                                    </p>
                                  </div>
                                  <div className="text-right">
                                    <div className="flex items-center gap-1 mb-1">
                                      <svg
                                        className="w-3 h-3 text-yellow-400"
                                        fill="currentColor"
                                        viewBox="0 0 20 20"
                                      >
                                        <path
                                          fillRule="evenodd"
                                          d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z"
                                          clipRule="evenodd"
                                        />
                                      </svg>
                                      <p className="dark:text-white text-theme-primary text-sm font-medium">
                                        Alert when{" "}
                                        {alert.alert_type === "above"
                                          ? "above"
                                          : "below"}
                                        :
                                      </p>
                                    </div>
                                    <p className="dark:text-white text-theme-primary text-lg font-bold mb-1">
                                      $
                                      {alert.alert_price != null &&
                                      typeof alert.alert_price === "number"
                                        ? alert.alert_price.toFixed(2)
                                        : "0.00"}
                                    </p>
                                    <p
                                      className={`text-xs ${
                                        alert.currentPrice != null &&
                                        typeof alert.currentPrice ===
                                          "number" &&
                                        ((alert.alert_type === "above" &&
                                          alert.currentPrice >=
                                            alert.alert_price) ||
                                          (alert.alert_type === "below" &&
                                            alert.currentPrice <=
                                              alert.alert_price))
                                          ? "text-green-400 font-medium"
                                          : "dark:text-gray-400 text-theme-secondary"
                                      }`}
                                    >
                                      Current:{" "}
                                      {alert.currentPrice != null &&
                                      typeof alert.currentPrice === "number"
                                        ? `$${alert.currentPrice.toFixed(2)}`
                                        : "Loading..."}
                                      {alert.currentPrice != null &&
                                        typeof alert.currentPrice ===
                                          "number" &&
                                        ((alert.alert_type === "above" &&
                                          alert.currentPrice >=
                                            alert.alert_price) ||
                                          (alert.alert_type === "below" &&
                                            alert.currentPrice <=
                                              alert.alert_price)) && (
                                          <span className="ml-1 text-green-400">
                                            🎯
                                          </span>
                                        )}
                                    </p>
                                    <button
                                      onClick={() =>
                                        handleDeletePricingAlert(alert.id)
                                      }
                                      className="text-red-400 text-xs mt-2 flex items-center gap-1 hover:text-red-300 transition-colors"
                                    >
                                      <svg
                                        className="w-3 h-3"
                                        fill="currentColor"
                                        viewBox="0 0 20 20"
                                      >
                                        <path
                                          fillRule="evenodd"
                                          d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z"
                                          clipRule="evenodd"
                                        />
                                      </svg>
                                      Delete
                                    </button>
                                  </div>
                                </div>
                              ))
                          )}
                        </div>
                      </div>

                      {/* Set Progression */}
                      <div className="dark:bg-white/5 bg-white/20 backdrop-blur-md rounded-xl p-4 pb-10 dark:border-white/10 border-theme">
                        <div className="flex items-center justify-between mb-4">
                          <h3 className="dark:text-white text-theme-primary text-sm font-semibold">
                            Set Progression
                          </h3>
                          <button
                            onClick={() => {
                              loadSetProgression();
                            }}
                            className="text-xs dark:text-blue-300 dark:hover:text-white text-[#6865E7] hover:text-[#4F46E5] transition-colors"
                          >
                            Refresh
                          </button>
                        </div>

                        <div className="space-y-4">
                          {setProgression.length === 0 ? (
                            <div className="text-center py-8">
                              <p className="dark:text-gray-400 text-theme-secondary text-sm">
                                No sets in progress
                              </p>
                              <p className="dark:text-gray-500 text-theme-tertiary text-xs mt-1">
                                Start collecting cards to track your progress
                              </p>
                            </div>
                          ) : (
                            setProgression.map((set) => (
                              <div key={set.id} className="space-y-2">
                                <div className="flex items-center justify-between">
                                  <div className="flex items-center gap-2">
                                    <img
                                      src={getSetSymbolPath(
                                        set.name,
                                        set.series,
                                        set.language || "en"
                                      )}
                                      alt={set.name}
                                      className="w-7 h-7 object-contain"
                                      onError={(e) => {
                                        // Fallback to gradient if image fails to load
                                        e.target.style.display = "none";
                                        e.target.nextSibling.style.display =
                                          "block";
                                      }}
                                    />
                                    <div
                                      className="w-7 h-5 bg-gradient-to-br from-purple-500 to-blue-500 rounded"
                                      style={{ display: "none" }}
                                    ></div>
                                    <span className="dark:text-white text-theme-primary text-sm font-medium">
                                      {set.name}
                                    </span>
                                  </div>
                                  <span className="dark:text-gray-400 text-theme-secondary text-xs">
                                    {set.releaseDate
                                      ? new Date(
                                          set.releaseDate
                                        ).toLocaleDateString("en-US", {
                                          month: "short",
                                          day: "numeric",
                                          year: "numeric",
                                        })
                                      : "N/A"}
                                  </span>
                                </div>
                                <div className="flex items-center justify-between text-xs dark:text-gray-400 text-theme-secondary">
                                  <span>
                                    {set.collectedCount} of {set.totalCount}
                                  </span>
                                  <span>{set.percentage}%</span>
                                </div>
                                <div className="h-1 dark:bg-white/10 bg-[#d2d3db] rounded-full overflow-hidden">
                                  <div
                                    className="h-full bg-gradient-to-r from-blue-500 to-purple-600 rounded-full transition-all duration-300"
                                    style={{ width: `${set.percentage}%` }}
                                  ></div>
                                </div>
                              </div>
                            ))
                          )}
                        </div>
                      </div>
                    </div>
                  )}

                  {profileTab === "showcase" && (
                    <div className="space-y-6">
                      {/* Folders */}
                      <div>
                        <div className="flex items-center justify-between mb-4">
                          <h3 className="dark:text-white text-theme-primary text-sm font-semibold">
                            Folders
                          </h3>
                          <button className="dark:text-gray-400 dark:hover:text-white text-theme-secondary hover:text-theme-primary">
                            <svg
                              className="w-5 h-5"
                              fill="none"
                              stroke="currentColor"
                              viewBox="0 0 24 24"
                            >
                              <path
                                strokeLinecap="round"
                                strokeLinejoin="round"
                                strokeWidth="2"
                                d="M12 4v16m8-8H4"
                              />
                            </svg>
                          </button>
                        </div>

                        <div className="grid grid-cols-2 gap-3">
                          {userData?.collections?.map((collection) => (
                            <div
                              key={collection.id}
                              className="dark:bg-white/5 bg-white/20 backdrop-blur-md rounded-xl p-3 dark:border-white/10 border-theme dark:hover:bg-white/10 hover:bg-white/30 transition-colors cursor-pointer"
                            >
                              <div className="aspect-video bg-gradient-to-br from-blue-500/20 to-purple-500/20 rounded-lg mb-2 overflow-hidden">
                                {collection.cards?.[0] && (
                                  <img
                                    src={getCardImageUrl(collection.cards[0])}
                                    alt={collection.name}
                                    className="w-full h-full object-cover"
                                  />
                                )}
                              </div>
                              <div className="flex items-center gap-1 mb-1">
                                <div className="w-2 h-2 rounded-full bg-red-500"></div>
                                <h4 className="dark:text-white text-theme-primary text-xs font-medium">
                                  {collection.name}
                                </h4>
                              </div>
                              <p className="dark:text-gray-400 text-theme-secondary text-xs">
                                {collection.totalCards || 0} cards
                              </p>
                              <p className="dark:text-gray-400 text-theme-secondary text-xs">
                                Value: $
                                {collection.totalValue?.toFixed(2) || "0.00"}
                              </p>
                            </div>
                          )) || (
                            <div className="col-span-2 text-center dark:text-gray-400 text-theme-secondary text-sm py-8">
                              No collections yet
                            </div>
                          )}
                        </div>

                        <button className="w-full mt-3 text-center dark:text-white text-theme-primary text-sm py-2 rounded-lg dark:bg-white/5 bg-white/20 dark:hover:bg-white/10 hover:bg-white/30 transition-colors dark:border-white/10 border-theme">
                          View more
                        </button>
                      </div>

                      {/* Binders */}
                      <div>
                        <div className="flex items-center justify-between mb-4">
                          <h3 className="dark:text-white text-theme-primary text-sm font-semibold">
                            Binders
                          </h3>
                          <button className="dark:text-gray-400 dark:hover:text-white text-theme-secondary hover:text-theme-primary">
                            <svg
                              className="w-5 h-5"
                              fill="none"
                              stroke="currentColor"
                              viewBox="0 0 24 24"
                            >
                              <path
                                strokeLinecap="round"
                                strokeLinejoin="round"
                                strokeWidth="2"
                                d="M12 4v16m8-8H4"
                              />
                            </svg>
                          </button>
                        </div>

                        <div className="flex gap-3 overflow-x-auto pb-2">
                          {availableBinders && availableBinders.length > 0 ? (
                            availableBinders.map((binder) => (
                              <div
                                key={binder.id}
                                className="flex-shrink-0 w-24 h-32 rounded-lg bg-gradient-to-br from-blue-500/20 to-purple-500/20 border border-white/10 relative overflow-hidden cursor-pointer hover:scale-105 transition-transform"
                                title={binder.name}
                              >
                                <div className="absolute inset-0 flex items-center justify-center text-4xl">
                                  {binder.name?.charAt(0)?.toUpperCase() ||
                                    "📔"}
                                </div>
                                <div className="absolute bottom-0 left-0 right-0 bg-black/50 backdrop-blur-sm p-1">
                                  <p className="text-white text-xs font-medium text-center truncate">
                                    {binder.name}
                                  </p>
                                </div>
                              </div>
                            ))
                          ) : (
                            <div className="flex-shrink-0 w-full text-center dark:text-gray-400 text-theme-secondary text-sm py-8">
                              No binders yet
                            </div>
                          )}
                        </div>
                      </div>

                      {/* Wishlist */}
                      <div className="pb-6">
                        <div className="flex items-center gap-2 mb-4">
                          <svg
                            className="w-5 h-5 text-yellow-400"
                            fill="currentColor"
                            viewBox="0 0 20 20"
                          >
                            <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" />
                          </svg>
                          <h3 className="dark:text-white text-theme-primary text-sm font-semibold">
                            Wishlist
                          </h3>
                        </div>

                        <div className="grid grid-cols-3 gap-3">
                          {wishlistItems && wishlistItems.length > 0 ? (
                            wishlistItems.slice(0, 6).map((item) => {
                              const card = item.card || {};
                              const cardName = getDisplayName({
                                name:
                                  card.name ||
                                  card.clean_name ||
                                  "Unknown Card",
                              });
                              const setName = getDisplaySetName({
                                name: card.set_name || "Unknown Set",
                              });
                              const cardNumber = card.ext_number || "";
                              const rarity = card.ext_rarity || "";
                              const price =
                                card.market_price ||
                                card.mid_price ||
                                card.low_price ||
                                0;
                              const imageUrl =
                                card.image_url ||
                                "https://images.pokemontcg.io/base1/4.png";

                              return (
                                <div
                                  key={item.id || item.cardId}
                                  className="dark:bg-white/5 bg-white/20 backdrop-blur-md rounded-xl p-2 dark:border-white/10 border-theme"
                                >
                                  <div className="aspect-[3/4] bg-gradient-to-br from-blue-500/20 to-purple-500/20 rounded-lg mb-2 flex items-center justify-center overflow-hidden">
                                    <img
                                      src={imageUrl}
                                      alt={cardName}
                                      className="w-full h-full object-cover rounded-lg"
                                      onError={(e) => {
                                        e.target.src =
                                          "https://images.pokemontcg.io/base1/4.png";
                                      }}
                                    />
                                  </div>
                                  <p
                                    className="dark:text-white text-theme-primary text-xs font-medium mb-1 truncate"
                                    title={cardName}
                                  >
                                    {cardName}
                                  </p>
                                  <p
                                    className="dark:text-gray-400 text-theme-secondary text-xs truncate"
                                    title={setName}
                                  >
                                    {setName}
                                  </p>
                                  {rarity && (
                                    <p className="dark:text-gray-400 text-theme-secondary text-xs">
                                      {rarity}
                                    </p>
                                  )}
                                  {cardNumber && (
                                    <p className="dark:text-gray-400 text-theme-secondary text-xs mb-2">
                                      {cardNumber}
                                    </p>
                                  )}
                                  <p className="text-blue-400 text-sm font-bold">
                                    {formatCurrency(price)}
                                  </p>
                                  <button
                                    onClick={() => {
                                      if (card.product_id || card.cardId) {
                                        setCardToAdd({
                                          id: card.product_id || card.cardId,
                                          name: card.name || card.clean_name,
                                          imageUrl: card.image_url,
                                        });
                                        setShowAddToCollectionModal(true);
                                      }
                                    }}
                                    className="w-full mt-2 bg-blue-500 hover:bg-blue-600 text-white text-xs py-1 rounded flex items-center justify-center gap-1 transition-colors"
                                  >
                                    <svg
                                      className="w-3 h-3"
                                      fill="none"
                                      stroke="currentColor"
                                      viewBox="0 0 24 24"
                                    >
                                      <path
                                        strokeLinecap="round"
                                        strokeLinejoin="round"
                                        strokeWidth="2"
                                        d="M12 4v16m8-8H4"
                                      />
                                    </svg>
                                    Add
                                  </button>
                                </div>
                              );
                            })
                          ) : (
                            <div className="col-span-3 text-center dark:text-gray-400 text-theme-secondary text-sm py-8">
                              No wishlist items yet
                            </div>
                          )}
                        </div>
                      </div>
                    </div>
                  )}

                  {profileTab === "about" && (
                    <div className="space-y-6">
                      {/* Trading Info */}
                      <div className="dark:bg-white/5 bg-white/20 backdrop-blur-md rounded-xl p-4 dark:border-white/10 border-theme">
                        <h3 className="dark:text-white text-theme-primary text-sm font-semibold mb-3">
                          Trading Info
                        </h3>
                        <div className="space-y-2">
                          <div>
                            <p className="dark:text-gray-400 text-theme-secondary text-xs italic mb-1">
                              Tagline:
                            </p>
                            <p className="dark:text-white text-theme-primary text-sm">
                              {user?.tagline || "No tagline set"}
                            </p>
                          </div>
                        </div>
                      </div>

                      {/* About Me */}
                      <div className="dark:bg-white/5 bg-white/20 backdrop-blur-md rounded-xl p-4 dark:border-white/10 border-theme">
                        <h3 className="dark:text-white text-theme-primary text-sm font-semibold mb-3">
                          About me:
                        </h3>
                        <p className="dark:text-gray-300 text-theme-primary text-sm leading-relaxed">
                          {user?.aboutMe || "No bio set"}
                        </p>
                      </div>

                      {/* Current Collecting Goals */}
                      {user?.collectingGoals &&
                        Array.isArray(user.collectingGoals) &&
                        user.collectingGoals.length > 0 && (
                          <div className="dark:bg-white/5 bg-white/20 backdrop-blur-md rounded-xl p-4 dark:border-white/10 border-theme">
                            <h3 className="dark:text-white text-theme-primary text-sm font-semibold mb-3">
                              Current Collecting Goals:
                            </h3>
                            <ul className="space-y-2">
                              {user.collectingGoals.map((goal, index) => (
                                <li
                                  key={index}
                                  className="dark:text-gray-300 text-theme-primary text-sm flex items-start gap-2"
                                >
                                  <span className="text-blue-400 mt-1">•</span>
                                  <span>{goal}</span>
                                </li>
                              ))}
                            </ul>
                          </div>
                        )}

                      {/* Socials */}
                      {user?.socialLinks &&
                        (user.socialLinks.twitter ||
                          user.socialLinks.instagram ||
                          user.socialLinks.youtube ||
                          user.socialLinks.tiktok ||
                          user.socialLinks.website) && (
                          <div className="dark:bg-white/5 bg-white/20 backdrop-blur-md rounded-xl p-4 pb-10 dark:border-white/10 border-theme">
                            <h3 className="dark:text-white text-theme-primary text-sm font-semibold mb-4">
                              Socials
                            </h3>
                            <div className="space-y-3">
                              {user.socialLinks.twitter && (
                                <a
                                  href={`https://twitter.com/${user.socialLinks.twitter.replace(
                                    "@",
                                    ""
                                  )}`}
                                  target="_blank"
                                  rel="noopener noreferrer"
                                  className="flex items-center gap-3 dark:text-gray-300 dark:hover:text-white text-theme-primary hover:text-[#6865E7] transition-colors"
                                >
                                  <div className="w-8 h-8 dark:bg-white/10 bg-white/20 rounded-lg flex items-center justify-center">
                                    <svg
                                      className="w-4 h-4"
                                      fill="currentColor"
                                      viewBox="0 0 24 24"
                                    >
                                      <path d="M23.953 4.57a10 10 0 01-2.825.775 4.958 4.958 0 002.163-2.723c-.951.555-2.005.959-3.127 1.184a4.92 4.92 0 00-8.384 4.482C7.69 8.095 4.067 6.13 1.64 3.162a4.822 4.822 0 00-.666 2.475c0 1.71.87 3.213 2.188 4.096a4.904 4.904 0 01-2.228-.616v.06a4.923 4.923 0 003.946 4.827 4.996 4.996 0 01-2.212.085 4.936 4.936 0 004.604 3.417 9.867 9.867 0 01-6.102 2.105c-.39 0-.779-.023-1.17-.067a13.995 13.995 0 007.557 2.209c9.053 0 13.998-7.496 13.998-13.985 0-.21 0-.42-.015-.63A9.935 9.935 0 0024 4.59z" />
                                    </svg>
                                  </div>
                                  <span className="text-sm">
                                    @{user.socialLinks.twitter.replace("@", "")}
                                  </span>
                                </a>
                              )}
                              {user.socialLinks.instagram && (
                                <a
                                  href={`https://instagram.com/${user.socialLinks.instagram.replace(
                                    "@",
                                    ""
                                  )}`}
                                  target="_blank"
                                  rel="noopener noreferrer"
                                  className="flex items-center gap-3 dark:text-gray-300 dark:hover:text-white text-theme-primary hover:text-[#6865E7] transition-colors"
                                >
                                  <div className="w-8 h-8 dark:bg-white/10 bg-white/20 rounded-lg flex items-center justify-center">
                                    <svg
                                      className="w-4 h-4"
                                      fill="currentColor"
                                      viewBox="0 0 24 24"
                                    >
                                      <path d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849 0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07-3.204 0-3.584-.012-4.849-.07-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849 0-3.204.013-3.583.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zm0-2.163c-3.259 0-3.667.014-4.947.072-4.358.2-6.78 2.618-6.98 6.98-.059 1.281-.073 1.689-.073 4.948 0 3.259.014 3.668.072 4.948.2 4.358 2.618 6.78 6.98 6.98 1.281.058 1.689.072 4.948.072 3.259 0 3.668-.014 4.948-.072 4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948 0-3.259-.014-3.667-.072-4.947-.196-4.354-2.617-6.78-6.979-6.98-1.281-.059-1.69-.073-4.949-.073z" />
                                      <path d="M12 5.838c-3.403 0-6.162 2.759-6.162 6.162s2.759 6.163 6.162 6.163 6.162-2.759 6.162-6.163c0-3.403-2.759-6.162-6.162-6.162zm0 10.162c-2.209 0-4-1.79-4-4 0-2.209 1.791-4 4-4s4 1.791 4 4c0 2.21-1.791 4-4 4zm6.406-11.845c-.796 0-1.441.645-1.441 1.44s.645 1.44 1.441 1.44c.795 0 1.439-.645 1.439-1.44s-.644-1.44-1.439-1.44z" />
                                    </svg>
                                  </div>
                                  <span className="text-sm">
                                    @
                                    {user.socialLinks.instagram.replace(
                                      "@",
                                      ""
                                    )}
                                  </span>
                                </a>
                              )}
                              {user.socialLinks.youtube && (
                                <a
                                  href={`https://youtube.com/${user.socialLinks.youtube}`}
                                  target="_blank"
                                  rel="noopener noreferrer"
                                  className="flex items-center gap-3 dark:text-gray-300 dark:hover:text-white text-theme-primary hover:text-[#6865E7] transition-colors"
                                >
                                  <div className="w-8 h-8 dark:bg-white/10 bg-white/20 rounded-lg flex items-center justify-center">
                                    <svg
                                      className="w-4 h-4"
                                      fill="currentColor"
                                      viewBox="0 0 24 24"
                                    >
                                      <path d="M23.498 6.186a3.016 3.016 0 0 0-2.122-2.136C19.505 3.545 12 3.545 12 3.545s-7.505 0-9.377.505A3.017 3.017 0 0 0 .502 6.186C0 8.07 0 12 0 12s0 3.93.502 5.814a3.016 3.016 0 0 0 2.122 2.136c1.871.505 9.376.505 9.376.505s7.505 0 9.377-.505a3.015 3.015 0 0 0 2.122-2.136C24 15.93 24 12 24 12s0-3.93-.502-5.814zM9.545 15.568V8.432L15.818 12l-6.273 3.568z" />
                                    </svg>
                                  </div>
                                  <span className="text-sm">
                                    {user.socialLinks.youtube}
                                  </span>
                                </a>
                              )}
                              {user.socialLinks.tiktok && (
                                <a
                                  href={`https://tiktok.com/@${user.socialLinks.tiktok.replace(
                                    "@",
                                    ""
                                  )}`}
                                  target="_blank"
                                  rel="noopener noreferrer"
                                  className="flex items-center gap-3 dark:text-gray-300 dark:hover:text-white text-theme-primary hover:text-[#6865E7] transition-colors"
                                >
                                  <div className="w-8 h-8 dark:bg-white/10 bg-white/20 rounded-lg flex items-center justify-center">
                                    <svg
                                      className="w-4 h-4"
                                      fill="currentColor"
                                      viewBox="0 0 24 24"
                                    >
                                      <path d="M19.59 6.69a4.83 4.83 0 0 1-3.77-4.25V2h-3.45v13.67a2.89 2.89 0 0 1-5.2 1.74 2.89 2.89 0 0 1 2.31-4.64 2.93 2.93 0 0 1 .88.13V9.4a6.84 6.84 0 0 0-1-.05A6.33 6.33 0 0 0 5 20.1a6.34 6.34 0 0 0 10.86-4.43v-7a8.16 8.16 0 0 0 4.77 1.52v-3.4a4.85 4.85 0 0 1-1-.1z" />
                                    </svg>
                                  </div>
                                  <span className="text-sm">
                                    @{user.socialLinks.tiktok.replace("@", "")}
                                  </span>
                                </a>
                              )}
                              {user.socialLinks.website && (
                                <a
                                  href={
                                    user.socialLinks.website.startsWith("http")
                                      ? user.socialLinks.website
                                      : `https://${user.socialLinks.website}`
                                  }
                                  target="_blank"
                                  rel="noopener noreferrer"
                                  className="flex items-center gap-3 dark:text-gray-300 dark:hover:text-white text-theme-primary hover:text-[#6865E7] transition-colors"
                                >
                                  <div className="w-8 h-8 dark:bg-white/10 bg-white/20 rounded-lg flex items-center justify-center">
                                    <svg
                                      className="w-4 h-4"
                                      fill="currentColor"
                                      viewBox="0 0 24 24"
                                    >
                                      <path d="M5.868 2.75H18.132c1.136 0 2.054.918 2.054 2.05v14.4c0 1.132-.918 2.05-2.054 2.05H5.868c-1.136 0-2.054-.918-2.054-2.05V4.8c0-1.132.918-2.05 2.054-2.05zm3.312 15.683c0-.41-.343-.75-.764-.75H6.744c-.422 0-.764.34-.764.75s.342.75.764.75h1.672c.42 0 .764-.34.764-.75zm9.36-1.503h-1.636V14.41h1.636v2.52zm0-3.27h-1.636v-2.52h1.636v2.52zm0-3.27h-1.636V7.87h1.636v2.52z" />
                                    </svg>
                                  </div>
                                  <span className="text-sm">
                                    {user.socialLinks.website}
                                  </span>
                                </a>
                              )}
                            </div>
                          </div>
                        )}
                    </div>
                  )}
                </div>
              </div>
            );
          })()}

        {/* Create Collection Modal */}
        {showCreateCollectionModal && (
          <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
            <div className="bg-gray-800 rounded-lg p-6 w-96 max-w-md mx-4">
              <div className="flex items-center justify-between mb-4">
                <h3 className="text-white text-lg font-semibold">
                  Create New Collection
                </h3>
                <button
                  onClick={() => {
                    setShowCreateCollectionModal(false);
                    setNewCollectionName("");
                  }}
                  className="text-gray-400 hover:text-white"
                >
                  <svg
                    className="w-6 h-6"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      strokeLinecap="round"
                      strokeLinejoin="round"
                      strokeWidth="2"
                      d="M6 18L18 6M6 6l12 12"
                    />
                  </svg>
                </button>
              </div>

              <div className="mb-4">
                <label className="block text-white text-sm font-medium mb-2">
                  Collection Name
                </label>
                <input
                  type="text"
                  value={newCollectionName}
                  onChange={(e) => setNewCollectionName(e.target.value)}
                  placeholder="Enter collection name..."
                  className="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:border-blue-500"
                  autoFocus
                  onKeyPress={(e) => {
                    if (e.key === "Enter") {
                      createNewCollection();
                    }
                  }}
                />
              </div>

              <div className="flex gap-3">
                <button
                  onClick={() => {
                    setShowCreateCollectionModal(false);
                    setNewCollectionName("");
                  }}
                  className="flex-1 px-4 py-2 bg-gray-700 text-white rounded-lg hover:bg-gray-600 transition-colors"
                >
                  Cancel
                </button>
                <button
                  onClick={createNewCollection}
                  disabled={!newCollectionName.trim()}
                  className="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                >
                  Create Collection
                </button>
              </div>
            </div>
          </div>
        )}

        {/* Collections Modal */}
        {showCollectionsModal && (
          <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
            <div className="bg-gray-800 rounded-lg p-6 w-96 max-w-md mx-4 max-h-[80vh] overflow-y-auto">
              <div className="flex items-center justify-between mb-4">
                <h3 className="text-white text-lg font-semibold">
                  Your Collections
                </h3>
                <button
                  onClick={() => setShowCollectionsModal(false)}
                  className="text-gray-400 hover:text-white transition-colors"
                >
                  <svg
                    className="w-6 h-6"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      strokeLinecap="round"
                      strokeLinejoin="round"
                      strokeWidth="2"
                      d="M6 18L18 6M6 6l12 12"
                    />
                  </svg>
                </button>
              </div>

              <div className="space-y-3">
                {userData?.collections.map((collection) => (
                  <div
                    key={collection.id}
                    className={`p-4 rounded-lg border cursor-pointer transition-all ${
                      selectedCollection === collection.id
                        ? "bg-blue-600/20 border-blue-500"
                        : "bg-gray-700 border-gray-600 hover:bg-gray-600"
                    }`}
                    onClick={() => {
                      setSelectedCollection(collection.id);
                      setShowCollectionsModal(false);
                    }}
                  >
                    <div className="flex items-center justify-between">
                      <div>
                        <h4 className="text-white font-medium">
                          {collection.name}
                        </h4>
                        <p className="text-gray-400 text-sm">
                          {collection.cardCount} cards •{" "}
                          {formatCurrency(collection.totalValue)}
                        </p>
                      </div>
                      <div className="flex items-center gap-2">
                        {collection.monthlyChange >= 0 ? (
                          <div className="flex items-center gap-1 text-green-400 text-sm">
                            <svg
                              className="w-4 h-4"
                              fill="none"
                              stroke="currentColor"
                              viewBox="0 0 24 24"
                            >
                              <path
                                strokeLinecap="round"
                                strokeLinejoin="round"
                                strokeWidth="2"
                                d="M7 11l5-5m0 0l5 5m-5-5v12"
                              />
                            </svg>
                            <span>+{collection.monthlyChange.toFixed(1)}%</span>
                          </div>
                        ) : (
                          <div className="flex items-center gap-1 text-red-400 text-sm">
                            <svg
                              className="w-4 h-4"
                              fill="none"
                              stroke="currentColor"
                              viewBox="0 0 24 24"
                            >
                              <path
                                strokeLinecap="round"
                                strokeLinejoin="round"
                                strokeWidth="2"
                                d="M17 13l-5 5m0 0l-5-5m5 5V6"
                              />
                            </svg>
                            <span>{collection.monthlyChange.toFixed(1)}%</span>
                          </div>
                        )}
                        {selectedCollection === collection.id && (
                          <div className="w-2 h-2 bg-blue-500 rounded-full"></div>
                        )}
                      </div>
                    </div>
                  </div>
                ))}

                <button
                  onClick={() => {
                    setShowCollectionsModal(false);
                    setShowCreateCollectionModal(true);
                  }}
                  className="w-full p-4 border-2 border-dashed border-gray-600 rounded-lg text-gray-400 hover:text-white hover:border-gray-500 transition-colors flex items-center justify-center gap-2"
                >
                  <svg
                    className="w-5 h-5"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      strokeLinecap="round"
                      strokeLinejoin="round"
                      strokeWidth="2"
                      d="M12 6v6m0 0v6m0-6h6m-6 0H6"
                    />
                  </svg>
                  Create New Collection
                </button>
              </div>
            </div>
          </div>
        )}

        {/* Recent Activity Modal */}
        {showActivityModal && (
          <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
            <div className="bg-gray-800 rounded-lg p-6 w-96 max-w-md mx-4 max-h-[80vh] overflow-y-auto">
              <div className="flex items-center justify-between mb-4">
                <h3 className="text-white text-lg font-semibold">
                  Recent Activity
                </h3>
                <button
                  onClick={() => setShowActivityModal(false)}
                  className="text-gray-400 hover:text-white transition-colors"
                >
                  <svg
                    className="w-6 h-6"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      strokeLinecap="round"
                      strokeLinejoin="round"
                      strokeWidth="2"
                      d="M6 18L18 6M6 6l12 12"
                    />
                  </svg>
                </button>
              </div>

              <div className="space-y-3">
                {recentActivityData.map((activity) => (
                  <div
                    key={activity.id}
                    className="bg-gray-700 rounded-lg p-4 border border-gray-600"
                  >
                    <div className="flex items-center justify-between">
                      <div className="flex-1">
                        <h4 className="text-white font-medium text-sm">
                          {activity.cardName}
                        </h4>
                        <p className="text-gray-400 text-xs mt-1">
                          {activity.time}
                        </p>
                      </div>
                      <div
                        className={`flex items-center gap-2 px-3 py-1 rounded-full text-xs font-medium ${
                          activity.type === "add"
                            ? "bg-green-500/20 text-green-400 border border-green-500/30"
                            : "bg-red-500/20 text-red-400 border border-red-500/30"
                        }`}
                      >
                        <svg
                          className="w-4 h-4"
                          fill="none"
                          stroke="currentColor"
                          viewBox="0 0 24 24"
                        >
                          {activity.type === "add" ? (
                            <path
                              strokeLinecap="round"
                              strokeLinejoin="round"
                              strokeWidth="2"
                              d="M12 6v6m0 0v6m0-6h6m-6 0H6"
                            />
                          ) : (
                            <path
                              strokeLinecap="round"
                              strokeLinejoin="round"
                              strokeWidth="2"
                              d="M6 12L18 12"
                            />
                          )}
                        </svg>
                        <span>{activity.action}</span>
                      </div>
                    </div>
                  </div>
                ))}

                {recentActivityData.length === 0 && (
                  <div className="text-center py-8">
                    <div className="w-16 h-16 bg-gray-700 rounded-full flex items-center justify-center mx-auto mb-4">
                      <svg
                        className="w-8 h-8 text-gray-400"
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                      >
                        <path
                          strokeLinecap="round"
                          strokeLinejoin="round"
                          strokeWidth="2"
                          d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"
                        />
                      </svg>
                    </div>
                    <h4 className="text-white font-medium mb-2">
                      No Recent Activity
                    </h4>
                    <p className="text-gray-400 text-sm">
                      Start adding cards to your collection to see activity
                      here.
                    </p>
                  </div>
                )}
              </div>
            </div>
          </div>
        )}

        {/* Bottom Navigation Bar - Glass Effect Design */}
        <div
          className="fixed bottom-0 left-0 right-0 px-2 py-2 sm:px-[19px] sm:py-0 sm:bottom-4 sm:rounded-[16px] z-[10002]"
          style={{
            filter:
              "drop-shadow(0px 24px 7px rgba(0,0,0,0.01)) drop-shadow(16px 16px 16px rgba(0,0,0,0.04)) drop-shadow(0px 9px 5px rgba(0,0,0,0.15)) drop-shadow(0px 4px 4px rgba(0,0,0,0.25)) drop-shadow(0px 1px 2px rgba(0,0,0,0.29))",
          }}
        >
          <div
            className={`flex items-center justify-between px-4 py-2 sm:px-[30px] sm:py-0 rounded-[16px] relative dark:border-white/50 border-[#d2d3db]/50 h-[75px] overflow-hidden ${
              isDark ? "bg-gray-900/90" : "bg-[#fafafa]/95"
            }`}
            style={{
              backdropFilter: "blur(60px) saturate(200%)",
              WebkitBackdropFilter: "blur(60px) saturate(200%)",
              boxShadow: isDark
                ? "inset 0 1px 0 rgba(255,255,255,0.15), inset 0 -1px 0 rgba(0,0,0,0.2)"
                : "inset 0 1px 0 rgba(250,250,250,0.9), inset 0 -1px 0 rgba(72,75,106,0.03), 0 4px 6px rgba(72,75,106,0.08)",
            }}
          >
            {/* Home Button */}
            <button
              onClick={() => {
                setActiveTab("home");
                setNavigationMode("home");
                setSelectedCard(null); // Close card profile modal
                scrollToTop(); // Scroll to top when navigating
              }}
              className={`flex flex-col gap-[10px] h-[75px] items-center justify-end pb-0 pt-[15px] px-2 sm:px-[10px] w-16 sm:w-[84px] ${
                navigationMode === "home"
                  ? ""
                  : "justify-center pt-[26px] h-[47px]"
              } focus:outline-none rounded-lg transition-all border-none`}
              aria-label="Navigate to Home"
            >
              <div className="flex flex-col gap-[6px] h-[58px] items-center w-12 sm:w-[64px] border-none">
                <div className="w-6 h-6 relative">
                  {navigationMode === "home" ? (
                    <svg
                      width="24"
                      height="24"
                      viewBox="0 0 24 24"
                      fill="none"
                      xmlns="http://www.w3.org/2000/svg"
                    >
                      <path
                        d="M20.04 6.82006L14.28 2.79006C12.71 1.69006 10.3 1.75006 8.78999 2.92006L3.77999 6.83006C2.77999 7.61006 1.98999 9.21006 1.98999 10.4701V17.3701C1.98999 19.9201 4.05999 22.0001 6.60999 22.0001H17.39C19.94 22.0001 22.01 19.9301 22.01 17.3801V10.6001C22.01 9.25006 21.14 7.59006 20.04 6.82006ZM12.75 18.0001C12.75 18.4101 12.41 18.7501 12 18.7501C11.59 18.7501 11.25 18.4101 11.25 18.0001V15.0001C11.25 14.5901 11.59 14.2501 12 14.2501C12.41 14.2501 12.75 14.5901 12.75 15.0001V18.0001Z"
                        fill="#6865E7"
                      />
                    </svg>
                  ) : (
                    <svg
                      width="24"
                      height="24"
                      viewBox="0 0 24 24"
                      fill="none"
                      xmlns="http://www.w3.org/2000/svg"
                    >
                      <path
                        d="M20.04 6.82006L14.28 2.79006C12.71 1.69006 10.3 1.75006 8.78999 2.92006L3.77999 6.83006C2.77999 7.61006 1.98999 9.21006 1.98999 10.4701V17.3701C1.98999 19.9201 4.05999 22.0001 6.60999 22.0001H17.39C19.94 22.0001 22.01 19.9301 22.01 17.3801V10.6001C22.01 9.25006 21.14 7.59006 20.04 6.82006ZM12.75 18.0001C12.75 18.4101 12.41 18.7501 12 18.7501C11.59 18.7501 11.25 18.4101 11.25 18.0001V15.0001C11.25 14.5901 11.59 14.2501 12 14.2501C12.41 14.2501 12.75 14.5901 12.75 15.0001V18.0001Z"
                        stroke="#8F8F94"
                        strokeWidth="2"
                        strokeLinecap="round"
                        strokeLinejoin="round"
                      />
                    </svg>
                  )}
                </div>
                {navigationMode === "home" && (
                  <div className="dark:text-white text-theme-primary text-[11px] font-normal leading-[0]">
                    Home
                  </div>
                )}
              </div>
            </button>

            {/* Collection Button */}
            <button
              onClick={() => {
                setSelectedCard(null); // Close card profile modal first
                setTimeout(() => {
                  setActiveTab("collection");
                  setNavigationMode("collection");
                  scrollToTop(); // Scroll to top when navigating
                }, 100); // Small delay to ensure modal closes first
              }}
              className={`flex flex-col gap-[10px] h-[75px] items-center justify-end pb-0 pt-[15px] px-2 sm:px-[10px] w-16 sm:w-[84px] ${
                navigationMode === "collection"
                  ? ""
                  : "justify-center pt-[26px] h-[47px]"
              } focus:outline-none rounded-lg transition-all border-none`}
              aria-label="Navigate to Collection"
            >
              <div className="flex flex-col gap-[6px] h-[58px] items-center w-12 sm:w-[64px] border-none">
                <div className="w-6 h-6 relative">
                  {navigationMode === "collection" ? (
                    <svg
                      width="25"
                      height="24"
                      viewBox="0 0 25 24"
                      fill="none"
                      xmlns="http://www.w3.org/2000/svg"
                    >
                      <g clipPath="url(#clip0_27_2085)">
                        <path
                          fillRule="evenodd"
                          clipRule="evenodd"
                          d="M13.2934 0.565676C13.0829 0.509623 12.8587 0.53932 12.6701 0.648258C12.4815 0.757196 12.3437 0.936485 12.2871 1.14682L8.28764 16.0748C8.23165 16.2855 8.26158 16.5099 8.37087 16.6986C8.48015 16.8872 8.65985 17.0248 8.8705 17.0811L19.2985 19.8754C19.5092 19.9314 19.7336 19.9015 19.9222 19.7922C20.1109 19.6829 20.2485 19.5032 20.3048 19.2925L24.3076 4.36625C24.3356 4.26179 24.3427 4.15284 24.3286 4.04563C24.3144 3.93842 24.2793 3.83505 24.2252 3.74143C24.171 3.64782 24.099 3.56579 24.0131 3.50004C23.9273 3.43429 23.8293 3.38611 23.7248 3.35825L13.2934 0.565676ZM6.2185 15.5194L8.9545 5.31082L0.943644 7.45539C0.839153 7.48325 0.741178 7.53143 0.655321 7.59718C0.569464 7.66293 0.49741 7.74496 0.443278 7.83858C0.389145 7.93219 0.353997 8.03556 0.339843 8.14277C0.325688 8.24998 0.332805 8.35893 0.360787 8.46339L4.36364 23.3897C4.41993 23.6003 4.55751 23.78 4.74619 23.8893C4.93487 23.9986 5.1592 24.0285 5.36993 23.9725L15.7996 21.1782L15.8391 21.1662L8.31336 19.1502C7.55401 18.9465 6.90661 18.4497 6.51347 17.7688C6.12032 17.088 6.01361 16.2789 6.21679 15.5194"
                          fill="#6865E7"
                        />
                      </g>
                      <defs>
                        <clipPath id="clip0_27_2085">
                          <rect
                            width="24"
                            height="24"
                            fill="white"
                            transform="translate(0.333252)"
                          />
                        </clipPath>
                      </defs>
                    </svg>
                  ) : (
                    <svg
                      width="25"
                      height="24"
                      viewBox="0 0 25 24"
                      fill="none"
                      xmlns="http://www.w3.org/2000/svg"
                    >
                      <g clipPath="url(#clip0_248_3247)">
                        <path
                          d="M11.555 1.469C11.6113 1.26096 11.7477 1.0837 11.9344 0.976052C12.1211 0.868406 12.3428 0.839157 12.551 0.894714L22.871 3.65814C23.0797 3.71364 23.2578 3.84974 23.3661 4.03652C23.4745 4.2233 23.5042 4.44546 23.4488 4.65414L19.4888 19.4279C19.4325 19.6363 19.2959 19.8138 19.1088 19.9215C18.9217 20.0292 18.6995 20.0582 18.491 20.0021L8.17104 17.2387C7.96268 17.1828 7.78501 17.0466 7.67702 16.8599C7.56903 16.6731 7.53954 16.4512 7.59504 16.2427L11.555 1.469Z"
                          stroke="#8F8F94"
                          strokeWidth="2"
                          strokeLinecap="round"
                          strokeLinejoin="round"
                        ></path>
                        <path
                          d="M10.8042 4.3457L1.7939 6.76113C1.58555 6.81699 1.40787 6.95325 1.29988 7.13999C1.19189 7.32672 1.16241 7.54868 1.2179 7.75713L5.17447 22.5308C5.23069 22.7393 5.36736 22.9168 5.55445 23.0245C5.74154 23.1322 5.96373 23.1612 6.17219 23.1051L11.3322 21.7234"
                          stroke="#8F8F94"
                          strokeWidth="2"
                          strokeLinecap="round"
                          strokeLinejoin="round"
                        ></path>
                      </g>
                      <defs>
                        <clipPath id="clip0_248_3247">
                          <rect
                            width="24"
                            height="24"
                            fill="white"
                            transform="translate(0.333313)"
                          ></rect>
                        </clipPath>
                      </defs>
                    </svg>
                  )}
                </div>
                {navigationMode === "collection" && (
                  <div className="dark:text-white text-theme-primary text-[11px] font-normal leading-[0]">
                    Collection
                  </div>
                )}
              </div>
            </button>

            {/* Marketplace Button */}
            <button
              onClick={() => {
                setSelectedCard(null); // Close card profile modal
                setActiveTab("marketplace");
                setNavigationMode("marketplace");
                scrollToTop(); // Scroll to top when navigating
              }}
              className={`flex flex-col gap-[10px] h-[75px] items-center justify-end pb-0 pt-[15px] px-2 sm:px-[10px] w-16 sm:w-[84px] ${
                navigationMode === "marketplace"
                  ? ""
                  : "justify-center pt-[26px] h-[47px]"
              } focus:outline-none rounded-lg transition-all border-none`}
              aria-label="Navigate to Marketplace"
            >
              <div className="flex flex-col gap-[6px] h-[58px] items-center w-12 sm:w-[64px] border-none">
                <div className="w-6 h-6 relative">
                  {navigationMode === "marketplace" ? (
                    <svg
                      width="25"
                      height="24"
                      viewBox="0 0 25 24"
                      fill="none"
                      xmlns="http://www.w3.org/2000/svg"
                    >
                      <g clipPath="url(#clip0_115_14278)">
                        <path
                          fillRule="evenodd"
                          clipRule="evenodd"
                          d="M11.3341 21.3334C11.3341 22.8061 10.1402 24 8.6674 24C7.19464 24 6.00073 22.8061 6.00073 21.3334C6.00073 19.8606 7.19464 18.6667 8.6674 18.6667C10.1402 18.6667 11.3341 19.8606 11.3341 21.3334ZM22.0007 21.3334C22.0007 22.8061 20.8068 24 19.3341 24C17.8613 24 16.6674 22.8061 16.6674 21.3334C16.6674 19.8606 17.8613 18.6667 19.3341 18.6667C20.8068 18.6667 22.0007 19.8606 22.0007 21.3334Z"
                          fill="#6865E7"
                        />
                        <path
                          d="M2.00081 0C1.26443 0 0.66748 0.596954 0.66748 1.33333C0.66748 2.06971 1.26443 2.66667 2.00081 2.66667H2.48134C3.11691 2.66667 3.66413 3.11528 3.78878 3.73851L5.81234 13.8563C6.06163 15.1028 7.15607 16 8.42722 16H20.2749C21.5153 16 22.592 15.1447 22.8725 13.9363L24.6099 6.45226C24.9009 5.19836 23.9489 4 22.6617 4H6.56055L6.40366 3.21554C6.02972 1.34584 4.38806 0 2.48134 0H2.00081Z"
                          fill="#6865E7"
                        />
                      </g>
                      <defs>
                        <clipPath id="clip0_115_14278">
                          <rect
                            width="24"
                            height="24"
                            fill="white"
                            transform="translate(0.666748)"
                          />
                        </clipPath>
                      </defs>
                    </svg>
                  ) : (
                    <svg
                      width="25"
                      height="24"
                      viewBox="0 0 25 24"
                      fill="none"
                      xmlns="http://www.w3.org/2000/svg"
                    >
                      <g clipPath="url(#clip0_144_6148)">
                        <path
                          fillRule="evenodd"
                          clipRule="evenodd"
                          d="M11.3335 21.3348C11.3335 22.8078 10.1394 24.0019 8.66636 24.0019C7.19337 24.0019 5.99927 22.8078 5.99927 21.3348C5.99927 19.8618 7.19337 18.6677 8.66636 18.6677C10.1394 18.6677 11.3335 19.8618 11.3335 21.3348ZM22.0018 21.3348C22.0018 22.8078 20.8077 24.0019 19.3347 24.0019C17.8617 24.0019 16.6676 22.8078 16.6676 21.3348C16.6676 19.8618 17.8617 18.6677 19.3347 18.6677C20.8068 18.6677 22.0018 19.8618 22.0018 21.3348Z"
                          fill="#8F8F94"
                        />
                        <path
                          d="M1.99902 0.998108H2.47949C3.90971 0.998253 5.14138 2.00775 5.42188 3.41022L5.57812 4.1944L5.73926 4.99908H21.3311C22.8789 4.99924 23.9975 6.47835 23.5762 7.96783L22.2051 12.8165C21.8396 14.1084 20.66 15.001 19.3174 15.001H9.51953C8.08934 15.001 6.85784 13.9913 6.57715 12.5889L4.76758 3.54108C4.54945 2.45042 3.59172 1.66524 2.47949 1.6651H1.99902C1.81496 1.6651 1.66528 1.5161 1.66504 1.33209C1.66504 1.17082 1.77952 1.03595 1.93164 1.00494L1.99902 0.998108Z"
                          stroke="#8F8F94"
                          strokeWidth="2"
                          strokeLinecap="round"
                        />
                      </g>
                      <defs>
                        <clipPath id="clip0_144_6148">
                          <rect
                            width="24"
                            height="24"
                            fill="white"
                            transform="translate(0.666748)"
                          />
                        </clipPath>
                      </defs>
                    </svg>
                  )}
                </div>
                {navigationMode === "marketplace" && (
                  <div className="dark:text-white text-theme-primary text-[11px] font-normal leading-[0]">
                    Marketplace
                  </div>
                )}
              </div>
            </button>

            {/* Profile Button */}
            <button
              onClick={() => {
                setActiveTab("profile");
                setNavigationMode("profile");
                setViewingUserId(null); // Show own profile
                setSelectedCard(null); // Close card profile modal
                scrollToTop(); // Scroll to top when navigating
              }}
              className={`flex flex-col gap-[10px] h-[75px] items-center justify-end pb-0 pt-[15px] px-2 sm:px-[10px] w-16 sm:w-[84px] ${
                navigationMode === "profile"
                  ? ""
                  : "justify-center pt-[26px] h-[47px]"
              } focus:outline-none rounded-lg transition-all border-none`}
              aria-label="Navigate to Profile"
            >
              <div className="flex flex-col gap-[6px] h-[58px] items-center w-12 sm:w-[64px] border-none">
                <div className="w-6 h-6 relative">
                  {navigationMode === "profile" ? (
                    <svg
                      width="24"
                      height="24"
                      viewBox="0 0 24 24"
                      fill="none"
                      xmlns="http://www.w3.org/2000/svg"
                    >
                      <path
                        d="M12 12C14.7614 12 17 9.76142 17 7C17 4.23858 14.7614 2 12 2C9.23858 2 7 4.23858 7 7C7 9.76142 9.23858 12 12 12Z"
                        fill="#6865E7"
                      />
                      <path
                        d="M11.9999 14.5C6.98991 14.5 2.90991 17.86 2.90991 22C2.90991 22.28 3.12991 22.5 3.40991 22.5H20.5899C20.8699 22.5 21.0899 22.28 21.0899 22C21.0899 17.86 17.0099 14.5 11.9999 14.5Z"
                        fill="#6865E7"
                      />
                    </svg>
                  ) : (
                    <svg
                      width="24"
                      height="24"
                      viewBox="0 0 24 24"
                      fill="none"
                      xmlns="http://www.w3.org/2000/svg"
                    >
                      <path
                        d="M12 12C14.7614 12 17 9.76142 17 7C17 4.23858 14.7614 2 12 2C9.23858 2 7 4.23858 7 7C7 9.76142 9.23858 12 12 12Z"
                        stroke="#8F8F94"
                        strokeWidth="2"
                        strokeLinecap="round"
                        strokeLinejoin="round"
                      />
                      <path
                        d="M20.59 22C20.59 18.13 16.74 15 12 15C7.26003 15 3.41003 18.13 3.41003 22"
                        stroke="#8F8F94"
                        strokeWidth="2"
                        strokeLinecap="round"
                        strokeLinejoin="round"
                      />
                    </svg>
                  )}
                </div>
                {navigationMode === "profile" && (
                  <div className="dark:text-white text-theme-primary text-[11px] font-normal leading-[0]">
                    Profile
                  </div>
                )}
              </div>
            </button>
          </div>

          {/* Top Movers Modal */}
          {showTopMoversModal && (
            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
              <div className="bg-gray-800 rounded-2xl p-6 w-full max-w-4xl mx-4 max-h-[90vh] overflow-y-auto">
                <div className="flex items-center justify-between mb-6">
                  <div className="flex items-center gap-3">
                    <div className="w-8 h-8 bg-gradient-to-br from-green-500 to-emerald-600 rounded-lg flex items-center justify-center">
                      <svg
                        className="w-4 h-4 text-white"
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                      >
                        <path
                          strokeLinecap="round"
                          strokeLinejoin="round"
                          strokeWidth="2"
                          d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"
                        />
                      </svg>
                    </div>
                    <h3 className="text-white text-xl font-bold">
                      All Top Movers
                    </h3>
                  </div>
                  <button
                    onClick={() => setShowTopMoversModal(false)}
                    className="text-gray-400 hover:text-white transition-colors"
                  >
                    <svg
                      className="w-6 h-6"
                      fill="none"
                      stroke="currentColor"
                      viewBox="0 0 24 24"
                    >
                      <path
                        strokeLinecap="round"
                        strokeLinejoin="round"
                        strokeWidth="2"
                        d="M6 18L18 6M6 6l12 12"
                      />
                    </svg>
                  </button>
                </div>

                <div className="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-0.5">
                  {topMoversData.map((mover) => (
                    <div
                      key={mover.id}
                      onClick={() => {
                        handleCardClick(mover);
                        setShowTopMoversModal(false);
                      }}
                      className={`relative rounded-xl p-4 border transition-all duration-300 group cursor-pointer ${
                        mover.type === "gain"
                          ? "bg-gradient-to-r from-green-500/10 to-transparent border-green-500/20 hover:border-green-500/40"
                          : "bg-gradient-to-r from-red-500/10 to-transparent border-red-500/20 hover:border-red-500/40"
                      }`}
                    >
                      <div className="flex items-center gap-4">
                        <div className="relative">
                          <div className="w-16 h-20 rounded-lg shadow-lg overflow-hidden bg-gray-800">
                            <img
                              src={getCardImageUrl(mover)}
                              alt={mover.name}
                              className="w-full h-full object-cover"
                              onError={(e) => {
                                e.target.style.display = "none";
                                e.target.nextSibling.style.display = "flex";
                              }}
                            />
                            <div
                              className={`w-full h-full flex items-center justify-center ${
                                mover.rank === 1
                                  ? "bg-gradient-to-br from-yellow-400 to-orange-500"
                                  : mover.rank === 2
                                  ? "bg-gradient-to-br from-blue-400 to-purple-500"
                                  : mover.rank === 3
                                  ? "bg-gradient-to-br from-red-400 to-pink-500"
                                  : "bg-gradient-to-br from-gray-400 to-gray-600"
                              }`}
                              style={{ display: "none" }}
                            >
                              <span className="text-white font-bold text-xs">
                                #{mover.rank}
                              </span>
                            </div>
                          </div>
                          <div
                            className={`absolute -top-1 -right-1 w-6 h-6 rounded-full flex items-center justify-center ${
                              mover.type === "gain"
                                ? "bg-green-500"
                                : "bg-red-500"
                            }`}
                          >
                            <svg
                              className="w-3 h-3 text-white"
                              fill="none"
                              stroke="currentColor"
                              viewBox="0 0 24 24"
                            >
                              {mover.type === "gain" ? (
                                <path
                                  strokeLinecap="round"
                                  strokeLinejoin="round"
                                  strokeWidth="2"
                                  d="M7 11l5-5m0 0l5 5m-5-5v12"
                                />
                              ) : (
                                <path
                                  strokeLinecap="round"
                                  strokeLinejoin="round"
                                  strokeWidth="2"
                                  d="M17 13l-5 5m0 0l-5-5m5 5V6"
                                />
                              )}
                            </svg>
                          </div>
                        </div>
                        <div className="flex-1">
                          <h4
                            className={`font-bold text-sm transition-colors ${
                              mover.type === "gain"
                                ? "text-white group-hover:text-green-400"
                                : "text-white group-hover:text-red-400"
                            }`}
                          >
                            {mover.name}
                          </h4>
                          <p className="text-gray-400 text-xs">
                            {mover.set} • {mover.rarity}
                          </p>
                          <div className="flex items-center gap-2 mt-1">
                            {(mover.formattedNumber || mover.number) && (
                              <>
                                <span className="text-white text-xs font-medium">
                                  {mover.formattedNumber || mover.number}
                                </span>
                                <span className="text-gray-500 text-xs">•</span>
                              </>
                            )}
                            <span className="text-gray-400 text-xs">
                              Qty:{" "}
                              {getCardQuantityInCollection(
                                mover.cardId || mover.id
                              )}
                            </span>
                          </div>
                        </div>
                        <div className="text-right">
                          <div
                            className={`font-bold text-lg ${
                              mover.type === "gain"
                                ? "text-green-400"
                                : "text-red-400"
                            }`}
                          >
                            ${mover.price.toLocaleString()}
                          </div>
                          <div
                            className={`flex items-center gap-1 text-sm ${
                              mover.type === "gain"
                                ? "text-green-400"
                                : "text-red-400"
                            }`}
                          >
                            <svg
                              className="w-3 h-3"
                              fill="none"
                              stroke="currentColor"
                              viewBox="0 0 24 24"
                            >
                              {mover.type === "gain" ? (
                                <path
                                  strokeLinecap="round"
                                  strokeLinejoin="round"
                                  strokeWidth="2"
                                  d="M7 11l5-5m0 0l5 5m-5-5v12"
                                />
                              ) : (
                                <path
                                  strokeLinecap="round"
                                  strokeLinejoin="round"
                                  strokeWidth="2"
                                  d="M17 13l-5 5m0 0l-5-5m5 5V6"
                                />
                              )}
                            </svg>
                            <span className="font-semibold">
                              {Math.abs(mover.change).toFixed(2)}%
                            </span>
                          </div>
                          <div className="text-gray-400 text-xs">
                            {mover.dailyChange >= 0 ? "+" : ""}$
                            {mover.dailyChange.toFixed(2)} today
                          </div>
                        </div>
                      </div>
                    </div>
                  ))}
                </div>
              </div>
            </div>
          )}

          {/* Trending Cards Modal */}
          {showTrendingModal && (
            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
              <div className="bg-gray-800 rounded-2xl p-6 w-full max-w-4xl mx-4 max-h-[90vh] overflow-y-auto">
                <div className="flex items-center justify-between mb-6">
                  <div className="flex items-center gap-3">
                    <div className="w-8 h-8 bg-gradient-to-br from-purple-500 to-pink-600 rounded-lg flex items-center justify-center">
                      <svg
                        className="w-4 h-4 text-white"
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                      >
                        <path
                          strokeLinecap="round"
                          strokeLinejoin="round"
                          strokeWidth="2"
                          d="M17.657 18.657A8 8 0 016.343 7.343S7 9 9 10c0-2 .5-5 2.986-7C14 5 16.09 5.777 17.656 7.343A7.975 7.975 0 0120 13a7.975 7.975 0 01-2.343 5.657z"
                        />
                        <path
                          strokeLinecap="round"
                          strokeLinejoin="round"
                          strokeWidth="2"
                          d="M9.879 16.121A3 3 0 1012.015 11L11 14H9c0 .768.293 1.536.879 2.121z"
                        />
                      </svg>
                    </div>
                    <h3 className="text-white text-xl font-bold">
                      All Trending Cards
                    </h3>
                  </div>
                  <button
                    onClick={() => setShowTrendingModal(false)}
                    className="text-gray-400 hover:text-white transition-colors"
                  >
                    <svg
                      className="w-6 h-6"
                      fill="none"
                      stroke="currentColor"
                      viewBox="0 0 24 24"
                    >
                      <path
                        strokeLinecap="round"
                        strokeLinejoin="round"
                        strokeWidth="2"
                        d="M6 18L18 6M6 6l12 12"
                      />
                    </svg>
                  </button>
                </div>

                <div className="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-5 lg:grid-cols-6 xl:grid-cols-7 gap-0.5">
                  {trendingCardsData.map((card) => (
                    <div
                      key={card.id}
                      onClick={() => {
                        handleCardClick(card);
                        setShowTrendingModal(false);
                      }}
                      className={`relative rounded-xl p-4 border transition-all duration-300 group cursor-pointer ${
                        card.color === "orange"
                          ? "bg-gradient-to-br from-orange-500/10 to-red-500/5 border-orange-500/20 hover:border-orange-500/40"
                          : card.color === "blue"
                          ? "bg-gradient-to-br from-blue-500/10 to-cyan-500/5 border-blue-500/20 hover:border-blue-500/40"
                          : card.color === "green"
                          ? "bg-gradient-to-br from-green-500/10 to-emerald-500/5 border-green-500/20 hover:border-green-500/40"
                          : card.color === "purple"
                          ? "bg-gradient-to-br from-purple-500/10 to-pink-500/5 border-purple-500/20 hover:border-purple-500/40"
                          : card.color === "red"
                          ? "bg-gradient-to-br from-red-500/10 to-pink-500/5 border-red-500/20 hover:border-red-500/40"
                          : card.color === "cyan"
                          ? "bg-gradient-to-br from-cyan-500/10 to-blue-500/5 border-cyan-500/20 hover:border-cyan-500/40"
                          : card.color === "emerald"
                          ? "bg-gradient-to-br from-emerald-500/10 to-green-500/5 border-emerald-500/20 hover:border-emerald-500/40"
                          : "bg-gradient-to-br from-gray-500/10 to-gray-600/5 border-gray-500/20 hover:border-gray-500/40"
                      }`}
                    >
                      <div className="flex flex-col items-center text-center">
                        <div className="relative mb-3">
                          <div className="w-20 h-28 rounded-lg shadow-lg overflow-hidden bg-gray-800">
                            <img
                              src={getCardImageUrl(card)}
                              alt={getDisplayName(card)}
                              className="w-full h-full object-cover"
                              onError={(e) => {
                                e.target.style.display = "none";
                                e.target.nextSibling.style.display = "flex";
                              }}
                            />
                            <div
                              className={`w-full h-full flex items-center justify-center ${
                                card.color === "orange"
                                  ? "bg-gradient-to-br from-orange-400 to-red-500"
                                  : card.color === "blue"
                                  ? "bg-gradient-to-br from-blue-400 to-cyan-500"
                                  : card.color === "green"
                                  ? "bg-gradient-to-br from-green-400 to-emerald-500"
                                  : card.color === "purple"
                                  ? "bg-gradient-to-br from-purple-400 to-pink-500"
                                  : card.color === "red"
                                  ? "bg-gradient-to-br from-red-400 to-pink-500"
                                  : card.color === "cyan"
                                  ? "bg-gradient-to-br from-cyan-400 to-blue-500"
                                  : card.color === "emerald"
                                  ? "bg-gradient-to-br from-emerald-400 to-green-500"
                                  : "bg-gradient-to-br from-gray-400 to-gray-600"
                              }`}
                              style={{ display: "none" }}
                            >
                              <span className="text-white font-bold text-xs">
                                {card.emoji}
                              </span>
                            </div>
                          </div>
                          <div
                            className={`absolute -top-1 -right-1 w-5 h-5 rounded-full flex items-center justify-center ${
                              card.color === "orange"
                                ? "bg-orange-500"
                                : card.color === "blue"
                                ? "bg-blue-500"
                                : card.color === "green"
                                ? "bg-green-500"
                                : card.color === "purple"
                                ? "bg-purple-500"
                                : card.color === "red"
                                ? "bg-red-500"
                                : card.color === "cyan"
                                ? "bg-cyan-500"
                                : card.color === "emerald"
                                ? "bg-emerald-500"
                                : "bg-gray-500"
                            }`}
                          >
                            <span className="dark:text-white text-theme-primary text-xs font-bold">
                              {card.rank}
                            </span>
                          </div>
                        </div>
                        <h4
                          className={`font-bold text-sm transition-colors mb-1 ${
                            card.color === "orange"
                              ? "text-white group-hover:text-orange-400"
                              : card.color === "blue"
                              ? "text-white group-hover:text-blue-400"
                              : card.color === "green"
                              ? "text-white group-hover:text-green-400"
                              : card.color === "purple"
                              ? "text-white group-hover:text-purple-400"
                              : card.color === "red"
                              ? "text-white group-hover:text-red-400"
                              : card.color === "cyan"
                              ? "text-white group-hover:text-cyan-400"
                              : card.color === "emerald"
                              ? "text-white group-hover:text-emerald-400"
                              : "text-white group-hover:text-gray-400"
                          }`}
                        >
                          {card.name}
                        </h4>
                        <p className="text-gray-400 text-xs mb-1">
                          {card.set || card.set_name || "Unknown Set"}
                        </p>
                        <p className="text-gray-500 text-xs mb-1">
                          {card.formattedNumber || card.number || ""}
                        </p>
                        <p className="text-gray-500 text-xs mb-2">
                          {card.rarity || "Unknown"}
                        </p>
                        <div
                          className={`font-bold text-lg ${
                            card.color === "orange"
                              ? "text-orange-400"
                              : card.color === "blue"
                              ? "text-blue-400"
                              : card.color === "green"
                              ? "text-green-400"
                              : card.color === "purple"
                              ? "text-purple-400"
                              : card.color === "red"
                              ? "text-red-400"
                              : card.color === "cyan"
                              ? "text-cyan-400"
                              : card.color === "emerald"
                              ? "text-emerald-400"
                              : "text-gray-400"
                          }`}
                        >
                          ${card.price}
                        </div>
                        <div
                          className={`flex items-center gap-1 text-xs ${
                            card.color === "orange"
                              ? "text-orange-400"
                              : card.color === "blue"
                              ? "text-blue-400"
                              : card.color === "green"
                              ? "text-green-400"
                              : card.color === "purple"
                              ? "text-purple-400"
                              : card.color === "red"
                              ? "text-red-400"
                              : card.color === "cyan"
                              ? "text-cyan-400"
                              : card.color === "emerald"
                              ? "text-emerald-400"
                              : "text-gray-400"
                          }`}
                        >
                          <svg
                            className="w-3 h-3"
                            fill="none"
                            stroke="currentColor"
                            viewBox="0 0 24 24"
                          >
                            <path
                              strokeLinecap="round"
                              strokeLinejoin="round"
                              strokeWidth="2"
                              d="M7 11l5-5m0 0l5 5m-5-5v12"
                            />
                          </svg>
                          <span className="font-semibold">
                            +{card.change.toFixed(2)}%
                          </span>
                        </div>
                      </div>
                    </div>
                  ))}
                </div>
              </div>
            </div>
          )}

          {/* Sliding Menu */}
          {showSlidingMenu &&
            createPortal(
              <>
                {/* Backdrop */}
                <div
                  className="fixed inset-0 bg-black bg-opacity-50 z-[99999]"
                  onClick={() => setShowSlidingMenu(false)}
                />

                {/* Sliding Menu */}
                <div
                  className={`fixed top-0 right-0 h-full w-80 dark:bg-gray-900 bg-white shadow-2xl z-[99999] transform transition-transform duration-300 ease-in-out ${
                    showSlidingMenu ? "translate-x-0" : "translate-x-full"
                  }`}
                >
                  {/* Menu Header */}
                  <div className="flex items-center justify-between p-6 border-b dark:border-gray-700 border-[#d2d3db]">
                    <h2 className="dark:text-white text-theme-primary text-xl font-bold">
                      Menu
                    </h2>
                    <button
                      onClick={() => setShowSlidingMenu(false)}
                      className="w-8 h-8 dark:bg-gray-700 bg-gray-200 rounded-full flex items-center justify-center dark:hover:bg-gray-600 hover:bg-gray-300 transition-colors"
                      aria-label="Close menu"
                    >
                      <svg
                        className="w-4 h-4 dark:text-white text-theme-primary"
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                      >
                        <path
                          strokeLinecap="round"
                          strokeLinejoin="round"
                          strokeWidth="2"
                          d="M6 18L18 6M6 6l12 12"
                        />
                      </svg>
                    </button>
                  </div>

                  {/* Menu Content */}
                  <div className="p-6 overflow-y-auto h-full">
                    <nav className="space-y-6">
                      {/* Main Navigation */}
                      <div className="space-y-2">
                        <button
                          onClick={() => {
                            setActiveTab("profile");
                            setNavigationMode("profile");
                            setShowSlidingMenu(false);
                          }}
                          className="w-full flex items-center gap-3 p-3 rounded-lg dark:hover:bg-gray-800 hover:bg-gray-100 transition-colors text-left"
                        >
                          <svg
                            className="w-5 h-5 dark:text-gray-400 text-gray-600"
                            fill="none"
                            stroke="currentColor"
                            viewBox="0 0 24 24"
                          >
                            <path
                              strokeLinecap="round"
                              strokeLinejoin="round"
                              strokeWidth="2"
                              d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"
                            />
                          </svg>
                          <span className="dark:text-white text-theme-primary">
                            Profile
                          </span>
                        </button>

                        <button
                          onClick={() => {
                            setShowCardProfile(false);
                            setSelectedCard(null);
                            setActiveTab("deck-builder");
                            setNavigationMode("deck-builder");
                            setShowSlidingMenu(false);
                          }}
                          className="w-full flex items-center gap-3 p-3 rounded-lg dark:hover:bg-gray-800 hover:bg-gray-100 transition-colors text-left"
                        >
                          <svg
                            className="w-5 h-5 dark:text-gray-400 text-gray-600"
                            fill="none"
                            stroke="currentColor"
                            viewBox="0 0 24 24"
                          >
                            <path
                              strokeLinecap="round"
                              strokeLinejoin="round"
                              strokeWidth="2"
                              d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"
                            />
                          </svg>
                          <span className="dark:text-white text-theme-primary">
                            Deck Builder
                          </span>
                        </button>

                        <button
                          onClick={() => {
                            setShowCardProfile(false);
                            setSelectedCard(null);
                            setActiveTab("binder");
                            setNavigationMode("binder");
                            setShowSlidingMenu(false);
                          }}
                          className="w-full flex items-center gap-3 p-3 rounded-lg dark:hover:bg-gray-800 hover:bg-gray-100 transition-colors text-left"
                        >
                          <svg
                            className="w-5 h-5 dark:text-gray-400 text-gray-600"
                            fill="none"
                            stroke="currentColor"
                            viewBox="0 0 24 24"
                          >
                            <path
                              strokeLinecap="round"
                              strokeLinejoin="round"
                              strokeWidth="2"
                              d="M4 5a1 1 0 011-1h14a1 1 0 011 1v2a1 1 0 01-1 1H5a1 1 0 01-1-1V5zM4 13a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H5a1 1 0 01-1-1v-6zM16 13a1 1 0 011-1h2a1 1 0 011 1v6a1 1 0 01-1 1h-2a1 1 0 01-1-1v-6z"
                            />
                          </svg>
                          <span className="dark:text-white text-theme-primary">
                            Binder
                          </span>
                        </button>

                        <button
                          onClick={() => {
                            setShowCardProfile(false);
                            setSelectedCard(null);
                            setActiveTab("sets");
                            setNavigationMode("sets");
                            setShowSlidingMenu(false);
                          }}
                          className="w-full flex items-center gap-3 p-3 rounded-lg dark:hover:bg-gray-800 hover:bg-gray-100 transition-colors text-left"
                        >
                          <svg
                            className="w-5 h-5 dark:text-gray-400 text-gray-600"
                            fill="none"
                            stroke="currentColor"
                            viewBox="0 0 24 24"
                          >
                            <path
                              strokeLinecap="round"
                              strokeLinejoin="round"
                              strokeWidth="2"
                              d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"
                            />
                          </svg>
                          <span className="dark:text-white text-theme-primary">
                            Sets
                          </span>
                        </button>

                        <button
                          onClick={() => {
                            setPreviousTab(activeTab);
                            setPreviousNavigationMode(navigationMode);
                            setActiveTab("community");
                            setNavigationMode("community");
                            setShowSlidingMenu(false);
                          }}
                          className="w-full flex items-center gap-3 p-3 rounded-lg dark:hover:bg-gray-800 hover:bg-gray-100 transition-colors text-left"
                        >
                          <svg
                            className="w-5 h-5 dark:text-gray-400 text-gray-600"
                            fill="none"
                            stroke="currentColor"
                            viewBox="0 0 24 24"
                          >
                            <path
                              strokeLinecap="round"
                              strokeLinejoin="round"
                              strokeWidth="2"
                              d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"
                            />
                          </svg>
                          <span className="dark:text-white text-theme-primary">
                            Community
                          </span>
                        </button>
                      </div>

                      {/* Collections Section */}
                      <div className="pt-4 border-t dark:border-gray-700 border-[#d2d3db]">
                        <h4 className="dark:text-gray-400 text-gray-600 text-sm font-medium mb-3">
                          Collections
                        </h4>
                        <div className="space-y-2">
                          {/* Dynamic Collections from userData */}
                          {userData?.collections?.map((collection, index) => (
                            <button
                              key={collection.id || index}
                              onClick={() => {
                                setSelectedCollection(collection.id);
                                setActiveTab("collection");
                                setNavigationMode("collection");
                                setShowSlidingMenu(false);
                              }}
                              className="w-full flex items-center gap-3 p-3 rounded-lg dark:hover:bg-gray-800 hover:bg-gray-100 transition-colors text-left"
                            >
                              <svg
                                className="w-5 h-5 dark:text-gray-400 text-gray-600"
                                fill="none"
                                stroke="currentColor"
                                viewBox="0 0 24 24"
                              >
                                <path
                                  strokeLinecap="round"
                                  strokeLinejoin="round"
                                  strokeWidth="2"
                                  d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"
                                />
                              </svg>
                              <span className="dark:text-white text-theme-primary">
                                {collection.name}
                              </span>
                            </button>
                          ))}

                          {/* Wishlist - Always present */}
                          <button
                            onClick={() => {
                              setPreviousTab(activeTab);
                              setPreviousNavigationMode(navigationMode);
                              setActiveTab("wishlist");
                              setNavigationMode("wishlist");
                              setShowSlidingMenu(false);
                            }}
                            className="w-full flex items-center gap-3 p-3 rounded-lg dark:hover:bg-gray-800 hover:bg-gray-100 transition-colors text-left"
                          >
                            <svg
                              className="w-5 h-5 dark:text-gray-400 text-gray-600"
                              fill="none"
                              stroke="currentColor"
                              viewBox="0 0 24 24"
                            >
                              <path
                                strokeLinecap="round"
                                strokeLinejoin="round"
                                strokeWidth="2"
                                d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"
                              />
                            </svg>
                            <span className="dark:text-white text-theme-primary">
                              Wishlist
                            </span>
                          </button>
                        </div>
                      </div>

                      {/* Settings Section */}
                      <div className="pt-4 border-t dark:border-gray-700 border-[#d2d3db]">
                        <h4 className="dark:text-gray-400 text-gray-600 text-sm font-medium mb-3">
                          Settings
                        </h4>
                        <div className="space-y-2">
                          <button
                            onClick={() => {
                              setPreviousTab(activeTab);
                              setPreviousNavigationMode(navigationMode);
                              setActiveTab("settings");
                              setNavigationMode("settings");
                              setShowSlidingMenu(false);
                            }}
                            className="w-full flex items-center gap-3 p-3 rounded-lg dark:hover:bg-gray-800 hover:bg-gray-100 transition-colors text-left"
                          >
                            <svg
                              className="w-5 h-5 dark:text-gray-400 text-gray-600"
                              fill="none"
                              stroke="currentColor"
                              viewBox="0 0 24 24"
                            >
                              <path
                                strokeLinecap="round"
                                strokeLinejoin="round"
                                strokeWidth="2"
                                d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"
                              />
                              <path
                                strokeLinecap="round"
                                strokeLinejoin="round"
                                strokeWidth="2"
                                d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"
                              />
                            </svg>
                            <span className="dark:text-white text-theme-primary">
                              Settings
                            </span>
                          </button>

                          <button
                            onClick={() => {
                              setPreviousTab(activeTab);
                              setPreviousNavigationMode(navigationMode);
                              setActiveTab("help");
                              setNavigationMode("help");
                              setShowSlidingMenu(false);
                            }}
                            className="w-full flex items-center gap-3 p-3 rounded-lg dark:hover:bg-gray-800 hover:bg-gray-100 transition-colors text-left"
                          >
                            <svg
                              className="w-5 h-5 dark:text-gray-400 text-gray-600"
                              fill="none"
                              stroke="currentColor"
                              viewBox="0 0 24 24"
                            >
                              <path
                                strokeLinecap="round"
                                strokeLinejoin="round"
                                strokeWidth="2"
                                d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
                              />
                            </svg>
                            <span className="dark:text-white text-theme-primary">
                              Help Center
                            </span>
                          </button>

                          {/* Light/Dark Mode Toggle */}
                          <button
                            onClick={() => {
                              toggleTheme();
                              setShowSlidingMenu(false);
                            }}
                            className="w-full flex items-center gap-3 p-3 rounded-lg dark:hover:bg-gray-800 hover:bg-gray-100 transition-colors text-left"
                          >
                            {isDark ? (
                              <>
                                <svg
                                  className="w-5 h-5 dark:text-gray-400 text-gray-600"
                                  fill="none"
                                  stroke="currentColor"
                                  viewBox="0 0 24 24"
                                >
                                  <path
                                    strokeLinecap="round"
                                    strokeLinejoin="round"
                                    strokeWidth="2"
                                    d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"
                                  />
                                </svg>
                                <span className="dark:text-white text-theme-primary">
                                  Light Mode
                                </span>
                              </>
                            ) : (
                              <>
                                <svg
                                  className="w-5 h-5 dark:text-gray-400 text-gray-600"
                                  fill="none"
                                  stroke="currentColor"
                                  viewBox="0 0 24 24"
                                >
                                  <path
                                    strokeLinecap="round"
                                    strokeLinejoin="round"
                                    strokeWidth="2"
                                    d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"
                                  />
                                </svg>
                                <span className="dark:text-white text-theme-primary">
                                  Dark Mode
                                </span>
                              </>
                            )}
                          </button>

                          <button
                            onClick={async () => {
                              setShowSlidingMenu(false);
                              setGuestMode(false); // Clear guest mode on logout
                              await logout();
                              setCurrentScreen("login");
                            }}
                            className="w-full flex items-center gap-3 p-3 rounded-lg dark:hover:bg-gray-800 hover:bg-gray-100 transition-colors text-left"
                          >
                            <svg
                              className="w-5 h-5 dark:text-gray-400 text-gray-600"
                              fill="none"
                              stroke="currentColor"
                              viewBox="0 0 24 24"
                            >
                              <path
                                strokeLinecap="round"
                                strokeLinejoin="round"
                                strokeWidth="2"
                                d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"
                              />
                            </svg>
                            <span className="dark:text-white text-theme-primary">
                              Logout
                            </span>
                          </button>
                        </div>
                      </div>
                    </nav>
                  </div>
                </div>
              </>,
              document.body
            )}

          {/* Add to Collection Modal - Search Results - Rendered at top level */}
          {showSearchResultsModal &&
            cardToAddFromSearch &&
            (showSearchResults ||
              activeTab === "cards" ||
              activeTab === "search") &&
            createPortal(
              <div
                className="fixed left-0 right-0 top-0 bottom-0 z-[100500] bg-black/50 backdrop-blur-sm flex items-end justify-center p-0.5 sm:p-4 overflow-y-auto"
                style={{ top: "0px", bottom: "0px" }}
              >
                <div className="bg-gray-800 rounded-2xl w-full max-w-md mx-auto relative z-[100501] modal-container max-h-[82vh] sm:max-h-[80vh] flex flex-col shadow-2xl border border-gray-600">
                  <div className="p-4 sm:p-6 overflow-y-auto flex-1">
                    {/* Header */}
                    <div className="flex items-center justify-between mb-4 sm:mb-6">
                      <h2 className="text-white text-xl font-semibold">
                        Add to Collection
                      </h2>
                      <button
                        onClick={() => {
                          setShowSearchResultsModal(false);
                          setCardToAddFromSearch(null);
                        }}
                        className="w-8 h-8 bg-gray-600 rounded-full flex items-center justify-center text-white hover:bg-gray-500 transition-colors"
                      >
                        <svg
                          className="w-4 h-4"
                          fill="none"
                          stroke="currentColor"
                          viewBox="0 0 24 24"
                        >
                          <path
                            strokeLinecap="round"
                            strokeLinejoin="round"
                            strokeWidth={2}
                            d="M6 18L18 6M6 6l12 12"
                          />
                        </svg>
                      </button>
                    </div>

                    {/* Card Preview */}
                    {cardToAddFromSearch &&
                      ((
                        <div className="mb-6 p-4 bg-gray-700 rounded-xl">
                          <div className="flex gap-4 items-center">
                            <img
                              src={(() => {
                                const imageSrc =
                                  cardToAddFromSearch.imageUrl ||
                                  cardToAddFromSearch.images?.large ||
                                  cardToAddFromSearch.images?.small ||
                                  cardImages[cardToAddFromSearch.id];
                                return typeof imageSrc === "string"
                                  ? imageSrc
                                  : "";
                              })()}
                              alt={cardToAddFromSearch.name}
                              className="w-20 h-28 object-cover rounded-lg"
                            />
                            <div className="flex-1">
                              <h3 className="text-white text-base font-bold mb-2">
                                {cardToAddFromSearch.name}
                              </h3>
                              <p className="text-gray-300 text-sm mb-1">
                                {cardToAddFromSearch.set_name ||
                                  cardToAddFromSearch.set?.name ||
                                  cardToAddFromSearch.set ||
                                  "Set Name"}
                              </p>
                              <p className="text-gray-400 text-xs mb-2">
                                #
                                {cardToAddFromSearch.number
                                  ? cardToAddFromSearch.number.replace("#", "")
                                  : "001"}
                              </p>
                              <div className="flex justify-between items-center">
                                <span className="text-gray-300 text-xs">
                                  Est. Value:
                                </span>
                                <span className="text-primary text-base font-bold">
                                  $
                                  {calculateDynamicPrice(
                                    cardToAddFromSearch,
                                    selectedVariant,
                                    addCardCondition,
                                    isGraded,
                                    selectedGradingService,
                                    selectedGrade
                                  ).toFixed(2)}
                                </span>
                              </div>
                            </div>
                          </div>
                        </div>
                      ),
                      document.body)}

                    {/* Collection Selection */}
                    <div className="mb-5">
                      <label className="block text-gray-300 text-sm font-medium mb-2">
                        Collection
                      </label>
                      <div className="relative dropdown-container">
                        <button
                          onClick={() =>
                            setShowCollectionDropdown(!showCollectionDropdown)
                          }
                          className="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-3 text-white text-left flex items-center justify-between focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent"
                        >
                          <span>
                            {selectedCollectionForAdd
                              ? userData?.collections.find(
                                  (c) => c.id === selectedCollectionForAdd
                                )?.name
                              : "Select Collection"}
                          </span>
                          <svg
                            className={`w-4 h-4 transition-transform ${
                              showCollectionDropdown ? "rotate-180" : ""
                            }`}
                            fill="none"
                            stroke="currentColor"
                            viewBox="0 0 24 24"
                          >
                            <path
                              strokeLinecap="round"
                              strokeLinejoin="round"
                              strokeWidth={2}
                              d="M19 9l-7 7-7-7"
                            />
                          </svg>
                        </button>
                        {showCollectionDropdown && (
                          <div className="absolute z-50 w-full mt-1 bg-gray-700 border border-gray-600 rounded-lg shadow-lg">
                            <div className="py-1">
                              {userData?.collections.map((collection) => (
                                <button
                                  key={collection.id}
                                  onClick={() => {
                                    setSelectedCollectionForAdd(collection.id);
                                    setShowCollectionDropdown(false);
                                  }}
                                  className="w-full px-4 py-2 text-left text-white hover:bg-gray-600 transition-colors"
                                >
                                  {collection.name}
                                </button>
                              ))}
                            </div>
                          </div>
                        )}
                      </div>
                    </div>

                    {/* Quantity Selection */}
                    <div className="mb-5">
                      <label className="block text-gray-300 text-sm font-medium mb-2">
                        Quantity
                      </label>
                      <div className="flex items-center gap-3">
                        <button
                          onClick={() =>
                            setAddQuantity(Math.max(1, addQuantity - 1))
                          }
                          className="w-10 h-10 bg-gray-700 border border-gray-600 rounded-lg flex items-center justify-center text-white hover:bg-gray-600 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                          disabled={addQuantity <= 1}
                        >
                          <svg
                            className="w-4 h-4"
                            fill="none"
                            stroke="currentColor"
                            viewBox="0 0 24 24"
                          >
                            <path
                              strokeLinecap="round"
                              strokeLinejoin="round"
                              strokeWidth={2}
                              d="M20 12H4"
                            />
                          </svg>
                        </button>
                        <div className="flex-1 bg-gray-700 border border-gray-600 rounded-lg px-4 py-3 text-center">
                          <span className="text-white text-lg font-medium">
                            {addQuantity}
                          </span>
                        </div>
                        <button
                          onClick={() => setAddQuantity(addQuantity + 1)}
                          className="w-10 h-10 bg-gray-700 border border-gray-600 rounded-lg flex items-center justify-center text-white hover:bg-gray-600 transition-colors"
                        >
                          <svg
                            className="w-4 h-4"
                            fill="none"
                            stroke="currentColor"
                            viewBox="0 0 24 24"
                          >
                            <path
                              strokeLinecap="round"
                              strokeLinejoin="round"
                              strokeWidth={2}
                              d="M12 6v6m0 0v6m0-6h6m-6 0H6"
                            />
                          </svg>
                        </button>
                      </div>
                    </div>

                    {/* Variant Selection */}
                    <div className="mb-5">
                      <label className="block text-gray-300 text-sm font-medium mb-2">
                        Variant
                      </label>
                      <div className="relative dropdown-container">
                        <button
                          onClick={() =>
                            setShowVariantDropdown(!showVariantDropdown)
                          }
                          className="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-3 text-white text-left flex items-center justify-between focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent"
                        >
                          <span>{selectedVariant}</span>
                          <svg
                            className={`w-4 h-4 transition-transform ${
                              showVariantDropdown ? "rotate-180" : ""
                            }`}
                            fill="none"
                            stroke="currentColor"
                            viewBox="0 0 24 24"
                          >
                            <path
                              strokeLinecap="round"
                              strokeLinejoin="round"
                              strokeWidth={2}
                              d="M19 9l-7 7-7-7"
                            />
                          </svg>
                        </button>
                        {showVariantDropdown && (
                          <div className="absolute z-50 w-full mt-1 bg-gray-700 border border-gray-600 rounded-lg shadow-lg">
                            <div className="py-1">
                              {(() => {
                                // Get available variants for this specific card based on rarity
                                const availableVariants = [];
                                const rarity =
                                  cardToAddFromSearch?.ext_rarity || "";

                                // Determine variants based on rarity
                                if (
                                  rarity.includes("Holo") ||
                                  rarity.includes("Rare")
                                ) {
                                  // Holo cards can have both Normal and Holo variants
                                  availableVariants.push("Normal");
                                  availableVariants.push("Holo");

                                  // Add Reverse Holo for most holo cards
                                  if (
                                    !rarity.includes("Secret") &&
                                    !rarity.includes("Ultra") &&
                                    !rarity.includes("Hyper")
                                  ) {
                                    availableVariants.push("Reverse Holo");
                                  }
                                } else if (
                                  rarity.includes("Secret") ||
                                  rarity.includes("Ultra") ||
                                  rarity.includes("Hyper")
                                ) {
                                  // Secret/Ultra/Hyper rare cards are typically holo only
                                  availableVariants.push("Holo");
                                } else if (
                                  rarity.includes("Common") ||
                                  rarity.includes("Uncommon")
                                ) {
                                  // Common/Uncommon cards are typically normal only
                                  availableVariants.push("Normal");
                                } else {
                                  // Default to Normal for unknown rarities
                                  availableVariants.push("Normal");
                                }

                                // Add special variants based on rarity
                                if (
                                  rarity.includes("1st Edition") ||
                                  rarity.includes("First Edition")
                                ) {
                                  availableVariants.push("1st Edition");
                                }
                                if (rarity.includes("Shadowless")) {
                                  availableVariants.push("Shadowless");
                                }
                                if (rarity.includes("Radiant")) {
                                  availableVariants.push("Radiant");
                                }

                                // Remove duplicates
                                const uniqueVariants = [
                                  ...new Set(availableVariants),
                                ];

                                // Final fallback: if still no variants, default to Normal
                                if (uniqueVariants.length === 0) {
                                  uniqueVariants.push("Normal");
                                }

                                return uniqueVariants.map((variant) => (
                                  <button
                                    key={variant}
                                    onClick={() => {
                                      setSelectedVariant(variant);
                                      setShowVariantDropdown(false);
                                    }}
                                    className="w-full px-4 py-2 text-left text-white hover:bg-gray-600 transition-colors"
                                  >
                                    {variant}
                                  </button>
                                ));
                              })()}
                            </div>
                          </div>
                        )}
                      </div>
                    </div>

                    {/* Condition Selection */}
                    <div className="mb-5">
                      <label className="block text-gray-300 text-sm font-medium mb-2">
                        Condition
                      </label>
                      <div className="relative dropdown-container">
                        <button
                          onClick={() =>
                            setShowConditionDropdown(!showConditionDropdown)
                          }
                          className="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-3 text-white text-left flex items-center justify-between focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent"
                        >
                          <span>{addCardCondition}</span>
                          <svg
                            className={`w-4 h-4 transition-transform ${
                              showConditionDropdown ? "rotate-180" : ""
                            }`}
                            fill="none"
                            stroke="currentColor"
                            viewBox="0 0 24 24"
                          >
                            <path
                              strokeLinecap="round"
                              strokeLinejoin="round"
                              strokeWidth={2}
                              d="M19 9l-7 7-7-7"
                            />
                          </svg>
                        </button>
                        {showConditionDropdown && (
                          <div className="absolute z-50 w-full mt-1 bg-gray-700 border border-gray-600 rounded-lg shadow-lg">
                            <div className="py-1">
                              {[
                                "Near Mint",
                                "Lightly Played",
                                "Moderately Played",
                                "Heavily Played",
                                "Damaged",
                              ].map((condition) => (
                                <button
                                  key={condition}
                                  onClick={() => {
                                    setAddCardCondition(condition);
                                    setShowConditionDropdown(false);
                                  }}
                                  className="w-full px-4 py-2 text-left text-white hover:bg-gray-600 transition-colors"
                                >
                                  {condition}
                                </button>
                              ))}
                            </div>
                          </div>
                        )}
                      </div>
                    </div>

                    {/* Graded Card Toggle */}
                    <div className="mb-5">
                      <label className="flex items-center gap-3 text-gray-300 text-sm cursor-pointer">
                        <input
                          type="checkbox"
                          checked={isGraded}
                          onChange={(e) => setIsGraded(e.target.checked)}
                          className="w-4 h-4 text-primary bg-gray-700 border-gray-600 rounded focus:ring-primary focus:ring-2"
                        />
                        <span>This is a graded card</span>
                      </label>
                    </div>

                    {/* Grading Service Selection - Only show if graded */}
                    {isGraded && (
                      <div className="mb-5">
                        <label className="block text-gray-300 text-sm font-medium mb-2">
                          Grading Service
                        </label>
                        <div className="relative dropdown-container">
                          <button
                            onClick={() =>
                              setShowGradingServiceDropdown(
                                !showGradingServiceDropdown
                              )
                            }
                            className="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-3 text-white text-left flex items-center justify-between focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent"
                          >
                            <span>{selectedGradingService}</span>
                            <svg
                              className={`w-4 h-4 transition-transform ${
                                showGradingServiceDropdown ? "rotate-180" : ""
                              }`}
                              fill="none"
                              stroke="currentColor"
                              viewBox="0 0 24 24"
                            >
                              <path
                                strokeLinecap="round"
                                strokeLinejoin="round"
                                strokeWidth={2}
                                d="M19 9l-7 7-7-7"
                              />
                            </svg>
                          </button>
                          {showGradingServiceDropdown && (
                            <div className="absolute z-50 w-full mt-1 bg-gray-700 border border-gray-600 rounded-lg shadow-lg">
                              <div className="py-1">
                                {["PSA", "CGC", "TAG", "BGS", "ACE"].map(
                                  (service) => (
                                    <button
                                      key={service}
                                      onClick={() => {
                                        setSelectedGradingService(service);
                                        setShowGradingServiceDropdown(false);
                                      }}
                                      className="w-full px-4 py-2 text-left text-white hover:bg-gray-600 transition-colors"
                                    >
                                      {service}
                                    </button>
                                  )
                                )}
                              </div>
                            </div>
                          )}
                        </div>
                      </div>
                    )}

                    {/* Grade Selection - Only show if graded */}
                    {isGraded && (
                      <div className="mb-5">
                        <label className="block text-gray-300 text-sm font-medium mb-2">
                          Grade
                        </label>
                        <div className="relative dropdown-container">
                          <button
                            onClick={() =>
                              setShowGradeDropdown(!showGradeDropdown)
                            }
                            className="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-3 text-white text-left flex items-center justify-between focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent"
                          >
                            <span>{selectedGrade}</span>
                            <svg
                              className={`w-4 h-4 transition-transform ${
                                showGradeDropdown ? "rotate-180" : ""
                              }`}
                              fill="none"
                              stroke="currentColor"
                              viewBox="0 0 24 24"
                            >
                              <path
                                strokeLinecap="round"
                                strokeLinejoin="round"
                                strokeWidth={2}
                                d="M19 9l-7 7-7-7"
                              />
                            </svg>
                          </button>
                          {showGradeDropdown && (
                            <div className="absolute z-50 w-full mt-1 bg-gray-700 border border-gray-600 rounded-lg shadow-lg max-h-48 overflow-y-auto">
                              <div className="py-1">
                                {selectedGradingService === "PSA" &&
                                  [
                                    "1",
                                    "2",
                                    "3",
                                    "4",
                                    "5",
                                    "6",
                                    "7",
                                    "8",
                                    "9",
                                    "10",
                                  ].map((grade) => (
                                    <button
                                      key={grade}
                                      onClick={() => {
                                        setSelectedGrade(grade);
                                        setShowGradeDropdown(false);
                                      }}
                                      className="w-full px-4 py-2 text-left text-white hover:bg-gray-600 transition-colors"
                                    >
                                      {grade}
                                    </button>
                                  ))}
                                {selectedGradingService === "CGC" &&
                                  [
                                    "1",
                                    "2",
                                    "3",
                                    "4",
                                    "5",
                                    "6",
                                    "7",
                                    "8",
                                    "9",
                                    "10",
                                  ].map((grade) => (
                                    <button
                                      key={grade}
                                      onClick={() => {
                                        setSelectedGrade(grade);
                                        setShowGradeDropdown(false);
                                      }}
                                      className="w-full px-4 py-2 text-left text-white hover:bg-gray-600 transition-colors"
                                    >
                                      {grade}
                                    </button>
                                  ))}
                                {selectedGradingService === "TAG" &&
                                  [
                                    "1",
                                    "2",
                                    "3",
                                    "4",
                                    "5",
                                    "6",
                                    "7",
                                    "8",
                                    "9",
                                    "10",
                                  ].map((grade) => (
                                    <button
                                      key={grade}
                                      onClick={() => {
                                        setSelectedGrade(grade);
                                        setShowGradeDropdown(false);
                                      }}
                                      className="w-full px-4 py-2 text-left text-white hover:bg-gray-600 transition-colors"
                                    >
                                      {grade}
                                    </button>
                                  ))}
                                {selectedGradingService === "BGS" &&
                                  [
                                    "1",
                                    "1.5",
                                    "2",
                                    "2.5",
                                    "3",
                                    "3.5",
                                    "4",
                                    "4.5",
                                    "5",
                                    "5.5",
                                    "6",
                                    "6.5",
                                    "7",
                                    "7.5",
                                    "8",
                                    "8.5",
                                    "9",
                                    "9.5",
                                    "10",
                                  ].map((grade) => (
                                    <button
                                      key={grade}
                                      onClick={() => {
                                        setSelectedGrade(grade);
                                        setShowGradeDropdown(false);
                                      }}
                                      className="w-full px-4 py-2 text-left text-white hover:bg-gray-600 transition-colors"
                                    >
                                      {grade}
                                    </button>
                                  ))}
                                {selectedGradingService === "ACE" &&
                                  [
                                    "1",
                                    "2",
                                    "3",
                                    "4",
                                    "5",
                                    "6",
                                    "7",
                                    "8",
                                    "9",
                                    "10",
                                  ].map((grade) => (
                                    <button
                                      key={grade}
                                      onClick={() => {
                                        setSelectedGrade(grade);
                                        setShowGradeDropdown(false);
                                      }}
                                      className="w-full px-4 py-2 text-left text-white hover:bg-gray-600 transition-colors"
                                    >
                                      {grade}
                                    </button>
                                  ))}
                              </div>
                            </div>
                          )}
                        </div>
                      </div>
                    )}

                    {/* Notes */}
                    <div className="mb-6">
                      <label className="block text-gray-300 text-sm font-medium mb-2">
                        Notes (Optional)
                      </label>
                      <textarea
                        value={addNote}
                        onChange={(e) => setAddNote(e.target.value)}
                        placeholder="Add any notes about this card..."
                        className="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-3 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent resize-none h-20"
                      />
                    </div>
                  </div>

                  {/* Action Buttons - Fixed at bottom */}
                  <div className="p-6 pt-4 border-t border-gray-700">
                    <div className="flex gap-3">
                      <button
                        onClick={() => {
                          setShowSearchResultsModal(false);
                          setCardToAddFromSearch(null);
                        }}
                        className="flex-1 bg-gray-600 hover:bg-gray-500 text-white py-3 px-4 rounded-lg font-medium transition-colors"
                      >
                        Cancel
                      </button>
                      <button
                        onClick={handleConfirmAddToCollection}
                        className="flex-1 bg-primary hover:bg-primary/80 text-white py-3 px-4 rounded-lg font-medium transition-colors"
                      >
                        Add to Collection
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            )}

          {/* Add to Collection Modal - Dashboard - Rendered at top level */}
          {showAddToCollectionModal &&
            cardToAdd &&
            createPortal(
              <div
                className="fixed left-0 right-0 top-0 bottom-0 z-[100600] backdrop-blur-sm flex items-end justify-center p-0.5 sm:p-4 overflow-y-auto"
                style={{ top: "0px", bottom: "0px" }}
              >
                <div className="bg-gray-800 rounded-2xl w-full max-w-md mx-auto relative z-[100501] modal-container max-h-[82vh] sm:max-h-[80vh] flex flex-col shadow-2xl border border-gray-600 pointer-events-auto">
                  <div className="p-4 sm:p-6 overflow-y-auto flex-1">
                    {/* Header */}
                    <div className="flex items-center justify-between mb-4 sm:mb-6">
                      <h2 className="text-white text-xl font-semibold">
                        Add to Collection
                      </h2>
                      <button
                        onClick={() => {
                          setShowAddToCollectionModal(false);
                          setCardToAdd(null);
                        }}
                        className="w-8 h-8 bg-gray-600 rounded-full flex items-center justify-center text-white hover:bg-gray-500 transition-colors border border-gray-500"
                      >
                        <svg
                          className="w-4 h-4"
                          fill="none"
                          stroke="currentColor"
                          viewBox="0 0 24 24"
                        >
                          <path
                            strokeLinecap="round"
                            strokeLinejoin="round"
                            strokeWidth={2}
                            d="M6 18L18 6M6 6l12 12"
                          />
                        </svg>
                      </button>
                    </div>

                    {/* Card Preview */}
                    {cardToAdd && (
                      <div className="mb-6 p-4 bg-gray-700 rounded-xl border border-gray-600">
                        <div className="flex gap-4 items-center">
                          <img
                            src={getCardImageUrl(cardToAdd)}
                            alt={cardToAdd.name}
                            className="w-20 h-28 object-cover rounded-lg"
                          />
                          <div className="flex-1">
                            <h3 className="text-white text-base font-bold mb-2">
                              {cardToAdd.name}
                            </h3>
                            <p className="text-blue-300 text-sm mb-1">
                              {cardToAdd.set_name ||
                                cardToAdd.set?.name ||
                                cardToAdd.set ||
                                "Set Name"}
                            </p>
                            <p className="text-blue-300 text-xs mb-2">
                              #
                              {cardToAdd.number
                                ? cardToAdd.number.replace("#", "")
                                : "001"}
                            </p>
                            <div className="flex justify-between items-center">
                              <span className="text-blue-300 text-xs">
                                Est. Value:
                              </span>
                              <span className="text-blue-300 text-base font-bold">
                                {formatCurrency(
                                  updatedCollectionPrices[cardToAdd?.cardId] ||
                                    cardToAdd.current_value ||
                                    cardToAdd.price ||
                                    0
                                )}
                              </span>
                            </div>
                          </div>
                        </div>
                      </div>
                    )}

                    {/* Collection Selection */}
                    <div className="mb-5">
                      <label className="block text-blue-300 text-sm font-medium mb-2">
                        Collection
                      </label>
                      <div className="relative dropdown-container">
                        <button
                          onClick={() =>
                            setShowCollectionDropdown(!showCollectionDropdown)
                          }
                          className="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-3 text-white text-left flex items-center justify-between focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        >
                          <span>
                            {selectedCollectionForAdd
                              ? userData?.collections.find(
                                  (c) => c.id === selectedCollectionForAdd
                                )?.name
                              : "Select Collection"}
                          </span>
                          <svg
                            className={`w-4 h-4 transition-transform ${
                              showCollectionDropdown ? "rotate-180" : ""
                            }`}
                            fill="none"
                            stroke="currentColor"
                            viewBox="0 0 24 24"
                          >
                            <path
                              strokeLinecap="round"
                              strokeLinejoin="round"
                              strokeWidth={2}
                              d="M19 9l-7 7-7-7"
                            />
                          </svg>
                        </button>
                        {showCollectionDropdown && (
                          <div className="absolute z-50 w-full mt-1 bg-gray-700 border border-gray-600 rounded-lg shadow-lg">
                            <div className="py-1">
                              {userData?.collections.map((collection) => (
                                <button
                                  key={collection.id}
                                  onClick={() => {
                                    setSelectedCollectionForAdd(collection.id);
                                    setShowCollectionDropdown(false);
                                  }}
                                  className="w-full px-4 py-2 text-left text-white hover:bg-white/10 transition-colors"
                                >
                                  {collection.name}
                                </button>
                              ))}
                            </div>
                          </div>
                        )}
                      </div>
                    </div>

                    {/* Quantity Selection */}
                    <div className="mb-5">
                      <label className="block text-blue-300 text-sm font-medium mb-2">
                        Quantity
                      </label>
                      <div className="flex items-center gap-3">
                        <button
                          onClick={() =>
                            setAddQuantity(Math.max(1, addQuantity - 1))
                          }
                          className="w-10 h-10 bg-gray-700 border border-gray-600 rounded-lg flex items-center justify-center text-white hover:bg-gray-600 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                          disabled={addQuantity <= 1}
                        >
                          <svg
                            className="w-4 h-4"
                            fill="none"
                            stroke="currentColor"
                            viewBox="0 0 24 24"
                          >
                            <path
                              strokeLinecap="round"
                              strokeLinejoin="round"
                              strokeWidth={2}
                              d="M20 12H4"
                            />
                          </svg>
                        </button>
                        <div className="flex-1 bg-gray-700 border border-gray-600 rounded-lg px-4 py-3 text-center">
                          <span className="text-white text-lg font-medium">
                            {addQuantity}
                          </span>
                        </div>
                        <button
                          onClick={() => setAddQuantity(addQuantity + 1)}
                          className="w-10 h-10 bg-gray-700 border border-gray-600 rounded-lg flex items-center justify-center text-white hover:bg-gray-600 transition-colors"
                        >
                          <svg
                            className="w-4 h-4"
                            fill="none"
                            stroke="currentColor"
                            viewBox="0 0 24 24"
                          >
                            <path
                              strokeLinecap="round"
                              strokeLinejoin="round"
                              strokeWidth={2}
                              d="M12 6v6m0 0v6m0-6h6m-6 0H6"
                            />
                          </svg>
                        </button>
                      </div>
                    </div>

                    {/* Variant Selection */}
                    <div className="mb-5">
                      <label className="block text-blue-300 text-sm font-medium mb-2">
                        Variant
                      </label>
                      <div className="relative dropdown-container">
                        <button
                          onClick={() =>
                            setShowVariantDropdown(!showVariantDropdown)
                          }
                          className="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-3 text-white text-left flex items-center justify-between focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        >
                          <span>{selectedVariant}</span>
                          <svg
                            className={`w-4 h-4 transition-transform ${
                              showVariantDropdown ? "rotate-180" : ""
                            }`}
                            fill="none"
                            stroke="currentColor"
                            viewBox="0 0 24 24"
                          >
                            <path
                              strokeLinecap="round"
                              strokeLinejoin="round"
                              strokeWidth={2}
                              d="M19 9l-7 7-7-7"
                            />
                          </svg>
                        </button>
                        {showVariantDropdown && (
                          <div className="absolute z-50 w-full mt-1 bg-gray-700 border border-gray-600 rounded-lg shadow-lg">
                            <div className="py-1">
                              {(() => {
                                const availableVariants = [];

                                if (cardToAdd?.variant_normal) {
                                  availableVariants.push("Normal");
                                }
                                if (cardToAdd?.variant_holo) {
                                  availableVariants.push("Holo");
                                }
                                if (cardToAdd?.variant_reverse) {
                                  availableVariants.push("Reverse Holo");
                                }
                                if (cardToAdd?.variant_first_edition) {
                                  availableVariants.push("1st Edition");
                                }

                                // Fallback: if no boolean variants are set, check the variants array
                                if (
                                  availableVariants.length === 0 &&
                                  cardToAdd?.variants
                                ) {
                                  const variantMap = {
                                    Normal: "Normal",
                                    Holo: "Holo",
                                    "Reverse Holo": "Reverse Holo",
                                    "1st Edition": "1st Edition",
                                  };

                                  cardToAdd.variants.forEach((variant) => {
                                    const mappedVariant = variantMap[variant];
                                    if (
                                      mappedVariant &&
                                      !availableVariants.includes(mappedVariant)
                                    ) {
                                      availableVariants.push(mappedVariant);
                                    }
                                  });
                                }

                                // Final fallback: if still no variants, default to Normal
                                if (availableVariants.length === 0) {
                                  availableVariants.push("Normal");
                                }

                                return availableVariants.map((variant) => (
                                  <button
                                    key={variant}
                                    onClick={() => {
                                      setSelectedVariant(variant);
                                      setShowVariantDropdown(false);
                                    }}
                                    className="w-full px-4 py-2 text-left text-white hover:bg-gray-600 transition-colors"
                                  >
                                    {variant}
                                  </button>
                                ));
                              })()}
                            </div>
                          </div>
                        )}
                      </div>
                    </div>

                    {/* Condition Selection */}
                    <div className="mb-5">
                      <label className="block text-blue-300 text-sm font-medium mb-2">
                        Condition
                      </label>
                      <div className="relative dropdown-container">
                        <button
                          onClick={() =>
                            setShowConditionDropdown(!showConditionDropdown)
                          }
                          className="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-3 text-white text-left flex items-center justify-between focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        >
                          <span>{addCardCondition}</span>
                          <svg
                            className={`w-4 h-4 transition-transform ${
                              showConditionDropdown ? "rotate-180" : ""
                            }`}
                            fill="none"
                            stroke="currentColor"
                            viewBox="0 0 24 24"
                          >
                            <path
                              strokeLinecap="round"
                              strokeLinejoin="round"
                              strokeWidth={2}
                              d="M19 9l-7 7-7-7"
                            />
                          </svg>
                        </button>
                        {showConditionDropdown && (
                          <div className="absolute z-50 w-full mt-1 bg-gray-700 border border-gray-600 rounded-lg shadow-lg">
                            <div className="py-1">
                              {[
                                "Near Mint",
                                "Lightly Played",
                                "Moderately Played",
                                "Heavily Played",
                                "Damaged",
                              ].map((condition) => (
                                <button
                                  key={condition}
                                  onClick={() => {
                                    setAddCardCondition(condition);
                                    setShowConditionDropdown(false);
                                  }}
                                  className="w-full px-4 py-2 text-left text-white hover:bg-gray-600 transition-colors"
                                >
                                  {condition}
                                </button>
                              ))}
                            </div>
                          </div>
                        )}
                      </div>
                    </div>

                    {/* Graded Card Toggle */}
                    <div className="mb-5">
                      <label className="flex items-center gap-3 text-blue-300 text-sm cursor-pointer">
                        <input
                          type="checkbox"
                          checked={isGraded}
                          onChange={(e) => setIsGraded(e.target.checked)}
                          className="w-4 h-4 text-blue-500 bg-gray-700 border-gray-600 rounded focus:ring-blue-500 focus:ring-2"
                        />
                        <span>This is a graded card</span>
                      </label>
                    </div>

                    {/* Grading Service Selection - Only show if graded */}
                    {isGraded && (
                      <div className="mb-5">
                        <label className="block text-blue-300 text-sm font-medium mb-2">
                          Grading Service
                        </label>
                        <div className="relative dropdown-container">
                          <button
                            onClick={() =>
                              setShowGradingServiceDropdown(
                                !showGradingServiceDropdown
                              )
                            }
                            className="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-3 text-white text-left flex items-center justify-between focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                          >
                            <span>{selectedGradingService}</span>
                            <svg
                              className={`w-4 h-4 transition-transform ${
                                showGradingServiceDropdown ? "rotate-180" : ""
                              }`}
                              fill="none"
                              stroke="currentColor"
                              viewBox="0 0 24 24"
                            >
                              <path
                                strokeLinecap="round"
                                strokeLinejoin="round"
                                strokeWidth={2}
                                d="M19 9l-7 7-7-7"
                              />
                            </svg>
                          </button>
                          {showGradingServiceDropdown && (
                            <div className="absolute z-50 w-full mt-1 bg-gray-700 border border-gray-600 rounded-lg shadow-lg">
                              <div className="py-1">
                                {["PSA", "CGC", "TAG", "BGS", "ACE"].map(
                                  (service) => (
                                    <button
                                      key={service}
                                      onClick={() => {
                                        setSelectedGradingService(service);
                                        setShowGradingServiceDropdown(false);
                                      }}
                                      className="w-full px-4 py-2 text-left text-white hover:bg-gray-600 transition-colors"
                                    >
                                      {service}
                                    </button>
                                  )
                                )}
                              </div>
                            </div>
                          )}
                        </div>
                      </div>
                    )}

                    {/* Grade Selection - Only show if graded */}
                    {isGraded && (
                      <div className="mb-5">
                        <label className="block text-blue-300 text-sm font-medium mb-2">
                          Grade
                        </label>
                        <div className="relative dropdown-container">
                          <button
                            onClick={() =>
                              setShowGradeDropdown(!showGradeDropdown)
                            }
                            className="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-3 text-white text-left flex items-center justify-between focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                          >
                            <span>{selectedGrade}</span>
                            <svg
                              className={`w-4 h-4 transition-transform ${
                                showGradeDropdown ? "rotate-180" : ""
                              }`}
                              fill="none"
                              stroke="currentColor"
                              viewBox="0 0 24 24"
                            >
                              <path
                                strokeLinecap="round"
                                strokeLinejoin="round"
                                strokeWidth={2}
                                d="M19 9l-7 7-7-7"
                              />
                            </svg>
                          </button>
                          {showGradeDropdown && (
                            <div className="absolute z-50 w-full mt-1 bg-gray-700 border border-gray-600 rounded-lg shadow-lg max-h-48 overflow-y-auto">
                              <div className="py-1">
                                {selectedGradingService === "PSA" &&
                                  [
                                    "1",
                                    "2",
                                    "3",
                                    "4",
                                    "5",
                                    "6",
                                    "7",
                                    "8",
                                    "9",
                                    "10",
                                  ].map((grade) => (
                                    <button
                                      key={grade}
                                      onClick={() => {
                                        setSelectedGrade(grade);
                                        setShowGradeDropdown(false);
                                      }}
                                      className="w-full px-4 py-2 text-left text-white hover:bg-gray-600 transition-colors"
                                    >
                                      {grade}
                                    </button>
                                  ))}
                                {selectedGradingService === "CGC" &&
                                  [
                                    "1",
                                    "2",
                                    "3",
                                    "4",
                                    "5",
                                    "6",
                                    "7",
                                    "8",
                                    "9",
                                    "10",
                                  ].map((grade) => (
                                    <button
                                      key={grade}
                                      onClick={() => {
                                        setSelectedGrade(grade);
                                        setShowGradeDropdown(false);
                                      }}
                                      className="w-full px-4 py-2 text-left text-white hover:bg-gray-600 transition-colors"
                                    >
                                      {grade}
                                    </button>
                                  ))}
                                {selectedGradingService === "TAG" &&
                                  [
                                    "1",
                                    "2",
                                    "3",
                                    "4",
                                    "5",
                                    "6",
                                    "7",
                                    "8",
                                    "9",
                                    "10",
                                  ].map((grade) => (
                                    <button
                                      key={grade}
                                      onClick={() => {
                                        setSelectedGrade(grade);
                                        setShowGradeDropdown(false);
                                      }}
                                      className="w-full px-4 py-2 text-left text-white hover:bg-gray-600 transition-colors"
                                    >
                                      {grade}
                                    </button>
                                  ))}
                                {selectedGradingService === "BGS" &&
                                  [
                                    "1",
                                    "1.5",
                                    "2",
                                    "2.5",
                                    "3",
                                    "3.5",
                                    "4",
                                    "4.5",
                                    "5",
                                    "5.5",
                                    "6",
                                    "6.5",
                                    "7",
                                    "7.5",
                                    "8",
                                    "8.5",
                                    "9",
                                    "9.5",
                                    "10",
                                  ].map((grade) => (
                                    <button
                                      key={grade}
                                      onClick={() => {
                                        setSelectedGrade(grade);
                                        setShowGradeDropdown(false);
                                      }}
                                      className="w-full px-4 py-2 text-left text-white hover:bg-gray-600 transition-colors"
                                    >
                                      {grade}
                                    </button>
                                  ))}
                                {selectedGradingService === "ACE" &&
                                  [
                                    "1",
                                    "2",
                                    "3",
                                    "4",
                                    "5",
                                    "6",
                                    "7",
                                    "8",
                                    "9",
                                    "10",
                                  ].map((grade) => (
                                    <button
                                      key={grade}
                                      onClick={() => {
                                        setSelectedGrade(grade);
                                        setShowGradeDropdown(false);
                                      }}
                                      className="w-full px-4 py-2 text-left text-white hover:bg-gray-600 transition-colors"
                                    >
                                      {grade}
                                    </button>
                                  ))}
                              </div>
                            </div>
                          )}
                        </div>
                      </div>
                    )}

                    {/* Review Matches Toggle - Only show if matches are available */}
                    {cardToAdd?.showMatchesToggle &&
                      cardToAdd?.allMatches &&
                      cardToAdd.allMatches.length > 1 && (
                        <div className="mb-5">
                          <button
                            onClick={() =>
                              setShowMatchesReview(!showMatchesReview)
                            }
                            className="w-full flex items-center justify-between p-3 bg-gray-700 border border-gray-600 rounded-lg hover:bg-gray-600 transition-colors"
                          >
                            <span className="text-blue-300 text-sm font-medium">
                              Review Potential Matches (
                              {cardToAdd.allMatches.length})
                            </span>
                            <svg
                              className={`w-5 h-5 text-blue-300 transition-transform ${
                                showMatchesReview ? "rotate-180" : ""
                              }`}
                              fill="none"
                              stroke="currentColor"
                              viewBox="0 0 24 24"
                            >
                              <path
                                strokeLinecap="round"
                                strokeLinejoin="round"
                                strokeWidth={2}
                                d="M19 9l-7 7-7-7"
                              />
                            </svg>
                          </button>

                          {showMatchesReview && (
                            <div className="mt-3 max-h-64 overflow-y-auto space-y-2">
                              {cardToAdd.allMatches
                                .slice(0, 10)
                                .map((match, idx) => (
                                  <button
                                    key={match.product_id || match.id || idx}
                                    onClick={() => {
                                      // Update cardToAdd with selected match
                                      setCardToAdd({
                                        ...match,
                                        allMatches: cardToAdd.allMatches,
                                        showMatchesToggle: true,
                                      });
                                      setShowMatchesReview(false);
                                    }}
                                    className={`w-full p-3 rounded-lg border text-left transition-colors ${
                                      (match.product_id || match.id) ===
                                      (cardToAdd.product_id || cardToAdd.id)
                                        ? "bg-blue-600/30 border-blue-500"
                                        : "bg-gray-700 border-gray-600 hover:bg-gray-600"
                                    }`}
                                  >
                                    <div className="flex items-center gap-3">
                                      {match.images?.small && (
                                        <img
                                          src={match.images.small}
                                          alt={match.name}
                                          className="w-12 h-16 object-cover rounded"
                                        />
                                      )}
                                      <div className="flex-1 min-w-0">
                                        <p className="text-white text-sm font-medium truncate">
                                          {match.name || match.cleanName}
                                        </p>
                                        <p className="text-gray-400 text-xs truncate">
                                          {match.set_name ||
                                            match.clean_set_name ||
                                            "Unknown Set"}
                                        </p>
                                        {match.ext_number && (
                                          <p className="text-gray-500 text-xs">
                                            #{match.ext_number}
                                          </p>
                                        )}
                                      </div>
                                      {(match.product_id || match.id) ===
                                        (cardToAdd.product_id ||
                                          cardToAdd.id) && (
                                        <svg
                                          className="w-5 h-5 text-blue-400"
                                          fill="none"
                                          stroke="currentColor"
                                          viewBox="0 0 24 24"
                                        >
                                          <path
                                            strokeLinecap="round"
                                            strokeLinejoin="round"
                                            strokeWidth={2}
                                            d="M5 13l4 4L19 7"
                                          />
                                        </svg>
                                      )}
                                    </div>
                                  </button>
                                ))}
                            </div>
                          )}
                        </div>
                      )}

                    {/* Notes */}
                    <div className="mb-6">
                      <label className="block text-blue-300 text-sm font-medium mb-2">
                        Notes (Optional)
                      </label>
                      <textarea
                        value={addNote}
                        onChange={(e) => setAddNote(e.target.value)}
                        placeholder="Add any notes about this card..."
                        className="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-3 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none h-20"
                      />
                    </div>
                  </div>

                  <div className="p-6 pt-4 border-t border-gray-600">
                    <div className="flex gap-3">
                      <button
                        onClick={() => {
                          setShowAddToCollectionModal(false);
                          setCardToAdd(null);
                          setShowMatchesReview(false);
                        }}
                        className="flex-1 bg-gray-600 hover:bg-gray-500 text-white py-3 px-4 rounded-lg font-medium transition-colors border border-gray-500"
                      >
                        Cancel
                      </button>
                      <button
                        onClick={handleConfirmAddToCollection}
                        className="flex-1 bg-gradient-to-r from-blue-500 to-indigo-600 hover:from-blue-600 hover:to-indigo-700 text-white py-3 px-4 rounded-lg font-medium transition-colors"
                      >
                        Add to Collection
                      </button>
                    </div>
                  </div>
                </div>
              </div>,
              document.body
            )}

          {/* Edit Profile Modal */}
          {showEditProfile &&
            createPortal(
              <div className="fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center z-[10003] p-4">
                <div className="bg-gray-800/95 backdrop-blur-xl border border-gray-600/50 rounded-2xl w-full max-w-lg max-h-[90vh] overflow-y-auto shadow-2xl">
                  <div className="sticky top-0 bg-gray-800/95 backdrop-blur-xl p-6 border-b border-gray-700/50 z-10">
                    <div className="flex items-center justify-between">
                      <h3 className="text-white text-xl font-semibold">
                        Edit Profile
                      </h3>
                      <button
                        onClick={() => {
                          setShowEditProfile(false);
                          // Reset form values when closing
                          setEditDisplayName(user?.fullName || "");
                          setEditUsername(user?.username || "");
                          setEditTagline(user?.tagline || "");
                          setEditAboutMe(user?.aboutMe || "");
                          setEditSocialLinks(
                            user?.socialLinks || {
                              twitter: "",
                              instagram: "",
                              youtube: "",
                              tiktok: "",
                              website: "",
                            }
                          );
                          setEditCollectingGoals(user?.collectingGoals || []);
                        }}
                        className="text-gray-400 hover:text-white transition-colors"
                      >
                        <svg
                          className="w-6 h-6"
                          fill="none"
                          stroke="currentColor"
                          viewBox="0 0 24 24"
                        >
                          <path
                            strokeLinecap="round"
                            strokeLinejoin="round"
                            strokeWidth="2"
                            d="M6 18L18 6M6 6l12 12"
                          />
                        </svg>
                      </button>
                    </div>
                  </div>

                  <div className="p-6 space-y-6">
                    {/* Cover Photo */}
                    <div>
                      <label className="text-gray-300 text-sm font-medium mb-2 block">
                        Cover Photo
                      </label>
                      <div className="relative h-32 rounded-xl overflow-hidden border border-white/10">
                        {coverPhotoPreview ? (
                          <img
                            src={coverPhotoPreview}
                            alt="Cover"
                            className="absolute inset-0 w-full h-full object-cover opacity-60"
                          />
                        ) : (
                          <div className="absolute inset-0 bg-gradient-to-br from-[#6865E7] via-[#5B59D9] to-[#4F4DCB] dark:from-[#6865E7] dark:via-[#5B59D9] dark:to-[#4F4DCB]"></div>
                        )}
                        <div className="absolute inset-0 flex items-center justify-center">
                          <input
                            type="file"
                            accept="image/*"
                            onChange={handleCoverPhotoChange}
                            className="hidden"
                            id="cover-photo-input"
                          />
                          <label
                            htmlFor="cover-photo-input"
                            className="bg-black/50 backdrop-blur-sm text-white px-4 py-2 rounded-lg text-sm font-medium hover:bg-black/70 transition-colors cursor-pointer"
                          >
                            {coverPhotoPreview
                              ? "Change Cover"
                              : "Upload Cover"}
                          </label>
                          {coverPhotoPreview && (
                            <button
                              onClick={handleRemoveCoverPhoto}
                              className="ml-2 bg-red-500/50 backdrop-blur-sm text-white px-4 py-2 rounded-lg text-sm font-medium hover:bg-red-500/70 transition-colors"
                            >
                              Remove
                            </button>
                          )}
                        </div>
                      </div>
                    </div>

                    {/* Profile Picture */}
                    <div>
                      <label className="text-gray-300 text-sm font-medium mb-2 block">
                        Profile Picture
                      </label>
                      <div className="flex items-center gap-4">
                        <div className="w-20 h-20 rounded-full bg-gradient-to-br from-blue-500 to-purple-600 p-1 shadow-xl">
                          {profilePicturePreview ? (
                            <img
                              src={profilePicturePreview}
                              alt="Profile Preview"
                              className="w-full h-full rounded-full object-cover"
                            />
                          ) : user?.profileImage ? (
                            <img
                              src={user.profileImage}
                              alt="Profile"
                              className="w-full h-full rounded-full object-cover"
                            />
                          ) : (
                            <div className="w-full h-full rounded-full dark:bg-gray-900 bg-gray-300 flex items-center justify-center dark:text-white text-theme-primary text-2xl font-bold">
                              {user?.fullName?.charAt(0) ||
                                user?.username?.charAt(0) ||
                                "G"}
                            </div>
                          )}
                        </div>
                        <div className="flex flex-col gap-2">
                          <input
                            type="file"
                            accept="image/*"
                            onChange={handleProfilePictureChange}
                            className="hidden"
                            id="profile-picture-input"
                          />
                          <label
                            htmlFor="profile-picture-input"
                            className="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors cursor-pointer text-center"
                          >
                            {profilePicturePreview
                              ? "Change Photo"
                              : "Upload Photo"}
                          </label>
                          {profilePicturePreview && (
                            <button
                              onClick={handleRemoveProfilePicture}
                              className="bg-white/10 hover:bg-white/20 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors border border-white/10"
                            >
                              Remove
                            </button>
                          )}
                        </div>
                      </div>
                    </div>

                    {/* Name */}
                    <div>
                      <label className="text-gray-300 text-sm font-medium mb-2 block">
                        Display Name
                      </label>
                      <input
                        type="text"
                        value={editDisplayName}
                        onChange={(e) => setEditDisplayName(e.target.value)}
                        className="w-full bg-white/5 border border-white/10 rounded-lg px-4 py-3 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500/50 focus:border-blue-500/50"
                      />
                    </div>

                    {/* Username */}
                    <div>
                      <label className="text-gray-300 text-sm font-medium mb-2 block">
                        Username
                      </label>
                      <div className="relative">
                        <span className="absolute left-4 top-1/2 -translate-y-1/2 text-gray-400">
                          @
                        </span>
                        <input
                          type="text"
                          value={editUsername}
                          onChange={(e) => setEditUsername(e.target.value)}
                          className="w-full bg-white/5 border border-white/10 rounded-lg pl-8 pr-4 py-3 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500/50 focus:border-blue-500/50"
                        />
                      </div>
                    </div>

                    {/* Tagline */}
                    <div>
                      <label className="text-gray-300 text-sm font-medium mb-2 block">
                        Tagline
                      </label>
                      <input
                        type="text"
                        value={editTagline}
                        onChange={(e) => setEditTagline(e.target.value)}
                        placeholder="Your collecting specialty..."
                        className="w-full bg-white/5 border border-white/10 rounded-lg px-4 py-3 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500/50 focus:border-blue-500/50"
                      />
                    </div>

                    {/* About */}
                    <div>
                      <label className="text-gray-300 text-sm font-medium mb-2 block">
                        About Me
                      </label>
                      <textarea
                        value={editAboutMe}
                        onChange={(e) => setEditAboutMe(e.target.value)}
                        placeholder="Tell other collectors about yourself..."
                        rows={4}
                        className="w-full bg-white/5 border border-white/10 rounded-lg px-4 py-3 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500/50 focus:border-blue-500/50 resize-none"
                      />
                    </div>

                    {/* Social Links */}
                    <div>
                      <label className="text-gray-300 text-sm font-medium mb-2 block">
                        Social Links
                      </label>
                      <div className="space-y-3">
                        <input
                          type="text"
                          placeholder="Twitter/X username"
                          value={editSocialLinks.twitter || ""}
                          onChange={(e) =>
                            setEditSocialLinks({
                              ...editSocialLinks,
                              twitter: e.target.value,
                            })
                          }
                          className="w-full bg-white/5 border border-white/10 rounded-lg px-4 py-3 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500/50 focus:border-blue-500/50"
                        />
                        <input
                          type="text"
                          placeholder="Instagram username"
                          value={editSocialLinks.instagram || ""}
                          onChange={(e) =>
                            setEditSocialLinks({
                              ...editSocialLinks,
                              instagram: e.target.value,
                            })
                          }
                          className="w-full bg-white/5 border border-white/10 rounded-lg px-4 py-3 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500/50 focus:border-blue-500/50"
                        />
                        <input
                          type="text"
                          placeholder="YouTube channel"
                          value={editSocialLinks.youtube || ""}
                          onChange={(e) =>
                            setEditSocialLinks({
                              ...editSocialLinks,
                              youtube: e.target.value,
                            })
                          }
                          className="w-full bg-white/5 border border-white/10 rounded-lg px-4 py-3 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500/50 focus:border-blue-500/50"
                        />
                        <input
                          type="text"
                          placeholder="TikTok username"
                          value={editSocialLinks.tiktok || ""}
                          onChange={(e) =>
                            setEditSocialLinks({
                              ...editSocialLinks,
                              tiktok: e.target.value,
                            })
                          }
                          className="w-full bg-white/5 border border-white/10 rounded-lg px-4 py-3 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500/50 focus:border-blue-500/50"
                        />
                        <input
                          type="text"
                          placeholder="Website URL"
                          value={editSocialLinks.website || ""}
                          onChange={(e) =>
                            setEditSocialLinks({
                              ...editSocialLinks,
                              website: e.target.value,
                            })
                          }
                          className="w-full bg-white/5 border border-white/10 rounded-lg px-4 py-3 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500/50 focus:border-blue-500/50"
                        />
                      </div>
                    </div>

                    {/* Privacy Settings */}
                    <div>
                      <label className="text-gray-300 text-sm font-medium mb-3 block">
                        Privacy Settings
                      </label>
                      <div className="space-y-3 bg-white/5 rounded-lg p-4 border border-white/10">
                        <div className="flex items-center justify-between">
                          <span className="text-gray-300 text-sm">
                            Public Profile
                          </span>
                          <button className="relative w-12 h-6 bg-blue-500 rounded-full transition-colors">
                            <div className="absolute right-1 top-1 w-4 h-4 bg-white rounded-full transition-transform"></div>
                          </button>
                        </div>
                        <div className="flex items-center justify-between">
                          <span className="text-gray-300 text-sm">
                            Show Collection Value
                          </span>
                          <button className="relative w-12 h-6 bg-blue-500 rounded-full transition-colors">
                            <div className="absolute right-1 top-1 w-4 h-4 bg-white rounded-full transition-transform"></div>
                          </button>
                        </div>
                        <div className="flex items-center justify-between">
                          <span className="text-gray-300 text-sm">
                            Show Wishlist
                          </span>
                          <button className="relative w-12 h-6 bg-blue-500 rounded-full transition-colors">
                            <div className="absolute right-1 top-1 w-4 h-4 bg-white rounded-full transition-transform"></div>
                          </button>
                        </div>
                        <div className="flex items-center justify-between">
                          <span className="text-gray-300 text-sm">
                            Allow Messages
                          </span>
                          <button className="relative w-12 h-6 bg-gray-600 rounded-full transition-colors">
                            <div className="absolute left-1 top-1 w-4 h-4 bg-white rounded-full transition-transform"></div>
                          </button>
                        </div>
                      </div>
                    </div>

                    {/* Action Buttons */}
                    <div className="flex gap-3">
                      <button
                        onClick={() => {
                          setShowEditProfile(false);
                          // Reset form values when canceling
                          setEditDisplayName(user?.fullName || "");
                          setEditUsername(user?.username || "");
                          setEditTagline(user?.tagline || "");
                          setEditAboutMe(user?.aboutMe || "");
                          setEditSocialLinks(
                            user?.socialLinks || {
                              twitter: "",
                              instagram: "",
                              youtube: "",
                              tiktok: "",
                              website: "",
                            }
                          );
                          setEditCollectingGoals(user?.collectingGoals || []);
                        }}
                        className="flex-1 bg-white/10 hover:bg-white/20 text-white py-3 px-4 rounded-lg font-medium transition-colors border border-white/10"
                      >
                        Cancel
                      </button>
                      <button
                        onClick={async () => {
                          try {
                            // Check if user is authenticated before saving
                            if (!isAuthenticated) {
                              alert(
                                "Please log in to save your profile changes."
                              );
                              return;
                            }

                            // Prepare profile updates
                            const updates = {};

                            // Validate username before saving
                            if (editUsername !== user?.username) {
                              const trimmedUsername = editUsername.trim();
                              if (
                                !trimmedUsername ||
                                trimmedUsername.length === 0
                              ) {
                                alert("Username cannot be empty");
                                return;
                              }
                              if (trimmedUsername.length < 3) {
                                alert(
                                  "Username must be at least 3 characters long"
                                );
                                return;
                              }
                              if (trimmedUsername.length > 50) {
                                alert("Username must be 50 characters or less");
                                return;
                              }
                              if (!/^[a-zA-Z0-9_-]+$/.test(trimmedUsername)) {
                                alert(
                                  "Username can only contain letters, numbers, underscores, and hyphens"
                                );
                                return;
                              }
                            }

                            // Add display name and username updates
                            if (editDisplayName !== user?.fullName) {
                              updates.fullName = editDisplayName.trim();
                            }
                            if (editUsername !== user?.username) {
                              updates.username = editUsername.trim();
                            }

                            // Add profile fields
                            if (editTagline !== (user?.tagline || "")) {
                              updates.tagline = editTagline.trim();
                            }
                            if (editAboutMe !== (user?.aboutMe || "")) {
                              updates.aboutMe = editAboutMe.trim();
                            }
                            if (
                              JSON.stringify(editSocialLinks) !==
                              JSON.stringify(user?.socialLinks || {})
                            ) {
                              updates.socialLinks = editSocialLinks;
                            }
                            if (
                              JSON.stringify(editCollectingGoals) !==
                              JSON.stringify(user?.collectingGoals || [])
                            ) {
                              updates.collectingGoals = editCollectingGoals;
                            }

                            // Handle profile picture upload
                            if (profilePictureFile) {
                              // Convert file to base64 for storage
                              const reader = new FileReader();
                              reader.onload = async (e) => {
                                updates.profileImage = e.target.result;

                                // Update profile with all changes
                                const result = await updateProfile(updates);
                                if (result.success) {
                                  // Clear the preview states after successful save
                                  setProfilePicturePreview(null);
                                  setProfilePictureFile(null);
                                  setShowEditProfile(false);
                                  alert("Profile updated successfully!");
                                } else {
                                  console.error(
                                    "Failed to save profile:",
                                    result.error
                                  );
                                  alert(
                                    `Failed to save profile: ${
                                      result.error || "Unknown error"
                                    }`
                                  );
                                }
                              };
                              reader.readAsDataURL(profilePictureFile);
                            } else {
                              // No profile picture change, just save other updates
                              if (Object.keys(updates).length > 0) {
                                const result = await updateProfile(updates);
                                if (result.success) {
                                  setShowEditProfile(false);
                                  alert("Profile updated successfully!");
                                } else {
                                  console.error(
                                    "Failed to save profile:",
                                    result.error
                                  );
                                  alert(
                                    `Failed to save profile: ${
                                      result.error || "Unknown error"
                                    }`
                                  );
                                }
                              } else {
                                // No changes, just close the modal
                                setShowEditProfile(false);
                              }
                            }
                          } catch (error) {
                            console.error("Error saving profile:", error);
                            alert("Error saving profile. Please try again.");
                          }
                        }}
                        className="flex-1 bg-gradient-to-r from-blue-500 to-purple-600 hover:from-blue-600 hover:to-purple-700 text-white py-3 px-4 rounded-lg font-medium transition-colors shadow-lg"
                      >
                        Save Changes
                      </button>
                    </div>
                  </div>
                </div>
              </div>,
              document.body
            )}

          {/* Collection Added Notification - Global */}
          {showCollectionNotification && (
            <div className="fixed bottom-24 left-0 right-0 z-[10003] animate-slide-up-notification">
              <div className="bg-gray-800/95 backdrop-blur-sm border border-gray-600/50 rounded-xl px-4 py-3 shadow-2xl mx-auto w-fit">
                <div className="flex items-center gap-3">
                  <div className="w-8 h-8 bg-green-500/20 rounded-full flex items-center justify-center">
                    <svg
                      className="w-5 h-5 text-green-400"
                      fill="none"
                      stroke="currentColor"
                      viewBox="0 0 24 24"
                    >
                      <path
                        strokeLinecap="round"
                        strokeLinejoin="round"
                        strokeWidth="2"
                        d="M5 13l4 4L19 7"
                      />
                    </svg>
                  </div>
                  <span className="text-white text-sm font-medium">
                    {collectionNotificationMessage}
                  </span>
                </div>
              </div>
            </div>
          )}

          {/* Filter Modal */}
          {showFilterModal &&
            createPortal(
              <div
                className="fixed inset-0 bg-black/60 backdrop-blur-sm z-[10003] flex items-end"
                onClick={() => setShowFilterModal(false)}
              >
                <div
                  className="w-full bg-gray-900/95 backdrop-blur-xl border-t border-gray-700/50 rounded-t-3xl shadow-2xl animate-in slide-in-from-bottom-8 duration-300"
                  onClick={(e) => e.stopPropagation()}
                >
                  {/* Handle Bar */}
                  <div className="flex justify-center pt-3 pb-2">
                    <div className="w-12 h-1.5 bg-gray-600 rounded-full"></div>
                  </div>

                  {/* Header */}
                  <div className="px-6 py-4 border-b border-gray-700/50">
                    <div className="flex items-center justify-between mb-2">
                      <div className="flex items-center gap-2">
                        <h3 className="text-xl font-bold text-white">
                          Filter Collection
                        </h3>
                        {(filterSettings.cardStatus !== "all" ||
                          filterSettings.languages.length > 0 ||
                          filterSettings.products.length > 0) && (
                          <span className="bg-blue-500/20 border border-blue-500/50 text-blue-300 text-xs font-semibold rounded-full px-2.5 py-0.5">
                            {[
                              filterSettings.cardStatus !== "all" ? 1 : 0,
                              filterSettings.languages.length,
                              filterSettings.products.length,
                            ].reduce((a, b) => a + b, 0)}{" "}
                            Active
                          </span>
                        )}
                      </div>
                      {(filterSettings.cardStatus !== "all" ||
                        filterSettings.languages.length > 0 ||
                        filterSettings.products.length > 0) && (
                        <button
                          onClick={() =>
                            setFilterSettings({
                              cardStatus: "all",
                              languages: [],
                              products: [],
                            })
                          }
                          className="text-sm font-medium text-red-400 hover:text-red-300 transition-colors duration-200 flex items-center gap-1.5"
                        >
                          <svg
                            className="w-4 h-4"
                            fill="none"
                            stroke="currentColor"
                            viewBox="0 0 24 24"
                          >
                            <path
                              strokeLinecap="round"
                              strokeLinejoin="round"
                              strokeWidth="2"
                              d="M6 18L18 6M6 6l12 12"
                            />
                          </svg>
                          Clear All
                        </button>
                      )}
                    </div>
                    <p className="text-sm text-gray-400">
                      Filter cards in your collection
                    </p>
                  </div>

                  {/* Filter Content */}
                  <div className="p-6 max-h-[70vh] overflow-y-auto space-y-6">
                    {/* Card Status */}
                    <div>
                      <div className="flex items-center gap-2 mb-3">
                        <div className="w-1 h-4 bg-blue-400 rounded-full"></div>
                        <h4 className="text-white text-sm font-semibold tracking-wide uppercase">
                          Card Status
                        </h4>
                      </div>
                      <div className="flex flex-wrap gap-2">
                        {[
                          { value: "all", label: "All Cards" },
                          { value: "duplicates", label: "Duplicates" },
                          { value: "wishlisted", label: "Wishlisted" },
                        ].map((status) => (
                          <button
                            key={status.value}
                            onClick={() =>
                              setFilterSettings((prev) => ({
                                ...prev,
                                cardStatus: status.value,
                              }))
                            }
                            className={`px-4 py-2.5 rounded-full text-sm font-medium transition-all duration-200 border ${
                              filterSettings.cardStatus === status.value
                                ? "bg-blue-500/20 border-blue-500/50 text-blue-300 shadow-lg shadow-blue-500/20 backdrop-blur-xl"
                                : "bg-white/5 border-gray-600/30 text-gray-300 hover:bg-white/10 hover:border-gray-500/50 hover:text-white backdrop-blur-md"
                            }`}
                          >
                            {status.label}
                          </button>
                        ))}
                      </div>
                    </div>

                    {/* Languages */}
                    <div>
                      <div className="flex items-center gap-2 mb-3">
                        <div className="w-1 h-4 bg-green-400 rounded-full"></div>
                        <h4 className="text-white text-sm font-semibold tracking-wide uppercase">
                          Languages
                        </h4>
                      </div>
                      <div className="flex flex-wrap gap-2">
                        {[
                          { value: "english", label: "English" },
                          { value: "japanese", label: "Japanese" },
                          { value: "chinese", label: "Chinese" },
                          { value: "korean", label: "Korean" },
                          { value: "german", label: "German" },
                          { value: "spanish", label: "Spanish" },
                          { value: "french", label: "French" },
                          { value: "italian", label: "Italian" },
                        ].map((lang) => (
                          <button
                            key={lang.value}
                            onClick={() => {
                              setFilterSettings((prev) => ({
                                ...prev,
                                languages: prev.languages.includes(lang.value)
                                  ? prev.languages.filter(
                                      (l) => l !== lang.value
                                    )
                                  : [...prev.languages, lang.value],
                              }));
                            }}
                            className={`px-4 py-2.5 rounded-full text-sm font-medium transition-all duration-200 border ${
                              filterSettings.languages.includes(lang.value)
                                ? "bg-green-500/20 border-green-500/50 text-green-300 shadow-lg shadow-green-500/20 backdrop-blur-xl"
                                : "bg-white/5 border-gray-600/30 text-gray-300 hover:bg-white/10 hover:border-gray-500/50 hover:text-white backdrop-blur-md"
                            }`}
                          >
                            {lang.label}
                          </button>
                        ))}
                      </div>
                    </div>

                    {/* Products */}
                    <div>
                      <div className="flex items-center gap-2 mb-3">
                        <div className="w-1 h-4 bg-purple-400 rounded-full"></div>
                        <h4 className="text-white text-sm font-semibold tracking-wide uppercase">
                          Products
                        </h4>
                      </div>
                      <div className="flex flex-wrap gap-2">
                        {[
                          { value: "cards", label: "Cards" },
                          { value: "sealed", label: "Sealed" },
                        ].map((product) => (
                          <button
                            key={product.value}
                            onClick={() => {
                              setFilterSettings((prev) => ({
                                ...prev,
                                products: prev.products.includes(product.value)
                                  ? prev.products.filter(
                                      (p) => p !== product.value
                                    )
                                  : [...prev.products, product.value],
                              }));
                            }}
                            className={`px-4 py-2.5 rounded-full text-sm font-medium transition-all duration-200 border ${
                              filterSettings.products.includes(product.value)
                                ? "bg-purple-500/20 border-purple-500/50 text-purple-300 shadow-lg shadow-purple-500/20 backdrop-blur-xl"
                                : "bg-white/5 border-gray-600/30 text-gray-300 hover:bg-white/10 hover:border-gray-500/50 hover:text-white backdrop-blur-md"
                            }`}
                          >
                            {product.label}
                          </button>
                        ))}
                      </div>
                    </div>

                    {/* Energies */}
                    <div>
                      <div className="flex items-center gap-2 mb-3">
                        <div className="w-1 h-4 bg-yellow-400 rounded-full"></div>
                        <h4 className="text-white text-sm font-semibold tracking-wide uppercase">
                          Energy Type
                        </h4>
                      </div>
                      <div className="flex flex-wrap gap-2">
                        {[
                          { value: "colorless", label: "Colorless" },
                          { value: "darkness", label: "Darkness" },
                          { value: "dragon", label: "Dragon" },
                          { value: "electric", label: "Electric" },
                          { value: "fairy", label: "Fairy" },
                          { value: "fighting", label: "Fighting" },
                          { value: "fire", label: "Fire" },
                          { value: "grass", label: "Grass" },
                          { value: "metal", label: "Metal" },
                          { value: "psychic", label: "Psychic" },
                          { value: "water", label: "Water" },
                        ].map((energy) => (
                          <button
                            key={energy.value}
                            onClick={() => {
                              setFilterSettings((prev) => ({
                                ...prev,
                                energies: prev.energies.includes(energy.value)
                                  ? prev.energies.filter(
                                      (e) => e !== energy.value
                                    )
                                  : [...prev.energies, energy.value],
                              }));
                            }}
                            className={`px-3 py-2 rounded-full text-sm font-medium transition-all duration-200 border ${
                              filterSettings.energies.includes(energy.value)
                                ? "bg-yellow-500/20 border-yellow-500/50 text-yellow-300 shadow-lg shadow-yellow-500/20 backdrop-blur-xl"
                                : "bg-white/5 border-gray-600/30 text-gray-300 hover:bg-white/10 hover:border-gray-500/50 hover:text-white backdrop-blur-md"
                            }`}
                          >
                            {energy.label}
                          </button>
                        ))}
                      </div>
                    </div>

                    {/* Supertype */}
                    <div>
                      <div className="flex items-center gap-2 mb-3">
                        <div className="w-1 h-4 bg-cyan-400 rounded-full"></div>
                        <h4 className="text-white text-sm font-semibold tracking-wide uppercase">
                          Card Type
                        </h4>
                      </div>
                      <div className="flex flex-wrap gap-2">
                        {[
                          { value: "pokemon", label: "Pokémon" },
                          { value: "trainer", label: "Trainer" },
                          { value: "energy", label: "Energy" },
                        ].map((type) => (
                          <button
                            key={type.value}
                            onClick={() => {
                              setFilterSettings((prev) => ({
                                ...prev,
                                supertype: prev.supertype.includes(type.value)
                                  ? prev.supertype.filter(
                                      (t) => t !== type.value
                                    )
                                  : [...prev.supertype, type.value],
                              }));
                            }}
                            className={`px-4 py-2.5 rounded-full text-sm font-medium transition-all duration-200 border ${
                              filterSettings.supertype.includes(type.value)
                                ? "bg-cyan-500/20 border-cyan-500/50 text-cyan-300 shadow-lg shadow-cyan-500/20 backdrop-blur-xl"
                                : "bg-white/5 border-gray-600/30 text-gray-300 hover:bg-white/10 hover:border-gray-500/50 hover:text-white backdrop-blur-md"
                            }`}
                          >
                            {type.label}
                          </button>
                        ))}
                      </div>
                    </div>

                    {/* Rarities */}
                    <div>
                      <div className="flex items-center gap-2 mb-3">
                        <div className="w-1 h-4 bg-pink-400 rounded-full"></div>
                        <h4 className="text-white text-sm font-semibold tracking-wide uppercase">
                          Rarity
                        </h4>
                      </div>

                      {/* Rarity Type Toggle */}
                      <div className="flex bg-gray-800/50 rounded-full p-1 mb-4 border border-gray-700/50">
                        <button
                          onClick={() =>
                            setFilterSettings((prev) => ({
                              ...prev,
                              rarityType: "international",
                            }))
                          }
                          className={`flex-1 py-2 px-4 rounded-full text-sm font-medium transition-all duration-200 ${
                            filterSettings.rarityType === "international"
                              ? "bg-pink-500/20 border border-pink-500/50 text-pink-300 shadow-lg shadow-pink-500/20"
                              : "text-gray-400 hover:text-white"
                          }`}
                        >
                          International
                        </button>
                        <button
                          onClick={() =>
                            setFilterSettings((prev) => ({
                              ...prev,
                              rarityType: "japanese",
                            }))
                          }
                          className={`flex-1 py-2 px-4 rounded-full text-sm font-medium transition-all duration-200 ${
                            filterSettings.rarityType === "japanese"
                              ? "bg-pink-500/20 border border-pink-500/50 text-pink-300 shadow-lg shadow-pink-500/20"
                              : "text-gray-400 hover:text-white"
                          }`}
                        >
                          Japanese
                        </button>
                      </div>

                      {/* Rarity Options */}
                      <div className="flex flex-wrap gap-2">
                        {(filterSettings.rarityType === "international"
                          ? [
                              { value: "common", label: "Common" },
                              { value: "uncommon", label: "Uncommon" },
                              { value: "rare", label: "Rare" },
                              { value: "double_rare", label: "Double Rare" },
                              {
                                value: "ace_spec_rare",
                                label: "ACE Spec Rare",
                              },
                              {
                                value: "illustration_rare",
                                label: "Illustration Rare",
                              },
                              { value: "ultra_rare", label: "Ultra Rare" },
                              {
                                value: "special_illustration_rare",
                                label: "Special Illustration Rare",
                              },
                              { value: "hyper_rare", label: "Hyper Rare" },
                              { value: "shiny_rare", label: "Shiny Rare" },
                              {
                                value: "shiny_ultra_rare",
                                label: "Shiny Ultra Rare",
                              },
                              {
                                value: "black_star_promo",
                                label: "Black Star Promo",
                              },
                            ]
                          : [
                              { value: "common", label: "Common" },
                              { value: "uncommon", label: "Uncommon" },
                              { value: "rare", label: "Rare" },
                              { value: "double_rare", label: "Double Rare" },
                              {
                                value: "ace_spec_rare",
                                label: "Ace Spec Rare",
                              },
                              { value: "art_rare", label: "Art Rare" },
                              { value: "super_rare", label: "Super Rare" },
                              {
                                value: "special_art_rare",
                                label: "Special Art Rare",
                              },
                              { value: "ultra_rare", label: "Ultra Rare" },
                              { value: "shiny_rare", label: "Shiny Rare" },
                              {
                                value: "shiny_super_rare",
                                label: "Shiny Super Rare",
                              },
                              {
                                value: "black_star_promo",
                                label: "Black Star Promo",
                              },
                            ]
                        ).map((rarity) => (
                          <button
                            key={rarity.value}
                            onClick={() => {
                              setFilterSettings((prev) => ({
                                ...prev,
                                rarities: prev.rarities.includes(rarity.value)
                                  ? prev.rarities.filter(
                                      (r) => r !== rarity.value
                                    )
                                  : [...prev.rarities, rarity.value],
                              }));
                            }}
                            className={`px-3 py-2 rounded-full text-xs font-medium transition-all duration-200 border ${
                              filterSettings.rarities.includes(rarity.value)
                                ? "bg-pink-500/20 border-pink-500/50 text-pink-300 shadow-lg shadow-pink-500/20 backdrop-blur-xl"
                                : "bg-white/5 border-gray-600/30 text-gray-300 hover:bg-white/10 hover:border-gray-500/50 hover:text-white backdrop-blur-md"
                            }`}
                          >
                            {rarity.label}
                          </button>
                        ))}
                      </div>
                    </div>

                    {/* Variants */}
                    <div>
                      <div className="flex items-center gap-2 mb-3">
                        <div className="w-1 h-4 bg-orange-400 rounded-full"></div>
                        <h4 className="text-white text-sm font-semibold tracking-wide uppercase">
                          Variant
                        </h4>
                      </div>
                      <div className="flex flex-wrap gap-2">
                        {[
                          { value: "Normal", label: "Normal" },
                          { value: "holos", label: "Holos" },
                          { value: "reverse_holos", label: "Reverse Holos" },
                          { value: "first_editions", label: "1st Editions" },
                        ].map((variant) => (
                          <button
                            key={variant.value}
                            onClick={() => {
                              setFilterSettings((prev) => ({
                                ...prev,
                                variants: prev.variants.includes(variant.value)
                                  ? prev.variants.filter(
                                      (v) => v !== variant.value
                                    )
                                  : [...prev.variants, variant.value],
                              }));
                            }}
                            className={`px-4 py-2.5 rounded-full text-sm font-medium transition-all duration-200 border ${
                              filterSettings.variants.includes(variant.value)
                                ? "bg-orange-500/20 border-orange-500/50 text-orange-300 shadow-lg shadow-orange-500/20 backdrop-blur-xl"
                                : "bg-white/5 border-gray-600/30 text-gray-300 hover:bg-white/10 hover:border-gray-500/50 hover:text-white backdrop-blur-md"
                            }`}
                          >
                            {variant.label}
                          </button>
                        ))}
                      </div>
                    </div>

                    {/* Formats */}
                    <div>
                      <div className="flex items-center gap-2 mb-3">
                        <div className="w-1 h-4 bg-indigo-400 rounded-full"></div>
                        <h4 className="text-white text-sm font-semibold tracking-wide uppercase">
                          Format
                        </h4>
                      </div>
                      <div className="flex flex-wrap gap-2">
                        {[
                          { value: "unlimited", label: "Unlimited" },
                          { value: "expanded", label: "Expanded" },
                          { value: "standard", label: "Standard" },
                        ].map((format) => (
                          <button
                            key={format.value}
                            onClick={() => {
                              setFilterSettings((prev) => ({
                                ...prev,
                                formats: prev.formats.includes(format.value)
                                  ? prev.formats.filter(
                                      (f) => f !== format.value
                                    )
                                  : [...prev.formats, format.value],
                              }));
                            }}
                            className={`px-4 py-2.5 rounded-full text-sm font-medium transition-all duration-200 border ${
                              filterSettings.formats.includes(format.value)
                                ? "bg-indigo-500/20 border-indigo-500/50 text-indigo-300 shadow-lg shadow-indigo-500/20 backdrop-blur-xl"
                                : "bg-white/5 border-gray-600/30 text-gray-300 hover:bg-white/10 hover:border-gray-500/50 hover:text-white backdrop-blur-md"
                            }`}
                          >
                            {format.label}
                          </button>
                        ))}
                      </div>
                    </div>

                    {/* Regulation Markings */}
                    <div>
                      <div className="flex items-center gap-2 mb-3">
                        <div className="w-1 h-4 bg-red-400 rounded-full"></div>
                        <h4 className="text-white text-sm font-semibold tracking-wide uppercase">
                          Regulation
                        </h4>
                      </div>
                      <div className="flex flex-wrap gap-2">
                        {["A", "B", "C", "D", "E", "F", "G", "H", "I"].map(
                          (marking) => (
                            <button
                              key={marking}
                              onClick={() => {
                                setFilterSettings((prev) => ({
                                  ...prev,
                                  regulationMarkings:
                                    prev.regulationMarkings.includes(marking)
                                      ? prev.regulationMarkings.filter(
                                          (m) => m !== marking
                                        )
                                      : [...prev.regulationMarkings, marking],
                                }));
                              }}
                              className={`px-4 py-2.5 rounded-full text-sm font-medium transition-all duration-200 border ${
                                filterSettings.regulationMarkings.includes(
                                  marking
                                )
                                  ? "bg-red-500/20 border-red-500/50 text-red-300 shadow-lg shadow-red-500/20 backdrop-blur-xl"
                                  : "bg-white/5 border-gray-600/30 text-gray-300 hover:bg-white/10 hover:border-gray-500/50 hover:text-white backdrop-blur-md"
                              }`}
                            >
                              {marking}
                            </button>
                          )
                        )}
                      </div>
                    </div>

                    {/* Conditions */}
                    <div>
                      <div className="flex items-center gap-2 mb-3">
                        <div className="w-1 h-4 bg-emerald-400 rounded-full"></div>
                        <h4 className="text-white text-sm font-semibold tracking-wide uppercase">
                          Condition
                        </h4>
                      </div>
                      <div className="flex flex-wrap gap-2">
                        {[
                          { value: "near_mint", label: "Near Mint" },
                          { value: "lightly_played", label: "Lightly Played" },
                          {
                            value: "moderately_played",
                            label: "Moderately Played",
                          },
                          { value: "heavily_played", label: "Heavily Played" },
                          { value: "damaged", label: "Damaged" },
                        ].map((condition) => (
                          <button
                            key={condition.value}
                            onClick={() => {
                              setFilterSettings((prev) => ({
                                ...prev,
                                conditions: prev.conditions.includes(
                                  condition.value
                                )
                                  ? prev.conditions.filter(
                                      (c) => c !== condition.value
                                    )
                                  : [...prev.conditions, condition.value],
                              }));
                            }}
                            className={`px-4 py-2.5 rounded-full text-sm font-medium transition-all duration-200 border ${
                              filterSettings.conditions.includes(
                                condition.value
                              )
                                ? "bg-emerald-500/20 border-emerald-500/50 text-emerald-300 shadow-lg shadow-emerald-500/20 backdrop-blur-xl"
                                : "bg-white/5 border-gray-600/30 text-gray-300 hover:bg-white/10 hover:border-gray-500/50 hover:text-white backdrop-blur-md"
                            }`}
                          >
                            {condition.label}
                          </button>
                        ))}
                      </div>
                    </div>
                  </div>
                </div>
              </div>,
              document.body
            )}
        </div>
      </div>
    );
  }

  // Default return for main dashboard
  return (
    <div
      className="min-h-screen dark:bg-theme-primary text-theme-primary transition-all duration-300 ease-in-out relative"
      style={{
        height: "100vh",
        overflowY: "auto",
        WebkitOverflowScrolling: "touch",
        touchAction: "pan-y",
        position: "relative",
      }}
    >
      {/* Background gradient for light mode - muted palette */}
      <div
        className="fixed inset-0 dark:hidden bg-gradient-to-br from-[#fafafa] via-[#e4e5f1] to-[#d2d3db] -z-10"
        style={{
          background:
            "linear-gradient(135deg, #fafafa 0%, #e4e5f1 50%, rgba(104, 101, 231, 0.1) 100%)",
        }}
      ></div>
      {/* Header */}
      <div className="px-4 py-4">
        <div className="flex items-center justify-between mb-6">
          <h1 className="text-2xl font-bold dark:text-white text-theme-primary">
            Card Collector
          </h1>
          <div className="flex items-center gap-4">
            <button
              className="dark:text-white text-theme-primary focus:outline-none focus:ring-2 focus:ring-[#6865E7] focus:ring-offset-2 rounded-lg p-1 transition-colors"
              aria-label="Settings"
            >
              <svg
                className="w-6 h-6"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  strokeLinecap="round"
                  strokeLinejoin="round"
                  strokeWidth="2"
                  d="M15 17h5l-5 5-5-5h5v-5a7.5 7.5 0 1 0-15 0v5h5l-5 5-5-5h5v-5a7.5 7.5 0 1 1 15 0v5z"
                />
              </svg>
            </button>
          </div>
        </div>
      </div>

      {/* Main Content */}
      <div className="px-4">
        <p className="text-white text-center py-8">
          Welcome to Card Collector!
        </p>
      </div>

      {/* Event History Modal */}
      <EventHistory
        isOpen={showEventHistory}
        onClose={() => setShowEventHistory(false)}
      />
    </div>
  );
}
